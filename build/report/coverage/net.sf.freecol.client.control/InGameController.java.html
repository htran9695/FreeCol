<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InGameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.control</a> &gt; <span class="el_source">InGameController.java</span></div><h1>InGameController.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.control;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import net.sf.freecol.FreeCol;
import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.gui.ChoiceItem;
import net.sf.freecol.client.gui.GUI;
import net.sf.freecol.client.gui.option.FreeColActionUI;
import net.sf.freecol.common.debug.DebugUtils;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.i18n.NameCache;
import net.sf.freecol.common.io.FreeColDirectories;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.BuildableType;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.ColonyWas;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.DiplomaticTrade.TradeContext;
import net.sf.freecol.common.model.DiplomaticTrade.TradeStatus;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.EuropeWas;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.GoldTradeItem;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.LostCityRumour;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.MarketWas;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.ModelMessage.MessageType;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.Nameable;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.Ownable;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.NoClaimReason;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.Region;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StanceTradeItem;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TradeLocation;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.UnitWas;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.networking.NetworkConstants;
import net.sf.freecol.common.networking.ServerAPI;
import net.sf.freecol.common.option.BooleanOption;
import net.sf.freecol.server.FreeColServer;

import static net.sf.freecol.common.util.CollectionUtils.*;

/**
 * The controller that will be used while the game is played.
 */
public final class InGameController implements NetworkConstants {

	/** The Constant logger. */
<span class="nc" id="L115">	private static final Logger logger = Logger.getLogger(InGameController.class.getName());</span>

	/** Actions when an armed unit contacts a settlement. */
<span class="nc" id="L118">	public static enum ArmedUnitSettlementAction {</span>

		/** The settlement attack. */
<span class="nc" id="L121">		SETTLEMENT_ATTACK,</span>

		/** The settlement tribute. */
<span class="nc" id="L124">		SETTLEMENT_TRIBUTE,</span>
	}

	/** Actions when dealing with a boycott. */
<span class="nc" id="L128">	public static enum BoycottAction {</span>

		/** The pay arrears. */
<span class="nc" id="L131">		PAY_ARREARS,</span>

		/** The dump cargo. */
<span class="nc" id="L134">		DUMP_CARGO</span>
	}

	/** Actions when buying from the natives. */
<span class="nc" id="L138">	public static enum BuyAction {</span>

		/** The buy. */
<span class="nc" id="L141">		BUY,</span>

		/** The haggle. */
<span class="nc" id="L144">		HAGGLE</span>
	}

	/** Actions when claiming land. */
<span class="nc" id="L148">	public static enum ClaimAction {</span>

		/** The accept. */
<span class="nc" id="L151">		ACCEPT,</span>

		/** The steal. */
<span class="nc" id="L154">		STEAL</span>
	}

	/** Actions with a missionary at a native settlement. */
<span class="nc" id="L158">	public static enum MissionaryAction {</span>

		/** The establish mission. */
<span class="nc" id="L161">		ESTABLISH_MISSION,</span>

		/** The denounce heresy. */
<span class="nc" id="L164">		DENOUNCE_HERESY,</span>

		/** The incite indians. */
<span class="nc" id="L167">		INCITE_INDIANS</span>
	}

	/** Actions in scouting a colony. */
<span class="nc" id="L171">	public static enum ScoutColonyAction {</span>

		/** The foreign colony negotiate. */
<span class="nc" id="L174">		FOREIGN_COLONY_NEGOTIATE,</span>

		/** The foreign colony spy. */
<span class="nc" id="L177">		FOREIGN_COLONY_SPY,</span>

		/** The foreign colony attack. */
<span class="nc" id="L180">		FOREIGN_COLONY_ATTACK</span>
	}

	/** Actions in scouting a native settlement. */
<span class="nc" id="L184">	public static enum ScoutIndianSettlementAction {</span>

		/** The indian settlement speak. */
<span class="nc" id="L187">		INDIAN_SETTLEMENT_SPEAK,</span>

		/** The indian settlement tribute. */
<span class="nc" id="L190">		INDIAN_SETTLEMENT_TRIBUTE,</span>

		/** The indian settlement attack. */
<span class="nc" id="L193">		INDIAN_SETTLEMENT_ATTACK</span>
	}

	/** Actions when selling to the natives. */
<span class="nc" id="L197">	public static enum SellAction {</span>

		/** The sell. */
<span class="nc" id="L200">		SELL,</span>

		/** The haggle. */
<span class="nc" id="L203">		HAGGLE,</span>

		/** The gift. */
<span class="nc" id="L206">		GIFT</span>
	}

	/** Choice of sales action at a native settlement. */
<span class="nc" id="L210">	public static enum TradeAction {</span>

		/** The buy. */
<span class="nc" id="L213">		BUY,</span>

		/** The sell. */
<span class="nc" id="L216">		SELL,</span>

		/** The gift. */
<span class="nc" id="L219">		GIFT</span>
	}

	/**
	 * Selecting next unit depends on mode--- either from the active list, from
	 * the going-to list, or flush going-to and end the turn.
	 */
<span class="nc" id="L226">	private static enum MoveMode {</span>

		/** The next active unit. */
<span class="nc" id="L229">		NEXT_ACTIVE_UNIT,</span>

		/** The execute goto orders. */
<span class="nc" id="L232">		EXECUTE_GOTO_ORDERS,</span>

		/** The end turn. */
<span class="nc" id="L235">		END_TURN;</span>

		/**
		 * Maximize.
		 *
		 * @param m
		 *            the m
		 * @return the move mode
		 */
		public MoveMode maximize(MoveMode m) {
<span class="nc bnc" id="L245" title="All 2 branches missed.">			return (this.ordinal() &lt; m.ordinal()) ? m : this;</span>
		}
	}

	/** The Constant UNIT_LAST_MOVE_DELAY. */
	private static final short UNIT_LAST_MOVE_DELAY = 300;

	/** A template to use as a magic cookie for aborted trades. */
<span class="nc" id="L253">	private static final StringTemplate abortTrade = StringTemplate.template(&quot;&quot;);</span>

	/** The enclosing &lt;code&gt;FreeColClient&lt;/code&gt;. */
	private final FreeColClient freeColClient;

	/** A cache reference to the gui. */
	private final GUI gui;

	/** Current mode for moving units. */
<span class="nc" id="L262">	private MoveMode moveMode = MoveMode.NEXT_ACTIVE_UNIT;</span>

	/** A map of messages to be ignored. */
<span class="nc" id="L265">	private final HashMap&lt;String, Integer&gt; messagesToIgnore = new HashMap&lt;&gt;();</span>

	/** The messages in the last turn report. */
<span class="nc" id="L268">	private final List&lt;ModelMessage&gt; turnReportMessages = new ArrayList&lt;&gt;();</span>

	/**
	 * The constructor to use.
	 *
	 * @param freeColClient
	 *            The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
	 */
<span class="nc" id="L276">	public InGameController(FreeColClient freeColClient) {</span>
<span class="nc" id="L277">		this.freeColClient = freeColClient;</span>
<span class="nc" id="L278">		this.gui = freeColClient.getGUI();</span>

		// FIXME: fetch value of lastSaveGameFile from a persistent
		// client value
		// lastSaveGameFile = new
		// File(freeColClient.getClientOptions().getString(null));
<span class="nc" id="L284">	}</span>

	// Simple utilities

	/**
	 * Meaningfully named access to the ServerAPI.
	 *
	 * @return The ServerAPI.
	 */
	private ServerAPI askServer() {
<span class="nc" id="L294">		return freeColClient.askServer();</span>
	}

	/**
	 * Play a sound.
	 *
	 * @param soundKey
	 *            The sound resource key.
	 */
	private void sound(String soundKey) {
<span class="nc" id="L304">		freeColClient.getSoundController().playSound(soundKey);</span>
<span class="nc" id="L305">	}</span>

	/**
	 * Gets the specification for the current game.
	 *
	 * @return The current game specification.
	 */
	private Specification getSpecification() {
<span class="nc" id="L313">		return freeColClient.getGame().getSpecification();</span>
	}

	/**
	 * Require that it is this client's player's turn. Put up the notYourTurn
	 * message if not.
	 *
	 * @return True if it is our turn.
	 */
	private boolean requireOurTurn() {
<span class="nc bnc" id="L323" title="All 2 branches missed.">		if (freeColClient.currentPlayerIsMyPlayer())</span>
<span class="nc" id="L324">			return true;</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		if (freeColClient.isInGame()) {</span>
<span class="nc" id="L326">			gui.showInformationMessage(&quot;info.notYourTurn&quot;);</span>
		}
<span class="nc" id="L328">		return false;</span>
	}

	/**
	 * Display the colony panel for a colony, and select the unit that just
	 * arrived there if it is a carrier.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to display.
	 * @param unit
	 *            An optional &lt;code&gt;Unit&lt;/code&gt; to select.
	 */
	private void colonyPanel(Colony colony, Unit unit) {
<span class="nc bnc" id="L341" title="All 2 branches missed.">		gui.showColonyPanel(colony, (unit.isCarrier()) ? unit : null);</span>
<span class="nc" id="L342">	}</span>

	/**
	 * Convenience function to find an adjacent settlement. Intended to be
	 * called in contexts where we are expecting a settlement to be there, such
	 * as when handling a particular move type.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to start at.
	 * @param direction
	 *            The &lt;code&gt;Direction&lt;/code&gt; to step.
	 * @return A settlement on the adjacent tile if any.
	 */
	private Settlement getSettlementAt(Tile tile, Direction direction) {
<span class="nc" id="L356">		return tile.getNeighbourOrNull(direction).getSettlement();</span>
	}

	/**
	 * Convenience function to find the nation controlling an adjacent
	 * settlement. Intended to be called in contexts where we are expecting a
	 * settlement or unit to be there, such as when handling a particular move
	 * type.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to start at.
	 * @param direction
	 *            The &lt;code&gt;Direction&lt;/code&gt; to step.
	 * @return The name of the nation controlling a settlement on the adjacent
	 *         tile if any.
	 */
	private StringTemplate getNationAt(Tile tile, Direction direction) {
<span class="nc" id="L373">		Tile newTile = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L374">		Player player = null;</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">		if (newTile.hasSettlement()) {</span>
<span class="nc" id="L376">			player = newTile.getSettlement().getOwner();</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">		} else if (newTile.getFirstUnit() != null) {</span>
<span class="nc" id="L378">			player = newTile.getFirstUnit().getOwner();</span>
		} else { // should not happen
<span class="nc" id="L380">			player = freeColClient.getGame().getUnknownEnemy();</span>
		}
<span class="nc" id="L382">		return player.getNationLabel();</span>
	}

	/**
	 * Update the GUI and the active unit with a fallback tile.
	 *
	 * @param tile
	 *            An optional fallback &lt;code&gt;Tile&lt;/code&gt; to display if no active
	 *            unit is found, useful when the last unit might have died.
	 */
	private void updateGUI(Tile tile) {
<span class="nc bnc" id="L393" title="All 2 branches missed.">		if (displayModelMessages(false, false)) {</span>
			; // If messages are displayed they probably refer to the
				// current unit, so do not update it.
<span class="nc bnc" id="L396" title="All 2 branches missed.">		} else if (updateActiveUnit(tile)) {</span>
			; // setActiveUnit will update the menu bar
		} else {
<span class="nc" id="L399">			gui.updateMapControls();</span>
<span class="nc" id="L400">			gui.updateMenuBar();</span>
		}
<span class="nc" id="L402">	}</span>

	// Server access routines called from multiple places.

	/**
	 * Ask the server to assign a trade route.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to assign to.
	 * @param tradeRoute
	 *            The &lt;code&gt;TradeRoute&lt;/code&gt; to assign.
	 * @return True if the assignment succeeds.
	 */
	private boolean askAssignTradeRoute(Unit unit, TradeRoute tradeRoute) {
<span class="nc bnc" id="L416" title="All 2 branches missed.">		if (tradeRoute == unit.getTradeRoute())</span>
<span class="nc" id="L417">			return true;</span>

<span class="nc bnc" id="L419" title="All 4 branches missed.">		if (tradeRoute != null &amp;&amp; unit.getTradeRoute() != null) {</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">			if (!gui.confirmClearTradeRoute(unit))</span>
<span class="nc" id="L421">				return false;</span>
		}

<span class="nc bnc" id="L424" title="All 4 branches missed.">		return askServer().assignTradeRoute(unit, tradeRoute) &amp;&amp; unit.getTradeRoute() == tradeRoute;</span>
	}

	/**
	 * Claim a tile.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; that is claiming.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to claim.
	 * @param claimant
	 *            The &lt;code&gt;Unit&lt;/code&gt; or &lt;code&gt;Colony&lt;/code&gt; claiming.
	 * @param price
	 *            The price required.
	 * @return True if the claim succeeded.
	 */
	private boolean askClaimTile(Player player, Tile tile, FreeColGameObject claimant, int price) {
<span class="nc" id="L441">		final Player owner = tile.getOwner();</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">		if (price &lt; 0) { // not for sale</span>
<span class="nc" id="L443">			return false;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">		} else if (price &gt; 0) { // for sale</span>
<span class="nc" id="L445">			ClaimAction act = gui.getClaimChoice(tile, player, price, owner);</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">			if (act == null)</span>
<span class="nc" id="L447">				return false; // Cancelled</span>
<span class="nc bnc" id="L448" title="All 3 branches missed.">			switch (act) {</span>
			case ACCEPT: // accepted price
<span class="nc" id="L450">				break;</span>
			case STEAL:
<span class="nc" id="L452">				price = NetworkConstants.STEAL_LAND;</span>
<span class="nc" id="L453">				break;</span>
			default:
<span class="nc" id="L455">				logger.warning(&quot;Claim dialog fail: &quot; + act);</span>
<span class="nc" id="L456">				return false;</span>
			}
		} // else price == 0 and we can just proceed to claim

		// Ask the server
<span class="nc bnc" id="L461" title="All 4 branches missed.">		return askServer().claimTile(tile, claimant, price) &amp;&amp; player.owns(tile);</span>
	}

	/**
	 * Clears the goto orders of the given unit by setting its destination to
	 * null.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to clear the destination for.
	 * @return True if the unit now has no destination or trade route.
	 */
	private boolean askClearGotoOrders(Unit unit) {
<span class="nc bnc" id="L473" title="All 2 branches missed.">		if (!askAssignTradeRoute(unit, null))</span>
<span class="nc" id="L474">			return false;</span>

<span class="nc bnc" id="L476" title="All 2 branches missed.">		if (unit.getDestination() == null)</span>
<span class="nc" id="L477">			return true;</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">		if (askSetDestination(unit, null)) {</span>
<span class="nc" id="L480">			gui.clearGotoPath();</span>
<span class="nc" id="L481">			return true;</span>
		}
<span class="nc" id="L483">		return false;</span>
	}

	/**
	 * Embark onto a carrier.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to embark.
	 * @param carrier
	 *            The carrier &lt;code&gt;Unit&lt;/code&gt; to board.
	 * @return True if boarding succeeded.
	 */
	private boolean askEmbark(Unit unit, Unit carrier) {
<span class="nc bnc" id="L496" title="All 2 branches missed.">		ColonyWas colonyWas = (unit.getColony() != null) ? new ColonyWas(unit.getColony()) : null;</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">		EuropeWas europeWas = (unit.isInEurope()) ? new EuropeWas(unit.getOwner().getEurope()) : null;</span>
<span class="nc" id="L498">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L499" title="All 4 branches missed.">		if (askServer().embark(unit, carrier, null) &amp;&amp; unit.getLocation() == carrier) {</span>
<span class="nc" id="L500">			sound(&quot;sound.event.loadCargo&quot;);</span>
<span class="nc" id="L501">			unitWas.fireChanges();</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">			if (colonyWas != null)</span>
<span class="nc" id="L503">				colonyWas.fireChanges();</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">			if (europeWas != null)</span>
<span class="nc" id="L505">				europeWas.fireChanges();</span>
<span class="nc" id="L506">			return true;</span>
		}
<span class="nc" id="L508">		return false;</span>
	}

	/**
	 * A unit in Europe emigrates.
	 *
	 * This is unusual for an ask* routine in that it uses a *Was structure, but
	 * it is needed to extract the unit.
	 *
	 * @param europe
	 *            The &lt;code&gt;Europe&lt;/code&gt; where the unit appears.
	 * @param slot
	 *            The slot to choose, [0..RECRUIT_COUNT].
	 * @return The new &lt;code&gt;Unit&lt;/code&gt; or null on failure.
	 */
	private Unit askEmigrate(Europe europe, int slot) {
<span class="nc bnc" id="L524" title="All 4 branches missed.">		if (europe == null || !MigrationType.validMigrantSlot(slot))</span>
<span class="nc" id="L525">			return null;</span>

<span class="nc" id="L527">		EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L528">		Unit newUnit = null;</span>
<span class="nc bnc" id="L529" title="All 4 branches missed.">		if (askServer().emigrate(slot) &amp;&amp; (newUnit = europeWas.getNewUnit()) != null) {</span>
<span class="nc" id="L530">			europeWas.fireChanges();</span>
		}
<span class="nc" id="L532">		return newUnit;</span>
	}

	/**
	 * Select all the units to emigrate from Europe. If they are all the same
	 * they can be picked automatically, but otherwise use the emigration
	 * dialog. Only to be called if the player is allowed to select the unit
	 * type (i.e. FoY or has Brewster).
	 *
	 * The server contains the count of available FoY-units, and maintains the
	 * immigration/immigrationRequired amounts, so this routine will fail
	 * harmlessly if it asks for too much.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; that owns the unit.
	 * @param n
	 *            The number of units known to be eligible to emigrate.
	 * @param fountainOfYouth
	 *            True if this migration if due to a FoY.
	 */
	private void emigration(Player player, int n, boolean fountainOfYouth) {
<span class="nc" id="L553">		final Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">		if (europe == null)</span>
<span class="nc" id="L555">			return;</span>

<span class="nc bnc" id="L557" title="All 4 branches missed.">		for (; n &gt; 0 || player.checkEmigrate(); n--) {</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">			if (!allSame(europe.getRecruitables())) {</span>
<span class="nc" id="L559">				final int nf = n;</span>
<span class="nc" id="L560">				gui.showEmigrationDialog(player, fountainOfYouth, (Integer value) -&gt; { // Value</span>
																						// is
																						// a
																						// valid
																						// slot
<span class="nc" id="L565">					emigrate(player, Europe.MigrationType.convertToMigrantSlot(value), nf - 1, fountainOfYouth);</span>
<span class="nc" id="L566">				});</span>
<span class="nc" id="L567">				return;</span>
			}
<span class="nc" id="L569">			Unit u = askEmigrate(europe, Europe.MigrationType.getDefaultSlot());</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">			if (u == null)</span>
<span class="nc" id="L571">				break; // Give up on failure, try again next turn</span>
<span class="nc" id="L572">			player.addModelMessage(player.getEmigrationMessage(u));</span>
		}
<span class="nc" id="L574">	}</span>

	/**
	 * Load some goods onto a carrier.
	 *
	 * @param loc
	 *            The &lt;code&gt;Location&lt;/code&gt; to load from.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to load.
	 * @param amount
	 *            The amount of goods to load.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; to load onto.
	 * @return True if the load succeeded.
	 */
	private boolean askLoadGoods(Location loc, GoodsType type, int amount, Unit carrier) {
<span class="nc" id="L590">		TradeLocation trl = carrier.getTradeLocation();</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">		if (trl == null)</span>
<span class="nc" id="L592">			return false;</span>

		// Size check, if there are spare holds they can be filled, but...
<span class="nc" id="L595">		int loadable = carrier.getLoadableAmount(type);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">		if (amount &gt; loadable)</span>
<span class="nc" id="L597">			amount = loadable;</span>

<span class="nc" id="L599">		final Player player = carrier.getOwner();</span>
<span class="nc" id="L600">		final Market market = player.getMarket();</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">		MarketWas marketWas = (market != null) ? new MarketWas(player) : null;</span>

<span class="nc bnc" id="L603" title="All 2 branches missed.">		if (carrier.isInEurope()) {</span>
			// Are the goods boycotted?
<span class="nc bnc" id="L605" title="All 2 branches missed.">			if (!player.canTrade(type))</span>
<span class="nc" id="L606">				return false;</span>

			// Check that the purchase is funded.
<span class="nc bnc" id="L609" title="All 2 branches missed.">			if (!player.checkGold(market.getBidPrice(type, amount))) {</span>
<span class="nc" id="L610">				gui.showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L611">				return false;</span>
			}
		}

		// Try to purchase.
<span class="nc" id="L616">		int oldAmount = carrier.getGoodsContainer().getGoodsCount(type);</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">		if (askServer().loadGoods(loc, type, amount, carrier)</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">				&amp;&amp; carrier.getGoodsContainer().getGoodsCount(type) != oldAmount) {</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">			if (marketWas != null)</span>
<span class="nc" id="L620">				marketWas.fireChanges(type, amount);</span>
<span class="nc" id="L621">			return true;</span>
		}
<span class="nc" id="L623">		return false;</span>
	}

	/**
	 * Set a destination for a unit.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to direct.
	 * @param destination
	 *            The destination &lt;code&gt;Location&lt;/code&gt;.
	 * @return True if the destination was set.
	 */
	private boolean askSetDestination(Unit unit, Location destination) {
<span class="nc bnc" id="L636" title="All 4 branches missed.">		return askServer().setDestination(unit, destination) &amp;&amp; unit.getDestination() == destination;</span>
	}

	/**
	 * Unload some goods from a carrier.
	 *
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to unload.
	 * @param amount
	 *            The amount of goods to unload.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
	 * @return True if the unload succeeded.
	 */
	private boolean askUnloadGoods(GoodsType type, int amount, Unit carrier) {
		// Do not check for trade location, unloading can include dumping
		// which can happen anywhere
<span class="nc" id="L653">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L654">		final Market market = player.getMarket();</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">		MarketWas marketWas = (market != null) ? new MarketWas(player) : null;</span>

<span class="nc" id="L657">		int oldAmount = carrier.getGoodsContainer().getGoodsCount(type);</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">		if (askServer().unloadGoods(type, amount, carrier)</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">				&amp;&amp; carrier.getGoodsContainer().getGoodsCount(type) != oldAmount) {</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">			if (marketWas != null)</span>
<span class="nc" id="L661">				marketWas.fireChanges(type, -amount);</span>
<span class="nc" id="L662">			return true;</span>
		}
<span class="nc" id="L664">		return false;</span>
	}

	// Utilities connected with saving the game

	/**
	 * Get the trunk of the save game string.
	 *
	 * @param game
	 *            The &lt;code&gt;Game&lt;/code&gt; to query.
	 * @return The trunk of the file name to use for saved games.
	 */
	private String getSaveGameString(Game game) {
<span class="nc" id="L677">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L678">		final String gid = Integer.toHexString(game.getUUID().hashCode());</span>
<span class="nc" id="L679">		final Turn turn = game.getTurn();</span>
<span class="nc" id="L680">		return (/* player.getName() + &quot;_&quot; */ gid + &quot;_&quot; + Messages.message(player.getNationLabel()) + &quot;_&quot;</span>
<span class="nc" id="L681">				+ turn.getSaveGameSuffix() + &quot;.&quot; + FreeCol.FREECOL_SAVE_EXTENSION).replaceAll(&quot; &quot;, &quot;_&quot;);</span>
	}

	/**
	 * Creates at least one autosave game file of the currently played game in
	 * the autosave directory. Does nothing if there is no game running.
	 */
	private void autoSaveGame() {
<span class="nc" id="L689">		final Game game = freeColClient.getGame();</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">		if (game == null)</span>
<span class="nc" id="L691">			return;</span>

		// unconditional save per round (fixed file &quot;last-turn&quot;)
<span class="nc" id="L694">		final ClientOptions options = freeColClient.getClientOptions();</span>
<span class="nc" id="L695">		final String prefix = options.getText(ClientOptions.AUTO_SAVE_PREFIX);</span>
<span class="nc" id="L696">		final String lastTurnName = prefix + &quot;-&quot; + options.getText(ClientOptions.LAST_TURN_NAME) + &quot;.&quot;</span>
				+ FreeCol.FREECOL_SAVE_EXTENSION;
<span class="nc" id="L698">		final String beforeLastTurnName = prefix + &quot;-&quot; + options.getText(ClientOptions.BEFORE_LAST_TURN_NAME) + &quot;.&quot;</span>
				+ FreeCol.FREECOL_SAVE_EXTENSION;
<span class="nc" id="L700">		File autoSaveDir = FreeColDirectories.getAutosaveDirectory();</span>
<span class="nc" id="L701">		File lastTurnFile = new File(autoSaveDir, lastTurnName);</span>
<span class="nc" id="L702">		File beforeLastTurnFile = new File(autoSaveDir, beforeLastTurnName);</span>
		// if &quot;last-turn&quot; file exists, shift it to &quot;before-last-turn&quot; file
<span class="nc bnc" id="L704" title="All 2 branches missed.">		if (lastTurnFile.exists()) {</span>
<span class="nc" id="L705">			beforeLastTurnFile.delete();</span>
<span class="nc" id="L706">			lastTurnFile.renameTo(beforeLastTurnFile);</span>
		}
<span class="nc" id="L708">		saveGame(lastTurnFile);</span>

		// conditional save after user-set period
<span class="nc" id="L711">		int saveGamePeriod = options.getInteger(ClientOptions.AUTOSAVE_PERIOD);</span>
<span class="nc" id="L712">		int turnNumber = game.getTurn().getNumber();</span>
<span class="nc bnc" id="L713" title="All 4 branches missed.">		if (saveGamePeriod &gt;= 1 &amp;&amp; turnNumber % saveGamePeriod == 0) {</span>
<span class="nc" id="L714">			String fileName = prefix + &quot;-&quot; + getSaveGameString(game);</span>
<span class="nc" id="L715">			saveGame(new File(autoSaveDir, fileName));</span>
		}
<span class="nc" id="L717">	}</span>

	/**
	 * Saves the game to the given file.
	 *
	 * @param file
	 *            The &lt;code&gt;File&lt;/code&gt;.
	 * @return True if the game was saved.
	 */
	private boolean saveGame(final File file) {
<span class="nc" id="L727">		final FreeColServer server = freeColClient.getFreeColServer();</span>
<span class="nc" id="L728">		boolean result = false;</span>
<span class="nc" id="L729">		gui.showStatusPanel(Messages.message(&quot;status.savingGame&quot;));</span>
		try {
<span class="nc" id="L731">			server.setActiveUnit(gui.getActiveUnit());</span>
<span class="nc" id="L732">			server.saveGame(file, freeColClient.getClientOptions());</span>
<span class="nc" id="L733">			result = true;</span>
<span class="nc" id="L734">		} catch (IOException e) {</span>
<span class="nc" id="L735">			gui.showErrorMessage(FreeCol.badSave(file));</span>
		} finally {
<span class="nc" id="L737">			gui.closeStatusPanel();</span>
<span class="nc" id="L738">		}</span>
<span class="nc" id="L739">		return result;</span>
	}

	// Utilities for message handling.

	/**
	 * Provides an opportunity to filter the messages delivered to the canvas.
	 *
	 * @param message
	 *            the message that is candidate for delivery to the canvas
	 * @return true if the message should be delivered
	 */
	private boolean shouldAllowMessage(ModelMessage message) {
<span class="nc" id="L752">		BooleanOption option = freeColClient.getClientOptions().getBooleanOption(message);</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">		return (option == null) ? true : option.getValue();</span>
	}

	/**
	 * Start ignoring a kind of message.
	 *
	 * @param key
	 *            The key for a message to ignore.
	 * @param turn
	 *            The current &lt;code&gt;Turn&lt;/code&gt;.
	 */
	private synchronized void startIgnoringMessage(String key, Turn turn) {
<span class="nc" id="L765">		messagesToIgnore.put(key, turn.getNumber());</span>
<span class="nc" id="L766">		logger.finer(&quot;Ignore message start: &quot; + key);</span>
<span class="nc" id="L767">	}</span>

	/**
	 * Stop ignoring a kind of message.
	 *
	 * @param key
	 *            The key for a message to stop ignoring.
	 */
	private synchronized void stopIgnoringMessage(String key) {
<span class="nc" id="L776">		messagesToIgnore.remove(key);</span>
<span class="nc" id="L777">		logger.finer(&quot;Ignore message stop: &quot; + key);</span>
<span class="nc" id="L778">	}</span>

	/**
	 * Reap all ignored message keys that are older than the given turn.
	 *
	 * @param turn
	 *            The &lt;code&gt;Turn&lt;/code&gt; value to test against.
	 */
	private synchronized void reapIgnoredMessages(Turn turn) {
<span class="nc" id="L787">		Iterator&lt;String&gt; keys = messagesToIgnore.keySet().iterator();</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">		while (keys.hasNext()) {</span>
<span class="nc" id="L789">			String key = keys.next();</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">			if (messagesToIgnore.get(key) &lt; turn.getNumber()) {</span>
<span class="nc" id="L791">				keys.remove();</span>
<span class="nc" id="L792">				logger.finer(&quot;Ignore message reap: &quot; + key);</span>
			}
<span class="nc" id="L794">		}</span>
<span class="nc" id="L795">	}</span>

	/**
	 * See if messages with a given key were ignored last turn. If so, continue
	 * to ignore them.
	 *
	 * @param key
	 *            The key to check.
	 * @param turn
	 *            The current &lt;code&gt;Turn&lt;/code&gt;.
	 * @return True if the message should continue to be ignored.
	 */
	private synchronized boolean continueIgnoreMessage(String key, Turn turn) {
		Integer value;
<span class="nc bnc" id="L809" title="All 6 branches missed.">		if (key != null &amp;&amp; (value = messagesToIgnore.get(key)) != null &amp;&amp; value + 1 == turn.getNumber()) {</span>
<span class="nc" id="L810">			messagesToIgnore.put(key, value + 1);</span>
<span class="nc" id="L811">			logger.finer(&quot;Ignore message continue: &quot; + key);</span>
<span class="nc" id="L812">			return true;</span>
		}
<span class="nc" id="L814">		return false;</span>
	}

	/**
	 * Displays the messages in the current turn report.
	 */
	public void displayTurnReportMessages() {
<span class="nc" id="L821">		gui.showReportTurnPanel(turnReportMessages);</span>
<span class="nc" id="L822">	}</span>

	/**
	 * Displays pending &lt;code&gt;ModelMessage&lt;/code&gt;s.
	 *
	 * @param allMessages
	 *            Display all messages or just the undisplayed ones.
	 * @param endOfTurn
	 *            Use a turn report panel if necessary.
	 * @return True if any messages were displayed.
	 */
	public boolean displayModelMessages(final boolean allMessages, final boolean endOfTurn) {
<span class="nc" id="L834">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L835">		final Turn thisTurn = freeColClient.getGame().getTurn();</span>
<span class="nc" id="L836">		final ArrayList&lt;ModelMessage&gt; messages = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L838" title="All 4 branches missed.">		for (ModelMessage m : ((allMessages) ? player.getModelMessages() : player.getNewModelMessages())) {</span>
<span class="nc bnc" id="L839" title="All 4 branches missed.">			if (shouldAllowMessage(m) &amp;&amp; !continueIgnoreMessage(m.getIgnoredMessageKey(), thisTurn)) {</span>
<span class="nc" id="L840">				messages.add(m);</span>
			}
<span class="nc" id="L842">			m.setBeenDisplayed(true);</span>
<span class="nc" id="L843">		}</span>

<span class="nc" id="L845">		reapIgnoredMessages(thisTurn);</span>

<span class="nc bnc" id="L847" title="All 2 branches missed.">		if (!messages.isEmpty()) {</span>
			Runnable uiTask;
<span class="nc bnc" id="L849" title="All 2 branches missed.">			if (endOfTurn) {</span>
<span class="nc" id="L850">				turnReportMessages.addAll(messages);</span>
<span class="nc" id="L851">				uiTask = () -&gt; {</span>
<span class="nc" id="L852">					displayTurnReportMessages();</span>
<span class="nc" id="L853">				};</span>
			} else {
<span class="nc" id="L855">				uiTask = () -&gt; {</span>
<span class="nc" id="L856">					gui.showModelMessages(messages);</span>
<span class="nc" id="L857">				};</span>
			}
<span class="nc" id="L859">			gui.invokeNowOrWait(uiTask);</span>
		}
<span class="nc bnc" id="L861" title="All 2 branches missed.">		return !messages.isEmpty();</span>
	}

	// Utilities to handle the transitions between the active-unit,
	// execute-orders and end-turn states.

	/**
	 * Do the goto orders operation.
	 *
	 * @return True if all goto orders have been performed and no units reached
	 *         their destination and are free to move again.
	 */
	private boolean doExecuteGotoOrders() {
<span class="nc bnc" id="L874" title="All 2 branches missed.">		if (gui.isShowingSubPanel())</span>
<span class="nc" id="L875">			return false; // Clear the panel first</span>

<span class="nc" id="L877">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L878">		final Unit active = gui.getActiveUnit();</span>
<span class="nc" id="L879">		Unit stillActive = null;</span>

		// Ensure the goto mode sticks.
<span class="nc" id="L882">		moveMode = moveMode.maximize(MoveMode.EXECUTE_GOTO_ORDERS);</span>

		// Deal with the trade route units first.
<span class="nc" id="L885">		List&lt;ModelMessage&gt; messages = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">		while (player.hasNextTradeRouteUnit()) {</span>
<span class="nc" id="L887">			Unit unit = player.getNextTradeRouteUnit();</span>
<span class="nc" id="L888">			gui.setActiveUnit(unit);</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">			if (moveToDestination(unit, messages))</span>
<span class="nc" id="L890">				stillActive = unit;</span>
<span class="nc" id="L891">		}</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">		if (!messages.isEmpty()) {</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">			for (ModelMessage m : messages) {</span>
<span class="nc" id="L894">				player.addModelMessage(m);</span>
<span class="nc" id="L895">				turnReportMessages.add(m);</span>
<span class="nc" id="L896">			}</span>
<span class="nc" id="L897">			displayModelMessages(false, false);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">			gui.setActiveUnit((stillActive != null) ? stillActive : active);</span>
<span class="nc" id="L899">			return false;</span>
		}

		// The active unit might also be a going-to unit. Make sure it
		// gets processed first. setNextGoingToUnit will fail harmlessly
		// if it is not a going-to unit so this is safe.
<span class="nc bnc" id="L905" title="All 2 branches missed.">		if (active != null)</span>
<span class="nc" id="L906">			player.setNextGoingToUnit(active);</span>

		// Process all units.
<span class="nc bnc" id="L909" title="All 2 branches missed.">		while (player.hasNextGoingToUnit()) {</span>
<span class="nc" id="L910">			Unit unit = player.getNextGoingToUnit();</span>
<span class="nc" id="L911">			gui.setActiveUnit(unit);</span>
			// Move the unit as much as possible
<span class="nc bnc" id="L913" title="All 2 branches missed.">			if (moveToDestination(unit, null))</span>
<span class="nc" id="L914">				stillActive = unit;</span>

			// Might have LCR messages to display
<span class="nc" id="L917">			displayModelMessages(false, false);</span>

			// Give the player a chance to deal with any problems
			// shown in a popup before pressing on with more moves.
<span class="nc bnc" id="L921" title="All 2 branches missed.">			if (gui.isShowingSubPanel()) {</span>
<span class="nc" id="L922">				gui.requestFocusForSubPanel();</span>
<span class="nc" id="L923">				break;</span>
			}
<span class="nc" id="L925">		}</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">		gui.setActiveUnit((stillActive != null) ? stillActive : active);</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">		return stillActive == null;</span>
	}

	/**
	 * End the turn.
	 *
	 * @param showDialog
	 *            Show the end turn dialog?
	 * @return True if the turn ended.
	 */
	private boolean doEndTurn(boolean showDialog) {
<span class="nc bnc" id="L938" title="All 2 branches missed.">		if (showDialog) {</span>
<span class="nc" id="L939">			List&lt;Unit&gt; units = freeColClient.getMyPlayer().getUnits().stream().filter(Unit::couldMove)</span>
<span class="nc" id="L940">					.collect(Collectors.toList());</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">			if (!units.isEmpty()) {</span>
				// Modal dialog takes over
<span class="nc" id="L943">				gui.showEndTurnDialog(units, (Boolean value) -&gt; {</span>
<span class="nc bnc" id="L944" title="All 4 branches missed.">					if (value != null &amp;&amp; value) {</span>
<span class="nc" id="L945">						endTurn(false);</span>
					}
<span class="nc" id="L947">				});</span>
<span class="nc" id="L948">				return false;</span>
			}
		}

		// Ensure end-turn mode sticks.
<span class="nc" id="L953">		moveMode = moveMode.maximize(MoveMode.END_TURN);</span>

		// Make sure all goto orders are complete before ending turn.
<span class="nc bnc" id="L956" title="All 2 branches missed.">		if (!doExecuteGotoOrders())</span>
<span class="nc" id="L957">			return false;</span>

		// Check for desync as last thing!
<span class="nc bnc" id="L960" title="All 2 branches missed.">		if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.DESYNC)</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">				&amp;&amp; DebugUtils.checkDesyncAction(freeColClient)) {</span>
<span class="nc" id="L962">			freeColClient.getConnectController().reconnect();</span>
<span class="nc" id="L963">			return false;</span>
		}

		// Clean up lingering menus.
<span class="nc" id="L967">		gui.closeMenus();</span>

		// Clear active unit if any.
<span class="nc" id="L970">		gui.setActiveUnit(null);</span>

		// Unskip all skipped, some may have been faked in-client.
		// Server-side skipped units are set active in csNewTurn.
<span class="nc bnc" id="L974" title="All 2 branches missed.">		for (Unit unit : freeColClient.getMyPlayer().getUnits()) {</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">			if (unit.getState() == UnitState.SKIPPED) {</span>
<span class="nc" id="L976">				unit.setState(UnitState.ACTIVE);</span>
			}
<span class="nc" id="L978">		}</span>

		// Restart the selection cycle.
<span class="nc" id="L981">		moveMode = MoveMode.NEXT_ACTIVE_UNIT;</span>

		// Clear outdated turn report messages.
<span class="nc" id="L984">		turnReportMessages.clear();</span>

		// Inform the server of end of turn.
<span class="nc" id="L987">		return askServer().endTurn();</span>
	}

	/**
	 * Makes a new unit active if any, or focus on a tile (useful if the current
	 * unit just died).
	 *
	 * Displays any new &lt;code&gt;ModelMessage&lt;/code&gt;s with
	 * {@link #nextModelMessage}.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to select if no new unit can be made
	 *            active.
	 * @return True if the active unit changes.
	 */
	private boolean updateActiveUnit(Tile tile) {
		// Make sure the active unit is done.
<span class="nc" id="L1004">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L1005">		Unit unit = gui.getActiveUnit();</span>
<span class="nc bnc" id="L1006" title="All 4 branches missed.">		if (unit != null &amp;&amp; unit.couldMove())</span>
<span class="nc" id="L1007">			return false;</span>

		// Flush any outstanding orders once the mode is raised.
<span class="nc bnc" id="L1010" title="All 4 branches missed.">		if (moveMode != MoveMode.NEXT_ACTIVE_UNIT &amp;&amp; !doExecuteGotoOrders()) {</span>
<span class="nc" id="L1011">			return false;</span>
		}

		// Successfully found a unit to display
<span class="nc bnc" id="L1015" title="All 2 branches missed.">		if (player.hasNextActiveUnit()) {</span>
<span class="nc" id="L1016">			gui.setActiveUnit(player.getNextActiveUnit());</span>
<span class="nc" id="L1017">			return true;</span>
		}

		// No unit to find.
<span class="nc" id="L1021">		gui.setActiveUnit(null);</span>

		// No active units left. Do the goto orders.
<span class="nc bnc" id="L1024" title="All 2 branches missed.">		if (!doExecuteGotoOrders())</span>
<span class="nc" id="L1025">			return true;</span>

		// If not already ending the turn, use the fallback tile if
		// supplied, then check for automatic end of turn, otherwise
		// just select nothing and wait.
<span class="nc" id="L1030">		final ClientOptions options = freeColClient.getClientOptions();</span>
<span class="nc bnc" id="L1031" title="All 2 branches missed.">		if (tile != null) {</span>
<span class="nc" id="L1032">			gui.setSelectedTile(tile);</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">		} else if (options.getBoolean(ClientOptions.AUTO_END_TURN)) {</span>
<span class="nc" id="L1034">			doEndTurn(options.getBoolean(ClientOptions.SHOW_END_TURN_DIALOG));</span>
		}
<span class="nc" id="L1036">		return true;</span>
	}

	// Movement support.

	/**
	 * Moves the given unit towards its destination/s if possible.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to move.
	 * @param messages
	 *            An optional list in which to retain any trade route
	 *            &lt;code&gt;ModelMessage&lt;/code&gt;s generated.
	 * @return True if the unit reached its destination, is still alive, and has
	 *         more moves to make.
	 */
	private boolean moveToDestination(Unit unit, List&lt;ModelMessage&gt; messages) {
		Location destination;
<span class="nc bnc" id="L1054" title="All 8 branches missed.">		if (!requireOurTurn() || unit.isAtSea() || unit.getMovesLeft() &lt;= 0 || unit.getState() == UnitState.SKIPPED) {</span>
<span class="nc" id="L1055">			return false;</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">		} else if (unit.getTradeRoute() != null) {</span>
<span class="nc" id="L1057">			return followTradeRoute(unit, messages);</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">		} else if ((destination = unit.getDestination()) == null) {</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">			return unit.getMovesLeft() &gt; 0;</span>
		}

		// Find a path to the destination and try to follow it.
<span class="nc" id="L1063">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L1064">		PathNode path = unit.findPath(destination);</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">		if (path == null) {</span>
<span class="nc" id="L1066">			StringTemplate src = unit.getLocation().getLocationLabelFor(player);</span>
<span class="nc" id="L1067">			StringTemplate dst = destination.getLocationLabelFor(player);</span>
<span class="nc" id="L1068">			StringTemplate template = StringTemplate.template(&quot;info.moveToDestinationFailed&quot;)</span>
<span class="nc" id="L1069">					.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1070">					.addStringTemplate(&quot;%location%&quot;, src).addStringTemplate(&quot;%destination%&quot;, dst);</span>
<span class="nc" id="L1071">			gui.showInformationMessage(unit, template);</span>
<span class="nc" id="L1072">			return false;</span>
		}
<span class="nc" id="L1074">		gui.setActiveUnit(unit);</span>

		// Clear ordinary destinations if arrived.
<span class="nc bnc" id="L1077" title="All 4 branches missed.">		if (movePath(unit, path) &amp;&amp; unit.isAtLocation(destination)) {</span>
<span class="nc" id="L1078">			askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">			Colony colony = (unit.hasTile()) ? unit.getTile().getColony() : null;</span>
<span class="nc bnc" id="L1080" title="All 4 branches missed.">			if (colony != null &amp;&amp; !checkCashInTreasureTrain(unit)) {</span>
<span class="nc" id="L1081">				colonyPanel(colony, unit);</span>
			}
<span class="nc" id="L1083">			return unit.couldMove();</span>
		}
<span class="nc" id="L1085">		return false;</span>
	}

	/**
	 * Move a unit in a given direction.
	 *
	 * Public for the test suite.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to move.
	 * @param direction
	 *            The &lt;code&gt;Direction&lt;/code&gt; to move in.
	 * @param interactive
	 *            Interactive mode: play sounds and emit errors.
	 * @return True if the unit can possibly move further.
	 */
	public boolean moveDirection(Unit unit, Direction direction, boolean interactive) {
		// If this move would reach the unit destination but we
		// discover that it would be permanently impossible to complete,
		// clear the destination.
<span class="nc" id="L1105">		Unit.MoveType mt = unit.getMoveType(direction);</span>
<span class="nc" id="L1106">		Location destination = unit.getDestination();</span>
<span class="nc" id="L1107">		Tile oldTile = unit.getTile();</span>
<span class="nc bnc" id="L1108" title="All 4 branches missed.">		boolean clearDestination = destination != null &amp;&amp; oldTile != null</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">				&amp;&amp; Map.isSameLocation(oldTile.getNeighbourOrNull(direction), destination);</span>

		// Consider all the move types.
<span class="nc" id="L1112">		boolean result = mt.isLegal();</span>
<span class="nc bnc" id="L1113" title="All 25 branches missed.">		switch (mt) {</span>
		case MOVE_HIGH_SEAS:
<span class="nc bnc" id="L1115" title="All 2 branches missed.">			if (freeColClient.getMyPlayer().getEurope() == null) {</span>
				; // do nothing
<span class="nc bnc" id="L1117" title="All 2 branches missed.">			} else if (destination == null) {</span>
<span class="nc" id="L1118">				result = moveHighSeas(unit, direction);</span>
<span class="nc" id="L1119">				break;</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">			} else if (destination instanceof Europe) {</span>
<span class="nc" id="L1121">				result = moveTo(unit, destination);</span>
<span class="nc" id="L1122">				break;</span>
			}
			// Fall through
		case MOVE:
<span class="nc" id="L1126">			result = moveMove(unit, direction);</span>
<span class="nc" id="L1127">			break;</span>
		case EXPLORE_LOST_CITY_RUMOUR:
<span class="nc" id="L1129">			result = moveExplore(unit, direction);</span>
<span class="nc" id="L1130">			break;</span>
		case ATTACK_UNIT:
<span class="nc" id="L1132">			result = moveAttack(unit, direction);</span>
<span class="nc" id="L1133">			break;</span>
		case ATTACK_SETTLEMENT:
<span class="nc" id="L1135">			result = moveAttackSettlement(unit, direction);</span>
<span class="nc" id="L1136">			break;</span>
		case EMBARK:
<span class="nc" id="L1138">			result = moveEmbark(unit, direction);</span>
<span class="nc" id="L1139">			break;</span>
		case ENTER_INDIAN_SETTLEMENT_WITH_FREE_COLONIST:
<span class="nc" id="L1141">			result = moveLearnSkill(unit, direction);</span>
<span class="nc" id="L1142">			break;</span>
		case ENTER_INDIAN_SETTLEMENT_WITH_SCOUT:
<span class="nc" id="L1144">			result = moveScoutIndianSettlement(unit, direction);</span>
<span class="nc" id="L1145">			break;</span>
		case ENTER_INDIAN_SETTLEMENT_WITH_MISSIONARY:
<span class="nc" id="L1147">			result = moveUseMissionary(unit, direction);</span>
<span class="nc" id="L1148">			break;</span>
		case ENTER_FOREIGN_COLONY_WITH_SCOUT:
<span class="nc" id="L1150">			result = moveScoutColony(unit, direction);</span>
<span class="nc" id="L1151">			break;</span>
		case ENTER_SETTLEMENT_WITH_CARRIER_AND_GOODS:
<span class="nc" id="L1153">			result = moveTrade(unit, direction);</span>
<span class="nc" id="L1154">			break;</span>

		// Illegal moves
		case MOVE_NO_ACCESS_BEACHED:
<span class="nc bnc" id="L1158" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1159">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1160">				StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1161">				gui.showInformationMessage(unit,</span>
<span class="nc" id="L1162">						StringTemplate.template(&quot;move.noAccessBeached&quot;).addStringTemplate(&quot;%nation%&quot;, nation));</span>
<span class="nc" id="L1163">			}</span>
			break;
		case MOVE_NO_ACCESS_CONTACT:
<span class="nc bnc" id="L1166" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1167">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1168">				StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1169">				gui.showInformationMessage(unit,</span>
<span class="nc" id="L1170">						StringTemplate.template(&quot;move.noAccessContact&quot;).addStringTemplate(&quot;%nation%&quot;, nation));</span>
<span class="nc" id="L1171">			}</span>
			break;
		case MOVE_NO_ACCESS_GOODS:
<span class="nc bnc" id="L1174" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1175">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1176">				StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1177">				gui.showInformationMessage(unit,</span>
<span class="nc" id="L1178">						StringTemplate.template(&quot;move.noAccessGoods&quot;).addStringTemplate(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L1179">								.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
<span class="nc" id="L1180">			}</span>
			break;
		case MOVE_NO_ACCESS_LAND:
<span class="nc bnc" id="L1183" title="All 2 branches missed.">			if (!moveDisembark(unit, direction)) {</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">				if (interactive) {</span>
<span class="nc" id="L1185">					sound(&quot;sound.event.illegalMove&quot;);</span>
				}
			}
			break;
		case MOVE_NO_ACCESS_MISSION_BAN:
<span class="nc bnc" id="L1190" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1191">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1192">				StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1193">				gui.showInformationMessage(unit,</span>
<span class="nc" id="L1194">						StringTemplate.template(&quot;move.noAccessMissionBan&quot;)</span>
<span class="nc" id="L1195">								.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1196">								.addStringTemplate(&quot;%nation%&quot;, nation));</span>
<span class="nc" id="L1197">			}</span>
			break;
		case MOVE_NO_ACCESS_SETTLEMENT:
<span class="nc bnc" id="L1200" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1201">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1202">				StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1203">				gui.showInformationMessage(unit,</span>
<span class="nc" id="L1204">						StringTemplate.template(&quot;move.noAccessSettlement&quot;)</span>
<span class="nc" id="L1205">								.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1206">								.addStringTemplate(&quot;%nation%&quot;, nation));</span>
<span class="nc" id="L1207">			}</span>
			break;
		case MOVE_NO_ACCESS_SKILL:
<span class="nc bnc" id="L1210" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1211">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1212">				gui.showInformationMessage(unit, StringTemplate.template(&quot;move.noAccessSkill&quot;)</span>
<span class="nc" id="L1213">						.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
			}
			break;
		case MOVE_NO_ACCESS_TRADE:
<span class="nc bnc" id="L1217" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1218">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1219">				StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1220">				gui.showInformationMessage(unit,</span>
<span class="nc" id="L1221">						StringTemplate.template(&quot;move.noAccessTrade&quot;).addStringTemplate(&quot;%nation%&quot;, nation));</span>
<span class="nc" id="L1222">			}</span>
			break;
		case MOVE_NO_ACCESS_WAR:
<span class="nc bnc" id="L1225" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1226">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1227">				StringTemplate nation = getNationAt(unit.getTile(), direction);</span>
<span class="nc" id="L1228">				gui.showInformationMessage(unit,</span>
<span class="nc" id="L1229">						StringTemplate.template(&quot;move.noAccessWar&quot;).addStringTemplate(&quot;%nation%&quot;, nation));</span>
<span class="nc" id="L1230">			}</span>
			break;
		case MOVE_NO_ACCESS_WATER:
<span class="nc bnc" id="L1233" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1234">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1235">				gui.showInformationMessage(unit, StringTemplate.template(&quot;move.noAccessWater&quot;)</span>
<span class="nc" id="L1236">						.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
			}
			break;
		case MOVE_NO_ATTACK_MARINE:
<span class="nc bnc" id="L1240" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1241">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1242">				gui.showInformationMessage(unit, StringTemplate.template(&quot;move.noAttackWater&quot;)</span>
<span class="nc" id="L1243">						.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
			}
			break;
		case MOVE_NO_MOVES:
			// The unit may have some moves left, but not enough
			// to move to the next node. The move is illegal
			// this turn, but might not be next turn, so do not cancel the
			// destination but set the state to skipped instead.
<span class="nc" id="L1251">			clearDestination = false;</span>
<span class="nc" id="L1252">			unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L1253">			break;</span>
		case MOVE_NO_TILE:
<span class="nc bnc" id="L1255" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1256">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L1257">				gui.showInformationMessage(unit, StringTemplate.template(&quot;move.noTile&quot;).addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L1258">						unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
			}
			break;
		default:
<span class="nc bnc" id="L1262" title="All 4 branches missed.">			if (interactive || clearDestination) {</span>
<span class="nc" id="L1263">				sound(&quot;sound.event.illegalMove&quot;);</span>
			}
<span class="nc" id="L1265">			result = false;</span>
			break;
		}
<span class="nc bnc" id="L1268" title="All 4 branches missed.">		if (clearDestination &amp;&amp; !unit.isDisposed()) {</span>
<span class="nc" id="L1269">			askClearGotoOrders(unit);</span>
		}
<span class="nc" id="L1271">		return result;</span>
	}

	/**
	 * Follow a path.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to move.
	 * @param path
	 *            The path to follow.
	 * @return True if the unit has completed the path and can move further.
	 */
	private boolean movePath(Unit unit, PathNode path) {
<span class="nc bnc" id="L1284" title="All 2 branches missed.">		for (; path != null; path = path.next) {</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">			if (unit.isAtLocation(path.getLocation()))</span>
<span class="nc" id="L1286">				continue;</span>

<span class="nc bnc" id="L1288" title="All 2 branches missed.">			if (path.getLocation() instanceof Europe) {</span>
<span class="nc bnc" id="L1289" title="All 4 branches missed.">				if (unit.hasTile() &amp;&amp; unit.getTile().isDirectlyHighSeasConnected()) {</span>
<span class="nc" id="L1290">					moveTo(unit, path.getLocation());</span>
				} else {
<span class="nc" id="L1292">					logger.warning(&quot;Can not move to Europe from &quot; + unit.getLocation() + &quot; on path: &quot;</span>
<span class="nc" id="L1293">							+ path.fullPathToString());</span>
				}
<span class="nc" id="L1295">				return false;</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">			} else if (path.getLocation() instanceof Tile) {</span>
<span class="nc bnc" id="L1297" title="All 2 branches missed.">				if (path.getDirection() == null) {</span>
<span class="nc bnc" id="L1298" title="All 2 branches missed.">					if (unit.isInEurope()) {</span>
<span class="nc" id="L1299">						moveTo(unit, unit.getGame().getMap());</span>
					} else {
<span class="nc" id="L1301">						logger.warning(&quot;Null direction on path: &quot; + path.fullPathToString());</span>
					}
<span class="nc" id="L1303">					return false;</span>
				} else {
<span class="nc bnc" id="L1305" title="All 2 branches missed.">					if (!moveDirection(unit, path.getDirection(), false)) {</span>
<span class="nc" id="L1306">						return false;</span>
					}
<span class="nc bnc" id="L1308" title="All 4 branches missed.">					if (unit.hasTile() &amp;&amp; unit.getTile().getDiscoverableRegion() != null) {</span>
						// Break up the goto to allow region naming to occur,
						// BR#2707
<span class="nc" id="L1311">						return false;</span>
					}
				}
<span class="nc bnc" id="L1314" title="All 2 branches missed.">			} else if (path.getLocation() instanceof Unit) {</span>
<span class="nc" id="L1315">				return moveEmbark(unit, path.getDirection());</span>

			} else {
<span class="nc" id="L1318">				logger.warning(&quot;Bad path: &quot; + path.fullPathToString());</span>
			}
		}
<span class="nc" id="L1321">		return true;</span>
	}

	/**
	 * Confirm attack or demand a tribute from a native settlement, following an
	 * attacking move.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to perform the attack.
	 * @param direction
	 *            The direction in which to attack.
	 * @return True if the unit could move further.
	 */
	private boolean moveAttack(Unit unit, Direction direction) {
<span class="nc" id="L1335">		Tile tile = unit.getTile();</span>
<span class="nc" id="L1336">		Tile target = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1337">		Unit u = target.getFirstUnit();</span>
<span class="nc bnc" id="L1338" title="All 4 branches missed.">		if (u == null || unit.getOwner().owns(u))</span>
<span class="nc" id="L1339">			return false;</span>

<span class="nc" id="L1341">		askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L1342" title="All 4 branches missed.">		if (gui.confirmHostileAction(unit, target) &amp;&amp; gui.confirmPreCombat(unit, target)) {</span>
<span class="nc" id="L1343">			askServer().attack(unit, direction);</span>
		}
		// Always return false, as the unit has either attacked and lost
		// its remaining moves, or the move can not proceed because it is
		// blocked.
<span class="nc" id="L1348">		return false;</span>
	}

	/**
	 * Confirm attack or demand a tribute from a settlement, following an
	 * attacking move.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to perform the attack.
	 * @param direction
	 *            The direction in which to attack.
	 * @return True if the unit could move further.
	 */
	private boolean moveAttackSettlement(Unit unit, Direction direction) {
<span class="nc" id="L1362">		Tile tile = unit.getTile();</span>
<span class="nc" id="L1363">		Tile target = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1364">		Settlement settlement = target.getSettlement();</span>
<span class="nc bnc" id="L1365" title="All 4 branches missed.">		if (settlement == null || unit.getOwner().owns(settlement))</span>
<span class="nc" id="L1366">			return false;</span>

<span class="nc" id="L1368">		ArmedUnitSettlementAction act = gui.getArmedUnitSettlementChoice(settlement);</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">		if (act == null)</span>
<span class="nc" id="L1370">			return true; // Cancelled</span>
<span class="nc bnc" id="L1371" title="All 3 branches missed.">		switch (act) {</span>
		case SETTLEMENT_ATTACK:
<span class="nc bnc" id="L1373" title="All 4 branches missed.">			if (gui.confirmHostileAction(unit, target) &amp;&amp; gui.confirmPreCombat(unit, target)) {</span>
<span class="nc" id="L1374">				askServer().attack(unit, direction);</span>
<span class="nc" id="L1375">				Colony col = target.getColony();</span>
<span class="nc bnc" id="L1376" title="All 4 branches missed.">				if (col != null &amp;&amp; unit.getOwner().owns(col)) {</span>
<span class="nc" id="L1377">					colonyPanel(col, unit);</span>
				}
<span class="nc" id="L1379">				return false;</span>
			}
			break;
		case SETTLEMENT_TRIBUTE:
<span class="nc bnc" id="L1383" title="All 2 branches missed.">			int amount = (settlement instanceof Colony)</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">					? gui.confirmEuropeanTribute(unit, (Colony) settlement, getNationSummary(settlement.getOwner()))</span>
					: (settlement instanceof IndianSettlement)
<span class="nc" id="L1386">							? gui.confirmNativeTribute(unit, (IndianSettlement) settlement) : -1;</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">			if (amount &lt;= 0)</span>
<span class="nc" id="L1388">				return true; // Cancelled</span>
<span class="nc" id="L1389">			return moveTribute(unit, amount, direction);</span>

		default:
<span class="nc" id="L1392">			logger.warning(&quot;showArmedUnitSettlementDialog fail: &quot; + act);</span>
			break;
		}
<span class="nc" id="L1395">		return true;</span>
	}

	/**
	 * Initiates diplomacy with a foreign power.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; negotiating.
	 * @param direction
	 *            The direction of a settlement to negotiate with.
	 * @param dt
	 *            The base &lt;code&gt;DiplomaticTrade&lt;/code&gt; agreement to begin the
	 *            negotiation with.
	 * @return True if the unit can move further.
	 */
	private boolean moveDiplomacy(Unit unit, Direction direction, DiplomaticTrade dt) {
<span class="nc" id="L1411">		Settlement settlement = getSettlementAt(unit.getTile(), direction);</span>
<span class="nc bnc" id="L1412" title="All 4 branches missed.">		if (settlement == null || !(settlement instanceof Colony))</span>
<span class="nc" id="L1413">			return false;</span>
<span class="nc" id="L1414">		Colony colony = (Colony) settlement;</span>

		// Can not negotiate with the REF.
<span class="nc" id="L1417">		final Game game = freeColClient.getGame();</span>
<span class="nc" id="L1418">		final Player player = unit.getOwner();</span>
<span class="nc" id="L1419">		final Player other = colony.getOwner();</span>
<span class="nc bnc" id="L1420" title="All 2 branches missed.">		if (other == player.getREFPlayer())</span>
<span class="nc" id="L1421">			return false;</span>

<span class="nc" id="L1423">		StringTemplate nation = other.getNationLabel();</span>
<span class="nc bnc" id="L1424" title="All 2 branches missed.">		while (dt != null) {</span>
			// Inform server of current agreement.
<span class="nc" id="L1426">			dt = askServer().diplomacy(game, unit, colony, dt);</span>
			// Returned dt will be null if we sent or the other player
			// replied with an accept/reject. Otherwise consider
			// counter proposal.
<span class="nc bnc" id="L1430" title="All 2 branches missed.">			if (dt != null) {</span>
<span class="nc" id="L1431">				dt = gui.showNegotiationDialog(unit, colony, dt, dt.getSendMessage(player, colony));</span>
			}
		}
<span class="nc" id="L1434">		return false;</span>
	}

	/**
	 * Check the carrier for passengers to disembark, possibly snatching a
	 * useful result from the jaws of a MOVE_NO_ACCESS_LAND failure.
	 *
	 * @param unit
	 *            The carrier containing the unit to disembark.
	 * @param direction
	 *            The direction in which to disembark the unit.
	 * @return True if the disembark &quot;succeeds&quot; (which deliberately includes
	 *         declined disembarks).
	 */
	private boolean moveDisembark(Unit unit, final Direction direction) {
<span class="nc" id="L1449">		Tile tile = unit.getTile().getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L1450" title="All 4 branches missed.">		if (tile.getFirstUnit() != null &amp;&amp; tile.getFirstUnit().getOwner() != unit.getOwner()) {</span>
<span class="nc" id="L1451">			return false; // Can not disembark onto other nation units.</span>
		}

		// Disembark selected units able to move.
<span class="nc" id="L1455">		unit.setStateToAllChildren(UnitState.ACTIVE);</span>
<span class="nc" id="L1456">		final List&lt;Unit&gt; disembarkable = unit.getUnitList().stream().filter(u -&gt; u.getMoveType(tile).isProgress())</span>
<span class="nc" id="L1457">				.collect(Collectors.toList());</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">		if (disembarkable.isEmpty())</span>
<span class="nc" id="L1459">			return false; // Fail, did not find one</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">		if (disembarkable.size() == 1) {</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">			if (gui.confirm(tile, StringTemplate.key(&quot;disembark.text&quot;), disembarkable.get(0), &quot;ok&quot;, &quot;cancel&quot;)) {</span>
<span class="nc" id="L1462">				moveDirection(disembarkable.get(0), direction, false);</span>
			}
		} else {
<span class="nc" id="L1465">			List&lt;ChoiceItem&lt;Unit&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1466" title="All 2 branches missed.">			for (Unit dUnit : disembarkable) {</span>
<span class="nc" id="L1467">				choices.add(new ChoiceItem&lt;&gt;(dUnit.getDescription(Unit.UnitLabelType.NATIONAL), dUnit));</span>
<span class="nc" id="L1468">			}</span>
<span class="nc" id="L1469">			choices.add(new ChoiceItem&lt;&gt;(Messages.message(&quot;all&quot;), unit));</span>

			// Use moveDirection() to disembark units as while the
			// destination tile is known to be clear of other player
			// units or settlements, it may have a rumour or need
			// other special handling.
<span class="nc" id="L1475">			Unit u = gui.getChoice(unit.getTile(), Messages.message(&quot;disembark.text&quot;), unit, &quot;none&quot;, choices);</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">			if (u == null) {</span>
				// Cancelled, done.
<span class="nc bnc" id="L1478" title="All 2 branches missed.">			} else if (u == unit) {</span>
				// Disembark all.
<span class="nc bnc" id="L1480" title="All 2 branches missed.">				for (Unit dUnit : disembarkable) {</span>
					// Guard against loss of control when asking the
					// server to move the unit.
					try {
<span class="nc" id="L1484">						moveDirection(dUnit, direction, false);</span>
					} finally {
<span class="nc" id="L1486">						continue;</span>
					}
				}
			} else {
<span class="nc" id="L1490">				moveDirection(u, direction, false);</span>
			}
		}
<span class="nc" id="L1493">		return true;</span>
	}

	/**
	 * Embarks the specified unit onto a carrier in a specified direction
	 * following a move of MoveType.EMBARK.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that wishes to embark.
	 * @param direction
	 *            The direction in which to embark.
	 * @return True if the unit could move further.
	 */
	private boolean moveEmbark(Unit unit, Direction direction) {
<span class="nc bnc" id="L1507" title="All 4 branches missed.">		if (unit.getColony() != null &amp;&amp; !gui.confirmLeaveColony(unit))</span>
<span class="nc" id="L1508">			return false;</span>

<span class="nc" id="L1510">		Tile sourceTile = unit.getTile();</span>
<span class="nc" id="L1511">		Tile destinationTile = sourceTile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1512">		Unit carrier = null;</span>
<span class="nc" id="L1513">		List&lt;ChoiceItem&lt;Unit&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1514" title="All 2 branches missed.">		for (Unit u : destinationTile.getUnitList()) {</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">			if (u.canAdd(unit)) {</span>
<span class="nc" id="L1516">				String m = u.getDescription(Unit.UnitLabelType.NATIONAL);</span>
<span class="nc" id="L1517">				choices.add(new ChoiceItem&lt;&gt;(m, u));</span>
<span class="nc" id="L1518">				carrier = u; // Save a default</span>
			}
<span class="nc" id="L1520">		}</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">		if (choices.isEmpty()) {</span>
<span class="nc" id="L1522">			throw new RuntimeException(&quot;Unit &quot; + unit.getId() + &quot; found no carrier to embark upon.&quot;);</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">		} else if (choices.size() == 1) {</span>
			// Use the default
		} else {
<span class="nc" id="L1526">			carrier = gui.getChoice(unit.getTile(), Messages.message(&quot;embark.text&quot;), unit, &quot;none&quot;, choices);</span>
<span class="nc bnc" id="L1527" title="All 2 branches missed.">			if (carrier == null)</span>
<span class="nc" id="L1528">				return true; // User cancelled</span>
		}

		// Proceed to embark
<span class="nc" id="L1532">		askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L1533" title="All 4 branches missed.">		if (!askServer().embark(unit, carrier, direction) || unit.getLocation() != carrier) {</span>
<span class="nc" id="L1534">			unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L1535">			return false;</span>
		}
<span class="nc" id="L1537">		unit.getOwner().invalidateCanSeeTiles();</span>
<span class="nc" id="L1538">		return false;</span>
	}

	/**
	 * Confirm exploration of a lost city rumour, following a move of
	 * MoveType.EXPLORE_LOST_CITY_RUMOUR.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is exploring.
	 * @param direction
	 *            The direction of a rumour.
	 * @return True if the unit can move further.
	 */
	private boolean moveExplore(Unit unit, Direction direction) {
<span class="nc" id="L1552">		Tile tile = unit.getTile().getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">		if (!gui.confirm(unit.getTile(), StringTemplate.key(&quot;exploreLostCityRumour.text&quot;), unit,</span>
				&quot;exploreLostCityRumour.yes&quot;, &quot;exploreLostCityRumour.no&quot;)) {
<span class="nc" id="L1555">			return true;</span>
		}
<span class="nc bnc" id="L1557" title="All 2 branches missed.">		if (tile.getLostCityRumour().getType() == LostCityRumour.RumourType.MOUNDS</span>
<span class="nc bnc" id="L1558" title="All 2 branches missed.">				&amp;&amp; !gui.confirm(unit.getTile(), StringTemplate.key(&quot;exploreMoundsRumour.text&quot;), unit,</span>
						&quot;exploreLostCityRumour.yes&quot;, &quot;exploreLostCityRumour.no&quot;)) {
<span class="nc" id="L1560">			askServer().declineMounds(unit, direction);</span>
		}
<span class="nc" id="L1562">		return moveMove(unit, direction);</span>
	}

	/**
	 * Moves a unit onto the &quot;high seas&quot; in a specified direction following a
	 * move of MoveType.MOVE_HIGH_SEAS. This may result in a move to Europe, no
	 * move, or an ordinary move.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to be moved.
	 * @param direction
	 *            The direction in which to move.
	 * @return True if the unit can move further.
	 */
	private boolean moveHighSeas(Unit unit, Direction direction) {
		// Confirm moving to Europe if told to move to a null tile
		// (FIXME: can this still happen?), or if crossing the boundary
		// between coastal and high sea. Otherwise just move.
<span class="nc" id="L1580">		Tile oldTile = unit.getTile();</span>
<span class="nc" id="L1581">		Tile newTile = oldTile.getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L1582" title="All 6 branches missed.">		if (newTile == null || (!oldTile.isDirectlyHighSeasConnected() &amp;&amp; newTile.isDirectlyHighSeasConnected())) {</span>
<span class="nc bnc" id="L1583" title="All 2 branches missed.">			if (unit.getTradeRoute() != null) {</span>
<span class="nc" id="L1584">				TradeRouteStop stop = unit.getStop();</span>
<span class="nc bnc" id="L1585" title="All 6 branches missed.">				if (stop != null &amp;&amp; TradeRoute.isStopValid(unit, stop) &amp;&amp; stop.getLocation() instanceof Europe) {</span>
<span class="nc" id="L1586">					moveTo(unit, stop.getLocation());</span>
<span class="nc" id="L1587">					return false;</span>
				}
<span class="nc bnc" id="L1589" title="All 2 branches missed.">			} else if (unit.getDestination() instanceof Europe) {</span>
<span class="nc" id="L1590">				moveTo(unit, unit.getDestination());</span>
<span class="nc" id="L1591">				return false;</span>
			} else {
<span class="nc bnc" id="L1593" title="All 2 branches missed.">				if (gui.confirm(oldTile,</span>
<span class="nc" id="L1594">						StringTemplate.template(&quot;highseas.text&quot;).addAmount(&quot;%number%&quot;, unit.getSailTurns()), unit,</span>
						&quot;highseas.yes&quot;, &quot;highseas.no&quot;)) {
<span class="nc" id="L1596">					moveTo(unit, unit.getOwner().getEurope());</span>
<span class="nc" id="L1597">					return false;</span>
				}
			}
		}
<span class="nc" id="L1601">		return moveMove(unit, direction);</span>
	}

	/**
	 * Move a free colonist to a native settlement to learn a skill following a
	 * move of MoveType.ENTER_INDIAN_SETTLEMENT_WITH_FREE_COLONIST. The colonist
	 * does not physically get into the village, it will just stay where it is
	 * and gain the skill.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to learn the skill.
	 * @param direction
	 *            The direction in which the Indian settlement lies.
	 * @return True if the unit can move further.
	 */
	private boolean moveLearnSkill(Unit unit, Direction direction) {
<span class="nc" id="L1617">		askClearGotoOrders(unit);</span>
		// Refresh knowledge of settlement skill. It may have been
		// learned by another player.
<span class="nc bnc" id="L1620" title="All 2 branches missed.">		if (!askServer().askSkill(unit, direction))</span>
<span class="nc" id="L1621">			return false;</span>

<span class="nc" id="L1623">		IndianSettlement settlement = (IndianSettlement) getSettlementAt(unit.getTile(), direction);</span>
<span class="nc" id="L1624">		UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc bnc" id="L1625" title="All 2 branches missed.">		if (skill == null) {</span>
<span class="nc" id="L1626">			gui.showInformationMessage(settlement, &quot;info.noMoreSkill&quot;);</span>
<span class="nc bnc" id="L1627" title="All 2 branches missed.">		} else if (!unit.getType().canBeUpgraded(skill, ChangeType.NATIVES)) {</span>
<span class="nc" id="L1628">			gui.showInformationMessage(settlement,</span>
<span class="nc" id="L1629">					StringTemplate.template(&quot;info.cantLearnSkill&quot;)</span>
<span class="nc" id="L1630">							.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1631">							.addNamed(&quot;%skill%&quot;, skill));</span>
<span class="nc bnc" id="L1632" title="All 2 branches missed.">		} else if (gui.confirm(unit.getTile(), StringTemplate.template(&quot;learnSkill.text&quot;).addNamed(&quot;%skill%&quot;, skill),</span>
				unit, &quot;learnSkill.yes&quot;, &quot;learnSkill.no&quot;)) {
<span class="nc bnc" id="L1634" title="All 2 branches missed.">			if (askServer().learnSkill(unit, direction)) {</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">				if (unit.isDisposed()) {</span>
<span class="nc" id="L1636">					gui.showInformationMessage(settlement, &quot;learnSkill.die&quot;);</span>
<span class="nc" id="L1637">					return false;</span>
				}
<span class="nc bnc" id="L1639" title="All 2 branches missed.">				if (unit.getType() != skill) {</span>
<span class="nc" id="L1640">					gui.showInformationMessage(settlement, &quot;learnSkill.leave&quot;);</span>
				}
			}
		}
<span class="nc" id="L1644">		return false;</span>
	}

	/**
	 * Actually move a unit in a specified direction, following a move of
	 * MoveType.MOVE.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to be moved.
	 * @param direction
	 *            The direction in which to move the Unit.
	 * @return True if the unit can move further.
	 */
	private boolean moveMove(Unit unit, Direction direction) {
<span class="nc" id="L1658">		final ClientOptions options = freeColClient.getClientOptions();</span>
<span class="nc bnc" id="L1659" title="All 6 branches missed.">		if (unit.canCarryUnits() &amp;&amp; unit.hasSpaceLeft() &amp;&amp; options.getBoolean(ClientOptions.AUTOLOAD_SENTRIES)) {</span>
			// Autoload sentries if selected
<span class="nc bnc" id="L1661" title="All 2 branches missed.">			List&lt;Unit&gt; waiting = (unit.getColony() != null) ? unit.getTile().getUnitList()</span>
<span class="nc" id="L1662">					: Collections.&lt;Unit&gt;emptyList();</span>
<span class="nc bnc" id="L1663" title="All 2 branches missed.">			for (Unit u : waiting) {</span>
<span class="nc bnc" id="L1664" title="All 4 branches missed.">				if (u.getState() != UnitState.SENTRY || !unit.couldCarry(u))</span>
<span class="nc" id="L1665">					continue;</span>
				try {
<span class="nc" id="L1667">					askEmbark(u, unit);</span>
				} finally {
<span class="nc bnc" id="L1669" title="All 4 branches missed.">					if (u.getLocation() != unit) {</span>
<span class="nc" id="L1670">						u.setState(UnitState.SKIPPED);</span>
					}
					continue;
				}
			}
			// Boarding consumed this unit's moves.
<span class="nc bnc" id="L1676" title="All 2 branches missed.">			if (unit.getMovesLeft() &lt;= 0)</span>
<span class="nc" id="L1677">				return false;</span>
		}

		// Ask the server
<span class="nc bnc" id="L1681" title="All 2 branches missed.">		if (!askServer().move(unit, direction)) {</span>
			// Can fail due to desynchronization. Skip this unit so
			// we do not end up retrying indefinitely.
<span class="nc" id="L1684">			unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L1685">			return false;</span>
		}

<span class="nc" id="L1688">		unit.getOwner().invalidateCanSeeTiles();</span>

<span class="nc" id="L1690">		final Tile tile = unit.getTile();</span>

		// Perform a short pause on an active unit's last move if
		// the option is enabled.
<span class="nc bnc" id="L1694" title="All 4 branches missed.">		if (unit.getMovesLeft() &lt;= 0 &amp;&amp; options.getBoolean(ClientOptions.UNIT_LAST_MOVE_DELAY)) {</span>
<span class="nc" id="L1695">			gui.paintImmediatelyCanvasInItsBounds();</span>
			try {
<span class="nc" id="L1697">				Thread.sleep(UNIT_LAST_MOVE_DELAY);</span>
<span class="nc" id="L1698">			} catch (InterruptedException e) {</span>
<span class="nc" id="L1699">			} // Ignore</span>
		}

		// Update the active unit and GUI.
<span class="nc bnc" id="L1703" title="All 4 branches missed.">		boolean ret = !unit.isDisposed() &amp;&amp; !checkCashInTreasureTrain(unit);</span>
<span class="nc bnc" id="L1704" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L1705" title="All 4 branches missed.">			if (tile.getColony() != null &amp;&amp; unit.isCarrier()) {</span>
<span class="nc" id="L1706">				final Colony colony = tile.getColony();</span>
<span class="nc bnc" id="L1707" title="All 4 branches missed.">				if (unit.getTradeRoute() == null &amp;&amp; Map.isSameLocation(tile, unit.getDestination())) {</span>
<span class="nc" id="L1708">					colonyPanel(colony, unit);</span>
				}
			}
<span class="nc bnc" id="L1711" title="All 2 branches missed.">			ret = unit.getMovesLeft() &gt; 0;</span>
		}
<span class="nc" id="L1713">		return ret;</span>
	}

	/**
	 * Move to a foreign colony and either attack, negotiate with the foreign
	 * power or spy on them. Follows a move of
	 * MoveType.ENTER_FOREIGN_COLONY_WITH_SCOUT.
	 *
	 * FIXME: Unify trade and negotiation.
	 *
	 * @param unit
	 *            The unit that will spy, negotiate or attack.
	 * @param direction
	 *            The direction in which the foreign colony lies.
	 * @return True if the unit can move further.
	 */
	private boolean moveScoutColony(Unit unit, Direction direction) {
<span class="nc" id="L1730">		final Game game = freeColClient.getGame();</span>
<span class="nc" id="L1731">		Colony colony = (Colony) getSettlementAt(unit.getTile(), direction);</span>
<span class="nc bnc" id="L1732" title="All 2 branches missed.">		boolean canNeg = colony.getOwner() != unit.getOwner().getREFPlayer();</span>
<span class="nc" id="L1733">		askClearGotoOrders(unit);</span>

<span class="nc" id="L1735">		ScoutColonyAction act = gui.getScoutForeignColonyChoice(colony, unit, canNeg);</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">		if (act == null)</span>
<span class="nc" id="L1737">			return true; // Cancelled</span>
<span class="nc bnc" id="L1738" title="All 4 branches missed.">		switch (act) {</span>
		case FOREIGN_COLONY_ATTACK:
<span class="nc" id="L1740">			return moveAttackSettlement(unit, direction);</span>
		case FOREIGN_COLONY_NEGOTIATE:
<span class="nc" id="L1742">			Player player = unit.getOwner();</span>
<span class="nc" id="L1743">			DiplomaticTrade agreement = new DiplomaticTrade(game, TradeContext.DIPLOMATIC, player, colony.getOwner(),</span>
					null, 0);
<span class="nc" id="L1745">			agreement = gui.showNegotiationDialog(unit, colony, agreement, agreement.getSendMessage(player, colony));</span>
<span class="nc bnc" id="L1746" title="All 4 branches missed.">			return (agreement == null || agreement.getStatus() == TradeStatus.REJECT_TRADE) ? true</span>
<span class="nc" id="L1747">					: moveDiplomacy(unit, direction, agreement);</span>
		case FOREIGN_COLONY_SPY:
<span class="nc" id="L1749">			return moveSpy(unit, direction);</span>
		default:
<span class="nc" id="L1751">			logger.warning(&quot;showScoutForeignColonyDialog fail: &quot; + act);</span>
			break;
		}
<span class="nc" id="L1754">		return true;</span>
	}

	/**
	 * Move a scout into an Indian settlement to speak with the chief, or demand
	 * a tribute following a move of
	 * MoveType.ENTER_INDIAN_SETTLEMENT_WITH_SCOUT. The scout does not
	 * physically get into the village, it will just stay where it is.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is scouting.
	 * @param direction
	 *            The direction in which the Indian settlement lies.
	 * @return True if the unit can move further.
	 */
	private boolean moveScoutIndianSettlement(Unit unit, Direction direction) {
<span class="nc" id="L1770">		Tile unitTile = unit.getTile();</span>
<span class="nc" id="L1771">		Tile tile = unitTile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L1772">		IndianSettlement settlement = tile.getIndianSettlement();</span>
<span class="nc" id="L1773">		Player player = unit.getOwner();</span>
<span class="nc" id="L1774">		askClearGotoOrders(unit);</span>

		// Offer the choices.
<span class="nc" id="L1777">		String number = askServer().scoutSettlement(unit, direction);</span>
<span class="nc bnc" id="L1778" title="All 2 branches missed.">		if (number == null)</span>
<span class="nc" id="L1779">			number = Messages.message(&quot;many&quot;);</span>
<span class="nc" id="L1780">		ScoutIndianSettlementAction act = gui.getScoutIndianSettlementChoice(settlement, number);</span>
<span class="nc bnc" id="L1781" title="All 2 branches missed.">		if (act == null)</span>
<span class="nc" id="L1782">			return true; // Cancelled</span>
<span class="nc bnc" id="L1783" title="All 4 branches missed.">		switch (act) {</span>
		case INDIAN_SETTLEMENT_ATTACK:
<span class="nc bnc" id="L1785" title="All 2 branches missed.">			if (!gui.confirmPreCombat(unit, tile))</span>
<span class="nc" id="L1786">				return true;</span>
<span class="nc" id="L1787">			askServer().attack(unit, direction);</span>
<span class="nc" id="L1788">			return false;</span>
		case INDIAN_SETTLEMENT_SPEAK:
<span class="nc" id="L1790">			final int oldGold = player.getGold();</span>
<span class="nc" id="L1791">			String result = askServer().scoutSpeakToChief(unit, direction);</span>
<span class="nc bnc" id="L1792" title="All 2 branches missed.">			if (result == null) {</span>
<span class="nc" id="L1793">				return false; // Fail</span>
<span class="nc bnc" id="L1794" title="All 2 branches missed.">			} else if (&quot;die&quot;.equals(result)) {</span>
<span class="nc" id="L1795">				gui.showInformationMessage(settlement, &quot;scoutSettlement.speakDie&quot;);</span>
<span class="nc" id="L1796">				return false;</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">			} else if (&quot;expert&quot;.equals(result)) {</span>
<span class="nc" id="L1798">				gui.showInformationMessage(settlement,</span>
<span class="nc" id="L1799">						StringTemplate.template(&quot;scoutSettlement.expertScout&quot;).addNamed(&quot;%unit%&quot;, unit.getType()));</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">			} else if (&quot;tales&quot;.equals(result)) {</span>
<span class="nc" id="L1801">				gui.showInformationMessage(settlement, &quot;scoutSettlement.speakTales&quot;);</span>
<span class="nc bnc" id="L1802" title="All 2 branches missed.">			} else if (&quot;beads&quot;.equals(result)) {</span>
<span class="nc" id="L1803">				gui.showInformationMessage(settlement, StringTemplate.template(&quot;scoutSettlement.speakBeads&quot;)</span>
<span class="nc" id="L1804">						.addAmount(&quot;%amount%&quot;, player.getGold() - oldGold));</span>
<span class="nc bnc" id="L1805" title="All 2 branches missed.">			} else if (&quot;nothing&quot;.equals(result)) {</span>
<span class="nc" id="L1806">				gui.showInformationMessage(settlement, StringTemplate.template(&quot;scoutSettlement.speakNothing&quot;)</span>
<span class="nc" id="L1807">						.addStringTemplate(&quot;%nation%&quot;, player.getNationLabel()));</span>
			} else {
<span class="nc" id="L1809">				logger.warning(&quot;Invalid result from askScoutSpeak: &quot; + result);</span>
			}
<span class="nc" id="L1811">			return false;</span>
		case INDIAN_SETTLEMENT_TRIBUTE:
<span class="nc" id="L1813">			return moveTribute(unit, 1, direction);</span>
		default:
<span class="nc" id="L1815">			logger.warning(&quot;showScoutIndianSettlementDialog fail: &quot; + act);</span>
			break;
		}
<span class="nc" id="L1818">		return true;</span>
	}

	/**
	 * Spy on a foreign colony.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is spying.
	 * @param direction
	 *            The &lt;code&gt;Direction&lt;/code&gt; of a colony to spy on.
	 * @return True if the unit can move further.
	 */
	private boolean moveSpy(Unit unit, Direction direction) {
<span class="nc" id="L1831">		askServer().spy(unit, direction);</span>
<span class="nc" id="L1832">		return false;</span>
	}

	/**
	 * Arrive at a settlement with a laden carrier following a move of
	 * MoveType.ENTER_SETTLEMENT_WITH_CARRIER_AND_GOODS.
	 *
	 * @param unit
	 *            The carrier.
	 * @param direction
	 *            The direction to the settlement.
	 * @return True if the unit can move further.
	 */
	private boolean moveTrade(Unit unit, Direction direction) {
<span class="nc" id="L1846">		askClearGotoOrders(unit);</span>

<span class="nc" id="L1848">		Settlement settlement = getSettlementAt(unit.getTile(), direction);</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">		if (settlement instanceof Colony) {</span>
<span class="nc" id="L1850">			final Game game = freeColClient.getGame();</span>
<span class="nc" id="L1851">			final Player player = unit.getOwner();</span>
<span class="nc" id="L1852">			DiplomaticTrade agreement = new DiplomaticTrade(game, TradeContext.TRADE, player, settlement.getOwner(),</span>
					null, 0);
<span class="nc" id="L1854">			agreement = gui.showNegotiationDialog(unit, settlement, agreement,</span>
<span class="nc" id="L1855">					agreement.getSendMessage(player, settlement));</span>
<span class="nc bnc" id="L1856" title="All 4 branches missed.">			return (agreement == null || agreement.getStatus() == TradeStatus.REJECT_TRADE) ? true</span>
<span class="nc" id="L1857">					: moveDiplomacy(unit, direction, agreement);</span>
<span class="nc bnc" id="L1858" title="All 2 branches missed.">		} else if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1859">			return moveTradeIndianSettlement(unit, direction);</span>
		} else {
<span class="nc" id="L1861">			throw new RuntimeException(&quot;Bogus settlement: &quot; + settlement.getId());</span>
		}
	}

	/**
	 * Trading with the natives, including buying, selling and delivering gifts.
	 * (Deliberate use of Settlement rather than IndianSettlement throughout
	 * these routines as some unification with colony trading is anticipated,
	 * and the native AI already uses the same DeliverGiftMessage to deliver
	 * gifts to Colonies).
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is a carrier containing goods.
	 * @param direction
	 *            The direction the unit could move in order to enter a
	 *            &lt;code&gt;Settlement&lt;/code&gt;.
	 * @return True if the unit can move further.
	 * @see Settlement
	 */
	private boolean moveTradeIndianSettlement(Unit unit, Direction direction) {
<span class="nc" id="L1881">		Settlement settlement = getSettlementAt(unit.getTile(), direction);</span>

<span class="nc" id="L1883">		StringTemplate baseTemplate = StringTemplate.template(&quot;tradeProposition.welcome&quot;)</span>
<span class="nc" id="L1884">				.addStringTemplate(&quot;%nation%&quot;, settlement.getOwner().getNationLabel())</span>
<span class="nc" id="L1885">				.addName(&quot;%settlement%&quot;, settlement.getName());</span>
<span class="nc" id="L1886">		StringTemplate template = baseTemplate;</span>
<span class="nc" id="L1887">		boolean[] results = askServer().openTransactionSession(unit, settlement);</span>
<span class="nc bnc" id="L1888" title="All 2 branches missed.">		while (results != null) {</span>
			// The session tracks buy/sell/gift events and disables
			// them when one happens. So only offer such options if
			// the session allows it and the carrier is in good shape.
<span class="nc bnc" id="L1892" title="All 4 branches missed.">			boolean buy = results[0] &amp;&amp; unit.hasSpaceLeft();</span>
<span class="nc bnc" id="L1893" title="All 4 branches missed.">			boolean sel = results[1] &amp;&amp; unit.hasGoodsCargo();</span>
<span class="nc bnc" id="L1894" title="All 4 branches missed.">			boolean gif = results[2] &amp;&amp; unit.hasGoodsCargo();</span>
<span class="nc bnc" id="L1895" title="All 6 branches missed.">			if (!buy &amp;&amp; !sel &amp;&amp; !gif)</span>
<span class="nc" id="L1896">				break;</span>

<span class="nc" id="L1898">			TradeAction act = gui.getIndianSettlementTradeChoice(settlement, template, buy, sel, gif);</span>
<span class="nc bnc" id="L1899" title="All 2 branches missed.">			if (act == null)</span>
<span class="nc" id="L1900">				break;</span>
<span class="nc" id="L1901">			StringTemplate t = null;</span>
<span class="nc bnc" id="L1902" title="All 4 branches missed.">			switch (act) {</span>
			case BUY:
<span class="nc" id="L1904">				t = attemptBuyFromSettlement(unit, settlement);</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">				if (t == null) {</span>
<span class="nc" id="L1906">					results[0] = false;</span>
<span class="nc" id="L1907">					template = baseTemplate;</span>
				} else {
<span class="nc" id="L1909">					template = t;</span>
				}
<span class="nc" id="L1911">				break;</span>
			case SELL:
<span class="nc" id="L1913">				t = attemptSellToSettlement(unit, settlement);</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">				if (t == null) {</span>
<span class="nc" id="L1915">					results[1] = false;</span>
<span class="nc" id="L1916">					template = baseTemplate;</span>
				} else {
<span class="nc" id="L1918">					template = t;</span>
				}
<span class="nc" id="L1920">				break;</span>
			case GIFT:
<span class="nc" id="L1922">				t = attemptGiftToSettlement(unit, settlement);</span>
<span class="nc bnc" id="L1923" title="All 2 branches missed.">				if (t == null) {</span>
<span class="nc" id="L1924">					results[2] = false;</span>
<span class="nc" id="L1925">					template = baseTemplate;</span>
				} else {
<span class="nc" id="L1927">					template = t;</span>
				}
<span class="nc" id="L1929">				break;</span>
			default:
<span class="nc" id="L1931">				logger.warning(&quot;showIndianSettlementTradeDialog fail: &quot; + act);</span>
<span class="nc" id="L1932">				results = null;</span>
				break;
			}
<span class="nc bnc" id="L1935" title="All 2 branches missed.">			if (template == abortTrade)</span>
<span class="nc" id="L1936">				template = baseTemplate;</span>
<span class="nc" id="L1937">		}</span>

<span class="nc" id="L1939">		askServer().closeTransactionSession(unit, settlement);</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">		if (unit.getMovesLeft() &gt; 0)</span>
<span class="nc" id="L1941">			gui.setActiveUnit(unit); // No trade?</span>
<span class="nc" id="L1942">		return false;</span>
	}

	/**
	 * Displays an appropriate trade failure message.
	 *
	 * @param fail
	 *            The failure state.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that failed to trade.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; that failed to trade.
	 * @return A &lt;code&gt;StringTemplate&lt;/code&gt; describing the failure.
	 */
	private StringTemplate tradeFailMessage(int fail, Settlement settlement, Goods goods) {
<span class="nc bnc" id="L1957" title="All 4 branches missed.">		switch (fail) {</span>
		case NO_TRADE_GOODS:
<span class="nc" id="L1959">			return StringTemplate.template(&quot;trade.noTradeGoods&quot;).addNamed(&quot;%goods%&quot;, goods);</span>
		case NO_TRADE_HAGGLE:
<span class="nc" id="L1961">			return StringTemplate.template(&quot;trade.noTradeHaggle&quot;);</span>
		case NO_TRADE_HOSTILE:
<span class="nc" id="L1963">			return StringTemplate.template(&quot;trade.noTradeHostile&quot;);</span>
		case NO_TRADE: // Proposal was refused
		default:
			break;
		}
<span class="nc" id="L1968">		return StringTemplate.template(&quot;trade.noTrade&quot;).addName(&quot;%settlement%&quot;,</span>
<span class="nc" id="L1969">				settlement.getLocationLabelFor(freeColClient.getMyPlayer()));</span>
	}

	/**
	 * User interaction for buying from the natives.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @return A &lt;code&gt;StringTemplate&lt;/code&gt; containing a message if there is
	 *         problem, or null on success.
	 */
	private StringTemplate attemptBuyFromSettlement(Unit unit, Settlement settlement) {
<span class="nc" id="L1983">		final Game game = freeColClient.getGame();</span>
<span class="nc" id="L1984">		Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L1985">		Goods goods = null;</span>

		// Get list of goods for sale
<span class="nc" id="L1988">		List&lt;Goods&gt; forSale = askServer().getGoodsForSaleInSettlement(game, unit, settlement);</span>
		for (;;) {
<span class="nc bnc" id="L1990" title="All 2 branches missed.">			if (forSale.isEmpty()) { // Nothing to sell to the player</span>
<span class="nc" id="L1991">				return StringTemplate.template(&quot;trade.nothingToSell&quot;);</span>
			}

			// Choose goods to buy
<span class="nc" id="L1995">			List&lt;ChoiceItem&lt;Goods&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1996" title="All 2 branches missed.">			for (Goods g : forSale) {</span>
<span class="nc" id="L1997">				String label = Messages.message(g.getLabel(true));</span>
<span class="nc" id="L1998">				choices.add(new ChoiceItem&lt;&gt;(label, g));</span>
<span class="nc" id="L1999">			}</span>
<span class="nc" id="L2000">			goods = gui.getChoice(unit.getTile(), Messages.message(&quot;buyProposition.text&quot;), settlement, &quot;nothing&quot;,</span>
					choices);
<span class="nc bnc" id="L2002" title="All 2 branches missed.">			if (goods == null)</span>
<span class="nc" id="L2003">				break; // Trade aborted by the player</span>

<span class="nc" id="L2005">			int gold = -1; // Initially ask for a price</span>
			for (;;) {
<span class="nc" id="L2007">				gold = askServer().buyProposition(unit, settlement, goods, gold);</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">				if (gold &lt;= 0) {</span>
<span class="nc" id="L2009">					return tradeFailMessage(gold, settlement, goods);</span>
				}

				// Show dialog for buy proposal
<span class="nc" id="L2013">				boolean canBuy = player.checkGold(gold);</span>
<span class="nc" id="L2014">				BuyAction act = gui.getBuyChoice(unit, settlement, goods, gold, canBuy);</span>
<span class="nc bnc" id="L2015" title="All 2 branches missed.">				if (act == null)</span>
<span class="nc" id="L2016">					break; // User cancelled</span>
<span class="nc bnc" id="L2017" title="All 3 branches missed.">				switch (act) {</span>
				case BUY: // Accept price, make purchase
<span class="nc bnc" id="L2019" title="All 2 branches missed.">					return (askServer().buyFromSettlement(unit, settlement, goods, gold)) ? null : abortTrade;</span>
				case HAGGLE: // Try to negotiate a lower price
<span class="nc" id="L2021">					gold = gold * 9 / 10;</span>
<span class="nc" id="L2022">					break;</span>
				default:
<span class="nc" id="L2024">					logger.warning(&quot;showBuyDialog fail: &quot; + act);</span>
<span class="nc" id="L2025">					return null;</span>
				}
<span class="nc" id="L2027">			}</span>
<span class="nc" id="L2028">		}</span>
<span class="nc" id="L2029">		return abortTrade;</span>
	}

	/**
	 * User interaction for selling to the natives.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @return A &lt;code&gt;StringTemplate&lt;/code&gt; containing a message if there is
	 *         problem, or null on success.
	 */
	private StringTemplate attemptSellToSettlement(Unit unit, Settlement settlement) {
<span class="nc" id="L2043">		Goods goods = null;</span>
		for (;;) {
			// Choose goods to sell
<span class="nc" id="L2046">			List&lt;ChoiceItem&lt;Goods&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2047" title="All 2 branches missed.">			for (Goods g : unit.getGoodsList()) {</span>
<span class="nc" id="L2048">				String label = Messages.message(g.getLabel(true));</span>
<span class="nc" id="L2049">				choices.add(new ChoiceItem&lt;&gt;(label, g));</span>
<span class="nc" id="L2050">			}</span>
<span class="nc" id="L2051">			goods = gui.getChoice(unit.getTile(), Messages.message(&quot;sellProposition.text&quot;), settlement, &quot;nothing&quot;,</span>
					choices);
<span class="nc bnc" id="L2053" title="All 2 branches missed.">			if (goods == null)</span>
<span class="nc" id="L2054">				break; // Trade aborted by the player</span>

<span class="nc" id="L2056">			int gold = -1; // Initially ask for a price</span>
			for (;;) {
<span class="nc" id="L2058">				gold = askServer().sellProposition(unit, settlement, goods, gold);</span>
<span class="nc bnc" id="L2059" title="All 2 branches missed.">				if (gold &lt;= 0) {</span>
<span class="nc" id="L2060">					return tradeFailMessage(gold, settlement, goods);</span>
				}

				// Show dialog for sale proposal
<span class="nc" id="L2064">				SellAction act = gui.getSellChoice(unit, settlement, goods, gold);</span>
<span class="nc bnc" id="L2065" title="All 2 branches missed.">				if (act == null)</span>
<span class="nc" id="L2066">					break; // Cancelled</span>
<span class="nc bnc" id="L2067" title="All 4 branches missed.">				switch (act) {</span>
				case SELL: // Accepted price, make the sale
<span class="nc bnc" id="L2069" title="All 2 branches missed.">					return (askServer().sellToSettlement(unit, settlement, goods, gold)) ? null : abortTrade;</span>
				case HAGGLE: // Ask for more money
<span class="nc" id="L2071">					gold = (gold * 11) / 10;</span>
<span class="nc" id="L2072">					break;</span>
				case GIFT: // Decide to make a gift of the goods
<span class="nc" id="L2074">					askServer().deliverGiftToSettlement(unit, settlement, goods);</span>
<span class="nc" id="L2075">					return abortTrade;</span>
				default:
<span class="nc" id="L2077">					logger.warning(&quot;showSellDialog fail: &quot; + act);</span>
<span class="nc" id="L2078">					return null;</span>
				}
<span class="nc" id="L2080">			}</span>
<span class="nc" id="L2081">		}</span>
<span class="nc" id="L2082">		return abortTrade;</span>
	}

	/**
	 * User interaction for delivering a gift to the natives.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @return A &lt;code&gt;StringTemplate&lt;/code&gt; containing a message if there is
	 *         problem, or null on success.
	 */
	private StringTemplate attemptGiftToSettlement(Unit unit, Settlement settlement) {
<span class="nc" id="L2096">		List&lt;ChoiceItem&lt;Goods&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2097" title="All 2 branches missed.">		for (Goods g : unit.getGoodsList()) {</span>
<span class="nc" id="L2098">			String label = Messages.message(g.getLabel(true));</span>
<span class="nc" id="L2099">			choices.add(new ChoiceItem&lt;&gt;(label, g));</span>
<span class="nc" id="L2100">		}</span>
<span class="nc" id="L2101">		Goods goods = gui.getChoice(unit.getTile(), Messages.message(&quot;gift.text&quot;), settlement, &quot;cancel&quot;, choices);</span>
<span class="nc bnc" id="L2102" title="All 4 branches missed.">		return (goods != null &amp;&amp; askServer().deliverGiftToSettlement(unit, settlement, goods)) ? null : abortTrade;</span>
	}

	/**
	 * Demand a tribute.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to perform the attack.
	 * @param amount
	 *            An amount of tribute to demand.
	 * @param direction
	 *            The direction in which to attack.
	 * @return True if the unit can move further.
	 */
	private boolean moveTribute(Unit unit, int amount, Direction direction) {
<span class="nc" id="L2117">		final Game game = freeColClient.getGame();</span>
<span class="nc" id="L2118">		Player player = unit.getOwner();</span>
<span class="nc" id="L2119">		Tile tile = unit.getTile();</span>
<span class="nc" id="L2120">		Tile target = tile.getNeighbourOrNull(direction);</span>
<span class="nc" id="L2121">		Settlement settlement = target.getSettlement();</span>
<span class="nc" id="L2122">		Player other = settlement.getOwner();</span>

		// Indians are easy and can use the basic tribute mechanism.
<span class="nc bnc" id="L2125" title="All 2 branches missed.">		if (settlement.getOwner().isIndian()) {</span>
<span class="nc" id="L2126">			askServer().demandTribute(unit, direction);</span>
<span class="nc" id="L2127">			return false;</span>
		}

		// Europeans might be human players, so we convert to a diplomacy
		// dialog.
<span class="nc" id="L2132">		DiplomaticTrade agreement = new DiplomaticTrade(game, TradeContext.TRIBUTE, player, other, null, 0);</span>
<span class="nc" id="L2133">		agreement.add(new StanceTradeItem(game, player, other, Stance.PEACE));</span>
<span class="nc" id="L2134">		agreement.add(new GoldTradeItem(game, other, player, amount));</span>
<span class="nc" id="L2135">		return moveDiplomacy(unit, direction, agreement);</span>
	}

	/**
	 * Move a missionary into a native settlement, following a move of
	 * MoveType.ENTER_INDIAN_SETTLEMENT_WITH_MISSIONARY.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that will enter the settlement.
	 * @param direction
	 *            The direction in which the Indian settlement lies.
	 * @return True if the unit can move further.
	 */
	private boolean moveUseMissionary(Unit unit, Direction direction) {
<span class="nc" id="L2149">		IndianSettlement settlement = (IndianSettlement) getSettlementAt(unit.getTile(), direction);</span>
<span class="nc" id="L2150">		Player player = unit.getOwner();</span>
<span class="nc bnc" id="L2151" title="All 2 branches missed.">		boolean canEstablish = !settlement.hasMissionary();</span>
<span class="nc bnc" id="L2152" title="All 4 branches missed.">		boolean canDenounce = !canEstablish &amp;&amp; !settlement.hasMissionary(player);</span>
<span class="nc" id="L2153">		askClearGotoOrders(unit);</span>

		// Offer the choices.
<span class="nc" id="L2156">		MissionaryAction act = gui.getMissionaryChoice(unit, settlement, canEstablish, canDenounce);</span>
<span class="nc bnc" id="L2157" title="All 2 branches missed.">		if (act == null)</span>
<span class="nc" id="L2158">			return true;</span>
<span class="nc bnc" id="L2159" title="All 3 branches missed.">		switch (act) {</span>
		case ESTABLISH_MISSION:
		case DENOUNCE_HERESY:
<span class="nc bnc" id="L2162" title="All 4 branches missed.">			if (askServer().missionary(unit, direction, act == MissionaryAction.DENOUNCE_HERESY)</span>
<span class="nc bnc" id="L2163" title="All 2 branches missed.">					&amp;&amp; settlement.hasMissionary(player)) {</span>
<span class="nc" id="L2164">				sound(&quot;sound.event.missionEstablished&quot;);</span>
<span class="nc" id="L2165">				player.invalidateCanSeeTiles();</span>
			}
			break;
		case INCITE_INDIANS:
<span class="nc" id="L2169">			List&lt;ChoiceItem&lt;Player&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2170" title="All 2 branches missed.">			for (Player p : freeColClient.getGame().getLiveEuropeanPlayers(player)) {</span>
<span class="nc" id="L2171">				String label = Messages.message(p.getCountryLabel());</span>
<span class="nc" id="L2172">				choices.add(new ChoiceItem&lt;&gt;(label, p));</span>
<span class="nc" id="L2173">			}</span>
<span class="nc" id="L2174">			Player enemy = gui.getChoice(unit.getTile(), Messages.message(&quot;missionarySettlement.inciteQuestion&quot;), unit,</span>
					&quot;missionarySettlement.cancel&quot;, choices);
<span class="nc bnc" id="L2176" title="All 2 branches missed.">			if (enemy == null)</span>
<span class="nc" id="L2177">				return true;</span>
<span class="nc" id="L2178">			int gold = askServer().incite(unit, direction, enemy, -1);</span>
<span class="nc bnc" id="L2179" title="All 2 branches missed.">			if (gold &lt; 0) {</span>
				// protocol fail
<span class="nc bnc" id="L2181" title="All 2 branches missed.">			} else if (!player.checkGold(gold)) {</span>
<span class="nc" id="L2182">				gui.showInformationMessage(settlement, StringTemplate.template(&quot;missionarySettlement.inciteGoldFail&quot;)</span>
<span class="nc" id="L2183">						.add(&quot;%player%&quot;, enemy.getName()).addAmount(&quot;%amount%&quot;, gold));</span>
<span class="nc bnc" id="L2184" title="All 2 branches missed.">			} else if (gui.confirm(unit.getTile(), StringTemplate.template(&quot;missionarySettlement.inciteConfirm&quot;)</span>
<span class="nc" id="L2185">					.add(&quot;%player%&quot;, enemy.getName()).addAmount(&quot;%amount%&quot;, gold), unit, &quot;yes&quot;, &quot;no&quot;)) {</span>
<span class="nc" id="L2186">				askServer().incite(unit, direction, enemy, gold);</span>
			}
			break;
		default:
<span class="nc" id="L2190">			logger.warning(&quot;showUseMissionaryDialog fail&quot;);</span>
			break;
		}
<span class="nc" id="L2193">		return false;</span>
	}

	// Trade route support.

	/**
	 * Follows a trade route, doing load/unload actions, moving the unit, and
	 * updating the stop and destination.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; on the route.
	 * @param messages
	 *            An optional list in which to retain any
	 *            &lt;code&gt;ModelMessage&lt;/code&gt;s generated.
	 * @return True if the unit should keep moving, which can only happen if the
	 *         trade route is found to be broken and the unit is thrown off it.
	 */
	private boolean followTradeRoute(Unit unit, List&lt;ModelMessage&gt; messages) {
<span class="nc" id="L2211">		final Player player = unit.getOwner();</span>
<span class="nc" id="L2212">		final TradeRoute tr = unit.getTradeRoute();</span>
<span class="nc" id="L2213">		final boolean detailed = freeColClient.getClientOptions().getBoolean(ClientOptions.SHOW_GOODS_MOVEMENT);</span>
<span class="nc" id="L2214">		final boolean checkProduction = freeColClient.getClientOptions()</span>
<span class="nc" id="L2215">				.getBoolean(ClientOptions.STOCK_ACCOUNTS_FOR_PRODUCTION);</span>
<span class="nc" id="L2216">		final List&lt;TradeRouteStop&gt; stops = unit.getCurrentStops();</span>
<span class="nc" id="L2217">		boolean result = false;</span>

		// If required, accumulate a summary of all the activity of
		// this unit on its trade route.
<span class="nc bnc" id="L2221" title="All 4 branches missed.">		LogBuilder lb = new LogBuilder((detailed &amp;&amp; !tr.isSilent()) ? 256 : -1);</span>
<span class="nc" id="L2222">		lb.mark();</span>

		// Validate the whole route.
<span class="nc" id="L2225">		boolean valid = true;</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">		for (TradeRouteStop trs : stops) {</span>
<span class="nc bnc" id="L2227" title="All 2 branches missed.">			if (!TradeRoute.isStopValid(unit, trs)) {</span>
<span class="nc" id="L2228">				lb.add(&quot; &quot;, Messages.message(trs.invalidStopLabel(player)));</span>
<span class="nc" id="L2229">				valid = false;</span>
			}
<span class="nc" id="L2231">		}</span>
<span class="nc bnc" id="L2232" title="All 2 branches missed.">		if (!valid) {</span>
<span class="nc" id="L2233">			clearOrders(unit);</span>
<span class="nc" id="L2234">			stops.clear();</span>
<span class="nc bnc" id="L2235" title="All 2 branches missed.">			result = unit.getMovesLeft() &gt; 0;</span>
		}

		// Try to find work to do on the current list of stops.
<span class="nc bnc" id="L2239" title="All 2 branches missed.">		while (!stops.isEmpty()) {</span>
<span class="nc" id="L2240">			TradeRouteStop stop = stops.remove(0);</span>

<span class="nc bnc" id="L2242" title="All 2 branches missed.">			if (!unit.atStop(stop)) {</span>
				// Not at stop, give up if no moves left or the path was
				// exhausted on a previous round.
<span class="nc bnc" id="L2245" title="All 4 branches missed.">				if (unit.getMovesLeft() &lt;= 0 || unit.getState() == UnitState.SKIPPED) {</span>
<span class="nc" id="L2246">					lb.add(&quot; &quot;, Messages.message(stop.getLabelFor(&quot;tradeRoute.toStop&quot;, player)));</span>
<span class="nc" id="L2247">					break;</span>
				}

				// Find a path to the stop, skip if none.
<span class="nc" id="L2251">				Location destination = stop.getLocation();</span>
<span class="nc" id="L2252">				PathNode path = unit.findPath(destination);</span>
<span class="nc bnc" id="L2253" title="All 2 branches missed.">				if (path == null) {</span>
<span class="nc" id="L2254">					lb.add(&quot; &quot;, Messages.message(stop.getLabelFor(&quot;tradeRoute.pathStop&quot;, player)));</span>
<span class="nc" id="L2255">					unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2256">					break;</span>
				}

				// Try to follow the path. If the unit does not reach
				// the stop it is finished for now.
<span class="nc" id="L2261">				movePath(unit, path);</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">				if (!unit.atStop(stop)) {</span>
<span class="nc" id="L2263">					unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2264">					break;</span>
				}
			}

			// At the stop, do the work available.
<span class="nc" id="L2269">			lb.mark();</span>
<span class="nc" id="L2270">			unloadUnitAtStop(unit, lb); // Anything to unload?</span>
<span class="nc" id="L2271">			loadUnitAtStop(unit, lb); // Anything to load?</span>
<span class="nc" id="L2272">			lb.grew(&quot; &quot;, Messages.message(stop.getLabelFor(&quot;tradeRoute.atStop&quot;, player)));</span>

			// If the un/load consumed the moves, break now before
			// updating the stop. This allows next turn to retry
			// un/loading, but this time it will not consume the moves.
<span class="nc bnc" id="L2277" title="All 2 branches missed.">			if (unit.getMovesLeft() &lt;= 0)</span>
<span class="nc" id="L2278">				break;</span>

			// Find the next stop with work to do.
<span class="nc" id="L2281">			TradeRouteStop next = null;</span>
<span class="nc" id="L2282">			List&lt;TradeRouteStop&gt; moreStops = unit.getCurrentStops();</span>
<span class="nc bnc" id="L2283" title="All 2 branches missed.">			if (unit.atStop(moreStops.get(0)))</span>
<span class="nc" id="L2284">				moreStops.remove(0);</span>
<span class="nc bnc" id="L2285" title="All 2 branches missed.">			for (TradeRouteStop trs : moreStops) {</span>
<span class="nc bnc" id="L2286" title="All 4 branches missed.">				if (trs.hasWork(unit, (!checkProduction) ? 0 : unit.getTurnsToReach(trs.getLocation()))) {</span>
<span class="nc" id="L2287">					next = trs;</span>
<span class="nc" id="L2288">					break;</span>
				}
<span class="nc" id="L2290">			}</span>
<span class="nc bnc" id="L2291" title="All 2 branches missed.">			if (next == null) {</span>
				// No work was found anywhere on the trade route,
				// so we should skip this unit.
<span class="nc" id="L2294">				lb.add(&quot; &quot;, Messages.message(&quot;tradeRoute.wait&quot;));</span>
<span class="nc" id="L2295">				unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2296">				break;</span>
			}
			// Add a message for any skipped stops.
<span class="nc" id="L2299">			List&lt;TradeRouteStop&gt; skipped = tr.getStopSublist(stops.get(0), next);</span>
<span class="nc bnc" id="L2300" title="All 2 branches missed.">			if (!skipped.isEmpty()) {</span>
<span class="nc" id="L2301">				StringTemplate t = StringTemplate.label(&quot;&quot;).add(&quot;tradeRoute.skipped&quot;);</span>
<span class="nc" id="L2302">				String sep = &quot; &quot;;</span>
<span class="nc bnc" id="L2303" title="All 2 branches missed.">				for (TradeRouteStop trs : skipped) {</span>
<span class="nc" id="L2304">					t.addName(sep).addStringTemplate(trs.getLocation().getLocationLabelFor(player));</span>
<span class="nc" id="L2305">					sep = &quot;, &quot;;</span>
<span class="nc" id="L2306">				}</span>
<span class="nc" id="L2307">				t.addName(&quot;.&quot;);</span>
<span class="nc" id="L2308">				lb.add(&quot; &quot;, Messages.message(t));</span>
			}
			// Bring the next stop to the head of the stops list if it
			// is present.
<span class="nc bnc" id="L2312" title="All 4 branches missed.">			while (!stops.isEmpty() &amp;&amp; stops.get(0) != next) {</span>
<span class="nc" id="L2313">				stops.remove(0);</span>
			}
			// Set the new stop, skip on error.
<span class="nc bnc" id="L2316" title="All 2 branches missed.">			if (!askServer().setCurrentStop(unit, tr.getIndex(next))) {</span>
<span class="nc" id="L2317">				unit.setState(UnitState.SKIPPED);</span>
<span class="nc" id="L2318">				break;</span>
			}
<span class="nc" id="L2320">		}</span>

<span class="nc bnc" id="L2322" title="All 2 branches missed.">		if (lb.grew()) {</span>
<span class="nc" id="L2323">			ModelMessage m = new ModelMessage(MessageType.GOODS_MOVEMENT, &quot;tradeRoute.prefix&quot;, unit)</span>
<span class="nc" id="L2324">					.addName(&quot;%route%&quot;, tr.getName())</span>
<span class="nc" id="L2325">					.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L2326">					.addName(&quot;%data%&quot;, lb.toString());</span>
<span class="nc bnc" id="L2327" title="All 2 branches missed.">			if (messages != null) {</span>
<span class="nc" id="L2328">				messages.add(m);</span>
			} else {
<span class="nc" id="L2330">				player.addModelMessage(m);</span>
<span class="nc" id="L2331">				turnReportMessages.add(m);</span>
			}
		}
<span class="nc" id="L2334">		return result;</span>
	}

	/**
	 * Work out what goods to load onto a unit at a stop, and load them.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to load.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to update.
	 * @return True if goods were loaded.
	 */
	private boolean loadUnitAtStop(Unit unit, LogBuilder lb) {
<span class="nc" id="L2347">		final TradeLocation trl = unit.getTradeLocation();</span>
<span class="nc bnc" id="L2348" title="All 2 branches missed.">		if (trl == null)</span>
<span class="nc" id="L2349">			return false;</span>

<span class="nc" id="L2351">		final TradeRouteStop stop = unit.getStop();</span>
<span class="nc" id="L2352">		boolean ret = false;</span>

		// Get the collapsed list of goods to load at this stop.
<span class="nc" id="L2355">		List&lt;AbstractGoods&gt; toLoad = stop.getCompactCargo();</span>
		// If already at capacity for a goods type, drop it from the
		// toLoad list, otherwise reduce its amount by the amount
		// already loaded. Handle excess goods.
<span class="nc bnc" id="L2359" title="All 2 branches missed.">		for (Goods g : unit.getCompactGoods()) {</span>
<span class="nc" id="L2360">			AbstractGoods ag = AbstractGoods.findByType(g.getType(), toLoad);</span>
<span class="nc bnc" id="L2361" title="All 2 branches missed.">			if (ag != null) {</span>
<span class="nc" id="L2362">				int goodsAmount = g.getAmount();</span>
<span class="nc" id="L2363">				int amount = ag.getAmount() - goodsAmount;</span>
<span class="nc bnc" id="L2364" title="All 2 branches missed.">				if (amount &lt;= 0) { // At capacity</span>
<span class="nc" id="L2365">					toLoad.remove(ag);</span>
				} else { // Modify amount
<span class="nc" id="L2367">					ag.setAmount(amount);</span>
				}
<span class="nc" id="L2369">			} else {</span>
				// Excess goods on board. They must have failed to
				// unload somewhere.
<span class="nc" id="L2372">				lb.add(&quot; &quot;, Messages.message(StringTemplate.template(&quot;tradeRoute.loadStopBlocked&quot;)</span>
<span class="nc" id="L2373">						.addStringTemplate(&quot;%goods%&quot;, g.getLabel())));</span>
			}
<span class="nc" id="L2375">		}</span>

		// Adjust toLoad with the actual export amount. Some goods
		// may not have an export surplus. Add messages for them and
		// drop from the toLoad list.
<span class="nc" id="L2380">		Iterator&lt;AbstractGoods&gt; iterator = toLoad.iterator();</span>
<span class="nc bnc" id="L2381" title="All 2 branches missed.">		while (iterator.hasNext()) {</span>
<span class="nc" id="L2382">			AbstractGoods ag = iterator.next();</span>
<span class="nc" id="L2383">			int amount = stop.getExportAmount(ag.getType(), 0);</span>
<span class="nc bnc" id="L2384" title="All 2 branches missed.">			if (amount &lt;= 0) {</span>
<span class="nc bnc" id="L2385" title="All 2 branches missed.">				if (stop.getCargo().contains(ag.getType())) {</span>
					// Complain only if this goods type was planned to load
<span class="nc" id="L2387">					int present = stop.getGoodsCount(ag.getType());</span>
<span class="nc" id="L2388">					lb.add(&quot; &quot;, getLoadGoodsMessage(ag.getType(), 0, present, 0, -1));</span>
				}
<span class="nc" id="L2390">				iterator.remove();</span>
			} else {
<span class="nc" id="L2392">				ag.setAmount(Math.min(amount, ag.getAmount()));</span>
			}
<span class="nc" id="L2394">		}</span>
		// Load the goods.
<span class="nc bnc" id="L2396" title="All 2 branches missed.">		for (AbstractGoods ag : toLoad) {</span>
<span class="nc" id="L2397">			GoodsType type = ag.getType();</span>
<span class="nc" id="L2398">			int demand = ag.getAmount();</span>
<span class="nc" id="L2399">			ret = askLoadGoods(stop.getLocation(), type, demand, unit);</span>
<span class="nc bnc" id="L2400" title="All 2 branches missed.">			if (!ret) {</span>
				// Assume any failure is due to goods still on board,
				// and thus no further loading is likely to succeed.
<span class="nc" id="L2403">				break;</span>
			}
<span class="nc" id="L2405">			int present = stop.getGoodsCount(type);</span>
<span class="nc" id="L2406">			int export = stop.getExportAmount(type, 0);</span>
<span class="nc" id="L2407">			lb.add(&quot; &quot;, getLoadGoodsMessage(type, demand, present, export, demand));</span>
<span class="nc" id="L2408">		}</span>
<span class="nc" id="L2409">		return ret;</span>
	}

	/**
	 * Gets a message describing a goods loading.
	 *
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; the type of goods being loaded.
	 * @param amount
	 *            The amount of goods actually loaded.
	 * @param present
	 *            The amount of goods already at the location.
	 * @param export
	 *            The amount of goods available to export.
	 * @param toLoad
	 *            The amount of goods the unit should load according to the
	 *            trade route orders.
	 * @return A summary of the load.
	 */
	private String getLoadGoodsMessage(GoodsType type, int amount, int present, int export, int toLoad) {
		String key;
		int more;

<span class="nc bnc" id="L2432" title="All 2 branches missed.">		if (amount == 0) {</span>
<span class="nc bnc" id="L2433" title="All 2 branches missed.">			key = (present == 0)</span>
					// Loaded no %goods% from an empty warehouse.
					? &quot;tradeRoute.loadStopNone&quot;
					// Loaded no %goods% with %more% more retained...
					: &quot;tradeRoute.loadStopNoExport&quot;;
<span class="nc" id="L2438">			more = present;</span>
<span class="nc bnc" id="L2439" title="All 2 branches missed.">		} else if (toLoad &lt; export) {</span>
<span class="nc" id="L2440">			key = &quot;tradeRoute.loadStopImport&quot;;</span>
			// Loaded %amount% %goods% lacking space for %more% more
<span class="nc" id="L2442">			more = export - toLoad;</span>
<span class="nc bnc" id="L2443" title="All 4 branches missed.">		} else if (present &gt; export &amp;&amp; toLoad &gt; export) {</span>
			// Loaded %amount% %goods% with %more% more retained...
<span class="nc" id="L2445">			key = &quot;tradeRoute.loadStopExport&quot;;</span>
<span class="nc" id="L2446">			more = present - export;</span>
		} else {
			// Loaded %amount% %goods%
<span class="nc" id="L2449">			key = &quot;tradeRoute.loadStop&quot;;</span>
<span class="nc" id="L2450">			more = -1; // not displayed</span>
		}
<span class="nc" id="L2452">		return Messages.message(StringTemplate.template(key).addAmount(&quot;%amount%&quot;, amount).addNamed(&quot;%goods%&quot;, type)</span>
<span class="nc" id="L2453">				.addAmount(&quot;%more%&quot;, more));</span>
	}

	/**
	 * Work out what goods to unload from a unit at a stop, and unload them.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to unload.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to update.
	 * @return True if something was unloaded.
	 */
	private boolean unloadUnitAtStop(Unit unit, LogBuilder lb) {
<span class="nc" id="L2466">		final TradeLocation trl = unit.getTradeLocation();</span>
<span class="nc bnc" id="L2467" title="All 2 branches missed.">		if (trl == null)</span>
<span class="nc" id="L2468">			return false;</span>

<span class="nc" id="L2470">		final TradeRouteStop stop = unit.getStop();</span>
<span class="nc" id="L2471">		final List&lt;GoodsType&gt; goodsTypesToLoad = stop.getCargo();</span>
<span class="nc" id="L2472">		boolean ret = false;</span>

		// Unload everything that is on the carrier but not listed to
		// be loaded at this stop.
<span class="nc" id="L2476">		Game game = freeColClient.getGame();</span>
<span class="nc bnc" id="L2477" title="All 2 branches missed.">		for (Goods goods : unit.getCompactGoodsList()) {</span>
<span class="nc" id="L2478">			GoodsType type = goods.getType();</span>
<span class="nc bnc" id="L2479" title="All 2 branches missed.">			if (goodsTypesToLoad.contains(type))</span>
<span class="nc" id="L2480">				continue; // Keep this cargo.</span>

<span class="nc" id="L2482">			int present = goods.getAmount();</span>
<span class="nc" id="L2483">			int toUnload = present;</span>
<span class="nc" id="L2484">			int atStop = trl.getImportAmount(type, 0);</span>
<span class="nc" id="L2485">			int amount = toUnload;</span>
<span class="nc bnc" id="L2486" title="All 2 branches missed.">			if (amount &gt; atStop) {</span>
<span class="nc" id="L2487">				StringTemplate locName = ((Location) trl).getLocationLabel();</span>
<span class="nc" id="L2488">				int option = freeColClient.getClientOptions().getInteger(ClientOptions.UNLOAD_OVERFLOW_RESPONSE);</span>
<span class="nc bnc" id="L2489" title="All 4 branches missed.">				switch (option) {</span>
				case ClientOptions.UNLOAD_OVERFLOW_RESPONSE_ASK:
<span class="nc" id="L2491">					StringTemplate template = StringTemplate.template(&quot;traderoute.warehouseCapacity&quot;)</span>
<span class="nc" id="L2492">							.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L2493">							.addStringTemplate(&quot;%colony%&quot;, locName).addAmount(&quot;%amount%&quot;, toUnload - atStop)</span>
<span class="nc" id="L2494">							.addNamed(&quot;%goods%&quot;, goods);</span>
<span class="nc bnc" id="L2495" title="All 2 branches missed.">					if (!gui.confirm(unit.getTile(), template, unit, &quot;yes&quot;, &quot;no&quot;))</span>
<span class="nc" id="L2496">						amount = atStop;</span>
					break;
				case ClientOptions.UNLOAD_OVERFLOW_RESPONSE_NEVER:
<span class="nc" id="L2499">					amount = atStop;</span>
<span class="nc" id="L2500">					break;</span>
				case ClientOptions.UNLOAD_OVERFLOW_RESPONSE_ALWAYS:
<span class="nc" id="L2502">					break;</span>
				default:
<span class="nc" id="L2504">					logger.warning(&quot;Illegal UNLOAD_OVERFLOW_RESPONSE: &quot; + Integer.toString(option));</span>
					break;
				}
			}

			// Try to unload.
<span class="nc bnc" id="L2510" title="All 2 branches missed.">			ret = (amount == 0) ? false : askUnloadGoods(type, amount, unit);</span>
<span class="nc bnc" id="L2511" title="All 2 branches missed.">			if (ret) {</span>
<span class="nc" id="L2512">				lb.add(&quot; &quot;, getUnloadGoodsMessage(unit, type, amount, present, atStop, toUnload));</span>
			}
<span class="nc" id="L2514">		}</span>

<span class="nc" id="L2516">		return ret;</span>
	}

	/**
	 * Gets a message describing a goods unloading.
	 *
	 * Normally just state that a certain amount of goods was unloaded. Make
	 * special mention if the actual unloaded amount was short (unloaded &amp;lt;
	 * amount), or an overflow is happening (amount &amp;gt; atStop) in which case
	 * distinguish dumping (amount == toUnload) from retaining on board).
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is unloading.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; the type of goods being unloaded.
	 * @param amount
	 *            The amount of goods requested to be unloaded.
	 * @param present
	 *            The amount of goods originally on the unit.
	 * @param atStop
	 *            The amount of goods space available at the stop.
	 * @param toUnload
	 *            The amount of goods that should be unloaded according to the
	 *            trade route orders.
	 * @return A summary of the unload.
	 */
	private String getUnloadGoodsMessage(Unit unit, GoodsType type, int amount, int present, int atStop, int toUnload) {
<span class="nc" id="L2543">		String key = null;</span>
<span class="nc" id="L2544">		int onBoard = unit.getGoodsCount(type);</span>
<span class="nc" id="L2545">		int unloaded = present - onBoard;</span>
<span class="nc" id="L2546">		int more = 0;</span>

<span class="nc bnc" id="L2548" title="All 2 branches missed.">		if (unloaded &lt; amount) {</span>
			// Tried to unload %amount% %goods%, but %more% was unloaded
<span class="nc" id="L2550">			key = &quot;tradeRoute.unloadStopFail&quot;;</span>
<span class="nc" id="L2551">			more = unloaded;</span>
<span class="nc bnc" id="L2552" title="All 2 branches missed.">		} else if (amount &gt; atStop) {</span>
<span class="nc bnc" id="L2553" title="All 2 branches missed.">			if (amount == toUnload) {</span>
				// Unloaded %amount% %goods% and dumped %more%.
<span class="nc" id="L2555">				key = &quot;tradeRoute.unloadStopImport&quot;;</span>
<span class="nc" id="L2556">				more = toUnload - atStop;</span>
			} else {
				// Unloaded %amount% %goods% with %more% more retained...
<span class="nc bnc" id="L2559" title="All 2 branches missed.">				key = (amount == 0) ? &quot;tradeRoute.unloadStopNoExport&quot; : &quot;tradeRoute.unloadStopExport&quot;;</span>
<span class="nc" id="L2560">				more = onBoard;</span>
			}
		} else {
			// Unloaded %amount% %goods%
<span class="nc" id="L2564">			key = &quot;tradeRoute.unloadStop&quot;;</span>
		}

<span class="nc" id="L2567">		return Messages.message(StringTemplate.template(key).addAmount(&quot;%amount%&quot;, amount).addAmount(&quot;%more%&quot;, more)</span>
<span class="nc" id="L2568">				.addNamed(&quot;%goods%&quot;, type));</span>
	}

	// Routines from here on are mostly user commands. That is they
	// are called directly as a result of keyboard, menu, mouse or
	// panel/dialog actions. Some though are called indirectly after
	// a call to the server routes information back through the
	// InGameInputHandler. They should all be annotated as such to
	// confirm where they can come from.
	//
	// User command all return a success/failure indication, except if
	// the game is stopped. IGIH-initiated routines do not need to.
	//
	// Successfully executed commands should update the GUI.

	/**
	 * Abandon a colony with no units.
	 *
	 * Called from ColonyPanel.closeColonyPanel
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to be abandoned.
	 * @return True if the colony was abandoned.
	 */
	public boolean abandonColony(Colony colony) {
<span class="nc" id="L2593">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L2594" title="All 8 branches missed.">		if (!requireOurTurn() || colony == null || !player.owns(colony) || colony.getUnitCount() &gt; 0)</span>
<span class="nc" id="L2595">			return false;</span>

		// Proceed to abandon
<span class="nc" id="L2598">		final Tile tile = colony.getTile();</span>
<span class="nc bnc" id="L2599" title="All 4 branches missed.">		boolean ret = askServer().abandonColony(colony) &amp;&amp; !tile.hasSettlement();</span>
<span class="nc bnc" id="L2600" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2601">			player.invalidateCanSeeTiles();</span>
<span class="nc" id="L2602">			updateGUI(null);</span>
		}
<span class="nc" id="L2604">		return ret;</span>
	}

	/**
	 * Animate an attack.
	 *
	 * Called from IGIH.animateAttack.
	 *
	 * @param attacker
	 *            The attacking &lt;code&gt;Unit&lt;/code&gt;.
	 * @param defender
	 *            The defending &lt;code&gt;Unit&lt;/code&gt;.
	 * @param attackerTile
	 *            The &lt;code&gt;Tile&lt;/code&gt; the attack originates from.
	 * @param defenderTile
	 *            The &lt;code&gt;Tile&lt;/code&gt; the defence takes place on.
	 * @param success
	 *            True if the attack succeeds.
	 */
	public void animateAttack(Unit attacker, Unit defender, Tile attackerTile, Tile defenderTile, boolean success) {
		// Note: we used to focus the map on the unit even when
		// animation is off as long as the center-active-unit option
		// was set. However IR#115 requested that if animation is off
		// that we display nothing so as to speed up the other player
		// moves as much as possible.
<span class="nc bnc" id="L2629" title="All 2 branches missed.">		if (freeColClient.getAnimationSpeed(attacker.getOwner()) &gt; 0) {</span>
<span class="nc" id="L2630">			gui.animateUnitAttack(attacker, defender, attackerTile, defenderTile, success);</span>
		}
<span class="nc" id="L2632">		gui.refresh();</span>
<span class="nc" id="L2633">	}</span>

	/**
	 * Animate a move.
	 *
	 * Called from IGIH.animateMove.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that moves.
	 * @param oldTile
	 *            The &lt;code&gt;Tile&lt;/code&gt; the move begins at.
	 * @param newTile
	 *            The &lt;code&gt;Tile&lt;/code&gt; the move ends at.
	 */
	public void animateMove(Unit unit, Tile oldTile, Tile newTile) {
		// Note: we used to focus the map on the unit even when
		// animation is off as long as the center-active-unit option
		// was set. However IR#115 requested that if animation is off
		// that we display nothing so as to speed up the other player
		// moves as much as possible.
<span class="nc bnc" id="L2653" title="All 2 branches missed.">		if (freeColClient.getAnimationSpeed(unit.getOwner()) &gt; 0) {</span>
<span class="nc" id="L2654">			gui.animateUnitMove(unit, oldTile, newTile);</span>
<span class="nc bnc" id="L2655" title="All 2 branches missed.">		} else if (freeColClient.getMyPlayer().owns(unit)) {</span>
<span class="nc" id="L2656">			gui.requireFocus(newTile);</span>
		}
<span class="nc" id="L2658">		gui.refresh();</span>
<span class="nc" id="L2659">	}</span>

	/**
	 * Assigns a student to a teacher.
	 *
	 * Called from UnitLabel
	 *
	 * @param student
	 *            The student &lt;code&gt;Unit&lt;/code&gt;.
	 * @param teacher
	 *            The teacher &lt;code&gt;Unit&lt;/code&gt;.
	 * @return True if the student was assigned.
	 */
	public boolean assignTeacher(Unit student, Unit teacher) {
<span class="nc" id="L2673">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L2674" title="All 8 branches missed.">		if (!requireOurTurn() || student == null || !player.owns(student) || student.getColony() == null</span>
<span class="nc bnc" id="L2675" title="All 8 branches missed.">				|| !student.isInColony() || teacher == null || !player.owns(teacher) || !student.canBeStudent(teacher)</span>
<span class="nc bnc" id="L2676" title="All 4 branches missed.">				|| teacher.getColony() == null || student.getColony() != teacher.getColony()</span>
<span class="nc bnc" id="L2677" title="All 2 branches missed.">				|| !teacher.getColony().canTrain(teacher))</span>
<span class="nc" id="L2678">			return false;</span>

<span class="nc" id="L2680">		UnitWas unitWas = new UnitWas(student);</span>
<span class="nc bnc" id="L2681" title="All 4 branches missed.">		boolean ret = askServer().assignTeacher(student, teacher) &amp;&amp; student.getTeacher() == teacher;</span>
<span class="nc bnc" id="L2682" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2683">			unitWas.fireChanges();</span>
<span class="nc" id="L2684">			updateGUI(null);</span>
		}
<span class="nc" id="L2686">		return ret;</span>
	}

	/**
	 * Assigns a trade route to a unit.
	 *
	 * Called from EuropePanel.DestinationPanel, TradeRoutePanel(),
	 * TradeRoutePanel.newRoute
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to assign a trade route to.
	 * @param tradeRoute
	 *            The &lt;code&gt;TradeRoute&lt;/code&gt; to assign.
	 * @return True if the route was successfully assigned.
	 */
	public boolean assignTradeRoute(Unit unit, TradeRoute tradeRoute) {
<span class="nc bnc" id="L2702" title="All 2 branches missed.">		if (unit == null)</span>
<span class="nc" id="L2703">			return false;</span>

<span class="nc" id="L2705">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L2706">		boolean ret = askAssignTradeRoute(unit, tradeRoute);</span>
<span class="nc bnc" id="L2707" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2708">			unitWas.fireChanges();</span>
<span class="nc" id="L2709">			updateGUI(null);</span>
		}
<span class="nc" id="L2711">		return ret;</span>
	}

	/**
	 * Boards a specified unit onto a carrier. The carrier must be at the same
	 * location as the boarding unit.
	 *
	 * Called from CargoPanel, TilePopup.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; which is to board the carrier.
	 * @param carrier
	 *            The carrier to board.
	 * @return True if the unit boards the carrier.
	 */
	public boolean boardShip(Unit unit, Unit carrier) {
<span class="nc bnc" id="L2727" title="All 10 branches missed.">		if (!requireOurTurn() || unit == null || unit.isCarrier() || carrier == null || !carrier.canCarryUnits()</span>
<span class="nc bnc" id="L2728" title="All 2 branches missed.">				|| !unit.isAtLocation(carrier.getLocation()))</span>
<span class="nc" id="L2729">			return false;</span>

<span class="nc" id="L2731">		boolean ret = askEmbark(unit, carrier);</span>
<span class="nc bnc" id="L2732" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2733">			updateGUI(null);</span>
		}
<span class="nc" id="L2735">		return ret;</span>
	}

	/**
	 * Use the active unit to build a colony.
	 *
	 * Called from BuildColonyAction.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to build the colony.
	 * @return True if a colony was built.
	 */
	public boolean buildColony(Unit unit) {
<span class="nc bnc" id="L2748" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L2749">			return false;</span>

		// Check unit, which must be on the map and able to build.
<span class="nc bnc" id="L2752" title="All 2 branches missed.">		if (unit == null)</span>
<span class="nc" id="L2753">			return false;</span>
<span class="nc" id="L2754">		final Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L2755" title="All 2 branches missed.">		if (tile == null)</span>
<span class="nc" id="L2756">			return false;</span>
<span class="nc bnc" id="L2757" title="All 2 branches missed.">		if (!unit.canBuildColony()) {</span>
<span class="nc" id="L2758">			gui.showInformationMessage(unit,</span>
<span class="nc" id="L2759">					StringTemplate.template(&quot;buildColony.badUnit&quot;).addName(&quot;%unit%&quot;, unit.getName()));</span>
<span class="nc" id="L2760">			return false;</span>
		}

		// Join existing colony if present
<span class="nc" id="L2764">		final Colony colony = tile.getColony();</span>
<span class="nc bnc" id="L2765" title="All 2 branches missed.">		if (colony != null) {</span>
<span class="nc" id="L2766">			askServer().joinColony(unit, colony);</span>
<span class="nc" id="L2767">			updateGUI(null);</span>
<span class="nc" id="L2768">			colonyPanel(colony, unit);</span>
<span class="nc" id="L2769">			return false;</span>
		}

		// Check for other impediments.
<span class="nc" id="L2773">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L2774">		NoClaimReason reason = player.canClaimToFoundSettlementReason(tile);</span>
<span class="nc bnc" id="L2775" title="All 2 branches missed.">		switch (reason) {</span>
		case NONE:
		case NATIVES: // Tile can still be claimed
<span class="nc" id="L2778">			break;</span>
		default:
<span class="nc" id="L2780">			gui.showInformationMessage(reason.getDescriptionKey());</span>
<span class="nc" id="L2781">			return false;</span>
		}

		// Show the warnings if applicable.
<span class="nc bnc" id="L2785" title="All 2 branches missed.">		if (freeColClient.getClientOptions().getBoolean(ClientOptions.SHOW_COLONY_WARNINGS)) {</span>
<span class="nc" id="L2786">			StringTemplate warnings = tile.getBuildColonyWarnings(unit);</span>
<span class="nc bnc" id="L2787" title="All 2 branches missed.">			if (!warnings.getReplacements().isEmpty()</span>
<span class="nc bnc" id="L2788" title="All 2 branches missed.">					&amp;&amp; !gui.confirm(tile, warnings, unit, &quot;buildColony.yes&quot;, &quot;buildColony.no&quot;)) {</span>
<span class="nc" id="L2789">				return false;</span>
			}
		}

		// Get and check the name.
<span class="nc" id="L2794">		String name = gui.getNewColonyName(player, tile);</span>
<span class="nc bnc" id="L2795" title="All 2 branches missed.">		if (name == null)</span>
<span class="nc" id="L2796">			return false;</span>

		// Claim tile from other owners before founding a settlement.
		// Only native owners that we can steal, buy from, or use a
		// bonus center tile exception should be possible by this point.
<span class="nc" id="L2801">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L2802">		boolean ret = player.owns(tile);</span>
<span class="nc bnc" id="L2803" title="All 2 branches missed.">		if (!ret) {</span>
<span class="nc" id="L2804">			ret = askClaimTile(player, tile, unit, player.getLandPrice(tile));</span>
<span class="nc bnc" id="L2805" title="All 2 branches missed.">			if (!ret)</span>
<span class="nc" id="L2806">				NameCache.putSettlementName(player, name);</span>
		}
<span class="nc bnc" id="L2808" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L2809" title="All 4 branches missed.">			ret = askServer().buildColony(name, unit) &amp;&amp; tile.hasSettlement();</span>
<span class="nc bnc" id="L2810" title="All 2 branches missed.">			if (ret) {</span>
<span class="nc" id="L2811">				sound(&quot;sound.event.buildingComplete&quot;);</span>
<span class="nc" id="L2812">				player.invalidateCanSeeTiles();</span>
<span class="nc" id="L2813">				unitWas.fireChanges();</span>
				// Check units present for treasure cash-in as they are now
				// at a colony.
<span class="nc bnc" id="L2816" title="All 2 branches missed.">				for (Unit u : tile.getUnitList())</span>
<span class="nc" id="L2817">					checkCashInTreasureTrain(u);</span>
<span class="nc" id="L2818">				colonyPanel((Colony) tile.getSettlement(), unit);</span>
			}
<span class="nc" id="L2820">			updateGUI(null);</span>
		}
<span class="nc" id="L2822">		return ret;</span>
	}

	/**
	 * Buy goods in Europe. The amount of goods is adjusted to the space in the
	 * carrier.
	 *
	 * Called from CargoPanel, TilePopup, loadCargo()
	 *
	 * @param type
	 *            The type of goods to buy.
	 * @param amount
	 *            The amount of goods to buy.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; acting as carrier.
	 * @return True if the purchase succeeds.
	 */
	public boolean buyGoods(GoodsType type, int amount, Unit carrier) {
<span class="nc bnc" id="L2840" title="All 10 branches missed.">		if (!requireOurTurn() || type == null || amount &lt;= 0 || carrier == null || !carrier.isInEurope()</span>
<span class="nc bnc" id="L2841" title="All 2 branches missed.">				|| !freeColClient.getMyPlayer().owns(carrier))</span>
<span class="nc" id="L2842">			return false;</span>

<span class="nc" id="L2844">		final Europe europe = carrier.getOwner().getEurope();</span>
<span class="nc" id="L2845">		EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L2846">		UnitWas unitWas = new UnitWas(carrier);</span>
<span class="nc" id="L2847">		boolean ret = askLoadGoods(europe, type, amount, carrier);</span>
<span class="nc bnc" id="L2848" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2849">			sound(&quot;sound.event.loadCargo&quot;);</span>
<span class="nc" id="L2850">			europeWas.fireChanges();</span>
<span class="nc" id="L2851">			unitWas.fireChanges();</span>
<span class="nc" id="L2852">			updateGUI(null);</span>
		}
<span class="nc" id="L2854">		return ret;</span>
	}

	/**
	 * Chat with another player.
	 *
	 * Called from IGIH.chat.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; to chat with.
	 * @param message
	 *            What to say.
	 * @param pri
	 *            If true, the message is private.
	 */
	public void chat(Player player, String message, boolean pri) {
<span class="nc" id="L2870">		gui.displayChatMessage(player, message, pri);</span>
<span class="nc" id="L2871">	}</span>

	/**
	 * Changes the state of this &lt;code&gt;Unit&lt;/code&gt;.
	 *
	 * Called from FortifyAction, SentryAction, TilePopup, UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt;
	 * @param state
	 *            The state of the unit.
	 * @return True if the state was changed.
	 */
	public boolean changeState(Unit unit, UnitState state) {
<span class="nc bnc" id="L2885" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L2886">			return false;</span>
<span class="nc bnc" id="L2887" title="All 2 branches missed.">		if (unit.getState() == state)</span>
<span class="nc" id="L2888">			return true;</span>
<span class="nc bnc" id="L2889" title="All 2 branches missed.">		if (!unit.checkSetState(state))</span>
<span class="nc" id="L2890">			return false;</span>

		// Check if this is a hostile fortification, and give the player
		// a chance to confirm.
<span class="nc" id="L2894">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L2895" title="All 6 branches missed.">		if (state == UnitState.FORTIFYING &amp;&amp; unit.isOffensiveUnit() &amp;&amp; !unit.hasAbility(Ability.PIRACY)) {</span>
<span class="nc" id="L2896">			Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L2897" title="All 4 branches missed.">			if (tile != null &amp;&amp; tile.getOwningSettlement() != null) {</span>
<span class="nc" id="L2898">				Player enemy = tile.getOwningSettlement().getOwner();</span>
<span class="nc bnc" id="L2899" title="All 4 branches missed.">				if (player != enemy &amp;&amp; player.getStance(enemy) != Stance.ALLIANCE</span>
<span class="nc bnc" id="L2900" title="All 2 branches missed.">						&amp;&amp; !gui.confirmHostileAction(unit, tile))</span>
<span class="nc" id="L2901">					return false; // Aborted</span>
			}
		}

<span class="nc" id="L2905">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L2906" title="All 4 branches missed.">		boolean ret = askServer().changeState(unit, state) &amp;&amp; unit.getState() == state;</span>
<span class="nc bnc" id="L2907" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2908">			unitWas.fireChanges();</span>
<span class="nc" id="L2909">			updateGUI(null);</span>
		}
<span class="nc" id="L2911">		return ret;</span>
	}

	/**
	 * Changes the work type of this &lt;code&gt;Unit&lt;/code&gt;.
	 *
	 * Called from ImprovementAction.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt;
	 * @param improvementType
	 *            a &lt;code&gt;TileImprovementType&lt;/code&gt; value
	 * @return True if the improvement was changed.
	 */
	public boolean changeWorkImprovementType(Unit unit, TileImprovementType improvementType) {
<span class="nc bnc" id="L2926" title="All 8 branches missed.">		if (!requireOurTurn() || unit == null || improvementType == null || !unit.hasTile()</span>
<span class="nc bnc" id="L2927" title="All 4 branches missed.">				|| !unit.checkSetState(UnitState.IMPROVING) || improvementType.isNatural())</span>
<span class="nc" id="L2928">			return false;</span>

		// May need to claim the tile first
<span class="nc" id="L2931">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L2932">		final Tile tile = unit.getTile();</span>
<span class="nc" id="L2933">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L2934" title="All 4 branches missed.">		boolean ret = player.owns(tile) || askClaimTile(player, tile, unit, player.getLandPrice(tile));</span>
<span class="nc bnc" id="L2935" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L2936" title="All 4 branches missed.">			ret = askServer().changeWorkImprovementType(unit, improvementType) &amp;&amp; unit.getWorkImprovement() != null</span>
<span class="nc bnc" id="L2937" title="All 2 branches missed.">					&amp;&amp; unit.getWorkImprovement().getType() == improvementType;</span>
<span class="nc bnc" id="L2938" title="All 2 branches missed.">			if (ret) {</span>
<span class="nc" id="L2939">				unitWas.fireChanges();</span>
			}
<span class="nc" id="L2941">			updateGUI(null);</span>
		}
<span class="nc" id="L2943">		return ret;</span>
	}

	/**
	 * Changes the work type of this &lt;code&gt;Unit&lt;/code&gt;.
	 *
	 * Called from ColonyPanel.tryWork, UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt;
	 * @param workType
	 *            The new &lt;code&gt;GoodsType&lt;/code&gt; to produce.
	 * @return True if the work type was changed.
	 */
	public boolean changeWorkType(Unit unit, GoodsType workType) {
<span class="nc bnc" id="L2958" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L2959">			return false;</span>

<span class="nc" id="L2961">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L2962" title="All 4 branches missed.">		boolean ret = askServer().changeWorkType(unit, workType) &amp;&amp; unit.getWorkType() == workType;</span>
<span class="nc bnc" id="L2963" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2964">			unitWas.fireChanges();</span>
<span class="nc" id="L2965">			updateGUI(null);</span>
		}
<span class="nc" id="L2967">		return ret;</span>
	}

	/**
	 * Check if a unit is a treasure train, and if it should be cashed in.
	 * Transfers the gold carried by this unit to the {@link Player owner}.
	 *
	 * Called from TilePopup
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to be checked.
	 * @return True if the unit was cashed in (and disposed).
	 */
	public boolean checkCashInTreasureTrain(Unit unit) {
<span class="nc bnc" id="L2981" title="All 8 branches missed.">		if (!requireOurTurn() || unit == null || !unit.canCarryTreasure() || !unit.canCashInTreasureTrain())</span>
<span class="nc" id="L2982">			return false; // Fail quickly if just not a candidate.</span>

<span class="nc" id="L2984">		final Tile tile = unit.getTile();</span>
<span class="nc" id="L2985">		final Europe europe = unit.getOwner().getEurope();</span>
<span class="nc bnc" id="L2986" title="All 4 branches missed.">		if (europe == null || unit.isInEurope()) {</span>
			;// No need to check for transport.
		} else {
<span class="nc" id="L2989">			int fee = unit.getTransportFee();</span>
			StringTemplate template;
<span class="nc bnc" id="L2991" title="All 2 branches missed.">			if (fee == 0) {</span>
<span class="nc" id="L2992">				template = StringTemplate.template(&quot;cashInTreasureTrain.free&quot;);</span>
			} else {
<span class="nc" id="L2994">				int percent = getSpecification().getInteger(GameOptions.TREASURE_TRANSPORT_FEE);</span>
<span class="nc" id="L2995">				template = StringTemplate.template(&quot;cashInTreasureTrain.pay&quot;).addAmount(&quot;%fee%&quot;, percent);</span>
			}
<span class="nc bnc" id="L2997" title="All 2 branches missed.">			if (!gui.confirm(unit.getTile(), template, unit, &quot;accept&quot;, &quot;reject&quot;))</span>
<span class="nc" id="L2998">				return false;</span>
		}

<span class="nc" id="L3001">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3002" title="All 4 branches missed.">		boolean ret = askServer().cashInTreasureTrain(unit) &amp;&amp; unit.isDisposed();</span>
<span class="nc bnc" id="L3003" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3004">			sound(&quot;sound.event.cashInTreasureTrain&quot;);</span>
<span class="nc" id="L3005">			unitWas.fireChanges();</span>
<span class="nc" id="L3006">			updateGUI(tile);</span>
		}
<span class="nc" id="L3008">		return ret;</span>
	}

	/**
	 * Choose a founding father from an offered list.
	 *
	 * Called from GUI.showChooseFoundingFatherDialog
	 *
	 * @param ffs
	 *            A list of &lt;code&gt;FoundingFather&lt;/code&gt;s to choose from.
	 * @param ff
	 *            The chosen &lt;code&gt;FoundingFather&lt;/code&gt; (may be null).
	 * @return True if a father was chosen.
	 */
	public boolean chooseFoundingFather(List&lt;FoundingFather&gt; ffs, FoundingFather ff) {
<span class="nc bnc" id="L3023" title="All 2 branches missed.">		if (ffs == null)</span>
<span class="nc" id="L3024">			return false;</span>

<span class="nc" id="L3026">		Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L3027">		player.setCurrentFather(ff);</span>
<span class="nc" id="L3028">		return askServer().chooseFoundingFather(ffs, ff);</span>
	}

	/**
	 * Choose a founding father from an offered list.
	 *
	 * Called from IGIH.chooseFoundingFather.
	 *
	 * @param ffs
	 *            A list of &lt;code&gt;FoundingFather&lt;/code&gt;s to choose from.
	 */
	public void chooseFoundingFather(List&lt;FoundingFather&gt; ffs) {
<span class="nc bnc" id="L3040" title="All 2 branches missed.">		if (ffs == null)</span>
<span class="nc" id="L3041">			return;</span>
<span class="nc" id="L3042">		gui.showChooseFoundingFatherDialog(ffs, (FoundingFather ff) -&gt; chooseFoundingFather(ffs, ff));</span>
<span class="nc" id="L3043">	}</span>

	/**
	 * Claim a tile.
	 *
	 * Called from ColonyPanel.ASingleTilePanel, UnitLabel and work()
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to claim.
	 * @param claimant
	 *            The &lt;code&gt;Unit&lt;/code&gt; or &lt;code&gt;Colony&lt;/code&gt; claiming.
	 * @return True if the claim succeeded.
	 */
	public boolean claimTile(Tile tile, FreeColGameObject claimant) {
<span class="nc bnc" id="L3057" title="All 6 branches missed.">		if (!requireOurTurn() || tile == null || claimant == null)</span>
<span class="nc" id="L3058">			return false;</span>

<span class="nc" id="L3060">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L3061" title="All 4 branches missed.">		final int price = ((claimant instanceof Settlement) ? player.canClaimForSettlement(tile)</span>
<span class="nc bnc" id="L3062" title="All 2 branches missed.">				: player.canClaimForImprovement(tile)) ? 0 : player.getLandPrice(tile);</span>
<span class="nc bnc" id="L3063" title="All 2 branches missed.">		UnitWas unitWas = (claimant instanceof Unit) ? new UnitWas((Unit) claimant) : null;</span>
<span class="nc" id="L3064">		boolean ret = askClaimTile(player, tile, claimant, price);</span>
<span class="nc bnc" id="L3065" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L3066" title="All 2 branches missed.">			if (unitWas != null)</span>
<span class="nc" id="L3067">				unitWas.fireChanges();</span>
<span class="nc" id="L3068">			updateGUI(null);</span>
		}
<span class="nc" id="L3070">		return ret;</span>
	}

	/**
	 * Clears the goto orders of the given unit by setting its destination to
	 * null.
	 *
	 * Called from CanvasMouseListener
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to clear the destination for.
	 * @return True if the unit has no destination.
	 */
	public boolean clearGotoOrders(Unit unit) {
<span class="nc bnc" id="L3084" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L3085">			return false;</span>

<span class="nc" id="L3087">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3088">		boolean ret = askClearGotoOrders(unit);</span>
<span class="nc bnc" id="L3089" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3090">			unitWas.fireChanges();</span>
<span class="nc" id="L3091">			updateGUI(null);</span>
		}
<span class="nc" id="L3093">		return ret;</span>
	}

	/**
	 * Clears the orders of the given unit. Make the unit active and set a null
	 * destination and trade route.
	 *
	 * Called from ClearOrdersAction, TilePopup, TradeRoutePanel, UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to clear the orders of
	 * @return boolean &lt;b&gt;true&lt;/b&gt; if the orders were cleared
	 */
	public boolean clearOrders(Unit unit) {
<span class="nc bnc" id="L3107" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L3108">			return false;</span>

<span class="nc bnc" id="L3110" title="All 4 branches missed.">		if (unit.getState() == UnitState.IMPROVING &amp;&amp; !gui.confirm(unit.getTile(),</span>
<span class="nc" id="L3111">				StringTemplate.template(&quot;clearOrders.text&quot;).addAmount(&quot;%turns%&quot;, unit.getWorkTurnsLeft()), unit, &quot;ok&quot;,</span>
				&quot;cancel&quot;)) {
<span class="nc" id="L3113">			return false;</span>
		}

<span class="nc" id="L3116">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3117" title="All 2 branches missed.">		boolean ret = askClearGotoOrders(unit)</span>
<span class="nc bnc" id="L3118" title="All 4 branches missed.">				&amp;&amp; (unit.getState() == UnitState.ACTIVE || askServer().changeState(unit, UnitState.ACTIVE));</span>
<span class="nc bnc" id="L3119" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3120">			unitWas.fireChanges();</span>
<span class="nc" id="L3121">			updateGUI(null);</span>
		}
<span class="nc" id="L3123">		return ret;</span>
	}

	/**
	 * Clear the speciality of a Unit, making it a Free Colonist.
	 *
	 * Called from UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to clear the speciality of.
	 * @return True if the speciality was cleared.
	 */
	public boolean clearSpeciality(Unit unit) {
<span class="nc bnc" id="L3136" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L3137">			return false;</span>

<span class="nc" id="L3139">		UnitType oldType = unit.getType();</span>
<span class="nc" id="L3140">		UnitType newType = oldType.getTargetType(ChangeType.CLEAR_SKILL, unit.getOwner());</span>
<span class="nc bnc" id="L3141" title="All 2 branches missed.">		if (newType == null) {</span>
<span class="nc" id="L3142">			gui.showInformationMessage(unit, StringTemplate.template(&quot;clearSpeciality.impossible&quot;)</span>
<span class="nc" id="L3143">					.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL)));</span>
<span class="nc" id="L3144">			return false;</span>
		}

<span class="nc bnc" id="L3147" title="All 2 branches missed.">		final Tile tile = (gui.isShowingSubPanel()) ? null : unit.getTile();</span>
<span class="nc bnc" id="L3148" title="All 2 branches missed.">		if (!gui.confirm(tile, StringTemplate.template(&quot;clearSpeciality.areYouSure&quot;)</span>
<span class="nc" id="L3149">				.addStringTemplate(&quot;%oldUnit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL)).addNamed(&quot;%unit%&quot;, newType),</span>
				unit, &quot;ok&quot;, &quot;cancel&quot;)) {
<span class="nc" id="L3151">			return false;</span>
		}

		// Try to clear.
		// Note that this routine is only called out of UnitLabel,
		// where the unit icon is always updated anyway.
<span class="nc" id="L3157">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3158" title="All 4 branches missed.">		boolean ret = askServer().clearSpeciality(unit) &amp;&amp; unit.getType() == newType;</span>
<span class="nc bnc" id="L3159" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3160">			unitWas.fireChanges();</span>
<span class="nc" id="L3161">			updateGUI(null);</span>
		}
<span class="nc" id="L3163">		return ret;</span>
	}

	/**
	 * Close any open GUI menus.
	 *
	 * Called from IGIH.closeMenus.
	 */
	public void closeMenus() {
<span class="nc" id="L3172">		gui.closeMenus();</span>
<span class="nc" id="L3173">	}</span>

	/**
	 * Declares independence for the home country.
	 *
	 * Called from DeclareIndependenceAction
	 *
	 * @return True if independence was declared.
	 */
	public boolean declareIndependence() {
<span class="nc bnc" id="L3183" title="All 2 branches missed.">		if (!requireOurTurn())</span>
<span class="nc" id="L3184">			return false;</span>

<span class="nc" id="L3186">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L3187" title="All 2 branches missed.">		if (player.getNewLandName() == null) {</span>
<span class="nc" id="L3188">			return false; // Can only happen in debug mode.</span>
		}

		// Check for adequate support.
<span class="nc" id="L3192">		StringTemplate declare = player.checkDeclareIndependence();</span>
<span class="nc bnc" id="L3193" title="All 2 branches missed.">		if (declare != null) {</span>
<span class="nc" id="L3194">			gui.showInformationMessage(declare);</span>
<span class="nc" id="L3195">			return false;</span>
		}

		// Confirm intention, and collect nation+country names.
<span class="nc" id="L3199">		List&lt;String&gt; names = gui.confirmDeclaration();</span>
<span class="nc bnc" id="L3200" title="All 8 branches missed.">		if (names == null || names.get(0) == null || names.get(0).isEmpty() || names.get(1) == null</span>
<span class="nc bnc" id="L3201" title="All 2 branches missed.">				|| names.get(1).isEmpty()) {</span>
			// Empty name =&gt; user cancelled.
<span class="nc" id="L3203">			return false;</span>
		}

		// Ask server.
<span class="nc bnc" id="L3207" title="All 4 branches missed.">		boolean ret = askServer().declareIndependence(names.get(0), names.get(1)) &amp;&amp; player.isRebel();</span>
<span class="nc bnc" id="L3208" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3209">			gui.showDeclarationPanel();</span>
<span class="nc" id="L3210">			updateGUI(null);</span>
		}
<span class="nc" id="L3212">		return ret;</span>
	}

	/**
	 * Handle a diplomatic offer.
	 *
	 * Called from IGIH.diplomacy
	 *
	 * @param our
	 *            Our &lt;code&gt;FreeColGameObject&lt;/code&gt; that is negotiating.
	 * @param other
	 *            The other &lt;code&gt;FreeColGameObject&lt;/code&gt;.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; agreement.
	 * @return A counter agreement, a rejected agreement, or null if the
	 *         original agreement was already decided.
	 */
	public DiplomaticTrade diplomacy(FreeColGameObject our, FreeColGameObject other, DiplomaticTrade agreement) {
<span class="nc" id="L3230">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L3231">		final Player otherPlayer = agreement.getOtherPlayer(player);</span>
<span class="nc" id="L3232">		StringTemplate t, nation = otherPlayer.getNationLabel();</span>

<span class="nc bnc" id="L3234" title="All 4 branches missed.">		switch (agreement.getStatus()) {</span>
		case ACCEPT_TRADE:
<span class="nc" id="L3236">			boolean visibilityChange = false;</span>
<span class="nc bnc" id="L3237" title="All 2 branches missed.">			for (Colony c : agreement.getColoniesGivenBy(player)) {</span>
<span class="nc" id="L3238">				player.removeSettlement(c);// -vis(player)</span>
<span class="nc" id="L3239">				visibilityChange = true;</span>
<span class="nc" id="L3240">			}</span>
<span class="nc bnc" id="L3241" title="All 2 branches missed.">			for (Unit u : agreement.getUnitsGivenBy(player)) {</span>
<span class="nc" id="L3242">				player.removeUnit(u);// -vis(player)</span>
<span class="nc" id="L3243">				visibilityChange = true;</span>
<span class="nc" id="L3244">			}</span>
<span class="nc bnc" id="L3245" title="All 2 branches missed.">			if (visibilityChange)</span>
<span class="nc" id="L3246">				player.invalidateCanSeeTiles();// +vis(player)</span>
<span class="nc" id="L3247">			ModelMessage mm = new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;diplomacy.offerAccepted&quot;,</span>
<span class="nc" id="L3248">					otherPlayer).addStringTemplate(&quot;%nation%&quot;, nation);</span>
<span class="nc" id="L3249">			player.addModelMessage(mm);</span>
<span class="nc" id="L3250">			updateGUI(null);</span>
<span class="nc" id="L3251">			break;</span>
		case REJECT_TRADE:
<span class="nc" id="L3253">			t = StringTemplate.template(&quot;diplomacy.offerRejected&quot;).addStringTemplate(&quot;%nation%&quot;, nation);</span>
<span class="nc" id="L3254">			gui.showInformationMessage(t);</span>
<span class="nc" id="L3255">			break;</span>
		case PROPOSE_TRADE:
<span class="nc" id="L3257">			t = agreement.getReceiveMessage(otherPlayer);</span>
<span class="nc" id="L3258">			DiplomaticTrade ourAgreement = gui.showNegotiationDialog(our, other, agreement, t);</span>
<span class="nc bnc" id="L3259" title="All 2 branches missed.">			if (ourAgreement == null) {</span>
<span class="nc" id="L3260">				agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
			} else {
<span class="nc" id="L3262">				agreement = ourAgreement;</span>
			}
<span class="nc" id="L3264">			return agreement;</span>
		default:
<span class="nc" id="L3266">			logger.warning(&quot;Bogus trade status: &quot; + agreement.getStatus());</span>
			break;
		}
<span class="nc" id="L3269">		return null;</span>
	}

	/**
	 * Disbands the active unit.
	 *
	 * Called from DisbandUnitAction.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to disband.
	 * @return True if the unit was disbanded.
	 */
	public boolean disbandUnit(Unit unit) {
<span class="nc bnc" id="L3282" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L3283">			return false;</span>

<span class="nc bnc" id="L3285" title="All 4 branches missed.">		if (unit.getColony() != null &amp;&amp; !gui.confirmLeaveColony(unit))</span>
<span class="nc" id="L3286">			return false;</span>
<span class="nc bnc" id="L3287" title="All 2 branches missed.">		final Tile tile = (gui.isShowingSubPanel()) ? null : unit.getTile();</span>
<span class="nc bnc" id="L3288" title="All 2 branches missed.">		if (!gui.confirm(tile, StringTemplate.key(&quot;disbandUnit.text&quot;), unit, &quot;disbandUnit.yes&quot;, &quot;cancel&quot;))</span>
<span class="nc" id="L3289">			return false;</span>

		// Try to disband
<span class="nc bnc" id="L3292" title="All 4 branches missed.">		boolean ret = askServer().disbandUnit(unit) &amp;&amp; unit.isDisposed();</span>
<span class="nc bnc" id="L3293" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3294">			updateGUI(tile);</span>
		}
<span class="nc" id="L3296">		return ret;</span>
	}

	/**
	 * Display the high scores.
	 *
	 * Called from IGIH.gameEnded, ReportHighScoresAction
	 *
	 * @param high
	 *            A &lt;code&gt;Boolean&lt;/code&gt; whose values indicates whether a new
	 *            high score has been achieved, or no information if null.
	 * @return True, the high scores were displayed.
	 */
	public boolean displayHighScores(Boolean high) {
<span class="nc" id="L3310">		List&lt;HighScore&gt; scores = askServer().getHighScores();</span>
<span class="nc bnc" id="L3311" title="All 4 branches missed.">		gui.showHighScoresPanel((high == null) ? null : (high) ? &quot;highscores.yes&quot; : &quot;highscores.no&quot;, scores);</span>
<span class="nc" id="L3312">		return true;</span>
	}

	/**
	 * Displays pending &lt;code&gt;ModelMessage&lt;/code&gt;s.
	 *
	 * Called from IGIH.displayModelMessagesRunnable
	 *
	 * @param allMessages
	 *            Display all messages or just the undisplayed ones.
	 * @return True if any messages were displayed.
	 */
	public boolean displayModelMessages(boolean allMessages) {
<span class="nc" id="L3325">		return displayModelMessages(allMessages, false);</span>
	}

	/**
	 * Emigrate a unit from Europe.
	 *
	 * Called from GUI.showEmigrationDialog.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; that owns the unit.
	 * @param slot
	 *            The slot to emigrate from, [0..RECRUIT_COUNT].
	 * @param n
	 *            The number of remaining units known to be eligible to migrate.
	 * @param foY
	 *            True if this migration is due to a fountain of youth event.
	 */
	public void emigrate(Player player, int slot, int n, boolean foY) {
<span class="nc bnc" id="L3343" title="All 6 branches missed.">		if (player == null || !player.isColonial() || !MigrationType.validMigrantSlot(slot))</span>
<span class="nc" id="L3344">			return;</span>

<span class="nc bnc" id="L3346" title="All 2 branches missed.">		if (askEmigrate(player.getEurope(), slot) != null) {</span>
<span class="nc" id="L3347">			emigration(player, n, foY);</span>
		}
<span class="nc" id="L3349">	}</span>

	/**
	 * End the turn command.
	 *
	 * Called from EndTurnAction, GUI.showEndTurnDialog
	 *
	 * @param showDialog
	 *            If false, suppress showing the end turn dialog.
	 * @return True if the turn was ended.
	 */
	public boolean endTurn(boolean showDialog) {
<span class="nc bnc" id="L3361" title="All 2 branches missed.">		if (!requireOurTurn())</span>
<span class="nc" id="L3362">			return false;</span>

<span class="nc bnc" id="L3364" title="All 4 branches missed.">		return doEndTurn(showDialog &amp;&amp; freeColClient.getClientOptions().getBoolean(ClientOptions.SHOW_END_TURN_DIALOG));</span>
	}

	/**
	 * Change the role-equipment a unit has.
	 *
	 * Called from DefaultTransferHandler, QuickActionMenu
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt;.
	 * @param role
	 *            The &lt;code&gt;Role&lt;/code&gt; to assume.
	 * @param roleCount
	 *            The role count.
	 * @return True if the role is taken.
	 */
	public boolean equipUnitForRole(Unit unit, Role role, int roleCount) {
<span class="nc bnc" id="L3381" title="All 10 branches missed.">		if (!requireOurTurn() || unit == null || role == null || 0 &gt; roleCount || roleCount &gt; role.getMaximumCount())</span>
<span class="nc" id="L3382">			return false;</span>
<span class="nc bnc" id="L3383" title="All 4 branches missed.">		if (role == unit.getRole() &amp;&amp; roleCount == unit.getRoleCount())</span>
<span class="nc" id="L3384">			return true;</span>

<span class="nc" id="L3386">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L3387">		final Colony colony = unit.getColony();</span>
<span class="nc bnc" id="L3388" title="All 2 branches missed.">		ColonyWas colonyWas = (colony != null) ? new ColonyWas(colony) : null;</span>
<span class="nc" id="L3389">		final Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L3390" title="All 2 branches missed.">		EuropeWas europeWas = (europe != null) ? new EuropeWas(europe) : null;</span>
<span class="nc bnc" id="L3391" title="All 2 branches missed.">		final Market market = (europe != null) ? player.getMarket() : null;</span>
<span class="nc bnc" id="L3392" title="All 2 branches missed.">		MarketWas marketWas = (market != null) ? new MarketWas(player) : null;</span>
<span class="nc" id="L3393">		int price = -1;</span>

<span class="nc" id="L3395">		List&lt;AbstractGoods&gt; req = unit.getGoodsDifference(role, roleCount);</span>
<span class="nc bnc" id="L3396" title="All 2 branches missed.">		if (unit.isInEurope()) {</span>
<span class="nc bnc" id="L3397" title="All 2 branches missed.">			for (AbstractGoods ag : req) {</span>
<span class="nc" id="L3398">				GoodsType goodsType = ag.getType();</span>
<span class="nc bnc" id="L3399" title="All 4 branches missed.">				if (!player.canTrade(goodsType) &amp;&amp; !payArrears(goodsType)) {</span>
<span class="nc" id="L3400">					return false; // payment failed</span>
				}
<span class="nc" id="L3402">			}</span>
<span class="nc" id="L3403">			price = player.getEurope().priceGoods(req);</span>
<span class="nc bnc" id="L3404" title="All 4 branches missed.">			if (price &lt; 0 || !player.checkGold(price))</span>
<span class="nc" id="L3405">				return false;</span>
<span class="nc bnc" id="L3406" title="All 2 branches missed.">		} else if (colony != null) {</span>
<span class="nc bnc" id="L3407" title="All 2 branches missed.">			for (AbstractGoods ag : req) {</span>
<span class="nc bnc" id="L3408" title="All 2 branches missed.">				if (colony.getGoodsCount(ag.getType()) &lt; ag.getAmount()) {</span>
<span class="nc" id="L3409">					StringTemplate template = StringTemplate.template(&quot;equipUnit.impossible&quot;)</span>
<span class="nc" id="L3410">							.addName(&quot;%colony%&quot;, colony.getName()).addNamed(&quot;%equipment%&quot;, ag.getType())</span>
<span class="nc" id="L3411">							.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L3412">					gui.showInformationMessage(unit, template);</span>
<span class="nc" id="L3413">					return false;</span>
				}
<span class="nc" id="L3415">			}</span>
		} else {
<span class="nc" id="L3417">			return false;</span>
		}

<span class="nc" id="L3420">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3421" title="All 4 branches missed.">		boolean ret = askServer().equipUnitForRole(unit, role, roleCount) &amp;&amp; unit.getRole() == role;</span>
<span class="nc bnc" id="L3422" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L3423" title="All 2 branches missed.">			if (colonyWas != null)</span>
<span class="nc" id="L3424">				colonyWas.fireChanges();</span>
<span class="nc bnc" id="L3425" title="All 2 branches missed.">			if (europeWas != null)</span>
<span class="nc" id="L3426">				europeWas.fireChanges();</span>
<span class="nc bnc" id="L3427" title="All 2 branches missed.">			if (marketWas != null)</span>
<span class="nc" id="L3428">				marketWas.fireChanges(req);</span>
<span class="nc" id="L3429">			unitWas.fireChanges();</span>
<span class="nc" id="L3430">			updateGUI(null);</span>
		}
<span class="nc" id="L3432">		return ret;</span>
	}

	/**
	 * Display an error.
	 *
	 * Called from IGIH.error.
	 *
	 * @param messageId
	 *            The i18n-keyname of the error message to display.
	 * @param message
	 *            An alternative (possibly non-i18n) message to display if the
	 *            resource specified by &lt;code&gt;messageId&lt;/code&gt; is unavailable.
	 */
	public void error(String messageId, String message) {
<span class="nc" id="L3447">		gui.showErrorMessage(messageId, message);</span>
<span class="nc" id="L3448">	}</span>

	/**
	 * Execute goto orders command.
	 *
	 * Called from ExecuteGotoOrdersAction.
	 *
	 * @return True if all goto orders have been performed and no units reached
	 *         their destination and are free to move again.
	 */
	public boolean executeGotoOrders() {
<span class="nc bnc" id="L3459" title="All 2 branches missed.">		if (!requireOurTurn())</span>
<span class="nc" id="L3460">			return false;</span>

<span class="nc" id="L3462">		return doExecuteGotoOrders();</span>
	}

	/**
	 * A player makes first contact with a native player.
	 *
	 * Called from GUI.showFirstContactDialog
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; making contact.
	 * @param other
	 *            The native &lt;code&gt;Player&lt;/code&gt; being contacted.
	 * @param tile
	 *            An optional &lt;code&gt;Tile&lt;/code&gt; to offer the player if they have
	 *            made a first landing.
	 * @param result
	 *            Whether the initial treaty was accepted.
	 * @return True if first contact occurs.
	 */
	public boolean firstContact(Player player, Player other, Tile tile, boolean result) {
<span class="nc bnc" id="L3482" title="All 8 branches missed.">		if (player == null || player == null || player == other || tile == null)</span>
<span class="nc" id="L3483">			return false;</span>

<span class="nc" id="L3485">		boolean ret = askServer().firstContact(player, other, tile, result);</span>
<span class="nc bnc" id="L3486" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3487">			updateGUI(null);</span>
		}
<span class="nc" id="L3489">		return ret;</span>
	}

	/**
	 * A player makes first contact with a native player.
	 *
	 * Called from IGIH.firstContact.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; making contact.
	 * @param other
	 *            The native &lt;code&gt;Player&lt;/code&gt; being contacted.
	 * @param tile
	 *            An optional &lt;code&gt;Tile&lt;/code&gt; to offer the player if they have
	 *            made a first landing.
	 * @param n
	 *            The number of settlements claimed by the native player.
	 */
	public void firstContact(Player player, Player other, Tile tile, int n) {
<span class="nc" id="L3508">		gui.showFirstContactDialog(player, other, tile, n, (Boolean b) -&gt; firstContact(player, other, tile, b));</span>
<span class="nc" id="L3509">	}</span>

	/**
	 * Handle a fountain of youth event.
	 *
	 * Called from IGIH.fountainOfYouth.
	 *
	 * @param n
	 *            The number of migrants available for selection.
	 */
	public void fountainOfYouth(int n) {
<span class="nc" id="L3520">		Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L3521">		final boolean fountainOfYouth = true;</span>
<span class="nc" id="L3522">		gui.showEmigrationDialog(player, fountainOfYouth, (Integer value) -&gt; { // Value</span>
																				// is
																				// a
																				// valid
																				// slot
<span class="nc" id="L3527">			emigrate(player, Europe.MigrationType.convertToMigrantSlot(value), n - 1, fountainOfYouth);</span>
<span class="nc" id="L3528">		});</span>
<span class="nc" id="L3529">	}</span>

	/**
	 * Get the nation summary for a player.
	 *
	 * Called from DiplomaticTradePanel, ReportForeignAffairsPanel,
	 * ReportIndianPanel
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; to summarize.
	 * @return A summary of that nation, or null on error.
	 */
	public NationSummary getNationSummary(Player player) {
<span class="nc bnc" id="L3542" title="All 2 branches missed.">		if (player == null)</span>
<span class="nc" id="L3543">			return null;</span>

<span class="nc" id="L3545">		return askServer().getNationSummary(player);</span>
	}

	/**
	 * Gets a new trade route for a player.
	 *
	 * Called from TradeRoutePanel.newRoute
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; to get a new trade route for.
	 * @return A new &lt;code&gt;TradeRoute&lt;/code&gt;.
	 */
	public TradeRoute getNewTradeRoute(Player player) {
<span class="nc bnc" id="L3558" title="All 2 branches missed.">		if (player == null)</span>
<span class="nc" id="L3559">			return null;</span>

<span class="nc" id="L3561">		final int n = player.getTradeRoutes().size();</span>
<span class="nc bnc" id="L3562" title="All 4 branches missed.">		return (askServer().getNewTradeRoute() &amp;&amp; player.getTradeRoutes().size() == n + 1)</span>
<span class="nc" id="L3563">				? player.getTradeRoutes().get(n) : null;</span>
	}

	/**
	 * Gathers information about the REF.
	 *
	 * Called from ReportNavalPanel, ReportMilitaryPanel
	 *
	 * @return a &lt;code&gt;List&lt;/code&gt; value
	 */
	public List&lt;AbstractUnit&gt; getREFUnits() {
<span class="nc bnc" id="L3574" title="All 2 branches missed.">		return (!requireOurTurn()) ? Collections.&lt;AbstractUnit&gt;emptyList() : askServer().getREFUnits();</span>
	}

	/**
	 * Retrieves the server statistics.
	 *
	 * Called from StatisticsPanel
	 *
	 * @return A &lt;code&gt;Map&lt;/code&gt; containing the server statistics.
	 */
	public java.util.Map&lt;String, String&gt; getServerStatistics() {
<span class="nc" id="L3585">		return askServer().getStatistics();</span>
	}

	/**
	 * Go to a tile.
	 *
	 * Called from CanvasMouseListener, TilePopup
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to move.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to move to.
	 * @return True if the destination change was successful.
	 */
	public boolean goToTile(Unit unit, Tile tile) {
<span class="nc bnc" id="L3600" title="All 6 branches missed.">		if (!requireOurTurn() || unit == null || !freeColClient.getMyPlayer().owns(unit))</span>
<span class="nc" id="L3601">			return false;</span>

<span class="nc bnc" id="L3603" title="All 2 branches missed.">		if (!gui.confirmClearTradeRoute(unit))</span>
<span class="nc" id="L3604">			return false;</span>

<span class="nc" id="L3606">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3607">		boolean ret = askSetDestination(unit, tile);</span>
<span class="nc bnc" id="L3608" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3609">			moveToDestination(unit, null);</span>
<span class="nc" id="L3610">			unitWas.fireChanges();</span>
<span class="nc" id="L3611">			updateGUI(null);</span>
		}
<span class="nc" id="L3613">		return ret;</span>
	}

	/**
	 * Ignore this ModelMessage from now on until it is not generated in a turn.
	 *
	 * Called from ReportTurnPanel
	 *
	 * @param message
	 *            a &lt;code&gt;ModelMessage&lt;/code&gt; value
	 * @param flag
	 *            whether to ignore the ModelMessage or not
	 * @return True, ignore message status changes can not fail.
	 */
	public boolean ignoreMessage(ModelMessage message, boolean flag) {
		String key;
<span class="nc bnc" id="L3629" title="All 4 branches missed.">		if (message == null || (key = message.getIgnoredMessageKey()) == null)</span>
<span class="nc" id="L3630">			return false;</span>

<span class="nc bnc" id="L3632" title="All 2 branches missed.">		if (flag) {</span>
<span class="nc" id="L3633">			final Turn turn = freeColClient.getGame().getTurn();</span>
<span class="nc bnc" id="L3634" title="All 2 branches missed.">			if (!continueIgnoreMessage(key, turn)) {</span>
<span class="nc" id="L3635">				startIgnoringMessage(key, turn);</span>
			}
<span class="nc" id="L3637">		} else {</span>
<span class="nc" id="L3638">			stopIgnoringMessage(key);</span>
		}
<span class="nc" id="L3640">		return true;</span>
	}

	/**
	 * Handle a native demand at a colony.
	 *
	 * Called from IGIH.indianDemand
	 *
	 * @param unit
	 *            The native &lt;code&gt;Unit&lt;/code&gt; making the demand.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; demanded of.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; demanded (null means gold).
	 * @param amount
	 *            The amount of goods/gold demanded.
	 * @return Whether the demand was accepted or not.
	 */
	public boolean indianDemand(Unit unit, Colony colony, GoodsType type, int amount) {
<span class="nc bnc" id="L3659" title="All 4 branches missed.">		if (unit == null || colony == null)</span>
<span class="nc" id="L3660">			return false;</span>

<span class="nc" id="L3662">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L3663">		final int opt = freeColClient.getClientOptions().getInteger(ClientOptions.INDIAN_DEMAND_RESPONSE);</span>
		boolean accepted;
<span class="nc" id="L3665">		ModelMessage m = null;</span>
<span class="nc" id="L3666">		String nation = Messages.message(unit.getOwner().getNationLabel());</span>
<span class="nc bnc" id="L3667" title="All 2 branches missed.">		if (type == null) {</span>
<span class="nc bnc" id="L3668" title="All 4 branches missed.">			switch (opt) {</span>
			case ClientOptions.INDIAN_DEMAND_RESPONSE_ASK:
<span class="nc" id="L3670">				accepted = gui.confirm(colony.getTile(),</span>
<span class="nc" id="L3671">						StringTemplate.template(&quot;indianDemand.gold.text&quot;).addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3672">								.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%amount%&quot;, amount),</span>
						unit, &quot;accept&quot;, &quot;indianDemand.gold.no&quot;);
<span class="nc" id="L3674">				break;</span>
			case ClientOptions.INDIAN_DEMAND_RESPONSE_ACCEPT:
<span class="nc" id="L3676">				m = new ModelMessage(ModelMessage.MessageType.DEMANDS, &quot;indianDemand.gold.text&quot;, colony, unit)</span>
<span class="nc" id="L3677">						.addName(&quot;%nation%&quot;, nation).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3678">						.addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc" id="L3679">				accepted = true;</span>
<span class="nc" id="L3680">				break;</span>
			case ClientOptions.INDIAN_DEMAND_RESPONSE_REJECT:
<span class="nc" id="L3682">				m = new ModelMessage(ModelMessage.MessageType.DEMANDS, &quot;indianDemand.gold.text&quot;, colony, unit)</span>
<span class="nc" id="L3683">						.addName(&quot;%nation%&quot;, nation).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3684">						.addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc" id="L3685">				accepted = false;</span>
<span class="nc" id="L3686">				break;</span>
			default:
<span class="nc" id="L3688">				throw new RuntimeException(&quot;Impossible option value.&quot;);</span>
			}
		} else {
<span class="nc bnc" id="L3691" title="All 4 branches missed.">			switch (opt) {</span>
			case ClientOptions.INDIAN_DEMAND_RESPONSE_ASK:
<span class="nc bnc" id="L3693" title="All 2 branches missed.">				if (type.isFoodType()) {</span>
<span class="nc" id="L3694">					accepted = gui.confirm(colony.getTile(),</span>
<span class="nc" id="L3695">							StringTemplate.template(&quot;indianDemand.food.text&quot;).addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3696">									.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%amount%&quot;, amount),</span>
							unit, &quot;indianDemand.food.yes&quot;, &quot;indianDemand.food.no&quot;);
				} else {
<span class="nc" id="L3699">					accepted = gui.confirm(colony.getTile(),</span>
<span class="nc" id="L3700">							StringTemplate.template(&quot;indianDemand.other.text&quot;).addName(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L3701">									.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L3702">									.addNamed(&quot;%goods%&quot;, type),</span>
							unit, &quot;accept&quot;, &quot;indianDemand.other.no&quot;);
				}
<span class="nc" id="L3705">				break;</span>
			case ClientOptions.INDIAN_DEMAND_RESPONSE_ACCEPT:
<span class="nc bnc" id="L3707" title="All 2 branches missed.">				if (type.isFoodType()) {</span>
<span class="nc" id="L3708">					m = new ModelMessage(ModelMessage.MessageType.DEMANDS, &quot;indianDemand.food.text&quot;, colony, unit)</span>
<span class="nc" id="L3709">							.addName(&quot;%nation%&quot;, nation).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3710">							.addAmount(&quot;%amount%&quot;, amount);</span>
				} else {
<span class="nc" id="L3712">					m = new ModelMessage(ModelMessage.MessageType.DEMANDS, &quot;indianDemand.other.text&quot;, colony, unit)</span>
<span class="nc" id="L3713">							.addName(&quot;%nation%&quot;, nation).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3714">							.addAmount(&quot;%amount%&quot;, amount).addNamed(&quot;%goods%&quot;, type);</span>
				}
<span class="nc" id="L3716">				accepted = true;</span>
<span class="nc" id="L3717">				break;</span>
			case ClientOptions.INDIAN_DEMAND_RESPONSE_REJECT:
<span class="nc bnc" id="L3719" title="All 2 branches missed.">				if (type.isFoodType()) {</span>
<span class="nc" id="L3720">					m = new ModelMessage(ModelMessage.MessageType.DEMANDS, &quot;indianDemand.food.text&quot;, colony, unit)</span>
<span class="nc" id="L3721">							.addName(&quot;%nation%&quot;, nation).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3722">							.addAmount(&quot;%amount%&quot;, amount);</span>
				} else {
<span class="nc" id="L3724">					m = new ModelMessage(ModelMessage.MessageType.DEMANDS, &quot;indianDemand.other.text&quot;, colony, unit)</span>
<span class="nc" id="L3725">							.addName(&quot;%nation%&quot;, nation).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L3726">							.addAmount(&quot;%amount%&quot;, amount).addNamed(&quot;%goods%&quot;, type);</span>
				}
<span class="nc" id="L3728">				accepted = false;</span>
<span class="nc" id="L3729">				break;</span>
			default:
<span class="nc" id="L3731">				throw new RuntimeException(&quot;Impossible option value.&quot;);</span>
			}
		}
<span class="nc bnc" id="L3734" title="All 2 branches missed.">		if (m != null) {</span>
<span class="nc" id="L3735">			player.addModelMessage(m);</span>
<span class="nc" id="L3736">			displayModelMessages(false);</span>
		}
<span class="nc" id="L3738">		return accepted;</span>
	}

	/**
	 * Leave a ship. The ship must be in harbour.
	 *
	 * Called from CargoPanel, ColonyPanel, EuropePanel.unloadAction, UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; which is to leave the ship.
	 * @return True if the unit left the ship.
	 */
	public boolean leaveShip(Unit unit) {
		Unit carrier;
<span class="nc bnc" id="L3752" title="All 6 branches missed.">		if (!requireOurTurn() || unit == null || (carrier = unit.getCarrier()) == null)</span>
<span class="nc" id="L3753">			return false;</span>

		// Proceed to disembark
<span class="nc" id="L3756">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L3757" title="All 4 branches missed.">		boolean ret = askServer().disembark(unit) &amp;&amp; unit.getLocation() != carrier;</span>
<span class="nc bnc" id="L3758" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3759">			checkCashInTreasureTrain(unit);</span>
<span class="nc" id="L3760">			unitWas.fireChanges();</span>
<span class="nc" id="L3761">			updateGUI(null);</span>
		}
<span class="nc" id="L3763">		return ret;</span>
	}

	/**
	 * Loads a cargo onto a carrier.
	 * 
	 * Called from CargoPanel, ColonyPanel, LoadAction, TilePopup.
	 *
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; which are going aboard the carrier.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; acting as carrier.
	 * @return true, if successful
	 */
	public boolean loadCargo(Goods goods, Unit carrier) {
<span class="nc bnc" id="L3778" title="All 10 branches missed.">		if (!requireOurTurn() || goods == null || goods.getAmount() &lt;= 0 || goods.getLocation() == null</span>
<span class="nc bnc" id="L3779" title="All 2 branches missed.">				|| carrier == null || !carrier.isCarrier())</span>
<span class="nc" id="L3780">			return false;</span>

<span class="nc bnc" id="L3782" title="All 2 branches missed.">		if (goods.getLocation() instanceof Europe) {</span>
<span class="nc" id="L3783">			return buyGoods(goods.getType(), goods.getAmount(), carrier);</span>
		}
<span class="nc" id="L3785">		UnitWas carrierWas = new UnitWas(carrier);</span>
<span class="nc" id="L3786">		UnitWas sourceWas = null;</span>
<span class="nc" id="L3787">		ColonyWas colonyWas = null;</span>
<span class="nc bnc" id="L3788" title="All 2 branches missed.">		if (goods.getLocation() instanceof Unit) {</span>
<span class="nc" id="L3789">			Unit source = (Unit) goods.getLocation();</span>
<span class="nc" id="L3790">			sourceWas = new UnitWas(source);</span>
<span class="nc" id="L3791">		} else {</span>
<span class="nc" id="L3792">			Colony colony = carrier.getColony();</span>
<span class="nc bnc" id="L3793" title="All 2 branches missed.">			if (colony == null)</span>
<span class="nc" id="L3794">				return false;</span>
<span class="nc" id="L3795">			colonyWas = new ColonyWas(colony);</span>
		}

<span class="nc" id="L3798">		boolean ret = askLoadGoods(goods.getLocation(), goods.getType(), goods.getAmount(), carrier);</span>
<span class="nc bnc" id="L3799" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3800">			sound(&quot;sound.event.loadCargo&quot;);</span>
<span class="nc bnc" id="L3801" title="All 2 branches missed.">			if (colonyWas != null)</span>
<span class="nc" id="L3802">				colonyWas.fireChanges();</span>
<span class="nc bnc" id="L3803" title="All 2 branches missed.">			if (sourceWas != null)</span>
<span class="nc" id="L3804">				sourceWas.fireChanges();</span>
<span class="nc" id="L3805">			carrierWas.fireChanges();</span>
<span class="nc" id="L3806">			updateGUI(null);</span>
		}
<span class="nc" id="L3808">		return ret;</span>
	}

	/**
	 * Opens a dialog where the user should specify the filename and loads the
	 * game.
	 *
	 * Called from OpenAction.
	 *
	 * Returns no status as this game is stopped.
	 */
	public void loadGame() {
<span class="nc" id="L3820">		File file = gui.showLoadSaveFileDialog();</span>
<span class="nc bnc" id="L3821" title="All 2 branches missed.">		if (file == null)</span>
<span class="nc" id="L3822">			return;</span>
<span class="nc bnc" id="L3823" title="All 4 branches missed.">		if (freeColClient.isInGame() &amp;&amp; !gui.confirmStopGame())</span>
<span class="nc" id="L3824">			return;</span>

<span class="nc" id="L3826">		freeColClient.getConnectController().quitGame(true);</span>
<span class="nc" id="L3827">		turnReportMessages.clear();</span>
<span class="nc" id="L3828">		gui.setActiveUnit(null);</span>
<span class="nc" id="L3829">		gui.removeInGameComponents();</span>
<span class="nc" id="L3830">		FreeColDirectories.setSavegameFile(file.getPath());</span>
<span class="nc" id="L3831">		freeColClient.getConnectController().startSavedGame(file, null);</span>
<span class="nc" id="L3832">	}</span>

	/**
	 * Loot some cargo.
	 *
	 * Called from GUI.showCaptureGoodsDialog
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is looting.
	 * @param goods
	 *            A list of &lt;code&gt;Goods&lt;/code&gt; to choose from.
	 * @param defenderId
	 *            The identifier of the defender unit (may have sunk).
	 * @return True if looting occurs.
	 */
	public boolean lootCargo(Unit unit, List&lt;Goods&gt; goods, String defenderId) {
<span class="nc bnc" id="L3848" title="All 8 branches missed.">		if (unit == null || goods == null || goods.isEmpty() || defenderId == null)</span>
<span class="nc" id="L3849">			return false;</span>

<span class="nc" id="L3851">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3852">		boolean ret = askServer().loot(unit, defenderId, goods);</span>
<span class="nc bnc" id="L3853" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3854">			unitWas.fireChanges();</span>
<span class="nc" id="L3855">			updateGUI(null);</span>
		}
<span class="nc" id="L3857">		return ret;</span>
	}

	/**
	 * Loot some cargo.
	 *
	 * Called from IGIH.lootCargo.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is looting.
	 * @param goods
	 *            A list of &lt;code&gt;Goods&lt;/code&gt; to choose from.
	 * @param defenderId
	 *            The identifier of the defender unit (may have sunk).
	 */
	public void loot(Unit unit, List&lt;Goods&gt; goods, String defenderId) {
<span class="nc" id="L3873">		gui.showCaptureGoodsDialog(unit, goods, (List&lt;Goods&gt; gl) -&gt; lootCargo(unit, gl, defenderId));</span>
<span class="nc" id="L3874">	}</span>

	/**
	 * Accept or reject a monarch action.
	 *
	 * Called from GUI.showMonarchDialog
	 *
	 * @param action
	 *            The &lt;code&gt;MonarchAction&lt;/code&gt; performed.
	 * @param accept
	 *            If true, accept the action.
	 * @return True if the monarch was answered.
	 */
	public boolean monarchAction(MonarchAction action, boolean accept) {
<span class="nc bnc" id="L3888" title="All 2 branches missed.">		if (action == null)</span>
<span class="nc" id="L3889">			return false;</span>

<span class="nc" id="L3891">		boolean ret = false;</span>
<span class="nc bnc" id="L3892" title="All 2 branches missed.">		switch (action) {</span>
		case RAISE_TAX_ACT:
		case RAISE_TAX_WAR:
		case MONARCH_MERCENARIES:
		case HESSIAN_MERCENARIES:
<span class="nc" id="L3897">			ret = askServer().answerMonarch(action, accept);</span>
<span class="nc" id="L3898">			break;</span>
		default:
			break;
		}
<span class="nc bnc" id="L3902" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3903">			updateGUI(null);</span>
		}
<span class="nc" id="L3905">		return ret;</span>
	}

	/**
	 * Do a monarch interaction.
	 *
	 * Called from IGIH.monarchAction.
	 *
	 * @param action
	 *            The &lt;code&gt;MonarchAction&lt;/code&gt; to perform.
	 * @param template
	 *            A &lt;code&gt;StringTemplate&lt;/code&gt; describing the action.
	 * @param monarchKey
	 *            A key for the monarch involved.
	 */
	public void monarch(MonarchAction action, StringTemplate template, String monarchKey) {
<span class="nc" id="L3921">		gui.showMonarchDialog(action, template, monarchKey, (Boolean b) -&gt; monarchAction(action, b));</span>
<span class="nc" id="L3922">	}</span>

	/**
	 * Moves the specified unit somewhere that requires crossing the high seas.
	 *
	 * Called from EuropePanel.DestinationPanel, TilePopup
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to be moved.
	 * @param destination
	 *            The &lt;code&gt;Location&lt;/code&gt; to be moved to.
	 * @return True if the unit can possibly move further.
	 */
	public boolean moveTo(Unit unit, Location destination) {
<span class="nc bnc" id="L3936" title="All 6 branches missed.">		if (!requireOurTurn() || unit == null || destination == null)</span>
<span class="nc" id="L3937">			return false;</span>

		// Sanity check current state.
<span class="nc bnc" id="L3940" title="All 2 branches missed.">		if (destination instanceof Europe) {</span>
<span class="nc bnc" id="L3941" title="All 2 branches missed.">			if (unit.isInEurope()) {</span>
<span class="nc" id="L3942">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L3943">				return false;</span>
			}
<span class="nc bnc" id="L3945" title="All 2 branches missed.">		} else if (destination instanceof Map) {</span>
<span class="nc bnc" id="L3946" title="All 4 branches missed.">			if (unit.hasTile() &amp;&amp; unit.getTile().getMap() == destination) {</span>
<span class="nc" id="L3947">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L3948">				return false;</span>
			}
<span class="nc bnc" id="L3950" title="All 2 branches missed.">		} else if (destination instanceof Settlement) {</span>
<span class="nc bnc" id="L3951" title="All 2 branches missed.">			if (unit.hasTile()) {</span>
<span class="nc" id="L3952">				sound(&quot;sound.event.illegalMove&quot;);</span>
<span class="nc" id="L3953">				return false;</span>
			}
		} else {
<span class="nc" id="L3956">			return false;</span>
		}

		// Autoload?
<span class="nc" id="L3960">		boolean update = false;</span>
<span class="nc bnc" id="L3961" title="All 4 branches missed.">		if (freeColClient.getClientOptions().getBoolean(ClientOptions.AUTOLOAD_EMIGRANTS) &amp;&amp; unit.isInEurope()) {</span>
<span class="nc bnc" id="L3962" title="All 2 branches missed.">			for (Unit u : unit.getOwner().getEurope().getUnitList()) {</span>
<span class="nc bnc" id="L3963" title="All 6 branches missed.">				if (!u.isNaval() &amp;&amp; u.getState() == UnitState.SENTRY &amp;&amp; unit.canAdd(u)) {</span>
<span class="nc bnc" id="L3964" title="All 2 branches missed.">					if (askEmbark(u, unit))</span>
<span class="nc" id="L3965">						update = true;</span>
				}
<span class="nc" id="L3967">			}</span>
		}

<span class="nc" id="L3970">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L3971">		boolean ret = askServer().moveTo(unit, destination);</span>
<span class="nc bnc" id="L3972" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L3973">			unitWas.fireChanges();</span>
<span class="nc" id="L3974">			update = true;</span>
		}
<span class="nc bnc" id="L3976" title="All 2 branches missed.">		if (update)</span>
<span class="nc" id="L3977">			updateGUI(null);</span>
<span class="nc" id="L3978">		return ret;</span>
	}

	/**
	 * Moves the active unit in a specified direction. This may result in an
	 * attack, move... action.
	 *
	 * Called from MoveAction, CornerMapControls
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to move.
	 * @param direction
	 *            The &lt;code&gt;Direction&lt;/code&gt; in which to move the active unit.
	 * @return True if the unit may move further.
	 */
	public boolean moveUnit(Unit unit, Direction direction) {
<span class="nc bnc" id="L3994" title="All 8 branches missed.">		if (!requireOurTurn() || unit == null || direction == null || !unit.hasTile())</span>
<span class="nc" id="L3995">			return false;</span>

<span class="nc bnc" id="L3997" title="All 2 branches missed.">		if (!askClearGotoOrders(unit))</span>
<span class="nc" id="L3998">			return false;</span>

<span class="nc" id="L4000">		final int unitCount = unit.getUnitCount(), goodsCount = unit.getGoodsList().size();</span>
<span class="nc" id="L4001">		final Tile oldTile = unit.getTile();</span>
<span class="nc" id="L4002">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L4003" title="All 2 branches missed.">		ColonyWas colonyWas = (unit.getColony() == null) ? null : new ColonyWas(unit.getColony());</span>
<span class="nc" id="L4004">		unit.setState(UnitState.ACTIVE);</span>
<span class="nc" id="L4005">		moveDirection(unit, direction, true);</span>
<span class="nc bnc" id="L4006" title="All 4 branches missed.">		boolean ret = unit.getTile() != oldTile || unitWas.fireChanges();</span>
<span class="nc bnc" id="L4007" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L4008" title="All 2 branches missed.">			if (colonyWas != null)</span>
<span class="nc" id="L4009">				colonyWas.fireChanges();</span>
<span class="nc" id="L4010">			updateGUI(null);</span>
<span class="nc bnc" id="L4011" title="All 4 branches missed.">			if (!unit.couldMove() &amp;&amp; unit.hasTile()) {</span>
				// Show colony panel if unit out of moves
<span class="nc" id="L4013">				Colony colony = unit.getTile().getColony();</span>
<span class="nc bnc" id="L4014" title="All 2 branches missed.">				if (colony != null)</span>
<span class="nc" id="L4015">					colonyPanel(colony, unit);</span>
			}
		}
<span class="nc" id="L4018">		return ret;</span>
	}

	/**
	 * Move the tile cursor.
	 *
	 * Called from MoveAction in terrain mode.
	 *
	 * @param direction
	 *            The &lt;code&gt;Direction&lt;/code&gt; to move the tile cursor.
	 * @return True if the tile cursor is moved.
	 */
	public boolean moveTileCursor(Direction direction) {
<span class="nc bnc" id="L4031" title="All 2 branches missed.">		if (direction == null)</span>
<span class="nc" id="L4032">			return false;</span>

<span class="nc" id="L4034">		final Tile tile = gui.getSelectedTile();</span>
<span class="nc bnc" id="L4035" title="All 2 branches missed.">		if (tile == null)</span>
<span class="nc" id="L4036">			return false;</span>

<span class="nc" id="L4038">		final Tile newTile = tile.getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L4039" title="All 2 branches missed.">		if (newTile == null)</span>
<span class="nc" id="L4040">			return false;</span>

<span class="nc" id="L4042">		gui.setSelectedTile(newTile);</span>
<span class="nc" id="L4043">		return true;</span>
	}

	/**
	 * A player names the New World.
	 *
	 * Called from GUI.showNameNewLandDialog
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that landed.
	 * @param name
	 *            The name to use.
	 * @return True if the new land was named.
	 */
	public boolean nameNewLand(Unit unit, String name) {
<span class="nc bnc" id="L4058" title="All 4 branches missed.">		if (unit == null || name == null)</span>
<span class="nc" id="L4059">			return false;</span>

		// Respond to the server.
<span class="nc bnc" id="L4062" title="All 2 branches missed.">		if (!askServer().newLandName(unit, name))</span>
<span class="nc" id="L4063">			return false;</span>

		// The name is set, bring up the first landing panel.
<span class="nc" id="L4066">		final Player player = unit.getOwner();</span>
<span class="nc" id="L4067">		StringTemplate t = StringTemplate.template(&quot;event.firstLanding&quot;).addName(&quot;%name%&quot;, name);</span>
<span class="nc" id="L4068">		gui.showEventPanel(Messages.message(t), &quot;image.flavor.event.firstLanding&quot;, null);</span>

		// Add tutorial message.
<span class="nc" id="L4071">		final String key = FreeColActionUI.getHumanKeyStrokeText(</span>
<span class="nc" id="L4072">				freeColClient.getActionManager().getFreeColAction(&quot;buildColonyAction&quot;).getAccelerator());</span>
<span class="nc" id="L4073">		player.addModelMessage(new ModelMessage(ModelMessage.MessageType.TUTORIAL, &quot;buildColony.tutorial&quot;, player)</span>
<span class="nc" id="L4074">				.addName(&quot;%colonyKey%&quot;, key).add(&quot;%colonyMenuItem%&quot;, &quot;buildColonyAction.name&quot;)</span>
<span class="nc" id="L4075">				.add(&quot;%ordersMenuItem%&quot;, &quot;menuBar.orders&quot;));</span>
<span class="nc" id="L4076">		displayModelMessages(false);</span>
<span class="nc" id="L4077">		return true;</span>
	}

	/**
	 * The player names a new region.
	 *
	 * Called from newRegionName, GUI.showNameNewRegionDialog
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; within the region.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that has discovered the region.
	 * @param region
	 *            The &lt;code&gt;Region&lt;/code&gt; to name.
	 * @param name
	 *            The name to offer.
	 * @return True if the new region was named.
	 */
	public boolean nameNewRegion(final Tile tile, final Unit unit, final Region region, final String name) {
<span class="nc bnc" id="L4096" title="All 6 branches missed.">		if (tile == null || unit == null || region == null)</span>
<span class="nc" id="L4097">			return false;</span>

<span class="nc" id="L4099">		return askServer().newRegionName(region, tile, unit, name);</span>
	}

	/**
	 * Ask the player to name the new land.
	 *
	 * Called from IGIH.newLandName.
	 *
	 * @param defaultName
	 *            The default name to use.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that has landed.
	 */
	public void newLandName(String defaultName, Unit unit) {
<span class="nc" id="L4113">		gui.showNamingDialog(StringTemplate.key(&quot;newLand.text&quot;), defaultName, unit, (String name) -&gt; {</span>
<span class="nc bnc" id="L4114" title="All 4 branches missed.">			if (name == null || name.isEmpty())</span>
<span class="nc" id="L4115">				name = defaultName;</span>
<span class="nc" id="L4116">			nameNewLand(unit, name);</span>
<span class="nc" id="L4117">		});</span>
<span class="nc" id="L4118">	}</span>

	/**
	 * Ask the player to name a new region.
	 *
	 * Called from IGIH.newRegionName.
	 *
	 * @param region
	 *            The &lt;code&gt;Region&lt;/code&gt; to name.
	 * @param defaultName
	 *            The default name to use.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; the unit landed at.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that has landed.
	 */
	public void newRegionName(Region region, String defaultName, Tile tile, Unit unit) {
<span class="nc bnc" id="L4135" title="All 2 branches missed.">		if (region.hasName()) {</span>
<span class="nc bnc" id="L4136" title="All 2 branches missed.">			if (region.isPacific()) {</span>
<span class="nc" id="L4137">				gui.showEventPanel(Messages.message(&quot;event.discoverPacific&quot;), &quot;image.flavor.event.discoverPacific&quot;,</span>
						null);
			}
<span class="nc" id="L4140">			nameNewRegion(tile, unit, region, defaultName);</span>
		} else {
<span class="nc" id="L4142">			gui.showNamingDialog(</span>
<span class="nc" id="L4143">					StringTemplate.template(&quot;nameRegion.text&quot;).addStringTemplate(&quot;%type%&quot;, region.getLabel()),</span>
					defaultName, unit, (String name) -&gt; {
<span class="nc bnc" id="L4145" title="All 4 branches missed.">						if (name == null || name.isEmpty())</span>
<span class="nc" id="L4146">							name = defaultName;</span>
<span class="nc" id="L4147">						nameNewRegion(tile, unit, region, name);</span>
<span class="nc" id="L4148">					});</span>
		}
<span class="nc" id="L4150">	}</span>

	/**
	 * Switch to a new turn.
	 *
	 * Called from IGIH.newTurn
	 *
	 * @param turn
	 *            The turn number.
	 * @return True if the new turn occurs.
	 */
	public boolean newTurn(int turn) {
<span class="nc" id="L4162">		final Game game = freeColClient.getGame();</span>
<span class="nc" id="L4163">		final Player player = freeColClient.getMyPlayer();</span>

<span class="nc bnc" id="L4165" title="All 2 branches missed.">		if (turn &lt; 0) {</span>
<span class="nc" id="L4166">			logger.warning(&quot;Bad turn in newTurn: &quot; + turn);</span>
<span class="nc" id="L4167">			return false;</span>
		}
<span class="nc" id="L4169">		Turn newTurn = new Turn(turn);</span>
<span class="nc" id="L4170">		game.setTurn(newTurn);</span>
<span class="nc" id="L4171">		logger.info(&quot;New turn: &quot; + newTurn + &quot;/&quot; + turn);</span>

<span class="nc" id="L4173">		final boolean alert = freeColClient.getClientOptions().getBoolean(ClientOptions.AUDIO_ALERTS);</span>
<span class="nc bnc" id="L4174" title="All 2 branches missed.">		if (alert)</span>
<span class="nc" id="L4175">			sound(&quot;sound.event.alertSound&quot;);</span>

<span class="nc" id="L4177">		final Turn currTurn = game.getTurn();</span>
<span class="nc bnc" id="L4178" title="All 2 branches missed.">		if (currTurn.isFirstSeasonTurn()) {</span>
<span class="nc" id="L4179">			player.addModelMessage(new ModelMessage(MessageType.WARNING, &quot;twoTurnsPerYear&quot;, player)</span>
<span class="nc" id="L4180">					.addStringTemplate(&quot;%year%&quot;, currTurn.getLabel())</span>
<span class="nc" id="L4181">					.addAmount(&quot;%amount%&quot;, currTurn.getSeasonNumber()));</span>
		}
<span class="nc" id="L4183">		return true;</span>
	}

	/**
	 * Makes a new unit active.
	 *
	 * Called from PGC.startGame, ColonyPanel.closeColonyPanel
	 *
	 * @return True unless it was not our turn.
	 */
	public boolean nextActiveUnit() {
<span class="nc bnc" id="L4194" title="All 2 branches missed.">		if (!requireOurTurn())</span>
<span class="nc" id="L4195">			return false;</span>

<span class="nc" id="L4197">		updateGUI(null);</span>
<span class="nc" id="L4198">		return true;</span>
	}

	/**
	 * Displays the next &lt;code&gt;ModelMessage&lt;/code&gt;.
	 *
	 * Called from CC.reconnect, CargoPanel, ColonyPanel.closeColonyPanel,
	 * EuropePanel.exitAction, EuropePanel.MarketPanel
	 *
	 * @return True if any messages were displayed.
	 */
	public boolean nextModelMessage() {
<span class="nc" id="L4210">		return displayModelMessages(false, false);</span>
	}

	/**
	 * Pays the tax arrears on this type of goods.
	 *
	 * Called from CargoPanel, EuropePanel.MarketPanel,
	 * EuropePanel.unloadAction, QuickActionMenu
	 *
	 * @param type
	 *            The type of goods for which to pay arrears.
	 * @return True if the arrears were paid.
	 */
	public boolean payArrears(GoodsType type) {
<span class="nc bnc" id="L4224" title="All 4 branches missed.">		if (!requireOurTurn() || type == null)</span>
<span class="nc" id="L4225">			return false;</span>

<span class="nc" id="L4227">		Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L4228">		int arrears = player.getArrears(type);</span>
<span class="nc bnc" id="L4229" title="All 2 branches missed.">		if (arrears &lt;= 0)</span>
<span class="nc" id="L4230">			return false;</span>
<span class="nc bnc" id="L4231" title="All 2 branches missed.">		if (!player.checkGold(arrears)) {</span>
<span class="nc" id="L4232">			gui.showInformationMessage(StringTemplate.template(&quot;payArrears.noGold&quot;).addAmount(&quot;%amount%&quot;, arrears));</span>
<span class="nc" id="L4233">			return false;</span>
		}

<span class="nc" id="L4236">		StringTemplate t = StringTemplate.template(&quot;payArrears.text&quot;).addAmount(&quot;%amount%&quot;, arrears);</span>
<span class="nc bnc" id="L4237" title="All 2 branches missed.">		if (!gui.confirm(null, t, type, &quot;ok&quot;, &quot;cancel&quot;))</span>
<span class="nc" id="L4238">			return false;</span>

<span class="nc bnc" id="L4240" title="All 4 branches missed.">		boolean ret = askServer().payArrears(type) &amp;&amp; player.canTrade(type);</span>
<span class="nc bnc" id="L4241" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L4242">			updateGUI(null);</span>
		}
<span class="nc" id="L4244">		return ret;</span>
	}

	/**
	 * Buys the remaining hammers and tools for the {@link Building} currently
	 * being built in the given &lt;code&gt;Colony&lt;/code&gt;.
	 *
	 * Called from BuildQueuePanel
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; where the building should be bought.
	 * @return True if the building was bought.
	 */
	public boolean payForBuilding(Colony colony) {
<span class="nc bnc" id="L4258" title="All 4 branches missed.">		if (!requireOurTurn() || colony == null)</span>
<span class="nc" id="L4259">			return false;</span>

<span class="nc bnc" id="L4261" title="All 2 branches missed.">		if (!getSpecification().getBoolean(GameOptions.PAY_FOR_BUILDING)) {</span>
<span class="nc" id="L4262">			gui.showInformationMessage(&quot;payForBuilding.disabled&quot;);</span>
<span class="nc" id="L4263">			return false;</span>
		}

<span class="nc bnc" id="L4266" title="All 2 branches missed.">		if (!colony.canPayToFinishBuilding()) {</span>
<span class="nc" id="L4267">			gui.showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L4268">			return false;</span>
		}

<span class="nc" id="L4271">		final int price = colony.getPriceForBuilding();</span>
<span class="nc" id="L4272">		StringTemplate t = StringTemplate.template(&quot;payForBuilding.text&quot;).addAmount(&quot;%amount%&quot;, price);</span>
<span class="nc bnc" id="L4273" title="All 2 branches missed.">		if (!gui.confirm(null, t, colony, &quot;yes&quot;, &quot;no&quot;))</span>
<span class="nc" id="L4274">			return false;</span>

<span class="nc" id="L4276">		ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc bnc" id="L4277" title="All 4 branches missed.">		boolean ret = askServer().payForBuilding(colony) &amp;&amp; colony.getPriceForBuilding() == 0;</span>
<span class="nc bnc" id="L4278" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L4279">			colonyWas.fireChanges();</span>
<span class="nc" id="L4280">			updateGUI(null);</span>
		}
<span class="nc" id="L4282">		return ret;</span>
	}

	/**
	 * Puts the specified unit outside the colony.
	 *
	 * Called from ColonyPanel.OutsideColonyPanel, UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt;
	 * @return True if the unit was successfully put outside the colony.
	 */
	public boolean putOutsideColony(Unit unit) {
		Colony colony;
<span class="nc bnc" id="L4296" title="All 6 branches missed.">		if (!requireOurTurn() || unit == null || (colony = unit.getColony()) == null)</span>
<span class="nc" id="L4297">			return false;</span>

<span class="nc bnc" id="L4299" title="All 2 branches missed.">		if (!gui.confirmLeaveColony(unit))</span>
<span class="nc" id="L4300">			return false;</span>

<span class="nc" id="L4302">		ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc" id="L4303">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L4304" title="All 4 branches missed.">		boolean ret = askServer().putOutsideColony(unit) &amp;&amp; unit.getLocation() == colony.getTile();</span>
<span class="nc bnc" id="L4305" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L4306">			colonyWas.fireChanges();</span>
<span class="nc" id="L4307">			unitWas.fireChanges();</span>
<span class="nc" id="L4308">			updateGUI(null);</span>
		}
<span class="nc" id="L4310">		return ret;</span>
	}

	/**
	 * Query whether the user wants to reconnect?
	 *
	 * Called from ReconnectAction, IGIH.reconnectRunnable
	 *
	 * Returns no status, this game is going away.
	 */
	public void reconnect() {
<span class="nc bnc" id="L4321" title="All 2 branches missed.">		if (gui.confirm(&quot;reconnect.text&quot;, &quot;reconnect.no&quot;, &quot;reconnect.yes&quot;)) {</span>
<span class="nc" id="L4322">			logger.finest(&quot;Reconnect quit.&quot;);</span>
<span class="nc" id="L4323">			freeColClient.quit();</span>
		} else {
<span class="nc" id="L4325">			logger.finest(&quot;Reconnect accepted.&quot;);</span>
<span class="nc" id="L4326">			freeColClient.getConnectController().reconnect();</span>
		}
<span class="nc" id="L4328">	}</span>

	/**
	 * Recruit a unit from a specified index in Europe.
	 *
	 * Called from RecruitPanel
	 *
	 * @param index
	 *            The index in Europe to recruit from, [0..RECRUIT_COUNT).
	 * @return True if a unit was recruited.
	 */
	public boolean recruitUnitInEurope(int index) {
<span class="nc bnc" id="L4340" title="All 4 branches missed.">		if (!requireOurTurn() || !MigrationType.validMigrantIndex(index))</span>
<span class="nc" id="L4341">			return false;</span>

<span class="nc" id="L4343">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L4344" title="All 2 branches missed.">		if (!player.isColonial())</span>
<span class="nc" id="L4345">			return false;</span>

<span class="nc bnc" id="L4347" title="All 2 branches missed.">		if (!player.checkGold(player.getRecruitPrice())) {</span>
<span class="nc" id="L4348">			gui.showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L4349">			return false;</span>
		}

<span class="nc" id="L4352">		Unit newUnit = askEmigrate(player.getEurope(), MigrationType.migrantIndexToSlot(index));</span>
<span class="nc bnc" id="L4353" title="All 2 branches missed.">		if (newUnit != null) {</span>
<span class="nc" id="L4354">			player.setNextActiveUnit(newUnit);</span>
<span class="nc" id="L4355">			gui.setActiveUnit(newUnit);</span>
<span class="nc" id="L4356">			updateGUI(null);</span>
		}
<span class="nc bnc" id="L4358" title="All 2 branches missed.">		return newUnit != null;</span>
	}

	/**
	 * Remove game objects.
	 * 
	 * Called from IGIH.remove().
	 *
	 * @param objects
	 *            A list of &lt;code&gt;FreeColGameObject&lt;/code&gt;s to remove.
	 * @param divert
	 *            the divert
	 */
	public void remove(List&lt;FreeColGameObject&gt; objects, FreeColGameObject divert) {
<span class="nc" id="L4372">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L4373">		boolean visibilityChange = false;</span>
<span class="nc bnc" id="L4374" title="All 2 branches missed.">		for (FreeColGameObject fcgo : objects) {</span>
<span class="nc bnc" id="L4375" title="All 2 branches missed.">			if (divert != null)</span>
<span class="nc" id="L4376">				player.divertModelMessages(fcgo, divert);</span>

<span class="nc bnc" id="L4378" title="All 2 branches missed.">			if (fcgo instanceof Settlement) {</span>
<span class="nc" id="L4379">				Settlement settlement = (Settlement) fcgo;</span>
<span class="nc bnc" id="L4380" title="All 4 branches missed.">				if (settlement != null &amp;&amp; settlement.getOwner() != null) {</span>
<span class="nc" id="L4381">					settlement.getOwner().removeSettlement(settlement);</span>
				}
<span class="nc" id="L4383">				visibilityChange = true;// -vis(player)</span>

<span class="nc bnc" id="L4385" title="All 2 branches missed.">			} else if (fcgo instanceof Unit) {</span>
				// Deselect the object if it is the current active unit.
<span class="nc" id="L4387">				Unit u = (Unit) fcgo;</span>
<span class="nc bnc" id="L4388" title="All 2 branches missed.">				if (u == gui.getActiveUnit())</span>
<span class="nc" id="L4389">					gui.setActiveUnit(null);</span>

				// Temporary hack until we have real containers.
<span class="nc bnc" id="L4392" title="All 4 branches missed.">				if (u != null &amp;&amp; u.getOwner() != null) {</span>
<span class="nc" id="L4393">					u.getOwner().removeUnit(u);</span>
				}
<span class="nc" id="L4395">				visibilityChange = true;// -vis(player)</span>
			}

			// Do just the low level dispose that removes
			// reference to this object in the client. The other
			// updates should have done the rest.
<span class="nc" id="L4401">			fcgo.disposeResources();</span>
<span class="nc" id="L4402">		}</span>
<span class="nc bnc" id="L4403" title="All 2 branches missed.">		if (visibilityChange)</span>
<span class="nc" id="L4404">			player.invalidateCanSeeTiles();// +vis(player)</span>

<span class="nc" id="L4406">		gui.refresh();</span>
<span class="nc" id="L4407">	}</span>

	/**
	 * Renames a &lt;code&gt;Nameable&lt;/code&gt;.
	 *
	 * Apparently this can be done while it is not your turn.
	 *
	 * Called from RenameAction, TilePopup.
	 *
	 * @param object
	 *            The object to rename.
	 * @return True if the object was renamed.
	 */
	public boolean rename(Nameable object) {
<span class="nc" id="L4421">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L4422" title="All 4 branches missed.">		if (!(object instanceof Ownable) || !player.owns((Ownable) object))</span>
<span class="nc" id="L4423">			return false;</span>

<span class="nc" id="L4425">		String name = null;</span>
<span class="nc bnc" id="L4426" title="All 2 branches missed.">		if (object instanceof Colony) {</span>
<span class="nc" id="L4427">			Colony colony = (Colony) object;</span>
<span class="nc" id="L4428">			name = gui.getInput(colony.getTile(), StringTemplate.key(&quot;renameColony.text&quot;), colony.getName(), &quot;rename&quot;,</span>
					&quot;cancel&quot;);
<span class="nc bnc" id="L4430" title="All 2 branches missed.">			if (name == null) { // User cancelled</span>
<span class="nc" id="L4431">				return false;</span>
<span class="nc bnc" id="L4432" title="All 2 branches missed.">			} else if (name.isEmpty()) { // Zero length invalid</span>
<span class="nc" id="L4433">				gui.showInformationMessage(&quot;info.enterSomeText&quot;);</span>
<span class="nc" id="L4434">				return false;</span>
<span class="nc bnc" id="L4435" title="All 2 branches missed.">			} else if (colony.getName().equals(name)) { // No change</span>
<span class="nc" id="L4436">				return false;</span>
<span class="nc bnc" id="L4437" title="All 2 branches missed.">			} else if (player.getSettlementByName(name) != null) {</span>
				// Colony name must be unique.
<span class="nc" id="L4439">				gui.showInformationMessage((Colony) object,</span>
<span class="nc" id="L4440">						StringTemplate.template(&quot;nameColony.notUnique&quot;).addName(&quot;%name%&quot;, name));</span>
<span class="nc" id="L4441">				return false;</span>
			}
<span class="nc bnc" id="L4443" title="All 2 branches missed.">		} else if (object instanceof Unit) {</span>
<span class="nc" id="L4444">			Unit unit = (Unit) object;</span>
<span class="nc" id="L4445">			name = gui.getInput(unit.getTile(), StringTemplate.key(&quot;renameUnit.text&quot;), unit.getName(), &quot;rename&quot;,</span>
					&quot;cancel&quot;);
<span class="nc bnc" id="L4447" title="All 2 branches missed.">			if (name == null)</span>
<span class="nc" id="L4448">				return false; // User cancelled</span>
<span class="nc" id="L4449">		} else {</span>
<span class="nc" id="L4450">			logger.warning(&quot;Tried to rename an unsupported Nameable: &quot; + object);</span>
<span class="nc" id="L4451">			return false;</span>
		}

<span class="nc" id="L4454">		return askServer().rename((FreeColGameObject) object, name);</span>
	}

	/**
	 * Opens a dialog where the user should specify the filename and saves the
	 * game.
	 *
	 * Called from SaveAction and SaveAndQuitAction.
	 *
	 * @return True if the game was saved.
	 */
	public boolean saveGame() {
<span class="nc bnc" id="L4466" title="All 2 branches missed.">		if (!freeColClient.canSaveCurrentGame())</span>
<span class="nc" id="L4467">			return false;</span>

<span class="nc" id="L4469">		final Game game = freeColClient.getGame();</span>
<span class="nc bnc" id="L4470" title="All 2 branches missed.">		if (game == null)</span>
<span class="nc" id="L4471">			return false; // Keyboard handling can race init</span>
<span class="nc" id="L4472">		String fileName = getSaveGameString(game);</span>
<span class="nc" id="L4473">		File file = gui.showSaveDialog(FreeColDirectories.getSaveDirectory(), fileName);</span>
<span class="nc bnc" id="L4474" title="All 2 branches missed.">		if (file == null)</span>
<span class="nc" id="L4475">			return false;</span>
<span class="nc" id="L4476">		final boolean confirm = freeColClient.getClientOptions().getBoolean(ClientOptions.CONFIRM_SAVE_OVERWRITE);</span>
<span class="nc bnc" id="L4477" title="All 6 branches missed.">		if (!confirm || !file.exists() || gui.confirm(&quot;saveConfirmationDialog.areYouSure.text&quot;, &quot;ok&quot;, &quot;cancel&quot;)) {</span>
<span class="nc" id="L4478">			FreeColDirectories.setSavegameFile(file.getPath());</span>
<span class="nc" id="L4479">			return saveGame(file);</span>
		}
<span class="nc" id="L4481">		return false;</span>
	}

	/**
	 * Selects a destination for this unit. Europe and the player's colonies are
	 * valid destinations.
	 *
	 * Called from GotoAction.
	 *
	 * @param unit
	 *            The unit for which to select a destination.
	 * @return True if the destination change succeeds.
	 */
	public boolean selectDestination(Unit unit) {
<span class="nc bnc" id="L4495" title="All 4 branches missed.">		if (!requireOurTurn() || unit == null)</span>
<span class="nc" id="L4496">			return false;</span>

<span class="nc bnc" id="L4498" title="All 2 branches missed.">		if (!gui.confirmClearTradeRoute(unit))</span>
<span class="nc" id="L4499">			return false;</span>
<span class="nc" id="L4500">		Location destination = gui.showSelectDestinationDialog(unit);</span>
<span class="nc bnc" id="L4501" title="All 2 branches missed.">		if (destination == null)</span>
<span class="nc" id="L4502">			return false;</span>

<span class="nc" id="L4504">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc" id="L4505">		boolean ret = askSetDestination(unit, destination);</span>
<span class="nc bnc" id="L4506" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L4507" title="All 2 branches missed.">			if (destination instanceof Europe) {</span>
<span class="nc bnc" id="L4508" title="All 4 branches missed.">				if (unit.hasTile() &amp;&amp; unit.getTile().isDirectlyHighSeasConnected()) {</span>
<span class="nc" id="L4509">					moveTo(unit, destination);</span>
				} else {
<span class="nc" id="L4511">					moveToDestination(unit, null);</span>
				}
			} else {
<span class="nc bnc" id="L4514" title="All 2 branches missed.">				if (unit.isInEurope()) {</span>
<span class="nc" id="L4515">					moveTo(unit, destination);</span>
				} else {
<span class="nc" id="L4517">					moveToDestination(unit, null);</span>
				}
			}
<span class="nc" id="L4520">			unitWas.fireChanges();</span>
<span class="nc" id="L4521">			updateGUI(null);</span>
		}
<span class="nc" id="L4523">		return ret;</span>
	}

	/**
	 * Sells goods in Europe.
	 *
	 * Called from EuropePanel.MarketPanel, EuropePanel.unloadAction, unload(),
	 * unloadCargo()
	 *
	 * @param goods
	 *            The goods to be sold.
	 * @return True if the sale succeeds.
	 */
	public boolean sellGoods(Goods goods) {
<span class="nc bnc" id="L4537" title="All 6 branches missed.">		if (!requireOurTurn() || goods == null || !(goods.getLocation() instanceof Unit))</span>
<span class="nc" id="L4538">			return false;</span>

<span class="nc" id="L4540">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L4541">		Unit carrier = (Unit) goods.getLocation();</span>

<span class="nc" id="L4543">		Europe europe = player.getEurope();</span>
<span class="nc" id="L4544">		EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L4545">		UnitWas unitWas = new UnitWas(carrier);</span>
<span class="nc" id="L4546">		boolean ret = askUnloadGoods(goods.getType(), goods.getAmount(), carrier);</span>
<span class="nc bnc" id="L4547" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L4548">			sound(&quot;sound.event.sellCargo&quot;);</span>
<span class="nc" id="L4549">			europeWas.fireChanges();</span>
<span class="nc" id="L4550">			unitWas.fireChanges();</span>
<span class="nc" id="L4551">			updateGUI(null);</span>
		}
<span class="nc" id="L4553">		return ret;</span>
	}

	/**
	 * Sends a public chat message.
	 *
	 * Called from ChatPanel
	 *
	 * @param chat
	 *            The text of the message.
	 * @return True if the message was sent.
	 */
	public boolean sendChat(String chat) {
<span class="nc bnc" id="L4566" title="All 2 branches missed.">		if (chat == null)</span>
<span class="nc" id="L4567">			return false;</span>

<span class="nc" id="L4569">		return askServer().chat(freeColClient.getMyPlayer(), chat);</span>
	}

	/**
	 * Changes the current construction project of a &lt;code&gt;Colony&lt;/code&gt;.
	 *
	 * Called from BuildQueuePanel
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt;
	 * @param buildQueue
	 *            List of &lt;code&gt;BuildableType&lt;/code&gt;
	 * @return True if the build queue was changed.
	 */
	public boolean setBuildQueue(Colony colony, List&lt;BuildableType&gt; buildQueue) {
<span class="nc bnc" id="L4584" title="All 6 branches missed.">		if (!requireOurTurn() || colony == null || buildQueue == null)</span>
<span class="nc" id="L4585">			return false;</span>

<span class="nc" id="L4587">		ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc" id="L4588">		boolean ret = askServer().setBuildQueue(colony, buildQueue);</span>
<span class="nc bnc" id="L4589" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L4590">			colonyWas.fireChanges();</span>
<span class="nc" id="L4591">			updateGUI(null);</span>
		}
<span class="nc" id="L4593">		return ret;</span>
	}

	/**
	 * Set a player to be the new current player.
	 *
	 * Called from IGIH.newTurn, IGIH.setCurrentPlayer, CC.login
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; to be the new current player.
	 * @return True if the current player changes.
	 */
	public boolean setCurrentPlayer(Player player) {
<span class="nc bnc" id="L4606" title="All 4 branches missed.">		if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS) &amp;&amp; freeColClient.currentPlayerIsMyPlayer()) {</span>
<span class="nc" id="L4607">			gui.closeMenus();</span>
		}
<span class="nc" id="L4609">		FreeColDebugger.finishDebugRun(freeColClient, false);</span>

<span class="nc" id="L4611">		final Game game = freeColClient.getGame();</span>
<span class="nc" id="L4612">		game.setCurrentPlayer(player);</span>

<span class="nc bnc" id="L4614" title="All 2 branches missed.">		if (freeColClient.getMyPlayer().equals(player)) {</span>
<span class="nc bnc" id="L4615" title="All 2 branches missed.">			if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.DESYNC)</span>
<span class="nc bnc" id="L4616" title="All 2 branches missed.">					&amp;&amp; DebugUtils.checkDesyncAction(freeColClient)) {</span>
<span class="nc" id="L4617">				freeColClient.getConnectController().reconnect();</span>
<span class="nc" id="L4618">				return false;</span>
			}

			// Save the game (if it isn't newly loaded)
<span class="nc bnc" id="L4622" title="All 4 branches missed.">			if (freeColClient.getFreeColServer() != null &amp;&amp; game.getTurn().getNumber() &gt; 0)</span>
<span class="nc" id="L4623">				autoSaveGame();</span>

			// Get turn report out quickly before more message display occurs.
<span class="nc" id="L4626">			player.removeDisplayedModelMessages();</span>
<span class="nc" id="L4627">			displayModelMessages(true, true);</span>

<span class="nc" id="L4629">			player.invalidateCanSeeTiles();</span>

			// Check for emigration.
<span class="nc" id="L4632">			Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L4633" title="All 2 branches missed.">			if (player.hasAbility(Ability.SELECT_RECRUIT)) {</span>
<span class="nc" id="L4634">				emigration(player, 0, false);</span>
			} else {
<span class="nc bnc" id="L4636" title="All 2 branches missed.">				while (player.checkEmigrate()) {</span>
<span class="nc" id="L4637">					askEmigrate(europe, Europe.MigrationType.getUnspecificSlot());</span>
				}
			}

			// Wake up human!
<span class="nc bnc" id="L4642" title="All 2 branches missed.">			if (!freeColClient.isSinglePlayer()) {</span>
<span class="nc" id="L4643">				sound(&quot;sound.anthem.&quot; + player.getNationId());</span>
			}

<span class="nc" id="L4646">			player.resetIterators();</span>
<span class="nc" id="L4647">			updateGUI(player.getFallbackTile());</span>
		}
<span class="nc" id="L4649">		return true;</span>
	}

	/**
	 * Set a player to be dead.
	 *
	 * Called from IGIH.setDead
	 *
	 * @param dead
	 *            The dead &lt;code&gt;Player&lt;/code&gt;.
	 * @return True if the player is marked as dead.
	 */
	public boolean setDead(Player dead) {
<span class="nc bnc" id="L4662" title="All 2 branches missed.">		if (dead == null)</span>
<span class="nc" id="L4663">			return false;</span>

<span class="nc" id="L4665">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L4666" title="All 2 branches missed.">		if (player == dead) {</span>
<span class="nc" id="L4667">			FreeColDebugger.finishDebugRun(freeColClient, true);</span>
<span class="nc bnc" id="L4668" title="All 2 branches missed.">			if (freeColClient.isSinglePlayer()) {</span>
<span class="nc bnc" id="L4669" title="All 2 branches missed.">				if (player.getPlayerType() == Player.PlayerType.RETIRED) {</span>
					; // Do nothing, retire routine will quit

<span class="nc bnc" id="L4672" title="All 2 branches missed.">				} else if (player.getPlayerType() != Player.PlayerType.UNDEAD</span>
<span class="nc bnc" id="L4673" title="All 2 branches missed.">						&amp;&amp; gui.confirm(&quot;defeatedSinglePlayer.text&quot;, &quot;defeatedSinglePlayer.yes&quot;, &quot;quit&quot;)) {</span>
<span class="nc" id="L4674">					freeColClient.askServer().enterRevengeMode();</span>
				} else {
<span class="nc" id="L4676">					freeColClient.quit();</span>
				}
			} else {
<span class="nc bnc" id="L4679" title="All 2 branches missed.">				if (!gui.confirm(&quot;defeated.text&quot;, &quot;defeated.yes&quot;, &quot;quit&quot;))</span>
<span class="nc" id="L4680">					freeColClient.quit();</span>
			}
		} else {
<span class="nc" id="L4683">			player.setStance(dead, null);</span>
		}
<span class="nc" id="L4685">		return true;</span>
	}

	/**
	 * Informs this controller that a game has been newly loaded.
	 *
	 * Called from ConnectController.startSavedGame
	 *
	 * No status returned to connect controller.
	 */
	public void setGameConnected() {
<span class="nc" id="L4696">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L4697" title="All 2 branches missed.">		if (player != null) {</span>
<span class="nc" id="L4698">			player.refilterModelMessages(freeColClient.getClientOptions());</span>
		}
<span class="nc" id="L4700">	}</span>

	/**
	 * Sets the export settings of the custom house.
	 *
	 * Called from WarehouseDialog
	 *
	 * @param colony
	 *            The colony with the custom house.
	 * @param goodsType
	 *            The goods for which to set the settings.
	 * @return True if the levels were set.
	 */
	public boolean setGoodsLevels(Colony colony, GoodsType goodsType) {
<span class="nc bnc" id="L4714" title="All 4 branches missed.">		if (colony == null || goodsType == null)</span>
<span class="nc" id="L4715">			return false;</span>

<span class="nc" id="L4717">		return askServer().setGoodsLevels(colony, colony.getExportData(goodsType));</span>
	}

	/**
	 * Sets the debug mode to include the extra menu commands.
	 *
	 * Called from DebugAction
	 *
	 * @return True, always succeeds.
	 */
	public boolean setInDebugMode() {
<span class="nc" id="L4728">		FreeColDebugger.enableDebugMode(FreeColDebugger.DebugMode.MENUS);</span>
<span class="nc" id="L4729">		updateGUI(null);</span>
<span class="nc" id="L4730">		return true;</span>
	}

	/**
	 * Notify the player that the stance between two players has changed.
	 *
	 * Called from IGIH.setStance
	 *
	 * @param stance
	 *            The changed &lt;code&gt;Stance&lt;/code&gt;.
	 * @param first
	 *            The first &lt;code&gt;Player&lt;/code&gt;.
	 * @param second
	 *            The second &lt;code&gt;Player&lt;/code&gt;.
	 * @return True if the stance change succeeds.
	 */
	public boolean setStance(Stance stance, Player first, Player second) {
<span class="nc bnc" id="L4747" title="All 6 branches missed.">		if (stance == null || first == null || second == null)</span>
<span class="nc" id="L4748">			return false;</span>

<span class="nc" id="L4750">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L4751">		Stance old = first.getStance(second);</span>
		try {
<span class="nc" id="L4753">			first.setStance(second, stance);</span>
<span class="nc" id="L4754">		} catch (IllegalStateException e) {</span>
<span class="nc" id="L4755">			logger.log(Level.WARNING, &quot;Illegal stance transition&quot;, e);</span>
<span class="nc" id="L4756">			return false;</span>
<span class="nc" id="L4757">		}</span>
<span class="nc bnc" id="L4758" title="All 4 branches missed.">		if (player == first &amp;&amp; old == Stance.UNCONTACTED) {</span>
<span class="nc" id="L4759">			sound(&quot;sound.event.meet.&quot; + second.getNationId());</span>
		}
<span class="nc" id="L4761">		return true;</span>
	}

	/**
	 * Sets the trade routes for this player
	 *
	 * Called from TradeRoutePanel.deleteTradeRoute
	 *
	 * @param routes
	 *            The trade routes to set.
	 * @return True if the trade routes were set.
	 */
	public boolean setTradeRoutes(List&lt;TradeRoute&gt; routes) {
<span class="nc bnc" id="L4774" title="All 2 branches missed.">		if (routes == null)</span>
<span class="nc" id="L4775">			return false;</span>

<span class="nc" id="L4777">		return askServer().setTradeRoutes(routes);</span>
	}

	/**
	 * Spy on a colony.
	 *
	 * Called from IGIH.spyResult.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to find the colony on.
	 * @param recover
	 *            A &lt;code&gt;Runnable&lt;/code&gt; to restore the normal player view of
	 *            the tile when the spying colony panel is closed.
	 */
	public void spyColony(Tile tile, Runnable recover) {
<span class="nc" id="L4792">		gui.showSpyColonyPanel(tile, recover);</span>
<span class="nc" id="L4793">	}</span>

	/**
	 * Trains a unit of a specified type in Europe.
	 *
	 * Called from NewUnitPanel
	 *
	 * @param unitType
	 *            The type of unit to be trained.
	 * @return True if a new unit was trained.
	 */
	public boolean trainUnitInEurope(UnitType unitType) {
<span class="nc bnc" id="L4805" title="All 4 branches missed.">		if (!requireOurTurn() || unitType == null)</span>
<span class="nc" id="L4806">			return false;</span>

<span class="nc" id="L4808">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L4809">		final Europe europe = player.getEurope();</span>
<span class="nc bnc" id="L4810" title="All 2 branches missed.">		if (!player.checkGold(europe.getUnitPrice(unitType))) {</span>
<span class="nc" id="L4811">			gui.showInformationMessage(&quot;info.notEnoughGold&quot;);</span>
<span class="nc" id="L4812">			return false;</span>
		}

<span class="nc" id="L4815">		EuropeWas europeWas = new EuropeWas(europe);</span>
<span class="nc" id="L4816">		Unit newUnit = null;</span>
<span class="nc bnc" id="L4817" title="All 4 branches missed.">		boolean ret = askServer().trainUnitInEurope(unitType) &amp;&amp; (newUnit = europeWas.getNewUnit()) != null;</span>
<span class="nc bnc" id="L4818" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L4819">			europeWas.fireChanges();</span>
<span class="nc" id="L4820">			player.setNextActiveUnit(newUnit);</span>
<span class="nc" id="L4821">			gui.setActiveUnit(newUnit);</span>
<span class="nc" id="L4822">			updateGUI(null);</span>
		}
<span class="nc" id="L4824">		return ret;</span>
	}

	/**
	 * Unload, including dumping cargo.
	 *
	 * Called from UnloadAction, UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is dumping.
	 * @return True if the unit unloaded.
	 */
	public boolean unload(Unit unit) {
<span class="nc bnc" id="L4837" title="All 6 branches missed.">		if (!requireOurTurn() || unit == null || !unit.isCarrier())</span>
<span class="nc" id="L4838">			return false;</span>

<span class="nc" id="L4840">		boolean ret = true;</span>
<span class="nc" id="L4841">		Colony colony = unit.getColony();</span>
<span class="nc bnc" id="L4842" title="All 2 branches missed.">		if (colony != null) { // In colony, unload units and goods.</span>
<span class="nc bnc" id="L4843" title="All 2 branches missed.">			for (Unit u : unit.getUnitList()) {</span>
<span class="nc bnc" id="L4844" title="All 4 branches missed.">				ret = leaveShip(u) &amp;&amp; ret;</span>
<span class="nc" id="L4845">			}</span>
<span class="nc bnc" id="L4846" title="All 2 branches missed.">			for (Goods goods : unit.getGoodsList()) {</span>
<span class="nc bnc" id="L4847" title="All 4 branches missed.">				ret = unloadCargo(goods, false) &amp;&amp; ret;</span>
<span class="nc" id="L4848">			}</span>
<span class="nc bnc" id="L4849" title="All 2 branches missed.">		} else if (unit.isInEurope()) { // In Europe, unload non-boycotted goods</span>
<span class="nc" id="L4850">			Player player = freeColClient.getMyPlayer();</span>
<span class="nc bnc" id="L4851" title="All 2 branches missed.">			for (Goods goods : unit.getCompactGoodsList()) {</span>
<span class="nc bnc" id="L4852" title="All 2 branches missed.">				if (player.canTrade(goods.getType())) {</span>
<span class="nc bnc" id="L4853" title="All 4 branches missed.">					ret = sellGoods(goods) &amp;&amp; ret;</span>
				}
<span class="nc" id="L4855">			}</span>
<span class="nc bnc" id="L4856" title="All 2 branches missed.">			if (unit.hasGoodsCargo()) { // Goods left here must be dumped.</span>
<span class="nc" id="L4857">				gui.showDumpCargoDialog(unit, (List&lt;Goods&gt; goodsList) -&gt; {</span>
<span class="nc bnc" id="L4858" title="All 2 branches missed.">					for (Goods g : goodsList)</span>
<span class="nc" id="L4859">						unloadCargo(g, true);</span>
<span class="nc" id="L4860">				});</span>
<span class="nc" id="L4861">				return false;</span>
			}
<span class="nc" id="L4863">		} else { // Dump goods, units dislike jumping overboard</span>
<span class="nc bnc" id="L4864" title="All 2 branches missed.">			for (Goods goods : unit.getGoodsList()) {</span>
<span class="nc bnc" id="L4865" title="All 4 branches missed.">				ret = unloadCargo(goods, false) &amp;&amp; ret;</span>
<span class="nc" id="L4866">			}</span>
		}
<span class="nc" id="L4868">		return ret;</span>
	}

	/**
	 * Unload cargo. If the unit carrying the cargo is not in a harbour, or if
	 * the given boolean is true, the goods will be dumped.
	 *
	 * Called from CargoPanel, ColonyPanel, EuropePanel.MarketPanel,
	 * GUI.showDumpCargoDialog, QuickActionMenu, unload()
	 *
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to unload.
	 * @param dump
	 *            If true, dump the goods.
	 * @return True if the unload succeeds.
	 */
	public boolean unloadCargo(Goods goods, boolean dump) {
<span class="nc bnc" id="L4885" title="All 8 branches missed.">		if (!requireOurTurn() || goods == null || goods.getAmount() &lt;= 0 || !(goods.getLocation() instanceof Unit))</span>
<span class="nc" id="L4886">			return false;</span>

		// Find the carrier
<span class="nc" id="L4889">		final Unit carrier = (Unit) goods.getLocation();</span>

		// Use Europe-specific routine if needed
<span class="nc bnc" id="L4892" title="All 2 branches missed.">		if (carrier.isInEurope())</span>
<span class="nc" id="L4893">			return sellGoods(goods);</span>

		// Check for a colony
<span class="nc" id="L4896">		final Colony colony = carrier.getColony();</span>

		// Unload
<span class="nc bnc" id="L4899" title="All 2 branches missed.">		ColonyWas colonyWas = (colony == null) ? null : new ColonyWas(colony);</span>
<span class="nc" id="L4900">		UnitWas unitWas = new UnitWas(carrier);</span>
<span class="nc" id="L4901">		boolean ret = askUnloadGoods(goods.getType(), goods.getAmount(), carrier);</span>
<span class="nc bnc" id="L4902" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc bnc" id="L4903" title="All 2 branches missed.">			if (!dump)</span>
<span class="nc" id="L4904">				sound(&quot;sound.event.unloadCargo&quot;);</span>
<span class="nc bnc" id="L4905" title="All 2 branches missed.">			if (colonyWas != null)</span>
<span class="nc" id="L4906">				colonyWas.fireChanges();</span>
<span class="nc" id="L4907">			unitWas.fireChanges();</span>
<span class="nc" id="L4908">			updateGUI(null);</span>
		}
<span class="nc" id="L4910">		return ret;</span>
	}

	/**
	 * Updates a trade route.
	 *
	 * Called from TradeRoutePanel(), TradeRoutePanel.newRoute
	 *
	 * @param route
	 *            The trade route to update.
	 * @return True if the trade route was updated.
	 */
	public boolean updateTradeRoute(TradeRoute route) {
<span class="nc bnc" id="L4923" title="All 2 branches missed.">		if (route == null)</span>
<span class="nc" id="L4924">			return false;</span>

<span class="nc" id="L4926">		return askServer().updateTradeRoute(route);</span>
	}

	/**
	 * The player has won, show the high scores and victory dialog.
	 *
	 * Called from IGIH.gameEnded.
	 *
	 * @param score
	 *            If &quot;true&quot;, a new high score was reached.
	 */
	public void victory(String score) {
<span class="nc" id="L4938">		displayHighScores(&quot;true&quot;.equalsIgnoreCase(score));</span>
<span class="nc" id="L4939">		gui.showVictoryDialog((Boolean result) -&gt; victory(result));</span>
<span class="nc" id="L4940">	}</span>

	/**
	 * The player has won!
	 *
	 * Called from GUI.showVictoryDialog
	 *
	 * @param quit
	 *            If true, leave this game and start a new one.
	 * @return True.
	 */
	public boolean victory(Boolean quit) {
<span class="nc bnc" id="L4952" title="All 2 branches missed.">		if (quit) {</span>
<span class="nc" id="L4953">			freeColClient.newGame(false);</span>
		} else {
<span class="nc" id="L4955">			askServer().continuePlaying();</span>
		}
<span class="nc" id="L4957">		return true;</span>
	}

	/**
	 * Tell a unit to wait.
	 *
	 * Called from WaitAction.
	 *
	 * @return True, this can not fail.
	 */
	public boolean waitUnit() {
<span class="nc bnc" id="L4968" title="All 2 branches missed.">		if (!requireOurTurn())</span>
<span class="nc" id="L4969">			return false;</span>

		// Defeat the normal check for whether the current unit can move.
<span class="nc" id="L4972">		gui.setActiveUnit(null);</span>
<span class="nc" id="L4973">		updateGUI(null);</span>
<span class="nc" id="L4974">		return true;</span>
	}

	/**
	 * Moves a &lt;code&gt;Unit&lt;/code&gt; to a &lt;code&gt;WorkLocation&lt;/code&gt;.
	 *
	 * Called from ColonyPanel.tryWork, UnitLabel
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt;.
	 * @param workLocation
	 *            The new &lt;code&gt;WorkLocation&lt;/code&gt;.
	 * @return True if the unit is now working at the new work location.
	 */
	public boolean work(Unit unit, WorkLocation workLocation) {
<span class="nc bnc" id="L4989" title="All 6 branches missed.">		if (!requireOurTurn() || unit == null || workLocation == null)</span>
<span class="nc" id="L4990">			return false;</span>

		StringTemplate template;
<span class="nc bnc" id="L4993" title="All 4 branches missed.">		if (unit.getStudent() != null &amp;&amp; !gui.confirmAbandonEducation(unit, false))</span>
<span class="nc" id="L4994">			return false;</span>

<span class="nc" id="L4996">		Colony colony = workLocation.getColony();</span>
<span class="nc bnc" id="L4997" title="All 2 branches missed.">		if (workLocation instanceof ColonyTile) {</span>
<span class="nc" id="L4998">			Tile tile = ((ColonyTile) workLocation).getWorkTile();</span>
<span class="nc bnc" id="L4999" title="All 2 branches missed.">			if (tile.hasLostCityRumour()) {</span>
<span class="nc" id="L5000">				gui.showInformationMessage(&quot;tileHasRumour&quot;);</span>
<span class="nc" id="L5001">				return false;</span>
			}
<span class="nc bnc" id="L5003" title="All 2 branches missed.">			if (!unit.getOwner().owns(tile)) {</span>
<span class="nc bnc" id="L5004" title="All 2 branches missed.">				if (!claimTile(tile, colony))</span>
<span class="nc" id="L5005">					return false;</span>
			}
		}

		// Try to change the work location.
<span class="nc" id="L5010">		ColonyWas colonyWas = new ColonyWas(colony);</span>
<span class="nc" id="L5011">		UnitWas unitWas = new UnitWas(unit);</span>
<span class="nc bnc" id="L5012" title="All 4 branches missed.">		boolean ret = askServer().work(unit, workLocation) &amp;&amp; unit.getLocation() == workLocation;</span>
<span class="nc bnc" id="L5013" title="All 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L5014">			colonyWas.fireChanges();</span>
<span class="nc" id="L5015">			unitWas.fireChanges();</span>
<span class="nc" id="L5016">			updateGUI(null);</span>
		}
<span class="nc" id="L5018">		return ret;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>