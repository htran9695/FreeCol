<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ColonyPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui.panel</a> &gt; <span class="el_source">ColonyPanel.java</span></div><h1>ColonyPanel.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui.panel;

import java.awt.Color;
import java.awt.Component;
import java.awt.Container;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GridLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.beans.PropertyChangeEvent;
import java.beans.PropertyChangeListener;
import java.util.Collections;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.swing.ComponentInputMap;
import javax.swing.ImageIcon;
import javax.swing.InputMap;
import javax.swing.JButton;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JMenuItem;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;
import javax.swing.JScrollPane;
import javax.swing.JToolTip;
import javax.swing.KeyStroke;
import javax.swing.ScrollPaneConstants;
import javax.swing.SwingUtilities;

import net.miginfocom.swing.MigLayout;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.gui.FontLibrary;
import net.sf.freecol.client.gui.GUI;
import net.sf.freecol.client.gui.ImageLibrary;
import net.sf.freecol.common.debug.DebugUtils;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.BuildableType;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.Colony.ColonyChangeEvent;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.NoClaimReason;
import net.sf.freecol.common.model.ProductionInfo;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitLocation.NoAddReason;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.WorkLocation;

/**
 * This is a panel for the Colony display. It shows the units that are working
 * in the colony, the buildings and much more.
 *
 * Beware that in debug mode, this might be a server-side version of the colony
 * which is why we need to call getColony().getSpecification() to get the spec
 * that corresponds to the good types in this colony.
 */
public final class ColonyPanel extends PortPanel implements ActionListener, PropertyChangeListener {

	/** The Constant logger. */
<span class="nc" id="L106">	private static final Logger logger = Logger.getLogger(ColonyPanel.class.getName());</span>

	/** The Constant OCCUPATION. */
	private static final int EXIT = 0, BUILDQUEUE = 1, UNLOAD = 2, WAREHOUSE = 4, FILL = 5, COLONY_UNITS = 6,
			SETGOODS = 7, OCCUPATION = 8;

	/** The height of the area in which autoscrolling should happen. */
	public static final int SCROLL_AREA_HEIGHT = 40;

	/** The speed of the scrolling. */
	public static final int SCROLL_SPEED = 40;

	/** The unload button. */
	// Buttons
<span class="nc" id="L120">	private JButton unloadButton = Utility.localizedButton(&quot;unload&quot;);</span>

	/** The fill button. */
<span class="nc" id="L123">	private JButton fillButton = Utility.localizedButton(&quot;load&quot;);</span>

	/** The warehouse button. */
<span class="nc" id="L126">	private JButton warehouseButton = Utility.localizedButton(&quot;colonyPanel.warehouse&quot;);</span>

	/** The build queue button. */
<span class="nc" id="L129">	private JButton buildQueueButton = Utility.localizedButton(&quot;colonyPanel.buildQueue&quot;);</span>

	/** The colony units button. */
<span class="nc" id="L132">	private JButton colonyUnitsButton = Utility.localizedButton(&quot;colonyPanel.colonyUnits&quot;);</span>

	/** The set goods button. */
	// Only present in debug mode
<span class="nc" id="L136">	private JButton setGoodsButton = null;</span>

	/** The trace work button. */
<span class="nc" id="L139">	private JButton traceWorkButton = null;</span>

	/** The &lt;code&gt;Colony&lt;/code&gt; this panel is displaying. */
<span class="nc" id="L142">	private Colony colony = null;</span>

	// inherit PortPanel.pressListener
	// inherit PortPanel.defaultTransferHandler
	// inherit PortPanel.selectedUnitLabel

	/** The release listener. */
<span class="nc" id="L149">	private MouseListener releaseListener = null;</span>

	/** The name box. */
	// Subparts
<span class="nc" id="L153">	private final JComboBox&lt;Colony&gt; nameBox = new JComboBox&lt;&gt;();</span>

	/** The net production panel. */
<span class="nc" id="L156">	private JPanel netProductionPanel = null;</span>

	/** The buildings scroll. */
<span class="nc" id="L159">	private JScrollPane buildingsScroll = null;</span>

	/** The buildings panel. */
<span class="nc" id="L162">	private BuildingsPanel buildingsPanel = null;</span>

	/** The cargo scroll. */
<span class="nc" id="L165">	private JScrollPane cargoScroll = null;</span>
	// inherit protected PortPanel.cargoPanel

	/** The construction panel. */
<span class="nc" id="L169">	private ConstructionPanel constructionPanel = null;</span>

	/** The in port scroll. */
<span class="nc" id="L172">	private JScrollPane inPortScroll = null;</span>
	// inherit protected PortPanel.inPortPanel

	/** The outside colony scroll. */
<span class="nc" id="L176">	private JScrollPane outsideColonyScroll = null;</span>

	/** The outside colony panel. */
<span class="nc" id="L179">	private OutsideColonyPanel outsideColonyPanel = null;</span>

	/** The population panel. */
<span class="nc" id="L182">	private PopulationPanel populationPanel = null;</span>

	/** The tiles scroll. */
<span class="nc" id="L185">	private JScrollPane tilesScroll = null;</span>

	/** The tiles panel. */
<span class="nc" id="L188">	private TilesPanel tilesPanel = null;</span>

	/** The warehouse scroll. */
<span class="nc" id="L191">	private JScrollPane warehouseScroll = null;</span>

	/** The warehouse panel. */
<span class="nc" id="L194">	private WarehousePanel warehousePanel = null;</span>

	/**
	 * The constructor for the panel.
	 *
	 * @param freeColClient
	 *            The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to display in this panel.
	 */
	public ColonyPanel(FreeColClient freeColClient, Colony colony) {
<span class="nc" id="L205">		super(freeColClient,</span>
				new MigLayout(&quot;fill, wrap 2, insets 2&quot;, &quot;[390!][fill]&quot;, &quot;[growprio 100,shrinkprio 10][]0[]0[]&quot;
						+ &quot;[growprio 150,shrinkprio 50]&quot; + &quot;[growprio 150,shrinkprio 50][]&quot;));

		// Do not just use colony.getOwner() == getMyPlayer() because
		// in debug mode we are in the *server* colony, and the equality
		// will fail.
<span class="nc" id="L212">		editable = colony.getOwner().getId().equals(getMyPlayer().getId());</span>

		// Only enable the set goods button in debug mode when not spying
<span class="nc bnc" id="L215" title="All 4 branches missed.">		if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS) &amp;&amp; editable) {</span>
<span class="nc" id="L216">			setGoodsButton = Utility.localizedButton(&quot;colonyPanel.setGoods&quot;);</span>
<span class="nc" id="L217">			traceWorkButton = Utility.localizedButton(&quot;colonyPanel.traceWork&quot;);</span>
		}

		// Use ESCAPE for closing the ColonyPanel:
<span class="nc" id="L221">		InputMap closeIM = new ComponentInputMap(okButton);</span>
<span class="nc" id="L222">		closeIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0, false), &quot;pressed&quot;);</span>
<span class="nc" id="L223">		closeIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_ESCAPE, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L224">		SwingUtilities.replaceUIInputMap(okButton, JComponent.WHEN_IN_FOCUSED_WINDOW, closeIM);</span>
<span class="nc" id="L225">		okButton.setText(Messages.message(&quot;close&quot;));</span>

<span class="nc" id="L227">		InputMap unloadIM = new ComponentInputMap(unloadButton);</span>
<span class="nc" id="L228">		unloadIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_U, 0, false), &quot;pressed&quot;);</span>
<span class="nc" id="L229">		unloadIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_U, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L230">		SwingUtilities.replaceUIInputMap(unloadButton, JComponent.WHEN_IN_FOCUSED_WINDOW, unloadIM);</span>
<span class="nc" id="L231">		unloadButton.setActionCommand(String.valueOf(UNLOAD));</span>

<span class="nc" id="L233">		InputMap fillIM = new ComponentInputMap(fillButton);</span>
<span class="nc" id="L234">		fillIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_L, 0, false), &quot;pressed&quot;);</span>
<span class="nc" id="L235">		fillIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_L, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L236">		SwingUtilities.replaceUIInputMap(fillButton, JComponent.WHEN_IN_FOCUSED_WINDOW, fillIM);</span>
<span class="nc" id="L237">		fillButton.setActionCommand(String.valueOf(FILL));</span>

<span class="nc" id="L239">		InputMap warehouseIM = new ComponentInputMap(warehouseButton);</span>
<span class="nc" id="L240">		warehouseIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_W, 0, false), &quot;pressed&quot;);</span>
<span class="nc" id="L241">		warehouseIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_W, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L242">		SwingUtilities.replaceUIInputMap(warehouseButton, JComponent.WHEN_IN_FOCUSED_WINDOW, warehouseIM);</span>
<span class="nc" id="L243">		warehouseButton.setActionCommand(String.valueOf(WAREHOUSE));</span>

<span class="nc" id="L245">		InputMap buildQueueIM = new ComponentInputMap(buildQueueButton);</span>
<span class="nc" id="L246">		buildQueueIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_B, 0, false), &quot;pressed&quot;);</span>
<span class="nc" id="L247">		buildQueueIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_B, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L248">		SwingUtilities.replaceUIInputMap(buildQueueButton, JComponent.WHEN_IN_FOCUSED_WINDOW, buildQueueIM);</span>
<span class="nc" id="L249">		buildQueueButton.setActionCommand(String.valueOf(BUILDQUEUE));</span>

<span class="nc" id="L251">		InputMap colonyUnitsIM = new ComponentInputMap(colonyUnitsButton);</span>
<span class="nc" id="L252">		colonyUnitsIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_C, 0, false), &quot;pressed&quot;);</span>
<span class="nc" id="L253">		colonyUnitsIM.put(KeyStroke.getKeyStroke(KeyEvent.VK_C, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L254">		SwingUtilities.replaceUIInputMap(colonyUnitsButton, JComponent.WHEN_IN_FOCUSED_WINDOW, colonyUnitsIM);</span>
<span class="nc" id="L255">		colonyUnitsButton.setActionCommand(String.valueOf(COLONY_UNITS));</span>

<span class="nc bnc" id="L257" title="All 2 branches missed.">		if (setGoodsButton != null) {</span>
<span class="nc" id="L258">			setGoodsButton.setActionCommand(String.valueOf(SETGOODS));</span>
		}
<span class="nc bnc" id="L260" title="All 2 branches missed.">		if (traceWorkButton != null) {</span>
<span class="nc" id="L261">			traceWorkButton.setActionCommand(String.valueOf(OCCUPATION));</span>
		}

<span class="nc" id="L264">		defaultTransferHandler = new DefaultTransferHandler(freeColClient, this);</span>
<span class="nc" id="L265">		pressListener = new DragListener(freeColClient, this);</span>
<span class="nc" id="L266">		releaseListener = new DropListener();</span>
<span class="nc" id="L267">		selectedUnitLabel = null;</span>

		// Make the colony label
<span class="nc" id="L270">		Font nameBoxFont = FontLibrary.createFont(FontLibrary.FontType.HEADER, FontLibrary.FontSize.SMALL,</span>
<span class="nc" id="L271">				getImageLibrary().getScaleFactor());</span>
<span class="nc" id="L272">		boolean incompatibleFont = false;</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">		if (editable) {</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">			for (Colony c : freeColClient.getMySortedColonies()) {</span>
<span class="nc" id="L275">				this.nameBox.addItem(c);</span>
<span class="nc bnc" id="L276" title="All 4 branches missed.">				if (!incompatibleFont &amp;&amp; nameBoxFont.canDisplayUpTo(c.getName()) != -1) {</span>
<span class="nc" id="L277">					incompatibleFont = true;</span>
				}
<span class="nc" id="L279">			}</span>
		} else { // When spying, only add the given colony.
<span class="nc" id="L281">			this.nameBox.addItem(colony);</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">			if (nameBoxFont.canDisplayUpTo(colony.getName()) != -1)</span>
<span class="nc" id="L283">				incompatibleFont = true;</span>
		}
<span class="nc bnc" id="L285" title="All 2 branches missed.">		if (incompatibleFont) {</span>
<span class="nc" id="L286">			nameBoxFont = FontLibrary.createFont(FontLibrary.FontType.NORMAL, FontLibrary.FontSize.SMALL,</span>
<span class="nc" id="L287">					getImageLibrary().getScaleFactor());</span>
		}
<span class="nc" id="L289">		this.nameBox.setFont(nameBoxFont);</span>
<span class="nc" id="L290">		this.nameBox.setSelectedItem(colony);</span>
<span class="nc" id="L291">		this.nameBox.getInputMap().put(KeyStroke.getKeyStroke(&quot;LEFT&quot;), &quot;selectPrevious2&quot;);</span>
<span class="nc" id="L292">		this.nameBox.getInputMap().put(KeyStroke.getKeyStroke(&quot;RIGHT&quot;), &quot;selectNext2&quot;);</span>

<span class="nc" id="L294">		netProductionPanel = new JPanel();</span>
<span class="nc" id="L295">		netProductionPanel.setOpaque(false);</span>

<span class="nc" id="L297">		buildingsPanel = new BuildingsPanel();</span>
<span class="nc" id="L298">		buildingsScroll = new JScrollPane(buildingsPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L300">		buildingsScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L301">		buildingsScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L302">		buildingsPanel.setOpaque(false);</span>
<span class="nc" id="L303">		buildingsScroll.setBorder(Utility.ETCHED_BORDER);</span>

<span class="nc" id="L305">		cargoPanel = new ColonyCargoPanel(freeColClient);</span>
<span class="nc" id="L306">		cargoScroll = new JScrollPane(cargoPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L308">		cargoScroll.setBorder(Utility.ETCHED_BORDER);</span>

<span class="nc" id="L310">		constructionPanel = new ConstructionPanel(freeColClient, colony, true);</span>

<span class="nc" id="L312">		inPortPanel = new ColonyInPortPanel();</span>
<span class="nc" id="L313">		inPortScroll = new JScrollPane(inPortPanel);</span>
<span class="nc" id="L314">		inPortScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L315">		inPortScroll.setBorder(Utility.ETCHED_BORDER);</span>

<span class="nc" id="L317">		outsideColonyPanel = new OutsideColonyPanel();</span>
<span class="nc" id="L318">		outsideColonyScroll = new JScrollPane(outsideColonyPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
<span class="nc" id="L320">		outsideColonyScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L321">		outsideColonyScroll.setBorder(Utility.ETCHED_BORDER);</span>

<span class="nc" id="L323">		populationPanel = new PopulationPanel();</span>

<span class="nc" id="L325">		tilesPanel = new TilesPanel();</span>
<span class="nc" id="L326">		tilesScroll = new JScrollPane(tilesPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L328">		tilesScroll.setBorder(Utility.BEVEL_BORDER);</span>

<span class="nc" id="L330">		warehousePanel = new WarehousePanel();</span>
<span class="nc" id="L331">		warehouseScroll = new JScrollPane(warehousePanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L333">		warehouseScroll.setBorder(Utility.ETCHED_BORDER);</span>

<span class="nc" id="L335">		InputMap nameIM = new ComponentInputMap(this.nameBox);</span>
<span class="nc" id="L336">		nameIM.put(KeyStroke.getKeyStroke(&quot;LEFT&quot;), &quot;selectPrevious2&quot;);</span>
<span class="nc" id="L337">		nameIM.put(KeyStroke.getKeyStroke(&quot;RIGHT&quot;), &quot;selectNext2&quot;);</span>
<span class="nc" id="L338">		SwingUtilities.replaceUIInputMap(this.nameBox, JComponent.WHEN_IN_FOCUSED_WINDOW, nameIM);</span>

<span class="nc" id="L340">		initialize(colony);</span>
<span class="nc" id="L341">		float scale = getImageLibrary().getScaleFactor();</span>
<span class="nc" id="L342">		getGUI().restoreSavedSize(this, 200 + (int) (scale * 850), 200 + (int) (scale * 525));</span>
<span class="nc" id="L343">	}</span>

	/**
	 * Set the current colony.
	 *
	 * @param colony
	 *            The new colony value.
	 */
	private synchronized void setColony(Colony colony) {
<span class="nc" id="L352">		this.colony = colony;</span>
<span class="nc" id="L353">	}</span>

	/**
	 * Initialize the entire panel.
	 *
	 * We can arrive here normally when a colony panel is created, or when an
	 * existing colony panel is changed via the colony name menu in the nameBox.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to be displayed.
	 */
	private void initialize(Colony colony) {
<span class="nc" id="L365">		cleanup();</span>

<span class="nc" id="L367">		setColony(colony);</span>

<span class="nc" id="L369">		addPropertyChangeListeners();</span>
<span class="nc" id="L370">		addMouseListeners();</span>
<span class="nc" id="L371">		setTransferHandlers(isEditable());</span>

		// Enable/disable widgets
<span class="nc" id="L374">		unloadButton.addActionListener(this);</span>
<span class="nc" id="L375">		fillButton.addActionListener(this);</span>
<span class="nc" id="L376">		warehouseButton.addActionListener(this);</span>
<span class="nc" id="L377">		buildQueueButton.addActionListener(this);</span>
<span class="nc" id="L378">		colonyUnitsButton.addActionListener(this);</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">		if (setGoodsButton != null) {</span>
<span class="nc" id="L380">			setGoodsButton.addActionListener(this);</span>
		}
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (traceWorkButton != null) {</span>
<span class="nc" id="L383">			traceWorkButton.addActionListener(this);</span>
		}

<span class="nc" id="L386">		unloadButton.setEnabled(isEditable());</span>
<span class="nc" id="L387">		fillButton.setEnabled(isEditable());</span>
<span class="nc" id="L388">		warehouseButton.setEnabled(isEditable());</span>
<span class="nc" id="L389">		buildQueueButton.setEnabled(isEditable());</span>
<span class="nc" id="L390">		colonyUnitsButton.setEnabled(isEditable());</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">		if (setGoodsButton != null) {</span>
<span class="nc" id="L392">			setGoodsButton.setEnabled(isEditable());</span>
		}
<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (traceWorkButton != null) {</span>
<span class="nc" id="L395">			traceWorkButton.setEnabled(isEditable());</span>
		}

<span class="nc" id="L398">		final GUI gui = getGUI();</span>
<span class="nc" id="L399">		this.nameBox.setEnabled(isEditable());</span>
<span class="nc" id="L400">		this.nameBox.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L401">			final Colony newColony = (Colony) nameBox.getSelectedItem();</span>
<span class="nc" id="L402">			closeColonyPanel();</span>
<span class="nc" id="L403">			gui.showColonyPanel(newColony, null);</span>
<span class="nc" id="L404">		});</span>
<span class="nc" id="L405">		updateNetProductionPanel();</span>

<span class="nc" id="L407">		buildingsPanel.initialize();</span>
<span class="nc" id="L408">		cargoPanel.initialize();</span>
<span class="nc" id="L409">		constructionPanel.initialize();</span>
<span class="nc" id="L410">		inPortPanel.initialize();</span>
<span class="nc" id="L411">		outsideColonyPanel.initialize();</span>
<span class="nc" id="L412">		populationPanel.initialize();</span>
<span class="nc" id="L413">		tilesPanel.initialize();</span>
<span class="nc" id="L414">		warehousePanel.initialize();</span>

<span class="nc" id="L416">		add(this.nameBox, &quot;height 42:, grow&quot;);</span>
<span class="nc" id="L417">		int tmp = (int) (ImageLibrary.ICON_SIZE.height * gui.getImageLibrary().getScaleFactor());</span>
<span class="nc" id="L418">		add(netProductionPanel, &quot;grow, height &quot; + (tmp + 10) + &quot;:&quot; + (2 * tmp + 10) + &quot;:&quot; + (2 * tmp + 10));</span>
<span class="nc" id="L419">		add(tilesScroll, &quot;width 390!, height 200!, top&quot;);</span>
<span class="nc" id="L420">		add(buildingsScroll, &quot;span 1 3, grow&quot;);</span>
<span class="nc" id="L421">		add(populationPanel, &quot;grow&quot;);</span>
<span class="nc" id="L422">		add(constructionPanel, &quot;grow, top&quot;);</span>
<span class="nc" id="L423">		add(inPortScroll, &quot;span, split 3, grow, sg, height 60:121:&quot;);</span>
<span class="nc" id="L424">		add(cargoScroll, &quot;grow, sg, height 60:121:&quot;);</span>
<span class="nc" id="L425">		add(outsideColonyScroll, &quot;grow, sg, height 60:121:&quot;);</span>
<span class="nc" id="L426">		add(warehouseScroll, &quot;span, height 40:60:, growx&quot;);</span>
<span class="nc" id="L427">		int buttonFields = 6;</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">		if (setGoodsButton != null)</span>
<span class="nc" id="L429">			buttonFields++;</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">		if (traceWorkButton != null)</span>
<span class="nc" id="L431">			buttonFields++;</span>
<span class="nc" id="L432">		add(unloadButton, &quot;span, split &quot; + Integer.toString(buttonFields) + &quot;, align center&quot;);</span>
<span class="nc" id="L433">		add(fillButton);</span>
<span class="nc" id="L434">		add(warehouseButton);</span>
<span class="nc" id="L435">		add(buildQueueButton);</span>
<span class="nc" id="L436">		add(colonyUnitsButton);</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">		if (setGoodsButton != null)</span>
<span class="nc" id="L438">			add(setGoodsButton);</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">		if (traceWorkButton != null)</span>
<span class="nc" id="L440">			add(traceWorkButton);</span>
<span class="nc" id="L441">		add(okButton, &quot;tag ok&quot;);</span>

<span class="nc" id="L443">		update();</span>
<span class="nc" id="L444">	}</span>

	/**
	 * Clean up this colony panel.
	 */
	private void cleanup() {
<span class="nc" id="L450">		unloadButton.removeActionListener(this);</span>
<span class="nc" id="L451">		fillButton.removeActionListener(this);</span>
<span class="nc" id="L452">		warehouseButton.removeActionListener(this);</span>
<span class="nc" id="L453">		buildQueueButton.removeActionListener(this);</span>
<span class="nc" id="L454">		colonyUnitsButton.removeActionListener(this);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">		if (setGoodsButton != null) {</span>
<span class="nc" id="L456">			setGoodsButton.removeActionListener(this);</span>
		}
<span class="nc bnc" id="L458" title="All 2 branches missed.">		if (traceWorkButton != null) {</span>
<span class="nc" id="L459">			traceWorkButton.removeActionListener(this);</span>
		}

<span class="nc" id="L462">		removePropertyChangeListeners();</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">		if (getSelectedUnit() != null) {</span>
<span class="nc" id="L464">			getSelectedUnit().removePropertyChangeListener(this);</span>
		}
<span class="nc" id="L466">		removeMouseListeners();</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">		for (MouseListener listener : getMouseListeners()) {</span>
<span class="nc" id="L468">			removeMouseListener(listener);</span>
		}
<span class="nc" id="L470">		setTransferHandlers(false);</span>

<span class="nc" id="L472">		buildingsPanel.cleanup();</span>
<span class="nc" id="L473">		cargoPanel.cleanup();</span>
<span class="nc" id="L474">		constructionPanel.cleanup();</span>
<span class="nc" id="L475">		inPortPanel.cleanup();</span>
<span class="nc" id="L476">		outsideColonyPanel.cleanup();</span>
<span class="nc" id="L477">		populationPanel.cleanup();</span>
<span class="nc" id="L478">		tilesPanel.cleanup();</span>
<span class="nc" id="L479">		warehousePanel.cleanup();</span>

<span class="nc" id="L481">		removeAll();</span>
<span class="nc" id="L482">	}</span>

	/**
	 * Adds the mouse listeners.
	 */
	private void addMouseListeners() {
<span class="nc bnc" id="L488" title="All 2 branches missed.">		if (isEditable()) {</span>
<span class="nc" id="L489">			cargoPanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L490">			inPortPanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L491">			outsideColonyPanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L492">			warehousePanel.addMouseListener(releaseListener);</span>
		}
<span class="nc" id="L494">	}</span>

	/**
	 * Removes the mouse listeners.
	 */
	private void removeMouseListeners() {
<span class="nc" id="L500">		cargoPanel.removeMouseListener(releaseListener);</span>
<span class="nc" id="L501">		inPortPanel.removeMouseListener(releaseListener);</span>
<span class="nc" id="L502">		outsideColonyPanel.removeMouseListener(releaseListener);</span>
<span class="nc" id="L503">		warehousePanel.removeMouseListener(releaseListener);</span>
<span class="nc" id="L504">	}</span>

	/**
	 * Sets the transfer handlers.
	 *
	 * @param enable
	 *            the new transfer handlers
	 */
	private void setTransferHandlers(boolean enable) {
<span class="nc bnc" id="L513" title="All 2 branches missed.">		DefaultTransferHandler dth = (enable) ? defaultTransferHandler : null;</span>
<span class="nc" id="L514">		cargoPanel.setTransferHandler(dth);</span>
<span class="nc" id="L515">		inPortPanel.setTransferHandler(dth);</span>
<span class="nc" id="L516">		outsideColonyPanel.setTransferHandler(dth);</span>
<span class="nc" id="L517">		warehousePanel.setTransferHandler(dth);</span>
<span class="nc" id="L518">	}</span>

	/**
	 * Add property change listeners needed by this ColonyPanel.
	 */
	private void addPropertyChangeListeners() {
<span class="nc" id="L524">		final Colony colony = getColony();</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">		if (colony != null) {</span>
<span class="nc" id="L526">			colony.addPropertyChangeListener(this);</span>
<span class="nc" id="L527">			colony.getGoodsContainer().addPropertyChangeListener(this);</span>
<span class="nc" id="L528">			colony.getTile().addPropertyChangeListener(this);</span>
		}
<span class="nc" id="L530">	}</span>

	/**
	 * Remove the property change listeners of ColonyPanel.
	 */
	private void removePropertyChangeListeners() {
<span class="nc" id="L536">		final Colony colony = getColony();</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">		if (colony != null) {</span>
<span class="nc" id="L538">			colony.removePropertyChangeListener(this);</span>
<span class="nc" id="L539">			colony.getGoodsContainer().removePropertyChangeListener(this);</span>
<span class="nc" id="L540">			colony.getTile().removePropertyChangeListener(this);</span>
		}
<span class="nc" id="L542">	}</span>

	/**
	 * Update all the production-related panels.
	 *
	 * This has to be very broad as a change at one work location can have a
	 * secondary effect on another, and especially if the population hits a
	 * bonus boundary. A simple example is that adding extra lumber production
	 * may improve the production of the lumber mill. These changes can then
	 * flow on to production and construction displays.
	 */
	private void updateProduction() {
<span class="nc" id="L554">		final Colony colony = getColony();</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">		if (colony == null)</span>
<span class="nc" id="L556">			return;</span>

		// Check for non-producing locations that can now produce.
<span class="nc bnc" id="L559" title="All 2 branches missed.">		for (WorkLocation wl : colony.getCurrentWorkLocations()) {</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">			boolean change = false, check = wl.getProductionType() == null;</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">			for (Unit u : wl.getUnitList()) {</span>
<span class="nc bnc" id="L562" title="All 4 branches missed.">				if (check || !wl.produces(u.getWorkType())) {</span>
<span class="nc" id="L563">					GoodsType workType = wl.getWorkFor(u);</span>
<span class="nc bnc" id="L564" title="All 4 branches missed.">					if (workType != null &amp;&amp; workType != u.getWorkType()) {</span>
<span class="nc" id="L565">						igc().changeWorkType(u, workType);</span>
					}
<span class="nc" id="L567">					change = true;</span>
				}
<span class="nc" id="L569">			}</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">			if (change)</span>
<span class="nc" id="L571">				wl.updateProductionType();</span>
<span class="nc" id="L572">		}</span>

<span class="nc" id="L574">		updateTilesPanel();</span>
<span class="nc" id="L575">		updateBuildingsPanel();</span>
<span class="nc" id="L576">		updateNetProductionPanel();</span>
<span class="nc" id="L577">		updateConstructionPanel();</span>
<span class="nc" id="L578">	}</span>

	/**
	 * Update the entire colony panel.
	 */
	public void update() {
<span class="nc" id="L584">		buildingsPanel.update();</span>
<span class="nc" id="L585">		constructionPanel.update();</span>
<span class="nc" id="L586">		inPortPanel.update();</span>
<span class="nc" id="L587">		updateNetProductionPanel();</span>
<span class="nc" id="L588">		outsideColonyPanel.update();</span>
<span class="nc" id="L589">		populationPanel.update();</span>
<span class="nc" id="L590">		tilesPanel.update();</span>
<span class="nc" id="L591">		warehousePanel.update();</span>
<span class="nc" id="L592">	}</span>

	/**
	 * Enables the unload and fill buttons if the currently selected unit is a
	 * carrier with some cargo.
	 */
	private void updateCarrierButtons() {
<span class="nc" id="L599">		final Colony colony = getColony();</span>
<span class="nc" id="L600">		unloadButton.setEnabled(false);</span>
<span class="nc" id="L601">		fillButton.setEnabled(false);</span>
<span class="nc bnc" id="L602" title="All 4 branches missed.">		if (isEditable() &amp;&amp; selectedUnitLabel != null) {</span>
<span class="nc" id="L603">			Unit unit = selectedUnitLabel.getUnit();</span>
<span class="nc bnc" id="L604" title="All 6 branches missed.">			if (unit != null &amp;&amp; unit.isCarrier() &amp;&amp; unit.hasCargo()) {</span>
<span class="nc" id="L605">				unloadButton.setEnabled(true);</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">				for (Goods goods : unit.getCompactGoodsList()) {</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">					if (colony.getGoodsCount(goods.getType()) &gt; 0) {</span>
<span class="nc" id="L608">						fillButton.setEnabled(true);</span>
<span class="nc" id="L609">						break;</span>
					}
<span class="nc" id="L611">				}</span>
			}
		}
<span class="nc" id="L614">	}</span>

	/**
	 * Generates a menu containing the units currently accessible from the
	 * Colony Panel allowing keyboard access to said units.
	 */
	private void generateColonyUnitsMenu() {
<span class="nc" id="L621">		final FreeColClient freeColClient = getFreeColClient();</span>
<span class="nc" id="L622">		ImageLibrary lib = getImageLibrary();</span>
<span class="nc" id="L623">		final Colony colony = getColony();</span>
<span class="nc" id="L624">		JPopupMenu colonyUnitsMenu = new JPopupMenu(Messages.message(&quot;colonyPanel.colonyUnits&quot;));</span>
<span class="nc" id="L625">		ImageIcon unitIcon = null;</span>
<span class="nc" id="L626">		final QuickActionMenu unitMenu = new QuickActionMenu(freeColClient, this);</span>
<span class="nc" id="L627">		Tile colonyTile = colony.getTile();</span>
<span class="nc" id="L628">		int unitNumber = 0;</span>
<span class="nc" id="L629">		JMenuItem subMenu = null;</span>

<span class="nc bnc" id="L631" title="All 2 branches missed.">		for (final Unit unit : colony.getUnitList()) {</span>
<span class="nc" id="L632">			Building workingInBuilding = unit.getWorkBuilding();</span>
<span class="nc" id="L633">			ColonyTile workingOnLand = unit.getWorkTile();</span>
<span class="nc" id="L634">			GoodsType goodsType = unit.getWorkType();</span>
<span class="nc" id="L635">			Unit student = unit.getStudent();</span>

<span class="nc" id="L637">			unitIcon = new ImageIcon(lib.getSmallerUnitImage(unit));</span>
<span class="nc" id="L638">			StringBuilder sb = new StringBuilder(64);</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">			if (student != null) {</span>
<span class="nc" id="L640">				sb.append(unit.getDescription()).append(&quot; &quot;).append(Messages.message(&quot;colonyPanel.producing&quot;))</span>
<span class="nc" id="L641">						.append(&quot; &quot;).append(Messages.getName(unit.getType().getSkillTaught())).append(&quot; &quot;)</span>
<span class="nc" id="L642">						.append(unit.getTurnsOfTraining()).append(&quot;/&quot;).append(unit.getNeededTurnsOfTraining());</span>
<span class="nc bnc" id="L643" title="All 4 branches missed.">			} else if (workingOnLand != null &amp;&amp; goodsType != null) {</span>
<span class="nc" id="L644">				int producing = workingOnLand.getProductionOf(unit, goodsType);</span>
<span class="nc" id="L645">				String nominative = Messages</span>
<span class="nc" id="L646">						.message(StringTemplate.template(goodsType).addAmount(&quot;%amount%&quot;, producing));</span>
<span class="nc" id="L647">				sb.append(unit.getDescription()).append(&quot; &quot;).append(Messages.message(&quot;colonyPanel.producing&quot;))</span>
<span class="nc" id="L648">						.append(&quot; &quot;).append(producing).append(&quot; &quot;).append(nominative);</span>
<span class="nc bnc" id="L649" title="All 4 branches missed.">			} else if (workingInBuilding != null &amp;&amp; goodsType != null) {</span>
<span class="nc" id="L650">				int producing = workingInBuilding.getProductionOf(unit, goodsType);</span>
<span class="nc" id="L651">				String nominative = Messages</span>
<span class="nc" id="L652">						.message(StringTemplate.template(goodsType).addAmount(&quot;%amount%&quot;, producing));</span>
<span class="nc" id="L653">				sb.append(unit.getDescription()).append(&quot; &quot;).append(Messages.message(&quot;colonyPanel.producing&quot;))</span>
<span class="nc" id="L654">						.append(&quot; &quot;).append(producing).append(&quot; &quot;).append(nominative);</span>
<span class="nc" id="L655">			} else {</span>
<span class="nc" id="L656">				sb.append(unit.getDescription()).append(&quot; &quot;).append(Messages.message(&quot;colonyPanel.producing&quot;))</span>
<span class="nc" id="L657">						.append(&quot; &quot;).append(Messages.message(&quot;nothing&quot;));</span>
			}
<span class="nc" id="L659">			String menuTitle = sb.toString();</span>
<span class="nc" id="L660">			subMenu = new JMenuItem(menuTitle, unitIcon);</span>
<span class="nc" id="L661">			subMenu.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L662">				unitMenu.addMenuItems(new UnitLabel(freeColClient, unit));</span>
<span class="nc" id="L663">				unitMenu.show(getGUI().getCanvas(), 0, 0);</span>
<span class="nc" id="L664">			});</span>
<span class="nc" id="L665">			unitNumber++;</span>
<span class="nc" id="L666">			colonyUnitsMenu.add(subMenu);</span>
<span class="nc" id="L667">		}</span>
<span class="nc" id="L668">		colonyUnitsMenu.addSeparator();</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">		for (final Unit unit : colonyTile.getUnitList()) {</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">			if (unit.isCarrier()) {</span>
<span class="nc" id="L671">				unitIcon = new ImageIcon(lib.getSmallerUnitImage(unit));</span>
<span class="nc" id="L672">				String menuTitle = unit.getDescription() + &quot; &quot; + Messages.message(&quot;colonyPanel.inPort&quot;);</span>
<span class="nc" id="L673">				subMenu = new JMenuItem(menuTitle, unitIcon);</span>
<span class="nc" id="L674">				subMenu.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L675">					unitMenu.addMenuItems(new UnitLabel(freeColClient, unit));</span>
<span class="nc" id="L676">					unitMenu.show(getGUI().getCanvas(), 0, 0);</span>
<span class="nc" id="L677">				});</span>
<span class="nc" id="L678">				unitNumber++;</span>
<span class="nc" id="L679">				colonyUnitsMenu.add(subMenu);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">				if (unit.getUnitList() != null) {</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">					for (final Unit innerUnit : unit.getUnitList()) {</span>
<span class="nc" id="L682">						unitIcon = new ImageIcon(lib.getSmallerUnitImage(innerUnit));</span>
<span class="nc" id="L683">						menuTitle = innerUnit.getDescription() + &quot; &quot; + Messages.message(&quot;cargoOnCarrier&quot;) + &quot; &quot;</span>
<span class="nc" id="L684">								+ unit.getDescription();</span>
<span class="nc" id="L685">						subMenu = new JMenuItem(menuTitle, unitIcon);</span>
<span class="nc" id="L686">						subMenu.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L687">							unitMenu.addMenuItems(new UnitLabel(freeColClient, innerUnit));</span>
<span class="nc" id="L688">							unitMenu.show(getGUI().getCanvas(), 0, 0);</span>
<span class="nc" id="L689">						});</span>
<span class="nc" id="L690">						unitNumber++;</span>
<span class="nc" id="L691">						colonyUnitsMenu.add(subMenu);</span>
<span class="nc" id="L692">					}</span>
				}
<span class="nc bnc" id="L694" title="All 2 branches missed.">			} else if (!unit.isOnCarrier()) {</span>
<span class="nc" id="L695">				unitIcon = new ImageIcon(lib.getSmallerUnitImage(unit));</span>
<span class="nc" id="L696">				String menuTitle = unit.getDescription() + &quot; &quot; + Messages.message(&quot;colonyPanel.outsideColony&quot;);</span>
<span class="nc" id="L697">				subMenu = new JMenuItem(menuTitle, unitIcon);</span>
<span class="nc" id="L698">				subMenu.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L699">					unitMenu.addMenuItems(new UnitLabel(freeColClient, unit));</span>
<span class="nc" id="L700">					unitMenu.show(getGUI().getCanvas(), 0, 0);</span>
<span class="nc" id="L701">				});</span>
<span class="nc" id="L702">				unitNumber++;</span>
<span class="nc" id="L703">				colonyUnitsMenu.add(subMenu);</span>
			}
<span class="nc" id="L705">		}</span>
<span class="nc" id="L706">		colonyUnitsMenu.addSeparator();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">		if (colonyUnitsMenu != null) {</span>
<span class="nc" id="L708">			int elements = colonyUnitsMenu.getSubElements().length;</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">			if (elements &gt; 0) {</span>
<span class="nc" id="L710">				int lastIndex = colonyUnitsMenu.getComponentCount() - 1;</span>
<span class="nc bnc" id="L711" title="All 2 branches missed.">				if (colonyUnitsMenu.getComponent(lastIndex) instanceof JPopupMenu.Separator) {</span>
<span class="nc" id="L712">					colonyUnitsMenu.remove(lastIndex);</span>
				}
			}
		}
<span class="nc" id="L716">		colonyUnitsMenu.show(getGUI().getCanvas(), 0, 0);</span>
<span class="nc" id="L717">	}</span>

	/**
	 * Try to assign a unit to work in a colony work location.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is to work.
	 * @param wl
	 *            The &lt;code&gt;WorkLocation&lt;/code&gt; to work in.
	 * @return True if the unit is now in the work location.
	 */
	private boolean tryWork(Unit unit, WorkLocation wl) {
		// Choose the best work type.
<span class="nc" id="L730">		GoodsType workType = wl.getWorkFor(unit);</span>

		// Set the unit to work. Note this might upgrade the unit,
		// and possibly even change its work type as the server has
		// the right to maintain consistency.
<span class="nc" id="L735">		igc().work(unit, wl);</span>

		// Did it work?
<span class="nc bnc" id="L738" title="All 2 branches missed.">		if (unit.getLocation() != wl)</span>
<span class="nc" id="L739">			return false;</span>

		// Now recheck, and see if we want to change to the expected
		// work type.
<span class="nc bnc" id="L743" title="All 4 branches missed.">		if (workType != null &amp;&amp; workType != unit.getWorkType()) {</span>
<span class="nc" id="L744">			igc().changeWorkType(unit, workType);</span>
		}
<span class="nc" id="L746">		return true;</span>
	}

	// Public base accessors and mutators

	/**
	 * Gets the &lt;code&gt;Colony&lt;/code&gt; in use.
	 *
	 * Try to use this at the top of all the routines that need the colony, to
	 * get a stable value. There have been nasty races when the colony changes
	 * out from underneath us, and more may be lurking.
	 *
	 * @return The &lt;code&gt;Colony&lt;/code&gt;.
	 */
	public synchronized final Colony getColony() {
<span class="nc" id="L761">		return colony;</span>
	}

	/**
	 * Gets the &lt;code&gt;TilesPanel&lt;/code&gt;-object in use.
	 *
	 * @return The &lt;code&gt;TilesPanel&lt;/code&gt;.
	 */
	public final TilesPanel getTilesPanel() {
<span class="nc" id="L770">		return tilesPanel;</span>
	}

	/**
	 * Gets the &lt;code&gt;WarehousePanel&lt;/code&gt;-object in use.
	 *
	 * @return The &lt;code&gt;WarehousePanel&lt;/code&gt;.
	 */
	public final WarehousePanel getWarehousePanel() {
<span class="nc" id="L779">		return warehousePanel;</span>
	}

	// Override PortPanel

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void setSelectedUnitLabel(UnitLabel unitLabel) {
<span class="nc bnc" id="L789" title="All 2 branches missed.">		if (selectedUnitLabel != unitLabel) {</span>
<span class="nc" id="L790">			inPortPanel.removePropertyChangeListeners();</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">			if (selectedUnitLabel != null) {</span>
<span class="nc" id="L792">				selectedUnitLabel.setSelected(false);</span>
<span class="nc" id="L793">				selectedUnitLabel.getUnit().removePropertyChangeListener(this);</span>
			}
<span class="nc" id="L795">			super.setSelectedUnitLabel(unitLabel);</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">			if (unitLabel == null) {</span>
<span class="nc" id="L797">				cargoPanel.setCarrier(null);</span>
			} else {
<span class="nc" id="L799">				cargoPanel.setCarrier(unitLabel.getUnit());</span>
<span class="nc" id="L800">				unitLabel.setSelected(true);</span>
<span class="nc" id="L801">				unitLabel.getUnit().addPropertyChangeListener(this);</span>
			}
<span class="nc" id="L803">			inPortPanel.addPropertyChangeListeners();</span>
		}
<span class="nc" id="L805">		updateCarrierButtons();</span>
<span class="nc" id="L806">		inPortPanel.revalidate();</span>
<span class="nc" id="L807">		inPortPanel.repaint();</span>
<span class="nc" id="L808">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean setSelectedUnit(Unit unit) {
<span class="nc bnc" id="L815" title="All 2 branches missed.">		return ((unit.isCarrier()) ? inPortPanel.setSelectedUnit(unit) : super.setSelectedUnit(unit));</span>
	}

	// Public update routines

	/**
	 * Update buildings panel.
	 */
	public void updateBuildingsPanel() {
<span class="nc" id="L824">		buildingsPanel.update();</span>
<span class="nc" id="L825">	}</span>

	/**
	 * Update construction panel.
	 */
	public void updateConstructionPanel() {
<span class="nc" id="L831">		constructionPanel.update();</span>
<span class="nc" id="L832">	}</span>

	/**
	 * Update in port panel.
	 */
	public void updateInPortPanel() {
<span class="nc" id="L838">		inPortPanel.update();</span>
<span class="nc" id="L839">	}</span>

	/**
	 * Update net production panel.
	 */
	public void updateNetProductionPanel() {
<span class="nc" id="L845">		final Colony colony = getColony();</span>
<span class="nc" id="L846">		final Specification spec = colony.getSpecification();</span>
		// FIXME: find out why the cache needs to be explicitly invalidated
<span class="nc" id="L848">		colony.invalidateCache();</span>
<span class="nc" id="L849">		netProductionPanel.removeAll();</span>

<span class="nc bnc" id="L851" title="All 2 branches missed.">		for (GoodsType goodsType : spec.getGoodsTypeList()) {</span>
<span class="nc" id="L852">			int amount = colony.getAdjustedNetProductionOf(goodsType);</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">			if (amount != 0) {</span>
<span class="nc" id="L854">				netProductionPanel.add(new ProductionLabel(getFreeColClient(), new AbstractGoods(goodsType, amount)));</span>
			}
<span class="nc" id="L856">		}</span>

<span class="nc" id="L858">		netProductionPanel.revalidate();</span>
<span class="nc" id="L859">	}</span>

	/**
	 * Update outside colony panel.
	 */
	public void updateOutsideColonyPanel() {
<span class="nc" id="L865">		outsideColonyPanel.update();</span>
<span class="nc" id="L866">	}</span>

	/**
	 * Update population panel.
	 */
	public void updatePopulationPanel() {
<span class="nc" id="L872">		populationPanel.update();</span>
<span class="nc" id="L873">	}</span>

	/**
	 * Update tiles panel.
	 */
	public void updateTilesPanel() {
<span class="nc" id="L879">		tilesPanel.update();</span>
<span class="nc" id="L880">	}</span>

	/**
	 * Update warehouse panel.
	 */
	public void updateWarehousePanel() {
<span class="nc" id="L886">		warehousePanel.update();</span>
<span class="nc" id="L887">	}</span>

	/**
	 * Close this &lt;code&gt;ColonyPanel&lt;/code&gt;.
	 */
	public void closeColonyPanel() {
<span class="nc" id="L893">		final Colony colony = getColony();</span>
<span class="nc" id="L894">		boolean abandon = false;</span>
<span class="nc bnc" id="L895" title="All 4 branches missed.">		if (colony.getUnitCount() == 0 &amp;&amp; getMyPlayer().owns(colony)) {</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">			if (!getGUI().confirm(null, StringTemplate.key(&quot;abandonColony.text&quot;), &quot;abandonColony.yes&quot;,</span>
					&quot;abandonColony.no&quot;))
<span class="nc" id="L898">				return;</span>
<span class="nc" id="L899">			abandon = true;</span>
		}
<span class="nc bnc" id="L901" title="All 2 branches missed.">		if (!abandon) {</span>
<span class="nc" id="L902">			BuildableType buildable = colony.getCurrentlyBuilding();</span>
<span class="nc bnc" id="L903" title="All 6 branches missed.">			if (buildable != null &amp;&amp; buildable.getRequiredPopulation() &gt; colony.getUnitCount() &amp;&amp; !getGUI().confirm(</span>
					null,
<span class="nc" id="L905">					StringTemplate.template(&quot;colonyPanel.reducePopulation&quot;).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L906">							.addAmount(&quot;%number%&quot;, buildable.getRequiredPopulation())</span>
<span class="nc" id="L907">							.addNamed(&quot;%buildable%&quot;, buildable),</span>
					&quot;ok&quot;, &quot;cancel&quot;)) {
<span class="nc" id="L909">				return;</span>
			}
		}

<span class="nc" id="L913">		cleanup();</span>

<span class="nc" id="L915">		getGUI().removeFromCanvas(this);</span>
<span class="nc" id="L916">		getGUI().updateMapControls();</span>

		// Talk to the controller last, allow all the cleanup to happen first.
<span class="nc bnc" id="L919" title="All 2 branches missed.">		if (abandon)</span>
<span class="nc" id="L920">			igc().abandonColony(colony);</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">		if (getFreeColClient().currentPlayerIsMyPlayer()) {</span>
<span class="nc" id="L922">			igc().nextModelMessage();</span>
<span class="nc" id="L923">			Unit activeUnit = getGUI().getActiveUnit();</span>
<span class="nc bnc" id="L924" title="All 4 branches missed.">			if (activeUnit == null || !activeUnit.hasTile()</span>
<span class="nc bnc" id="L925" title="All 4 branches missed.">					|| (!(activeUnit.getLocation() instanceof Tile) &amp;&amp; !activeUnit.isOnCarrier())) {</span>
<span class="nc" id="L926">				igc().nextActiveUnit();</span>
			}
		}
<span class="nc" id="L929">	}</span>

	// Interface PortPanel

	/**
	 * Gets the list of units on the colony tile. Note, does not include the
	 * units *inside* the colony.
	 *
	 * @return A sorted list of units on the colony tile.
	 */
	@Override
	public List&lt;Unit&gt; getUnitList() {
<span class="nc" id="L941">		return FreeColObject.getSortedCopy(colony.getTile().getUnitList());</span>
	}

	// Interface ActionListener

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L951">		final Colony colony = getColony();</span>
<span class="nc" id="L952">		final String command = ae.getActionCommand();</span>
<span class="nc" id="L953">		final Unit unit = getSelectedUnit();</span>

<span class="nc bnc" id="L955" title="All 2 branches missed.">		if (OK.equals(command)) {</span>
<span class="nc" id="L956">			closeColonyPanel();</span>
		} else {
			int cmd;
			try {
<span class="nc" id="L960">				cmd = Integer.parseInt(command);</span>
<span class="nc" id="L961">			} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L962">				logger.warning(&quot;Invalid action number: &quot; + command);</span>
<span class="nc" id="L963">				return;</span>
<span class="nc" id="L964">			}</span>
<span class="nc bnc" id="L965" title="All 8 branches missed.">			switch (cmd) {</span>
			case UNLOAD:
<span class="nc bnc" id="L967" title="All 4 branches missed.">				if (unit == null || !unit.isCarrier())</span>
<span class="nc" id="L968">					break;</span>
<span class="nc bnc" id="L969" title="All 2 branches missed.">				for (Goods goods : unit.getGoodsContainer().getGoods()) {</span>
<span class="nc" id="L970">					igc().unloadCargo(goods, false);</span>
<span class="nc" id="L971">				}</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">				for (Unit u : unit.getUnitList()) {</span>
<span class="nc" id="L973">					igc().leaveShip(u);</span>
<span class="nc" id="L974">				}</span>
<span class="nc" id="L975">				cargoPanel.update();</span>
<span class="nc" id="L976">				updateOutsideColonyPanel();</span>
<span class="nc" id="L977">				unloadButton.setEnabled(false);</span>
<span class="nc" id="L978">				fillButton.setEnabled(false);</span>
<span class="nc" id="L979">				break;</span>
			case WAREHOUSE:
<span class="nc bnc" id="L981" title="All 2 branches missed.">				if (getGUI().showWarehouseDialog(colony)) {</span>
<span class="nc" id="L982">					updateWarehousePanel();</span>
				}
				break;
			case BUILDQUEUE:
<span class="nc" id="L986">				getGUI().showBuildQueuePanel(colony);</span>
<span class="nc" id="L987">				updateConstructionPanel();</span>
<span class="nc" id="L988">				break;</span>
			case FILL:
<span class="nc bnc" id="L990" title="All 4 branches missed.">				if (unit == null || !unit.isCarrier())</span>
<span class="nc" id="L991">					break;</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">				for (Goods goods : unit.getCompactGoodsList()) {</span>
<span class="nc" id="L993">					final GoodsType type = goods.getType();</span>
<span class="nc" id="L994">					int space = unit.getLoadableAmount(type);</span>
<span class="nc" id="L995">					int count = colony.getGoodsCount(type);</span>
<span class="nc bnc" id="L996" title="All 4 branches missed.">					if (space &gt; 0 &amp;&amp; count &gt; 0) {</span>
<span class="nc" id="L997">						int n = Math.min(space, count);</span>
<span class="nc" id="L998">						igc().loadCargo(new Goods(goods.getGame(), colony, type, n), unit);</span>
					}
<span class="nc" id="L1000">				}</span>
<span class="nc" id="L1001">				break;</span>
			case COLONY_UNITS:
<span class="nc" id="L1003">				generateColonyUnitsMenu();</span>
<span class="nc" id="L1004">				break;</span>
			case SETGOODS:
<span class="nc" id="L1006">				DebugUtils.setColonyGoods(getFreeColClient(), colony);</span>
<span class="nc" id="L1007">				updateWarehousePanel();</span>
<span class="nc" id="L1008">				updateProduction();</span>
<span class="nc" id="L1009">				break;</span>
			case OCCUPATION:
<span class="nc bnc" id="L1011" title="All 2 branches missed.">				colony.setOccupationTrace(!colony.getOccupationTrace());</span>
<span class="nc" id="L1012">				break;</span>
			default:
<span class="nc" id="L1014">				super.actionPerformed(ae);</span>
			}
		}
<span class="nc" id="L1017">	}</span>

	// Interface PropertyChangeListener

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void propertyChange(PropertyChangeEvent event) {
<span class="nc" id="L1026">		final Colony colony = getColony();</span>
<span class="nc bnc" id="L1027" title="All 4 branches missed.">		if (!isShowing() || colony == null)</span>
<span class="nc" id="L1028">			return;</span>
<span class="nc" id="L1029">		String property = event.getPropertyName();</span>
<span class="nc" id="L1030">		logger.finest(</span>
<span class="nc" id="L1031">				colony.getName() + &quot; change &quot; + property + &quot;: &quot; + event.getOldValue() + &quot; -&gt; &quot; + event.getNewValue());</span>

<span class="nc bnc" id="L1033" title="All 2 branches missed.">		if (property == null) {</span>
<span class="nc" id="L1034">			logger.warning(&quot;Null property change&quot;);</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">		} else if (Unit.CARGO_CHANGE.equals(property)) {</span>
<span class="nc" id="L1036">			cargoPanel.update();</span>
<span class="nc" id="L1037">			updateInPortPanel();</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">		} else if (ColonyChangeEvent.POPULATION_CHANGE.toString().equals(property)) {</span>
<span class="nc" id="L1039">			updatePopulationPanel();</span>
<span class="nc" id="L1040">			updateNetProductionPanel(); // food production changes</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">		} else if (ColonyChangeEvent.BONUS_CHANGE.toString().equals(property)) {</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">			if (colony.getUnitCount() &gt; 0) { // Ignore messages when abandoning</span>
<span class="nc" id="L1043">				ModelMessage msg = colony.checkForGovMgtChangeMessage();</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">				if (msg != null) {</span>
<span class="nc" id="L1045">					getGUI().showInformationMessage(colony, msg);</span>
				}
			}
<span class="nc" id="L1048">			updatePopulationPanel();</span>
<span class="nc bnc" id="L1049" title="All 2 branches missed.">		} else if (ColonyChangeEvent.BUILD_QUEUE_CHANGE.toString().equals(property)) {</span>
<span class="nc" id="L1050">			updateProduction();</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">		} else if (ColonyChangeEvent.UNIT_TYPE_CHANGE.toString().equals(property)) {</span>
<span class="nc" id="L1052">			FreeColGameObject object = (FreeColGameObject) event.getSource();</span>
<span class="nc" id="L1053">			UnitType oldType = (UnitType) event.getOldValue();</span>
<span class="nc" id="L1054">			UnitType newType = (UnitType) event.getNewValue();</span>
<span class="nc" id="L1055">			getGUI().showInformationMessage(object,</span>
<span class="nc" id="L1056">					StringTemplate.template(&quot;colonyPanel.unitChange&quot;).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L1057">							.addNamed(&quot;%oldType%&quot;, oldType).addNamed(&quot;%newType%&quot;, newType));</span>
<span class="nc" id="L1058">			updateTilesPanel();</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">		} else if (property.startsWith(&quot;model.goods.&quot;)) {</span>
			// Changes to warehouse goods count may affect building production
			// which requires a view update.
<span class="nc" id="L1062">			updateWarehousePanel();</span>
<span class="nc" id="L1063">			updateProduction();</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">		} else if (Tile.UNIT_CHANGE.equals(property)) {</span>
<span class="nc" id="L1065">			updateOutsideColonyPanel();</span>
<span class="nc" id="L1066">			updateInPortPanel();</span>
<span class="nc" id="L1067">			updatePopulationPanel();</span>
<span class="nc" id="L1068">			updateWarehousePanel();// Role change changes equipment goods</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">		} else if (Unit.MOVE_CHANGE.equals(property)) {</span>
<span class="nc" id="L1070">			updateOutsideColonyPanel();</span>
		} else {
			// ColonyTiles and Buildings now have their own
			// propertyChangeListeners so {ColonyTile,Building}.UNIT_CHANGE
			// events should not arrive here.
<span class="nc" id="L1075">			logger.warning(&quot;Unknown property change event: &quot; + event.getPropertyName());</span>
		}
<span class="nc" id="L1077">	}</span>

	// Override Component

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void removeNotify() {
<span class="nc bnc" id="L1086" title="All 2 branches missed.">		if (colony == null)</span>
<span class="nc" id="L1087">			return; // Been here already</span>
<span class="nc" id="L1088">		colony.setOccupationTrace(false);</span>
<span class="nc" id="L1089">		colony = null; // Now Canvas.getColonyPanel will no longer find this</span>

<span class="nc" id="L1091">		super.removeNotify();</span>

		// Alas, ColonyPanel is often leaky.
<span class="nc" id="L1094">		unloadButton = null;</span>
<span class="nc" id="L1095">		fillButton = null;</span>
<span class="nc" id="L1096">		warehouseButton = null;</span>
<span class="nc" id="L1097">		buildQueueButton = null;</span>
<span class="nc" id="L1098">		colonyUnitsButton = null;</span>
<span class="nc" id="L1099">		setGoodsButton = null;</span>
<span class="nc" id="L1100">		traceWorkButton = null;</span>
<span class="nc" id="L1101">		netProductionPanel = null;</span>
<span class="nc" id="L1102">		buildingsPanel = null;</span>
<span class="nc" id="L1103">		buildingsScroll = null;</span>
<span class="nc" id="L1104">		cargoScroll = null;</span>
<span class="nc" id="L1105">		constructionPanel = null;</span>
<span class="nc" id="L1106">		inPortScroll = null;</span>
<span class="nc" id="L1107">		outsideColonyPanel = null;</span>
<span class="nc" id="L1108">		outsideColonyScroll = null;</span>
<span class="nc" id="L1109">		populationPanel = null;</span>
<span class="nc" id="L1110">		tilesPanel = null;</span>
<span class="nc" id="L1111">		tilesScroll = null;</span>
<span class="nc" id="L1112">		warehousePanel = null;</span>
<span class="nc" id="L1113">		warehouseScroll = null;</span>

<span class="nc" id="L1115">		releaseListener = null;</span>

		// Inherited from PortPanel
		// cargoPanel = null;
		// inPortPanel = null;
		// defaultTransferHandler = null;
		// pressListener = null;
		// selectedUnitLabel = null;
<span class="nc" id="L1123">	}</span>

	// Subpanel classes

	/**
	 * This panel shows the content of a carrier in the colony.
	 */
	public final class ColonyCargoPanel extends CargoPanel {

		/**
		 * Create this colony cargo panel.
		 *
		 * @param freeColClient
		 *            The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
		 */
<span class="nc" id="L1138">		public ColonyCargoPanel(FreeColClient freeColClient) {</span>
<span class="nc" id="L1139">			super(freeColClient, true);</span>
<span class="nc" id="L1140">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void update() {
<span class="nc" id="L1147">			super.update();</span>
			// May have un/loaded cargo, &quot;Unload&quot; could have changed validity
<span class="nc" id="L1149">			updateCarrierButtons();</span>
<span class="nc" id="L1150">			updatePopulationPanel();</span>
<span class="nc" id="L1151">		}</span>
	}

	/**
	 * The panel to display the population breakdown for this colony.
	 */
	public final class PopulationPanel extends JPanel {

		/** The rebel shield. */
		// Predefine all the required labels.
<span class="nc" id="L1161">		private final JLabel rebelShield = new JLabel();</span>

		/** The rebel label. */
<span class="nc" id="L1164">		private final JLabel rebelLabel = new JLabel();</span>

		/** The bonus label. */
<span class="nc" id="L1167">		private final JLabel bonusLabel = new JLabel();</span>

		/** The royalist label. */
<span class="nc" id="L1170">		private final JLabel royalistLabel = new JLabel();</span>

		/** The royalist shield. */
<span class="nc" id="L1173">		private final JLabel royalistShield = new JLabel();</span>

		/** The rebel member label. */
<span class="nc" id="L1176">		private final JLabel rebelMemberLabel = new JLabel();</span>

		/** The pop label. */
<span class="nc" id="L1179">		private final JLabel popLabel = new JLabel();</span>

		/** The royalist member label. */
<span class="nc" id="L1182">		private final JLabel royalistMemberLabel = new JLabel();</span>

		/**
		 * Create a new population panel.
		 */
<span class="nc" id="L1187">		public PopulationPanel() {</span>
<span class="nc" id="L1188">			super(new MigLayout(&quot;wrap 5, fill, insets 0&quot;, &quot;[][]:push[center]:push[right][]&quot;));</span>
<span class="nc" id="L1189">			setOpaque(false);</span>
<span class="nc" id="L1190">			setToolTipText(&quot; &quot;);</span>
<span class="nc" id="L1191">		}</span>

		/**
		 * Initialize this population panel.
		 */
		public void initialize() {
<span class="nc" id="L1197">			cleanup();</span>
<span class="nc" id="L1198">			update();</span>
<span class="nc" id="L1199">		}</span>

		/**
		 * Clean up this population panel.
		 */
		public void cleanup() {
			// Nothing yet
<span class="nc" id="L1206">		}</span>

		/**
		 * Update this population panel.
		 */
		public void update() {
<span class="nc" id="L1212">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">			if (colony == null)</span>
<span class="nc" id="L1214">				return;</span>
<span class="nc" id="L1215">			final ImageLibrary lib = getGUI().getTileImageLibrary();</span>
<span class="nc" id="L1216">			final Font font = FontLibrary.createFont(FontLibrary.FontType.NORMAL, FontLibrary.FontSize.SMALLER,</span>
<span class="nc" id="L1217">					lib.getScaleFactor());</span>
<span class="nc" id="L1218">			final int uc = colony.getUnitCount();</span>
<span class="nc" id="L1219">			final int solPercent = colony.getSoL();</span>
<span class="nc" id="L1220">			final int rebels = Colony.calculateRebels(uc, solPercent);</span>
<span class="nc" id="L1221">			final Nation nation = colony.getOwner().getNation();</span>
<span class="nc" id="L1222">			final int grow = colony.getPreferredSizeChange();</span>
<span class="nc" id="L1223">			final int bonus = colony.getProductionBonus();</span>
			StringTemplate t;

<span class="nc" id="L1226">			removeAll();</span>

<span class="nc" id="L1228">			rebelShield.setIcon(new ImageIcon(lib.getSmallerMiscIconImage(nation)));</span>
<span class="nc" id="L1229">			add(rebelShield, &quot;bottom&quot;);</span>

<span class="nc" id="L1231">			t = StringTemplate.template(&quot;colonyPanel.rebelLabel&quot;).addAmount(&quot;%number%&quot;, rebels);</span>
<span class="nc" id="L1232">			rebelLabel.setText(Messages.message(t));</span>
<span class="nc" id="L1233">			rebelLabel.setFont(font);</span>
<span class="nc" id="L1234">			add(rebelLabel, &quot;split 2, flowy&quot;);</span>

<span class="nc" id="L1236">			rebelMemberLabel.setText(solPercent + &quot;%&quot;);</span>
<span class="nc" id="L1237">			rebelMemberLabel.setFont(font);</span>
<span class="nc" id="L1238">			add(rebelMemberLabel);</span>

<span class="nc" id="L1240">			t = StringTemplate.template(&quot;colonyPanel.populationLabel&quot;).addAmount(&quot;%number%&quot;, uc);</span>
<span class="nc" id="L1241">			popLabel.setText(Messages.message(t));</span>
<span class="nc" id="L1242">			popLabel.setFont(font);</span>
<span class="nc" id="L1243">			add(popLabel, &quot;split 2, flowy&quot;);</span>

<span class="nc bnc" id="L1245" title="All 2 branches missed.">			t = StringTemplate.template(&quot;colonyPanel.bonusLabel&quot;).addAmount(&quot;%number%&quot;, bonus).add(&quot;%extra%&quot;,</span>
					((grow == 0) ? &quot;&quot; : &quot;(&quot; + grow + &quot;)&quot;));
<span class="nc" id="L1247">			bonusLabel.setText(Messages.message(t));</span>
<span class="nc" id="L1248">			bonusLabel.setFont(font);</span>
<span class="nc" id="L1249">			add(bonusLabel);</span>

<span class="nc" id="L1251">			t = StringTemplate.template(&quot;colonyPanel.royalistLabel&quot;).addAmount(&quot;%number%&quot;, uc - rebels);</span>
<span class="nc" id="L1252">			royalistLabel.setText(Messages.message(t));</span>
<span class="nc" id="L1253">			royalistLabel.setFont(font);</span>
<span class="nc" id="L1254">			add(royalistLabel, &quot;split 2, flowy&quot;);</span>

<span class="nc" id="L1256">			royalistMemberLabel.setText(colony.getTory() + &quot;%&quot;);</span>
<span class="nc" id="L1257">			royalistMemberLabel.setFont(font);</span>
<span class="nc" id="L1258">			add(royalistMemberLabel);</span>

<span class="nc bnc" id="L1260" title="All 2 branches missed.">			Nation other = (colony.getOwner().isREF()) ? nation.getRebelNation() : nation.getREFNation();</span>
			try {
<span class="nc" id="L1262">				royalistShield.setIcon(new ImageIcon(lib.getSmallerMiscIconImage(other)));</span>
<span class="nc" id="L1263">				add(royalistShield, &quot;bottom&quot;);</span>
<span class="nc" id="L1264">			} catch (Exception e) {</span>
<span class="nc" id="L1265">				logger.log(Level.WARNING, &quot;Shield: &quot; + nation + &quot;/&quot; + other, e);</span>
<span class="nc" id="L1266">			}</span>

<span class="nc" id="L1268">			revalidate();</span>
<span class="nc" id="L1269">			repaint();</span>
<span class="nc" id="L1270">		}</span>

		/*
		 * (non-Javadoc)
		 * 
		 * @see javax.swing.JComponent#createToolTip()
		 */
		@Override
		public JToolTip createToolTip() {
<span class="nc" id="L1279">			return new RebelToolTip(getFreeColClient(), getColony());</span>
		}

		// Override JLabel

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String getUIClassID() {
<span class="nc" id="L1289">			return &quot;PopulationPanelUI&quot;;</span>
		}

		// Override Component

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void removeNotify() {
<span class="nc" id="L1299">			super.removeNotify();</span>

<span class="nc" id="L1301">			removeAll();</span>
<span class="nc" id="L1302">			setLayout(null);</span>
<span class="nc" id="L1303">		}</span>
	}

	/**
	 * A panel that holds UnitLabels that represent Units that are standing in
	 * front of a colony.
	 */
	public final class OutsideColonyPanel extends UnitPanel implements DropTarget {

		/**
		 * Create this OutsideColonyPanel.
		 */
<span class="nc" id="L1315">		public OutsideColonyPanel() {</span>
<span class="nc" id="L1316">			super(ColonyPanel.this, null, ColonyPanel.this.isEditable());</span>

<span class="nc" id="L1318">			setLayout(new MigLayout(&quot;wrap 3, fill, insets 0&quot;));</span>
<span class="nc" id="L1319">			setBorder(Utility.localizedBorder(&quot;colonyPanel.outsideColony&quot;));</span>
<span class="nc" id="L1320">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void initialize() {
<span class="nc" id="L1327">			super.initialize();</span>

<span class="nc" id="L1329">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc" id="L1331">				setName(colony.getName() + &quot; - &quot; + Messages.message(&quot;port&quot;));</span>
			}
<span class="nc" id="L1333">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void cleanup() {
<span class="nc" id="L1340">			super.cleanup();</span>

<span class="nc" id="L1342">			removeAll();</span>
<span class="nc" id="L1343">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		protected void addPropertyChangeListeners() {
<span class="nc" id="L1350">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc" id="L1352">				colony.getTile().addPropertyChangeListener(Tile.UNIT_CHANGE, this);</span>
			}
<span class="nc" id="L1354">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		protected void removePropertyChangeListeners() {
<span class="nc" id="L1361">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc" id="L1363">				colony.getTile().removePropertyChangeListener(Tile.UNIT_CHANGE, this);</span>
			}
<span class="nc" id="L1365">		}</span>

		// Inherit UnitPanel.update

		// Interface DropTarget

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Unit unit) {
<span class="nc bnc" id="L1375" title="All 2 branches missed.">			return !unit.isCarrier();</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Goods goods) {
<span class="nc" id="L1382">			return false;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public Component add(Component comp, boolean editState) {
<span class="nc" id="L1389">			Container oldParent = comp.getParent();</span>
<span class="nc bnc" id="L1390" title="All 2 branches missed.">			if (editState) {</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">				if (comp instanceof UnitLabel) {</span>
<span class="nc" id="L1392">					UnitLabel unitLabel = (UnitLabel) comp;</span>
<span class="nc" id="L1393">					Unit unit = unitLabel.getUnit();</span>

<span class="nc bnc" id="L1395" title="All 2 branches missed.">					if (!unit.isOnCarrier()) {</span>
<span class="nc" id="L1396">						igc().putOutsideColony(unit);</span>
					}

<span class="nc bnc" id="L1399" title="All 2 branches missed.">					if (unit.getColony() == null) {</span>
<span class="nc" id="L1400">						closeColonyPanel();</span>
<span class="nc" id="L1401">						return null;</span>
<span class="nc bnc" id="L1402" title="All 4 branches missed.">					} else if (!(unit.getLocation() instanceof Tile) &amp;&amp; !unit.isOnCarrier()) {</span>
<span class="nc" id="L1403">						return null;</span>
					}

<span class="nc" id="L1406">					oldParent.remove(comp);</span>
<span class="nc" id="L1407">					initialize();</span>
<span class="nc" id="L1408">					return comp;</span>
				} else {
<span class="nc" id="L1410">					logger.warning(&quot;Invalid component: &quot; + comp);</span>
<span class="nc" id="L1411">					return null;</span>
				}
			} else {
<span class="nc" id="L1414">				((UnitLabel) comp).setSmall(false);</span>
<span class="nc" id="L1415">				return add(comp);</span>
			}
		}

		/**
		 * {@inheritDoc}
		 */
		public int suggested(GoodsType type) {
<span class="nc" id="L1423">			return -1;</span>
		} // N/A

		// Override JPanel

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String getUIClassID() {
<span class="nc" id="L1433">			return &quot;OutsideColonyPanelUI&quot;;</span>
		}
	}

	/**
	 * A panel that holds UnitLabels that represent naval Units that are waiting
	 * in the port of the colony.
	 */
	public final class ColonyInPortPanel extends InPortPanel {

		/**
		 * Creates this ColonyInPortPanel.
		 */
<span class="nc" id="L1446">		public ColonyInPortPanel() {</span>
<span class="nc" id="L1447">			super(ColonyPanel.this, null, ColonyPanel.this.isEditable());</span>

<span class="nc" id="L1449">			setBorder(Utility.localizedBorder(&quot;colonyPanel.inPort&quot;));</span>
<span class="nc" id="L1450">			setLayout(new MigLayout(&quot;wrap 3, fill, insets 0&quot;));</span>
<span class="nc" id="L1451">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void initialize() {
<span class="nc" id="L1458">			super.initialize();</span>

<span class="nc" id="L1460">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc" id="L1462">				setName(colony.getName() + &quot; - &quot; + Messages.message(&quot;port&quot;));</span>
			}
<span class="nc" id="L1464">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		protected void addPropertyChangeListeners() {
<span class="nc" id="L1471">			Unit selected = getSelectedUnit();</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">			if (selected != null) {</span>
<span class="nc" id="L1473">				selected.addPropertyChangeListener(Unit.CARGO_CHANGE, this);</span>
			}
<span class="nc" id="L1475">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		protected void removePropertyChangeListeners() {
<span class="nc" id="L1482">			Unit selected = getSelectedUnit();</span>
<span class="nc bnc" id="L1483" title="All 2 branches missed.">			if (selected != null) {</span>
<span class="nc" id="L1484">				selected.removePropertyChangeListener(Unit.CARGO_CHANGE, this);</span>
			}
<span class="nc" id="L1486">		}</span>

		// extend UnitPanel

		/**
		 * {@inheritDoc}
		 */
		@Override
		public boolean accepts(Unit unit) {
<span class="nc" id="L1495">			return unit.isCarrier();</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void selectLabel() {
<span class="nc" id="L1503">			removePropertyChangeListeners();</span>
<span class="nc" id="L1504">			super.selectLabel();</span>
<span class="nc" id="L1505">			addPropertyChangeListeners();</span>
<span class="nc" id="L1506">		}</span>
	}

	/**
	 * A panel that holds goods that represent cargo that is inside the Colony.
	 */
	public final class WarehousePanel extends JPanel implements DropTarget, PropertyChangeListener {

		/**
		 * Creates a WarehousePanel.
		 */
<span class="nc" id="L1517">		public WarehousePanel() {</span>
<span class="nc" id="L1518">			setLayout(new MigLayout(&quot;fill, gap push, insets 0&quot;));</span>
<span class="nc" id="L1519">		}</span>

		/**
		 * Initialize this WarehousePanel.
		 */
		public void initialize() {
<span class="nc" id="L1525">			cleanup();</span>
<span class="nc" id="L1526">			addPropertyChangeListeners();</span>
<span class="nc" id="L1527">			update();</span>
<span class="nc" id="L1528">		}</span>

		/**
		 * Clean up this WarehousePanel.
		 */
		public void cleanup() {
<span class="nc" id="L1534">			removePropertyChangeListeners();</span>
<span class="nc" id="L1535">			removeAll();</span>
<span class="nc" id="L1536">		}</span>

		/**
		 * Add the property change listeners to this panel.
		 */
		protected void addPropertyChangeListeners() {
<span class="nc" id="L1542">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc" id="L1544">				colony.getGoodsContainer().addPropertyChangeListener(this);</span>
			}
<span class="nc" id="L1546">		}</span>

		/**
		 * Remove the property change listeners from this panel.
		 */
		protected void removePropertyChangeListeners() {
<span class="nc" id="L1552">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc" id="L1554">				colony.getGoodsContainer().removePropertyChangeListener(this);</span>
			}
<span class="nc" id="L1556">		}</span>

		/**
		 * Update this WarehousePanel.
		 */
		public void update() {
<span class="nc" id="L1562">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1563" title="All 2 branches missed.">			if (colony == null)</span>
<span class="nc" id="L1564">				return;</span>
<span class="nc" id="L1565">			removeAll();</span>

<span class="nc" id="L1567">			ClientOptions options = getClientOptions();</span>
<span class="nc bnc" id="L1568" title="All 2 branches missed.">			final int threshold = (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) ? 1</span>
<span class="nc" id="L1569">					: options.getInteger(ClientOptions.MIN_NUMBER_FOR_DISPLAYING_GOODS);</span>
<span class="nc" id="L1570">			final Game game = colony.getGame();</span>
<span class="nc" id="L1571">			final Specification spec = colony.getSpecification();</span>
<span class="nc bnc" id="L1572" title="All 2 branches missed.">			for (GoodsType goodsType : spec.getStorableGoodsTypeList()) {</span>
<span class="nc" id="L1573">				int count = colony.getGoodsCount(goodsType);</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">				if (count &gt;= threshold) {</span>
<span class="nc" id="L1575">					Goods goods = new Goods(game, colony, goodsType, count);</span>
<span class="nc" id="L1576">					GoodsLabel goodsLabel = new GoodsLabel(getGUI(), goods);</span>
<span class="nc bnc" id="L1577" title="All 2 branches missed.">					if (ColonyPanel.this.isEditable()) {</span>
<span class="nc" id="L1578">						goodsLabel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L1579">						goodsLabel.addMouseListener(pressListener);</span>
					}
<span class="nc" id="L1581">					add(goodsLabel, false);</span>
				}
<span class="nc" id="L1583">			}</span>
<span class="nc" id="L1584">			ColonyPanel.this.updateProduction();</span>
<span class="nc" id="L1585">			revalidate();</span>
<span class="nc" id="L1586">			repaint();</span>
<span class="nc" id="L1587">		}</span>

		// Interface DropTarget

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Unit unit) {
<span class="nc" id="L1595">			return false;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Goods goods) {
<span class="nc" id="L1602">			return true;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public Component add(Component comp, boolean editState) {
<span class="nc bnc" id="L1609" title="All 2 branches missed.">			if (editState) {</span>
<span class="nc bnc" id="L1610" title="All 2 branches missed.">				if (!(comp instanceof GoodsLabel)) {</span>
<span class="nc" id="L1611">					logger.warning(&quot;Invalid component: &quot; + comp);</span>
<span class="nc" id="L1612">					return null;</span>
				}
<span class="nc" id="L1614">				comp.getParent().remove(comp);</span>
<span class="nc" id="L1615">				return comp;</span>
			}

<span class="nc" id="L1618">			return add(comp);</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public int suggested(GoodsType type) {
<span class="nc" id="L1625">			Colony colony = getColony();</span>
<span class="nc" id="L1626">			return colony.getWarehouseCapacity() - colony.getGoodsCount(type);</span>
		}

		// Interface PropertyChangeListener

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void propertyChange(PropertyChangeEvent event) {
<span class="nc" id="L1636">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1637" title="All 4 branches missed.">			if (colony != null &amp;&amp; event != null) {</span>
<span class="nc" id="L1638">				logger.finest(colony.getName() + &quot;-warehouse change &quot; + event.getPropertyName() + &quot;: &quot;</span>
<span class="nc" id="L1639">						+ event.getOldValue() + &quot; -&gt; &quot; + event.getNewValue());</span>
			}
<span class="nc" id="L1641">			update();</span>
<span class="nc" id="L1642">		}</span>

		// Override JPanel

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String getUIClassID() {
<span class="nc" id="L1651">			return &quot;WarehousePanelUI&quot;;</span>
		}

		// Override Component

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void removeNotify() {
<span class="nc" id="L1661">			super.removeNotify();</span>

<span class="nc" id="L1663">			removeAll();</span>
<span class="nc" id="L1664">			setLayout(null);</span>
<span class="nc" id="L1665">		}</span>
	}

	/**
	 * This panel is a list of the colony's buildings.
	 */
	public final class BuildingsPanel extends JPanel {

		/**
		 * Creates this BuildingsPanel.
		 */
<span class="nc" id="L1676">		public BuildingsPanel() {</span>
<span class="nc" id="L1677">			setLayout(new MigLayout(&quot;fill, wrap 4, insets 0, gap 0:10:10:push&quot;));</span>
<span class="nc" id="L1678">		}</span>

		/**
		 * Initializes the game data in this buildings panel.
		 */
		public void initialize() {
<span class="nc" id="L1684">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1685" title="All 2 branches missed.">			if (colony == null)</span>
<span class="nc" id="L1686">				return;</span>
<span class="nc" id="L1687">			cleanup();</span>

<span class="nc" id="L1689">			List&lt;Building&gt; buildings = colony.getBuildings();</span>
<span class="nc" id="L1690">			Collections.sort(buildings);</span>
<span class="nc bnc" id="L1691" title="All 2 branches missed.">			for (Building building : buildings) {</span>
<span class="nc" id="L1692">				ASingleBuildingPanel aSBP = new ASingleBuildingPanel(building);</span>
<span class="nc" id="L1693">				aSBP.initialize();</span>
<span class="nc" id="L1694">				add(aSBP);</span>
<span class="nc" id="L1695">			}</span>

<span class="nc" id="L1697">			update();</span>
<span class="nc" id="L1698">		}</span>

		/**
		 * Clean up this buildings panel.
		 */
		public void cleanup() {
<span class="nc bnc" id="L1704" title="All 2 branches missed.">			for (Component component : getComponents()) {</span>
<span class="nc bnc" id="L1705" title="All 2 branches missed.">				if (component instanceof ASingleBuildingPanel) {</span>
<span class="nc" id="L1706">					((ASingleBuildingPanel) component).cleanup();</span>
				}
			}
<span class="nc" id="L1709">			removeAll();</span>
<span class="nc" id="L1710">		}</span>

		/**
		 * Update this buildings panel.
		 */
		public void update() {
<span class="nc bnc" id="L1716" title="All 2 branches missed.">			for (Component component : getComponents()) {</span>
<span class="nc bnc" id="L1717" title="All 2 branches missed.">				if (component instanceof ASingleBuildingPanel) {</span>
<span class="nc" id="L1718">					((ASingleBuildingPanel) component).update();</span>
				}
			}

<span class="nc" id="L1722">			repaint();</span>
<span class="nc" id="L1723">		}</span>

		// Override JPanel

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String getUIClassID() {
<span class="nc" id="L1732">			return &quot;BuildingsPanelUI&quot;;</span>
		}

		// Override Component

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void removeNotify() {
<span class="nc" id="L1742">			super.removeNotify();</span>

<span class="nc" id="L1744">			removeAll();</span>
<span class="nc" id="L1745">			setLayout(null);</span>
<span class="nc" id="L1746">		}</span>

		/**
		 * This panel is a single line (one building) in the
		 * &lt;code&gt;BuildingsPanel&lt;/code&gt;.
		 */
		public final class ASingleBuildingPanel extends BuildingPanel implements DropTarget {

			/** The build queue listener. */
<span class="nc" id="L1755">			private final MouseAdapter buildQueueListener = new MouseAdapter() {</span>
				@Override
				public void mousePressed(MouseEvent e) {
<span class="nc" id="L1758">					getGUI().showBuildQueuePanel(getColony());</span>
<span class="nc" id="L1759">				}</span>
			};

			/**
			 * Creates this ASingleBuildingPanel.
			 *
			 * @param building
			 *            The &lt;code&gt;Building&lt;/code&gt; to display information from.
			 */
<span class="nc" id="L1768">			public ASingleBuildingPanel(Building building) {</span>
<span class="nc" id="L1769">				super(getFreeColClient(), building);</span>

<span class="nc" id="L1771">				setOpaque(false);</span>
<span class="nc" id="L1772">			}</span>

			/**
			 * {@inheritDoc}
			 */
			@Override
			public void initialize() {
<span class="nc bnc" id="L1779" title="All 2 branches missed.">				if (ColonyPanel.this.isEditable()) {</span>
<span class="nc" id="L1780">					super.initialize();</span>

<span class="nc" id="L1782">					addMouseListener(releaseListener);</span>
<span class="nc" id="L1783">					addMouseListener(buildQueueListener);</span>
<span class="nc" id="L1784">					setTransferHandler(defaultTransferHandler);</span>
				}
<span class="nc" id="L1786">			}</span>

			/**
			 * {@inheritDoc}
			 */
			@Override
			public void cleanup() {
<span class="nc" id="L1793">				super.cleanup();</span>

<span class="nc" id="L1795">				removeMouseListener(releaseListener);</span>
<span class="nc" id="L1796">				removeMouseListener(buildQueueListener);</span>
<span class="nc" id="L1797">				setTransferHandler(null);</span>
<span class="nc" id="L1798">				removeAll();</span>
<span class="nc" id="L1799">			}</span>

			/**
			 * {@inheritDoc}
			 */
			@Override
			public void update() {
<span class="nc" id="L1806">				super.update();</span>

<span class="nc bnc" id="L1808" title="All 2 branches missed.">				if (ColonyPanel.this.isEditable()) {</span>
<span class="nc bnc" id="L1809" title="All 2 branches missed.">					for (UnitLabel unitLabel : getUnitLabels()) {</span>
<span class="nc" id="L1810">						unitLabel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L1811">						unitLabel.addMouseListener(pressListener);</span>
<span class="nc" id="L1812">					}</span>
				}
<span class="nc" id="L1814">			}</span>

			/**
			 * Try to assign a unit to work this building.
			 *
			 * @param unit
			 *            The &lt;code&gt;Unit&lt;/code&gt; to try.
			 * @return True if the work begins.
			 */
			private boolean tryWork(Unit unit) {
<span class="nc" id="L1824">				Building building = getBuilding();</span>
<span class="nc" id="L1825">				NoAddReason reason = building.getNoAddReason(unit);</span>
<span class="nc bnc" id="L1826" title="All 2 branches missed.">				if (reason != NoAddReason.NONE) {</span>
<span class="nc" id="L1827">					getGUI().showInformationMessage(building, reason.getDescriptionKey());</span>
<span class="nc" id="L1828">					return false;</span>
				}

<span class="nc" id="L1831">				return ColonyPanel.this.tryWork(unit, building);</span>
			}

			// Interface DropTarget

			/**
			 * {@inheritDoc}
			 */
			public boolean accepts(Unit unit) {
<span class="nc" id="L1840">				return unit.isPerson();</span>
			}

			/**
			 * {@inheritDoc}
			 */
			public boolean accepts(Goods goods) {
<span class="nc" id="L1847">				return false;</span>
			}

			/**
			 * {@inheritDoc}
			 */
			public Component add(Component comp, boolean editState) {
<span class="nc bnc" id="L1854" title="All 2 branches missed.">				if (editState) {</span>
<span class="nc bnc" id="L1855" title="All 2 branches missed.">					if (comp instanceof UnitLabel) {</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">						if (!tryWork(((UnitLabel) comp).getUnit()))</span>
<span class="nc" id="L1857">							return null;</span>
					} else {
<span class="nc" id="L1859">						logger.warning(&quot;An invalid component was dropped&quot; + &quot; on this ASingleBuildingPanel.&quot;);</span>
<span class="nc" id="L1860">						return null;</span>
					}
<span class="nc" id="L1862">					update();</span>
				}
<span class="nc" id="L1864">				return null;</span>
			}

			/**
			 * {@inheritDoc}
			 */
			public int suggested(GoodsType type) {
<span class="nc" id="L1871">				return -1;</span>
			} // N/A

			// Interface PropertyChangeListener

			/**
			 * {@inheritDoc}
			 */
			@Override
			public void propertyChange(PropertyChangeEvent event) {
<span class="nc" id="L1881">				super.propertyChange(event);</span>

<span class="nc" id="L1883">				ColonyPanel.this.updateProduction();</span>
<span class="nc" id="L1884">			}</span>
		}
	}

	/**
	 * A panel that displays the tiles in the immediate area around the colony.
	 * TilesPanel class must use the ImageLibrary inside SwingGUI.tileMapViewer
	 * for everything.
	 */
	public final class TilesPanel extends JPanel {

		/** The tiles around the colony. */
<span class="nc" id="L1896">		private final Tile[][] tiles = new Tile[3][3];</span>

		/**
		 * Creates a TilesPanel.
		 */
<span class="nc" id="L1901">		public TilesPanel() {</span>
<span class="nc" id="L1902">			setBackground(Color.BLACK);</span>
<span class="nc" id="L1903">			setBorder(null);</span>
<span class="nc" id="L1904">			setLayout(null);</span>
<span class="nc" id="L1905">		}</span>

		/**
		 * Initialize the game data in this tiles panel.
		 */
		public void initialize() {
<span class="nc" id="L1911">			final Colony colony = getColony();</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">			if (colony == null)</span>
<span class="nc" id="L1913">				return;</span>
<span class="nc" id="L1914">			cleanup();</span>

<span class="nc" id="L1916">			Tile tile = colony.getTile();</span>
<span class="nc" id="L1917">			tiles[0][0] = tile.getNeighbourOrNull(Direction.N);</span>
<span class="nc" id="L1918">			tiles[0][1] = tile.getNeighbourOrNull(Direction.NE);</span>
<span class="nc" id="L1919">			tiles[0][2] = tile.getNeighbourOrNull(Direction.E);</span>
<span class="nc" id="L1920">			tiles[1][0] = tile.getNeighbourOrNull(Direction.NW);</span>
<span class="nc" id="L1921">			tiles[1][1] = tile;</span>
<span class="nc" id="L1922">			tiles[1][2] = tile.getNeighbourOrNull(Direction.SE);</span>
<span class="nc" id="L1923">			tiles[2][0] = tile.getNeighbourOrNull(Direction.W);</span>
<span class="nc" id="L1924">			tiles[2][1] = tile.getNeighbourOrNull(Direction.SW);</span>
<span class="nc" id="L1925">			tiles[2][2] = tile.getNeighbourOrNull(Direction.S);</span>

<span class="nc" id="L1927">			int layer = 2;</span>
<span class="nc bnc" id="L1928" title="All 2 branches missed.">			for (int x = 0; x &lt; 3; x++) {</span>
<span class="nc bnc" id="L1929" title="All 2 branches missed.">				for (int y = 0; y &lt; 3; y++) {</span>
<span class="nc bnc" id="L1930" title="All 2 branches missed.">					if (tiles[x][y] == null)</span>
<span class="nc" id="L1931">						continue;</span>
<span class="nc" id="L1932">					ColonyTile colonyTile = colony.getColonyTile(tiles[x][y]);</span>
<span class="nc" id="L1933">					ASingleTilePanel aSTP = new ASingleTilePanel(colonyTile, x, y);</span>
<span class="nc" id="L1934">					aSTP.initialize();</span>
<span class="nc" id="L1935">					add(aSTP, Integer.valueOf(layer++));</span>
				}
			}

<span class="nc" id="L1939">			update();</span>
<span class="nc" id="L1940">		}</span>

		/**
		 * Clean up this tiles panel.
		 */
		public void cleanup() {
<span class="nc bnc" id="L1946" title="All 2 branches missed.">			for (Component component : getComponents()) {</span>
<span class="nc bnc" id="L1947" title="All 2 branches missed.">				if (component instanceof ASingleTilePanel) {</span>
<span class="nc" id="L1948">					((ASingleTilePanel) component).cleanup();</span>
				}
			}
<span class="nc" id="L1951">			removeAll();</span>
<span class="nc" id="L1952">		}</span>

		/**
		 * Update this tiles panel.
		 */
		public void update() {
<span class="nc bnc" id="L1958" title="All 2 branches missed.">			for (Component component : getComponents()) {</span>
<span class="nc bnc" id="L1959" title="All 2 branches missed.">				if (component instanceof ASingleTilePanel) {</span>
<span class="nc" id="L1960">					((ASingleTilePanel) component).update();</span>
				}
			}
<span class="nc" id="L1963">			repaint();</span>
<span class="nc" id="L1964">		}</span>

		// Override JComponent

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void paintComponent(Graphics g) {
<span class="nc" id="L1973">			final Colony colony = getColony();</span>
<span class="nc" id="L1974">			g.setColor(Color.BLACK);</span>
<span class="nc" id="L1975">			g.fillRect(0, 0, getWidth(), getHeight());</span>
<span class="nc bnc" id="L1976" title="All 2 branches missed.">			if (colony == null)</span>
<span class="nc" id="L1977">				return;</span>

<span class="nc" id="L1979">			getGUI().displayColonyTiles((Graphics2D) g, tiles, colony);</span>
<span class="nc" id="L1980">		}</span>

		/**
		 * Panel for visualizing a &lt;code&gt;ColonyTile&lt;/code&gt;. The component itself
		 * is not visible, however the content of the component is (i.e. the
		 * people working and the production)
		 */
		public final class ASingleTilePanel extends JPanel implements DropTarget, PropertyChangeListener {

			/** The colony tile to monitor. */
			private final ColonyTile colonyTile;

			/**
			 * Create a new single tile panel.
			 *
			 * @param colonyTile
			 *            The &lt;code&gt;ColonyTile&lt;/code&gt; to monitor.
			 * @param x
			 *            The x offset.
			 * @param y
			 *            The y offset.
			 */
<span class="nc" id="L2002">			public ASingleTilePanel(ColonyTile colonyTile, int x, int y) {</span>
<span class="nc" id="L2003">				this.colonyTile = colonyTile;</span>

<span class="nc" id="L2005">				setLayout(new FlowLayout(FlowLayout.CENTER, 0, 0));</span>
<span class="nc" id="L2006">				setOpaque(false);</span>
				// Size and position:
<span class="nc" id="L2008">				Dimension size = getGUI().getTileImageLibrary().scaleDimension(ImageLibrary.TILE_SIZE);</span>
<span class="nc" id="L2009">				setSize(size);</span>
<span class="nc" id="L2010">				setLocation(((2 - x) + y) * size.width / 2, (x + y) * size.height / 2);</span>
<span class="nc" id="L2011">			}</span>

			/**
			 * Initialize this single tile panel.
			 */
			public void initialize() {
<span class="nc bnc" id="L2017" title="All 2 branches missed.">				if (ColonyPanel.this.isEditable()) {</span>
<span class="nc" id="L2018">					cleanup();</span>

<span class="nc" id="L2020">					addMouseListener(pressListener);</span>
<span class="nc" id="L2021">					addMouseListener(releaseListener);</span>
<span class="nc" id="L2022">					setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L2023">					addPropertyChangeListeners();</span>
				}
<span class="nc" id="L2025">			}</span>

			/**
			 * Clean up this single tile panel.
			 */
			public void cleanup() {
<span class="nc" id="L2031">				removeMouseListener(pressListener);</span>
<span class="nc" id="L2032">				removeMouseListener(releaseListener);</span>
<span class="nc" id="L2033">				setTransferHandler(null);</span>
<span class="nc" id="L2034">				removePropertyChangeListeners();</span>
<span class="nc" id="L2035">				removeAll();</span>
<span class="nc" id="L2036">			}</span>

			/**
			 * Adds the property change listeners.
			 */
			protected void addPropertyChangeListeners() {
<span class="nc bnc" id="L2042" title="All 2 branches missed.">				if (colonyTile != null) {</span>
<span class="nc" id="L2043">					colonyTile.addPropertyChangeListener(this);</span>
				}
<span class="nc" id="L2045">			}</span>

			/**
			 * Removes the property change listeners.
			 */
			protected void removePropertyChangeListeners() {
<span class="nc bnc" id="L2051" title="All 2 branches missed.">				if (colonyTile != null) {</span>
<span class="nc" id="L2052">					colonyTile.removePropertyChangeListener(this);</span>
				}
<span class="nc" id="L2054">			}</span>

			/**
			 * Update this single tile panel.
			 */
			public void update() {
<span class="nc" id="L2060">				removeAll();</span>

<span class="nc" id="L2062">				UnitLabel label = null;</span>
<span class="nc bnc" id="L2063" title="All 2 branches missed.">				for (Unit unit : colonyTile.getUnitList()) {</span>
<span class="nc" id="L2064">					label = new UnitLabel(getFreeColClient(), unit, false, false, true);</span>
<span class="nc bnc" id="L2065" title="All 2 branches missed.">					if (ColonyPanel.this.isEditable()) {</span>
<span class="nc" id="L2066">						label.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L2067">						label.addMouseListener(pressListener);</span>
					}
<span class="nc" id="L2069">					super.add(label);</span>
<span class="nc" id="L2070">				}</span>
<span class="nc" id="L2071">				updateDescriptionLabel(label, true);</span>
<span class="nc bnc" id="L2072" title="All 2 branches missed.">				if (colonyTile.isColonyCenterTile()) {</span>
<span class="nc" id="L2073">					setLayout(new GridLayout(2, 1));</span>
<span class="nc" id="L2074">					ProductionInfo info = colony.getProductionInfo(colonyTile);</span>
<span class="nc bnc" id="L2075" title="All 2 branches missed.">					if (info != null) {</span>
<span class="nc bnc" id="L2076" title="All 2 branches missed.">						for (AbstractGoods ag : info.getProduction()) {</span>
<span class="nc" id="L2077">							ProductionLabel productionLabel = new ProductionLabel(getFreeColClient(),</span>
<span class="nc" id="L2078">									getGUI().getTileImageLibrary(), ag);</span>
<span class="nc" id="L2079">							productionLabel.addMouseListener(pressListener);</span>
<span class="nc" id="L2080">							add(productionLabel);</span>
<span class="nc" id="L2081">						}</span>
					}
				}
<span class="nc" id="L2084">			}</span>

			/**
			 * Gets the colony tile this panel is handling.
			 *
			 * @return The colony tile.
			 */
			public ColonyTile getColonyTile() {
<span class="nc" id="L2092">				return colonyTile;</span>
			}

			/**
			 * Updates the description label, which is a tooltip with the
			 * terrain type, road and plow indicator, if any.
			 * 
			 * If a unit is on it update the tooltip of it instead.
			 *
			 * @param unitLabel
			 *            the unit label
			 * @param toAdd
			 *            the to add
			 */
			private void updateDescriptionLabel(UnitLabel unitLabel, boolean toAdd) {
<span class="nc" id="L2107">				String tileMsg = Messages.message(colonyTile.getLabel());</span>
<span class="nc bnc" id="L2108" title="All 2 branches missed.">				if (unitLabel == null) {</span>
<span class="nc" id="L2109">					setToolTipText(tileMsg);</span>
				} else {
<span class="nc" id="L2111">					String unitMsg = unitLabel.getUnit().getDescription(Unit.UnitLabelType.NATIONAL);</span>
<span class="nc bnc" id="L2112" title="All 2 branches missed.">					if (toAdd)</span>
<span class="nc" id="L2113">						unitMsg = tileMsg + &quot; [&quot; + unitMsg + &quot;]&quot;;</span>
<span class="nc" id="L2114">					unitLabel.setDescriptionLabel(unitMsg);</span>
				}
<span class="nc" id="L2116">			}</span>

			/**
			 * Try to work this tile with a specified unit.
			 *
			 * @param unit
			 *            The &lt;code&gt;Unit&lt;/code&gt; to work the tile.
			 * @return True if the unit succeeds.
			 */
			private boolean tryWork(Unit unit) {
<span class="nc" id="L2126">				final Colony colony = getColony();</span>
<span class="nc" id="L2127">				Tile tile = colonyTile.getWorkTile();</span>
<span class="nc" id="L2128">				Player player = unit.getOwner();</span>

<span class="nc bnc" id="L2130" title="All 2 branches missed.">				if (tile.getOwningSettlement() != colony) {</span>
					// Need to acquire the tile before working it.
<span class="nc" id="L2132">					NoClaimReason claim = player.canClaimForSettlementReason(tile);</span>
<span class="nc bnc" id="L2133" title="All 2 branches missed.">					switch (claim) {</span>
					case NONE:
					case NATIVES:
<span class="nc bnc" id="L2136" title="All 4 branches missed.">						if (igc().claimTile(tile, colony) &amp;&amp; tile.getOwningSettlement() == colony) {</span>
<span class="nc" id="L2137">							logger.info(&quot;Colony &quot; + colony.getName() + &quot; claims tile &quot; + tile + &quot; with unit &quot;</span>
<span class="nc" id="L2138">									+ unit.getId());</span>
						} else {
<span class="nc" id="L2140">							logger.warning(&quot;Colony &quot; + colony.getName() + &quot; did not claim &quot; + tile + &quot; with unit &quot;</span>
<span class="nc" id="L2141">									+ unit.getId());</span>
<span class="nc" id="L2142">							return false;</span>
						}
						break;
					default: // Otherwise, can not use land
<span class="nc" id="L2146">						getGUI().showInformationMessage(tile, claim.getDescriptionKey());</span>
<span class="nc" id="L2147">						return false;</span>
					}
					// Check reason again, claim should be satisfied.
<span class="nc bnc" id="L2150" title="All 2 branches missed.">					if (tile.getOwningSettlement() != colony) {</span>
<span class="nc" id="L2151">						throw new IllegalStateException(&quot;Claim failed&quot;);</span>
					}
				}

				// Claim sorted, but complain about other failure.
<span class="nc" id="L2156">				NoAddReason reason = colonyTile.getNoAddReason(unit);</span>
<span class="nc bnc" id="L2157" title="All 2 branches missed.">				if (reason != NoAddReason.NONE) {</span>
<span class="nc" id="L2158">					getGUI().showInformationMessage(colonyTile, StringTemplate.template(reason.getDescriptionKey()));</span>
<span class="nc" id="L2159">					return false;</span>
				}

<span class="nc bnc" id="L2162" title="All 2 branches missed.">				if (!ColonyPanel.this.tryWork(unit, colonyTile))</span>
<span class="nc" id="L2163">					return false;</span>

<span class="nc" id="L2165">				GoodsType workType = unit.getWorkType();</span>
<span class="nc bnc" id="L2166" title="All 4 branches missed.">				if (workType != null &amp;&amp; getClientOptions().getBoolean(ClientOptions.SHOW_NOT_BEST_TILE)) {</span>
<span class="nc" id="L2167">					WorkLocation best = colony.getWorkLocationFor(unit, workType);</span>
<span class="nc bnc" id="L2168" title="All 4 branches missed.">					if (best != null &amp;&amp; colonyTile != best &amp;&amp; (colonyTile.getPotentialProduction(workType,</span>
<span class="nc bnc" id="L2169" title="All 2 branches missed.">							unit.getType()) &lt; best.getPotentialProduction(workType, unit.getType()))) {</span>
<span class="nc" id="L2170">						StringTemplate template = StringTemplate.template(&quot;colonyPanel.notBestTile&quot;)</span>
<span class="nc" id="L2171">								.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL))</span>
<span class="nc" id="L2172">								.addNamed(&quot;%goods%&quot;, workType).addStringTemplate(&quot;%tile%&quot;, best.getLabel());</span>
<span class="nc" id="L2173">						getGUI().showInformationMessage(best, template);</span>
					}
				}
<span class="nc" id="L2176">				return true;</span>
			}

			// Interface DropTarget

			/**
			 * {@inheritDoc}
			 */
			public boolean accepts(Unit unit) {
<span class="nc" id="L2185">				return unit.isPerson();</span>
			}

			/**
			 * {@inheritDoc}
			 */
			public boolean accepts(Goods goods) {
<span class="nc" id="L2192">				return false;</span>
			}

			/**
			 * {@inheritDoc}
			 */
			public Component add(Component comp, boolean editState) {
<span class="nc bnc" id="L2199" title="All 2 branches missed.">				if (editState) {</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">					if (comp instanceof UnitLabel) {</span>
<span class="nc" id="L2201">						UnitLabel label = (UnitLabel) comp;</span>
<span class="nc bnc" id="L2202" title="All 2 branches missed.">						if (!tryWork(label.getUnit()))</span>
<span class="nc" id="L2203">							return null;</span>
<span class="nc" id="L2204">						label.setSmall(false);</span>
<span class="nc" id="L2205">					} else {</span>
<span class="nc" id="L2206">						logger.warning(&quot;An invalid component was dropped&quot; + &quot; on this ASingleTilePanel.&quot;);</span>
<span class="nc" id="L2207">						return null;</span>
					}
				}

<span class="nc" id="L2211">				update();</span>
<span class="nc" id="L2212">				return comp;</span>
			}

			/**
			 * {@inheritDoc}
			 */
			public int suggested(GoodsType type) {
<span class="nc" id="L2219">				return -1;</span>
			} // N/A

			// Interface PropertyChangeListener

			/**
			 * {@inheritDoc}
			 */
			@Override
			public void propertyChange(PropertyChangeEvent event) {
<span class="nc" id="L2229">				String property = event.getPropertyName();</span>
<span class="nc" id="L2230">				logger.finest(colonyTile.getId() + &quot; change &quot; + property + &quot;: &quot; + event.getOldValue() + &quot; -&gt; &quot;</span>
<span class="nc" id="L2231">						+ event.getNewValue());</span>
<span class="nc" id="L2232">				ColonyPanel.this.updateProduction();</span>
<span class="nc" id="L2233">			}</span>

			// Override JComponent

			/**
			 * Checks if this &lt;code&gt;JComponent&lt;/code&gt; contains the given
			 * coordinate.
			 *
			 * @param px
			 *            The x coordinate to check.
			 * @param py
			 *            The y coordinate to check.
			 * @return true, if successful
			 */
			@Override
			public boolean contains(int px, int py) {
<span class="nc" id="L2249">				int w = getWidth();</span>
<span class="nc" id="L2250">				int h = getHeight();</span>
<span class="nc" id="L2251">				int dx = Math.abs(w / 2 - px);</span>
<span class="nc" id="L2252">				int dy = Math.abs(h / 2 - py);</span>
<span class="nc bnc" id="L2253" title="All 2 branches missed.">				return (dx + w * dy / h) &lt;= w / 2;</span>
			}
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>