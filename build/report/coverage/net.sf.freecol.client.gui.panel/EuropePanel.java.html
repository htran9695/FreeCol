<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EuropePanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui.panel</a> &gt; <span class="el_source">EuropePanel.java</span></div><h1>EuropePanel.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui.panel;

import java.awt.Component;
import java.awt.GridLayout;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.MouseListener;
import java.util.Iterator;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.swing.ComponentInputMap;
import javax.swing.InputMap;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTextPane;
import javax.swing.KeyStroke;
import javax.swing.ScrollPaneConstants;
import javax.swing.SwingUtilities;
import javax.swing.text.SimpleAttributeSet;
import javax.swing.text.StyleConstants;
import javax.swing.text.StyledDocument;

import net.miginfocom.swing.MigLayout;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.control.InGameController.BoycottAction;
import net.sf.freecol.client.gui.ImageLibrary;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighSeas;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.MarketData;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.TransactionListener;
import net.sf.freecol.common.model.Unit;

/**
 * This is a panel for the Europe display. It shows the ships in Europe and
 * allows the user to send them back.
 */
public final class EuropePanel extends PortPanel {

	/** The Constant logger. */
<span class="nc" id="L73">	private static final Logger logger = Logger.getLogger(EuropePanel.class.getName());</span>

	/**
	 * A panel to hold unit labels that represent units that are going to
	 * America or Europe.
	 */
<span class="nc" id="L79">	private final class DestinationPanel extends JPanel implements DropTarget {</span>

		/** The destination. */
		private Location destination;

		/**
		 * Initialize this DestinationPanel.
		 *
		 * @param destination
		 *            the destination
		 */
		public void initialize(Location destination) {
<span class="nc" id="L91">			this.destination = destination;</span>
<span class="nc" id="L92">			update();</span>
<span class="nc" id="L93">		}</span>

		/**
		 * Cleans up this DestinationPanel.
		 */
		public void cleanup() {
<span class="nc" id="L99">		}</span>

		/**
		 * Update this DestinationPanel.
		 */
		public void update() {
<span class="nc" id="L105">			removeAll();</span>

<span class="nc" id="L107">			HighSeas highSeas = getMyPlayer().getHighSeas();</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">			if (highSeas != null) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">				for (Unit unit : highSeas.getUnitList()) {</span>
					boolean belongs;
<span class="nc bnc" id="L111" title="All 2 branches missed.">					if (destination instanceof Europe) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">						belongs = unit.getDestination() == destination;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">					} else if (destination instanceof Map) {</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">						belongs = unit.getDestination() == destination</span>
<span class="nc bnc" id="L115" title="All 4 branches missed.">								|| (unit.getDestination() != null &amp;&amp; unit.getDestination().getTile() != null</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">										&amp;&amp; unit.getDestination().getTile().getMap() == destination);</span>
					} else {
<span class="nc" id="L118">						logger.warning(&quot;Bogus DestinationPanel location: &quot; + destination + &quot; for unit: &quot; + unit);</span>
<span class="nc" id="L119">						belongs = false;</span>
					}
<span class="nc bnc" id="L121" title="All 2 branches missed.">					if (belongs) {</span>
<span class="nc" id="L122">						UnitLabel unitLabel = new UnitLabel(getFreeColClient(), unit);</span>
<span class="nc" id="L123">						unitLabel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L124">						unitLabel.addMouseListener(pressListener);</span>
<span class="nc" id="L125">						add(unitLabel);</span>
					}
<span class="nc" id="L127">				}</span>
			}

			// &quot;ship&quot; is a tag, not a key
<span class="nc" id="L131">			Utility.localizeBorder(this, Unit.getDestinationLabel(&quot;ship&quot;, destination, getMyPlayer()));</span>
<span class="nc" id="L132">			revalidate();</span>
<span class="nc" id="L133">		}</span>

		// Interface DropTarget

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Unit unit) {
<span class="nc bnc" id="L141" title="All 4 branches missed.">			return unit.isNaval() &amp;&amp; !unit.isDamaged();</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Goods goods) {
<span class="nc" id="L148">			return false;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public Component add(Component comp, boolean editState) {
<span class="nc bnc" id="L155" title="All 2 branches missed.">			if (editState) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">				if (!(comp instanceof UnitLabel)) {</span>
<span class="nc" id="L157">					logger.warning(&quot;Invalid component: &quot; + comp);</span>
<span class="nc" id="L158">					return null;</span>
				}
<span class="nc" id="L160">				final Unit unit = ((UnitLabel) comp).getUnit();</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">				if (unit.getTradeRoute() != null) {</span>
<span class="nc bnc" id="L163" title="All 4 branches missed.">					if (!getGUI().confirmClearTradeRoute(unit) || !igc().assignTradeRoute(unit, null))</span>
<span class="nc" id="L164">						return null;</span>
				}

<span class="nc" id="L167">				Location dest = destination;</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">				if (unit.isInEurope()) {</span>
<span class="nc" id="L169">					dest = getGUI().showSelectDestinationDialog(unit);</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">					if (dest == null)</span>
<span class="nc" id="L171">						return null; // user aborted</span>
				}

<span class="nc" id="L174">				final ClientOptions co = getClientOptions();</span>
<span class="nc bnc" id="L175" title="All 6 branches missed.">				if (!co.getBoolean(ClientOptions.AUTOLOAD_EMIGRANTS) &amp;&amp; unit.isInEurope()</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">						&amp;&amp; !(destination instanceof Europe) &amp;&amp; docksPanel.getComponentCount() &gt; 0</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">						&amp;&amp; unit.hasSpaceLeft()) {</span>
<span class="nc" id="L178">					StringTemplate locName = destination.getLocationLabelFor(unit.getOwner());</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">					if (!getGUI().confirm(null, StringTemplate.template(&quot;europePanel.leaveColonists&quot;)</span>
<span class="nc" id="L180">							.addStringTemplate(&quot;%newWorld%&quot;, locName), unit, &quot;ok&quot;, &quot;cancel&quot;))</span>
<span class="nc" id="L181">						return null;</span>
				}

<span class="nc" id="L184">				comp.getParent().remove(comp);</span>
<span class="nc" id="L185">				igc().moveTo(unit, dest);</span>
<span class="nc" id="L186">				inPortPanel.update();</span>
<span class="nc" id="L187">				docksPanel.update();</span>
<span class="nc" id="L188">				cargoPanel.update();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">				if (unit == cargoPanel.getCarrier()) {</span>
<span class="nc" id="L190">					cargoPanel.setCarrier(null);</span>
				}
			}

<span class="nc" id="L194">			Component c = add(comp);</span>
<span class="nc" id="L195">			revalidate();</span>
<span class="nc" id="L196">			EuropePanel.this.refresh();</span>
<span class="nc" id="L197">			return c;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public int suggested(GoodsType type) {
<span class="nc" id="L204">			return -1;</span>
		} // N/A
	}

	/**
	 * A panel that holds UnitLabels that represent Units that are waiting on
	 * the docks in Europe.
	 */
	public final class DocksPanel extends UnitPanel implements DropTarget {

		/**
		 * Instantiates a new docks panel.
		 */
<span class="nc" id="L217">		public DocksPanel() {</span>
<span class="nc" id="L218">			super(EuropePanel.this, &quot;Europe - docks&quot;, true);</span>

<span class="nc" id="L220">			setLayout(new MigLayout(&quot;wrap 6&quot;));</span>
<span class="nc" id="L221">		}</span>

		/*
		 * (non-Javadoc)
		 * 
		 * @see
		 * net.sf.freecol.client.gui.panel.UnitPanel#addPropertyChangeListeners(
		 * )
		 */
		@Override
		public void addPropertyChangeListeners() {
<span class="nc" id="L232">			europe.addPropertyChangeListener(this);</span>
<span class="nc" id="L233">		}</span>

		/*
		 * (non-Javadoc)
		 * 
		 * @see net.sf.freecol.client.gui.panel.UnitPanel#
		 * removePropertyChangeListeners()
		 */
		@Override
		public void removePropertyChangeListeners() {
<span class="nc" id="L243">			europe.removePropertyChangeListener(this);</span>
<span class="nc" id="L244">		}</span>

		// Interface DropTarget

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Unit unit) {
<span class="nc bnc" id="L252" title="All 2 branches missed.">			return !unit.isNaval();</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Goods goods) {
<span class="nc" id="L259">			return false;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public Component add(Component comp, boolean editState) {
<span class="nc" id="L266">			Component c = add(comp);</span>
<span class="nc" id="L267">			update();</span>
<span class="nc" id="L268">			return c;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public int suggested(GoodsType type) {
<span class="nc" id="L275">			return -1;</span>
		} // N/A

		// Override Container

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void remove(Component comp) {
<span class="nc" id="L285">			update();</span>
<span class="nc" id="L286">		}</span>
	}

	/**
	 * The Class EuropeButton.
	 */
	private static final class EuropeButton extends JButton {

		/**
		 * Instantiates a new europe button.
		 *
		 * @param text
		 *            the text
		 * @param keyEvent
		 *            the key event
		 * @param command
		 *            the command
		 * @param listener
		 *            the listener
		 */
<span class="nc" id="L306">		public EuropeButton(String text, int keyEvent, String command, ActionListener listener) {</span>
<span class="nc" id="L307">			setOpaque(true);</span>
<span class="nc" id="L308">			setText(text);</span>
<span class="nc" id="L309">			setActionCommand(command);</span>
<span class="nc" id="L310">			addActionListener(listener);</span>
<span class="nc" id="L311">			InputMap closeInputMap = new ComponentInputMap(this);</span>
<span class="nc" id="L312">			closeInputMap.put(KeyStroke.getKeyStroke(keyEvent, 0, false), &quot;pressed&quot;);</span>
<span class="nc" id="L313">			closeInputMap.put(KeyStroke.getKeyStroke(keyEvent, 0, true), &quot;released&quot;);</span>
<span class="nc" id="L314">			SwingUtilities.replaceUIInputMap(this, JComponent.WHEN_IN_FOCUSED_WINDOW, closeInputMap);</span>
<span class="nc" id="L315">		}</span>
	}

	/**
	 * A panel that holds unit labels that represent naval units that are
	 * waiting in Europe.
	 */
	private final class EuropeInPortPanel extends InPortPanel {

		/**
		 * Instantiates a new europe in port panel.
		 */
<span class="nc" id="L327">		public EuropeInPortPanel() {</span>
<span class="nc" id="L328">			super(EuropePanel.this, &quot;Europe - port&quot;, true);</span>
<span class="nc" id="L329">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		protected void addPropertyChangeListeners() {
<span class="nc" id="L336">			europe.addPropertyChangeListener(this);</span>
<span class="nc" id="L337">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		protected void removePropertyChangeListeners() {
<span class="nc" id="L344">			europe.removePropertyChangeListener(this);</span>
<span class="nc" id="L345">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public boolean accepts(Unit unit) {
<span class="nc bnc" id="L352" title="All 2 branches missed.">			if (!unit.isNaval())</span>
<span class="nc" id="L353">				return false;</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">			switch (unit.getState()) {</span>
			case ACTIVE:
			case FORTIFIED:
			case FORTIFYING:
			case SENTRY:
			case SKIPPED:
<span class="nc" id="L360">				return true;</span>
			}
<span class="nc" id="L362">			return false;</span>
		}
	}

	/**
	 * A panel that shows goods available for purchase in Europe.
	 */
	private final class MarketPanel extends JPanel implements DropTarget {

		/**
		 * Creates this MarketPanel.
		 *
		 * @param europePanel
		 *            The panel that holds this CargoPanel.
		 */
<span class="nc" id="L377">		public MarketPanel(EuropePanel europePanel) {</span>
<span class="nc" id="L378">			super(new GridLayout(2, 8));</span>
<span class="nc" id="L379">		}</span>

		/**
		 * Initialize this MarketPanel.
		 */
		public void initialize() {
<span class="nc" id="L385">			removeAll();</span>

<span class="nc" id="L387">			final Market market = getMyPlayer().getMarket();</span>
<span class="nc" id="L388">			ImageLibrary lib = getImageLibrary();</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">			for (GoodsType goodsType : getSpecification().getStorableGoodsTypeList()) {</span>
<span class="nc" id="L390">				MarketLabel label = new MarketLabel(lib, goodsType, market);</span>
<span class="nc" id="L391">				label.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L392">				label.addMouseListener(pressListener);</span>
<span class="nc" id="L393">				MarketData md = market.getMarketData(goodsType);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">				if (md != null)</span>
<span class="nc" id="L395">					md.addPropertyChangeListener(label);</span>
<span class="nc" id="L396">				add(label);</span>
<span class="nc" id="L397">			}</span>
<span class="nc" id="L398">		}</span>

		/**
		 * Cleans up this MarketPanel.
		 */
		public void cleanup() {
<span class="nc" id="L404">		}</span>

		// Interface DropTarget

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Unit unit) {
<span class="nc" id="L412">			return false;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public boolean accepts(Goods goods) {
<span class="nc" id="L419">			return true;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public Component add(Component comp, boolean editState) {
<span class="nc bnc" id="L426" title="All 2 branches missed.">			if (editState) {</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">				if (!(comp instanceof GoodsLabel)) {</span>
<span class="nc" id="L428">					logger.warning(&quot;Invalid component: &quot; + comp);</span>
<span class="nc" id="L429">					return null;</span>
				}

<span class="nc" id="L432">				Goods goods = ((GoodsLabel) comp).getGoods();</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">				if (getMyPlayer().canTrade(goods.getType())) {</span>
<span class="nc" id="L434">					igc().sellGoods(goods);</span>
				} else {
<span class="nc" id="L436">					BoycottAction act = getGUI().getBoycottChoice(goods, europe);</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">					if (act != null) {</span>
<span class="nc bnc" id="L438" title="All 3 branches missed.">						switch (act) {</span>
						case PAY_ARREARS:
<span class="nc" id="L440">							igc().payArrears(goods.getType());</span>
<span class="nc" id="L441">							break;</span>
						case DUMP_CARGO:
<span class="nc" id="L443">							igc().unloadCargo(goods, true);</span>
<span class="nc" id="L444">							break;</span>
						default:
<span class="nc" id="L446">							logger.warning(&quot;showBoycottedGoodsDialog fail: &quot; + act);</span>
							break;
						}
					}
				}
<span class="nc" id="L451">				cargoPanel.revalidate();</span>
<span class="nc" id="L452">				revalidate();</span>
<span class="nc" id="L453">				igc().nextModelMessage();</span>
			}
<span class="nc" id="L455">			EuropePanel.this.refresh();</span>
<span class="nc" id="L456">			return comp;</span>
		}

		/**
		 * {@inheritDoc}
		 */
		public int suggested(GoodsType type) {
<span class="nc" id="L463">			return -1; // No good choice</span>
		}

		// Override Container

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void remove(Component comp) {
			// Don't remove market labels.
<span class="nc" id="L474">		}</span>
	}

	/**
	 * To log transactions made in Europe.
	 */
	private final class TransactionLog extends JTextPane implements TransactionListener {

		/**
		 * Creates a transaction log.
		 */
<span class="nc" id="L485">		public TransactionLog() {</span>
<span class="nc" id="L486">			setEditable(false);</span>
<span class="nc" id="L487">		}</span>

		/**
		 * Initializes this TransactionLog.
		 */
		public void initialize() {
<span class="nc" id="L493">			getMyPlayer().getMarket().addTransactionListener(this);</span>
<span class="nc" id="L494">			setText(&quot;&quot;);</span>
<span class="nc" id="L495">		}</span>

		/**
		 * Cleans up this TransactionLog.
		 */
		public void cleanup() {
<span class="nc" id="L501">			getMyPlayer().getMarket().removeTransactionListener(this);</span>
<span class="nc" id="L502">		}</span>

		/**
		 * Add text to the transaction log.
		 *
		 * @param text
		 *            The text to add.
		 */
		private void add(String text) {
<span class="nc" id="L511">			StyledDocument doc = getStyledDocument();</span>
			try {
<span class="nc bnc" id="L513" title="All 2 branches missed.">				if (doc.getLength() &gt; 0)</span>
<span class="nc" id="L514">					text = &quot;\n\n&quot; + text;</span>
<span class="nc" id="L515">				doc.insertString(doc.getLength(), text, null);</span>
<span class="nc" id="L516">			} catch (Exception e) {</span>
<span class="nc" id="L517">				logger.log(Level.WARNING, &quot;Transaction log update failure&quot;, e);</span>
<span class="nc" id="L518">			}</span>
<span class="nc" id="L519">		}</span>

		// Implement TransactionListener

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void logPurchase(GoodsType goodsType, int amount, int price) {
<span class="nc" id="L528">			int total = amount * price;</span>
<span class="nc" id="L529">			StringTemplate t1 = StringTemplate.template(&quot;europePanel.transaction.purchase&quot;)</span>
<span class="nc" id="L530">					.addNamed(&quot;%goods%&quot;, goodsType).addAmount(&quot;%amount%&quot;, amount).addAmount(&quot;%gold%&quot;, price);</span>
<span class="nc" id="L531">			StringTemplate t2 = StringTemplate.template(&quot;europePanel.transaction.price&quot;).addAmount(&quot;%gold%&quot;, total);</span>
<span class="nc" id="L532">			add(Messages.message(t1) + &quot;\n&quot; + Messages.message(t2));</span>
<span class="nc" id="L533">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void logSale(GoodsType goodsType, int amount, int price, int tax) {
<span class="nc" id="L540">			int totalBeforeTax = amount * price;</span>
<span class="nc" id="L541">			int totalTax = totalBeforeTax * tax / 100;</span>
<span class="nc" id="L542">			int totalAfterTax = totalBeforeTax - totalTax;</span>

<span class="nc" id="L544">			StringTemplate t1 = StringTemplate.template(&quot;europePanel.transaction.sale&quot;).addNamed(&quot;%goods%&quot;, goodsType)</span>
<span class="nc" id="L545">					.addAmount(&quot;%amount%&quot;, amount).addAmount(&quot;%gold%&quot;, price);</span>
<span class="nc" id="L546">			StringTemplate t2 = StringTemplate.template(&quot;europePanel.transaction.price&quot;).addAmount(&quot;%gold%&quot;,</span>
<span class="nc" id="L547">					totalBeforeTax);</span>
<span class="nc" id="L548">			StringTemplate t3 = StringTemplate.template(&quot;europePanel.transaction.tax&quot;).addAmount(&quot;%tax%&quot;, tax)</span>
<span class="nc" id="L549">					.addAmount(&quot;%gold%&quot;, totalTax);</span>
<span class="nc" id="L550">			StringTemplate t4 = StringTemplate.template(&quot;europePanel.transaction.net&quot;).addAmount(&quot;%gold%&quot;,</span>
<span class="nc" id="L551">					totalAfterTax);</span>
<span class="nc" id="L552">			add(Messages.message(t1) + &quot;\n&quot; + Messages.message(t2) + &quot;\n&quot; + Messages.message(t3) + &quot;\n&quot;</span>
<span class="nc" id="L553">					+ Messages.message(t4));</span>
<span class="nc" id="L554">		}</span>
	}

	/**
	 * The Enum EuropeAction.
	 */
<span class="nc" id="L560">	public static enum EuropeAction {</span>

		/** The exit. */
<span class="nc" id="L563">		EXIT,</span>

		/** The recruit. */
<span class="nc" id="L566">		RECRUIT,</span>

		/** The purchase. */
<span class="nc" id="L569">		PURCHASE,</span>

		/** The train. */
<span class="nc" id="L572">		TRAIN,</span>

		/** The unload. */
<span class="nc" id="L575">		UNLOAD,</span>

		/** The sail. */
<span class="nc" id="L578">		SAIL</span>
	}

	/** The to america panel. */
	private DestinationPanel toAmericaPanel;

	/** The to europe panel. */
	private DestinationPanel toEuropePanel;

	/** The docks panel. */
	private DocksPanel docksPanel;

	/** The market panel. */
	private MarketPanel marketPanel;

	/** The log. */
	private TransactionLog log;

	/** The sail button. */
	private JButton exitButton, trainButton, purchaseButton, recruitButton, unloadButton, sailButton;

	/** The europe. */
	private final Europe europe;

	/**
	 * The constructor for a EuropePanel.
	 *
	 * @param freeColClient
	 *            The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
	 * @param header
	 *            True when a header should be added.
	 */
	public EuropePanel(FreeColClient freeColClient, boolean header) {
<span class="nc" id="L611">		super(freeColClient, new MigLayout(&quot;wrap 3, fill&quot;, &quot;[30%:][30%:][15%:]&quot;));</span>

<span class="nc" id="L613">		exitButton = new EuropeButton(Messages.message(&quot;close&quot;), KeyEvent.VK_ESCAPE, EuropeAction.EXIT.toString(),</span>
				this);
<span class="nc" id="L615">		trainButton = new EuropeButton(Messages.message(&quot;train&quot;), KeyEvent.VK_T, EuropeAction.TRAIN.toString(), this);</span>
<span class="nc" id="L616">		purchaseButton = new EuropeButton(Messages.message(&quot;purchase&quot;), KeyEvent.VK_P, EuropeAction.PURCHASE.toString(),</span>
				this);
<span class="nc" id="L618">		recruitButton = new EuropeButton(Messages.message(&quot;recruit&quot;), KeyEvent.VK_R, EuropeAction.RECRUIT.toString(),</span>
				this);
<span class="nc" id="L620">		unloadButton = new EuropeButton(Messages.message(&quot;unload&quot;), KeyEvent.VK_U, EuropeAction.UNLOAD.toString(),</span>
				this);
<span class="nc" id="L622">		sailButton = new EuropeButton(Messages.message(&quot;setSail&quot;), KeyEvent.VK_S, EuropeAction.SAIL.toString(), this);</span>

<span class="nc" id="L624">		toAmericaPanel = new DestinationPanel();</span>
<span class="nc" id="L625">		toEuropePanel = new DestinationPanel();</span>
<span class="nc" id="L626">		inPortPanel = new EuropeInPortPanel();</span>
<span class="nc" id="L627">		cargoPanel = new CargoPanel(freeColClient, true);</span>
<span class="nc" id="L628">		docksPanel = new DocksPanel();</span>
<span class="nc" id="L629">		marketPanel = new MarketPanel(this);</span>
<span class="nc" id="L630">		log = new TransactionLog();</span>
<span class="nc" id="L631">		europe = freeColClient.getMyPlayer().getEurope();</span>

<span class="nc" id="L633">		SimpleAttributeSet attributes = new SimpleAttributeSet();</span>
<span class="nc" id="L634">		StyleConstants.setAlignment(attributes, StyleConstants.ALIGN_RIGHT);</span>
		// StyleConstants.setForeground(attributes, Color.WHITE);
<span class="nc" id="L636">		StyleConstants.setBold(attributes, true);</span>
<span class="nc" id="L637">		log.setParagraphAttributes(attributes, true);</span>

<span class="nc" id="L639">		defaultTransferHandler = new DefaultTransferHandler(freeColClient, this);</span>
<span class="nc" id="L640">		toAmericaPanel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L641">		toEuropePanel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L642">		inPortPanel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L643">		cargoPanel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L644">		docksPanel.setTransferHandler(defaultTransferHandler);</span>
<span class="nc" id="L645">		marketPanel.setTransferHandler(defaultTransferHandler);</span>

<span class="nc" id="L647">		pressListener = new DragListener(freeColClient, this);</span>
<span class="nc" id="L648">		MouseListener releaseListener = new DropListener();</span>
<span class="nc" id="L649">		toAmericaPanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L650">		toEuropePanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L651">		inPortPanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L652">		cargoPanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L653">		docksPanel.addMouseListener(releaseListener);</span>
<span class="nc" id="L654">		marketPanel.addMouseListener(releaseListener);</span>

<span class="nc" id="L656">		toAmericaPanel.setLayout(new GridLayout(1, 0));</span>
<span class="nc" id="L657">		toEuropePanel.setLayout(new GridLayout(1, 0));</span>
<span class="nc" id="L658">		inPortPanel.setLayout(new GridLayout(1, 0));</span>
<span class="nc" id="L659">		cargoPanel.setLayout(new GridLayout(1, 0));</span>
<span class="nc" id="L660">		docksPanel.setLayout(new GridLayout(0, 5));</span>

<span class="nc" id="L662">		JScrollPane toAmericaScroll = new JScrollPane(toAmericaPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L664">		toAmericaScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L665">		JScrollPane toEuropeScroll = new JScrollPane(toEuropePanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L667">		toEuropeScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L668">		JScrollPane inPortScroll = new JScrollPane(inPortPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L670">		inPortScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L671">		JScrollPane cargoScroll = new JScrollPane(cargoPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L673">		cargoScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L674">		JScrollPane docksScroll = new JScrollPane(docksPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
<span class="nc" id="L676">		docksScroll.getVerticalScrollBar().setUnitIncrement(16);</span>
<span class="nc" id="L677">		JScrollPane marketScroll = new JScrollPane(marketPanel, ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L679">		JScrollPane logScroll = new JScrollPane(log, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</span>
				ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
<span class="nc" id="L681">		logScroll.getVerticalScrollBar().setUnitIncrement(16);</span>

<span class="nc" id="L683">		toAmericaPanel.setBorder(Utility.localizedBorder(&quot;sailingToAmerica&quot;));</span>
<span class="nc" id="L684">		toEuropePanel.setBorder(Utility.localizedBorder(&quot;sailingToEurope&quot;));</span>
<span class="nc" id="L685">		docksPanel.setBorder(Utility.localizedBorder(&quot;docks&quot;));</span>
<span class="nc" id="L686">		inPortPanel.setBorder(Utility.localizedBorder(&quot;inPort&quot;));</span>
<span class="nc" id="L687">		marketPanel.setBorder(Utility.blankBorder(10, 10, 10, 10));</span>
<span class="nc" id="L688">		log.setBorder(Utility.localizedBorder(&quot;sales&quot;));</span>

<span class="nc" id="L690">		toAmericaScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L691">		toAmericaPanel.setOpaque(false);</span>
<span class="nc" id="L692">		toEuropeScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L693">		toEuropePanel.setOpaque(false);</span>
<span class="nc" id="L694">		inPortScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L695">		inPortPanel.setOpaque(false);</span>
<span class="nc" id="L696">		cargoScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L697">		cargoPanel.setOpaque(false);</span>
<span class="nc" id="L698">		docksScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L699">		docksPanel.setOpaque(false);</span>
<span class="nc" id="L700">		marketScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L701">		marketPanel.setOpaque(false);</span>
<span class="nc" id="L702">		logScroll.getViewport().setOpaque(false);</span>
<span class="nc" id="L703">		log.setOpaque(false);</span>

<span class="nc" id="L705">		initialize(europe);</span>

<span class="nc bnc" id="L707" title="All 2 branches missed.">		if (header) {</span>
<span class="nc" id="L708">			add(Utility.localizedHeader(europe.getNameKey(), false), &quot;span, top, center&quot;);</span>
		}
<span class="nc" id="L710">		add(toAmericaScroll, &quot;sg, height 15%:, grow&quot;);</span>
<span class="nc" id="L711">		add(toEuropeScroll, &quot;sg, height 15%:, grow&quot;);</span>
<span class="nc" id="L712">		add(logScroll, &quot;spany 3, grow&quot;);</span>
<span class="nc" id="L713">		add(inPortScroll, &quot;sg, height 15%:, grow&quot;);</span>
<span class="nc" id="L714">		add(docksScroll, &quot;spany 2, grow&quot;);</span>
<span class="nc" id="L715">		add(cargoScroll, &quot;height 10%:, grow&quot;);</span>
<span class="nc" id="L716">		add(marketScroll, &quot;span, height 10%:, grow&quot;);</span>

<span class="nc" id="L718">		add(recruitButton, &quot;span, split 6&quot;);</span>
<span class="nc" id="L719">		add(purchaseButton);</span>
<span class="nc" id="L720">		add(trainButton);</span>
<span class="nc" id="L721">		add(unloadButton);</span>
<span class="nc" id="L722">		add(sailButton);</span>
<span class="nc" id="L723">		add(exitButton, &quot;tag ok&quot;);</span>

<span class="nc" id="L725">		setSelectedUnitLabel(null);</span>

<span class="nc" id="L727">		float scale = getImageLibrary().getScaleFactor();</span>
<span class="nc" id="L728">		getGUI().restoreSavedSize(this, 200 + (int) (scale * 850), 200 + (int) (scale * 525));</span>
<span class="nc" id="L729">	}</span>

	/**
	 * Initialize this EuropePanel.
	 *
	 * @param europe
	 *            The &lt;code&gt;Europe&lt;/code&gt; this panel should display.
	 */
	private void initialize(Europe europe) {
		// Initialize the subpanels.
<span class="nc" id="L739">		toAmericaPanel.initialize(europe.getGame().getMap());</span>
<span class="nc" id="L740">		toEuropePanel.initialize(europe);</span>
		// Initialize cargoPanel *before* inPortPanel calls setSelectedUnit().
<span class="nc" id="L742">		cargoPanel.initialize();</span>
<span class="nc" id="L743">		inPortPanel.initialize();</span>
<span class="nc" id="L744">		marketPanel.initialize();</span>
<span class="nc" id="L745">		docksPanel.initialize();</span>
<span class="nc" id="L746">		log.initialize();</span>
<span class="nc" id="L747">	}</span>

	/**
	 * Cleans up this EuropePanel.
	 */
	public void cleanup() {
<span class="nc" id="L753">		log.cleanup();</span>
<span class="nc" id="L754">		docksPanel.cleanup();</span>
<span class="nc" id="L755">		marketPanel.cleanup();</span>
<span class="nc" id="L756">		inPortPanel.cleanup();</span>
<span class="nc" id="L757">		cargoPanel.cleanup();</span>
<span class="nc" id="L758">		toEuropePanel.cleanup();</span>
<span class="nc" id="L759">		toAmericaPanel.cleanup();</span>
<span class="nc" id="L760">	}</span>

	/**
	 * What to do when requesting focus.
	 */
	@Override
	public void requestFocus() {
<span class="nc" id="L767">		exitButton.requestFocus();</span>
<span class="nc" id="L768">	}</span>

	/**
	 * Refreshes this panel.
	 */
	public void refresh() {
<span class="nc" id="L774">		repaint(0, 0, getWidth(), getHeight());</span>
<span class="nc" id="L775">	}</span>

	/**
	 * Selects a unit that is located somewhere on this panel.
	 *
	 * @param unitLabel
	 *            The &lt;code&gt;UnitLabel&lt;/code&gt; for the unit that is being
	 *            selected.
	 */
	@Override
	public void setSelectedUnitLabel(UnitLabel unitLabel) {
<span class="nc bnc" id="L786" title="All 2 branches missed.">		if (selectedUnitLabel != unitLabel) {</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">			if (selectedUnitLabel != null) {</span>
<span class="nc" id="L788">				selectedUnitLabel.setSelected(false);</span>
			}
<span class="nc" id="L790">			selectedUnitLabel = unitLabel;</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">			if (unitLabel == null) {</span>
<span class="nc" id="L792">				cargoPanel.setCarrier(null);</span>
			} else {
<span class="nc" id="L794">				cargoPanel.setCarrier(unitLabel.getUnit());</span>
<span class="nc" id="L795">				unitLabel.setSelected(true);</span>
			}
		}
<span class="nc" id="L798">		inPortPanel.revalidate();</span>
<span class="nc" id="L799">		inPortPanel.repaint();</span>
<span class="nc" id="L800">	}</span>

	/**
	 * Exits this EuropePanel.
	 */
	private void exitAction() {
<span class="nc" id="L806">		cleanup();</span>
<span class="nc" id="L807">		getGUI().removeFromCanvas(this);</span>
<span class="nc" id="L808">		igc().nextModelMessage();</span>
<span class="nc" id="L809">	}</span>

	/**
	 * Unload the contents of the currently selected carrier.
	 */
	private void unloadAction() {
<span class="nc" id="L815">		Unit unit = getSelectedUnit();</span>
<span class="nc bnc" id="L816" title="All 4 branches missed.">		if (unit != null &amp;&amp; unit.isCarrier()) {</span>
<span class="nc" id="L817">			Iterator&lt;Goods&gt; goodsIterator = unit.getGoodsIterator();</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">			while (goodsIterator.hasNext()) {</span>
<span class="nc" id="L819">				Goods goods = goodsIterator.next();</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">				if (getMyPlayer().canTrade(goods.getType())) {</span>
<span class="nc" id="L821">					igc().sellGoods(goods);</span>
				} else {
<span class="nc" id="L823">					igc().payArrears(goods.getType());</span>
				}
<span class="nc" id="L825">			}</span>
<span class="nc" id="L826">			Iterator&lt;Unit&gt; unitIterator = unit.getUnitIterator();</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">			while (unitIterator.hasNext()) {</span>
<span class="nc" id="L828">				Unit newUnit = unitIterator.next();</span>
<span class="nc" id="L829">				igc().leaveShip(newUnit);</span>
<span class="nc" id="L830">			}</span>
<span class="nc" id="L831">			cargoPanel.update();</span>
<span class="nc" id="L832">			docksPanel.update();</span>
		}
<span class="nc" id="L834">		requestFocus();</span>
<span class="nc" id="L835">	}</span>

	/**
	 * A unit sets sail for the new world.
	 */
	private void sailAction() {
<span class="nc" id="L841">		Unit unit = getSelectedUnit();</span>
<span class="nc bnc" id="L842" title="All 4 branches missed.">		if (unit != null &amp;&amp; unit.isNaval()) {</span>
<span class="nc" id="L843">			UnitLabel unitLabel = getSelectedUnitLabel();</span>
<span class="nc" id="L844">			toAmericaPanel.add(unitLabel, true);</span>
		}
<span class="nc" id="L846">		requestFocus();</span>
<span class="nc" id="L847">	}</span>

	// Interface PortPanel

	/**
	 * Get the units in Europe.
	 *
	 * @return A list of units in Europe.
	 */
	@Override
	public List&lt;Unit&gt; getUnitList() {
<span class="nc" id="L858">		return europe.getUnitList();</span>
	}

	// Interface ActionListener

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L868">		final String command = ae.getActionCommand();</span>
<span class="nc" id="L869">		EuropeAction act = EuropeAction.valueOf(command);</span>
<span class="nc bnc" id="L870" title="All 7 branches missed.">		switch (act) {</span>
		case EXIT:
<span class="nc" id="L872">			exitAction();</span>
<span class="nc" id="L873">			break;</span>
		case PURCHASE:
<span class="nc" id="L875">			getGUI().showPurchasePanel();</span>
<span class="nc" id="L876">			break;</span>
		case RECRUIT:
<span class="nc" id="L878">			getGUI().showRecruitPanel();</span>
<span class="nc" id="L879">			break;</span>
		case SAIL:
<span class="nc" id="L881">			sailAction();</span>
<span class="nc" id="L882">			break;</span>
		case TRAIN:
<span class="nc" id="L884">			getGUI().showTrainPanel();</span>
<span class="nc" id="L885">			break;</span>
		case UNLOAD:
<span class="nc" id="L887">			unloadAction();</span>
<span class="nc" id="L888">			break;</span>
		default:
<span class="nc" id="L890">			super.actionPerformed(ae);</span>
			break;
		}
<span class="nc" id="L893">	}</span>

	// Override Component

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void removeNotify() {
<span class="nc" id="L902">		super.removeNotify();</span>

<span class="nc" id="L904">		removeAll();</span>
<span class="nc" id="L905">		toAmericaPanel = null;</span>
<span class="nc" id="L906">		toEuropePanel = null;</span>
<span class="nc" id="L907">		docksPanel = null;</span>
<span class="nc" id="L908">		marketPanel = null;</span>
<span class="nc" id="L909">		log = null;</span>
<span class="nc" id="L910">		exitButton = trainButton = purchaseButton = recruitButton = unloadButton = sailButton = null;</span>
<span class="nc" id="L911">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>