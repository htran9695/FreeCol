<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuickActionMenu.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui.panel</a> &gt; <span class="el_source">QuickActionMenu.java</span></div><h1>QuickActionMenu.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui.panel;

import java.awt.Font;
import java.awt.event.ActionEvent;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Logger;

import javax.swing.Icon;
import javax.swing.ImageIcon;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JMenu;
import javax.swing.JMenuItem;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;

import net.miginfocom.swing.MigLayout;

import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.control.InGameController;
import net.sf.freecol.client.gui.ImageLibrary;
import net.sf.freecol.client.gui.SwingGUI;
import net.sf.freecol.client.gui.panel.ColonyPanel.TilesPanel.ASingleTilePanel;
import net.sf.freecol.client.gui.panel.UnitLabel.UnitAction;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitLocation;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import static net.sf.freecol.common.util.CollectionUtils.*;

/**
 * Handles the generation of popup menu's generated by DragListener objects
 * attached to units within the Colony and Europe panels.
 * 
 * @author Brian
 */
public final class QuickActionMenu extends JPopupMenu {

	/** The Constant logger. */
<span class="nc" id="L83">	private static final Logger logger = Logger.getLogger(QuickActionMenu.class.getName());</span>

	/** The free col client. */
	private final FreeColClient freeColClient;

	/** The gui. */
	private final SwingGUI gui;

	/** The parent panel. */
	private final FreeColPanel parentPanel;

	/**
	 * Creates a standard empty menu.
	 *
	 * @param freeColClient
	 *            The enclosing &lt;code&gt;FreeColClient&lt;/code&gt;.
	 * @param freeColPanel
	 *            The parent &lt;code&gt;FreeColPanel&lt;/code&gt;.
	 */
<span class="nc" id="L102">	public QuickActionMenu(FreeColClient freeColClient, FreeColPanel freeColPanel) {</span>
<span class="nc" id="L103">		this.freeColClient = freeColClient;</span>
<span class="nc" id="L104">		this.gui = (SwingGUI) freeColClient.getGUI();</span>
<span class="nc" id="L105">		this.parentPanel = freeColPanel;</span>
<span class="nc" id="L106">	}</span>

	/**
	 * Add specific menu items for a given component.
	 *
	 * @param comp
	 *            The specific &lt;code&gt;JComponent&lt;/code&gt;.
	 * @return This &lt;code&gt;QuickActionMenu&lt;/code&gt;.
	 */
	public QuickActionMenu addMenuItems(JComponent comp) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">		if (comp instanceof UnitLabel) {</span>
<span class="nc" id="L117">			createUnitMenu((UnitLabel) comp);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		} else if (comp instanceof GoodsLabel) {</span>
<span class="nc" id="L119">			createGoodsMenu((GoodsLabel) comp);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		} else if (comp instanceof MarketLabel) {</span>
<span class="nc" id="L121">			createMarketMenu((MarketLabel) comp);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">		} else if (comp instanceof ASingleTilePanel) {</span>
<span class="nc" id="L123">			createTileMenu((ASingleTilePanel) comp);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">		} else if (comp.getParent() instanceof ASingleTilePanel) {</span>
			// Also check the parent to show the popup in the
			// center of the colony panel tile.
<span class="nc" id="L127">			createTileMenu((ASingleTilePanel) comp.getParent());</span>
		}
<span class="nc" id="L129">		return this;</span>
	}

	/**
	 * Prompt for an amount of goods to use.
	 *
	 * The amount is returned through the parameter amount.
	 *
	 * @param ag
	 *            The &lt;code&gt;AbstractGoods&lt;/code&gt; to query.
	 */
	private void promptForGoods(AbstractGoods ag) {
<span class="nc" id="L141">		int ret = gui.showSelectAmountDialog(ag.getType(), GoodsContainer.CARGO_SIZE, ag.getAmount(), true);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (ret &gt; 0)</span>
<span class="nc" id="L143">			ag.setAmount(ret);</span>
<span class="nc" id="L144">	}</span>

	/**
	 * Creates a popup menu for a Unit.
	 *
	 * @param unitLabel
	 *            the unit label
	 */
	private void createUnitMenu(final UnitLabel unitLabel) {
<span class="nc" id="L153">		final Unit unit = unitLabel.getUnit();</span>

<span class="nc" id="L155">		this.setLabel(&quot;Unit&quot;);</span>
<span class="nc" id="L156">		ImageIcon unitIcon = new ImageIcon(gui.getImageLibrary().getSmallUnitImage(unit));</span>
<span class="nc" id="L157">		JMenuItem name = new JMenuItem(</span>
<span class="nc" id="L158">				unit.getDescription(Unit.UnitLabelType.NATIONAL) + &quot; (&quot; + Messages.message(&quot;colopedia&quot;) + &quot;)&quot;,</span>
				unitIcon);
<span class="nc" id="L160">		name.setActionCommand(UnitAction.COLOPEDIA.toString());</span>
<span class="nc" id="L161">		name.addActionListener(unitLabel);</span>
<span class="nc" id="L162">		this.add(name);</span>
<span class="nc" id="L163">		this.addSeparator();</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">		if (addCarrierItems(unitLabel))</span>
<span class="nc" id="L166">			this.addSeparator();</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">		if (unit.isInEurope()) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">			if (addCommandItems(unitLabel))</span>
<span class="nc" id="L170">				this.addSeparator();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">			if (addBoardItems(unitLabel, unit.getOwner().getEurope())) {</span>
<span class="nc" id="L172">				this.addSeparator();</span>
			}
<span class="nc bnc" id="L174" title="All 2 branches missed.">		} else if (unit.hasTile()) {</span>
<span class="nc" id="L175">			Colony colony = unit.getLocation().getTile().getColony();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">				if (addTileItem(unitLabel))</span>
<span class="nc" id="L178">					this.addSeparator();</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">				if (addWorkItems(unitLabel))</span>
<span class="nc" id="L180">					this.addSeparator();</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">				if (addEducationItems(unitLabel))</span>
<span class="nc" id="L182">					this.addSeparator();</span>
<span class="nc bnc" id="L183" title="All 4 branches missed.">				if (unit.isInColony() &amp;&amp; colony.canReducePopulation()) {</span>
<span class="nc" id="L184">					JMenuItem menuItem = Utility.localizedMenuItem(&quot;quickActionMenu.leaveTown&quot;);</span>
<span class="nc" id="L185">					menuItem.setActionCommand(UnitAction.LEAVE_TOWN.toString());</span>
<span class="nc" id="L186">					menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L187">					this.add(menuItem);</span>
<span class="nc" id="L188">					addBoardItems(unitLabel, colony.getTile());</span>
<span class="nc" id="L189">					this.addSeparator();</span>
<span class="nc" id="L190">				} else {</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">					if (addCommandItems(unitLabel))</span>
<span class="nc" id="L192">						this.addSeparator();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">					if (addBoardItems(unitLabel, colony.getTile())) {</span>
<span class="nc" id="L194">						this.addSeparator();</span>
					}
				}
			} else {
<span class="nc bnc" id="L198" title="All 2 branches missed.">				if (addCommandItems(unitLabel))</span>
<span class="nc" id="L199">					this.addSeparator();</span>
			}
		}

<span class="nc bnc" id="L203" title="All 2 branches missed.">		if (unit.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (addRoleItems(unitLabel))</span>
<span class="nc" id="L205">				this.addSeparator();</span>
		}
<span class="nc" id="L207">	}</span>

	/**
	 * Adds the board items.
	 *
	 * @param unitLabel
	 *            the unit label
	 * @param loc
	 *            the loc
	 * @return true, if successful
	 */
	private boolean addBoardItems(final UnitLabel unitLabel, Location loc) {
<span class="nc" id="L219">		final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L220">		final Unit tempUnit = unitLabel.getUnit();</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">		if (tempUnit.isCarrier())</span>
<span class="nc" id="L223">			return false;</span>
<span class="nc" id="L224">		boolean added = false;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">		for (final Unit unit : loc.getUnitList()) {</span>
<span class="nc bnc" id="L226" title="All 8 branches missed.">			if (unit.isCarrier() &amp;&amp; unit.canCarryUnits() &amp;&amp; unit.canAdd(tempUnit) &amp;&amp; tempUnit.getLocation() != unit) {</span>
<span class="nc" id="L227">				StringTemplate template = StringTemplate.template(&quot;quickActionMenu.board&quot;).addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L228">						unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L229">				JMenuItem menuItem = Utility.localizedMenuItem(template);</span>
<span class="nc" id="L230">				menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L231">					igc.boardShip(tempUnit, unit);</span>
<span class="nc" id="L232">				});</span>
<span class="nc" id="L233">				this.add(menuItem);</span>
<span class="nc" id="L234">				added = true;</span>
			}
<span class="nc" id="L236">		}</span>
<span class="nc" id="L237">		return added;</span>
	}

	/**
	 * Adds the load items.
	 *
	 * @param goods
	 *            the goods
	 * @param loc
	 *            the loc
	 * @return true, if successful
	 */
	private boolean addLoadItems(final Goods goods, Location loc) {
<span class="nc" id="L250">		final InGameController igc = freeColClient.getInGameController();</span>

<span class="nc" id="L252">		boolean added = false;</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		for (final Unit unit : loc.getUnitList()) {</span>
<span class="nc bnc" id="L254" title="All 6 branches missed.">			if (unit.isCarrier() &amp;&amp; unit.canCarryGoods() &amp;&amp; unit.canAdd(goods)) {</span>
<span class="nc" id="L255">				StringTemplate template = StringTemplate.template(&quot;quickActionMenu.loadOnTo&quot;)</span>
<span class="nc" id="L256">						.addStringTemplate(&quot;%unit%&quot;, unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L257">				JMenuItem menuItem = Utility.localizedMenuItem(template);</span>
<span class="nc" id="L258">				menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">					if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L260">						promptForGoods(goods);</span>
					}
<span class="nc" id="L262">					igc.loadCargo(goods, unit);</span>
<span class="nc" id="L263">				});</span>
<span class="nc" id="L264">				this.add(menuItem);</span>
<span class="nc" id="L265">				added = true;</span>
			}
<span class="nc" id="L267">		}</span>
<span class="nc" id="L268">		return added;</span>
	}

	/**
	 * Adds the carrier items.
	 *
	 * @param unitLabel
	 *            the unit label
	 * @return true, if successful
	 */
	private boolean addCarrierItems(final UnitLabel unitLabel) {
<span class="nc" id="L279">		final Unit unit = unitLabel.getUnit();</span>
<span class="nc bnc" id="L280" title="All 4 branches missed.">		if (!unit.isCarrier() || !unit.hasCargo())</span>
<span class="nc" id="L281">			return false;</span>

<span class="nc" id="L283">		JMenuItem cargo = Utility.localizedMenuItem(&quot;cargoOnCarrier&quot;);</span>
<span class="nc" id="L284">		this.add(cargo);</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">		for (Unit passenger : unit.getUnitList()) {</span>
<span class="nc" id="L287">			JMenuItem menuItem = new JMenuItem(&quot;    &quot; + passenger.getDescription(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L288">			menuItem.setFont(menuItem.getFont().deriveFont(Font.ITALIC));</span>
<span class="nc" id="L289">			this.add(menuItem);</span>
<span class="nc" id="L290">		}</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">		for (Goods goods : unit.getGoodsList()) {</span>
<span class="nc" id="L292">			JMenuItem menuItem = new JMenuItem(&quot;    &quot; + Messages.message(goods.getLabel(true)));</span>
<span class="nc" id="L293">			menuItem.setFont(menuItem.getFont().deriveFont(Font.ITALIC));</span>
<span class="nc" id="L294">			this.add(menuItem);</span>
<span class="nc" id="L295">		}</span>
<span class="nc" id="L296">		return true;</span>
	}

	/**
	 * Descending list.
	 *
	 * @param map
	 *            the map
	 * @return the list
	 */
	private List&lt;JMenuItem&gt; descendingList(final Map&lt;JMenuItem, Integer&gt; map) {
<span class="nc" id="L307">		List&lt;JMenuItem&gt; ret = new ArrayList&lt;&gt;(map.keySet());</span>
<span class="nc" id="L308">		Collections.sort(ret, new Comparator&lt;JMenuItem&gt;() {</span>
			@Override
			public int compare(JMenuItem m1, JMenuItem m2) {
<span class="nc" id="L311">				Integer i1 = map.get(m1);</span>
<span class="nc" id="L312">				Integer i2 = map.get(m2);</span>
<span class="nc" id="L313">				int cmp = i2.compareTo(i1);</span>
<span class="nc bnc" id="L314" title="All 2 branches missed.">				if (cmp == 0)</span>
<span class="nc" id="L315">					cmp = m1.getText().compareTo(m2.getText());</span>
<span class="nc" id="L316">				return cmp;</span>
			}
		});
<span class="nc" id="L319">		return ret;</span>
	}

	/**
	 * Make production item.
	 *
	 * @param type
	 *            the type
	 * @param wl
	 *            the wl
	 * @param amount
	 *            the amount
	 * @param unitLabel
	 *            the unit label
	 * @param claim
	 *            the claim
	 * @return the j menu item
	 */
	private JMenuItem makeProductionItem(GoodsType type, WorkLocation wl, int amount, UnitLabel unitLabel,
			boolean claim) {
<span class="nc" id="L339">		StringTemplate t = StringTemplate.template(type.getId() + &quot;.workAs&quot;).addAmount(&quot;%amount%&quot;, amount);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">		if (claim) {</span>
<span class="nc" id="L341">			t.addStringTemplate(&quot;%claim%&quot;, wl.getClaimTemplate());</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">		} else if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L343">			t.addStringTemplate(&quot;%claim%&quot;, wl.getLocationLabel());</span>
		} else {
<span class="nc" id="L345">			t.addName(&quot;%claim%&quot;, &quot;&quot;);</span>
		}
<span class="nc" id="L347">		JMenuItem menuItem = Utility.localizedMenuItem(t, new ImageIcon(gui.getImageLibrary().getSmallIconImage(type)));</span>
<span class="nc" id="L348">		menuItem.setActionCommand(</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">				UnitLabel.getWorkLabel(wl) + &quot;/&quot; + wl.getId() + &quot;/&quot; + type.getId() + &quot;/&quot; + ((claim) ? &quot;!&quot; : &quot;&quot;));</span>
<span class="nc" id="L350">		menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L351">		return menuItem;</span>
	}

	/**
	 * Adds the work items.
	 *
	 * @param unitLabel
	 *            the unit label
	 * @return true, if successful
	 */
	private boolean addWorkItems(final UnitLabel unitLabel) {
<span class="nc" id="L362">		final Unit unit = unitLabel.getUnit();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">		if (unit.isCarrier())</span>
<span class="nc" id="L364">			return false;</span>

<span class="nc" id="L366">		final UnitType unitType = unit.getType();</span>
<span class="nc" id="L367">		final GoodsType expertGoods = unitType.getExpertProduction();</span>
<span class="nc" id="L368">		final Colony colony = unit.getLocation().getColony();</span>
<span class="nc" id="L369">		final Specification spec = freeColClient.getGame().getSpecification();</span>
<span class="nc" id="L370">		final WorkLocation current = unit.getWorkLocation();</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">		final int bonusChange = (current != null) ? 0 : colony.governmentChange(colony.getUnitCount() + 1);</span>
<span class="nc" id="L372">		final int bonus = colony.getProductionBonus();</span>

<span class="nc" id="L374">		Map&lt;JMenuItem, Integer&gt; items = new HashMap&lt;&gt;();</span>
<span class="nc" id="L375">		Map&lt;JMenuItem, Integer&gt; extras = new HashMap&lt;&gt;();</span>
<span class="nc" id="L376">		JMenuItem expertOwned = null;</span>
<span class="nc" id="L377">		JMenuItem expertUnowned = null;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">		for (GoodsType type : spec.getGoodsTypeList()) {</span>
<span class="nc" id="L379">			int bestOwnedProd = bonus + bonusChange, bestUnownedProd = bonus + bonusChange;</span>
<span class="nc" id="L380">			WorkLocation bestOwned = null, bestUnowned = null;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">			for (WorkLocation wl : colony.getAllWorkLocations()) {</span>
<span class="nc" id="L382">				int prod = 0;</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">				switch (wl.getNoAddReason(unit)) {</span>
				case NONE:
<span class="nc" id="L385">					prod = wl.getPotentialProduction(type, unitType);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">					if (bestOwnedProd &lt; prod) {</span>
<span class="nc" id="L387">						bestOwnedProd = prod;</span>
<span class="nc" id="L388">						bestOwned = wl;</span>
					}
					break;
				case ALREADY_PRESENT:
<span class="nc" id="L392">					prod = wl.getPotentialProduction(type, unitType);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">					if (bestOwnedProd &lt; prod) {</span>
<span class="nc" id="L394">						bestOwnedProd = prod;</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">						bestOwned = (unit.getWorkType() == type) ? null : wl;</span>
					}
					break;
				case CLAIM_REQUIRED:
<span class="nc" id="L399">					prod = wl.getPotentialProduction(type, unitType);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">					if (bestUnownedProd &lt; prod) {</span>
<span class="nc" id="L401">						bestUnownedProd = prod;</span>
<span class="nc" id="L402">						bestUnowned = wl;</span>
					}
					break;
				default:
					break;
				}
<span class="nc" id="L408">			}</span>
<span class="nc bnc" id="L409" title="All 4 branches missed.">			if (bestOwned != null &amp;&amp; bestOwnedProd &gt; 0) {</span>
<span class="nc" id="L410">				JMenuItem ji = makeProductionItem(type, bestOwned, bestOwnedProd, unitLabel, false);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">				if (type == expertGoods) {</span>
<span class="nc" id="L412">					expertOwned = ji;</span>
				} else {
<span class="nc" id="L414">					items.put(ji, bestOwnedProd);</span>
				}
			}
<span class="nc bnc" id="L417" title="All 6 branches missed.">			if (bestUnowned != null &amp;&amp; bestUnownedProd &gt; bestOwnedProd &amp;&amp; bestUnownedProd &gt; 0) {</span>
<span class="nc" id="L418">				JMenuItem ji = makeProductionItem(type, bestUnowned, bestUnownedProd, unitLabel, true);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">				if (type == expertGoods) {</span>
<span class="nc" id="L420">					expertUnowned = ji;</span>
				} else {
<span class="nc" id="L422">					extras.put(ji, bestUnownedProd);</span>
				}
			}
<span class="nc" id="L425">		}</span>

<span class="nc" id="L427">		JMenu container = Utility.localizedMenu(&quot;quickActionMenu.changeWork&quot;);</span>
<span class="nc" id="L428">		List&lt;JMenuItem&gt; owned = descendingList(items);</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">		if (expertOwned != null)</span>
<span class="nc" id="L430">			owned.add(0, expertOwned);</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">		for (JMenuItem j : owned)</span>
<span class="nc" id="L432">			container.add(j);</span>
<span class="nc" id="L433">		List&lt;JMenuItem&gt; unowned = descendingList(extras);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">		if (expertUnowned != null)</span>
<span class="nc" id="L435">			unowned.add(0, expertUnowned);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">		if (!unowned.isEmpty()) {</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">			if (!owned.isEmpty())</span>
<span class="nc" id="L438">				container.addSeparator();</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">			for (JMenuItem j : unowned)</span>
<span class="nc" id="L440">				container.add(j);</span>
		}
<span class="nc bnc" id="L442" title="All 2 branches missed.">		if (container.getItemCount() &gt; 0)</span>
<span class="nc" id="L443">			this.add(container);</span>

<span class="nc bnc" id="L445" title="All 4 branches missed.">		if (current != null &amp;&amp; unit.getWorkType() != null) {</span>
<span class="nc" id="L446">			JMenuItem ji = Utility.localizedMenuItem(&quot;showProductionModifiers&quot;);</span>
<span class="nc" id="L447">			ji.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L448">				gui.showWorkProductionPanel(unit);</span>
<span class="nc" id="L449">			});</span>
<span class="nc" id="L450">			this.add(ji);</span>
		}
<span class="nc bnc" id="L452" title="All 6 branches missed.">		return !(owned.isEmpty() &amp;&amp; unowned.isEmpty() &amp;&amp; current == null);</span>
	}

	/**
	 * Adds the education items.
	 *
	 * @param unitLabel
	 *            the unit label
	 * @return true, if successful
	 */
	private boolean addEducationItems(final UnitLabel unitLabel) {
<span class="nc" id="L463">		boolean separatorNeeded = false;</span>
<span class="nc" id="L464">		Unit unit = unitLabel.getUnit();</span>

<span class="nc" id="L466">		ImageLibrary lib = gui.getImageLibrary();</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">		if (unit.getSpecification().getBoolean(GameOptions.ALLOW_STUDENT_SELECTION)) {</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">			for (Unit teacher : unit.getColony().getTeachers()) {</span>
<span class="nc bnc" id="L469" title="All 4 branches missed.">				if (unit.canBeStudent(teacher) &amp;&amp; unit.isInColony()) {</span>
<span class="nc" id="L470">					JMenuItem menuItem = null;</span>
<span class="nc" id="L471">					ImageIcon teacherIcon = new ImageIcon(lib.getSmallerUnitImage(teacher));</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">					if (teacher.getStudent() != unit) {</span>
<span class="nc" id="L473">						menuItem = Utility.localizedMenuItem(&quot;quickActionMenu.assignToTeacher&quot;, teacherIcon);</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">						if (teacher.getStudent() != null) {</span>
<span class="nc" id="L475">							menuItem.setText(menuItem.getText() + &quot; (&quot; + teacher.getTurnsOfTraining() + &quot;/&quot;</span>
<span class="nc" id="L476">									+ teacher.getNeededTurnsOfTraining() + &quot;)&quot;);</span>
						}
<span class="nc" id="L478">						menuItem.setActionCommand(UnitAction.ASSIGN + &quot;/&quot; + teacher.getId());</span>
<span class="nc" id="L479">						menuItem.addActionListener(unitLabel);</span>
					} else {
<span class="nc" id="L481">						menuItem = Utility.localizedMenuItem(StringTemplate.template(&quot;quickActionMenu.apprentice&quot;)</span>
<span class="nc" id="L482">								.addName(&quot;%unit%&quot;, Messages.getName(teacher.getType())), teacherIcon);</span>
<span class="nc" id="L483">						menuItem.setText(menuItem.getText() + &quot;: &quot; + teacher.getTurnsOfTraining() + &quot;/&quot;</span>
<span class="nc" id="L484">								+ teacher.getNeededTurnsOfTraining());</span>
<span class="nc" id="L485">						menuItem.setEnabled(false);</span>
					}
<span class="nc" id="L487">					this.add(menuItem);</span>
<span class="nc" id="L488">					separatorNeeded = true;</span>
				}
<span class="nc" id="L490">			}</span>
		}
<span class="nc bnc" id="L492" title="All 2 branches missed.">		if (unit.getStudent() != null) {</span>
<span class="nc" id="L493">			Unit student = unit.getStudent();</span>
<span class="nc" id="L494">			JMenuItem menuItem = Utility.localizedMenuItem(StringTemplate.template(&quot;quickActionMenu.teaching&quot;)</span>
<span class="nc" id="L495">					.addName(&quot;%unit%&quot;, Messages.getName(student.getType())));</span>
<span class="nc" id="L496">			menuItem.setText(</span>
<span class="nc" id="L497">					menuItem.getText() + &quot;: &quot; + unit.getTurnsOfTraining() + &quot;/&quot; + unit.getNeededTurnsOfTraining());</span>
<span class="nc" id="L498">			menuItem.setEnabled(false);</span>
<span class="nc" id="L499">			this.add(menuItem);</span>
<span class="nc" id="L500">			separatorNeeded = true;</span>
		}
<span class="nc" id="L502">		int experience = unit.getExperience();</span>
<span class="nc" id="L503">		GoodsType goods = unit.getExperienceType();</span>
<span class="nc bnc" id="L504" title="All 4 branches missed.">		if (experience &gt; 0 &amp;&amp; goods != null) {</span>
<span class="nc" id="L505">			UnitType expertType = freeColClient.getGame().getSpecification().getExpertForProducing(goods);</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">			if (unit.getType().canBeUpgraded(expertType, ChangeType.EXPERIENCE)) {</span>
<span class="nc" id="L507">				int maxExperience = unit.getType().getMaximumExperience();</span>
<span class="nc" id="L508">				double probability = unit.getType().getUnitTypeChange(expertType).getProbability(ChangeType.EXPERIENCE)</span>
						* experience / (double) maxExperience;
<span class="nc" id="L510">				String jobName = Messages.message(goods.getWorkingAsKey());</span>
<span class="nc" id="L511">				JPanel experiencePanel = new MigPanel();</span>
<span class="nc" id="L512">				experiencePanel.setLayout(new MigLayout(&quot;wrap 3&quot;));</span>
<span class="nc" id="L513">				experiencePanel.add(new JLabel(new ImageIcon(lib.getSmallerUnitImage(expertType))), &quot;spany 2&quot;);</span>
<span class="nc" id="L514">				experiencePanel.add(Utility.localizedLabel(</span>
<span class="nc" id="L515">						StringTemplate.template(&quot;quickActionMenu.experience&quot;).addName(&quot;%job%&quot;, jobName)));</span>
<span class="nc" id="L516">				experiencePanel.add(Utility.localizedLabel(StringTemplate.label(&quot;/&quot;).addName(String.valueOf(experience))</span>
<span class="nc" id="L517">						.addName(String.valueOf(maxExperience))), &quot;align right&quot;);</span>
<span class="nc" id="L518">				experiencePanel.add(Utility.localizedLabel(&quot;quickActionMenu.upgrade&quot;));</span>
<span class="nc" id="L519">				experiencePanel.add(new JLabel(ModifierFormat.format(probability) + &quot;%&quot;), &quot;align right&quot;);</span>
<span class="nc" id="L520">				this.add(experiencePanel);</span>
<span class="nc" id="L521">				separatorNeeded = true;</span>
			}
		}
<span class="nc" id="L524">		return separatorNeeded;</span>
	}

	/**
	 * Adds the command items.
	 *
	 * @param unitLabel
	 *            the unit label
	 * @return true, if successful
	 */
	private boolean addCommandItems(final UnitLabel unitLabel) {
<span class="nc" id="L535">		final Unit tempUnit = unitLabel.getUnit();</span>
<span class="nc" id="L536">		final boolean isUnitAtSea = tempUnit.isAtSea();</span>

<span class="nc" id="L538">		JMenuItem menuItem = Utility.localizedMenuItem(&quot;activateUnit&quot;);</span>
<span class="nc" id="L539">		menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">			if (tempUnit.getState() != Unit.UnitState.ACTIVE) {</span>
<span class="nc" id="L541">				freeColClient.getInGameController().changeState(tempUnit, Unit.UnitState.ACTIVE);</span>
			}
<span class="nc" id="L543">			gui.setActiveUnit(tempUnit);</span>
<span class="nc" id="L544">		});</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">		menuItem.setEnabled(!isUnitAtSea);</span>
<span class="nc" id="L546">		this.add(menuItem);</span>

<span class="nc bnc" id="L548" title="All 2 branches missed.">		if (!(tempUnit.getLocation() instanceof Europe)) {</span>
<span class="nc" id="L549">			menuItem = Utility.localizedMenuItem(&quot;fortify&quot;);</span>
<span class="nc" id="L550">			menuItem.setActionCommand(UnitAction.FORTIFY.toString());</span>
<span class="nc" id="L551">			menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L552" title="All 4 branches missed.">			menuItem.setEnabled((tempUnit.getMovesLeft() &gt; 0) &amp;&amp; !(tempUnit.getState() == Unit.UnitState.FORTIFIED</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">					|| tempUnit.getState() == Unit.UnitState.FORTIFYING));</span>
<span class="nc" id="L554">			this.add(menuItem);</span>
		}

<span class="nc" id="L557">		UnitState unitState = tempUnit.getState();</span>
<span class="nc" id="L558">		menuItem = Utility.localizedMenuItem(&quot;sentry&quot;);</span>
<span class="nc" id="L559">		menuItem.setActionCommand(UnitAction.SENTRY.toString());</span>
<span class="nc" id="L560">		menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L561" title="All 4 branches missed.">		menuItem.setEnabled(unitState != Unit.UnitState.SENTRY &amp;&amp; !isUnitAtSea);</span>
<span class="nc" id="L562">		this.add(menuItem);</span>

<span class="nc bnc" id="L564" title="All 2 branches missed.">		boolean hasTradeRoute = tempUnit.getTradeRoute() != null;</span>
<span class="nc" id="L565">		menuItem = Utility.localizedMenuItem(&quot;clearOrders&quot;);</span>
<span class="nc" id="L566">		menuItem.setActionCommand(UnitAction.CLEAR_ORDERS.toString());</span>
<span class="nc" id="L567">		menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L568" title="All 6 branches missed.">		menuItem.setEnabled((unitState != Unit.UnitState.ACTIVE || hasTradeRoute) &amp;&amp; !isUnitAtSea);</span>
<span class="nc" id="L569">		this.add(menuItem);</span>

<span class="nc bnc" id="L571" title="All 2 branches missed.">		if (tempUnit.isCarrier()) {</span>
<span class="nc" id="L572">			menuItem = Utility.localizedMenuItem(&quot;assignTradeRoute&quot;);</span>
<span class="nc" id="L573">			menuItem.setActionCommand(UnitAction.ASSIGN_TRADE_ROUTE.toString());</span>
<span class="nc" id="L574">			menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">			menuItem.setEnabled(!hasTradeRoute);</span>
<span class="nc" id="L576">			this.add(menuItem);</span>
		}

<span class="nc bnc" id="L579" title="All 4 branches missed.">		if (tempUnit.canCarryTreasure() &amp;&amp; tempUnit.canCashInTreasureTrain()) {</span>
<span class="nc" id="L580">			menuItem = Utility.localizedMenuItem(&quot;cashInTreasureTrain&quot;);</span>
<span class="nc" id="L581">			menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L582">				freeColClient.getInGameController().checkCashInTreasureTrain(tempUnit);</span>
<span class="nc" id="L583">			});</span>
<span class="nc" id="L584">			menuItem.setEnabled(true);</span>
<span class="nc" id="L585">			this.add(menuItem);</span>
		}

<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (tempUnit.getLocation() instanceof Unit) {</span>
<span class="nc" id="L589">			menuItem = Utility.localizedMenuItem(&quot;leaveShip&quot;);</span>
<span class="nc" id="L590">			menuItem.setActionCommand(UnitAction.LEAVE_SHIP.toString());</span>
<span class="nc" id="L591">			menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L592">			menuItem.setEnabled(true);</span>
<span class="nc" id="L593">			this.add(menuItem);</span>
		}

<span class="nc bnc" id="L596" title="All 2 branches missed.">		if (tempUnit.isCarrier()) {</span>
<span class="nc" id="L597">			menuItem = Utility.localizedMenuItem(&quot;unload&quot;);</span>
<span class="nc" id="L598">			menuItem.setActionCommand(UnitAction.UNLOAD.toString());</span>
<span class="nc" id="L599">			menuItem.addActionListener(unitLabel);</span>
<span class="nc bnc" id="L600" title="All 4 branches missed.">			menuItem.setEnabled(tempUnit.hasCargo() &amp;&amp; !isUnitAtSea);</span>
<span class="nc" id="L601">			this.add(menuItem);</span>
		}

<span class="nc" id="L604">		return true;</span>
	}

	/**
	 * Nasty hack to get menu item to change roles.
	 * 
	 * Hacky because we are continuing to express this in terms of equipment
	 * changes despite the point of the role cutover was to get rid of equipment
	 * types. However, its time to release, and we should avoid string changes.
	 * Get rid of this post 0.11.0-release.
	 *
	 * @param unitLabel
	 *            the unit label
	 * @param from
	 *            the from
	 * @param fromCount
	 *            the from count
	 * @param to
	 *            the to
	 * @param toCount
	 *            the to count
	 * @param price
	 *            the price
	 * @return the j menu item
	 */
	private JMenuItem createRoleItem(final UnitLabel unitLabel, final Role from, final int fromCount, final Role to,
			final int toCount, final int price) {
		// Get the text
<span class="nc" id="L632">		String key = &quot;model.role.change.&quot; + to.getSuffix();</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">		if (!Messages.containsKey(key)) {</span>
			// Fall back to the full &quot;from&quot;.&quot;to&quot; key
<span class="nc" id="L635">			key = &quot;model.role.change.&quot; + from.getSuffix() + &quot;.&quot; + to.getSuffix();</span>
		}
<span class="nc" id="L637">		String text = Messages.message(key);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">		if (price &gt; 0) {</span>
<span class="nc" id="L639">			text += &quot; (&quot; + Messages.message(StringTemplate.template(&quot;goldAmount&quot;).addAmount(&quot;%amount%&quot;, price)) + &quot;)&quot;;</span>
		}

		// Get an icon
<span class="nc" id="L643">		AbstractGoods change = null;</span>
<span class="nc" id="L644">		List&lt;AbstractGoods&gt; need = Role.getGoodsDifference(from, fromCount, to, toCount);</span>
<span class="nc bnc" id="L645" title="All 3 branches missed.">		switch (need.size()) {</span>
		case 0:
<span class="nc" id="L647">			break;</span>
		case 1:
<span class="nc" id="L649">			change = need.get(0);</span>
<span class="nc" id="L650">			break;</span>
		default:
<span class="nc bnc" id="L652" title="All 2 branches missed.">			change = find(need, ag -&gt; ag.getAmount() &gt; 0);</span>
			break;
		}
<span class="nc bnc" id="L655" title="All 2 branches missed.">		Icon icon = (change == null) ? null : new ImageIcon(gui.getImageLibrary().getSmallIconImage(change.getType()));</span>

<span class="nc" id="L657">		JMenuItem item = new JMenuItem(text, icon);</span>
<span class="nc" id="L658">		final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L659">		item.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L660">			igc.equipUnitForRole(unitLabel.getUnit(), to, toCount);</span>
<span class="nc" id="L661">			unitLabel.updateIcon();</span>
			// FIXME: fix the PCL handling so this can go away
<span class="nc bnc" id="L663" title="All 2 branches missed.">			if (parentPanel instanceof ColonyPanel) {</span>
<span class="nc" id="L664">				((ColonyPanel) parentPanel).update();</span>
			}
<span class="nc" id="L666">		});</span>
<span class="nc" id="L667">		return item;</span>
	}

	/**
	 * Add menu items for role manipulation for a unit.
	 *
	 * Note &quot;clear speciality&quot; is here too to keep it well separated from other
	 * items.
	 *
	 * @param unitLabel
	 *            The &lt;code&gt;UnitLabel&lt;/code&gt; specifying the unit.
	 * @return True if menu items were added and a separator is now needed.
	 */
	private boolean addRoleItems(final UnitLabel unitLabel) {
<span class="nc" id="L681">		final Unit unit = unitLabel.getUnit();</span>
<span class="nc" id="L682">		final Role role = unit.getRole();</span>
<span class="nc" id="L683">		final int roleCount = unit.getRoleCount();</span>
<span class="nc" id="L684">		boolean separatorNeeded = false;</span>

<span class="nc bnc" id="L686" title="All 2 branches missed.">		UnitLocation uloc = (unit.isInEurope()) ? unit.getOwner().getEurope() : unit.getSettlement();</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">		if (uloc == null)</span>
<span class="nc" id="L688">			return false;</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">		for (Role r : unit.getAvailableRoles(null)) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">			if (r == role)</span>
<span class="nc" id="L691">				continue;</span>
			JMenuItem newItem;
<span class="nc bnc" id="L693" title="All 2 branches missed.">			if (r.isDefaultRole()) { // Always valid</span>
<span class="nc" id="L694">				newItem = createRoleItem(unitLabel, role, roleCount, r, 0, 0);</span>
			} else {
<span class="nc" id="L696">				newItem = null;</span>
<span class="nc bnc" id="L697" title="All 2 branches missed.">				for (int count = r.getMaximumCount(); count &gt; 0; count--) {</span>
<span class="nc" id="L698">					List&lt;AbstractGoods&gt; req = unit.getGoodsDifference(r, count);</span>
<span class="nc" id="L699">					int price = uloc.priceGoods(req);</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">					if (price &lt; 0)</span>
<span class="nc" id="L701">						continue;</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">					if (unit.getOwner().checkGold(price)) {</span>
<span class="nc" id="L703">						newItem = createRoleItem(unitLabel, role, roleCount, r, count, price);</span>
<span class="nc" id="L704">						break;</span>
					}
				}
			}
<span class="nc bnc" id="L708" title="All 2 branches missed.">			if (newItem != null) {</span>
<span class="nc" id="L709">				this.add(newItem);</span>
<span class="nc" id="L710">				separatorNeeded = true;</span>
			}
<span class="nc" id="L712">		}</span>

<span class="nc" id="L714">		UnitType newUnitType = unit.getType().getTargetType(ChangeType.CLEAR_SKILL, unit.getOwner());</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">		if (newUnitType != null) {</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">			if (separatorNeeded)</span>
<span class="nc" id="L717">				this.addSeparator();</span>
<span class="nc" id="L718">			JMenuItem menuItem = Utility.localizedMenuItem(&quot;quickActionMenu.clearSpeciality&quot;,</span>
<span class="nc" id="L719">					new ImageIcon(gui.getImageLibrary().getTinyUnitImage(newUnitType)));</span>
<span class="nc" id="L720">			menuItem.setActionCommand(UnitAction.CLEAR_SPECIALITY.toString());</span>
<span class="nc" id="L721">			menuItem.addActionListener(unitLabel);</span>
<span class="nc" id="L722">			this.add(menuItem);</span>
<span class="nc bnc" id="L723" title="All 4 branches missed.">			if (unit.getLocation() instanceof Building &amp;&amp; !((Building) unit.getLocation()).canAddType(newUnitType)) {</span>
<span class="nc" id="L724">				menuItem.setEnabled(false);</span>
			}
<span class="nc" id="L726">			separatorNeeded = true;</span>
		}
<span class="nc" id="L728">		return separatorNeeded;</span>
	}

	/**
	 * Creates a menu for some goods.
	 *
	 * @param goodsLabel
	 *            the goods label
	 */
	private void createGoodsMenu(final GoodsLabel goodsLabel) {
<span class="nc" id="L738">		final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L739">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L740">		final Goods goods = goodsLabel.getGoods();</span>

<span class="nc" id="L742">		this.setLabel(Messages.message(&quot;cargo&quot;));</span>
<span class="nc" id="L743">		JMenuItem name = new JMenuItem(Messages.getName(goods) + &quot; (&quot; + Messages.message(&quot;colopedia&quot;) + &quot;)&quot;,</span>
<span class="nc" id="L744">				new ImageIcon(gui.getImageLibrary().getSmallIconImage(goods.getType())));</span>
<span class="nc" id="L745">		name.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L746">			gui.showColopediaPanel(goods.getType().getId());</span>
<span class="nc" id="L747">		});</span>
<span class="nc" id="L748">		this.add(name);</span>

<span class="nc bnc" id="L750" title="All 2 branches missed.">		int amount = (player.getMarket() == null) ? 0</span>
<span class="nc" id="L751">				: player.getMarket().getSalePrice(goods.getType(), goods.getAmount());</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">		if (amount &gt; 0)</span>
<span class="nc" id="L753">			amount -= amount * player.getTax() / 100;</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">		if (amount &gt; 0) {</span>
<span class="nc" id="L755">			JMenuItem price = Utility</span>
<span class="nc" id="L756">					.localizedMenuItem(StringTemplate.template(&quot;quickActionMenu.profit&quot;).addAmount(&quot;%amount%&quot;, amount));</span>
<span class="nc" id="L757">			this.add(price);</span>
		}

<span class="nc bnc" id="L760" title="All 2 branches missed.">		if (goods.getLocation() instanceof Colony) {</span>
<span class="nc" id="L761">			Colony colony = (Colony) goods.getLocation();</span>
<span class="nc" id="L762">			addLoadItems(goods, colony.getTile());</span>

<span class="nc bnc" id="L764" title="All 2 branches missed.">		} else if (goods.getLocation() instanceof Europe) {</span>
<span class="nc" id="L765">			Europe europe = (Europe) goods.getLocation();</span>
<span class="nc" id="L766">			addLoadItems(goods, europe);</span>
<span class="nc bnc" id="L767" title="All 2 branches missed.">			if (!player.canTrade(goods.getType())) {</span>
<span class="nc" id="L768">				addPayArrears(goods.getType());</span>
			}

<span class="nc bnc" id="L771" title="All 2 branches missed.">		} else if (goods.getLocation() instanceof Unit) {</span>
<span class="nc" id="L772">			Unit carrier = (Unit) goods.getLocation();</span>

<span class="nc bnc" id="L774" title="All 2 branches missed.">			if (carrier.getLocation().getColony() != null</span>
<span class="nc bnc" id="L775" title="All 4 branches missed.">					|| (carrier.isInEurope() &amp;&amp; player.canTrade(goods.getType()))) {</span>
<span class="nc" id="L776">				JMenuItem unload = Utility.localizedMenuItem(&quot;unload&quot;);</span>
<span class="nc" id="L777">				unload.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">					if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L779">						promptForGoods(goods);</span>
					}
<span class="nc" id="L781">					igc.unloadCargo(goods, false);</span>
<span class="nc" id="L782">				});</span>
<span class="nc" id="L783">				this.add(unload);</span>
<span class="nc" id="L784">			} else {</span>
<span class="nc bnc" id="L785" title="All 4 branches missed.">				if (carrier.isInEurope() &amp;&amp; !player.canTrade(goods.getType())) {</span>
<span class="nc" id="L786">					addPayArrears(goods.getType());</span>
				}

<span class="nc" id="L789">				JMenuItem dump = Utility.localizedMenuItem(&quot;dumpCargo&quot;);</span>
<span class="nc" id="L790">				dump.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">					if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L792">						promptForGoods(goods);</span>
					}
<span class="nc" id="L794">					igc.unloadCargo(goods, true);</span>
					// FIXME: fix pcls so this hackery can go away
<span class="nc bnc" id="L796" title="All 2 branches missed.">					if (parentPanel instanceof CargoPanel) {</span>
<span class="nc" id="L797">						((CargoPanel) parentPanel).initialize();</span>
					}
<span class="nc" id="L799">					parentPanel.revalidate();</span>
<span class="nc" id="L800">				});</span>
<span class="nc" id="L801">				this.add(dump);</span>
			}
		}
<span class="nc" id="L804">	}</span>

	/**
	 * Add an item to pay arrears on the given goods type.
	 *
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to pay arrears on.
	 */
	private void addPayArrears(final GoodsType goodsType) {
<span class="nc" id="L813">		final InGameController igc = freeColClient.getInGameController();</span>

<span class="nc" id="L815">		JMenuItem menuItem = Utility.localizedMenuItem(&quot;payArrears&quot;);</span>
<span class="nc" id="L816">		menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L817">			igc.payArrears(goodsType);</span>
			// FIXME: fix pcls so this hackery can go away
<span class="nc bnc" id="L819" title="All 2 branches missed.">			if (parentPanel instanceof CargoPanel) {</span>
<span class="nc" id="L820">				CargoPanel cargoPanel = (CargoPanel) parentPanel;</span>
<span class="nc" id="L821">				cargoPanel.initialize();</span>
			}
<span class="nc" id="L823">			parentPanel.revalidate();</span>
<span class="nc" id="L824">		});</span>
<span class="nc" id="L825">		this.add(menuItem);</span>
<span class="nc" id="L826">	}</span>

	/**
	 * Creates menu items for some goods in a market.
	 *
	 * @param marketLabel
	 *            The &lt;code&gt;MarketLabel&lt;/code&gt; to create entries for.
	 */
	private void createMarketMenu(MarketLabel marketLabel) {
<span class="nc" id="L835">		final AbstractGoods ag = marketLabel.getAbstractGoods();</span>
<span class="nc" id="L836">		final Player player = freeColClient.getMyPlayer();</span>

<span class="nc" id="L838">		this.setLabel(Messages.message(&quot;cargo&quot;));</span>
<span class="nc" id="L839">		JMenuItem name = new JMenuItem(Messages.getName(ag) + &quot; (&quot; + Messages.message(&quot;colopedia&quot;) + &quot;)&quot;,</span>
<span class="nc" id="L840">				new ImageIcon(gui.getImageLibrary().getSmallIconImage(ag.getType())));</span>
<span class="nc" id="L841">		name.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L842">			gui.showColopediaPanel(ag.getType().getId());</span>
<span class="nc" id="L843">		});</span>
<span class="nc" id="L844">		this.add(name);</span>

<span class="nc" id="L846">		final Europe europe = this.freeColClient.getMyPlayer().getEurope();</span>
<span class="nc" id="L847">		addMarketItems(ag, europe);</span>

<span class="nc bnc" id="L849" title="All 2 branches missed.">		if (!player.canTrade(ag.getType())) {</span>
<span class="nc" id="L850">			addPayArrears(ag.getType());</span>
		}
<span class="nc" id="L852">	}</span>

	/**
	 * Adds the market items.
	 *
	 * @param ag
	 *            the ag
	 * @param europe
	 *            the europe
	 * @return true, if successful
	 */
	private boolean addMarketItems(final AbstractGoods ag, Europe europe) {
<span class="nc" id="L864">		final InGameController igc = freeColClient.getInGameController();</span>
<span class="nc" id="L865">		final Goods goods = new Goods(europe.getGame(), null, ag.getType(), ag.getAmount());</span>
<span class="nc" id="L866">		boolean added = false;</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">		for (final Unit unit : europe.getUnitList()) {</span>
<span class="nc bnc" id="L868" title="All 6 branches missed.">			if (unit.isCarrier() &amp;&amp; unit.canCarryGoods() &amp;&amp; unit.canAdd(goods)) {</span>
<span class="nc" id="L869">				StringTemplate template = StringTemplate.template(&quot;loadOnTo&quot;).addStringTemplate(&quot;%unit%&quot;,</span>
<span class="nc" id="L870">						unit.getLabel(Unit.UnitLabelType.NATIONAL));</span>
<span class="nc" id="L871">				JMenuItem menuItem = Utility.localizedMenuItem(template);</span>
<span class="nc" id="L872">				menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">					if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0) {</span>
<span class="nc" id="L874">						promptForGoods(ag);</span>
					}
<span class="nc" id="L876">					igc.buyGoods(ag.getType(), ag.getAmount(), unit);</span>
<span class="nc" id="L877">				});</span>
<span class="nc" id="L878">				this.add(menuItem);</span>
<span class="nc" id="L879">				added = true;</span>
			}
<span class="nc" id="L881">		}</span>
<span class="nc" id="L882">		return added;</span>
	}

	/**
	 * Creates a menu for a tile.
	 *
	 * @param singleTilePanel
	 *            the single tile panel
	 */
	private void createTileMenu(final ASingleTilePanel singleTilePanel) {
<span class="nc bnc" id="L892" title="All 4 branches missed.">		if (singleTilePanel.getColonyTile() != null &amp;&amp; singleTilePanel.getColonyTile().getColony() != null) {</span>
<span class="nc" id="L893">			addTileItem(singleTilePanel.getColonyTile().getWorkTile());</span>
		}
<span class="nc" id="L895">	}</span>

	/**
	 * Add a menu item for the tile a unit is working.
	 *
	 * @param unitLabel
	 *            The &lt;code&gt;UnitLabel&lt;/code&gt; specifying the unit.
	 * @return True if an item was added.
	 */
	private boolean addTileItem(final UnitLabel unitLabel) {
<span class="nc" id="L905">		final Unit unit = unitLabel.getUnit();</span>
<span class="nc bnc" id="L906" title="All 2 branches missed.">		if (unit.getWorkTile() != null) {</span>
<span class="nc" id="L907">			final Tile tile = unit.getWorkTile().getWorkTile();</span>
<span class="nc" id="L908">			addTileItem(tile);</span>
<span class="nc" id="L909">			return true;</span>
		}
<span class="nc" id="L911">		return false;</span>
	}

	/**
	 * Add a menu item to show the tile panel for a tile.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to use.
	 */
	private void addTileItem(final Tile tile) {
<span class="nc bnc" id="L921" title="All 2 branches missed.">		if (tile != null) {</span>
<span class="nc" id="L922">			JMenuItem menuItem = new JMenuItem(Messages.getName(tile));</span>
<span class="nc" id="L923">			menuItem.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L924">				gui.showTilePanel(tile);</span>
<span class="nc" id="L925">			});</span>
<span class="nc" id="L926">			this.add(menuItem);</span>
		}
<span class="nc" id="L928">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>