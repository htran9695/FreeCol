<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Specification.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.common.model</a> &gt; <span class="el_source">Specification.java</span></div><h1>Specification.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.common.model;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.reflect.Constructor;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.function.Predicate;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.io.FreeColDirectories;
import net.sf.freecol.common.io.FreeColModFile;
import net.sf.freecol.common.io.FreeColTcFile;
import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.io.FreeColXMLWriter;
import net.sf.freecol.common.model.NationOptions.Advantages;
import net.sf.freecol.common.option.AbstractOption;
import net.sf.freecol.common.option.AbstractUnitOption;
import net.sf.freecol.common.option.BooleanOption;
import net.sf.freecol.common.option.IntegerOption;
import net.sf.freecol.common.option.MapGeneratorOptions;
import net.sf.freecol.common.option.Option;
import net.sf.freecol.common.option.OptionGroup;
import net.sf.freecol.common.option.RangeOption;
import net.sf.freecol.common.option.StringOption;
import net.sf.freecol.common.option.TextOption;
import net.sf.freecol.common.option.UnitListOption;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.StringUtils.*;

/**
 * This class encapsulates any parts of the &quot;specification&quot; for FreeCol that are
 * expressed best using XML. The XML is loaded through the class loader from the
 * resource named &quot;specification.xml&quot; in the same package as this class.
 */
public final class Specification {

	/** The Constant logger. */
<span class="fc" id="L73">	private static final Logger logger = Logger.getLogger(Specification.class.getName());</span>

	/** The difficulty levels option group is special. */
	private static final String DIFFICULTY_LEVELS = &quot;difficultyLevels&quot;;

	/** Roles backward compatibility fragment. */
	public static final String ROLES_COMPAT_FILE_NAME = &quot;roles-compat.xml&quot;;

	/** The default role. */
	public static final String DEFAULT_ROLE_ID = &quot;model.role.default&quot;;

	/** How many game ages. */
	public static final int NUMBER_OF_AGES = 3;

	/**
	 * The Class Source.
	 */
	public static class Source extends FreeColGameObjectType {

		/**
		 * Trivial constructor.
		 *
		 * @param id
		 *            The object identifier.
		 */
		public Source(String id) {
<span class="fc" id="L99">			super(id);</span>
<span class="fc" id="L100">		}</span>

		/**
		 * {@inheritDoc}
		 */
		@Override
		public void toXML(FreeColXMLWriter xw) {
<span class="nc" id="L107">			throw new RuntimeException(&quot;Can not happen&quot;);</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String toString() {
<span class="nc" id="L115">			return getId();</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String getXMLTagName() {
<span class="nc" id="L123">			return &quot;source&quot;;</span>
		}
	};

	/** The Constant AMBUSH_BONUS_SOURCE. */
<span class="fc" id="L128">	public static final Source AMBUSH_BONUS_SOURCE = new Source(&quot;model.source.ambushBonus&quot;);</span>

	/** The Constant AMPHIBIOUS_ATTACK_PENALTY_SOURCE. */
<span class="fc" id="L131">	public static final Source AMPHIBIOUS_ATTACK_PENALTY_SOURCE = new Source(&quot;model.source.amphibiousAttack&quot;);</span>

	/** The Constant ARTILLERY_PENALTY_SOURCE. */
<span class="fc" id="L134">	public static final Source ARTILLERY_PENALTY_SOURCE = new Source(&quot;model.source.artilleryInTheOpen&quot;);</span>

	/** The Constant ATTACK_BONUS_SOURCE. */
<span class="fc" id="L137">	public static final Source ATTACK_BONUS_SOURCE = new Source(&quot;model.source.attackBonus&quot;);</span>

	/** The Constant BASE_DEFENCE_SOURCE. */
<span class="fc" id="L140">	public static final Source BASE_DEFENCE_SOURCE = new Source(&quot;model.source.baseDefence&quot;);</span>

	/** The Constant BASE_OFFENCE_SOURCE. */
<span class="fc" id="L143">	public static final Source BASE_OFFENCE_SOURCE = new Source(&quot;model.source.baseOffence&quot;);</span>

	/** The Constant CARGO_PENALTY_SOURCE. */
<span class="fc" id="L146">	public static final Source CARGO_PENALTY_SOURCE = new Source(&quot;model.source.cargoPenalty&quot;);</span>

	/** The Constant COLONY_GOODS_PARTY_SOURCE. */
<span class="fc" id="L149">	public static final Source COLONY_GOODS_PARTY_SOURCE = new Source(&quot;model.source.colonyGoodsParty&quot;);</span>

	/** The Constant FORTIFICATION_BONUS_SOURCE. */
<span class="fc" id="L152">	public static final Source FORTIFICATION_BONUS_SOURCE = new Source(&quot;model.source.fortified&quot;);</span>

	/** The Constant INDIAN_RAID_BONUS_SOURCE. */
<span class="fc" id="L155">	public static final Source INDIAN_RAID_BONUS_SOURCE = new Source(&quot;model.source.artilleryAgainstRaid&quot;);</span>

	/** The Constant MOVEMENT_PENALTY_SOURCE. */
<span class="fc" id="L158">	public static final Source MOVEMENT_PENALTY_SOURCE = new Source(&quot;model.source.movementPenalty&quot;);</span>

	/** The Constant SHIP_TRADE_PENALTY_SOURCE. */
<span class="fc" id="L161">	public static final Source SHIP_TRADE_PENALTY_SOURCE = new Source(&quot;model.source.shipTradePenalty&quot;);</span>

	/** The Constant SOL_MODIFIER_SOURCE. */
<span class="fc" id="L164">	public static final Source SOL_MODIFIER_SOURCE = new Source(&quot;model.source.solModifier&quot;);</span>
	/** All the special static sources. */
<span class="fc" id="L166">	private static final Source[] sources = new Source[] { MOVEMENT_PENALTY_SOURCE, ARTILLERY_PENALTY_SOURCE,</span>
			ATTACK_BONUS_SOURCE, FORTIFICATION_BONUS_SOURCE, INDIAN_RAID_BONUS_SOURCE, AMPHIBIOUS_ATTACK_PENALTY_SOURCE,
			BASE_OFFENCE_SOURCE, BASE_DEFENCE_SOURCE, CARGO_PENALTY_SOURCE, AMBUSH_BONUS_SOURCE,
			COLONY_GOODS_PARTY_SOURCE, SHIP_TRADE_PENALTY_SOURCE, SOL_MODIFIER_SOURCE };

	/** A map from specification element to a reader for that element. */
<span class="fc" id="L172">	private final Map&lt;String, ChildReader&gt; readerMap = new HashMap&lt;&gt;();</span>

	/* Containers filled from readers in the readerMap. */

	/** The building type list. */
	// readerMap(&quot;building-types&quot;)
<span class="fc" id="L178">	private final List&lt;BuildingType&gt; buildingTypeList = new ArrayList&lt;&gt;();</span>

	/** The disasters. */
	// readerMap(&quot;disasters&quot;)
<span class="fc" id="L182">	private final List&lt;Disaster&gt; disasters = new ArrayList&lt;&gt;();</span>

	/** The equipment types. */
	// @compat 0.10.x readerMap(&quot;equipment-types&quot;)
<span class="fc" id="L186">	private final List&lt;EquipmentType&gt; equipmentTypes = new ArrayList&lt;&gt;();</span>
	// end @compat 0.10.x
	/** The european nation types. */
	// readerMap(&quot;european-nation-types&quot;)
<span class="fc" id="L190">	private final List&lt;EuropeanNationType&gt; europeanNationTypes = new ArrayList&lt;&gt;();</span>

	/** The events. */
	// readerMap(&quot;events&quot;)
<span class="fc" id="L194">	private final List&lt;Event&gt; events = new ArrayList&lt;&gt;();</span>

	/** The founding fathers. */
	// readerMap(&quot;founding-fathers&quot;)
<span class="fc" id="L198">	private final List&lt;FoundingFather&gt; foundingFathers = new ArrayList&lt;&gt;();</span>

	/** The goods type list. */
	// readerMap(&quot;goods-types&quot;)
<span class="fc" id="L202">	private final List&lt;GoodsType&gt; goodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The indian nation types. */
	// readerMap(&quot;indian-nation-types&quot;)
<span class="fc" id="L206">	private final List&lt;IndianNationType&gt; indianNationTypes = new ArrayList&lt;&gt;();</span>

	/** The nations. */
	// readerMap(&quot;nations&quot;)
<span class="fc" id="L210">	private final List&lt;Nation&gt; nations = new ArrayList&lt;&gt;();</span>

	/** The resource type list. */
	// readerMap(&quot;resource-types&quot;)
<span class="fc" id="L214">	private final List&lt;ResourceType&gt; resourceTypeList = new ArrayList&lt;&gt;();</span>

	/** The roles. */
	// readerMap(&quot;roles&quot;)
<span class="fc" id="L218">	private final List&lt;Role&gt; roles = new ArrayList&lt;&gt;();</span>

	/** The tile type list. */
	// readerMap(&quot;tile-types&quot;)
<span class="fc" id="L222">	private final List&lt;TileType&gt; tileTypeList = new ArrayList&lt;&gt;();</span>

	/** The tile improvement type list. */
	// readerMap(&quot;tile-improvement-types&quot;)
<span class="fc" id="L226">	private final List&lt;TileImprovementType&gt; tileImprovementTypeList = new ArrayList&lt;&gt;();</span>

	/** The unit type list. */
	// readerMap(&quot;unit-types&quot;)
<span class="fc" id="L230">	private final List&lt;UnitType&gt; unitTypeList = new ArrayList&lt;&gt;();</span>

	/** The all modifiers. */
	// readerMap(&quot;modifiers&quot;)
<span class="fc" id="L234">	private final Map&lt;String, List&lt;Modifier&gt;&gt; allModifiers = new HashMap&lt;&gt;();</span>

	/** The special modifiers. */
<span class="fc" id="L237">	private final List&lt;Modifier&gt; specialModifiers = new ArrayList&lt;&gt;();</span>

	/** The all options. */
	// readerMap(&quot;options&quot;)
<span class="fc" id="L241">	private final Map&lt;String, AbstractOption&gt; allOptions = new HashMap&lt;&gt;();</span>

	/** The all option groups. */
<span class="fc" id="L244">	private final Map&lt;String, OptionGroup&gt; allOptionGroups = new HashMap&lt;&gt;();</span>

	/* Containers derived from readerMap containers */

	/** The storable goods type list. */
	// Derived from readerMap container: goodsTypeList
<span class="fc" id="L250">	private final List&lt;GoodsType&gt; storableGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The farmed goods type list. */
<span class="fc" id="L253">	private final List&lt;GoodsType&gt; farmedGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The food goods type list. */
<span class="fc" id="L256">	private final List&lt;GoodsType&gt; foodGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The new world goods type list. */
<span class="fc" id="L259">	private final List&lt;GoodsType&gt; newWorldGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The new world luxury goods type list. */
<span class="fc" id="L262">	private final List&lt;GoodsType&gt; newWorldLuxuryGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The liberty goods type list. */
<span class="fc" id="L265">	private final List&lt;GoodsType&gt; libertyGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The immigration goods type list. */
<span class="fc" id="L268">	private final List&lt;GoodsType&gt; immigrationGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The raw building goods type list. */
<span class="fc" id="L271">	private final List&lt;GoodsType&gt; rawBuildingGoodsTypeList = new ArrayList&lt;&gt;();</span>

	/** The european nations. */
	// Derived from readerMap container: nations
<span class="fc" id="L275">	private final List&lt;Nation&gt; europeanNations = new ArrayList&lt;&gt;();</span>

	/** The REF nations. */
<span class="fc" id="L278">	private final List&lt;Nation&gt; REFNations = new ArrayList&lt;&gt;();</span>

	/** The indian nations. */
<span class="fc" id="L281">	private final List&lt;Nation&gt; indianNations = new ArrayList&lt;&gt;();</span>

	/** The nation types. */
	// Derived from readerMap containers: indianNationTypes europeanNationTypes
<span class="fc" id="L285">	private final List&lt;NationType&gt; nationTypes = new ArrayList&lt;&gt;();</span>

	/** The REF nation types. */
	// Derived from readerMap container: europeanNationTypes
<span class="fc" id="L289">	private final List&lt;EuropeanNationType&gt; REFNationTypes = new ArrayList&lt;&gt;();</span>

	/** The buildable unit types. */
	// Derived from readerMap container: unitTypeList
<span class="fc" id="L293">	private final ArrayList&lt;UnitType&gt; buildableUnitTypes = new ArrayList&lt;&gt;();</span>

	/** The experts. */
<span class="fc" id="L296">	private final Map&lt;GoodsType, UnitType&gt; experts = new HashMap&lt;&gt;();</span>

	/** The unit types trained in europe. */
<span class="fc" id="L299">	private final List&lt;UnitType&gt; unitTypesTrainedInEurope = new ArrayList&lt;&gt;();</span>

	/** The unit types purchased in europe. */
<span class="fc" id="L302">	private final List&lt;UnitType&gt; unitTypesPurchasedInEurope = new ArrayList&lt;&gt;();</span>

	/** The fastest land unit type. */
<span class="fc" id="L305">	private UnitType fastestLandUnitType = null;</span>

	/** The fastest naval unit type. */
<span class="fc" id="L308">	private UnitType fastestNavalUnitType = null;</span>

	/** The default unit types. */
<span class="fc" id="L311">	private final List&lt;UnitType&gt; defaultUnitTypes = new ArrayList&lt;&gt;();</span>

	/* Other containers. */

	/** The father goods fix map. */
	// @compat 0.10.7
<span class="fc" id="L317">	public final Map&lt;String, String&gt; fatherGoodsFixMap = new HashMap&lt;&gt;();</span>
	// end @compat 0.10.7

	/** The all types. */
<span class="fc" id="L321">	private final Map&lt;String, FreeColGameObjectType&gt; allTypes = new HashMap&lt;&gt;();</span>

	/** The all abilities. */
<span class="fc" id="L324">	private final Map&lt;String, List&lt;Ability&gt;&gt; allAbilities = new HashMap&lt;&gt;();</span>

	/** A cache of the military roles in decreasing order. Do not serialize. */
<span class="fc" id="L327">	private List&lt;Role&gt; militaryRoles = null;</span>

	/** The initialized. */
<span class="fc" id="L330">	private boolean initialized = false;</span>

	/** The specification identifier. */
	private String id;

	/** The specification version. */
	private String version;

	/** The name of the difficulty level option group. */
<span class="fc" id="L339">	private String difficultyLevel = null;</span>

	/** The turn number for the game ages for FF recruitment. */
<span class="fc" id="L342">	private final int[] ages = new int[NUMBER_OF_AGES];</span>

	/**
	 * Creates a new Specification object.
	 */
<span class="fc" id="L347">	public Specification() {</span>
<span class="fc" id="L348">		logger.fine(&quot;Initializing Specification&quot;);</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">		for (Source source : sources)</span>
<span class="fc" id="L350">			allTypes.put(source.getId(), source);</span>

<span class="fc" id="L352">		readerMap.put(BUILDING_TYPES_TAG, new TypeReader&lt;&gt;(BuildingType.class, buildingTypeList));</span>
<span class="fc" id="L353">		readerMap.put(DISASTERS_TAG, new TypeReader&lt;&gt;(Disaster.class, disasters));</span>
		// @compat 0.10.x
<span class="fc" id="L355">		readerMap.put(EQUIPMENT_TYPES_TAG, new TypeReader&lt;&gt;(EquipmentType.class, equipmentTypes));</span>
		// end @compat 0.10.x
<span class="fc" id="L357">		readerMap.put(EUROPEAN_NATION_TYPES_TAG, new TypeReader&lt;&gt;(EuropeanNationType.class, europeanNationTypes));</span>
<span class="fc" id="L358">		readerMap.put(EVENTS_TAG, new TypeReader&lt;&gt;(Event.class, events));</span>
<span class="fc" id="L359">		readerMap.put(FOUNDING_FATHERS_TAG, new TypeReader&lt;&gt;(FoundingFather.class, foundingFathers));</span>
<span class="fc" id="L360">		readerMap.put(GOODS_TYPES_TAG, new TypeReader&lt;&gt;(GoodsType.class, goodsTypeList));</span>
<span class="fc" id="L361">		readerMap.put(INDIAN_NATION_TYPES_TAG, new TypeReader&lt;&gt;(IndianNationType.class, indianNationTypes));</span>
<span class="fc" id="L362">		readerMap.put(NATIONS_TAG, new TypeReader&lt;&gt;(Nation.class, nations));</span>
<span class="fc" id="L363">		readerMap.put(RESOURCE_TYPES_TAG, new TypeReader&lt;&gt;(ResourceType.class, resourceTypeList));</span>
<span class="fc" id="L364">		readerMap.put(ROLES_TAG, new TypeReader&lt;&gt;(Role.class, roles));</span>
<span class="fc" id="L365">		readerMap.put(TILE_TYPES_TAG, new TypeReader&lt;&gt;(TileType.class, tileTypeList));</span>
<span class="fc" id="L366">		readerMap.put(TILE_IMPROVEMENT_TYPES_TAG, new TypeReader&lt;&gt;(TileImprovementType.class, tileImprovementTypeList));</span>
		// @compat 0.11.3
<span class="fc" id="L368">		readerMap.put(OLD_TILEIMPROVEMENT_TYPES_TAG,</span>
				new TypeReader&lt;&gt;(TileImprovementType.class, tileImprovementTypeList));
		// end @compat 0.11.3
<span class="fc" id="L371">		readerMap.put(UNIT_TYPES_TAG, new TypeReader&lt;&gt;(UnitType.class, unitTypeList));</span>

<span class="fc" id="L373">		readerMap.put(MODIFIERS_TAG, new ModifierReader());</span>
<span class="fc" id="L374">		readerMap.put(OPTIONS_TAG, new OptionReader());</span>
<span class="fc" id="L375">	}</span>

	/**
	 * Creates a new Specification object by loading it from the given
	 * &lt;code&gt;FreeColXMLReader&lt;/code&gt;.
	 *
	 * @param xr
	 *            The &lt;code&gt;FreeColXMLReader&lt;/code&gt; to read from.
	 */
	public Specification(FreeColXMLReader xr) {
<span class="fc" id="L385">		this();</span>
<span class="fc" id="L386">		initialized = false;</span>
<span class="fc" id="L387">		load(xr);</span>
<span class="fc" id="L388">		prepare(null, difficultyLevel);</span>
<span class="fc" id="L389">		clean(&quot;load from stream&quot;);</span>
<span class="fc" id="L390">		initialized = true;</span>
<span class="fc" id="L391">	}</span>

	/**
	 * Load a specification or fragment from a stream.
	 *
	 * @param xr
	 *            The &lt;code&gt;FreeColXMLReader&lt;/code&gt; to read from.
	 */
	private void load(FreeColXMLReader xr) {
		try {
<span class="fc" id="L401">			readFromXML(xr);</span>
<span class="nc" id="L402">		} catch (Exception e) {</span>
<span class="nc" id="L403">			throw new RuntimeException(&quot;Error parsing specification&quot;, e);</span>
<span class="fc" id="L404">		}</span>
<span class="fc" id="L405">	}</span>

	/**
	 * Creates a new Specification object by loading it from the given
	 * &lt;code&gt;InputStream&lt;/code&gt;.
	 *
	 * @param in
	 *            The &lt;code&gt;InputStream&lt;/code&gt; to read from.
	 */
	public Specification(InputStream in) {
<span class="fc" id="L415">		this();</span>
<span class="fc" id="L416">		initialized = false;</span>
<span class="fc" id="L417">		load(in);</span>
<span class="fc" id="L418">		prepare(null, difficultyLevel);</span>
<span class="fc" id="L419">		clean(&quot;load from InputStream&quot;);</span>
<span class="fc" id="L420">		initialized = true;</span>
<span class="fc" id="L421">	}</span>

	/**
	 * Load a specification or fragment from a stream.
	 *
	 * @param in
	 *            The &lt;code&gt;InputStream&lt;/code&gt; to read from.
	 */
	private void load(InputStream in) {
<span class="pc" id="L430">		try (FreeColXMLReader xr = new FreeColXMLReader(in);) {</span>
<span class="fc" id="L431">			xr.nextTag();</span>
<span class="fc" id="L432">			load(xr);</span>
<span class="pc bpc" id="L433" title="6 of 8 branches missed.">		} catch (Exception e) {</span>
<span class="nc" id="L434">			throw new RuntimeException(&quot;Load specification stream error&quot;, e);</span>
<span class="fc" id="L435">		}</span>
<span class="fc" id="L436">	}</span>

	/**
	 * Prepare a specification with given advantages and difficulty level.
	 *
	 * @param advantages
	 *            An optional &lt;code&gt;Advantages&lt;/code&gt; setting.
	 * @param difficulty
	 *            An optional identifier for the difficulty level.
	 */
	public void prepare(Advantages advantages, String difficulty) {
<span class="fc bfc" id="L447" title="All 2 branches covered.">		prepare(advantages, (difficulty == null) ? null : getDifficultyOptionGroup(difficulty));</span>
<span class="fc" id="L448">	}</span>

	/**
	 * Prepare a specification with given advantages and difficulty level.
	 *
	 * @param advantages
	 *            An optional &lt;code&gt;Advantages&lt;/code&gt; setting.
	 * @param difficulty
	 *            An optional difficulty level &lt;code&gt;OptionGroup&lt;/code&gt;.
	 */
	public void prepare(Advantages advantages, OptionGroup difficulty) {
<span class="fc" id="L459">		applyFixes();</span>
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">		if (advantages == Advantages.NONE) {</span>
<span class="nc" id="L461">			clearEuropeanNationalAdvantages();</span>
		}
<span class="fc bfc" id="L463" title="All 2 branches covered.">		if (difficulty != null) {</span>
<span class="fc" id="L464">			allOptionGroups.put(difficulty.getId(), difficulty);</span>
<span class="fc" id="L465">			applyDifficultyLevel(difficulty);</span>
		}
<span class="fc" id="L467">	}</span>

	/**
	 * Load mods into this specification.
	 *
	 * @param mods
	 *            A list of &lt;code&gt;FreeColModFile&lt;/code&gt;s for the active mods.
	 * @return True if any mod was loaded.
	 */
	public boolean loadMods(List&lt;FreeColModFile&gt; mods) {
<span class="fc" id="L477">		initialized = false;</span>
<span class="fc" id="L478">		boolean loadedMod = false;</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">		for (FreeColModFile mod : mods) {</span>
<span class="fc" id="L480">			InputStream sis = null;</span>
			try {
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">				if ((sis = mod.getSpecificationInputStream()) != null) {</span>
					// Some mods are resource only
<span class="fc" id="L484">					load(sis);</span>
				}
<span class="fc" id="L486">				loadedMod = true;</span>
<span class="fc" id="L487">				logger.info(&quot;Loaded mod &quot; + mod.getId());</span>
<span class="nc" id="L488">			} catch (IOException ioe) {</span>
<span class="nc" id="L489">				logger.log(Level.WARNING, &quot;Read error in mod &quot; + mod.getId(), ioe);</span>
<span class="nc" id="L490">			} catch (RuntimeException rte) {</span>
<span class="nc" id="L491">				logger.log(Level.WARNING, &quot;Parse error in mod &quot; + mod.getId(), rte);</span>
<span class="pc" id="L492">			}</span>
<span class="fc" id="L493">		}</span>
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">		if (loadedMod)</span>
<span class="fc" id="L495">			clean(&quot;mod loading&quot;);</span>
<span class="fc" id="L496">		initialized = true;</span>
<span class="fc" id="L497">		return loadedMod;</span>
	}

	/**
	 * Load a limited set of options from a file.
	 *
	 * Useful to load the user game and map generator options before starting a
	 * new game.
	 *
	 * @param optionId
	 *            The root identifier of an option group expected to be found in
	 *            the file.
	 * @param file
	 *            The &lt;code&gt;File&lt;/code&gt; to load from.
	 * @return The &lt;code&gt;OptionGroup&lt;/code&gt; found.
	 */
	public OptionGroup loadOptionsFile(String optionId, File file) {
<span class="nc" id="L514">		OptionGroup group = null;</span>
<span class="nc" id="L515">		try (FileInputStream fis = new FileInputStream(file); FreeColXMLReader xr = new FreeColXMLReader(fis);) {</span>
<span class="nc" id="L516">			xr.nextTag();</span>
<span class="nc" id="L517">			group = new OptionGroup(this);</span>
<span class="nc" id="L518">			group.readFromXML(xr);</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">			if (!optionId.equals(group.getId())) {</span>
<span class="nc" id="L520">				Option op = group.getOption(optionId);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">				group = (op instanceof OptionGroup) ? (OptionGroup) op : null;</span>
			}
<span class="nc bnc" id="L523" title="All 2 branches missed.">			logger.info(&quot;Loaded &quot; + optionId + &quot; group from file &quot; + file.getPath()</span>
					+ ((group == null) ? &quot; failed&quot; : &quot; succeeded&quot;));
<span class="nc bnc" id="L525" title="All 16 branches missed.">		} catch (Exception e) {</span>
<span class="nc" id="L526">			logger.log(Level.WARNING, &quot;Failed to load OptionGroup &quot; + optionId + &quot; from &quot; + file.getName(), e);</span>
<span class="nc" id="L527">		}</span>
<span class="nc" id="L528">		return group;</span>
	}

	/**
	 * Merge an option group into the spec.
	 *
	 * @param group
	 *            The &lt;code&gt;OptionGroup&lt;/code&gt; to merge.
	 * @return The merged &lt;code&gt;OptionGroup&lt;/code&gt; from this
	 *         &lt;code&gt;Specification&lt;/code&gt;.
	 */
	public OptionGroup mergeGroup(OptionGroup group) {
<span class="nc" id="L540">		OptionGroup realGroup = allOptionGroups.get(group.getId());</span>
<span class="nc bnc" id="L541" title="All 4 branches missed.">		if (realGroup == null || !realGroup.isEditable())</span>
<span class="nc" id="L542">			return realGroup;</span>

<span class="nc bnc" id="L544" title="All 2 branches missed.">		for (Option o : group.getOptions()) {</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">			if (o instanceof OptionGroup) {</span>
<span class="nc" id="L546">				mergeGroup((OptionGroup) o);</span>
			} else {
<span class="nc" id="L548">				realGroup.add(o);</span>
			}
<span class="nc" id="L550">		}</span>
<span class="nc" id="L551">		return realGroup;</span>
	}

	/**
	 * Save a limited set of options to a file.
	 *
	 * Useful to save the user game and map generator options before starting a
	 * new game.
	 *
	 * @param group
	 *            The &lt;code&gt;OptionGroup&lt;/code&gt; to save.
	 * @param file
	 *            The &lt;code&gt;File&lt;/code&gt; to save to.
	 * @return The &lt;code&gt;OptionGroup&lt;/code&gt; saved, or null on error.
	 */
	public static OptionGroup saveOptionsFile(OptionGroup group, File file) {
<span class="nc bnc" id="L567" title="All 2 branches missed.">		if (group != null) {</span>
			try {
<span class="nc bnc" id="L569" title="All 2 branches missed.">				return (group.save(file, FreeColXMLWriter.WriteScope.toSave(), true)) ? group : null;</span>
<span class="nc" id="L570">			} catch (Exception e) {</span>
<span class="nc" id="L571">				logger.log(Level.WARNING, &quot;Failed to save option group &quot; + group.getId() + &quot; to &quot; + file.getName(), e);</span>
			}
		}
<span class="nc" id="L574">		return null;</span>
	}

	/**
	 * Clean up the specification.
	 *
	 * Builds all the cached containers and secondary variables. This *must*
	 * clear any containers before building as it may be called multiple times
	 * in response to various specification updates.
	 *
	 * @param why
	 *            A short statement of why the specification needed to be
	 *            cleaned.
	 */
	public void clean(String why) {
<span class="fc" id="L589">		logger.finest(&quot;Cleaning up specification following &quot; + why + &quot;.&quot;);</span>

<span class="fc" id="L591">		Iterator&lt;FreeColGameObjectType&gt; typeIterator = allTypes.values().iterator();</span>
<span class="fc bfc" id="L592" title="All 2 branches covered.">		while (typeIterator.hasNext()) {</span>
<span class="fc" id="L593">			FreeColGameObjectType type = typeIterator.next();</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">			if (type.isAbstractType()) {</span>
<span class="fc" id="L595">				typeIterator.remove();</span>
			}
<span class="fc" id="L597">		}</span>

		// Fix up the GoodsType derived attributes. Several GoodsType
		// predicates are likely to fail until this is done.
<span class="fc" id="L601">		GoodsType.setDerivedAttributes(this);</span>

<span class="fc" id="L603">		storableGoodsTypeList.clear();</span>
<span class="fc" id="L604">		farmedGoodsTypeList.clear();</span>
<span class="fc" id="L605">		foodGoodsTypeList.clear();</span>
<span class="fc" id="L606">		newWorldGoodsTypeList.clear();</span>
<span class="fc" id="L607">		newWorldLuxuryGoodsTypeList.clear();</span>
<span class="fc" id="L608">		libertyGoodsTypeList.clear();</span>
<span class="fc" id="L609">		immigrationGoodsTypeList.clear();</span>
<span class="fc" id="L610">		rawBuildingGoodsTypeList.clear();</span>
<span class="fc bfc" id="L611" title="All 2 branches covered.">		for (GoodsType goodsType : goodsTypeList) {</span>
<span class="fc bfc" id="L612" title="All 2 branches covered.">			if (goodsType.isStorable()) {</span>
<span class="fc" id="L613">				storableGoodsTypeList.add(goodsType);</span>
			}
<span class="fc bfc" id="L615" title="All 2 branches covered.">			if (goodsType.isFarmed()) {</span>
<span class="fc" id="L616">				farmedGoodsTypeList.add(goodsType);</span>
			}
<span class="fc bfc" id="L618" title="All 2 branches covered.">			if (goodsType.isFoodType()) {</span>
<span class="fc" id="L619">				foodGoodsTypeList.add(goodsType);</span>
			}
<span class="fc bfc" id="L621" title="All 2 branches covered.">			if (goodsType.isNewWorldGoodsType()) {</span>
<span class="fc" id="L622">				newWorldGoodsTypeList.add(goodsType);</span>
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">				if (goodsType.isNewWorldLuxuryType()) {</span>
<span class="nc" id="L624">					newWorldLuxuryGoodsTypeList.add(goodsType);</span>
				}
			}
<span class="fc bfc" id="L627" title="All 2 branches covered.">			if (goodsType.isLibertyType()) {</span>
<span class="fc" id="L628">				libertyGoodsTypeList.add(goodsType);</span>
			}
<span class="fc bfc" id="L630" title="All 2 branches covered.">			if (goodsType.isImmigrationType()) {</span>
<span class="fc" id="L631">				immigrationGoodsTypeList.add(goodsType);</span>
			}
<span class="fc bfc" id="L633" title="All 4 branches covered.">			if (goodsType.isRawBuildingMaterial() &amp;&amp; !goodsType.isFoodType()) {</span>
<span class="fc" id="L634">				rawBuildingGoodsTypeList.add(goodsType);</span>
			}
<span class="fc" id="L636">		}</span>

<span class="fc" id="L638">		REFNations.clear();</span>
<span class="fc" id="L639">		europeanNations.clear();</span>
<span class="fc" id="L640">		indianNations.clear();</span>
<span class="fc bfc" id="L641" title="All 2 branches covered.">		for (Nation nation : nations) {</span>
<span class="fc bfc" id="L642" title="All 2 branches covered.">			if (nation.getType().isEuropean()) {</span>
<span class="fc bfc" id="L643" title="All 2 branches covered.">				if (nation.isUnknownEnemy()) {</span>
<span class="fc" id="L644">					continue;</span>
<span class="fc bfc" id="L645" title="All 2 branches covered.">				} else if (nation.getType().isREF()) {</span>
<span class="fc" id="L646">					REFNations.add(nation);</span>
				} else {
<span class="fc" id="L648">					europeanNations.add(nation);</span>
				}
			} else {
<span class="fc" id="L651">				indianNations.add(nation);</span>
			}
<span class="fc" id="L653">		}</span>

<span class="fc" id="L655">		nationTypes.clear();</span>
<span class="fc" id="L656">		nationTypes.addAll(indianNationTypes);</span>
<span class="fc" id="L657">		nationTypes.addAll(europeanNationTypes);</span>
<span class="fc" id="L658">		Iterator&lt;EuropeanNationType&gt; iterator = europeanNationTypes.iterator();</span>
<span class="fc bfc" id="L659" title="All 2 branches covered.">		while (iterator.hasNext()) {</span>
<span class="fc" id="L660">			EuropeanNationType nationType = iterator.next();</span>
<span class="fc bfc" id="L661" title="All 2 branches covered.">			if (nationType.isREF()) {</span>
<span class="fc" id="L662">				REFNationTypes.add(nationType);</span>
<span class="fc" id="L663">				iterator.remove();</span>
			}
<span class="fc" id="L665">		}</span>

<span class="fc" id="L667">		experts.clear();</span>
<span class="fc" id="L668">		unitTypesTrainedInEurope.clear();</span>
<span class="fc" id="L669">		unitTypesPurchasedInEurope.clear();</span>
<span class="fc" id="L670">		defaultUnitTypes.clear();</span>
<span class="fc" id="L671">		int bestLandValue = -1, bestNavalValue = -1;</span>
<span class="fc bfc" id="L672" title="All 2 branches covered.">		for (UnitType unitType : unitTypeList) {</span>
<span class="fc bfc" id="L673" title="All 2 branches covered.">			if (unitType.isDefaultUnitType())</span>
<span class="fc" id="L674">				defaultUnitTypes.add(unitType);</span>
<span class="fc bfc" id="L675" title="All 4 branches covered.">			if (unitType.needsGoodsToBuild() &amp;&amp; !unitType.hasAbility(Ability.BORN_IN_COLONY)) {</span>
<span class="fc" id="L676">				buildableUnitTypes.add(unitType);</span>
			}
<span class="fc bfc" id="L678" title="All 2 branches covered.">			if (unitType.getExpertProduction() != null) {</span>
<span class="fc" id="L679">				experts.put(unitType.getExpertProduction(), unitType);</span>
			}
<span class="fc bfc" id="L681" title="All 2 branches covered.">			if (unitType.hasPrice()) {</span>
<span class="fc bfc" id="L682" title="All 2 branches covered.">				if (unitType.getSkill() &gt; 0) {</span>
<span class="fc" id="L683">					unitTypesTrainedInEurope.add(unitType);</span>
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">				} else if (!unitType.hasSkill()) {</span>
<span class="fc" id="L685">					unitTypesPurchasedInEurope.add(unitType);</span>
				}
			}
<span class="fc bfc" id="L688" title="All 2 branches covered.">			if (unitType.isNaval()) {</span>
<span class="fc bfc" id="L689" title="All 2 branches covered.">				if (bestNavalValue &lt; unitType.getMovement()) {</span>
<span class="fc" id="L690">					bestNavalValue = unitType.getMovement();</span>
<span class="fc" id="L691">					fastestNavalUnitType = unitType;</span>
				}
			} else {
<span class="fc bfc" id="L694" title="All 2 branches covered.">				if (bestLandValue &lt; unitType.getMovement()) {</span>
<span class="fc" id="L695">					bestLandValue = unitType.getMovement();</span>
<span class="fc" id="L696">					fastestLandUnitType = unitType;</span>
				}
			}
<span class="fc" id="L699">		}</span>

		// Initialize UI containers.
<span class="fc bfc" id="L702" title="All 2 branches covered.">		for (AbstractOption option : allOptions.values()) {</span>
<span class="fc" id="L703">			option.generateChoices();</span>
<span class="fc" id="L704">		}</span>

		// Initialize the Turn class using GameOptions and messages.
<span class="fc" id="L707">		Turn.initialize(getInteger(GameOptions.STARTING_YEAR), getInteger(GameOptions.SEASON_YEAR),</span>
<span class="fc" id="L708">				getInteger(GameOptions.SEASONS));</span>
		{
<span class="fc" id="L710">			Option agesOption = getOption(GameOptions.AGES);</span>
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">			boolean badAges = !(agesOption instanceof TextOption);</span>
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">			String agesValue = (badAges) ? &quot;&quot; : ((TextOption) agesOption).getValue();</span>
<span class="fc" id="L713">			String a[] = agesValue.split(&quot;,&quot;);</span>
<span class="pc bpc" id="L714" title="1 of 2 branches missed.">			badAges |= a.length != NUMBER_OF_AGES - 1;</span>
<span class="pc bpc" id="L715" title="1 of 2 branches missed.">			if (!badAges) {</span>
				try {
<span class="fc" id="L717">					ages[0] = 1;</span>
<span class="fc" id="L718">					ages[1] = Turn.yearToTurn(Integer.parseInt(a[0]));</span>
<span class="fc" id="L719">					ages[2] = Turn.yearToTurn(Integer.parseInt(a[1]));</span>
<span class="pc bpc" id="L720" title="2 of 4 branches missed.">					if (ages[1] &lt; 1 || ages[2] &lt; 1) {</span>
<span class="nc" id="L721">						badAges = true;</span>
<span class="pc bpc" id="L722" title="1 of 2 branches missed.">					} else if (ages[1] &gt; ages[2]) {</span>
<span class="nc" id="L723">						int tmp = ages[1];</span>
<span class="nc" id="L724">						ages[1] = ages[2];</span>
<span class="nc" id="L725">						ages[2] = tmp;</span>
					}
<span class="nc" id="L727">				} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L728">					badAges = true;</span>
<span class="fc" id="L729">				}</span>
			}
<span class="pc bpc" id="L731" title="1 of 2 branches missed.">			if (badAges) {</span>
<span class="nc" id="L732">				logger.warning(&quot;Bad ages: &quot; + agesValue);</span>
<span class="nc" id="L733">				ages[0] = 1; // First turn</span>
<span class="nc" id="L734">				ages[1] = Turn.yearToTurn(1600);</span>
<span class="nc" id="L735">				ages[2] = Turn.yearToTurn(1700);</span>
			}
		}

		// Apply the customs on coast restriction
<span class="fc" id="L740">		boolean customsOnCoast = getBoolean(GameOptions.CUSTOMS_ON_COAST);</span>
<span class="fc bfc" id="L741" title="All 2 branches covered.">		for (Ability a : getBuildingType(&quot;model.building.customHouse&quot;).getAbilities(Ability.COASTAL_ONLY)) {</span>
<span class="fc" id="L742">			a.setValue(customsOnCoast);</span>
<span class="fc" id="L743">		}</span>

<span class="fc" id="L745">		logger.info(&quot;Specification clean following &quot; + why + &quot; complete&quot; + &quot;, starting year=&quot; + Turn.getStartingYear()</span>
<span class="fc" id="L746">				+ &quot;, season year=&quot; + Turn.getSeasonYear() + &quot;, ages=[&quot; + ages[0] + &quot;,&quot; + ages[1] + &quot;,&quot; + ages[2] + &quot;]&quot;</span>
<span class="fc" id="L747">				+ &quot;, seasons=&quot; + Turn.getSeasonNumber() + &quot;, &quot; + allTypes.size() + &quot; FreeColGameObjectTypes&quot; + &quot;, &quot;</span>
<span class="fc" id="L748">				+ allAbilities.size() + &quot; Abilities&quot; + &quot;, &quot; + buildingTypeList.size() + &quot; BuildingTypes&quot; + &quot;, &quot;</span>
<span class="fc" id="L749">				+ disasters.size() + &quot; Disasters&quot; + &quot;, &quot; + europeanNationTypes.size() + &quot; EuropeanNationTypes&quot; + &quot;, &quot;</span>
<span class="fc" id="L750">				+ events.size() + &quot; Events&quot; + &quot;, &quot; + foundingFathers.size() + &quot; FoundingFathers&quot; + &quot;, &quot;</span>
<span class="fc" id="L751">				+ goodsTypeList.size() + &quot; GoodsTypes&quot; + &quot;, &quot; + indianNationTypes.size() + &quot; IndianNationTypes&quot; + &quot;, &quot;</span>
<span class="fc" id="L752">				+ allModifiers.size() + &quot; Modifiers&quot; + &quot;, &quot; + nations.size() + &quot; Nations&quot; + &quot;, &quot; + allOptions.size()</span>
<span class="fc" id="L753">				+ &quot; Options&quot; + &quot;, &quot; + allOptionGroups.size() + &quot; Option Groups&quot; + &quot;, &quot; + resourceTypeList.size()</span>
<span class="fc" id="L754">				+ &quot; ResourceTypes&quot; + &quot;, &quot; + roles.size() + &quot; Roles&quot; + &quot;, &quot; + tileTypeList.size() + &quot; TileTypes&quot; + &quot;, &quot;</span>
<span class="fc" id="L755">				+ tileImprovementTypeList.size() + &quot; TileImprovementTypes&quot; + &quot;, &quot; + unitTypeList.size() + &quot; UnitTypes&quot;</span>
				+ &quot; read.&quot;);
<span class="fc" id="L757">	}</span>

	/**
	 * Disable editing of some critical option groups.
	 */
	public void disableEditing() {
<span class="fc bfc" id="L763" title="All 2 branches covered.">		for (String s : new String[] { GameOptions.getXMLElementTagName(), MapGeneratorOptions.getXMLElementTagName(),</span>
				DIFFICULTY_LEVELS }) {
<span class="fc" id="L765">			OptionGroup og = allOptionGroups.get(s);</span>
<span class="pc bpc" id="L766" title="1 of 2 branches missed.">			if (og != null)</span>
<span class="fc" id="L767">				og.setEditable(false);</span>
		}
<span class="fc" id="L769">	}</span>

	/**
	 * Generate the dynamic options.
	 *
	 * Only call this in the server. If clients call it the European prices can
	 * be desynchronized.
	 */
	public void generateDynamicOptions() {
<span class="fc" id="L778">		logger.finest(&quot;Generating dynamic options.&quot;);</span>
<span class="fc" id="L779">		OptionGroup prices = new OptionGroup(GameOptions.GAMEOPTIONS_PRICES, this);</span>
<span class="fc" id="L780">		allOptionGroups.put(prices.getId(), prices);</span>
<span class="fc bfc" id="L781" title="All 2 branches covered.">		for (GoodsType goodsType : goodsTypeList) {</span>
<span class="fc" id="L782">			String name = goodsType.getSuffix(&quot;model.goods.&quot;);</span>
<span class="fc" id="L783">			String base = &quot;model.option.&quot; + name + &quot;.&quot;;</span>
<span class="fc bfc" id="L784" title="All 2 branches covered.">			if (goodsType.getInitialSellPrice() &gt; 0) {</span>
<span class="fc bfc" id="L785" title="All 4 branches covered.">				int diff = (goodsType.isNewWorldGoodsType() || goodsType.isNewWorldLuxuryType()) ? 3 : 0;</span>
<span class="fc" id="L786">				IntegerOption minimum = new IntegerOption(base + &quot;minimumPrice&quot;, this);</span>
<span class="fc" id="L787">				minimum.setValue(goodsType.getInitialSellPrice());</span>
<span class="fc" id="L788">				minimum.setMinimumValue(1);</span>
<span class="fc" id="L789">				minimum.setMaximumValue(100);</span>
<span class="fc" id="L790">				prices.add(minimum);</span>
<span class="fc" id="L791">				addAbstractOption(minimum);</span>
<span class="fc" id="L792">				IntegerOption maximum = new IntegerOption(base + &quot;maximumPrice&quot;, this);</span>
<span class="fc" id="L793">				maximum.setValue(goodsType.getInitialSellPrice() + diff);</span>
<span class="fc" id="L794">				maximum.setMinimumValue(1);</span>
<span class="fc" id="L795">				maximum.setMaximumValue(100);</span>
<span class="fc" id="L796">				prices.add(maximum);</span>
<span class="fc" id="L797">				addAbstractOption(maximum);</span>
<span class="fc" id="L798">				IntegerOption spread = new IntegerOption(base + &quot;spread&quot;, this);</span>
<span class="fc" id="L799">				spread.setValue(goodsType.getPriceDifference());</span>
<span class="fc" id="L800">				spread.setMinimumValue(1);</span>
<span class="fc" id="L801">				spread.setMaximumValue(100);</span>
<span class="fc" id="L802">				prices.add(spread);</span>
<span class="fc" id="L803">				addAbstractOption(spread);</span>
<span class="fc bfc" id="L804" title="All 2 branches covered.">			} else if (goodsType.getPrice() &lt; FreeColGameObjectType.INFINITY) {</span>
<span class="fc" id="L805">				IntegerOption price = new IntegerOption(base + &quot;price&quot;, this);</span>
<span class="fc" id="L806">				price.setValue(goodsType.getPrice());</span>
<span class="fc" id="L807">				price.setMinimumValue(1);</span>
<span class="fc" id="L808">				price.setMaximumValue(100);</span>
<span class="fc" id="L809">				prices.add(price);</span>
<span class="fc" id="L810">				addAbstractOption(price);</span>
			}
<span class="fc" id="L812">		}</span>
<span class="fc" id="L813">		getGameOptions().add(prices);</span>
<span class="fc" id="L814">	}</span>

	/**
	 * The Interface ChildReader.
	 */
	private interface ChildReader {

		/**
		 * Read children.
		 *
		 * @param xr
		 *            the xr
		 * @throws XMLStreamException
		 *             the XML stream exception
		 */
		public void readChildren(FreeColXMLReader xr) throws XMLStreamException;
	}

	/**
	 * The Class ModifierReader.
	 */
<span class="fc" id="L835">	private class ModifierReader implements ChildReader {</span>

		/*
		 * (non-Javadoc)
		 * 
		 * @see
		 * net.sf.freecol.common.model.Specification.ChildReader#readChildren(
		 * net.sf.freecol.common.io.FreeColXMLReader)
		 */
		@Override
		public void readChildren(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc bfc" id="L846" title="All 2 branches covered.">			while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L847">				Modifier modifier = new Modifier(xr, Specification.this);</span>
<span class="fc" id="L848">				Specification.this.addModifier(modifier);</span>
<span class="fc" id="L849">				Specification.this.specialModifiers.add(modifier);</span>
<span class="fc" id="L850">			}</span>
<span class="fc" id="L851">		}</span>
	}

	/**
	 * The Class TypeReader.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 */
	private class TypeReader&lt;T extends FreeColGameObjectType&gt; implements ChildReader {

		/** The type. */
		private final Class&lt;T&gt; type;

		/** The result. */
		private final List&lt;T&gt; result;

		/** The index. */
<span class="fc" id="L869">		private int index = 0;</span>

		/**
		 * Instantiates a new type reader.
		 *
		 * @param type
		 *            the type
		 * @param listToFill
		 *            the list to fill
		 */
		// Is there really no easy way to capture T?
<span class="fc" id="L880">		public TypeReader(Class&lt;T&gt; type, List&lt;T&gt; listToFill) {</span>
<span class="fc" id="L881">			result = listToFill;</span>
<span class="fc" id="L882">			this.type = type;</span>
<span class="fc" id="L883">		}</span>

		/*
		 * (non-Javadoc)
		 * 
		 * @see
		 * net.sf.freecol.common.model.Specification.ChildReader#readChildren(
		 * net.sf.freecol.common.io.FreeColXMLReader)
		 */
		@Override
		public void readChildren(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc bfc" id="L894" title="All 2 branches covered.">			while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L895">				final String tag = xr.getLocalName();</span>
<span class="fc" id="L896">				String id = xr.readId();</span>
<span class="pc bpc" id="L897" title="1 of 2 branches missed.">				if (id == null) {</span>
<span class="nc" id="L898">					logger.warning(&quot;Null identifier, tag: &quot; + tag);</span>

<span class="fc bfc" id="L900" title="All 2 branches covered.">				} else if (FreeColGameObjectType.DELETE_TAG.equals(tag)) {</span>
<span class="fc" id="L901">					FreeColGameObjectType object = allTypes.remove(id);</span>
<span class="pc bpc" id="L902" title="1 of 2 branches missed.">					if (object != null)</span>
<span class="fc" id="L903">						result.remove(object);</span>

<span class="fc" id="L905">				} else {</span>
<span class="fc" id="L906">					T object = getType(id, type);</span>
<span class="fc" id="L907">					allTypes.put(id, object);</span>

					// If this an existing object (with id) and the
					// PRESERVE tag is present, then leave the
					// attributes intact and only read the child
					// elements, otherwise do a full attribute
					// inclusive read. This allows mods and spec
					// extensions to not have to re-specify all the
					// attributes when just changing the children.
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">					if (object.getId() != null</span>
<span class="fc bfc" id="L917" title="All 2 branches covered.">							&amp;&amp; xr.getAttribute(FreeColGameObjectType.PRESERVE_TAG, (String) null) != null) {</span>
<span class="fc" id="L918">						object.readChildren(xr);</span>
					} else {
<span class="fc" id="L920">						object.readFromXML(xr);</span>
					}
<span class="fc bfc" id="L922" title="All 4 branches covered.">					if (!object.isAbstractType() &amp;&amp; !result.contains(object)) {</span>
<span class="fc" id="L923">						result.add(object);</span>
<span class="fc" id="L924">						object.setIndex(index);</span>
<span class="fc" id="L925">						index++;</span>
					}
				}
<span class="fc" id="L928">			}</span>
<span class="fc" id="L929">		}</span>
	}

	/**
	 * Options are special as they live in the allOptionGroups collection, which
	 * has its own particular semantics. So they need their own reader.
	 */
<span class="fc" id="L936">	private class OptionReader implements ChildReader {</span>

		/** The Constant RECURSIVE_TAG. */
		private static final String RECURSIVE_TAG = &quot;recursive&quot;;

		/*
		 * (non-Javadoc)
		 * 
		 * @see
		 * net.sf.freecol.common.model.Specification.ChildReader#readChildren(
		 * net.sf.freecol.common.io.FreeColXMLReader)
		 */
		@Override
		public void readChildren(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc bfc" id="L950" title="All 2 branches covered.">			while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L951">				readChild(xr);</span>
			}
<span class="fc" id="L953">		}</span>

		/**
		 * Read child.
		 *
		 * @param xr
		 *            the xr
		 * @throws XMLStreamException
		 *             the XML stream exception
		 */
		private void readChild(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L964">			final String tag = xr.getLocalName();</span>

<span class="fc" id="L966">			boolean recursive = xr.getAttribute(RECURSIVE_TAG, true);</span>

<span class="pc bpc" id="L968" title="1 of 2 branches missed.">			if (OptionGroup.getXMLElementTagName().equals(tag)) {</span>
<span class="fc" id="L969">				String id = xr.readId();</span>
<span class="fc" id="L970">				OptionGroup group = allOptionGroups.get(id);</span>
<span class="fc bfc" id="L971" title="All 2 branches covered.">				if (group == null) {</span>
<span class="fc" id="L972">					group = new OptionGroup(id, Specification.this);</span>
<span class="fc" id="L973">					allOptionGroups.put(id, group);</span>
				}
<span class="fc" id="L975">				group.readFromXML(xr);</span>
<span class="fc" id="L976">				Specification.this.addOptionGroup(group, recursive);</span>

<span class="fc" id="L978">			} else {</span>
<span class="nc" id="L979">				logger.warning(OptionGroup.getXMLElementTagName() + &quot; expected in OptionReader, not: &quot; + tag);</span>
<span class="nc" id="L980">				xr.nextTag();</span>
			}
<span class="fc" id="L982">		}</span>
	}

	// ---------------------------------------------------------- retrieval
	// methods

	/**
	 * Get the specification identifier.
	 *
	 * @return The specification identifier.
	 */
	public String getId() {
<span class="fc" id="L994">		return id;</span>
	}

	/**
	 * Get the specification version.
	 *
	 * @return The specification version.
	 */
	public String getVersion() {
<span class="nc" id="L1003">		return version;</span>
	}

	/**
	 * Registers an Ability as defined.
	 *
	 * @param ability
	 *            an &lt;code&gt;Ability&lt;/code&gt; value
	 */
	public void addAbility(Ability ability) {
<span class="fc" id="L1013">		String id = ability.getId();</span>
<span class="fc" id="L1014">		addAbility(id);</span>
<span class="fc" id="L1015">		allAbilities.get(id).add(ability);</span>
<span class="fc" id="L1016">	}</span>

	/**
	 * Registers an Ability's id as defined. This is useful for abilities that
	 * are required rather than provided by FreeColGameObjectTypes.
	 *
	 * @param id
	 *            The object identifier.
	 */
	public void addAbility(String id) {
<span class="fc bfc" id="L1026" title="All 2 branches covered.">		if (!allAbilities.containsKey(id)) {</span>
<span class="fc" id="L1027">			allAbilities.put(id, new ArrayList&lt;Ability&gt;());</span>
		}
<span class="fc" id="L1029">	}</span>

	/**
	 * Get all the Abilities with the given identifier.
	 *
	 * @param id
	 *            The object identifier to look for.
	 * @return the abilities
	 */
	public List&lt;Ability&gt; getAbilities(String id) {
<span class="fc" id="L1039">		return allAbilities.get(id);</span>
	}

	/**
	 * Add a modifier.
	 *
	 * @param modifier
	 *            The &lt;code&gt;Modifier&lt;/code&gt; to add.
	 */
	public void addModifier(Modifier modifier) {
<span class="fc" id="L1049">		String id = modifier.getId();</span>
<span class="fc bfc" id="L1050" title="All 2 branches covered.">		if (!allModifiers.containsKey(id)) {</span>
<span class="fc" id="L1051">			allModifiers.put(id, new ArrayList&lt;Modifier&gt;());</span>
		}
<span class="fc" id="L1053">		allModifiers.get(id).add(modifier);</span>
<span class="fc" id="L1054">	}</span>

	/**
	 * Get all the Modifiers with the given identifier.
	 *
	 * @param id
	 *            The object identifier to look for.
	 * @return the modifiers
	 */
	public List&lt;Modifier&gt; getModifiers(String id) {
<span class="fc" id="L1064">		List&lt;Modifier&gt; result = allModifiers.get(id);</span>
<span class="pc bpc" id="L1065" title="1 of 2 branches missed.">		return (result == null) ? Collections.&lt;Modifier&gt;emptyList() : result;</span>
	}

	// Option routines

	/**
	 * Is option with this identifier present? This is helpful when options are
	 * optionally(!) present, for example model.option.priceIncrease.artillery
	 * exists but model.option.priceIncrease.frigate does not.
	 *
	 * @param id
	 *            The object identifier to test.
	 * @return True/false on presence of option id.
	 */
	public boolean hasOption(String id) {
<span class="pc bpc" id="L1080" title="1 of 4 branches missed.">		return id != null &amp;&amp; allOptions.containsKey(id);</span>
	}

	/**
	 * Get the &lt;code&gt;AbstractOption&lt;/code&gt; with the given identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;AbstractOption&lt;/code&gt; found.
	 * @exception IllegalArgumentException
	 *                if the identifier is null or not present.
	 */
	public AbstractOption getOption(String id) throws IllegalArgumentException {
<span class="pc bpc" id="L1093" title="1 of 2 branches missed.">		if (id == null) {</span>
<span class="nc" id="L1094">			throw new IllegalArgumentException(&quot;AbstractOption with null id.&quot;);</span>
<span class="pc bpc" id="L1095" title="1 of 2 branches missed.">		} else if (!allOptions.containsKey(id)) {</span>
<span class="nc" id="L1096">			throw new IllegalArgumentException(&quot;Missing AbstractOption: &quot; + id);</span>
		} else {
<span class="fc" id="L1098">			return allOptions.get(id);</span>
		}
	}

	/**
	 * Get the &lt;code&gt;OptionGroup&lt;/code&gt; with the given identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;OptionGroup&lt;/code&gt; found.
	 * @exception IllegalArgumentException
	 *                if the identifier is null or not present.
	 */
	public OptionGroup getOptionGroup(String id) throws IllegalArgumentException {
<span class="pc bpc" id="L1112" title="1 of 2 branches missed.">		if (id == null) {</span>
<span class="nc" id="L1113">			throw new IllegalArgumentException(&quot;OptionGroup with null id.&quot;);</span>
<span class="pc bpc" id="L1114" title="1 of 2 branches missed.">		} else if (!allOptionGroups.containsKey(id)) {</span>
<span class="nc" id="L1115">			throw new IllegalArgumentException(&quot;Missing OptionGroup: &quot; + id);</span>
		} else {
<span class="fc" id="L1117">			return allOptionGroups.get(id);</span>
		}
	}

	/**
	 * Adds an &lt;code&gt;OptionGroup&lt;/code&gt; to this specification.
	 *
	 * @param optionGroup
	 *            The &lt;code&gt;OptionGroup&lt;/code&gt; to add.
	 * @param recursive
	 *            If true, add recursively to subgroups.
	 */
	public void addOptionGroup(OptionGroup optionGroup, boolean recursive) {
		// Add the options of the group
<span class="fc" id="L1131">		Iterator&lt;Option&gt; iter = optionGroup.iterator();</span>

<span class="fc bfc" id="L1133" title="All 2 branches covered.">		while (iter.hasNext()) {</span>
<span class="fc" id="L1134">			Option option = iter.next();</span>
<span class="fc bfc" id="L1135" title="All 2 branches covered.">			if (option instanceof OptionGroup) {</span>
<span class="fc" id="L1136">				allOptionGroups.put(option.getId(), (OptionGroup) option);</span>
<span class="fc bfc" id="L1137" title="All 2 branches covered.">				if (recursive) {</span>
<span class="fc" id="L1138">					addOptionGroup((OptionGroup) option, true);</span>
				}
			} else {
<span class="fc" id="L1141">				addAbstractOption((AbstractOption) option);</span>
			}
<span class="fc" id="L1143">		}</span>
<span class="fc" id="L1144">	}</span>

	/**
	 * Adds an &lt;code&gt;AbstractOption&lt;/code&gt; to this specification.
	 *
	 * @param abstractOption
	 *            The &lt;code&gt;AbstractOption&lt;/code&gt; to add.
	 */
	private void addAbstractOption(AbstractOption abstractOption) {
		// Add the option
<span class="fc" id="L1154">		allOptions.put(abstractOption.getId(), abstractOption);</span>
<span class="fc" id="L1155">	}</span>

	/**
	 * Get the &lt;code&gt;IntegerOption&lt;/code&gt; with the given identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;IntegerOption&lt;/code&gt; found.
	 */
	public IntegerOption getIntegerOption(String id) {
<span class="fc" id="L1165">		return (IntegerOption) getOption(id);</span>
	}

	/**
	 * Get the &lt;code&gt;RangeOption&lt;/code&gt; with the given identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;RangeOption&lt;/code&gt; found.
	 */
	public RangeOption getRangeOption(String id) {
<span class="fc" id="L1176">		return (RangeOption) getOption(id);</span>
	}

	/**
	 * Get the &lt;code&gt;BooleanOption&lt;/code&gt; with the given identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;BooleanOption&lt;/code&gt; found.
	 */
	public BooleanOption getBooleanOption(String id) {
<span class="fc" id="L1187">		return (BooleanOption) getOption(id);</span>
	}

	/**
	 * Get the &lt;code&gt;StringOption&lt;/code&gt; with the given identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;StringOption&lt;/code&gt; found.
	 */
	public StringOption getStringOption(String id) {
<span class="fc" id="L1198">		return (StringOption) getOption(id);</span>
	}

	/**
	 * Gets the boolean value of an option.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The value.
	 * @exception IllegalArgumentException
	 *                If there is no boolean value associated with the specified
	 *                option.
	 * @exception NullPointerException
	 *                if the given &lt;code&gt;Option&lt;/code&gt; does not exist.
	 */
	public boolean getBoolean(String id) {
		try {
<span class="fc" id="L1215">			return getBooleanOption(id).getValue();</span>
<span class="nc" id="L1216">		} catch (ClassCastException e) {</span>
<span class="nc" id="L1217">			throw new IllegalArgumentException(&quot;Not a boolean option: &quot; + id, e);</span>
		}
	}

	/**
	 * Gets the integer value of an option.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The value.
	 * @exception IllegalArgumentException
	 *                If there is no integer value associated with the specified
	 *                option.
	 * @exception NullPointerException
	 *                if the given &lt;code&gt;Option&lt;/code&gt; does not exist.
	 */
	public int getInteger(String id) {
		try {
<span class="fc" id="L1235">			return getIntegerOption(id).getValue();</span>
<span class="nc" id="L1236">		} catch (ClassCastException e) {</span>
<span class="nc" id="L1237">			throw new IllegalArgumentException(&quot;Not an integer option: &quot; + id, e);</span>
		}
	}

	/**
	 * Gets the string value of an option.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The value.
	 * @exception IllegalArgumentException
	 *                If there is no string value associated with the specified
	 *                option.
	 * @exception NullPointerException
	 *                if the given &lt;code&gt;Option&lt;/code&gt; does not exist.
	 */
	public String getString(String id) {
		try {
<span class="fc" id="L1255">			return getStringOption(id).getValue();</span>
<span class="nc" id="L1256">		} catch (ClassCastException e) {</span>
<span class="nc" id="L1257">			throw new IllegalArgumentException(&quot;Not a string option: &quot; + id, e);</span>
		}
	}

	// -- Buildings --

	/**
	 * Gets the building type list.
	 *
	 * @return the building type list
	 */
	public List&lt;BuildingType&gt; getBuildingTypeList() {
<span class="fc" id="L1269">		return buildingTypeList;</span>
	}

	/**
	 * Get a building type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;BuildingType&lt;/code&gt; found.
	 */
	public BuildingType getBuildingType(String id) {
<span class="fc" id="L1280">		return getType(id, BuildingType.class);</span>
	}

	// -- Goods --

	/**
	 * Gets the goods type list.
	 *
	 * @return the goods type list
	 */
	public List&lt;GoodsType&gt; getGoodsTypeList() {
<span class="fc" id="L1291">		return new ArrayList&lt;&gt;(goodsTypeList);</span>
	}

	/**
	 * Gets the storable goods type list.
	 *
	 * @return the storable goods type list
	 */
	public List&lt;GoodsType&gt; getStorableGoodsTypeList() {
<span class="fc" id="L1300">		return new ArrayList&lt;&gt;(storableGoodsTypeList);</span>
	}

	/**
	 * Gets the farmed goods type list.
	 *
	 * @return the farmed goods type list
	 */
	public List&lt;GoodsType&gt; getFarmedGoodsTypeList() {
<span class="fc" id="L1309">		return new ArrayList&lt;&gt;(farmedGoodsTypeList);</span>
	}

	/**
	 * Gets the new world goods type list.
	 *
	 * @return the new world goods type list
	 */
	public List&lt;GoodsType&gt; getNewWorldGoodsTypeList() {
<span class="fc" id="L1318">		return new ArrayList&lt;&gt;(newWorldGoodsTypeList);</span>
	}

	/**
	 * Gets the new world luxury goods type list.
	 *
	 * @return the new world luxury goods type list
	 */
	public List&lt;GoodsType&gt; getNewWorldLuxuryGoodsTypeList() {
<span class="fc" id="L1327">		return new ArrayList&lt;&gt;(newWorldLuxuryGoodsTypeList);</span>
	}

	/**
	 * Gets the liberty goods type list.
	 *
	 * @return the liberty goods type list
	 */
	public List&lt;GoodsType&gt; getLibertyGoodsTypeList() {
<span class="fc" id="L1336">		return new ArrayList&lt;&gt;(libertyGoodsTypeList);</span>
	}

	/**
	 * Gets the immigration goods type list.
	 *
	 * @return the immigration goods type list
	 */
	public List&lt;GoodsType&gt; getImmigrationGoodsTypeList() {
<span class="nc" id="L1345">		return new ArrayList&lt;&gt;(immigrationGoodsTypeList);</span>
	}

	/**
	 * Gets the food goods type list.
	 *
	 * @return the food goods type list
	 */
	public List&lt;GoodsType&gt; getFoodGoodsTypeList() {
<span class="fc" id="L1354">		return new ArrayList&lt;&gt;(foodGoodsTypeList);</span>
	}

	/**
	 * Gets the raw building goods type list.
	 *
	 * @return the raw building goods type list
	 */
	public final List&lt;GoodsType&gt; getRawBuildingGoodsTypeList() {
<span class="nc" id="L1363">		return new ArrayList&lt;&gt;(rawBuildingGoodsTypeList);</span>
	}

	/**
	 * The general &quot;Food&quot; type is handled as a special case in many places.
	 * Introduce this routine to collect them into one place, in the hope we can
	 * one day deprecate this routine and clean up the special cases.
	 *
	 * @return The main food type (&quot;model.goods.food&quot;).
	 */
	public GoodsType getPrimaryFoodType() {
<span class="fc" id="L1374">		return getGoodsType(&quot;model.goods.food&quot;);</span>
	}

	/**
	 * Get the initial &lt;em&gt;minimum&lt;/em&gt; price of the given goods type. The
	 * initial price in a particular Market may be higher.
	 *
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to check.
	 * @return The minimum price.
	 */
	public int getInitialPrice(GoodsType goodsType) {
<span class="fc" id="L1386">		String suffix = goodsType.getSuffix(&quot;model.goods.&quot;);</span>
<span class="fc" id="L1387">		String minPrice = &quot;model.option.&quot; + suffix + &quot;.minimumPrice&quot;;</span>
<span class="fc" id="L1388">		String maxPrice = &quot;model.option.&quot; + suffix + &quot;.maximumPrice&quot;;</span>
<span class="pc bpc" id="L1389" title="2 of 4 branches missed.">		return (hasOption(minPrice) &amp;&amp; hasOption(maxPrice)) ? Math.min(getInteger(minPrice), getInteger(maxPrice))</span>
<span class="nc" id="L1390">				: goodsType.getInitialSellPrice();</span>
	}

	/**
	 * Get a goods type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;GoodsType&lt;/code&gt; found.
	 */
	public GoodsType getGoodsType(String id) {
<span class="fc" id="L1401">		return getType(id, GoodsType.class);</span>
	}

	// -- Resources --

	/**
	 * Gets the resource type list.
	 *
	 * @return the resource type list
	 */
	public List&lt;ResourceType&gt; getResourceTypeList() {
<span class="nc" id="L1412">		return resourceTypeList;</span>
	}

	/**
	 * Get a resource type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;ResourceType&lt;/code&gt; found.
	 */
	public ResourceType getResourceType(String id) {
<span class="fc" id="L1423">		return getType(id, ResourceType.class);</span>
	}

	// -- Tiles --

	/**
	 * Gets the tile type list.
	 *
	 * @return the tile type list
	 */
	public List&lt;TileType&gt; getTileTypeList() {
<span class="fc" id="L1434">		return tileTypeList;</span>
	}

	/**
	 * Get a tile type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;TileType&lt;/code&gt; found.
	 */
	public TileType getTileType(String id) {
<span class="fc" id="L1445">		return getType(id, TileType.class);</span>
	}

	// -- Improvements --

	/**
	 * Gets the tile improvement type list.
	 *
	 * @return the tile improvement type list
	 */
	public List&lt;TileImprovementType&gt; getTileImprovementTypeList() {
<span class="fc" id="L1456">		return tileImprovementTypeList;</span>
	}

	/**
	 * Get a tile improvement type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;TileImprovementType&lt;/code&gt; found.
	 */
	public TileImprovementType getTileImprovementType(String id) {
<span class="fc" id="L1467">		return getType(id, TileImprovementType.class);</span>
	}

	// -- Units --

	/**
	 * Gets the unit type list.
	 *
	 * @return the unit type list
	 */
	public List&lt;UnitType&gt; getUnitTypeList() {
<span class="fc" id="L1478">		return unitTypeList;</span>
	}

	/**
	 * Get the most vanilla unit type for a given player.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; to find the default unit type for, or
	 *            null indicating a normal player nation (i.e. non-REF
	 *            European).
	 * @return The default unit type.
	 */
	public UnitType getDefaultUnitType(Player player) {
<span class="pc bpc" id="L1491" title="1 of 2 branches missed.">		return (player == null) ? getDefaultUnitType() : getDefaultUnitType(player.getNationType());</span>
	}

	/**
	 * Get the most vanilla unit type for a type of nation.
	 *
	 * Provides a type to use to make a neutral comparison of the productivity
	 * of work locations.
	 *
	 * @param nationType
	 *            The &lt;code&gt;NationType&lt;/code&gt; to find the default unit type for,
	 *            or null indicating a normal player nation (i.e. non-REF
	 *            European).
	 * @return The free colonist unit type.
	 */
	public UnitType getDefaultUnitType(NationType nationType) {
<span class="pc bpc" id="L1507" title="1 of 2 branches missed.">		Predicate&lt;UnitType&gt; p = (nationType == null)</span>
<span class="nc bnc" id="L1508" title="All 4 branches missed.">				? ut -&gt; !ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT) &amp;&amp; !ut.hasAbility(Ability.REF_UNIT)</span>
<span class="fc bfc" id="L1509" title="All 2 branches covered.">				: (nationType.isIndian())</span>
<span class="pc bpc" id="L1510" title="1 of 4 branches missed.">						? ut -&gt; ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT) &amp;&amp; !ut.hasAbility(Ability.REF_UNIT)</span>
<span class="fc bfc" id="L1511" title="All 2 branches covered.">						: (nationType.isREF())</span>
<span class="fc bfc" id="L1512" title="All 2 branches covered.">								? ut -&gt; !ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT)</span>
<span class="fc bfc" id="L1513" title="All 2 branches covered.">										&amp;&amp; ut.hasAbility(Ability.REF_UNIT)</span>
<span class="pc bpc" id="L1514" title="1 of 2 branches missed.">								: ut -&gt; !ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT)</span>
<span class="pc bpc" id="L1515" title="1 of 2 branches missed.">										&amp;&amp; !ut.hasAbility(Ability.REF_UNIT);</span>
<span class="fc" id="L1516">		return find(defaultUnitTypes, p, getDefaultUnitType());</span>
	}

	/**
	 * Get the most vanilla unit type.
	 *
	 * @return The default unit type.
	 */
	public UnitType getDefaultUnitType() {
<span class="fc" id="L1525">		return getUnitType(&quot;model.unit.freeColonist&quot;); // Drop this soon</span>
	}

	/**
	 * Get the list of buildable unit types.
	 *
	 * @return The list of buildable unit types.
	 */
	public List&lt;UnitType&gt; getBuildableUnitTypes() {
<span class="nc" id="L1534">		return buildableUnitTypes;</span>
	}

	/**
	 * Get the unit type that is the expert for producing a type of goods.
	 *
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to check.
	 * @return The expert &lt;code&gt;UnitType&lt;/code&gt;, or null if none.
	 */
	public UnitType getExpertForProducing(GoodsType goodsType) {
<span class="fc" id="L1545">		return experts.get(goodsType);</span>
	}

	/**
	 * Get the unit types which have any of the given abilities.
	 *
	 * @param abilities
	 *            The abilities for the search
	 * @return A list of &lt;code&gt;UnitType&lt;/code&gt;s with the abilities.
	 */
	public List&lt;UnitType&gt; getUnitTypesWithAbility(String... abilities) {
<span class="fc" id="L1556">		return getTypesWithAbility(UnitType.class, abilities);</span>
	}

	/**
	 * Get the unit types which have none of the given abilities.
	 *
	 * @param abilities
	 *            The abilities for the search
	 * @return A list of &lt;code&gt;UnitType&lt;/code&gt;s without the abilities.
	 */
	public List&lt;UnitType&gt; getUnitTypesWithoutAbility(String... abilities) {
<span class="fc" id="L1567">		return getTypesWithoutAbility(UnitType.class, abilities);</span>
	}

	/**
	 * Gets the unit types that can be trained in Europe.
	 *
	 * @return A list of Europe-trainable &lt;code&gt;UnitType&lt;/code&gt;s.
	 */
	public List&lt;UnitType&gt; getUnitTypesTrainedInEurope() {
<span class="nc" id="L1576">		return unitTypesTrainedInEurope;</span>
	}

	/**
	 * Get the unit types that can be purchased in Europe.
	 *
	 * @return A list of Europe-purchasable &lt;code&gt;UnitType&lt;/code&gt;s.
	 */
	public List&lt;UnitType&gt; getUnitTypesPurchasedInEurope() {
<span class="nc" id="L1585">		return unitTypesPurchasedInEurope;</span>
	}

	/**
	 * Gets the fastest land unit type in this specification.
	 *
	 * @return The fastest land unit type.
	 */
	public UnitType getFastestLandUnitType() {
<span class="nc" id="L1594">		return fastestLandUnitType;</span>
	}

	/**
	 * Gets the fastest naval unit type in this specification.
	 *
	 * @return The fastest naval unit type.
	 */
	public UnitType getFastestNavalUnitType() {
<span class="nc" id="L1603">		return fastestNavalUnitType;</span>
	}

	/**
	 * Gets the REF unit types.
	 *
	 * @param naval
	 *            If true, choose naval units, if not, land units.
	 * @return the REF unit types
	 */
	public List&lt;UnitType&gt; getREFUnitTypes(boolean naval) {
<span class="fc bfc" id="L1614" title="All 2 branches covered.">		return getUnitTypesWithAbility(Ability.REF_UNIT).stream().filter(ut -&gt; ut.isNaval() == naval)</span>
<span class="fc" id="L1615">				.collect(Collectors.toList());</span>
	}

	/**
	 * Get a unit type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;UnitType&lt;/code&gt; found.
	 */
	public UnitType getUnitType(String id) {
<span class="fc" id="L1626">		return getType(id, UnitType.class);</span>
	}

	// -- Founding Fathers --

	/**
	 * Gets the founding fathers.
	 *
	 * @return the founding fathers
	 */
	public List&lt;FoundingFather&gt; getFoundingFathers() {
<span class="fc" id="L1637">		return foundingFathers;</span>
	}

	/**
	 * Get a founding father type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;FoundingFather&lt;/code&gt; found.
	 */
	public FoundingFather getFoundingFather(String id) {
<span class="fc" id="L1648">		return getType(id, FoundingFather.class);</span>
	}

	// -- NationTypes --

	/**
	 * Gets the nation types.
	 *
	 * @return the nation types
	 */
	public List&lt;NationType&gt; getNationTypes() {
<span class="fc" id="L1659">		return nationTypes;</span>
	}

	/**
	 * Gets the european nation types.
	 *
	 * @return the european nation types
	 */
	public List&lt;EuropeanNationType&gt; getEuropeanNationTypes() {
<span class="fc" id="L1668">		return europeanNationTypes;</span>
	}

	/**
	 * Gets the REF nation types.
	 *
	 * @return the REF nation types
	 */
	public List&lt;EuropeanNationType&gt; getREFNationTypes() {
<span class="fc" id="L1677">		return REFNationTypes;</span>
	}

	/**
	 * Gets the indian nation types.
	 *
	 * @return the indian nation types
	 */
	public List&lt;IndianNationType&gt; getIndianNationTypes() {
<span class="fc" id="L1686">		return indianNationTypes;</span>
	}

	/**
	 * Get a nation type by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;NationType&lt;/code&gt; found.
	 */
	public NationType getNationType(String id) {
<span class="fc" id="L1697">		return getType(id, NationType.class);</span>
	}

	/**
	 * Gets the default nation type.
	 *
	 * @return the default nation type
	 */
	public NationType getDefaultNationType() {
<span class="nc" id="L1706">		return getNationType(&quot;model.nationType.default&quot;);</span>
	}

	// -- Nations --

	/**
	 * Gets the nations.
	 *
	 * @return the nations
	 */
	public List&lt;Nation&gt; getNations() {
<span class="fc" id="L1717">		return nations;</span>
	}

	/**
	 * Gets the european nations.
	 *
	 * @return the european nations
	 */
	public List&lt;Nation&gt; getEuropeanNations() {
<span class="fc" id="L1726">		return europeanNations;</span>
	}

	/**
	 * Gets the indian nations.
	 *
	 * @return the indian nations
	 */
	public List&lt;Nation&gt; getIndianNations() {
<span class="fc" id="L1735">		return indianNations;</span>
	}

	/**
	 * Gets the REF nations.
	 *
	 * @return the REF nations
	 */
	public List&lt;Nation&gt; getREFNations() {
<span class="fc" id="L1744">		return REFNations;</span>
	}

	/**
	 * Get a nation by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;Nation&lt;/code&gt; found.
	 */
	public Nation getNation(String id) {
<span class="fc" id="L1755">		return getType(id, Nation.class);</span>
	}

	/**
	 * Clear all European advantages. Implements the Advantages==NONE setting.
	 */
	public void clearEuropeanNationalAdvantages() {
<span class="nc bnc" id="L1762" title="All 2 branches missed.">		for (Nation n : getEuropeanNations()) {</span>
<span class="nc" id="L1763">			n.setType(getDefaultNationType());</span>
<span class="nc" id="L1764">		}</span>
<span class="nc" id="L1765">	}</span>

	// -- Roles --

	/**
	 * Gets the roles.
	 *
	 * @return the roles
	 */
	public List&lt;Role&gt; getRoles() {
<span class="fc" id="L1775">		return roles;</span>
	}

	/**
	 * Get a role by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;Role&lt;/code&gt; found.
	 */
	public Role getRole(String id) {
<span class="fc" id="L1786">		return getType(id, Role.class);</span>
	}

	/**
	 * Get the default role.
	 *
	 * @return The default &lt;code&gt;Role&lt;/code&gt;.
	 */
	public Role getDefaultRole() {
<span class="fc" id="L1795">		return getRole(DEFAULT_ROLE_ID);</span>
	}

	/**
	 * Get the military roles in this specification, in decreasing order of
	 * effectiveness.
	 *
	 * @return An unmodifiable list of military &lt;code&gt;Role&lt;/code&gt;s.
	 */
	public List&lt;Role&gt; getMilitaryRoles() {
<span class="fc bfc" id="L1805" title="All 2 branches covered.">		if (militaryRoles == null) {</span>
<span class="fc" id="L1806">			this.militaryRoles = Collections.&lt;Role&gt;unmodifiableList(roles.stream().filter(Role::isOffensive)</span>
<span class="fc" id="L1807">					.sorted(Role.militaryComparator).collect(Collectors.toList()));</span>
		}
<span class="fc" id="L1809">		return militaryRoles;</span>
	}

	/**
	 * Get a role with an ability.
	 *
	 * @param id
	 *            The ability identifier to look for.
	 * @param roles
	 *            An optional list of &lt;code&gt;Role&lt;/code&gt;s to look in, if null all
	 *            roles are used.
	 * @return The first &lt;code&gt;Role&lt;/code&gt; found with the required ability, or
	 *         null if none found.
	 */
	public Role getRoleWithAbility(String id, List&lt;Role&gt; roles) {
<span class="fc" id="L1824">		return find(getRoles(), r -&gt; r.hasAbility(id));</span>
	}

	/**
	 * Get the missionary role.
	 *
	 * @return The missionary &lt;code&gt;Role&lt;/code&gt;.
	 */
	public Role getMissionaryRole() {
<span class="nc" id="L1833">		return getRoleWithAbility(Ability.ESTABLISH_MISSION, null);</span>
	}

	/**
	 * Get the pioneer role.
	 *
	 * @return The pioneer &lt;code&gt;Role&lt;/code&gt;.
	 */
	public Role getPioneerRole() {
<span class="nc" id="L1842">		return getRoleWithAbility(Ability.IMPROVE_TERRAIN, null);</span>
	}

	/**
	 * Get the scout role.
	 *
	 * @return The scout &lt;code&gt;Role&lt;/code&gt;.
	 */
	public Role getScoutRole() {
<span class="nc" id="L1851">		return getRoleWithAbility(Ability.SPEAK_WITH_CHIEF, null);</span>
	}

	/**
	 * Gets the roles suitable for a REF unit.
	 *
	 * @param naval
	 *            If true, choose roles for naval units, if not, land units.
	 * @return the REF roles
	 */
	public List&lt;Role&gt; getREFRoles(boolean naval) {
<span class="nc bnc" id="L1862" title="All 2 branches missed.">		return ((naval) ? Stream.of(getDefaultRole())</span>
<span class="nc" id="L1863">				: getMilitaryRoles().stream().filter(r -&gt; r.requiresAbility(Ability.REF_UNIT)))</span>
<span class="nc" id="L1864">						.collect(Collectors.toList());</span>
	}

	// @compat 0.10.x -- EquipmentTypes --
	/**
	 * Get an equipment type by identifier. Still needed by backward
	 * compatibility code in Unit.readChild.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;EquipmentType&lt;/code&gt; found.
	 */
	public EquipmentType getEquipmentType(String id) {
<span class="nc" id="L1877">		return getType(id, EquipmentType.class);</span>
	}
	// end @compat 0.10.x

	// -- DifficultyLevels --

	/**
	 * Gets the difficulty levels in this specification.
	 *
	 * @return A list of difficulty levels in this specification.
	 */
	public List&lt;OptionGroup&gt; getDifficultyLevels() {
<span class="fc" id="L1889">		List&lt;OptionGroup&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1890">		OptionGroup group = allOptionGroups.get(DIFFICULTY_LEVELS);</span>
<span class="pc bpc" id="L1891" title="1 of 2 branches missed.">		if (group != null) {</span>
<span class="fc bfc" id="L1892" title="All 2 branches covered.">			for (Option option : group.getOptions()) {</span>
<span class="pc bpc" id="L1893" title="1 of 2 branches missed.">				if (option instanceof OptionGroup) {</span>
<span class="fc" id="L1894">					result.add((OptionGroup) option);</span>
				}
<span class="fc" id="L1896">			}</span>
		}
<span class="fc" id="L1898">		return result;</span>
	}

	/**
	 * Get the current difficulty level.
	 *
	 * @return The difficulty level.
	 */
	public String getDifficultyLevel() {
<span class="nc" id="L1907">		return this.difficultyLevel;</span>
	}

	/**
	 * Gets the current difficulty level options.
	 *
	 * @return The current difficulty level &lt;code&gt;OptionGroup&lt;/code&gt;.
	 */
	public OptionGroup getDifficultyOptionGroup() {
<span class="fc" id="L1916">		return allOptionGroups.get(this.difficultyLevel);</span>
	}

	/**
	 * Gets difficulty level options by id.
	 *
	 * @param id
	 *            The id to look for.
	 * @return The corresponding difficulty level &lt;code&gt;OptionGroup&lt;/code&gt;, if
	 *         any.
	 */
	public OptionGroup getDifficultyOptionGroup(String id) {
<span class="fc" id="L1928">		return allOptionGroups.get(id);</span>
	}

	/**
	 * Applies the difficulty level identified by the given String to the
	 * current specification.
	 *
	 * @param difficulty
	 *            The identifier of a difficulty level to apply.
	 */
	public void applyDifficultyLevel(String difficulty) {
<span class="fc" id="L1939">		applyDifficultyLevel(getDifficultyOptionGroup(difficulty));</span>
<span class="fc" id="L1940">	}</span>

	/**
	 * Applies the given difficulty level to the current specification.
	 *
	 * @param level
	 *            The difficulty level &lt;code&gt;OptionGroup&lt;/code&gt; to apply.
	 */
	public void applyDifficultyLevel(OptionGroup level) {
<span class="pc bpc" id="L1949" title="1 of 2 branches missed.">		if (level == null) {</span>
<span class="nc" id="L1950">			logger.warning(&quot;Null difficulty level supplied&quot;);</span>
<span class="nc" id="L1951">			return;</span>
		}
<span class="fc" id="L1953">		logger.info(&quot;Applying difficulty level &quot; + level.getId());</span>
<span class="fc" id="L1954">		addOptionGroup(level, true);</span>
<span class="fc" id="L1955">		this.difficultyLevel = level.getId();</span>
<span class="fc" id="L1956">	}</span>

	/**
	 * Gets the game options.
	 *
	 * @return the game options
	 */
	public OptionGroup getGameOptions() {
<span class="fc" id="L1964">		return getOptionGroup(GameOptions.getXMLElementTagName());</span>
	}

	/**
	 * Sets the game options.
	 *
	 * @param go
	 *            the new game options
	 */
	public void setGameOptions(OptionGroup go) {
<span class="nc" id="L1974">		allOptionGroups.put(GameOptions.getXMLElementTagName(), go);</span>
<span class="nc" id="L1975">		addOptionGroup(go, true);</span>
<span class="nc" id="L1976">	}</span>

	/**
	 * Gets the map generator options.
	 *
	 * @return the map generator options
	 */
	public OptionGroup getMapGeneratorOptions() {
<span class="fc" id="L1984">		return getOptionGroup(MapGeneratorOptions.getXMLElementTagName());</span>
	}

	/**
	 * Sets the map generator options.
	 *
	 * @param mgo
	 *            the new map generator options
	 */
	public void setMapGeneratorOptions(OptionGroup mgo) {
<span class="nc" id="L1994">		allOptionGroups.put(MapGeneratorOptions.getXMLElementTagName(), mgo);</span>
<span class="nc" id="L1995">		addOptionGroup(mgo, true);</span>
<span class="nc" id="L1996">	}</span>

	// -- Events --

	/**
	 * Gets the events.
	 *
	 * @return the events
	 */
	public List&lt;Event&gt; getEvents() {
<span class="nc" id="L2006">		return events;</span>
	}

	/**
	 * Get an event by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;Event&lt;/code&gt; found.
	 */
	public Event getEvent(String id) {
<span class="fc" id="L2017">		return getType(id, Event.class);</span>
	}

	// -- Disasters --

	/**
	 * Gets the disasters.
	 *
	 * @return the disasters
	 */
	public List&lt;Disaster&gt; getDisasters() {
<span class="nc" id="L2028">		return disasters;</span>
	}

	/**
	 * Get a disaster by identifier.
	 *
	 * @param id
	 *            The object identifier.
	 * @return The &lt;code&gt;Disaster&lt;/code&gt; found.
	 */
	public Disaster getDisaster(String id) {
<span class="fc" id="L2039">		return getType(id, Disaster.class);</span>
	}

	// -- Ages --

	/**
	 * Gets the age corresponding to a given turn.
	 *
	 * @param turn
	 *            The &lt;code&gt;Turn&lt;/code&gt; to check.
	 * @return The age of the given turn.
	 */
	public int getAge(Turn turn) {
<span class="fc" id="L2052">		int n = turn.getNumber();</span>
<span class="pc bpc" id="L2053" title="1 of 6 branches missed.">		return (n &lt; ages[0]) ? -1 : (n &lt; ages[1]) ? 0 : (n &lt; ages[2]) ? 1 : 2;</span>
	}

	// General type retrieval

	/**
	 * Get the &lt;code&gt;FreeColGameObjectType&lt;/code&gt; with the given identifier.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param id
	 *            The object identifier to look for.
	 * @param type
	 *            The expected &lt;code&gt;Class&lt;/code&gt;.
	 * @return The &lt;code&gt;FreeColGameObjectType&lt;/code&gt; found.
	 */
	public &lt;T extends FreeColGameObjectType&gt; T getType(String id, Class&lt;T&gt; type) {
<span class="fc" id="L2070">		FreeColGameObjectType o = findType(id);</span>
<span class="fc bfc" id="L2071" title="All 2 branches covered.">		if (o != null) {</span>
<span class="fc" id="L2072">			return type.cast(allTypes.get(id));</span>

<span class="fc bfc" id="L2074" title="All 2 branches covered.">		} else if (initialized) {</span>
<span class="fc" id="L2075">			throw new IllegalArgumentException(&quot;Undefined FCGOT: &quot; + id);</span>

		} else { // forward declaration of new type
			try {
<span class="fc" id="L2079">				Constructor&lt;T&gt; c = type.getConstructor(String.class, Specification.class);</span>
<span class="fc" id="L2080">				T result = c.newInstance(id, this);</span>
<span class="fc" id="L2081">				allTypes.put(id, result);</span>
<span class="fc" id="L2082">				return result;</span>
<span class="nc" id="L2083">			} catch (Exception e) {</span>
<span class="nc" id="L2084">				logger.log(Level.WARNING, &quot;Could not construct: &quot; + id, e);</span>
			}
		}
<span class="nc" id="L2087">		return null;</span>
	}

	/**
	 * Find a &lt;code&gt;FreeColGameObjectType&lt;/code&gt; by id.
	 *
	 * @param id
	 *            The identifier to look for, which must not be null.
	 * @return The &lt;code&gt;FreeColGameObjectType&lt;/code&gt; found if any.
	 * @throws IllegalArgumentException
	 *             the illegal argument exception
	 */
	public FreeColGameObjectType findType(String id) throws IllegalArgumentException {
<span class="pc bpc" id="L2100" title="1 of 2 branches missed.">		if (id == null) {</span>
<span class="nc" id="L2101">			throw new IllegalArgumentException(&quot;Null id&quot;);</span>

<span class="fc bfc" id="L2103" title="All 2 branches covered.">		} else if (allTypes.containsKey(id)) {</span>
<span class="fc" id="L2104">			return allTypes.get(id);</span>

		} else {
<span class="fc" id="L2107">			return null;</span>
		}
	}

	/**
	 * Get the FreeColGameObjectTypes that provide the required ability.
	 *
	 * @param id
	 *            The object identifier.
	 * @param value
	 *            The ability value to check.
	 * @return A list of &lt;code&gt;FreeColGameObjectType&lt;/code&gt;s that provide the
	 *         required ability.
	 */
	public List&lt;FreeColGameObjectType&gt; getTypesProviding(String id, boolean value) {
<span class="nc" id="L2122">		List&lt;FreeColGameObjectType&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2123" title="All 2 branches missed.">		for (Ability ability : getAbilities(id)) {</span>
<span class="nc bnc" id="L2124" title="All 4 branches missed.">			if (ability.getValue() == value &amp;&amp; ability.getSource() instanceof FreeColGameObjectType) {</span>
<span class="nc" id="L2125">				result.add((FreeColGameObjectType) ability.getSource());</span>
			}
<span class="nc" id="L2127">		}</span>
<span class="nc" id="L2128">		return result;</span>
	}

	/**
	 * Get all types which have any of the given abilities.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param resultType
	 *            the result type
	 * @param abilities
	 *            The abilities for the search
	 * @return A list of &lt;code&gt;FreeColGameObjectType&lt;/code&gt;s with at least one
	 *         of the given abilities.
	 */
	public &lt;T extends FreeColGameObjectType&gt; List&lt;T&gt; getTypesWithAbility(Class&lt;T&gt; resultType, String... abilities) {
<span class="fc" id="L2144">		return allTypes.values().stream()</span>
<span class="fc bfc" id="L2145" title="All 4 branches covered.">				.filter(type -&gt; resultType.isInstance(type) &amp;&amp; any(abilities, a -&gt; type.hasAbility(a)))</span>
<span class="fc" id="L2146">				.map(type -&gt; resultType.cast(type)).collect(Collectors.toList());</span>
	}

	/**
	 * Get all types which have none of the given abilities.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param resultType
	 *            the result type
	 * @param abilities
	 *            The abilities for the search
	 * @return A list of &lt;code&gt;FreeColGameObjectType&lt;/code&gt;s without the given
	 *         abilities.
	 */
	public &lt;T extends FreeColGameObjectType&gt; List&lt;T&gt; getTypesWithoutAbility(Class&lt;T&gt; resultType, String... abilities) {
<span class="fc" id="L2162">		return allTypes.values().stream()</span>
<span class="fc bfc" id="L2163" title="All 4 branches covered.">				.filter(type -&gt; resultType.isInstance(type) &amp;&amp; none(abilities, a -&gt; type.hasAbility(a)))</span>
<span class="fc" id="L2164">				.map(type -&gt; resultType.cast(type)).collect(Collectors.toList());</span>
	}

	// Backward compatibility fixes.
	// We do not pretend to fix everything, some specs are just too broken,
	// or some changes too radical. But we make an effort.

	/**
	 * Apply all the special fixes to bring older specifications up to date.
	 */
	private void applyFixes() {
<span class="fc" id="L2175">		fixDifficultyOptions();</span>
<span class="fc" id="L2176">		fixGameOptions();</span>
<span class="fc" id="L2177">		fixMapGeneratorOptions();</span>
<span class="fc" id="L2178">		fixSpec();</span>
<span class="fc" id="L2179">	}</span>

	// @compat 0.10.x
	/**
	 * Handle the reworking of roles that landed in 0.11.0.
	 *
	 * Deliberately not part of applyFixes(), this is called from readFromXML
	 * which can most accurately determine whether it is needed.
	 */
	private void fixRoles() {
		boolean zero10X;
		try {
<span class="pc bpc" id="L2191" title="1 of 2 branches missed.">			zero10X = Double.parseDouble(version) &lt; 0.86;</span>
<span class="nc" id="L2192">		} catch (Exception e) {</span>
<span class="nc" id="L2193">			zero10X = true;</span>
<span class="fc" id="L2194">		}</span>
<span class="pc bpc" id="L2195" title="1 of 2 branches missed.">		if (!zero10X)</span>
<span class="nc" id="L2196">			return;</span>
<span class="fc" id="L2197">		File base = FreeColDirectories.getBaseDirectory();</span>
<span class="fc" id="L2198">		File rolf = new File(base, ROLES_COMPAT_FILE_NAME);</span>
<span class="pc" id="L2199">		try (FileInputStream fis = new FileInputStream(rolf);) {</span>
<span class="fc" id="L2200">			load(fis);</span>
<span class="pc bpc" id="L2201" title="6 of 8 branches missed.">		} catch (Exception e) {</span>
<span class="nc" id="L2202">			logger.log(Level.WARNING, &quot;Failed to load remedial roles.&quot;, e);</span>
<span class="nc" id="L2203">			return;</span>
<span class="fc" id="L2204">		}</span>

<span class="fc" id="L2206">		logger.info(&quot;Loading role backward compatibility fragment: &quot; + ROLES_COMPAT_FILE_NAME + &quot; with roles: &quot;</span>
<span class="fc" id="L2207">				+ getRoles().stream().map(Role::getId).collect(Collectors.joining()));</span>
<span class="fc" id="L2208">	}</span>
	// end @compat 0.10.x

	/**
	 * Specification backward compatibility for the spec in general.
	 */
	private void fixSpec() {
		// @compat 0.10.0
<span class="pc bpc" id="L2216" title="1 of 2 branches missed.">		if (getModifiers(Modifier.SHIP_TRADE_PENALTY) == null) {</span>
<span class="nc" id="L2217">			addModifier(new Modifier(Modifier.SHIP_TRADE_PENALTY, -30.0f, Modifier.ModifierType.PERCENTAGE,</span>
					Specification.SHIP_TRADE_PENALTY_SOURCE));
		}
		// end @compat

		// @compat 0.10.7
		// model.ability.missionary was split into distinct parts,
		// which should be fixed by the roles work, but the Brebeuf
		// scope was left hanging.
<span class="fc" id="L2226">		FoundingFather brebeuf = getFoundingFather(&quot;model.foundingFather.fatherJeanDeBrebeuf&quot;);</span>
<span class="fc bfc" id="L2227" title="All 2 branches covered.">		for (Ability ability : brebeuf.getAbilities()) {</span>
<span class="fc bfc" id="L2228" title="All 2 branches covered.">			for (Scope scope : ability.getScopes()) {</span>
<span class="pc bpc" id="L2229" title="1 of 2 branches missed.">				if (&quot;model.ability.missionary&quot;.equals(scope.getAbilityId())) {</span>
<span class="nc" id="L2230">					scope.setAbilityId(Ability.ESTABLISH_MISSION);</span>
				}
<span class="fc" id="L2232">			}</span>
<span class="fc" id="L2233">		}</span>

		// Coronado gained an ability in freecol
<span class="fc" id="L2236">		FoundingFather coronado = getFoundingFather(&quot;model.foundingFather.franciscoDeCoronado&quot;);</span>
<span class="pc bpc" id="L2237" title="1 of 4 branches missed.">		if (&quot;freecol&quot;.equals(getId()) &amp;&amp; !coronado.hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
<span class="nc" id="L2238">			coronado.addAbility(new Ability(Ability.SEE_ALL_COLONIES, coronado, true));</span>
		}

		// Require the scopes added to founding fathers in git.8971674
<span class="fc" id="L2242">		fatherGoodsFixMap.clear();</span>
<span class="fc" id="L2243">		fatherGoodsFixMap.put(&quot;model.foundingFather.thomasJefferson&quot;, &quot;model.goods.bells&quot;);</span>
<span class="fc" id="L2244">		fatherGoodsFixMap.put(&quot;model.foundingFather.thomasPaine&quot;, &quot;model.goods.bells&quot;);</span>
<span class="fc" id="L2245">		fatherGoodsFixMap.put(&quot;model.foundingFather.williamPenn&quot;, &quot;model.goods.crosses&quot;);</span>
<span class="fc bfc" id="L2246" title="All 2 branches covered.">		for (Entry&lt;String, String&gt; e : fatherGoodsFixMap.entrySet()) {</span>
<span class="fc" id="L2247">			FoundingFather father = getFoundingFather(e.getKey());</span>
<span class="fc bfc" id="L2248" title="All 2 branches covered.">			for (Modifier m : father.getModifiers(e.getValue())) {</span>
<span class="fc" id="L2249">				m.requireNegatedPersonScope();</span>
<span class="fc" id="L2250">			}</span>
<span class="fc" id="L2251">		}</span>

		// Nation FOUND_COLONY -&gt; FOUNDS_COLONIES
<span class="fc bfc" id="L2254" title="All 2 branches covered.">		for (EuropeanNationType ent : europeanNationTypes) {</span>
<span class="pc bpc" id="L2255" title="1 of 2 branches missed.">			if (ent.hasAbility(Ability.FOUND_COLONY)) {</span>
<span class="nc" id="L2256">				ent.removeAbilities(Ability.FOUND_COLONY);</span>
<span class="nc" id="L2257">				ent.addAbility(new Ability(Ability.FOUNDS_COLONIES, ent, true));</span>
			}
<span class="fc" id="L2259">		}</span>

		// Fix REF roles, soldier -&gt; infantry, dragoon -&gt; cavalry
		// Older specs (&lt;= 0.10.5 ?) had refSize directly under difficulty
		// level, later moved it under the monarch group.
<span class="fc bfc" id="L2264" title="All 2 branches covered.">		for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L2265">			Option monarch = level.getOption(GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2266" title="1 of 2 branches missed.">			Option refSize = ((OptionGroup) ((monarch instanceof OptionGroup) ? monarch : level))</span>
<span class="fc" id="L2267">					.getOption(GameOptions.REF_FORCE);</span>
<span class="pc bpc" id="L2268" title="2 of 4 branches missed.">			if (refSize == null || !(refSize instanceof UnitListOption))</span>
<span class="nc" id="L2269">				continue;</span>
<span class="fc bfc" id="L2270" title="All 2 branches covered.">			for (AbstractUnit au : ((UnitListOption) refSize).getOptionValues()) {</span>
<span class="pc bpc" id="L2271" title="1 of 2 branches missed.">				if (&quot;DEFAULT&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2272">					au.setRoleId(DEFAULT_ROLE_ID);</span>
<span class="pc bpc" id="L2273" title="2 of 4 branches missed.">				} else if (&quot;model.role.soldier&quot;.equals(au.getRoleId()) || &quot;SOLDIER&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2274">					au.setRoleId(&quot;model.role.infantry&quot;);</span>
<span class="pc bpc" id="L2275" title="2 of 4 branches missed.">				} else if (&quot;model.role.dragoon&quot;.equals(au.getRoleId()) || &quot;DRAGOON&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2276">					au.setRoleId(&quot;model.role.cavalry&quot;);</span>
				}
<span class="fc" id="L2278">			}</span>
<span class="fc" id="L2279">		}</span>

		// Fix all other UnitListOptions
<span class="fc" id="L2282">		List&lt;Option&gt; todo = new ArrayList&lt;&gt;(getDifficultyLevels());</span>
<span class="fc bfc" id="L2283" title="All 2 branches covered.">		while (!todo.isEmpty()) {</span>
<span class="fc" id="L2284">			Option o = todo.remove(0);</span>
<span class="fc bfc" id="L2285" title="All 2 branches covered.">			if (o instanceof OptionGroup) {</span>
<span class="fc" id="L2286">				List&lt;Option&gt; next = ((OptionGroup) o).getOptions();</span>
<span class="fc" id="L2287">				todo.addAll(new ArrayList&lt;&gt;(next));</span>
<span class="fc bfc" id="L2288" title="All 2 branches covered.">			} else if (o instanceof UnitListOption) {</span>
<span class="fc bfc" id="L2289" title="All 2 branches covered.">				for (AbstractUnit au : ((UnitListOption) o).getOptionValues()) {</span>
<span class="fc" id="L2290">					String roleId = au.getRoleId();</span>
<span class="pc bpc" id="L2291" title="1 of 2 branches missed.">					if (roleId == null) {</span>
<span class="nc" id="L2292">						au.setRoleId(DEFAULT_ROLE_ID);</span>
<span class="pc bpc" id="L2293" title="1 of 2 branches missed.">					} else if (au.getRoleId().startsWith(&quot;model.role.&quot;)) {</span>
						; // OK
<span class="nc bnc" id="L2295" title="All 2 branches missed.">					} else if (&quot;DEFAULT&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2296">						au.setRoleId(DEFAULT_ROLE_ID);</span>
<span class="nc bnc" id="L2297" title="All 2 branches missed.">					} else if (&quot;DRAGOON&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2298">						au.setRoleId(&quot;model.role.dragoon&quot;);</span>
<span class="nc bnc" id="L2299" title="All 2 branches missed.">					} else if (&quot;MISSIONARY&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2300">						au.setRoleId(&quot;model.role.missionary&quot;);</span>
<span class="nc bnc" id="L2301" title="All 2 branches missed.">					} else if (&quot;PIONEER&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2302">						au.setRoleId(&quot;model.role.pioneer&quot;);</span>
<span class="nc bnc" id="L2303" title="All 2 branches missed.">					} else if (&quot;MISSIONARY&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2304">						au.setRoleId(&quot;model.role.missionary&quot;);</span>
<span class="nc bnc" id="L2305" title="All 2 branches missed.">					} else if (&quot;SCOUT&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2306">						au.setRoleId(&quot;model.role.scout&quot;);</span>
<span class="nc bnc" id="L2307" title="All 2 branches missed.">					} else if (&quot;SOLDIER&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2308">						au.setRoleId(&quot;model.role.soldier&quot;);</span>
					} else {
<span class="nc" id="L2310">						au.setRoleId(DEFAULT_ROLE_ID);</span>
					}
<span class="fc" id="L2312">				}</span>
			}
<span class="fc" id="L2314">		}</span>

		// The REF is also an independent nation, which is a required
		// ability to have man-o-war. Older specs used
		// INDEPENDENCE_DECLARED but we can not directly use that or
		// the REF gets access to colonialRegulars.
<span class="fc bfc" id="L2320" title="All 2 branches covered.">		for (NationType nt : europeanNationTypes) {</span>
<span class="fc bfc" id="L2321" title="All 2 branches covered.">			if (!nt.isREF())</span>
<span class="fc" id="L2322">				continue;</span>
<span class="pc bpc" id="L2323" title="1 of 2 branches missed.">			if (!nt.hasAbility(Ability.INDEPENDENT_NATION)) {</span>
<span class="nc" id="L2324">				nt.addAbility(new Ability(Ability.INDEPENDENT_NATION));</span>
			}
<span class="fc" id="L2326">		}</span>

		// Resource type modifiers had the wrong priority
<span class="fc bfc" id="L2329" title="All 2 branches covered.">		for (ResourceType rt : resourceTypeList) {</span>
<span class="fc bfc" id="L2330" title="All 2 branches covered.">			for (Modifier m : rt.getModifiers()) {</span>
<span class="fc" id="L2331">				m.setModifierIndex(Modifier.RESOURCE_PRODUCTION_INDEX);</span>
<span class="fc" id="L2332">			}</span>
<span class="fc" id="L2333">		}</span>

		// Unit type indexes moved into the spec
<span class="fc bfc" id="L2336" title="All 2 branches covered.">		for (UnitType ut : unitTypeList) {</span>
<span class="fc bfc" id="L2337" title="All 2 branches covered.">			for (Modifier m : ut.getModifiers()) {</span>
<span class="fc bfc" id="L2338" title="All 2 branches covered.">				if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2339">					m.setModifierIndex(Modifier.EXPERT_PRODUCTION_INDEX);</span>
				}
<span class="fc" id="L2341">			}</span>
<span class="fc" id="L2342">		}</span>

		// Father production modifiers have moved to the spec
<span class="fc bfc" id="L2345" title="All 2 branches covered.">		for (FoundingFather ff : foundingFathers) {</span>
<span class="fc bfc" id="L2346" title="All 2 branches covered.">			for (Modifier m : ff.getModifiers()) {</span>
<span class="fc bfc" id="L2347" title="All 2 branches covered.">				if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2348">					m.setModifierIndex(Modifier.FATHER_PRODUCTION_INDEX);</span>
				}
<span class="fc" id="L2350">			}</span>
<span class="fc" id="L2351">		}</span>

		// Tile improvement type modifier index has moved to the spec
<span class="fc bfc" id="L2354" title="All 2 branches covered.">		for (TileImprovementType ti : tileImprovementTypeList) {</span>
<span class="fc bfc" id="L2355" title="All 2 branches covered.">			for (Modifier m : ti.getModifiers()) {</span>
<span class="pc bpc" id="L2356" title="1 of 2 branches missed.">				if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2357">					m.setModifierIndex(Modifier.IMPROVEMENT_PRODUCTION_INDEX);</span>
				}
<span class="fc" id="L2359">			}</span>
<span class="fc" id="L2360">		}</span>

		// Building type modifier indexes have moved to the spec
<span class="fc bfc" id="L2363" title="All 2 branches covered.">		for (BuildingType bt : buildingTypeList) {</span>
<span class="fc bfc" id="L2364" title="All 2 branches covered.">			for (Modifier m : bt.getModifiers()) {</span>
<span class="fc bfc" id="L2365" title="All 2 branches covered.">				if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc bfc" id="L2366" title="All 2 branches covered.">					m.setModifierIndex((bt.hasAbility(Ability.AUTO_PRODUCTION)) ? Modifier.AUTO_PRODUCTION_INDEX</span>
							: Modifier.BUILDING_PRODUCTION_INDEX);
				}
<span class="fc" id="L2369">			}</span>
<span class="fc" id="L2370">		}</span>

		// European nation type production modifier indexes moved to the spec
<span class="fc bfc" id="L2373" title="All 2 branches covered.">		for (EuropeanNationType et : europeanNationTypes) {</span>
<span class="fc bfc" id="L2374" title="All 2 branches covered.">			for (Modifier m : et.getModifiers()) {</span>
<span class="fc bfc" id="L2375" title="All 2 branches covered.">				if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2376">					m.setModifierIndex(Modifier.NATION_PRODUCTION_INDEX);</span>
				}
<span class="fc" id="L2378">			}</span>
<span class="fc" id="L2379">		}</span>

		// TownHall, Chapel et al now have unattended production types
		// (replacing modifiers).
<span class="fc" id="L2383">		BuildingType townHallType = getBuildingType(&quot;model.building.townHall&quot;);</span>
<span class="pc bpc" id="L2384" title="1 of 2 branches missed.">		if (townHallType.hasModifier(&quot;model.goods.bells&quot;)) {</span>
<span class="nc" id="L2385">			GoodsType bellsType = getGoodsType(&quot;model.goods.bells&quot;);</span>
<span class="nc" id="L2386">			AbstractGoods ag = new AbstractGoods(bellsType, 1);</span>
<span class="nc" id="L2387">			ProductionType pt = new ProductionType(ag, true, null);</span>
<span class="nc" id="L2388">			townHallType.addProductionType(pt);</span>
<span class="nc" id="L2389">			townHallType.removeModifiers(&quot;model.goods.bells&quot;);</span>
<span class="nc" id="L2390">			logger.info(&quot;Added backward compatibility production &quot; + pt + &quot; to &quot; + townHallType);</span>
		}
<span class="fc" id="L2392">		GoodsType crossesType = getGoodsType(&quot;model.goods.crosses&quot;);</span>
<span class="fc" id="L2393">		int a = 1;</span>
<span class="fc bfc" id="L2394" title="All 2 branches covered.">		for (BuildingType bt : new BuildingType[] { getBuildingType(&quot;model.building.chapel&quot;),</span>
<span class="fc" id="L2395">				getBuildingType(&quot;model.building.church&quot;), getBuildingType(&quot;model.building.cathedral&quot;) }) {</span>
<span class="pc bpc" id="L2396" title="1 of 2 branches missed.">			if (bt.hasModifier(&quot;model.goods.crosses&quot;)) {</span>
<span class="nc" id="L2397">				AbstractGoods ag = new AbstractGoods(crossesType, a);</span>
<span class="nc" id="L2398">				a++;</span>
<span class="nc" id="L2399">				ProductionType pt = new ProductionType(ag, true, null);</span>
<span class="nc" id="L2400">				bt.addProductionType(pt);</span>
<span class="nc" id="L2401">				bt.removeModifiers(&quot;model.goods.crosses&quot;);</span>
<span class="nc" id="L2402">				logger.info(&quot;Added backward compatibility production &quot; + pt + &quot; to &quot; + bt);</span>
			}
		}
		// Country and stables production is now defined as unattended.
<span class="fc bfc" id="L2406" title="All 2 branches covered.">		for (BuildingType bt : new BuildingType[] { getBuildingType(&quot;model.building.country&quot;),</span>
<span class="fc" id="L2407">				getBuildingType(&quot;model.building.stables&quot;) }) {</span>
<span class="pc bpc" id="L2408" title="1 of 2 branches missed.">			for (ProductionType pt : bt.getAvailableProductionTypes(false)) {</span>
<span class="nc" id="L2409">				pt.setUnattended(true);</span>
<span class="nc" id="L2410">				logger.info(&quot;Switched production &quot; + pt + &quot; to unattended at &quot; + bt);</span>
<span class="nc" id="L2411">			}</span>
		}

		// 0.10.x had no unknown enemy nation, just an unknown enemy player
<span class="pc bpc" id="L2415" title="1 of 2 branches missed.">		if (getNation(Nation.UNKNOWN_NATION_ID) == null) {</span>
<span class="nc" id="L2416">			Nation ue = new Nation(Nation.UNKNOWN_NATION_ID, this);</span>
<span class="nc" id="L2417">			ue.setColor(Nation.UNKNOWN_NATION_COLOR);</span>
		}

		// Ambush terrain ability not present in older specs.
<span class="pc bpc" id="L2421" title="1 of 2 branches missed.">		if (getAbilities(Ability.AMBUSH_TERRAIN) == null) {</span>
<span class="nc" id="L2422">			Ability ambush = new Ability(Ability.AMBUSH_TERRAIN, null, true);</span>
<span class="nc" id="L2423">			addAbility(ambush);</span>
<span class="nc bnc" id="L2424" title="All 2 branches missed.">			for (TileType tt : getTileTypeList()) {</span>
<span class="nc bnc" id="L2425" title="All 6 branches missed.">				if ((tt.isElevation() || tt.isForested()) &amp;&amp; !tt.hasAbility(Ability.AMBUSH_TERRAIN)) {</span>
<span class="nc" id="L2426">					tt.addAbility(new Ability(Ability.AMBUSH_TERRAIN, tt, true));</span>
				}
<span class="nc" id="L2428">			}</span>
		}

		// is-military was added to goods type
<span class="fc" id="L2432">		GoodsType goodsType = getGoodsType(&quot;model.goods.horses&quot;);</span>
<span class="fc" id="L2433">		goodsType.setMilitary();</span>
<span class="fc" id="L2434">		goodsType = getGoodsType(&quot;model.goods.muskets&quot;);</span>
<span class="fc" id="L2435">		goodsType.setMilitary();</span>

		// automaticEquipment scope types are now roles
<span class="fc bfc" id="L2438" title="All 2 branches covered.">		for (NationType nt : indianNationTypes) {</span>
<span class="fc bfc" id="L2439" title="All 2 branches covered.">			for (Ability ability : nt.getAbilities(Ability.AUTOMATIC_EQUIPMENT)) {</span>
<span class="fc bfc" id="L2440" title="All 2 branches covered.">				for (Scope scope : ability.getScopes()) {</span>
<span class="fc" id="L2441">					String type = scope.getType();</span>
<span class="pc bpc" id="L2442" title="1 of 2 branches missed.">					if (&quot;model.equipment.indian.muskets&quot;.equals(type)) {</span>
<span class="nc" id="L2443">						scope.setType(&quot;model.role.nativeDragoon&quot;);</span>
<span class="pc bpc" id="L2444" title="1 of 2 branches missed.">					} else if (&quot;model.equipment.indian.horses&quot;.equals(type)) {</span>
<span class="nc" id="L2445">						scope.setType(&quot;model.role.armedBrave&quot;);</span>
					}
<span class="fc" id="L2447">				}</span>
<span class="fc" id="L2448">			}</span>
<span class="fc" id="L2449">		}</span>
		{
<span class="fc" id="L2451">			FoundingFather revere = getFoundingFather(&quot;model.foundingFather.paulRevere&quot;);</span>
<span class="fc bfc" id="L2452" title="All 2 branches covered.">			for (Ability ability : revere.getAbilities(Ability.AUTOMATIC_EQUIPMENT)) {</span>
<span class="fc bfc" id="L2453" title="All 2 branches covered.">				for (Scope scope : ability.getScopes()) {</span>
<span class="fc" id="L2454">					String type = scope.getType();</span>
<span class="pc bpc" id="L2455" title="1 of 2 branches missed.">					if (&quot;model.equipment.muskets&quot;.equals(type)) {</span>
<span class="nc" id="L2456">						scope.setType(&quot;model.role.soldier&quot;);</span>
					}
<span class="fc" id="L2458">				}</span>
<span class="fc" id="L2459">			}</span>
		}
		// end @compat 0.10.7

		// @compat 0.11.0
		// Bolivar changed from being an event, then to a liberty modifier,
		// and now to a SoL% modifier.
<span class="fc" id="L2466">		FoundingFather bolivar = getFoundingFather(&quot;model.foundingFather.simonBolivar&quot;);</span>
<span class="fc" id="L2467">		boolean bolivarAdd = false;</span>
<span class="pc bpc" id="L2468" title="1 of 2 branches missed.">		if (!bolivar.getEvents().isEmpty()) {</span>
<span class="nc" id="L2469">			bolivar.setEvents(Collections.&lt;Event&gt;emptyList());</span>
<span class="nc" id="L2470">			bolivarAdd = true;</span>
<span class="pc bpc" id="L2471" title="1 of 2 branches missed.">		} else if (bolivar.hasModifier(Modifier.LIBERTY)) {</span>
<span class="nc" id="L2472">			bolivar.removeModifiers(Modifier.LIBERTY);</span>
<span class="nc" id="L2473">			bolivarAdd = true;</span>
		}
<span class="pc bpc" id="L2475" title="1 of 2 branches missed.">		if (bolivarAdd) {</span>
<span class="nc" id="L2476">			bolivar.addModifier(new Modifier(Modifier.SOL, 20, Modifier.ModifierType.ADDITIVE, bolivar, 0));</span>
		}

		// The COASTAL_ONLY attribute was added to customs house.
<span class="fc" id="L2480">		BuildingType customs = getBuildingType(&quot;model.building.customHouse&quot;);</span>
<span class="pc bpc" id="L2481" title="1 of 2 branches missed.">		if (!customs.hasAbility(Ability.COASTAL_ONLY)) {</span>
<span class="fc" id="L2482">			customs.addAbility(new Ability(Ability.COASTAL_ONLY, null, false));</span>
		}
		// end @compat 0.11.0

		// @compat 0.11.3
		// Added the cargo penalty modifier
<span class="pc bpc" id="L2488" title="1 of 2 branches missed.">		if (getModifiers(Modifier.CARGO_PENALTY).isEmpty()) {</span>
<span class="nc" id="L2489">			addModifier(new Modifier(Modifier.CARGO_PENALTY, -12.5f, Modifier.ModifierType.PERCENTAGE,</span>
					CARGO_PENALTY_SOURCE, Modifier.GENERAL_COMBAT_INDEX));
		}

		// Backwards compatibility for the fixes to BR#2873.
<span class="fc" id="L2494">		Event event = getEvent(&quot;model.event.declareIndependence&quot;);</span>
<span class="pc bpc" id="L2495" title="1 of 2 branches missed.">		if (event != null) {</span>
<span class="fc" id="L2496">			Limit limit = event.getLimit(&quot;model.limit.independence.coastalColonies&quot;);</span>
<span class="pc bpc" id="L2497" title="1 of 2 branches missed.">			if (limit != null) {</span>
<span class="fc" id="L2498">				limit.setOperator(Limit.Operator.GE);</span>
<span class="fc" id="L2499">				limit.getRightHandSide().setValue(1);</span>
			}
		}
		// end @compat 0.11.3

		// @compat 0.11.5
		// Added a modifier to hardy pioneer
<span class="fc" id="L2506">		UnitType hardyPioneer = getUnitType(&quot;model.unit.hardyPioneer&quot;);</span>
<span class="pc bpc" id="L2507" title="1 of 2 branches missed.">		if (hardyPioneer.getModifiers(Modifier.TILE_TYPE_CHANGE_PRODUCTION).isEmpty()) {</span>
<span class="nc" id="L2508">			Modifier m = new Modifier(Modifier.TILE_TYPE_CHANGE_PRODUCTION, 2.0f, Modifier.ModifierType.MULTIPLICATIVE);</span>
<span class="nc" id="L2509">			Scope scope = new Scope();</span>
<span class="nc" id="L2510">			scope.setType(&quot;model.goods.lumber&quot;);</span>
<span class="nc" id="L2511">			m.addScope(scope);</span>
<span class="nc" id="L2512">			hardyPioneer.addModifier(m);</span>
		}

		// Added modifier to Coronado
<span class="fc bfc" id="L2516" title="All 2 branches covered.">		if (!coronado.hasModifier(Modifier.EXPOSED_TILES_RADIUS)) {</span>
<span class="fc" id="L2517">			coronado.addModifier(</span>
					new Modifier(Modifier.EXPOSED_TILES_RADIUS, 3.0f, Modifier.ModifierType.ADDITIVE, coronado, 0));
		}
		// end @compat 0.11.5
<span class="fc" id="L2521">	}</span>

	/**
	 * Backward compatibility code to make sure this specification contains a
	 * default value for every difficulty option.
	 *
	 * When a new difficulty option is added to the spec, add a sensible default
	 * here.
	 *
	 * @return True if an option was missing and added.
	 */
	private boolean fixDifficultyOptions() {
<span class="fc" id="L2533">		boolean ret = false;</span>
		String id;
		AbstractOption op;
		OptionGroup og;
		UnitListOption ulo;

		// SAVEGAME_VERSION == 11

		// For 0.10.6 we moved from a three level structure:
		// difficultyLevels/&lt;difficulty&gt;/&lt;option&gt;
		// to a four level structure
		// difficultyLevels/&lt;difficulty&gt;/&lt;group&gt;/&lt;option&gt;
		// so add the groups in, and move the options that could be present
		// in anything up to 0.10.5 into their destination groups.
<span class="fc" id="L2547">		ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_IMMIGRATION, GameOptions.CROSSES_INCREMENT,</span>
				GameOptions.RECRUIT_PRICE_INCREASE, GameOptions.LOWER_CAP_INCREASE,
				GameOptions.PRICE_INCREASE + &quot;.artillery&quot;, GameOptions.PRICE_INCREASE_PER_TYPE,
				GameOptions.EXPERT_STARTING_UNITS, GameOptions.IMMIGRANTS);
<span class="fc" id="L2551">		ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_NATIVES, GameOptions.LAND_PRICE_FACTOR,</span>
				GameOptions.NATIVE_CONVERT_PROBABILITY, GameOptions.BURN_PROBABILITY, GameOptions.NATIVE_DEMANDS,
				GameOptions.RUMOUR_DIFFICULTY, GameOptions.SHIP_TRADE_PENALTY, GameOptions.BUILD_ON_NATIVE_LAND,
				GameOptions.SETTLEMENT_NUMBER);
<span class="fc" id="L2555">		ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_MONARCH, GameOptions.MONARCH_MEDDLING,</span>
				GameOptions.TAX_ADJUSTMENT, GameOptions.MERCENARY_PRICE, GameOptions.MAXIMUM_TAX,
				GameOptions.MONARCH_SUPPORT, GameOptions.TREASURE_TRANSPORT_FEE, GameOptions.REF_FORCE,
				GameOptions.INTERVENTION_BELLS, GameOptions.INTERVENTION_TURNS, GameOptions.INTERVENTION_FORCE,
				GameOptions.MERCENARY_FORCE);
<span class="fc" id="L2560">		ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_GOVERNMENT, GameOptions.BAD_GOVERNMENT_LIMIT,</span>
				GameOptions.VERY_BAD_GOVERNMENT_LIMIT, GameOptions.GOOD_GOVERNMENT_LIMIT,
				GameOptions.VERY_GOOD_GOVERNMENT_LIMIT);
<span class="fc" id="L2563">		ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_OTHER, GameOptions.STARTING_MONEY,</span>
				GameOptions.FOUNDING_FATHER_FACTOR, GameOptions.ARREARS_FACTOR, GameOptions.UNITS_THAT_USE_NO_BELLS,
				GameOptions.TILE_PRODUCTION);
<span class="fc" id="L2566">		ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_CHEAT, GameOptions.LIFT_BOYCOTT_CHEAT,</span>
				GameOptions.EQUIP_SCOUT_CHEAT, GameOptions.LAND_UNIT_CHEAT, GameOptions.OFFENSIVE_NAVAL_UNIT_CHEAT,
				GameOptions.TRANSPORT_NAVAL_UNIT_CHEAT);

		// @compat 0.10.0
		// This used to be a game option.
<span class="fc" id="L2572">		ret |= checkDifficultyIntegerOption(GameOptions.SHIP_TRADE_PENALTY, GameOptions.DIFFICULTY_NATIVES, -30);</span>
		// end @compat 0.10.0

		// SAVEGAME_VERSION == 12

		// @compat 0.10.4
<span class="fc" id="L2578">		id = GameOptions.REF_FORCE; // Yes, really &quot;refSize&quot;</span>
<span class="fc" id="L2579">		ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2580" title="1 of 2 branches missed.">		if (ulo != null) {</span>
<span class="nc" id="L2581">			AbstractUnitOption regulars = new AbstractUnitOption(id + &quot;.regulars&quot;, this);</span>
<span class="nc" id="L2582">			regulars.setValue(new AbstractUnit(&quot;model.unit.kingsRegular&quot;, &quot;model.role.infantry&quot;, 31));</span>
<span class="nc" id="L2583">			ulo.getValue().add(regulars);</span>
<span class="nc" id="L2584">			AbstractUnitOption dragoons = new AbstractUnitOption(id + &quot;.dragoons&quot;, this);</span>
<span class="nc" id="L2585">			dragoons.setValue(new AbstractUnit(&quot;model.unit.kingsRegular&quot;, &quot;model.role.cavalry&quot;, 15));</span>
<span class="nc" id="L2586">			ulo.getValue().add(dragoons);</span>
<span class="nc" id="L2587">			AbstractUnitOption artillery = new AbstractUnitOption(id + &quot;.artillery&quot;, this);</span>
<span class="nc" id="L2588">			artillery.setValue(new AbstractUnit(&quot;model.unit.artillery&quot;, DEFAULT_ROLE_ID, 14));</span>
<span class="nc" id="L2589">			ulo.getValue().add(artillery);</span>
<span class="nc" id="L2590">			AbstractUnitOption menOfWar = new AbstractUnitOption(id + &quot;.menOfWar&quot;, this);</span>
<span class="nc" id="L2591">			menOfWar.setValue(new AbstractUnit(&quot;model.unit.manOWar&quot;, DEFAULT_ROLE_ID, 8));</span>
<span class="nc" id="L2592">			ulo.getValue().add(menOfWar);</span>
<span class="nc" id="L2593">			ret = true;</span>
		}
<span class="fc" id="L2595">		id = GameOptions.IMMIGRANTS;</span>
<span class="fc" id="L2596">		ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_IMMIGRATION);</span>
<span class="fc bfc" id="L2597" title="All 2 branches covered.">		if (ulo != null) {</span>
<span class="fc" id="L2598">			AbstractUnitOption i1 = new AbstractUnitOption(id + &quot;.1&quot;, this);</span>
<span class="fc" id="L2599">			i1.setValue(new AbstractUnit(&quot;model.unit.masterCarpenter&quot;, DEFAULT_ROLE_ID, 1));</span>
<span class="fc" id="L2600">			ulo.getValue().add(i1);</span>
<span class="fc" id="L2601">			ret = true;</span>
		}
		// end @compat 0.10.4

		// @compat 0.10.5
<span class="fc" id="L2606">		ret |= checkDifficultyIntegerOption(GameOptions.INTERVENTION_BELLS, GameOptions.DIFFICULTY_MONARCH, 5000);</span>
<span class="fc" id="L2607">		ret |= checkDifficultyIntegerOption(GameOptions.INTERVENTION_TURNS, GameOptions.DIFFICULTY_MONARCH, 52);</span>
<span class="fc" id="L2608">		id = GameOptions.INTERVENTION_FORCE;</span>
<span class="fc" id="L2609">		ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2610" title="1 of 2 branches missed.">		if (ulo != null) {</span>
<span class="nc" id="L2611">			AbstractUnitOption regulars = new AbstractUnitOption(id + &quot;.regulars&quot;, this);</span>
<span class="nc" id="L2612">			regulars.setValue(new AbstractUnit(&quot;model.unit.colonialRegular&quot;, &quot;model.role.soldier&quot;, 2));</span>
<span class="nc" id="L2613">			ulo.getValue().add(regulars);</span>
<span class="nc" id="L2614">			AbstractUnitOption dragoons = new AbstractUnitOption(id + &quot;.dragoons&quot;, this);</span>
<span class="nc" id="L2615">			dragoons.setValue(new AbstractUnit(&quot;model.unit.colonialRegular&quot;, &quot;model.role.dragoon&quot;, 2));</span>
<span class="nc" id="L2616">			ulo.getValue().add(dragoons);</span>
<span class="nc" id="L2617">			AbstractUnitOption artillery = new AbstractUnitOption(id + &quot;.artillery&quot;, this);</span>
<span class="nc" id="L2618">			artillery.setValue(new AbstractUnit(&quot;model.unit.artillery&quot;, DEFAULT_ROLE_ID, 2));</span>
<span class="nc" id="L2619">			ulo.getValue().add(artillery);</span>
<span class="nc" id="L2620">			AbstractUnitOption menOfWar = new AbstractUnitOption(id + &quot;.menOfWar&quot;, this);</span>
<span class="nc" id="L2621">			menOfWar.setValue(new AbstractUnit(&quot;model.unit.manOWar&quot;, DEFAULT_ROLE_ID, 2));</span>
<span class="nc" id="L2622">			ulo.getValue().add(menOfWar);</span>
<span class="nc" id="L2623">			ret = true;</span>
		}
<span class="fc" id="L2625">		id = GameOptions.MERCENARY_FORCE;</span>
<span class="fc" id="L2626">		ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2627" title="1 of 2 branches missed.">		if (ulo != null) {</span>
<span class="nc" id="L2628">			AbstractUnitOption regulars = new AbstractUnitOption(id + &quot;.regulars&quot;, this);</span>
<span class="nc" id="L2629">			regulars.setValue(new AbstractUnit(&quot;model.unit.veteranSoldier&quot;, &quot;model.role.soldier&quot;, 2));</span>
<span class="nc" id="L2630">			ulo.getValue().add(regulars);</span>
<span class="nc" id="L2631">			AbstractUnitOption dragoons = new AbstractUnitOption(id + &quot;.dragoons&quot;, this);</span>
<span class="nc" id="L2632">			dragoons.setValue(new AbstractUnit(&quot;model.unit.veteranSoldier&quot;, &quot;model.role.dragoon&quot;, 2));</span>
<span class="nc" id="L2633">			ulo.getValue().add(dragoons);</span>
<span class="nc" id="L2634">			AbstractUnitOption artillery = new AbstractUnitOption(id + &quot;.artillery&quot;, this);</span>
<span class="nc" id="L2635">			artillery.setValue(new AbstractUnit(&quot;model.unit.artillery&quot;, DEFAULT_ROLE_ID, 2));</span>
<span class="nc" id="L2636">			ulo.getValue().add(artillery);</span>
<span class="nc" id="L2637">			AbstractUnitOption menOfWar = new AbstractUnitOption(id + &quot;.menOfWar&quot;, this);</span>
<span class="nc" id="L2638">			menOfWar.setValue(new AbstractUnit(&quot;model.unit.manOWar&quot;, DEFAULT_ROLE_ID, 2));</span>
<span class="nc" id="L2639">			ulo.getValue().add(menOfWar);</span>
<span class="nc" id="L2640">			ret = true;</span>
		}
<span class="fc" id="L2642">		ret |= checkDifficultyIntegerOption(GameOptions.GOOD_GOVERNMENT_LIMIT, GameOptions.DIFFICULTY_GOVERNMENT, 50);</span>
<span class="fc" id="L2643">		ret |= checkDifficultyIntegerOption(GameOptions.VERY_GOOD_GOVERNMENT_LIMIT, GameOptions.DIFFICULTY_GOVERNMENT,</span>
				100);
<span class="fc" id="L2645">		ret |= checkDifficultyIntegerOption(GameOptions.LIFT_BOYCOTT_CHEAT, GameOptions.DIFFICULTY_CHEAT, 10);</span>
<span class="fc" id="L2646">		ret |= checkDifficultyIntegerOption(GameOptions.EQUIP_SCOUT_CHEAT, GameOptions.DIFFICULTY_CHEAT, 10);</span>
<span class="fc" id="L2647">		ret |= checkDifficultyIntegerOption(GameOptions.LAND_UNIT_CHEAT, GameOptions.DIFFICULTY_CHEAT, 10);</span>
<span class="fc" id="L2648">		ret |= checkDifficultyIntegerOption(GameOptions.OFFENSIVE_NAVAL_UNIT_CHEAT, GameOptions.DIFFICULTY_CHEAT, 10);</span>
<span class="fc" id="L2649">		ret |= checkDifficultyIntegerOption(GameOptions.TRANSPORT_NAVAL_UNIT_CHEAT, GameOptions.DIFFICULTY_CHEAT, 10);</span>
		// end @compat 0.10.5

		// SAVEGAME_VERSION == 13

		// @compat 0.10.7
<span class="fc" id="L2655">		ret |= checkDifficultyIntegerOption(GameOptions.DESTROY_SETTLEMENT_SCORE, GameOptions.DIFFICULTY_NATIVES, -5);</span>
<span class="fc" id="L2656">		ret |= checkDifficultyIntegerOption(GameOptions.BAD_RUMOUR, GameOptions.DIFFICULTY_OTHER, 23);</span>
<span class="fc" id="L2657">		ret |= checkDifficultyIntegerOption(GameOptions.GOOD_RUMOUR, GameOptions.DIFFICULTY_OTHER, 48);</span>
<span class="fc" id="L2658">		ret |= checkDifficultyIntegerOption(GameOptions.OFFENSIVE_LAND_UNIT_CHEAT, GameOptions.DIFFICULTY_CHEAT, 4);</span>
<span class="fc" id="L2659">		ret |= checkDifficultyIntegerOption(GameOptions.EQUIP_PIONEER_CHEAT, GameOptions.DIFFICULTY_CHEAT, 10);</span>
		// end @compat 0.10.7

		// @compat 0.11.3
<span class="fc" id="L2663">		id = GameOptions.WAR_SUPPORT_FORCE;</span>
<span class="fc" id="L2664">		ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2665" title="1 of 2 branches missed.">		if (ulo != null) {</span>
<span class="nc" id="L2666">			AbstractUnitOption support = new AbstractUnitOption(id, this);</span>
<span class="nc" id="L2667">			support.setValue(new AbstractUnit(&quot;model.unit.veteranSoldier&quot;, &quot;model.role.soldier&quot;, 4));</span>
<span class="nc" id="L2668">			ulo.getValue().add(support);</span>
<span class="nc" id="L2669">			ret = true;</span>
		}
<span class="fc" id="L2671">		ret |= checkDifficultyIntegerOption(GameOptions.WAR_SUPPORT_GOLD, GameOptions.DIFFICULTY_MONARCH, 1500);</span>
		// end @compat 0.11.3

<span class="fc" id="L2674">		return ret;</span>
	}

	/**
	 * Check difficulty option group.
	 *
	 * @param gr
	 *            the gr
	 * @param ids
	 *            the ids
	 * @return true, if successful
	 */
	private boolean checkDifficultyOptionGroup(String gr, String... ids) {
<span class="fc" id="L2687">		logger.info(&quot;Check group &quot; + gr);</span>
<span class="fc" id="L2688">		boolean ret = false;</span>
<span class="fc bfc" id="L2689" title="All 2 branches covered.">		for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L2690">			Option op = level.getOption(gr);</span>
			OptionGroup og;
<span class="pc bpc" id="L2692" title="1 of 2 branches missed.">			if (op instanceof OptionGroup) {</span>
<span class="fc" id="L2693">				og = (OptionGroup) op;</span>
			} else {
<span class="nc" id="L2695">				og = new OptionGroup(gr, this);</span>
<span class="nc" id="L2696">				level.add(og);</span>
<span class="nc" id="L2697">				og.setGroup(level.getId());</span>
<span class="nc" id="L2698">				ret = true;</span>
			}
<span class="fc bfc" id="L2700" title="All 2 branches covered.">			for (String id : ids) {</span>
<span class="fc" id="L2701">				op = level.remove(id);</span>
<span class="fc bfc" id="L2702" title="All 2 branches covered.">				if (op != null) {</span>
<span class="pc bpc" id="L2703" title="1 of 2 branches missed.">					if (op instanceof AbstractOption) {</span>
<span class="fc" id="L2704">						((AbstractOption) op).setGroup(og.getId());</span>
					}
<span class="fc" id="L2706">					og.add(op);</span>
<span class="fc" id="L2707">					ret = true;</span>
				}
			}
<span class="fc" id="L2710">		}</span>
<span class="fc" id="L2711">		return ret;</span>
	}

	/**
	 * Check difficulty integer option.
	 *
	 * @param id
	 *            the id
	 * @param gr
	 *            the gr
	 * @param defaultValue
	 *            the default value
	 * @return true, if successful
	 */
	private boolean checkDifficultyIntegerOption(String id, String gr, int defaultValue) {
<span class="fc" id="L2726">		boolean ret = false;</span>
<span class="fc bfc" id="L2727" title="All 2 branches covered.">		for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L2728">			Option op = level.getOption(gr);</span>
<span class="pc bpc" id="L2729" title="1 of 2 branches missed.">			if (op instanceof OptionGroup) {</span>
<span class="fc" id="L2730">				OptionGroup og = (OptionGroup) op;</span>
<span class="pc bpc" id="L2731" title="1 of 2 branches missed.">				if ((op = og.getOption(id)) != null)</span>
<span class="fc" id="L2732">					continue;</span>
<span class="nc" id="L2733">				IntegerOption iop = new IntegerOption(id, this);</span>
<span class="nc" id="L2734">				iop.setGroup(gr);</span>
<span class="nc" id="L2735">				iop.setValue(defaultValue);</span>
<span class="nc" id="L2736">				og.add(iop);</span>
<span class="nc" id="L2737">				ret = true;</span>
			}
<span class="nc" id="L2739">		}</span>
<span class="pc bpc" id="L2740" title="1 of 2 branches missed.">		if (ret) {</span>
<span class="nc" id="L2741">			logger.info(&quot;Added difficulty integer option: &quot; + id);</span>
		}
<span class="fc" id="L2743">		return ret;</span>
	}

	/**
	 * Check difficulty unit list option.
	 *
	 * @param id
	 *            the id
	 * @param gr
	 *            the gr
	 * @return the unit list option
	 */
	private UnitListOption checkDifficultyUnitListOption(String id, String gr) {
<span class="fc" id="L2756">		UnitListOption ulo = null;</span>
<span class="fc bfc" id="L2757" title="All 2 branches covered.">		for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L2758">			Option op = level.getOption(gr);</span>
<span class="pc bpc" id="L2759" title="1 of 2 branches missed.">			if (op instanceof OptionGroup) {</span>
<span class="fc" id="L2760">				OptionGroup og = (OptionGroup) op;</span>
<span class="fc bfc" id="L2761" title="All 2 branches covered.">				if (og.getOption(id) instanceof UnitListOption)</span>
<span class="fc" id="L2762">					continue;</span>
<span class="fc bfc" id="L2763" title="All 2 branches covered.">				if (ulo == null)</span>
<span class="fc" id="L2764">					ulo = new UnitListOption(id, this);</span>
<span class="fc" id="L2765">				og.add(ulo);</span>
			}
<span class="fc" id="L2767">		}</span>
<span class="fc bfc" id="L2768" title="All 2 branches covered.">		if (ulo != null) {</span>
<span class="fc" id="L2769">			logger.info(&quot;Added difficulty unit list option: &quot; + id);</span>
		}
<span class="fc" id="L2771">		return ulo;</span>
	}

	/**
	 * Backward compatibility code to make sure this specification contains a
	 * default value for every game option.
	 *
	 * When a new game option is added to the spec, add a sensible default here.
	 *
	 * @return True if an option was missing and added.
	 */
	public boolean fixGameOptions() {
<span class="fc" id="L2783">		boolean ret = false;</span>
		// SAVEGAME_VERSION == 11

		// @compat 0.10.0
<span class="fc" id="L2787">		ret |= checkOptionGroup(GameOptions.GAMEOPTIONS_YEARS);</span>
<span class="fc" id="L2788">		String[] years = { GameOptions.STARTING_YEAR, GameOptions.SEASON_YEAR, GameOptions.MANDATORY_COLONY_YEAR,</span>
				GameOptions.LAST_YEAR, GameOptions.LAST_COLONIAL_YEAR, };
<span class="fc" id="L2790">		int[] values = { 1492, 1600, 1600, 1850, 1800 };</span>
<span class="fc bfc" id="L2791" title="All 2 branches covered.">		for (int index = 0; index &lt; years.length; index++) {</span>
<span class="fc" id="L2792">			ret |= checkIntegerOption(years[index], GameOptions.GAMEOPTIONS_YEARS, values[index]);</span>
		}
<span class="fc" id="L2794">		ret |= checkBooleanOption(GameOptions.ENHANCED_MISSIONARIES, GameOptions.GAMEOPTIONS_MAP, false);</span>
<span class="fc" id="L2795">		ret |= checkBooleanOption(GameOptions.CONTINUE_FOUNDING_FATHER_RECRUITMENT, GameOptions.GAMEOPTIONS_MAP, false);</span>
<span class="fc" id="L2796">		ret |= checkIntegerOption(GameOptions.SETTLEMENT_LIMIT_MODIFIER, GameOptions.GAMEOPTIONS_MAP, 0);</span>
<span class="fc" id="L2797">		ret |= checkBooleanOption(GameOptions.SETTLEMENT_ACTIONS_CONTACT_CHIEF, GameOptions.GAMEOPTIONS_MAP, false);</span>
<span class="fc" id="L2798">		ret |= checkIntegerOption(GameOptions.STARTING_POSITIONS, GameOptions.GAMEOPTIONS_MAP, 0);</span>
<span class="fc" id="L2799">		ret |= checkBooleanOption(GameOptions.TELEPORT_REF, GameOptions.GAMEOPTIONS_MAP, false);</span>
		// end @compat 0.10.0

		// SAVEGAME_VERSION == 12

		// @compat 0.10.5
<span class="fc" id="L2805">		ret |= checkBooleanOption(GameOptions.ENABLE_UPKEEP, GameOptions.GAMEOPTIONS_COLONY, false);</span>
<span class="fc" id="L2806">		ret |= checkIntegerOption(GameOptions.NATURAL_DISASTERS, GameOptions.GAMEOPTIONS_COLONY, 0);</span>
<span class="fc" id="L2807">		ret |= checkIntegerOption(GameOptions.GIFT_PROBABILITY, GameOptions.GAMEOPTIONS_MAP, 5);</span>
<span class="fc" id="L2808">		ret |= checkIntegerOption(GameOptions.DEMAND_PROBABILITY, GameOptions.GAMEOPTIONS_MAP, 10);</span>
<span class="fc" id="L2809">		ret |= checkBooleanOption(GameOptions.EMPTY_TRADERS, GameOptions.GAMEOPTIONS_MAP, false);</span>
		// end @compat 0.10.5

		// SAVEGAME_VERSION == 13

		// @compat 0.10.7
<span class="fc" id="L2815">		ret |= checkBooleanOption(GameOptions.ONLY_NATURAL_IMPROVEMENTS, GameOptions.GAMEOPTIONS_COLONY, true);</span>
<span class="fc" id="L2816">		ret |= checkIntegerOption(GameOptions.PEACE_PROBABILITY, GameOptions.GAMEOPTIONS_MAP, 90);</span>
<span class="fc" id="L2817">		ret |= checkIntegerOption(GameOptions.INITIAL_IMMIGRATION, GameOptions.GAMEOPTIONS_MAP, 15);</span>
<span class="fc" id="L2818">		ret |= checkIntegerOption(GameOptions.EUROPEAN_UNIT_IMMIGRATION_PENALTY, GameOptions.GAMEOPTIONS_MAP, -4);</span>
<span class="fc" id="L2819">		ret |= checkIntegerOption(GameOptions.PLAYER_IMMIGRATION_BONUS, GameOptions.GAMEOPTIONS_MAP, 2);</span>
<span class="fc" id="L2820">		ret |= checkBooleanOption(GameOptions.FOUND_COLONY_DURING_REBELLION, GameOptions.GAMEOPTIONS_COLONY, true);</span>
		// end @compat 0.10.7

		// @compat 0.11.0
<span class="fc" id="L2824">		ret |= checkBooleanOption(GameOptions.BELL_ACCUMULATION_CAPPED, GameOptions.GAMEOPTIONS_COLONY, false);</span>
<span class="fc" id="L2825">		ret |= checkBooleanOption(GameOptions.CAPTURE_UNITS_UNDER_REPAIR, GameOptions.GAMEOPTIONS_COLONY, false);</span>
<span class="fc" id="L2826">		ret |= checkBooleanOption(GameOptions.PAY_FOR_BUILDING, GameOptions.GAMEOPTIONS_COLONY, true);</span>
<span class="fc" id="L2827">		ret |= checkBooleanOption(GameOptions.CLEAR_HAMMERS_ON_CONSTRUCTION_SWITCH, GameOptions.GAMEOPTIONS_COLONY,</span>
				false);
<span class="fc" id="L2829">		ret |= checkBooleanOption(GameOptions.CUSTOMS_ON_COAST, GameOptions.GAMEOPTIONS_COLONY, false);</span>
<span class="fc" id="L2830">		ret |= checkBooleanOption(GameOptions.EQUIP_EUROPEAN_RECRUITS, GameOptions.GAMEOPTIONS_COLONY, true);</span>
		// end @compat 0.11.0

		// @compat 0.11.3
<span class="fc" id="L2834">		ret |= checkIntegerOption(GameOptions.MISSION_INFLUENCE, GameOptions.GAMEOPTIONS_MAP, -10);</span>
<span class="fc" id="L2835">		ret |= checkIntegerOption(GameOptions.INDEPENDENCE_TURN, GameOptions.GAMEOPTIONS_YEARS, 468);</span>
<span class="fc" id="L2836">		ret |= checkTextOption(GameOptions.AGES, GameOptions.GAMEOPTIONS_YEARS, &quot;1600,1700&quot;);</span>
<span class="fc" id="L2837">		ret |= checkIntegerOption(GameOptions.SEASONS, GameOptions.GAMEOPTIONS_YEARS, 2);</span>
<span class="fc" id="L2838">		ret |= checkBooleanOption(GameOptions.DISEMBARK_IN_COLONY, GameOptions.GAMEOPTIONS_COLONY, false);</span>
		// end @compat 0.11.3

<span class="fc" id="L2841">		return ret;</span>
	}

	/**
	 * Backward compatibility code to make sure this specification contains a
	 * default value for every map option.
	 *
	 * When a new map option is added to the spec, add a sensible default here.
	 *
	 * @return True if an option was missing and added.
	 */
	public boolean fixMapGeneratorOptions() {
<span class="fc" id="L2853">		boolean ret = false;</span>
		// SAVEGAME_VERSION == 11

		// @compat 0.10.0
<span class="fc" id="L2857">		ret |= checkIntegerOption(MapGeneratorOptions.MINIMUM_LATITUDE,</span>
				MapGeneratorOptions.MAPGENERATOROPTIONS_TERRAIN_GENERATOR, -90);
<span class="fc" id="L2859">		ret |= checkIntegerOption(MapGeneratorOptions.MAXIMUM_LATITUDE,</span>
				MapGeneratorOptions.MAPGENERATOROPTIONS_TERRAIN_GENERATOR, 90);
		// end @compat 0.10.0

		// SAVEGAME_VERSION == 12
		// SAVEGAME_VERSION == 13

<span class="fc" id="L2866">		return ret;</span>
	}

	/**
	 * Check option group.
	 *
	 * @param id
	 *            the id
	 * @return true, if successful
	 */
	private boolean checkOptionGroup(String id) {
<span class="pc bpc" id="L2877" title="1 of 2 branches missed.">		if (allOptionGroups.containsKey(id))</span>
<span class="fc" id="L2878">			return false;</span>
<span class="nc" id="L2879">		OptionGroup og = new OptionGroup(id, this);</span>
<span class="nc" id="L2880">		allOptionGroups.put(id, og);</span>
<span class="nc" id="L2881">		return true;</span>
	}

	/**
	 * Check boolean option.
	 *
	 * @param id
	 *            the id
	 * @param gr
	 *            the gr
	 * @param defaultValue
	 *            the default value
	 * @return true, if successful
	 */
	private boolean checkBooleanOption(String id, String gr, boolean defaultValue) {
<span class="pc bpc" id="L2896" title="1 of 2 branches missed.">		if (hasOption(id))</span>
<span class="fc" id="L2897">			return false;</span>
<span class="nc" id="L2898">		BooleanOption op = new BooleanOption(id, this);</span>
<span class="nc" id="L2899">		op.setGroup(gr);</span>
<span class="nc" id="L2900">		op.setValue(defaultValue);</span>
<span class="nc" id="L2901">		return checkOption(op);</span>
	}

	/**
	 * Check integer option.
	 *
	 * @param id
	 *            the id
	 * @param gr
	 *            the gr
	 * @param defaultValue
	 *            the default value
	 * @return true, if successful
	 */
	private boolean checkIntegerOption(String id, String gr, int defaultValue) {
<span class="pc bpc" id="L2916" title="1 of 2 branches missed.">		if (hasOption(id))</span>
<span class="fc" id="L2917">			return false;</span>
<span class="nc" id="L2918">		IntegerOption op = new IntegerOption(id, this);</span>
<span class="nc" id="L2919">		op.setGroup(gr);</span>
<span class="nc" id="L2920">		op.setValue(defaultValue);</span>
<span class="nc" id="L2921">		return checkOption(op);</span>
	}

	/**
	 * Check string option.
	 *
	 * @param id
	 *            the id
	 * @param gr
	 *            the gr
	 * @param defaultValue
	 *            the default value
	 * @return true, if successful
	 */
	private boolean checkStringOption(String id, String gr, String defaultValue) {
<span class="nc bnc" id="L2936" title="All 2 branches missed.">		if (hasOption(id))</span>
<span class="nc" id="L2937">			return false;</span>
<span class="nc" id="L2938">		StringOption op = new StringOption(id, this);</span>
<span class="nc" id="L2939">		op.setGroup(gr);</span>
<span class="nc" id="L2940">		op.setValue(defaultValue);</span>
<span class="nc" id="L2941">		return checkOption(op);</span>
	}

	/**
	 * Check text option.
	 *
	 * @param id
	 *            the id
	 * @param gr
	 *            the gr
	 * @param defaultValue
	 *            the default value
	 * @return true, if successful
	 */
	private boolean checkTextOption(String id, String gr, String defaultValue) {
<span class="pc bpc" id="L2956" title="1 of 2 branches missed.">		if (hasOption(id))</span>
<span class="fc" id="L2957">			return false;</span>
<span class="nc" id="L2958">		TextOption op = new TextOption(id, this);</span>
<span class="nc" id="L2959">		op.setGroup(gr);</span>
<span class="nc" id="L2960">		op.setValue(defaultValue);</span>
<span class="nc" id="L2961">		return checkOption(op);</span>
	}

	/**
	 * Check option.
	 *
	 * @param option
	 *            the option
	 * @return true, if successful
	 */
	private boolean checkOption(AbstractOption option) {
<span class="nc" id="L2972">		getOptionGroup(option.getGroup()).add(option);</span>
<span class="nc" id="L2973">		addAbstractOption(option);</span>
<span class="nc" id="L2974">		return true;</span>
	}

	// Serialization

	/** The Constant BUILDING_TYPES_TAG. */
	private static final String BUILDING_TYPES_TAG = &quot;building-types&quot;;

	/** The Constant DIFFICULTY_LEVEL_TAG. */
	private static final String DIFFICULTY_LEVEL_TAG = &quot;difficulty-level&quot;;

	/** The Constant DISASTERS_TAG. */
	private static final String DISASTERS_TAG = &quot;disasters&quot;;

	/** The Constant EUROPEAN_NATION_TYPES_TAG. */
	private static final String EUROPEAN_NATION_TYPES_TAG = &quot;european-nation-types&quot;;

	/** The Constant EVENTS_TAG. */
	private static final String EVENTS_TAG = &quot;events&quot;;

	/** The Constant FOUNDING_FATHERS_TAG. */
	private static final String FOUNDING_FATHERS_TAG = &quot;founding-fathers&quot;;

	/** The Constant GOODS_TYPES_TAG. */
	private static final String GOODS_TYPES_TAG = &quot;goods-types&quot;;

	/** The Constant INDIAN_NATION_TYPES_TAG. */
	private static final String INDIAN_NATION_TYPES_TAG = &quot;indian-nation-types&quot;;

	/** The Constant MODIFIERS_TAG. */
	private static final String MODIFIERS_TAG = &quot;modifiers&quot;;

	/** The Constant NATIONS_TAG. */
	private static final String NATIONS_TAG = &quot;nations&quot;;

	/** The Constant OPTIONS_TAG. */
	private static final String OPTIONS_TAG = &quot;options&quot;;

	/** The Constant RESOURCE_TYPES_TAG. */
	private static final String RESOURCE_TYPES_TAG = &quot;resource-types&quot;;

	/** The Constant ROLES_TAG. */
	private static final String ROLES_TAG = &quot;roles&quot;;

	/** The Constant TILE_TYPES_TAG. */
	private static final String TILE_TYPES_TAG = &quot;tile-types&quot;;

	/** The Constant TILE_IMPROVEMENT_TYPES_TAG. */
	private static final String TILE_IMPROVEMENT_TYPES_TAG = &quot;tile-improvement-types&quot;;

	/** The Constant UNIT_TYPES_TAG. */
	private static final String UNIT_TYPES_TAG = &quot;unit-types&quot;;

	/** The Constant VERSION_TAG. */
	private static final String VERSION_TAG = &quot;version&quot;;

	/** The Constant EQUIPMENT_TYPES_TAG. */
	// @compat 0.10.x
	private static final String EQUIPMENT_TYPES_TAG = &quot;equipment-types&quot;;
	// end @compat 0.10.x
	/** The Constant OLD_DIFFICULTY_LEVEL_TAG. */
	// @compat 0.11.3
	private static final String OLD_DIFFICULTY_LEVEL_TAG = &quot;difficultyLevel&quot;;

	/** The Constant OLD_TILEIMPROVEMENT_TYPES_TAG. */
	private static final String OLD_TILEIMPROVEMENT_TYPES_TAG = &quot;tileimprovement-types&quot;;
	// end @compat 0.11.3

	/**
	 * Write an XML-representation of this object to the given stream.
	 *
	 * @param xw
	 *            The &lt;code&gt;FreeColXMLWriter&lt;/code&gt; to write to.
	 * @exception XMLStreamException
	 *                if there are any problems writing to the stream.
	 */
	protected void toXML(FreeColXMLWriter xw) throws XMLStreamException {
		// Start element
<span class="fc" id="L3052">		xw.writeStartElement(getXMLElementTagName());</span>

		// Add attributes
<span class="fc" id="L3055">		xw.writeAttribute(FreeColObject.ID_ATTRIBUTE_TAG, getId());</span>
<span class="pc bpc" id="L3056" title="1 of 2 branches missed.">		if (difficultyLevel != null) {</span>
<span class="fc" id="L3057">			xw.writeAttribute(DIFFICULTY_LEVEL_TAG, difficultyLevel);</span>
		}
<span class="pc bpc" id="L3059" title="1 of 2 branches missed.">		if (version != null) {</span>
<span class="fc" id="L3060">			xw.writeAttribute(VERSION_TAG, version);</span>
		}

		// copy the order of section in specification.xml
<span class="fc" id="L3064">		writeSection(xw, MODIFIERS_TAG, specialModifiers);</span>
<span class="fc" id="L3065">		writeSection(xw, EVENTS_TAG, events);</span>
<span class="fc" id="L3066">		writeSection(xw, DISASTERS_TAG, disasters);</span>
<span class="fc" id="L3067">		writeSection(xw, GOODS_TYPES_TAG, goodsTypeList);</span>
<span class="fc" id="L3068">		writeSection(xw, RESOURCE_TYPES_TAG, resourceTypeList);</span>
<span class="fc" id="L3069">		writeSection(xw, TILE_TYPES_TAG, tileTypeList);</span>
<span class="fc" id="L3070">		writeSection(xw, ROLES_TAG, roles);</span>
<span class="fc" id="L3071">		writeSection(xw, TILE_IMPROVEMENT_TYPES_TAG, tileImprovementTypeList);</span>
<span class="fc" id="L3072">		writeSection(xw, UNIT_TYPES_TAG, unitTypeList);</span>
<span class="fc" id="L3073">		writeSection(xw, BUILDING_TYPES_TAG, buildingTypeList);</span>
<span class="fc" id="L3074">		writeSection(xw, FOUNDING_FATHERS_TAG, foundingFathers);</span>
<span class="fc" id="L3075">		writeSection(xw, EUROPEAN_NATION_TYPES_TAG, europeanNationTypes);</span>
<span class="fc" id="L3076">		writeSection(xw, EUROPEAN_NATION_TYPES_TAG, REFNationTypes);</span>
<span class="fc" id="L3077">		writeSection(xw, INDIAN_NATION_TYPES_TAG, indianNationTypes);</span>
<span class="fc" id="L3078">		writeSection(xw, NATIONS_TAG, nations);</span>

		// option tree has been flattened
<span class="fc" id="L3081">		xw.writeStartElement(OPTIONS_TAG);</span>
<span class="fc bfc" id="L3082" title="All 2 branches covered.">		for (OptionGroup item : allOptionGroups.values()) {</span>
<span class="fc bfc" id="L3083" title="All 2 branches covered.">			if (item.getGroup().isEmpty())</span>
<span class="fc" id="L3084">				item.toXML(xw);</span>
<span class="fc" id="L3085">		}</span>
<span class="fc" id="L3086">		xw.writeEndElement();</span>

		// End element
<span class="fc" id="L3089">		xw.writeEndElement();</span>

<span class="fc" id="L3091">	}</span>

	/**
	 * Write section.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param xw
	 *            the xw
	 * @param section
	 *            the section
	 * @param items
	 *            the items
	 * @throws XMLStreamException
	 *             the XML stream exception
	 */
	private &lt;T extends FreeColObject&gt; void writeSection(FreeColXMLWriter xw, String section, Collection&lt;T&gt; items)
			throws XMLStreamException {
<span class="fc" id="L3109">		xw.writeStartElement(section);</span>

<span class="fc bfc" id="L3111" title="All 2 branches covered.">		for (T item : items)</span>
<span class="fc" id="L3112">			item.toXML(xw);</span>

<span class="fc" id="L3114">		xw.writeEndElement();</span>
<span class="fc" id="L3115">	}</span>

	/**
	 * Initializes this object from its XML-representation.
	 *
	 * @param xr
	 *            The &lt;code&gt;FreeColXMLReader&lt;/code&gt; to read from.
	 * @exception XMLStreamException
	 *                if there are any problems reading the stream.
	 */
	public void readFromXML(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L3126">		String newId = xr.readId();</span>
<span class="fc bfc" id="L3127" title="All 2 branches covered.">		if (id == null)</span>
<span class="fc" id="L3128">			id = newId; // don't overwrite id with parent id!</span>

<span class="pc bpc" id="L3130" title="1 of 2 branches missed.">		if (difficultyLevel == null) {</span>
<span class="fc" id="L3131">			difficultyLevel = xr.getAttribute(DIFFICULTY_LEVEL_TAG, (String) null);</span>
			// @compat 0.11.3
<span class="fc bfc" id="L3133" title="All 2 branches covered.">			if (difficultyLevel == null) {</span>
<span class="fc" id="L3134">				difficultyLevel = xr.getAttribute(OLD_DIFFICULTY_LEVEL_TAG, (String) null);</span>
			}
			// end @compat 0.11.3
		}

<span class="fc" id="L3139">		version = xr.getAttribute(VERSION_TAG, (String) null);</span>

<span class="fc" id="L3141">		logger.fine(&quot;Reading specification &quot; + newId + &quot; difficulty=&quot; + difficultyLevel + &quot; version=&quot; + version);</span>

<span class="fc" id="L3143">		String parentId = xr.getAttribute(FreeColGameObjectType.EXTENDS_TAG, (String) null);</span>
<span class="fc bfc" id="L3144" title="All 2 branches covered.">		if (parentId != null) {</span>
			try {
<span class="fc" id="L3146">				FreeColTcFile parent = new FreeColTcFile(parentId);</span>
<span class="fc" id="L3147">				load(parent.getSpecificationInputStream());</span>
<span class="fc" id="L3148">				initialized = false;</span>
<span class="nc" id="L3149">			} catch (IOException e) {</span>
<span class="nc" id="L3150">				throw new XMLStreamException(&quot;Failed to open parent specification: &quot;, e);</span>
<span class="fc" id="L3151">			}</span>
		}

<span class="fc bfc" id="L3154" title="All 2 branches covered.">		while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L3155">			String childName = xr.getLocalName();</span>
			// @compat 0.10.x
			// Ideally we would handle role backward compatibility in
			// the type reader triggered by the &quot;roles&quot; section of the
			// spec. Alas, specs pre-0.10.6 had no roles section.
			// The next section after roles in modern specs is
			// &quot;equipment-types&quot;, which is also the first place roles
			// are referred to directly, and better still is completely
			// replaced by roles in 0.11.x. So this is the last chance
			// to fix any role omissions.
<span class="fc bfc" id="L3165" title="All 2 branches covered.">			if (&quot;equipment-types&quot;.equals(childName))</span>
<span class="fc" id="L3166">				fixRoles();</span>
			// end @compat 0.10.x
<span class="fc" id="L3168">			ChildReader reader = readerMap.get(childName);</span>
<span class="pc bpc" id="L3169" title="1 of 2 branches missed.">			if (reader == null) {</span>
<span class="nc" id="L3170">				logger.warning(&quot;No reader found for: &quot; + childName);</span>
			} else {
<span class="fc" id="L3172">				reader.readChildren(xr);</span>
			}
<span class="fc" id="L3174">		}</span>
<span class="fc" id="L3175">	}</span>

	/**
	 * Gets the tag name of the root element representing this object.
	 *
	 * @return &quot;freecol-specification&quot;.
	 */
	public static String getXMLElementTagName() {
<span class="fc" id="L3183">		return &quot;freecol-specification&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>