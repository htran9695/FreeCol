<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Specification.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.common.model</a> &gt; <span class="el_source">Specification.java</span></div><h1>Specification.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.common.model;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.reflect.Constructor;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.function.Predicate;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.io.FreeColDirectories;
import net.sf.freecol.common.io.FreeColModFile;
import net.sf.freecol.common.io.FreeColTcFile;
import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.io.FreeColXMLWriter;
import net.sf.freecol.common.model.NationOptions.Advantages;
import net.sf.freecol.common.option.AbstractOption;
import net.sf.freecol.common.option.AbstractUnitOption;
import net.sf.freecol.common.option.BooleanOption;
import net.sf.freecol.common.option.IntegerOption;
import net.sf.freecol.common.option.MapGeneratorOptions;
import net.sf.freecol.common.option.Option;
import net.sf.freecol.common.option.OptionGroup;
import net.sf.freecol.common.option.RangeOption;
import net.sf.freecol.common.option.StringOption;
import net.sf.freecol.common.option.TextOption;
import net.sf.freecol.common.option.UnitListOption;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.StringUtils.*;


/**
 * This class encapsulates any parts of the &quot;specification&quot; for
 * FreeCol that are expressed best using XML.  The XML is loaded
 * through the class loader from the resource named
 * &quot;specification.xml&quot; in the same package as this class.
 */
public final class Specification {

<span class="fc" id="L74">    private static final Logger logger = Logger.getLogger(Specification.class.getName());</span>

    /** The difficulty levels option group is special. */
    private static final String DIFFICULTY_LEVELS = &quot;difficultyLevels&quot;;

    /** Roles backward compatibility fragment. */
    public static final String ROLES_COMPAT_FILE_NAME = &quot;roles-compat.xml&quot;;

    /** The default role. */
    public static final String DEFAULT_ROLE_ID = &quot;model.role.default&quot;;

    /** How many game ages. */
    public static final int NUMBER_OF_AGES = 3;


    public static class Source extends FreeColGameObjectType {

        /**
         * Trivial constructor.
         *
         * @param id The object identifier.
         */
        public Source(String id) {
<span class="fc" id="L97">            super(id);</span>
<span class="fc" id="L98">        }</span>

        /**
         * {@inheritDoc}
         */
        @Override
        public void toXML(FreeColXMLWriter xw) {
<span class="nc" id="L105">            throw new RuntimeException(&quot;Can not happen&quot;);</span>
        }

        /**
         * {@inheritDoc}
         */
        @Override
        public String toString() {
<span class="nc" id="L113">            return getId();</span>
        }

        /**
         * {@inheritDoc}
         */
        @Override
<span class="nc" id="L120">        public String getXMLTagName() { return &quot;source&quot;; }</span>
    };

<span class="fc" id="L123">    public static final Source AMBUSH_BONUS_SOURCE</span>
        = new Source(&quot;model.source.ambushBonus&quot;);
<span class="fc" id="L125">    public static final Source AMPHIBIOUS_ATTACK_PENALTY_SOURCE</span>
        = new Source(&quot;model.source.amphibiousAttack&quot;);
<span class="fc" id="L127">    public static final Source ARTILLERY_PENALTY_SOURCE</span>
        = new Source(&quot;model.source.artilleryInTheOpen&quot;);
<span class="fc" id="L129">    public static final Source ATTACK_BONUS_SOURCE</span>
        = new Source(&quot;model.source.attackBonus&quot;);
<span class="fc" id="L131">    public static final Source BASE_DEFENCE_SOURCE</span>
        = new Source(&quot;model.source.baseDefence&quot;);
<span class="fc" id="L133">    public static final Source BASE_OFFENCE_SOURCE</span>
        = new Source(&quot;model.source.baseOffence&quot;);
<span class="fc" id="L135">    public static final Source CARGO_PENALTY_SOURCE</span>
        = new Source(&quot;model.source.cargoPenalty&quot;);
<span class="fc" id="L137">    public static final Source COLONY_GOODS_PARTY_SOURCE</span>
        = new Source(&quot;model.source.colonyGoodsParty&quot;);
<span class="fc" id="L139">    public static final Source FORTIFICATION_BONUS_SOURCE</span>
        = new Source(&quot;model.source.fortified&quot;);
<span class="fc" id="L141">    public static final Source INDIAN_RAID_BONUS_SOURCE</span>
        = new Source(&quot;model.source.artilleryAgainstRaid&quot;);
<span class="fc" id="L143">    public static final Source MOVEMENT_PENALTY_SOURCE</span>
        = new Source(&quot;model.source.movementPenalty&quot;);
<span class="fc" id="L145">    public static final Source SHIP_TRADE_PENALTY_SOURCE</span>
        = new Source(&quot;model.source.shipTradePenalty&quot;);
<span class="fc" id="L147">    public static final Source SOL_MODIFIER_SOURCE</span>
        = new Source(&quot;model.source.solModifier&quot;);
    /** All the special static sources. */
<span class="fc" id="L150">    private static final Source[] sources = new Source[] {</span>
        MOVEMENT_PENALTY_SOURCE,
        ARTILLERY_PENALTY_SOURCE,
        ATTACK_BONUS_SOURCE,
        FORTIFICATION_BONUS_SOURCE,
        INDIAN_RAID_BONUS_SOURCE,
        AMPHIBIOUS_ATTACK_PENALTY_SOURCE,
        BASE_OFFENCE_SOURCE,
        BASE_DEFENCE_SOURCE,
        CARGO_PENALTY_SOURCE,
        AMBUSH_BONUS_SOURCE,
        COLONY_GOODS_PARTY_SOURCE,
        SHIP_TRADE_PENALTY_SOURCE,
        SOL_MODIFIER_SOURCE
    };


    /** A map from specification element to a reader for that element. */
<span class="fc" id="L168">    private final Map&lt;String, ChildReader&gt; readerMap = new HashMap&lt;&gt;();</span>

    /* Containers filled from readers in the readerMap. */

    // readerMap(&quot;building-types&quot;)
<span class="fc" id="L173">    private final List&lt;BuildingType&gt; buildingTypeList = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;disasters&quot;)
<span class="fc" id="L175">    private final List&lt;Disaster&gt; disasters = new ArrayList&lt;&gt;();</span>
    // @compat 0.10.x readerMap(&quot;equipment-types&quot;)
<span class="fc" id="L177">    private final List&lt;EquipmentType&gt; equipmentTypes = new ArrayList&lt;&gt;();</span>
    // end @compat 0.10.x
    // readerMap(&quot;european-nation-types&quot;)
<span class="fc" id="L180">    private final List&lt;EuropeanNationType&gt; europeanNationTypes = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;events&quot;)
<span class="fc" id="L182">    private final List&lt;Event&gt; events = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;founding-fathers&quot;)
<span class="fc" id="L184">    private final List&lt;FoundingFather&gt; foundingFathers = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;goods-types&quot;)
<span class="fc" id="L186">    private final List&lt;GoodsType&gt; goodsTypeList = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;indian-nation-types&quot;)
<span class="fc" id="L188">    private final List&lt;IndianNationType&gt; indianNationTypes = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;nations&quot;)
<span class="fc" id="L190">    private final List&lt;Nation&gt; nations = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;resource-types&quot;)
<span class="fc" id="L192">    private final List&lt;ResourceType&gt; resourceTypeList = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;roles&quot;)
<span class="fc" id="L194">    private final List&lt;Role&gt; roles = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;tile-types&quot;)
<span class="fc" id="L196">    private final List&lt;TileType&gt; tileTypeList = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;tile-improvement-types&quot;)
<span class="fc" id="L198">    private final List&lt;TileImprovementType&gt; tileImprovementTypeList = new ArrayList&lt;&gt;();</span>
    // readerMap(&quot;unit-types&quot;)
<span class="fc" id="L200">    private final List&lt;UnitType&gt; unitTypeList = new ArrayList&lt;&gt;();</span>

    // readerMap(&quot;modifiers&quot;)
<span class="fc" id="L203">    private final Map&lt;String, List&lt;Modifier&gt;&gt; allModifiers = new HashMap&lt;&gt;();</span>
<span class="fc" id="L204">    private final List&lt;Modifier&gt; specialModifiers = new ArrayList&lt;&gt;();</span>

    // readerMap(&quot;options&quot;)
<span class="fc" id="L207">    private final Map&lt;String, AbstractOption&gt; allOptions = new HashMap&lt;&gt;();</span>
<span class="fc" id="L208">    private final Map&lt;String, OptionGroup&gt; allOptionGroups = new HashMap&lt;&gt;();</span>

    /* Containers derived from readerMap containers */

    // Derived from readerMap container: goodsTypeList
<span class="fc" id="L213">    private final List&lt;GoodsType&gt; storableGoodsTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L214">    private final List&lt;GoodsType&gt; farmedGoodsTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L215">    private final List&lt;GoodsType&gt; foodGoodsTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L216">    private final List&lt;GoodsType&gt; newWorldGoodsTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L217">    private final List&lt;GoodsType&gt; newWorldLuxuryGoodsTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L218">    private final List&lt;GoodsType&gt; libertyGoodsTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L219">    private final List&lt;GoodsType&gt; immigrationGoodsTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L220">    private final List&lt;GoodsType&gt; rawBuildingGoodsTypeList = new ArrayList&lt;&gt;();</span>

    // Derived from readerMap container: nations
<span class="fc" id="L223">    private final List&lt;Nation&gt; europeanNations = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L224">    private final List&lt;Nation&gt; REFNations = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L225">    private final List&lt;Nation&gt; indianNations = new ArrayList&lt;&gt;();</span>
    // Derived from readerMap containers: indianNationTypes europeanNationTypes
<span class="fc" id="L227">    private final List&lt;NationType&gt; nationTypes = new ArrayList&lt;&gt;();</span>
    // Derived from readerMap container: europeanNationTypes
<span class="fc" id="L229">    private final List&lt;EuropeanNationType&gt; REFNationTypes = new ArrayList&lt;&gt;();</span>

    // Derived from readerMap container: unitTypeList
<span class="fc" id="L232">    private final ArrayList&lt;UnitType&gt; buildableUnitTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L233">    private final Map&lt;GoodsType, UnitType&gt; experts = new HashMap&lt;&gt;();</span>
<span class="fc" id="L234">    private final List&lt;UnitType&gt; unitTypesTrainedInEurope = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L235">    private final List&lt;UnitType&gt; unitTypesPurchasedInEurope = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L236">    private UnitType fastestLandUnitType = null;</span>
<span class="fc" id="L237">    private UnitType fastestNavalUnitType = null;</span>
<span class="fc" id="L238">    private final List&lt;UnitType&gt; defaultUnitTypes = new ArrayList&lt;&gt;();</span>

    /* Other containers. */

    // @compat 0.10.7
<span class="fc" id="L243">    public final Map&lt;String, String&gt; fatherGoodsFixMap = new HashMap&lt;&gt;();</span>
    // end @compat 0.10.7

<span class="fc" id="L246">    private final Map&lt;String, FreeColGameObjectType&gt; allTypes = new HashMap&lt;&gt;();</span>

<span class="fc" id="L248">    private final Map&lt;String, List&lt;Ability&gt;&gt; allAbilities = new HashMap&lt;&gt;();</span>

    /** A cache of the military roles in decreasing order.  Do not serialize. */
<span class="fc" id="L251">    private List&lt;Role&gt; militaryRoles = null;</span>

<span class="fc" id="L253">    private boolean initialized = false;</span>

    /** The specification identifier. */
    private String id;

    /** The specification version. */
    private String version;

    /** The name of the difficulty level option group. */
<span class="fc" id="L262">    private String difficultyLevel = null;</span>

    /** The turn number for the game ages for FF recruitment. */
<span class="fc" id="L265">    private final int[] ages = new int[NUMBER_OF_AGES];</span>


    /**
     * Creates a new Specification object.
     */
<span class="fc" id="L271">    public Specification() {</span>
<span class="fc" id="L272">        logger.fine(&quot;Initializing Specification&quot;);</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">        for (Source source : sources) allTypes.put(source.getId(), source);</span>

<span class="fc" id="L275">        readerMap.put(BUILDING_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(BuildingType.class, buildingTypeList));
<span class="fc" id="L277">        readerMap.put(DISASTERS_TAG,</span>
                      new TypeReader&lt;&gt;(Disaster.class, disasters));
        // @compat 0.10.x
<span class="fc" id="L280">        readerMap.put(EQUIPMENT_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(EquipmentType.class, equipmentTypes));
        // end @compat 0.10.x
<span class="fc" id="L283">        readerMap.put(EUROPEAN_NATION_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(EuropeanNationType.class, europeanNationTypes));
<span class="fc" id="L285">        readerMap.put(EVENTS_TAG,</span>
                      new TypeReader&lt;&gt;(Event.class, events));
<span class="fc" id="L287">        readerMap.put(FOUNDING_FATHERS_TAG,</span>
                      new TypeReader&lt;&gt;(FoundingFather.class, foundingFathers));
<span class="fc" id="L289">        readerMap.put(GOODS_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(GoodsType.class, goodsTypeList));
<span class="fc" id="L291">        readerMap.put(INDIAN_NATION_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(IndianNationType.class, indianNationTypes));
<span class="fc" id="L293">        readerMap.put(NATIONS_TAG,</span>
                      new TypeReader&lt;&gt;(Nation.class, nations));
<span class="fc" id="L295">        readerMap.put(RESOURCE_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(ResourceType.class, resourceTypeList));
<span class="fc" id="L297">        readerMap.put(ROLES_TAG,</span>
                      new TypeReader&lt;&gt;(Role.class, roles));
<span class="fc" id="L299">        readerMap.put(TILE_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(TileType.class, tileTypeList));
<span class="fc" id="L301">        readerMap.put(TILE_IMPROVEMENT_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(TileImprovementType.class, tileImprovementTypeList));
        // @compat 0.11.3
<span class="fc" id="L304">        readerMap.put(OLD_TILEIMPROVEMENT_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(TileImprovementType.class, tileImprovementTypeList));
        // end @compat 0.11.3
<span class="fc" id="L307">        readerMap.put(UNIT_TYPES_TAG,</span>
                      new TypeReader&lt;&gt;(UnitType.class, unitTypeList));

<span class="fc" id="L310">        readerMap.put(MODIFIERS_TAG, new ModifierReader());</span>
<span class="fc" id="L311">        readerMap.put(OPTIONS_TAG, new OptionReader());</span>
<span class="fc" id="L312">    }</span>


    /**
     * Creates a new Specification object by loading it from the
     * given &lt;code&gt;FreeColXMLReader&lt;/code&gt;.
     *
     * @param xr The &lt;code&gt;FreeColXMLReader&lt;/code&gt; to read from.
     */
    public Specification(FreeColXMLReader xr) {
<span class="fc" id="L322">        this();</span>
<span class="fc" id="L323">        initialized = false;</span>
<span class="fc" id="L324">        load(xr);</span>
<span class="fc" id="L325">        prepare(null, difficultyLevel);</span>
<span class="fc" id="L326">        clean(&quot;load from stream&quot;);</span>
<span class="fc" id="L327">        initialized = true;</span>
<span class="fc" id="L328">    }</span>


    /**
     * Load a specification or fragment from a stream.
     *
     * @param xr The &lt;code&gt;FreeColXMLReader&lt;/code&gt; to read from.
     */
    private void load(FreeColXMLReader xr) {
        try {
<span class="fc" id="L338">            readFromXML(xr);</span>
<span class="nc" id="L339">        } catch (Exception e) {</span>
<span class="nc" id="L340">            throw new RuntimeException(&quot;Error parsing specification&quot;, e);</span>
<span class="fc" id="L341">        }</span>
<span class="fc" id="L342">    }</span>

    /**
     * Creates a new Specification object by loading it from the
     * given &lt;code&gt;InputStream&lt;/code&gt;.
     *
     * @param in The &lt;code&gt;InputStream&lt;/code&gt; to read from.
     */
    public Specification(InputStream in) {
<span class="fc" id="L351">        this();</span>
<span class="fc" id="L352">        initialized = false;</span>
<span class="fc" id="L353">        load(in);</span>
<span class="fc" id="L354">        prepare(null, difficultyLevel);</span>
<span class="fc" id="L355">        clean(&quot;load from InputStream&quot;);</span>
<span class="fc" id="L356">        initialized = true;</span>
<span class="fc" id="L357">    }</span>

    /**
     * Load a specification or fragment from a stream.
     *
     * @param in The &lt;code&gt;InputStream&lt;/code&gt; to read from.
     */
    private void load(InputStream in) {
<span class="pc" id="L365">        try (</span>
<span class="fc" id="L366">            FreeColXMLReader xr = new FreeColXMLReader(in);</span>
        ) {
<span class="fc" id="L368">            xr.nextTag();</span>
<span class="fc" id="L369">            load(xr);</span>
<span class="pc bpc" id="L370" title="6 of 8 branches missed.">        } catch (Exception e) {</span>
<span class="nc" id="L371">            throw new RuntimeException(&quot;Load specification stream error&quot;, e);</span>
<span class="fc" id="L372">        }</span>
<span class="fc" id="L373">    }</span>

    /**
     * Prepare a specification with given advantages and difficulty level.
     *
     * @param advantages An optional &lt;code&gt;Advantages&lt;/code&gt; setting.
     * @param difficulty An optional identifier for the difficulty level.
     */
    public void prepare(Advantages advantages, String difficulty) {
<span class="fc bfc" id="L382" title="All 2 branches covered.">        prepare(advantages, (difficulty == null) ? null</span>
<span class="fc" id="L383">            : getDifficultyOptionGroup(difficulty));</span>
<span class="fc" id="L384">    }</span>

    /**
     * Prepare a specification with given advantages and difficulty level.
     *
     * @param advantages An optional &lt;code&gt;Advantages&lt;/code&gt; setting.
     * @param difficulty An optional difficulty level &lt;code&gt;OptionGroup&lt;/code&gt;.
     */
    public void prepare(Advantages advantages, OptionGroup difficulty) {
<span class="fc" id="L393">        applyFixes();</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">        if (advantages == Advantages.NONE) {</span>
<span class="nc" id="L395">            clearEuropeanNationalAdvantages();</span>
        }
<span class="fc bfc" id="L397" title="All 2 branches covered.">        if (difficulty != null) {</span>
<span class="fc" id="L398">            allOptionGroups.put(difficulty.getId(), difficulty);</span>
<span class="fc" id="L399">            applyDifficultyLevel(difficulty);</span>
        }
<span class="fc" id="L401">    }</span>

    /**
     * Load mods into this specification.
     *
     * @param mods A list of &lt;code&gt;FreeColModFile&lt;/code&gt;s for the active mods.
     * @return True if any mod was loaded.
     */
    public boolean loadMods(List&lt;FreeColModFile&gt; mods) {
<span class="fc" id="L410">        initialized = false;</span>
<span class="fc" id="L411">        boolean loadedMod = false;</span>
<span class="fc bfc" id="L412" title="All 2 branches covered.">        for (FreeColModFile mod : mods) {</span>
<span class="fc" id="L413">            InputStream sis = null;</span>
            try {
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">                if ((sis = mod.getSpecificationInputStream()) != null) {</span>
                    // Some mods are resource only
<span class="fc" id="L417">                    load(sis);</span>
                }
<span class="fc" id="L419">                loadedMod = true;</span>
<span class="fc" id="L420">                logger.info(&quot;Loaded mod &quot; + mod.getId());</span>
<span class="nc" id="L421">            } catch (IOException ioe) {</span>
<span class="nc" id="L422">                logger.log(Level.WARNING, &quot;Read error in mod &quot; + mod.getId(),</span>
                    ioe);
<span class="nc" id="L424">            } catch (RuntimeException rte) {</span>
<span class="nc" id="L425">                logger.log(Level.WARNING, &quot;Parse error in mod &quot; + mod.getId(),</span>
                    rte);
<span class="pc" id="L427">            }</span>
<span class="fc" id="L428">        }</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">        if (loadedMod) clean(&quot;mod loading&quot;);</span>
<span class="fc" id="L430">        initialized = true;</span>
<span class="fc" id="L431">        return loadedMod;</span>
    }

    /**
     * Load a limited set of options from a file.
     *
     * Useful to load the user game and map generator options before
     * starting a new game.
     *
     * @param optionId The root identifier of an option group expected to
     *     be found in the file.
     * @param file The &lt;code&gt;File&lt;/code&gt; to load from.
     * @return The &lt;code&gt;OptionGroup&lt;/code&gt; found.
     */
    public OptionGroup loadOptionsFile(String optionId, File file) {
<span class="nc" id="L446">        OptionGroup group = null;</span>
<span class="nc" id="L447">        try (</span>
<span class="nc" id="L448">            FileInputStream fis = new FileInputStream(file);</span>
<span class="nc" id="L449">            FreeColXMLReader xr = new FreeColXMLReader(fis);</span>
        ) {
<span class="nc" id="L451">            xr.nextTag();</span>
<span class="nc" id="L452">            group = new OptionGroup(this);</span>
<span class="nc" id="L453">            group.readFromXML(xr);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            if (!optionId.equals(group.getId())) {</span>
<span class="nc" id="L455">                Option op = group.getOption(optionId);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                group = (op instanceof OptionGroup) ? (OptionGroup)op : null;</span>
            }                   
<span class="nc" id="L458">            logger.info(&quot;Loaded &quot; + optionId + &quot; group from file &quot;</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">                + file.getPath() </span>
                + ((group == null) ? &quot; failed&quot; : &quot; succeeded&quot;));
<span class="nc bnc" id="L461" title="All 16 branches missed.">        } catch (Exception e) {</span>
<span class="nc" id="L462">            logger.log(Level.WARNING, &quot;Failed to load OptionGroup &quot;</span>
<span class="nc" id="L463">                + optionId + &quot; from &quot; + file.getName(), e);</span>
<span class="nc" id="L464">        }</span>
<span class="nc" id="L465">        return group;</span>
    }

    /**
     * Merge an option group into the spec.
     *
     * @param group The &lt;code&gt;OptionGroup&lt;/code&gt; to merge.
     * @return The merged &lt;code&gt;OptionGroup&lt;/code&gt; from this
     *     &lt;code&gt;Specification&lt;/code&gt;.
     */
    public OptionGroup mergeGroup(OptionGroup group) {
<span class="nc" id="L476">        OptionGroup realGroup = allOptionGroups.get(group.getId());</span>
<span class="nc bnc" id="L477" title="All 4 branches missed.">        if (realGroup == null || !realGroup.isEditable()) return realGroup;</span>

<span class="nc bnc" id="L479" title="All 2 branches missed.">        for (Option o : group.getOptions()) {</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">            if (o instanceof OptionGroup) {</span>
<span class="nc" id="L481">                mergeGroup((OptionGroup)o);</span>
            } else {
<span class="nc" id="L483">                realGroup.add(o);</span>
            }
<span class="nc" id="L485">        }</span>
<span class="nc" id="L486">        return realGroup;</span>
    }
                
    /**
     * Save a limited set of options to a file.
     *
     * Useful to save the user game and map generator options before
     * starting a new game.
     *
     * @param group The &lt;code&gt;OptionGroup&lt;/code&gt; to save.
     * @param file The &lt;code&gt;File&lt;/code&gt; to save to.
     * @return The &lt;code&gt;OptionGroup&lt;/code&gt; saved, or null on error.
     */
    public static OptionGroup saveOptionsFile(OptionGroup group, File file) {
<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (group != null) {</span>
            try {
<span class="nc bnc" id="L502" title="All 2 branches missed.">                return (group.save(file, FreeColXMLWriter.WriteScope.toSave(),</span>
                                   true)) ? group : null;
<span class="nc" id="L504">            } catch (Exception e) {</span>
<span class="nc" id="L505">                logger.log(Level.WARNING, &quot;Failed to save option group &quot;</span>
<span class="nc" id="L506">                    + group.getId() + &quot; to &quot; + file.getName(), e);</span>
            }
        }
<span class="nc" id="L509">        return null;</span>
    }

    /**
     * Clean up the specification.
     *
     * Builds all the cached containers and secondary variables.  This
     * *must* clear any containers before building as it may be called
     * multiple times in response to various specification updates.
     *
     * @param why A short statement of why the specification needed to
     *     be cleaned.
     */
    public void clean(String why) {
<span class="fc" id="L523">        logger.finest(&quot;Cleaning up specification following &quot; + why + &quot;.&quot;);</span>

<span class="fc" id="L525">        Iterator&lt;FreeColGameObjectType&gt; typeIterator</span>
<span class="fc" id="L526">            = allTypes.values().iterator();</span>
<span class="fc bfc" id="L527" title="All 2 branches covered.">        while (typeIterator.hasNext()) {</span>
<span class="fc" id="L528">            FreeColGameObjectType type = typeIterator.next();</span>
<span class="fc bfc" id="L529" title="All 2 branches covered.">            if (type.isAbstractType()) {</span>
<span class="fc" id="L530">                typeIterator.remove();</span>
            }
<span class="fc" id="L532">        }</span>

        // Fix up the GoodsType derived attributes.  Several GoodsType
        // predicates are likely to fail until this is done.
<span class="fc" id="L536">        GoodsType.setDerivedAttributes(this);</span>

<span class="fc" id="L538">        storableGoodsTypeList.clear();</span>
<span class="fc" id="L539">        farmedGoodsTypeList.clear();</span>
<span class="fc" id="L540">        foodGoodsTypeList.clear();</span>
<span class="fc" id="L541">        newWorldGoodsTypeList.clear();</span>
<span class="fc" id="L542">        newWorldLuxuryGoodsTypeList.clear();</span>
<span class="fc" id="L543">        libertyGoodsTypeList.clear();</span>
<span class="fc" id="L544">        immigrationGoodsTypeList.clear();</span>
<span class="fc" id="L545">        rawBuildingGoodsTypeList.clear();</span>
<span class="fc bfc" id="L546" title="All 2 branches covered.">        for (GoodsType goodsType : goodsTypeList) {</span>
<span class="fc bfc" id="L547" title="All 2 branches covered.">            if (goodsType.isStorable()) {</span>
<span class="fc" id="L548">                storableGoodsTypeList.add(goodsType);</span>
            }
<span class="fc bfc" id="L550" title="All 2 branches covered.">            if (goodsType.isFarmed()) {</span>
<span class="fc" id="L551">                farmedGoodsTypeList.add(goodsType);</span>
            }
<span class="fc bfc" id="L553" title="All 2 branches covered.">            if (goodsType.isFoodType()) {</span>
<span class="fc" id="L554">                foodGoodsTypeList.add(goodsType);</span>
            }
<span class="fc bfc" id="L556" title="All 2 branches covered.">            if (goodsType.isNewWorldGoodsType()) {</span>
<span class="fc" id="L557">                newWorldGoodsTypeList.add(goodsType);</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">                if (goodsType.isNewWorldLuxuryType()) {</span>
<span class="nc" id="L559">                    newWorldLuxuryGoodsTypeList.add(goodsType);</span>
                }
            }
<span class="fc bfc" id="L562" title="All 2 branches covered.">            if (goodsType.isLibertyType()) {</span>
<span class="fc" id="L563">                libertyGoodsTypeList.add(goodsType);</span>
            }
<span class="fc bfc" id="L565" title="All 2 branches covered.">            if (goodsType.isImmigrationType()) {</span>
<span class="fc" id="L566">                immigrationGoodsTypeList.add(goodsType);</span>
            }
<span class="fc bfc" id="L568" title="All 4 branches covered.">            if (goodsType.isRawBuildingMaterial() &amp;&amp; !goodsType.isFoodType()) {</span>
<span class="fc" id="L569">                rawBuildingGoodsTypeList.add(goodsType);</span>
            }
<span class="fc" id="L571">        }</span>

<span class="fc" id="L573">        REFNations.clear();</span>
<span class="fc" id="L574">        europeanNations.clear();</span>
<span class="fc" id="L575">        indianNations.clear();</span>
<span class="fc bfc" id="L576" title="All 2 branches covered.">        for (Nation nation : nations) {</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">            if (nation.getType().isEuropean()) {</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">                if (nation.isUnknownEnemy()) {</span>
<span class="fc" id="L579">                    continue;</span>
<span class="fc bfc" id="L580" title="All 2 branches covered.">                } else if (nation.getType().isREF()) {</span>
<span class="fc" id="L581">                    REFNations.add(nation);</span>
                } else {
<span class="fc" id="L583">                    europeanNations.add(nation);</span>
                }
            } else {
<span class="fc" id="L586">                indianNations.add(nation);</span>
            }
<span class="fc" id="L588">        }</span>

<span class="fc" id="L590">        nationTypes.clear();</span>
<span class="fc" id="L591">        nationTypes.addAll(indianNationTypes);</span>
<span class="fc" id="L592">        nationTypes.addAll(europeanNationTypes);</span>
<span class="fc" id="L593">        Iterator&lt;EuropeanNationType&gt; iterator = europeanNationTypes.iterator();</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">        while (iterator.hasNext()) {</span>
<span class="fc" id="L595">            EuropeanNationType nationType = iterator.next();</span>
<span class="fc bfc" id="L596" title="All 2 branches covered.">            if (nationType.isREF()) {</span>
<span class="fc" id="L597">                REFNationTypes.add(nationType);</span>
<span class="fc" id="L598">                iterator.remove();</span>
            }
<span class="fc" id="L600">        }</span>

<span class="fc" id="L602">        experts.clear();</span>
<span class="fc" id="L603">        unitTypesTrainedInEurope.clear();</span>
<span class="fc" id="L604">        unitTypesPurchasedInEurope.clear();</span>
<span class="fc" id="L605">        defaultUnitTypes.clear();</span>
<span class="fc" id="L606">        int bestLandValue = -1, bestNavalValue = -1;</span>
<span class="fc bfc" id="L607" title="All 2 branches covered.">        for (UnitType unitType : unitTypeList) {</span>
<span class="fc bfc" id="L608" title="All 2 branches covered.">            if (unitType.isDefaultUnitType()) defaultUnitTypes.add(unitType);</span>
<span class="fc bfc" id="L609" title="All 2 branches covered.">            if (unitType.needsGoodsToBuild()</span>
<span class="fc bfc" id="L610" title="All 2 branches covered.">                &amp;&amp; !unitType.hasAbility(Ability.BORN_IN_COLONY)) {</span>
<span class="fc" id="L611">                buildableUnitTypes.add(unitType);</span>
            }
<span class="fc bfc" id="L613" title="All 2 branches covered.">            if (unitType.getExpertProduction() != null) {</span>
<span class="fc" id="L614">                experts.put(unitType.getExpertProduction(), unitType);</span>
            }
<span class="fc bfc" id="L616" title="All 2 branches covered.">            if (unitType.hasPrice()) {</span>
<span class="fc bfc" id="L617" title="All 2 branches covered.">                if (unitType.getSkill() &gt; 0) {</span>
<span class="fc" id="L618">                    unitTypesTrainedInEurope.add(unitType);</span>
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">                } else if (!unitType.hasSkill()) {</span>
<span class="fc" id="L620">                    unitTypesPurchasedInEurope.add(unitType);</span>
                }
            }
<span class="fc bfc" id="L623" title="All 2 branches covered.">            if (unitType.isNaval()) {</span>
<span class="fc bfc" id="L624" title="All 2 branches covered.">                if (bestNavalValue &lt; unitType.getMovement()) {</span>
<span class="fc" id="L625">                    bestNavalValue = unitType.getMovement();</span>
<span class="fc" id="L626">                    fastestNavalUnitType = unitType;</span>
                }
            } else {
<span class="fc bfc" id="L629" title="All 2 branches covered.">                if (bestLandValue &lt; unitType.getMovement()) {</span>
<span class="fc" id="L630">                    bestLandValue = unitType.getMovement();</span>
<span class="fc" id="L631">                    fastestLandUnitType = unitType;</span>
                }
            }
<span class="fc" id="L634">        }</span>

        // Initialize UI containers.
<span class="fc bfc" id="L637" title="All 2 branches covered.">        for (AbstractOption option : allOptions.values()) {</span>
<span class="fc" id="L638">            option.generateChoices();</span>
<span class="fc" id="L639">        }</span>

        // Initialize the Turn class using GameOptions and messages.
<span class="fc" id="L642">        Turn.initialize(getInteger(GameOptions.STARTING_YEAR),</span>
<span class="fc" id="L643">                        getInteger(GameOptions.SEASON_YEAR),</span>
<span class="fc" id="L644">                        getInteger(GameOptions.SEASONS));</span>
        {
<span class="fc" id="L646">            Option agesOption = getOption(GameOptions.AGES);</span>
<span class="pc bpc" id="L647" title="1 of 2 branches missed.">            boolean badAges = !(agesOption instanceof TextOption);</span>
<span class="pc bpc" id="L648" title="1 of 2 branches missed.">            String agesValue = (badAges) ? &quot;&quot;</span>
<span class="fc" id="L649">                : ((TextOption)agesOption).getValue();</span>
<span class="fc" id="L650">            String a[] = agesValue.split(&quot;,&quot;);</span>
<span class="pc bpc" id="L651" title="1 of 2 branches missed.">            badAges |= a.length != NUMBER_OF_AGES-1;</span>
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">            if (!badAges) {</span>
                try {
<span class="fc" id="L654">                    ages[0] = 1;</span>
<span class="fc" id="L655">                    ages[1] = Turn.yearToTurn(Integer.parseInt(a[0]));</span>
<span class="fc" id="L656">                    ages[2] = Turn.yearToTurn(Integer.parseInt(a[1]));</span>
<span class="pc bpc" id="L657" title="2 of 4 branches missed.">                    if (ages[1] &lt; 1 || ages[2] &lt; 1) {</span>
<span class="nc" id="L658">                        badAges = true;</span>
<span class="pc bpc" id="L659" title="1 of 2 branches missed.">                    } else if (ages[1] &gt; ages[2]) {</span>
<span class="nc" id="L660">                        int tmp = ages[1];</span>
<span class="nc" id="L661">                        ages[1] = ages[2];</span>
<span class="nc" id="L662">                        ages[2] = tmp;</span>
                    }
<span class="nc" id="L664">                } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L665">                    badAges = true;</span>
<span class="fc" id="L666">                }</span>
            }
<span class="pc bpc" id="L668" title="1 of 2 branches missed.">            if (badAges) {</span>
<span class="nc" id="L669">                logger.warning(&quot;Bad ages: &quot; + agesValue);</span>
<span class="nc" id="L670">                ages[0] = 1;   // First turn</span>
<span class="nc" id="L671">                ages[1] = Turn.yearToTurn(1600);</span>
<span class="nc" id="L672">                ages[2] = Turn.yearToTurn(1700);</span>
            }
        }

        // Apply the customs on coast restriction
<span class="fc" id="L677">        boolean customsOnCoast = getBoolean(GameOptions.CUSTOMS_ON_COAST);</span>
<span class="fc bfc" id="L678" title="All 2 branches covered.">        for (Ability a : getBuildingType(&quot;model.building.customHouse&quot;)</span>
<span class="fc" id="L679">                 .getAbilities(Ability.COASTAL_ONLY)) {</span>
<span class="fc" id="L680">            a.setValue(customsOnCoast);</span>
<span class="fc" id="L681">        }</span>

<span class="fc" id="L683">        logger.info(&quot;Specification clean following &quot; + why + &quot; complete&quot;</span>
<span class="fc" id="L684">            + &quot;, starting year=&quot; + Turn.getStartingYear()</span>
<span class="fc" id="L685">            + &quot;, season year=&quot; + Turn.getSeasonYear()</span>
            + &quot;, ages=[&quot; + ages[0] + &quot;,&quot; + ages[1] + &quot;,&quot; + ages[2] + &quot;]&quot;
<span class="fc" id="L687">            + &quot;, seasons=&quot; + Turn.getSeasonNumber()</span>
<span class="fc" id="L688">            + &quot;, &quot; + allTypes.size() + &quot; FreeColGameObjectTypes&quot;</span>
<span class="fc" id="L689">            + &quot;, &quot; + allAbilities.size() + &quot; Abilities&quot;</span>
<span class="fc" id="L690">            + &quot;, &quot; + buildingTypeList.size() + &quot; BuildingTypes&quot;</span>
<span class="fc" id="L691">            + &quot;, &quot; + disasters.size() + &quot; Disasters&quot;</span>
<span class="fc" id="L692">            + &quot;, &quot; + europeanNationTypes.size() + &quot; EuropeanNationTypes&quot;</span>
<span class="fc" id="L693">            + &quot;, &quot; + events.size() + &quot; Events&quot;</span>
<span class="fc" id="L694">            + &quot;, &quot; + foundingFathers.size() + &quot; FoundingFathers&quot;</span>
<span class="fc" id="L695">            + &quot;, &quot; + goodsTypeList.size() + &quot; GoodsTypes&quot;</span>
<span class="fc" id="L696">            + &quot;, &quot; + indianNationTypes.size() + &quot; IndianNationTypes&quot;</span>
<span class="fc" id="L697">            + &quot;, &quot; + allModifiers.size() + &quot; Modifiers&quot;</span>
<span class="fc" id="L698">            + &quot;, &quot; + nations.size() + &quot; Nations&quot;</span>
<span class="fc" id="L699">            + &quot;, &quot; + allOptions.size() + &quot; Options&quot;</span>
<span class="fc" id="L700">            + &quot;, &quot; + allOptionGroups.size() + &quot; Option Groups&quot;</span>
<span class="fc" id="L701">            + &quot;, &quot; + resourceTypeList.size() + &quot; ResourceTypes&quot;</span>
<span class="fc" id="L702">            + &quot;, &quot; + roles.size() + &quot; Roles&quot;</span>
<span class="fc" id="L703">            + &quot;, &quot; + tileTypeList.size() + &quot; TileTypes&quot;</span>
<span class="fc" id="L704">            + &quot;, &quot; + tileImprovementTypeList.size() + &quot; TileImprovementTypes&quot;</span>
<span class="fc" id="L705">            + &quot;, &quot; + unitTypeList.size() + &quot; UnitTypes&quot;</span>
            + &quot; read.&quot;);
<span class="fc" id="L707">    }</span>

    /**
     * Disable editing of some critical option groups.
     */
    public void disableEditing() {
<span class="fc bfc" id="L713" title="All 2 branches covered.">        for (String s : new String[] {</span>
<span class="fc" id="L714">                GameOptions.getXMLElementTagName(),</span>
<span class="fc" id="L715">                MapGeneratorOptions.getXMLElementTagName(),</span>
                DIFFICULTY_LEVELS
            }) {
<span class="fc" id="L718">            OptionGroup og = allOptionGroups.get(s);</span>
<span class="pc bpc" id="L719" title="1 of 2 branches missed.">            if (og != null) og.setEditable(false);</span>
        }
<span class="fc" id="L721">    }</span>

    /**
     * Generate the dynamic options.
     *
     * Only call this in the server.  If clients call it the European
     * prices can be desynchronized.
     */
    public void generateDynamicOptions() {
<span class="fc" id="L730">        logger.finest(&quot;Generating dynamic options.&quot;);</span>
<span class="fc" id="L731">        OptionGroup prices = new OptionGroup(GameOptions.GAMEOPTIONS_PRICES, this);</span>
<span class="fc" id="L732">        allOptionGroups.put(prices.getId(), prices);</span>
<span class="fc bfc" id="L733" title="All 2 branches covered.">        for (GoodsType goodsType : goodsTypeList) {</span>
<span class="fc" id="L734">            String name = goodsType.getSuffix(&quot;model.goods.&quot;);</span>
<span class="fc" id="L735">            String base = &quot;model.option.&quot; + name + &quot;.&quot;;</span>
<span class="fc bfc" id="L736" title="All 2 branches covered.">            if (goodsType.getInitialSellPrice() &gt; 0) {</span>
<span class="fc bfc" id="L737" title="All 2 branches covered.">                int diff = (goodsType.isNewWorldGoodsType()</span>
<span class="fc bfc" id="L738" title="All 2 branches covered.">                    || goodsType.isNewWorldLuxuryType()) ? 3 : 0;</span>
<span class="fc" id="L739">                IntegerOption minimum</span>
                    = new IntegerOption(base + &quot;minimumPrice&quot;, this);
<span class="fc" id="L741">                minimum.setValue(goodsType.getInitialSellPrice());</span>
<span class="fc" id="L742">                minimum.setMinimumValue(1);</span>
<span class="fc" id="L743">                minimum.setMaximumValue(100);</span>
<span class="fc" id="L744">                prices.add(minimum);</span>
<span class="fc" id="L745">                addAbstractOption(minimum);</span>
<span class="fc" id="L746">                IntegerOption maximum</span>
                    = new IntegerOption(base + &quot;maximumPrice&quot;, this);
<span class="fc" id="L748">                maximum.setValue(goodsType.getInitialSellPrice() + diff);</span>
<span class="fc" id="L749">                maximum.setMinimumValue(1);</span>
<span class="fc" id="L750">                maximum.setMaximumValue(100);</span>
<span class="fc" id="L751">                prices.add(maximum);</span>
<span class="fc" id="L752">                addAbstractOption(maximum);</span>
<span class="fc" id="L753">                IntegerOption spread</span>
                    = new IntegerOption(base + &quot;spread&quot;, this);
<span class="fc" id="L755">                spread.setValue(goodsType.getPriceDifference());</span>
<span class="fc" id="L756">                spread.setMinimumValue(1);</span>
<span class="fc" id="L757">                spread.setMaximumValue(100);</span>
<span class="fc" id="L758">                prices.add(spread);</span>
<span class="fc" id="L759">                addAbstractOption(spread);</span>
<span class="fc bfc" id="L760" title="All 2 branches covered.">            } else if (goodsType.getPrice() &lt; FreeColGameObjectType.INFINITY) {</span>
<span class="fc" id="L761">                IntegerOption price</span>
                    = new IntegerOption(base + &quot;price&quot;, this);
<span class="fc" id="L763">                price.setValue(goodsType.getPrice());</span>
<span class="fc" id="L764">                price.setMinimumValue(1);</span>
<span class="fc" id="L765">                price.setMaximumValue(100);</span>
<span class="fc" id="L766">                prices.add(price);</span>
<span class="fc" id="L767">                addAbstractOption(price);</span>
            }
<span class="fc" id="L769">        }</span>
<span class="fc" id="L770">        getGameOptions().add(prices);</span>
<span class="fc" id="L771">    }</span>


    private interface ChildReader {
        public void readChildren(FreeColXMLReader xr) throws XMLStreamException;
    }

<span class="fc" id="L778">    private class ModifierReader implements ChildReader {</span>

        @Override
        public void readChildren(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc bfc" id="L782" title="All 2 branches covered.">            while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L783">                Modifier modifier = new Modifier(xr, Specification.this);</span>
<span class="fc" id="L784">                Specification.this.addModifier(modifier);</span>
<span class="fc" id="L785">                Specification.this.specialModifiers.add(modifier);</span>
<span class="fc" id="L786">            }</span>
<span class="fc" id="L787">        }</span>
    }

    private class TypeReader&lt;T extends FreeColGameObjectType&gt; implements ChildReader {

        private final Class&lt;T&gt; type;
        private final List&lt;T&gt; result;
<span class="fc" id="L794">        private int index = 0;</span>

        // Is there really no easy way to capture T?
<span class="fc" id="L797">        public TypeReader(Class&lt;T&gt; type, List&lt;T&gt; listToFill) {</span>
<span class="fc" id="L798">            result = listToFill;</span>
<span class="fc" id="L799">            this.type = type;</span>
<span class="fc" id="L800">        }</span>

        @Override
        public void readChildren(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc bfc" id="L804" title="All 2 branches covered.">            while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L805">                final String tag = xr.getLocalName();</span>
<span class="fc" id="L806">                String id = xr.readId();</span>
<span class="pc bpc" id="L807" title="1 of 2 branches missed.">                if (id == null) {</span>
<span class="nc" id="L808">                    logger.warning(&quot;Null identifier, tag: &quot; + tag);</span>

<span class="fc bfc" id="L810" title="All 2 branches covered.">                } else if (FreeColGameObjectType.DELETE_TAG.equals(tag)) {</span>
<span class="fc" id="L811">                    FreeColGameObjectType object = allTypes.remove(id);</span>
<span class="pc bpc" id="L812" title="1 of 2 branches missed.">                    if (object != null) result.remove(object);</span>

<span class="fc" id="L814">                } else {</span>
<span class="fc" id="L815">                    T object = getType(id, type);</span>
<span class="fc" id="L816">                    allTypes.put(id, object);</span>

                    // If this an existing object (with id) and the
                    // PRESERVE tag is present, then leave the
                    // attributes intact and only read the child
                    // elements, otherwise do a full attribute
                    // inclusive read.  This allows mods and spec
                    // extensions to not have to re-specify all the
                    // attributes when just changing the children.
<span class="pc bpc" id="L825" title="1 of 2 branches missed.">                    if (object.getId() != null</span>
<span class="fc bfc" id="L826" title="All 2 branches covered.">                        &amp;&amp; xr.getAttribute(FreeColGameObjectType.PRESERVE_TAG,</span>
                                           (String)null) != null) {
<span class="fc" id="L828">                        object.readChildren(xr);</span>
                    } else {
<span class="fc" id="L830">                        object.readFromXML(xr);</span>
                    }
<span class="fc bfc" id="L832" title="All 4 branches covered.">                    if (!object.isAbstractType() &amp;&amp; !result.contains(object)) {</span>
<span class="fc" id="L833">                        result.add(object);</span>
<span class="fc" id="L834">                        object.setIndex(index);</span>
<span class="fc" id="L835">                        index++;</span>
                    }
                }
<span class="fc" id="L838">            }</span>
<span class="fc" id="L839">        }</span>
    }

    /**
     * Options are special as they live in the allOptionGroups
     * collection, which has its own particular semantics.  So they
     * need their own reader.
     */
<span class="fc" id="L847">    private class OptionReader implements ChildReader {</span>

        private static final String RECURSIVE_TAG = &quot;recursive&quot;;

        @Override
        public void readChildren(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc bfc" id="L853" title="All 2 branches covered.">            while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L854">                readChild(xr);</span>
            }
<span class="fc" id="L856">        }</span>

        private void readChild(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L859">            final String tag = xr.getLocalName();</span>

<span class="fc" id="L861">            boolean recursive = xr.getAttribute(RECURSIVE_TAG, true);</span>

<span class="pc bpc" id="L863" title="1 of 2 branches missed.">            if (OptionGroup.getXMLElementTagName().equals(tag)) {</span>
<span class="fc" id="L864">                String id = xr.readId();</span>
<span class="fc" id="L865">                OptionGroup group = allOptionGroups.get(id);</span>
<span class="fc bfc" id="L866" title="All 2 branches covered.">                if (group == null) {</span>
<span class="fc" id="L867">                    group = new OptionGroup(id, Specification.this);</span>
<span class="fc" id="L868">                    allOptionGroups.put(id, group);</span>
                }
<span class="fc" id="L870">                group.readFromXML(xr);</span>
<span class="fc" id="L871">                Specification.this.addOptionGroup(group, recursive);</span>

<span class="fc" id="L873">            } else {</span>
<span class="nc" id="L874">                logger.warning(OptionGroup.getXMLElementTagName()</span>
                    + &quot; expected in OptionReader, not: &quot; + tag);
<span class="nc" id="L876">                xr.nextTag();</span>
            }
<span class="fc" id="L878">        }</span>
    }

    // ---------------------------------------------------------- retrieval
    // methods

    /**
     * Get the specification identifier.
     *
     * @return The specification identifier.
     */
    public String getId() {
<span class="fc" id="L890">        return id;</span>
    }

    /**
     * Get the specification version.
     *
     * @return The specification version.
     */
    public String getVersion() {
<span class="nc" id="L899">        return version;</span>
    }

    /**
     * Registers an Ability as defined.
     *
     * @param ability an &lt;code&gt;Ability&lt;/code&gt; value
     */
    public void addAbility(Ability ability) {
<span class="fc" id="L908">        String id = ability.getId();</span>
<span class="fc" id="L909">        addAbility(id);</span>
<span class="fc" id="L910">        allAbilities.get(id).add(ability);</span>
<span class="fc" id="L911">    }</span>

    /**
     * Registers an Ability's id as defined.  This is useful for
     * abilities that are required rather than provided by
     * FreeColGameObjectTypes.
     *
     * @param id The object identifier.
     */
    public void addAbility(String id) {
<span class="fc bfc" id="L921" title="All 2 branches covered.">        if (!allAbilities.containsKey(id)) {</span>
<span class="fc" id="L922">            allAbilities.put(id, new ArrayList&lt;Ability&gt;());</span>
        }
<span class="fc" id="L924">    }</span>

    /**
     * Get all the Abilities with the given identifier.
     *
     * @param id The object identifier to look for.
     */
    public List&lt;Ability&gt; getAbilities(String id) {
<span class="fc" id="L932">        return allAbilities.get(id);</span>
    }

    /**
     * Add a modifier.
     *
     * @param modifier The &lt;code&gt;Modifier&lt;/code&gt; to add.
     */
    public void addModifier(Modifier modifier) {
<span class="fc" id="L941">        String id = modifier.getId();</span>
<span class="fc bfc" id="L942" title="All 2 branches covered.">        if (!allModifiers.containsKey(id)) {</span>
<span class="fc" id="L943">            allModifiers.put(id, new ArrayList&lt;Modifier&gt;());</span>
        }
<span class="fc" id="L945">        allModifiers.get(id).add(modifier);</span>
<span class="fc" id="L946">    }</span>

    /**
     * Get all the Modifiers with the given identifier.
     *
     * @param id The object identifier to look for.
     */
    public List&lt;Modifier&gt; getModifiers(String id) {
<span class="fc" id="L954">        List&lt;Modifier&gt; result = allModifiers.get(id);</span>
<span class="pc bpc" id="L955" title="1 of 2 branches missed.">        return (result == null) ? Collections.&lt;Modifier&gt;emptyList() : result;</span>
    }


    // Option routines

    /**
     * Is option with this identifier present?  This is helpful when
     * options are optionally(!) present, for example
     * model.option.priceIncrease.artillery exists but
     * model.option.priceIncrease.frigate does not.
     *
     * @param id The object identifier to test.
     * @return True/false on presence of option id.
     */
    public boolean hasOption(String id) {
<span class="pc bpc" id="L971" title="1 of 4 branches missed.">        return id != null &amp;&amp; allOptions.containsKey(id);</span>
    }

    /**
     * Get the &lt;code&gt;AbstractOption&lt;/code&gt; with the given identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;AbstractOption&lt;/code&gt; found.
     * @exception IllegalArgumentException if the identifier is null
     *     or not present.
     */
    public AbstractOption getOption(String id) throws IllegalArgumentException {
<span class="pc bpc" id="L983" title="1 of 2 branches missed.">        if (id == null) {</span>
<span class="nc" id="L984">            throw new IllegalArgumentException(&quot;AbstractOption with null id.&quot;);</span>
<span class="pc bpc" id="L985" title="1 of 2 branches missed.">        } else if (!allOptions.containsKey(id)) {</span>
<span class="nc" id="L986">            throw new IllegalArgumentException(&quot;Missing AbstractOption: &quot; + id);</span>
        } else {
<span class="fc" id="L988">            return allOptions.get(id);</span>
        }
    }

    /**
     * Get the &lt;code&gt;OptionGroup&lt;/code&gt; with the given identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;OptionGroup&lt;/code&gt; found.
     * @exception IllegalArgumentException if the identifier is null
     *     or not present.
     */
    public OptionGroup getOptionGroup(String id) throws IllegalArgumentException {
<span class="pc bpc" id="L1001" title="1 of 2 branches missed.">        if (id == null) {</span>
<span class="nc" id="L1002">            throw new IllegalArgumentException(&quot;OptionGroup with null id.&quot;);</span>
<span class="pc bpc" id="L1003" title="1 of 2 branches missed.">        } else if (!allOptionGroups.containsKey(id)) {</span>
<span class="nc" id="L1004">            throw new IllegalArgumentException(&quot;Missing OptionGroup: &quot; + id);</span>
        } else {
<span class="fc" id="L1006">            return allOptionGroups.get(id);</span>
        }
    }

    /**
     * Adds an &lt;code&gt;OptionGroup&lt;/code&gt; to this specification.
     *
     * @param optionGroup The &lt;code&gt;OptionGroup&lt;/code&gt; to add.
     * @param recursive If true, add recursively to subgroups.
     */
    public void addOptionGroup(OptionGroup optionGroup, boolean recursive) {
        // Add the options of the group
<span class="fc" id="L1018">        Iterator&lt;Option&gt; iter = optionGroup.iterator();</span>

<span class="fc bfc" id="L1020" title="All 2 branches covered.">        while (iter.hasNext()) {</span>
<span class="fc" id="L1021">            Option option = iter.next();</span>
<span class="fc bfc" id="L1022" title="All 2 branches covered.">            if (option instanceof OptionGroup) {</span>
<span class="fc" id="L1023">                allOptionGroups.put(option.getId(), (OptionGroup)option);</span>
<span class="fc bfc" id="L1024" title="All 2 branches covered.">                if (recursive) {</span>
<span class="fc" id="L1025">                    addOptionGroup((OptionGroup)option, true);</span>
                }
            } else {
<span class="fc" id="L1028">                addAbstractOption((AbstractOption)option);</span>
            }
<span class="fc" id="L1030">        }</span>
<span class="fc" id="L1031">    }</span>

    /**
     * Adds an &lt;code&gt;AbstractOption&lt;/code&gt; to this specification.
     *
     * @param abstractOption The &lt;code&gt;AbstractOption&lt;/code&gt; to add.
     */
    private void addAbstractOption(AbstractOption abstractOption) {
        // Add the option
<span class="fc" id="L1040">        allOptions.put(abstractOption.getId(), abstractOption);</span>
<span class="fc" id="L1041">    }</span>

    /**
     * Get the &lt;code&gt;IntegerOption&lt;/code&gt; with the given identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;IntegerOption&lt;/code&gt; found.
     */
    public IntegerOption getIntegerOption(String id) {
<span class="fc" id="L1050">        return (IntegerOption)getOption(id);</span>
    }

    /**
     * Get the &lt;code&gt;RangeOption&lt;/code&gt; with the given identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;RangeOption&lt;/code&gt; found.
     */
    public RangeOption getRangeOption(String id) {
<span class="fc" id="L1060">        return (RangeOption)getOption(id);</span>
    }

    /**
     * Get the &lt;code&gt;BooleanOption&lt;/code&gt; with the given identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;BooleanOption&lt;/code&gt; found.
     */
    public BooleanOption getBooleanOption(String id) {
<span class="fc" id="L1070">        return (BooleanOption)getOption(id);</span>
    }

    /**
     * Get the &lt;code&gt;StringOption&lt;/code&gt; with the given identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;StringOption&lt;/code&gt; found.
     */
    public StringOption getStringOption(String id) {
<span class="fc" id="L1080">        return (StringOption) getOption(id);</span>
    }

    /**
     * Gets the boolean value of an option.
     *
     * @param id The object identifier.
     * @return The value.
     * @exception IllegalArgumentException If there is no boolean
     *     value associated with the specified option.
     * @exception NullPointerException if the given
     *     &lt;code&gt;Option&lt;/code&gt; does not exist.
     */
    public boolean getBoolean(String id) {
        try {
<span class="fc" id="L1095">            return getBooleanOption(id).getValue();</span>
<span class="nc" id="L1096">        } catch (ClassCastException e) {</span>
<span class="nc" id="L1097">            throw new IllegalArgumentException(&quot;Not a boolean option: &quot; + id, e);</span>
        }
    }

    /**
     * Gets the integer value of an option.
     *
     * @param id The object identifier.
     * @return The value.
     * @exception IllegalArgumentException If there is no integer
     *     value associated with the specified option.
     * @exception NullPointerException if the given
     *     &lt;code&gt;Option&lt;/code&gt; does not exist.
     */
    public int getInteger(String id) {
        try {
<span class="fc" id="L1113">            return getIntegerOption(id).getValue();</span>
<span class="nc" id="L1114">        } catch (ClassCastException e) {</span>
<span class="nc" id="L1115">            throw new IllegalArgumentException(&quot;Not an integer option: &quot; + id, e);</span>
        }
    }

    /**
     * Gets the string value of an option.
     *
     * @param id The object identifier.
     * @return The value.
     * @exception IllegalArgumentException If there is no string
     *     value associated with the specified option.
     * @exception NullPointerException if the given
     *     &lt;code&gt;Option&lt;/code&gt; does not exist.
     */
    public String getString(String id) {
        try {
<span class="fc" id="L1131">            return getStringOption(id).getValue();</span>
<span class="nc" id="L1132">        } catch (ClassCastException e) {</span>
<span class="nc" id="L1133">            throw new IllegalArgumentException(&quot;Not a string option: &quot; + id, e);</span>
        }
    }


    // -- Buildings --

    public List&lt;BuildingType&gt; getBuildingTypeList() {
<span class="fc" id="L1141">        return buildingTypeList;</span>
    }

    /**
     * Get a building type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;BuildingType&lt;/code&gt; found.
     */
    public BuildingType getBuildingType(String id) {
<span class="fc" id="L1151">        return getType(id, BuildingType.class);</span>
    }

    // -- Goods --

    public List&lt;GoodsType&gt; getGoodsTypeList() {
<span class="fc" id="L1157">        return new ArrayList&lt;&gt;(goodsTypeList);</span>
    }

    public List&lt;GoodsType&gt; getStorableGoodsTypeList() {
<span class="fc" id="L1161">        return new ArrayList&lt;&gt;(storableGoodsTypeList);</span>
    }

    public List&lt;GoodsType&gt; getFarmedGoodsTypeList() {
<span class="fc" id="L1165">        return new ArrayList&lt;&gt;(farmedGoodsTypeList);</span>
    }

    public List&lt;GoodsType&gt; getNewWorldGoodsTypeList() {
<span class="fc" id="L1169">        return new ArrayList&lt;&gt;(newWorldGoodsTypeList);</span>
    }

    public List&lt;GoodsType&gt; getNewWorldLuxuryGoodsTypeList() {
<span class="fc" id="L1173">        return new ArrayList&lt;&gt;(newWorldLuxuryGoodsTypeList);</span>
    }

    public List&lt;GoodsType&gt; getLibertyGoodsTypeList() {
<span class="fc" id="L1177">        return new ArrayList&lt;&gt;(libertyGoodsTypeList);</span>
    }

    public List&lt;GoodsType&gt; getImmigrationGoodsTypeList() {
<span class="nc" id="L1181">        return new ArrayList&lt;&gt;(immigrationGoodsTypeList);</span>
    }

    public List&lt;GoodsType&gt; getFoodGoodsTypeList() {
<span class="fc" id="L1185">        return new ArrayList&lt;&gt;(foodGoodsTypeList);</span>
    }

    public final List&lt;GoodsType&gt; getRawBuildingGoodsTypeList() {
<span class="nc" id="L1189">        return new ArrayList&lt;&gt;(rawBuildingGoodsTypeList);</span>
    }

    /**
     * The general &quot;Food&quot; type is handled as a special case in many places.
     * Introduce this routine to collect them into one place, in the hope
     * we can one day deprecate this routine and clean up the special cases.
     *
     * @return The main food type (&quot;model.goods.food&quot;).
     */
    public GoodsType getPrimaryFoodType() {
<span class="fc" id="L1200">        return getGoodsType(&quot;model.goods.food&quot;);</span>
    }

    /**
     * Get the initial &lt;em&gt;minimum&lt;/em&gt; price of the given goods
     * type. The initial price in a particular Market may be higher.
     *
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to check.
     * @return The minimum price.
     */
    public int getInitialPrice(GoodsType goodsType) {
<span class="fc" id="L1211">        String suffix = goodsType.getSuffix(&quot;model.goods.&quot;);</span>
<span class="fc" id="L1212">        String minPrice = &quot;model.option.&quot; + suffix + &quot;.minimumPrice&quot;;</span>
<span class="fc" id="L1213">        String maxPrice = &quot;model.option.&quot; + suffix + &quot;.maximumPrice&quot;;</span>
<span class="pc bpc" id="L1214" title="2 of 4 branches missed.">        return (hasOption(minPrice) &amp;&amp; hasOption(maxPrice))</span>
<span class="pc" id="L1215">            ? Math.min(getInteger(minPrice), getInteger(maxPrice))</span>
<span class="nc" id="L1216">            : goodsType.getInitialSellPrice();</span>
    }

    /**
     * Get a goods type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;GoodsType&lt;/code&gt; found.
     */
    public GoodsType getGoodsType(String id) {
<span class="fc" id="L1226">        return getType(id, GoodsType.class);</span>
    }

    // -- Resources --

    public List&lt;ResourceType&gt; getResourceTypeList() {
<span class="nc" id="L1232">        return resourceTypeList;</span>
    }

    /**
     * Get a resource type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;ResourceType&lt;/code&gt; found.
     */
    public ResourceType getResourceType(String id) {
<span class="fc" id="L1242">        return getType(id, ResourceType.class);</span>
    }

    // -- Tiles --

    public List&lt;TileType&gt; getTileTypeList() {
<span class="fc" id="L1248">        return tileTypeList;</span>
    }

    /**
     * Get a tile type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;TileType&lt;/code&gt; found.
     */
    public TileType getTileType(String id) {
<span class="fc" id="L1258">        return getType(id, TileType.class);</span>
    }

    // -- Improvements --

    public List&lt;TileImprovementType&gt; getTileImprovementTypeList() {
<span class="fc" id="L1264">        return tileImprovementTypeList;</span>
    }

    /**
     * Get a tile improvement type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;TileImprovementType&lt;/code&gt; found.
     */
    public TileImprovementType getTileImprovementType(String id) {
<span class="fc" id="L1274">        return getType(id, TileImprovementType.class);</span>
    }

    // -- Units --

    public List&lt;UnitType&gt; getUnitTypeList() {
<span class="fc" id="L1280">        return unitTypeList;</span>
    }

    /**
     * Get the most vanilla unit type for a given player.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; to find the default
     *     unit type for, or null indicating a normal player nation
     *     (i.e. non-REF European).
     * @return The default unit type.
     */
    public UnitType getDefaultUnitType(Player player) {
<span class="pc bpc" id="L1292" title="1 of 2 branches missed.">        return (player == null) ? getDefaultUnitType()</span>
<span class="fc" id="L1293">            : getDefaultUnitType(player.getNationType());</span>
    }
    
    /**
     * Get the most vanilla unit type for a type of nation.
     *
     * Provides a type to use to make a neutral comparison of the
     * productivity of work locations.
     *
     * @param nationType The &lt;code&gt;NationType&lt;/code&gt; to find the default
     *     unit type for, or null indicating a normal player nation
     *     (i.e. non-REF European).
     * @return The free colonist unit type.
     */
    public UnitType getDefaultUnitType(NationType nationType) {
<span class="pc bpc" id="L1308" title="1 of 2 branches missed.">        Predicate&lt;UnitType&gt; p = (nationType == null)</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">            ? ut -&gt; !ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT)</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">                &amp;&amp; !ut.hasAbility(Ability.REF_UNIT)</span>
<span class="fc bfc" id="L1311" title="All 2 branches covered.">            : (nationType.isIndian())</span>
<span class="fc bfc" id="L1312" title="All 2 branches covered.">            ? ut -&gt; ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT)</span>
<span class="pc bpc" id="L1313" title="1 of 2 branches missed.">                &amp;&amp; !ut.hasAbility(Ability.REF_UNIT)</span>
<span class="fc bfc" id="L1314" title="All 2 branches covered.">            : (nationType.isREF())</span>
<span class="fc bfc" id="L1315" title="All 2 branches covered.">            ? ut -&gt; !ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT)</span>
<span class="fc bfc" id="L1316" title="All 2 branches covered.">                &amp;&amp; ut.hasAbility(Ability.REF_UNIT)</span>
<span class="pc bpc" id="L1317" title="1 of 2 branches missed.">            : ut -&gt; !ut.hasAbility(Ability.BORN_IN_INDIAN_SETTLEMENT)</span>
<span class="pc bpc" id="L1318" title="1 of 2 branches missed.">                &amp;&amp; !ut.hasAbility(Ability.REF_UNIT);</span>
<span class="fc" id="L1319">        return find(defaultUnitTypes, p, getDefaultUnitType());</span>
    }
    
    /**
     * Get the most vanilla unit type.
     *
     * @return The default unit type.
     */
    public UnitType getDefaultUnitType() {
<span class="fc" id="L1328">        return getUnitType(&quot;model.unit.freeColonist&quot;); // Drop this soon</span>
    }
    
    /**
     * Get the list of buildable unit types.
     *
     * @return The list of buildable unit types.
     */
    public List&lt;UnitType&gt; getBuildableUnitTypes() {
<span class="nc" id="L1337">        return buildableUnitTypes;</span>
    }

    /**
     * Get the unit type that is the expert for producing a type of goods.
     *
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to check.
     * @return The expert &lt;code&gt;UnitType&lt;/code&gt;, or null if none.
     */
    public UnitType getExpertForProducing(GoodsType goodsType) {
<span class="fc" id="L1347">        return experts.get(goodsType);</span>
    }

    /**
     * Get the unit types which have any of the given abilities
     *
     * @param abilities The abilities for the search
     * @return A list of &lt;code&gt;UnitType&lt;/code&gt;s with the abilities.
     */
    public List&lt;UnitType&gt; getUnitTypesWithAbility(String... abilities) {
<span class="fc" id="L1357">        return getTypesWithAbility(UnitType.class, abilities);</span>
    }

    /**
     * Get the unit types which have none of the given abilities
     *
     * @param abilities The abilities for the search
     * @return A list of &lt;code&gt;UnitType&lt;/code&gt;s without the abilities.
     */
    public List&lt;UnitType&gt; getUnitTypesWithoutAbility(String... abilities) {
<span class="fc" id="L1367">        return getTypesWithoutAbility(UnitType.class, abilities);</span>
    }

    /**
     * Gets the unit types that can be trained in Europe.
     *
     * @return A list of Europe-trainable &lt;code&gt;UnitType&lt;/code&gt;s.
     */
    public List&lt;UnitType&gt; getUnitTypesTrainedInEurope() {
<span class="nc" id="L1376">        return unitTypesTrainedInEurope;</span>
    }

    /**
     * Get the unit types that can be purchased in Europe.
     *
     * @return A list of Europe-purchasable &lt;code&gt;UnitType&lt;/code&gt;s.
     */
    public List&lt;UnitType&gt; getUnitTypesPurchasedInEurope() {
<span class="nc" id="L1385">        return unitTypesPurchasedInEurope;</span>
    }

    /**
     * Gets the fastest land unit type in this specification.
     *
     * @return The fastest land unit type.
     */
    public UnitType getFastestLandUnitType() {
<span class="nc" id="L1394">        return fastestLandUnitType;</span>
    }

    /**
     * Gets the fastest naval unit type in this specification.
     *
     * @return The fastest naval unit type.
     */
    public UnitType getFastestNavalUnitType() {
<span class="nc" id="L1403">        return fastestNavalUnitType;</span>
    }

    /**
     * Gets the REF unit types.
     *
     * @param naval If true, choose naval units, if not, land units.
     */
    public List&lt;UnitType&gt; getREFUnitTypes(boolean naval) {
<span class="fc" id="L1412">        return getUnitTypesWithAbility(Ability.REF_UNIT).stream()</span>
<span class="fc bfc" id="L1413" title="All 2 branches covered.">            .filter(ut -&gt; ut.isNaval() == naval)</span>
<span class="fc" id="L1414">            .collect(Collectors.toList());</span>
    }

    /**
     * Get a unit type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;UnitType&lt;/code&gt; found.
     */
    public UnitType getUnitType(String id) {
<span class="fc" id="L1424">        return getType(id, UnitType.class);</span>
    }

    // -- Founding Fathers --

    public List&lt;FoundingFather&gt; getFoundingFathers() {
<span class="fc" id="L1430">        return foundingFathers;</span>
    }

    /**
     * Get a founding father type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;FoundingFather&lt;/code&gt; found.
     */
    public FoundingFather getFoundingFather(String id) {
<span class="fc" id="L1440">        return getType(id, FoundingFather.class);</span>
    }

    // -- NationTypes --

    public List&lt;NationType&gt; getNationTypes() {
<span class="fc" id="L1446">        return nationTypes;</span>
    }

    public List&lt;EuropeanNationType&gt; getEuropeanNationTypes() {
<span class="fc" id="L1450">        return europeanNationTypes;</span>
    }

    public List&lt;EuropeanNationType&gt; getREFNationTypes() {
<span class="fc" id="L1454">        return REFNationTypes;</span>
    }

    public List&lt;IndianNationType&gt; getIndianNationTypes() {
<span class="fc" id="L1458">        return indianNationTypes;</span>
    }

    /**
     * Get a nation type by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;NationType&lt;/code&gt; found.
     */
    public NationType getNationType(String id) {
<span class="fc" id="L1468">        return getType(id, NationType.class);</span>
    }

    public NationType getDefaultNationType() {
<span class="nc" id="L1472">        return getNationType(&quot;model.nationType.default&quot;);</span>
    }


    // -- Nations --

    public List&lt;Nation&gt; getNations() {
<span class="fc" id="L1479">        return nations;</span>
    }

    public List&lt;Nation&gt; getEuropeanNations() {
<span class="fc" id="L1483">        return europeanNations;</span>
    }

    public List&lt;Nation&gt; getIndianNations() {
<span class="fc" id="L1487">        return indianNations;</span>
    }

    public List&lt;Nation&gt; getREFNations() {
<span class="fc" id="L1491">        return REFNations;</span>
    }

    /**
     * Get a nation by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;Nation&lt;/code&gt; found.
     */
    public Nation getNation(String id) {
<span class="fc" id="L1501">        return getType(id, Nation.class);</span>
    }

    /**
     * Clear all European advantages.  Implements the Advantages==NONE setting.
     */
    public void clearEuropeanNationalAdvantages() {
<span class="nc bnc" id="L1508" title="All 2 branches missed.">        for (Nation n : getEuropeanNations()) {</span>
<span class="nc" id="L1509">            n.setType(getDefaultNationType());</span>
<span class="nc" id="L1510">        }</span>
<span class="nc" id="L1511">    }</span>

    // -- Roles --

    public List&lt;Role&gt; getRoles() {
<span class="fc" id="L1516">        return roles;</span>
    }

    /**
     * Get a role by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;Role&lt;/code&gt; found.
     */
    public Role getRole(String id) {
<span class="fc" id="L1526">        return getType(id, Role.class);</span>
    }

    /**
     * Get the default role.
     *
     * @return The default &lt;code&gt;Role&lt;/code&gt;.
     */
    public Role getDefaultRole() {
<span class="fc" id="L1535">        return getRole(DEFAULT_ROLE_ID);</span>
    }

    /**
     * Get the military roles in this specification, in decreasing order
     * of effectiveness.
     *
     * @return An unmodifiable list of military &lt;code&gt;Role&lt;/code&gt;s.
     */
    public List&lt;Role&gt; getMilitaryRoles() {
<span class="fc bfc" id="L1545" title="All 2 branches covered.">        if (militaryRoles == null) {</span>
<span class="fc" id="L1546">            this.militaryRoles</span>
<span class="fc" id="L1547">                = Collections.&lt;Role&gt;unmodifiableList(roles.stream()</span>
<span class="fc" id="L1548">                    .filter(Role::isOffensive)</span>
<span class="fc" id="L1549">                    .sorted(Role.militaryComparator)</span>
<span class="fc" id="L1550">                    .collect(Collectors.toList()));</span>
        }
<span class="fc" id="L1552">        return militaryRoles;</span>
    }

    /**
     * Get a role with an ability.
     *
     * @param id The ability identifier to look for.
     * @param roles An optional list of &lt;code&gt;Role&lt;/code&gt;s to look in,
     *     if null all roles are used.
     * @return The first &lt;code&gt;Role&lt;/code&gt; found with the required
     *     ability, or null if none found.
     */
    public Role getRoleWithAbility(String id, List&lt;Role&gt; roles) {
<span class="fc" id="L1565">        return find(getRoles(), r -&gt; r.hasAbility(id));</span>
    }

    /**
     * Get the missionary role.
     *
     * @return The missionary &lt;code&gt;Role&lt;/code&gt;.
     */
    public Role getMissionaryRole() {
<span class="nc" id="L1574">        return getRoleWithAbility(Ability.ESTABLISH_MISSION, null);</span>
    }

    /**
     * Get the pioneer role.
     *
     * @return The pioneer &lt;code&gt;Role&lt;/code&gt;.
     */
    public Role getPioneerRole() {
<span class="nc" id="L1583">        return getRoleWithAbility(Ability.IMPROVE_TERRAIN, null);</span>
    }

    /**
     * Get the scout role.
     *
     * @return The scout &lt;code&gt;Role&lt;/code&gt;.
     */
    public Role getScoutRole() {
<span class="nc" id="L1592">        return getRoleWithAbility(Ability.SPEAK_WITH_CHIEF, null);</span>
    }

    /**
     * Gets the roles suitable for a REF unit.
     *
     * @param naval If true, choose roles for naval units, if not, land units.
     */
    public List&lt;Role&gt; getREFRoles(boolean naval) {
<span class="nc bnc" id="L1601" title="All 2 branches missed.">        return ((naval)</span>
<span class="nc" id="L1602">            ? Stream.of(getDefaultRole())</span>
<span class="nc" id="L1603">            : getMilitaryRoles().stream()</span>
<span class="nc" id="L1604">                .filter(r -&gt; r.requiresAbility(Ability.REF_UNIT)))</span>
<span class="nc" id="L1605">            .collect(Collectors.toList());</span>
    }


    // @compat 0.10.x -- EquipmentTypes --
    /**
     * Get an equipment type by identifier.
     * Still needed by backward compatibility code in Unit.readChild.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;EquipmentType&lt;/code&gt; found.
     */
    public EquipmentType getEquipmentType(String id) {
<span class="nc" id="L1618">        return getType(id, EquipmentType.class);</span>
    }
    // end @compat 0.10.x

    // -- DifficultyLevels --

    /**
     * Gets the difficulty levels in this specification.
     *
     * @return A list of difficulty levels in this specification.
     */
    public List&lt;OptionGroup&gt; getDifficultyLevels() {
<span class="fc" id="L1630">        List&lt;OptionGroup&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1631">        OptionGroup group = allOptionGroups.get(DIFFICULTY_LEVELS);</span>
<span class="pc bpc" id="L1632" title="1 of 2 branches missed.">        if (group != null) {</span>
<span class="fc bfc" id="L1633" title="All 2 branches covered.">            for (Option option : group.getOptions()) {</span>
<span class="pc bpc" id="L1634" title="1 of 2 branches missed.">                if (option instanceof OptionGroup) {</span>
<span class="fc" id="L1635">                    result.add((OptionGroup) option);</span>
                }
<span class="fc" id="L1637">            }</span>
        }
<span class="fc" id="L1639">        return result;</span>
    }

    /**
     * Get the current difficulty level.
     *
     * @return The difficulty level.
     */
    public String getDifficultyLevel() {
<span class="nc" id="L1648">        return this.difficultyLevel;</span>
    }

    /**
     * Gets the current difficulty level options.
     *
     * @return The current difficulty level &lt;code&gt;OptionGroup&lt;/code&gt;.
     */
    public OptionGroup getDifficultyOptionGroup() {
<span class="fc" id="L1657">        return allOptionGroups.get(this.difficultyLevel);</span>
    }

    /**
     * Gets difficulty level options by id.
     *
     * @param id The id to look for.
     * @return The corresponding difficulty level
     *     &lt;code&gt;OptionGroup&lt;/code&gt;, if any.
     */
    public OptionGroup getDifficultyOptionGroup(String id) {
<span class="fc" id="L1668">        return allOptionGroups.get(id);</span>
    }

    /**
     * Applies the difficulty level identified by the given String to
     * the current specification.
     *
     * @param difficulty The identifier of a difficulty level to apply.
     */
    public void applyDifficultyLevel(String difficulty) {
<span class="fc" id="L1678">        applyDifficultyLevel(getDifficultyOptionGroup(difficulty));</span>
<span class="fc" id="L1679">    }</span>

    /**
     * Applies the given difficulty level to the current
     * specification.
     *
     * @param level The difficulty level &lt;code&gt;OptionGroup&lt;/code&gt; to apply.
     */
    public void applyDifficultyLevel(OptionGroup level) {
<span class="pc bpc" id="L1688" title="1 of 2 branches missed.">        if (level == null) {</span>
<span class="nc" id="L1689">            logger.warning(&quot;Null difficulty level supplied&quot;);</span>
<span class="nc" id="L1690">            return;</span>
        }
<span class="fc" id="L1692">        logger.info(&quot;Applying difficulty level &quot; + level.getId());</span>
<span class="fc" id="L1693">        addOptionGroup(level, true);</span>
<span class="fc" id="L1694">        this.difficultyLevel = level.getId();</span>
<span class="fc" id="L1695">    }</span>

    public OptionGroup getGameOptions() {
<span class="fc" id="L1698">        return getOptionGroup(GameOptions.getXMLElementTagName());</span>
    }

    public void setGameOptions(OptionGroup go) {
<span class="nc" id="L1702">        allOptionGroups.put(GameOptions.getXMLElementTagName(), go);</span>
<span class="nc" id="L1703">        addOptionGroup(go, true);</span>
<span class="nc" id="L1704">    }</span>

    public OptionGroup getMapGeneratorOptions() {
<span class="fc" id="L1707">        return getOptionGroup(MapGeneratorOptions.getXMLElementTagName());</span>
    }

    public void setMapGeneratorOptions(OptionGroup mgo) {
<span class="nc" id="L1711">        allOptionGroups.put(MapGeneratorOptions.getXMLElementTagName(), mgo);</span>
<span class="nc" id="L1712">        addOptionGroup(mgo, true);</span>
<span class="nc" id="L1713">    }</span>


    // -- Events --

    public List&lt;Event&gt; getEvents() {
<span class="nc" id="L1719">        return events;</span>
    }

    /**
     * Get an event by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;Event&lt;/code&gt; found.
     */
    public Event getEvent(String id) {
<span class="fc" id="L1729">        return getType(id, Event.class);</span>
    }

    // -- Disasters --

    public List&lt;Disaster&gt; getDisasters() {
<span class="nc" id="L1735">        return disasters;</span>
    }

    /**
     * Get a disaster by identifier.
     *
     * @param id The object identifier.
     * @return The &lt;code&gt;Disaster&lt;/code&gt; found.
     */
    public Disaster getDisaster(String id) {
<span class="fc" id="L1745">        return getType(id, Disaster.class);</span>
    }

    // -- Ages --

    /**
     * Gets the age corresponding to a given turn.
     *
     * @param turn The &lt;code&gt;Turn&lt;/code&gt; to check.
     * @return The age of the given turn.
     */
    public int getAge(Turn turn) {
<span class="fc" id="L1757">        int n = turn.getNumber();</span>
<span class="pc bpc" id="L1758" title="1 of 6 branches missed.">        return (n &lt; ages[0]) ? -1</span>
            : (n &lt; ages[1]) ? 0
            : (n &lt; ages[2]) ? 1
            : 2;
    }        


    // General type retrieval

    /**
     * Get the &lt;code&gt;FreeColGameObjectType&lt;/code&gt; with the given identifier.
     *
     * @param id The object identifier to look for.
     * @param type The expected &lt;code&gt;Class&lt;/code&gt;.
     * @return The &lt;code&gt;FreeColGameObjectType&lt;/code&gt; found.
     */
    public &lt;T extends FreeColGameObjectType&gt; T getType(String id, Class&lt;T&gt; type) {
<span class="fc" id="L1775">        FreeColGameObjectType o = findType(id);</span>
<span class="fc bfc" id="L1776" title="All 2 branches covered.">        if (o != null) {</span>
<span class="fc" id="L1777">            return type.cast(allTypes.get(id));</span>

<span class="fc bfc" id="L1779" title="All 2 branches covered.">        } else if (initialized) {</span>
<span class="fc" id="L1780">            throw new IllegalArgumentException(&quot;Undefined FCGOT: &quot; + id);</span>

        } else { // forward declaration of new type
            try {
<span class="fc" id="L1784">                Constructor&lt;T&gt; c = type.getConstructor(String.class,</span>
                                                       Specification.class);
<span class="fc" id="L1786">                T result = c.newInstance(id, this);</span>
<span class="fc" id="L1787">                allTypes.put(id, result);</span>
<span class="fc" id="L1788">                return result;</span>
<span class="nc" id="L1789">            } catch (Exception e) {</span>
<span class="nc" id="L1790">                logger.log(Level.WARNING, &quot;Could not construct: &quot; + id, e);</span>
            }
        }
<span class="nc" id="L1793">        return null;</span>
    }

    /**
     * Find a &lt;code&gt;FreeColGameObjectType&lt;/code&gt; by id.
     *
     * @param id The identifier to look for, which must not be null.
     * @return The &lt;code&gt;FreeColGameObjectType&lt;/code&gt; found if any.
     */
    public FreeColGameObjectType findType(String id) throws IllegalArgumentException {
<span class="pc bpc" id="L1803" title="1 of 2 branches missed.">        if (id == null) {</span>
<span class="nc" id="L1804">            throw new IllegalArgumentException(&quot;Null id&quot;);</span>

<span class="fc bfc" id="L1806" title="All 2 branches covered.">        } else if (allTypes.containsKey(id)) {</span>
<span class="fc" id="L1807">            return allTypes.get(id);</span>

        } else {
<span class="fc" id="L1810">            return null;</span>
        }
    }

    /**
     * Get the FreeColGameObjectTypes that provide the required ability.
     *
     * @param id The object identifier.
     * @param value The ability value to check.
     * @return A list of &lt;code&gt;FreeColGameObjectType&lt;/code&gt;s that
     *     provide the required ability.
     */
    public List&lt;FreeColGameObjectType&gt; getTypesProviding(String id,
                                                         boolean value) {
<span class="nc" id="L1824">        List&lt;FreeColGameObjectType&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1825" title="All 2 branches missed.">        for (Ability ability : getAbilities(id)) {</span>
<span class="nc bnc" id="L1826" title="All 2 branches missed.">            if (ability.getValue() == value</span>
<span class="nc bnc" id="L1827" title="All 2 branches missed.">                &amp;&amp; ability.getSource() instanceof FreeColGameObjectType) {</span>
<span class="nc" id="L1828">                result.add((FreeColGameObjectType) ability.getSource());</span>
            }
<span class="nc" id="L1830">        }</span>
<span class="nc" id="L1831">        return result;</span>
    }

    /**
     * Get all types which have any of the given abilities.
     *
     * @param abilities The abilities for the search
     * @return A list of &lt;code&gt;FreeColGameObjectType&lt;/code&gt;s with at
     *     least one of the given abilities.
     */
    public &lt;T extends FreeColGameObjectType&gt; List&lt;T&gt;
                      getTypesWithAbility(Class&lt;T&gt; resultType,
                                          String... abilities) {
<span class="fc" id="L1844">        return allTypes.values().stream()</span>
<span class="fc bfc" id="L1845" title="All 2 branches covered.">            .filter(type -&gt; resultType.isInstance(type)</span>
<span class="fc bfc" id="L1846" title="All 2 branches covered.">                &amp;&amp; any(abilities, a -&gt; type.hasAbility(a)))</span>
<span class="fc" id="L1847">            .map(type -&gt; resultType.cast(type))</span>
<span class="fc" id="L1848">            .collect(Collectors.toList());</span>
    }

    /**
     * Get all types which have none of the given abilities.
     *
     * @param abilities The abilities for the search
     * @return A list of &lt;code&gt;FreeColGameObjectType&lt;/code&gt;s without the
     *     given abilities.
     */
    public &lt;T extends FreeColGameObjectType&gt; List&lt;T&gt;
                      getTypesWithoutAbility(Class&lt;T&gt; resultType,
                                             String... abilities) {
<span class="fc" id="L1861">        return allTypes.values().stream()</span>
<span class="fc bfc" id="L1862" title="All 2 branches covered.">            .filter(type -&gt; resultType.isInstance(type)</span>
<span class="fc bfc" id="L1863" title="All 2 branches covered.">                &amp;&amp; none(abilities, a -&gt; type.hasAbility(a)))</span>
<span class="fc" id="L1864">            .map(type -&gt; resultType.cast(type))</span>
<span class="fc" id="L1865">            .collect(Collectors.toList());</span>
    }


    // Backward compatibility fixes.
    // We do not pretend to fix everything, some specs are just too broken,
    // or some changes too radical.  But we make an effort.

    /**
     * Apply all the special fixes to bring older specifications up to date.
     */
    private void applyFixes() {
<span class="fc" id="L1877">        fixDifficultyOptions();</span>
<span class="fc" id="L1878">        fixGameOptions();</span>
<span class="fc" id="L1879">        fixMapGeneratorOptions();</span>
<span class="fc" id="L1880">        fixSpec();</span>
<span class="fc" id="L1881">    }</span>

    // @compat 0.10.x
    /**
     * Handle the reworking of roles that landed in 0.11.0.
     *
     * Deliberately not part of applyFixes(), this is called from readFromXML
     * which can most accurately determine whether it is needed.
     */
    private void fixRoles() {
        boolean zero10X;
        try {
<span class="pc bpc" id="L1893" title="1 of 2 branches missed.">            zero10X = Double.parseDouble(version) &lt; 0.86;</span>
<span class="nc" id="L1894">        } catch (Exception e) {</span>
<span class="nc" id="L1895">            zero10X = true;</span>
<span class="fc" id="L1896">        }</span>
<span class="pc bpc" id="L1897" title="1 of 2 branches missed.">        if (!zero10X) return;</span>
<span class="fc" id="L1898">        File base = FreeColDirectories.getBaseDirectory();</span>
<span class="fc" id="L1899">        File rolf = new File(base, ROLES_COMPAT_FILE_NAME); </span>
<span class="pc" id="L1900">        try (</span>
<span class="fc" id="L1901">            FileInputStream fis = new FileInputStream(rolf);</span>
        ) {
<span class="fc" id="L1903">            load(fis);</span>
<span class="pc bpc" id="L1904" title="6 of 8 branches missed.">        } catch (Exception e) {</span>
<span class="nc" id="L1905">            logger.log(Level.WARNING, &quot;Failed to load remedial roles.&quot;, e);</span>
<span class="nc" id="L1906">            return;</span>
<span class="fc" id="L1907">        }</span>

<span class="fc" id="L1909">        logger.info(&quot;Loading role backward compatibility fragment: &quot;</span>
            + ROLES_COMPAT_FILE_NAME + &quot; with roles: &quot;
<span class="fc" id="L1911">            + getRoles().stream()</span>
<span class="fc" id="L1912">                .map(Role::getId).collect(Collectors.joining()));</span>
<span class="fc" id="L1913">    }</span>
    // end @compat 0.10.x

    /**
     * Specification backward compatibility for the spec in general.
     */
    private void fixSpec() {
        // @compat 0.10.0
<span class="pc bpc" id="L1921" title="1 of 2 branches missed.">        if (getModifiers(Modifier.SHIP_TRADE_PENALTY) == null) {</span>
<span class="nc" id="L1922">            addModifier(new Modifier(Modifier.SHIP_TRADE_PENALTY,</span>
                                     -30.0f, Modifier.ModifierType.PERCENTAGE,
                                     Specification.SHIP_TRADE_PENALTY_SOURCE));
        }
        // end @compat

        // @compat 0.10.7
        // model.ability.missionary was split into distinct parts,
        // which should be fixed by the roles work, but the Brebeuf
        // scope was left hanging.
<span class="fc" id="L1932">        FoundingFather brebeuf</span>
<span class="fc" id="L1933">            = getFoundingFather(&quot;model.foundingFather.fatherJeanDeBrebeuf&quot;);</span>
<span class="fc bfc" id="L1934" title="All 2 branches covered.">        for (Ability ability : brebeuf.getAbilities()) {</span>
<span class="fc bfc" id="L1935" title="All 2 branches covered.">            for (Scope scope : ability.getScopes()) {</span>
<span class="pc bpc" id="L1936" title="1 of 2 branches missed.">                if (&quot;model.ability.missionary&quot;.equals(scope.getAbilityId())) {</span>
<span class="nc" id="L1937">                    scope.setAbilityId(Ability.ESTABLISH_MISSION);</span>
                }
<span class="fc" id="L1939">            }</span>
<span class="fc" id="L1940">        }</span>

        // Coronado gained an ability in freecol
<span class="fc" id="L1943">        FoundingFather coronado</span>
<span class="fc" id="L1944">            = getFoundingFather(&quot;model.foundingFather.franciscoDeCoronado&quot;);</span>
<span class="fc bfc" id="L1945" title="All 2 branches covered.">        if (&quot;freecol&quot;.equals(getId())</span>
<span class="pc bpc" id="L1946" title="1 of 2 branches missed.">            &amp;&amp; !coronado.hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
<span class="nc" id="L1947">            coronado.addAbility(new Ability(Ability.SEE_ALL_COLONIES,</span>
                                            coronado, true));
        }

        // Require the scopes added to founding fathers in git.8971674
<span class="fc" id="L1952">        fatherGoodsFixMap.clear();</span>
<span class="fc" id="L1953">        fatherGoodsFixMap.put(&quot;model.foundingFather.thomasJefferson&quot;,</span>
                              &quot;model.goods.bells&quot;);
<span class="fc" id="L1955">        fatherGoodsFixMap.put(&quot;model.foundingFather.thomasPaine&quot;,</span>
                              &quot;model.goods.bells&quot;);
<span class="fc" id="L1957">        fatherGoodsFixMap.put(&quot;model.foundingFather.williamPenn&quot;,</span>
                              &quot;model.goods.crosses&quot;);
<span class="fc bfc" id="L1959" title="All 2 branches covered.">        for (Entry&lt;String, String&gt; e : fatherGoodsFixMap.entrySet()) {</span>
<span class="fc" id="L1960">            FoundingFather father = getFoundingFather(e.getKey());</span>
<span class="fc bfc" id="L1961" title="All 2 branches covered.">            for (Modifier m : father.getModifiers(e.getValue())) {</span>
<span class="fc" id="L1962">                m.requireNegatedPersonScope();</span>
<span class="fc" id="L1963">            }</span>
<span class="fc" id="L1964">        }</span>

        // Nation FOUND_COLONY -&gt; FOUNDS_COLONIES
<span class="fc bfc" id="L1967" title="All 2 branches covered.">        for (EuropeanNationType ent : europeanNationTypes) {</span>
<span class="pc bpc" id="L1968" title="1 of 2 branches missed.">            if (ent.hasAbility(Ability.FOUND_COLONY)) {</span>
<span class="nc" id="L1969">                ent.removeAbilities(Ability.FOUND_COLONY);</span>
<span class="nc" id="L1970">                ent.addAbility(new Ability(Ability.FOUNDS_COLONIES, ent, true));</span>
            }
<span class="fc" id="L1972">        }</span>

        // Fix REF roles, soldier -&gt; infantry, dragoon -&gt; cavalry
        // Older specs (&lt;= 0.10.5 ?) had refSize directly under difficulty
        // level, later moved it under the monarch group.
<span class="fc bfc" id="L1977" title="All 2 branches covered.">        for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L1978">            Option monarch = level.getOption(GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L1979" title="1 of 2 branches missed.">            Option refSize = ((OptionGroup)((monarch instanceof OptionGroup)</span>
<span class="fc" id="L1980">                    ? monarch : level)).getOption(GameOptions.REF_FORCE);</span>
<span class="pc bpc" id="L1981" title="2 of 4 branches missed.">            if (refSize == null</span>
<span class="nc" id="L1982">                || !(refSize instanceof UnitListOption)) continue;</span>
            for (AbstractUnit au
<span class="fc bfc" id="L1984" title="All 2 branches covered.">                     : ((UnitListOption)refSize).getOptionValues()) {</span>
<span class="pc bpc" id="L1985" title="1 of 2 branches missed.">                if (&quot;DEFAULT&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L1986">                    au.setRoleId(DEFAULT_ROLE_ID);</span>
<span class="pc bpc" id="L1987" title="1 of 2 branches missed.">                } else if (&quot;model.role.soldier&quot;.equals(au.getRoleId())</span>
<span class="pc bpc" id="L1988" title="1 of 2 branches missed.">                    || &quot;SOLDIER&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L1989">                    au.setRoleId(&quot;model.role.infantry&quot;);</span>
<span class="pc bpc" id="L1990" title="1 of 2 branches missed.">                } else if (&quot;model.role.dragoon&quot;.equals(au.getRoleId())</span>
<span class="pc bpc" id="L1991" title="1 of 2 branches missed.">                    || &quot;DRAGOON&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L1992">                    au.setRoleId(&quot;model.role.cavalry&quot;);</span>
                }
<span class="fc" id="L1994">            }</span>
<span class="fc" id="L1995">        }</span>

        // Fix all other UnitListOptions
<span class="fc" id="L1998">        List&lt;Option&gt; todo = new ArrayList&lt;&gt;(getDifficultyLevels());</span>
<span class="fc bfc" id="L1999" title="All 2 branches covered.">        while (!todo.isEmpty()) {</span>
<span class="fc" id="L2000">            Option o = todo.remove(0);</span>
<span class="fc bfc" id="L2001" title="All 2 branches covered.">            if (o instanceof OptionGroup) {</span>
<span class="fc" id="L2002">                List&lt;Option&gt; next = ((OptionGroup)o).getOptions();</span>
<span class="fc" id="L2003">                todo.addAll(new ArrayList&lt;&gt;(next));</span>
<span class="fc bfc" id="L2004" title="All 2 branches covered.">            } else if (o instanceof UnitListOption) {</span>
<span class="fc bfc" id="L2005" title="All 2 branches covered.">                for (AbstractUnit au : ((UnitListOption)o).getOptionValues()) {</span>
<span class="fc" id="L2006">                    String roleId = au.getRoleId();</span>
<span class="pc bpc" id="L2007" title="1 of 2 branches missed.">                    if (roleId == null) {</span>
<span class="nc" id="L2008">                        au.setRoleId(DEFAULT_ROLE_ID);</span>
<span class="pc bpc" id="L2009" title="1 of 2 branches missed.">                    } else if (au.getRoleId().startsWith(&quot;model.role.&quot;)) {</span>
                        ; // OK
<span class="nc bnc" id="L2011" title="All 2 branches missed.">                    } else if (&quot;DEFAULT&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2012">                        au.setRoleId(DEFAULT_ROLE_ID);</span>
<span class="nc bnc" id="L2013" title="All 2 branches missed.">                    } else if (&quot;DRAGOON&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2014">                        au.setRoleId(&quot;model.role.dragoon&quot;);</span>
<span class="nc bnc" id="L2015" title="All 2 branches missed.">                    } else if (&quot;MISSIONARY&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2016">                        au.setRoleId(&quot;model.role.missionary&quot;);</span>
<span class="nc bnc" id="L2017" title="All 2 branches missed.">                    } else if (&quot;PIONEER&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2018">                        au.setRoleId(&quot;model.role.pioneer&quot;);</span>
<span class="nc bnc" id="L2019" title="All 2 branches missed.">                    } else if (&quot;MISSIONARY&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2020">                        au.setRoleId(&quot;model.role.missionary&quot;);</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">                    } else if (&quot;SCOUT&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2022">                        au.setRoleId(&quot;model.role.scout&quot;);</span>
<span class="nc bnc" id="L2023" title="All 2 branches missed.">                    } else if (&quot;SOLDIER&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L2024">                        au.setRoleId(&quot;model.role.soldier&quot;);</span>
                    } else {
<span class="nc" id="L2026">                        au.setRoleId(DEFAULT_ROLE_ID);</span>
                    }
<span class="fc" id="L2028">                }</span>
            }
<span class="fc" id="L2030">        }</span>

        // The REF is also an independent nation, which is a required
        // ability to have man-o-war.  Older specs used
        // INDEPENDENCE_DECLARED but we can not directly use that or
        // the REF gets access to colonialRegulars.
<span class="fc bfc" id="L2036" title="All 2 branches covered.">        for (NationType nt : europeanNationTypes) {</span>
<span class="fc bfc" id="L2037" title="All 2 branches covered.">            if (!nt.isREF()) continue;</span>
<span class="pc bpc" id="L2038" title="1 of 2 branches missed.">            if (!nt.hasAbility(Ability.INDEPENDENT_NATION)) {</span>
<span class="nc" id="L2039">                nt.addAbility(new Ability(Ability.INDEPENDENT_NATION));</span>
            }
<span class="fc" id="L2041">        }</span>

        // Resource type modifiers had the wrong priority
<span class="fc bfc" id="L2044" title="All 2 branches covered.">        for (ResourceType rt : resourceTypeList) {</span>
<span class="fc bfc" id="L2045" title="All 2 branches covered.">            for (Modifier m : rt.getModifiers()) {</span>
<span class="fc" id="L2046">                m.setModifierIndex(Modifier.RESOURCE_PRODUCTION_INDEX);</span>
<span class="fc" id="L2047">            }</span>
<span class="fc" id="L2048">        }</span>

        // Unit type indexes moved into the spec
<span class="fc bfc" id="L2051" title="All 2 branches covered.">        for (UnitType ut : unitTypeList) {</span>
<span class="fc bfc" id="L2052" title="All 2 branches covered.">            for (Modifier m : ut.getModifiers()) {</span>
<span class="fc bfc" id="L2053" title="All 2 branches covered.">                if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2054">                    m.setModifierIndex(Modifier.EXPERT_PRODUCTION_INDEX);</span>
                }
<span class="fc" id="L2056">            }</span>
<span class="fc" id="L2057">        }</span>

        // Father production modifiers have moved to the spec
<span class="fc bfc" id="L2060" title="All 2 branches covered.">        for (FoundingFather ff : foundingFathers) {</span>
<span class="fc bfc" id="L2061" title="All 2 branches covered.">            for (Modifier m : ff.getModifiers()) {</span>
<span class="fc bfc" id="L2062" title="All 2 branches covered.">                if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2063">                    m.setModifierIndex(Modifier.FATHER_PRODUCTION_INDEX);</span>
                }
<span class="fc" id="L2065">            }</span>
<span class="fc" id="L2066">        }</span>

        // Tile improvement type modifier index has moved to the spec
<span class="fc bfc" id="L2069" title="All 2 branches covered.">        for (TileImprovementType ti : tileImprovementTypeList) {</span>
<span class="fc bfc" id="L2070" title="All 2 branches covered.">            for (Modifier m : ti.getModifiers()) {</span>
<span class="pc bpc" id="L2071" title="1 of 2 branches missed.">                if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2072">                    m.setModifierIndex(Modifier.IMPROVEMENT_PRODUCTION_INDEX);</span>
                }
<span class="fc" id="L2074">            }</span>
<span class="fc" id="L2075">        }</span>

        // Building type modifier indexes have moved to the spec
<span class="fc bfc" id="L2078" title="All 2 branches covered.">        for (BuildingType bt : buildingTypeList) {</span>
<span class="fc bfc" id="L2079" title="All 2 branches covered.">            for (Modifier m : bt.getModifiers()) {</span>
<span class="fc bfc" id="L2080" title="All 2 branches covered.">                if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc bfc" id="L2081" title="All 2 branches covered.">                    m.setModifierIndex((bt.hasAbility(Ability.AUTO_PRODUCTION))</span>
                        ? Modifier.AUTO_PRODUCTION_INDEX
                        : Modifier.BUILDING_PRODUCTION_INDEX);
                }
<span class="fc" id="L2085">            }</span>
<span class="fc" id="L2086">        }</span>

        // European nation type production modifier indexes moved to the spec
<span class="fc bfc" id="L2089" title="All 2 branches covered.">        for (EuropeanNationType et : europeanNationTypes) {</span>
<span class="fc bfc" id="L2090" title="All 2 branches covered.">            for (Modifier m : et.getModifiers()) {</span>
<span class="fc bfc" id="L2091" title="All 2 branches covered.">                if (allTypes.get(m.getId()) instanceof GoodsType) {</span>
<span class="fc" id="L2092">                    m.setModifierIndex(Modifier.NATION_PRODUCTION_INDEX);</span>
                }
<span class="fc" id="L2094">            }</span>
<span class="fc" id="L2095">        }</span>

        // TownHall, Chapel et al now have unattended production types
        // (replacing modifiers).
<span class="fc" id="L2099">        BuildingType townHallType = getBuildingType(&quot;model.building.townHall&quot;);</span>
<span class="pc bpc" id="L2100" title="1 of 2 branches missed.">        if (townHallType.hasModifier(&quot;model.goods.bells&quot;)) {</span>
<span class="nc" id="L2101">            GoodsType bellsType = getGoodsType(&quot;model.goods.bells&quot;);</span>
<span class="nc" id="L2102">            AbstractGoods ag = new AbstractGoods(bellsType, 1);</span>
<span class="nc" id="L2103">            ProductionType pt = new ProductionType(ag, true, null);</span>
<span class="nc" id="L2104">            townHallType.addProductionType(pt);</span>
<span class="nc" id="L2105">            townHallType.removeModifiers(&quot;model.goods.bells&quot;);</span>
<span class="nc" id="L2106">            logger.info(&quot;Added backward compatibility production &quot; + pt</span>
                + &quot; to &quot; + townHallType);
        }
<span class="fc" id="L2109">        GoodsType crossesType = getGoodsType(&quot;model.goods.crosses&quot;);</span>
<span class="fc" id="L2110">        int a = 1;</span>
<span class="fc bfc" id="L2111" title="All 2 branches covered.">        for (BuildingType bt : new BuildingType[] {</span>
<span class="fc" id="L2112">                getBuildingType(&quot;model.building.chapel&quot;),</span>
<span class="fc" id="L2113">                getBuildingType(&quot;model.building.church&quot;),</span>
<span class="fc" id="L2114">                getBuildingType(&quot;model.building.cathedral&quot;) }) {</span>
<span class="pc bpc" id="L2115" title="1 of 2 branches missed.">            if (bt.hasModifier(&quot;model.goods.crosses&quot;)) {</span>
<span class="nc" id="L2116">                AbstractGoods ag = new AbstractGoods(crossesType, a);</span>
<span class="nc" id="L2117">                a++;</span>
<span class="nc" id="L2118">                ProductionType pt = new ProductionType(ag, true, null);</span>
<span class="nc" id="L2119">                bt.addProductionType(pt);</span>
<span class="nc" id="L2120">                bt.removeModifiers(&quot;model.goods.crosses&quot;);</span>
<span class="nc" id="L2121">                logger.info(&quot;Added backward compatibility production &quot; + pt</span>
                    + &quot; to &quot; + bt);
            }
        }
        // Country and stables production is now defined as unattended.
<span class="fc bfc" id="L2126" title="All 2 branches covered.">        for (BuildingType bt : new BuildingType[] {</span>
<span class="fc" id="L2127">                getBuildingType(&quot;model.building.country&quot;),</span>
<span class="fc" id="L2128">                getBuildingType(&quot;model.building.stables&quot;) }) {</span>
<span class="pc bpc" id="L2129" title="1 of 2 branches missed.">            for (ProductionType pt : bt.getAvailableProductionTypes(false)) {</span>
<span class="nc" id="L2130">                pt.setUnattended(true);</span>
<span class="nc" id="L2131">                logger.info(&quot;Switched production &quot; + pt</span>
                    + &quot; to unattended at &quot; + bt);
<span class="nc" id="L2133">            }</span>
        }

        // 0.10.x had no unknown enemy nation, just an unknown enemy player
<span class="pc bpc" id="L2137" title="1 of 2 branches missed.">        if (getNation(Nation.UNKNOWN_NATION_ID) == null) {</span>
<span class="nc" id="L2138">            Nation ue = new Nation(Nation.UNKNOWN_NATION_ID, this);</span>
<span class="nc" id="L2139">            ue.setColor(Nation.UNKNOWN_NATION_COLOR);</span>
        }

        // Ambush terrain ability not present in older specs.
<span class="pc bpc" id="L2143" title="1 of 2 branches missed.">        if (getAbilities(Ability.AMBUSH_TERRAIN) == null) {</span>
<span class="nc" id="L2144">            Ability ambush = new Ability(Ability.AMBUSH_TERRAIN, null, true);</span>
<span class="nc" id="L2145">            addAbility(ambush);</span>
<span class="nc bnc" id="L2146" title="All 2 branches missed.">            for (TileType tt : getTileTypeList()) {</span>
<span class="nc bnc" id="L2147" title="All 4 branches missed.">                if ((tt.isElevation() || tt.isForested())</span>
<span class="nc bnc" id="L2148" title="All 2 branches missed.">                    &amp;&amp; !tt.hasAbility(Ability.AMBUSH_TERRAIN)) {</span>
<span class="nc" id="L2149">                    tt.addAbility(new Ability(Ability.AMBUSH_TERRAIN, tt, true));</span>
                }
<span class="nc" id="L2151">            }</span>
        }

        // is-military was added to goods type
<span class="fc" id="L2155">        GoodsType goodsType = getGoodsType(&quot;model.goods.horses&quot;);</span>
<span class="fc" id="L2156">        goodsType.setMilitary();</span>
<span class="fc" id="L2157">        goodsType = getGoodsType(&quot;model.goods.muskets&quot;);</span>
<span class="fc" id="L2158">        goodsType.setMilitary();</span>

        // automaticEquipment scope types are now roles
<span class="fc bfc" id="L2161" title="All 2 branches covered.">        for (NationType nt : indianNationTypes) {</span>
<span class="fc bfc" id="L2162" title="All 2 branches covered.">            for (Ability ability : nt.getAbilities(Ability.AUTOMATIC_EQUIPMENT)) {</span>
<span class="fc bfc" id="L2163" title="All 2 branches covered.">                for (Scope scope : ability.getScopes()) {</span>
<span class="fc" id="L2164">                    String type = scope.getType();</span>
<span class="pc bpc" id="L2165" title="1 of 2 branches missed.">                    if (&quot;model.equipment.indian.muskets&quot;.equals(type)) {</span>
<span class="nc" id="L2166">                        scope.setType(&quot;model.role.nativeDragoon&quot;);</span>
<span class="pc bpc" id="L2167" title="1 of 2 branches missed.">                    } else if (&quot;model.equipment.indian.horses&quot;.equals(type)) {</span>
<span class="nc" id="L2168">                        scope.setType(&quot;model.role.armedBrave&quot;);</span>
                    }
<span class="fc" id="L2170">                }</span>
<span class="fc" id="L2171">            }</span>
<span class="fc" id="L2172">        }</span>
        {
<span class="fc" id="L2174">            FoundingFather revere</span>
<span class="fc" id="L2175">                = getFoundingFather(&quot;model.foundingFather.paulRevere&quot;);</span>
<span class="fc bfc" id="L2176" title="All 2 branches covered.">            for (Ability ability : revere.getAbilities(Ability.AUTOMATIC_EQUIPMENT)) {</span>
<span class="fc bfc" id="L2177" title="All 2 branches covered.">                for (Scope scope : ability.getScopes()) {</span>
<span class="fc" id="L2178">                    String type = scope.getType();</span>
<span class="pc bpc" id="L2179" title="1 of 2 branches missed.">                    if (&quot;model.equipment.muskets&quot;.equals(type)) {</span>
<span class="nc" id="L2180">                        scope.setType(&quot;model.role.soldier&quot;);</span>
                    }
<span class="fc" id="L2182">                }</span>
<span class="fc" id="L2183">            }</span>
        }
        // end @compat 0.10.7

        // @compat 0.11.0
        // Bolivar changed from being an event, then to a liberty modifier,
        // and now to a SoL% modifier.
<span class="fc" id="L2190">        FoundingFather bolivar</span>
<span class="fc" id="L2191">            = getFoundingFather(&quot;model.foundingFather.simonBolivar&quot;);</span>
<span class="fc" id="L2192">        boolean bolivarAdd = false;</span>
<span class="pc bpc" id="L2193" title="1 of 2 branches missed.">        if (!bolivar.getEvents().isEmpty()) {</span>
<span class="nc" id="L2194">            bolivar.setEvents(Collections.&lt;Event&gt;emptyList());</span>
<span class="nc" id="L2195">            bolivarAdd = true;</span>
<span class="pc bpc" id="L2196" title="1 of 2 branches missed.">        } else if (bolivar.hasModifier(Modifier.LIBERTY)) {</span>
<span class="nc" id="L2197">            bolivar.removeModifiers(Modifier.LIBERTY);</span>
<span class="nc" id="L2198">            bolivarAdd = true;</span>
        }
<span class="pc bpc" id="L2200" title="1 of 2 branches missed.">        if (bolivarAdd) {</span>
<span class="nc" id="L2201">            bolivar.addModifier(new Modifier(Modifier.SOL, 20,</span>
                    Modifier.ModifierType.ADDITIVE, bolivar, 0));
        }

        // The COASTAL_ONLY attribute was added to customs house.
<span class="fc" id="L2206">        BuildingType customs = getBuildingType(&quot;model.building.customHouse&quot;);</span>
<span class="pc bpc" id="L2207" title="1 of 2 branches missed.">        if (!customs.hasAbility(Ability.COASTAL_ONLY)) {</span>
<span class="fc" id="L2208">            customs.addAbility(new Ability(Ability.COASTAL_ONLY, null, false));</span>
        }
        // end @compat 0.11.0

        // @compat 0.11.3
        // Added the cargo penalty modifier
<span class="pc bpc" id="L2214" title="1 of 2 branches missed.">        if (getModifiers(Modifier.CARGO_PENALTY).isEmpty()) {</span>
<span class="nc" id="L2215">            addModifier(new Modifier(Modifier.CARGO_PENALTY, -12.5f,</span>
                    Modifier.ModifierType.PERCENTAGE, CARGO_PENALTY_SOURCE,
                    Modifier.GENERAL_COMBAT_INDEX));
        }

        // Backwards compatibility for the fixes to BR#2873.
<span class="fc" id="L2221">        Event event = getEvent(&quot;model.event.declareIndependence&quot;);</span>
<span class="pc bpc" id="L2222" title="1 of 2 branches missed.">        if (event != null) {</span>
<span class="fc" id="L2223">            Limit limit = event.getLimit(&quot;model.limit.independence.coastalColonies&quot;);</span>
<span class="pc bpc" id="L2224" title="1 of 2 branches missed.">            if (limit != null) {</span>
<span class="fc" id="L2225">                limit.setOperator(Limit.Operator.GE);</span>
<span class="fc" id="L2226">                limit.getRightHandSide().setValue(1);</span>
            }
        }
        // end @compat 0.11.3

        // @compat 0.11.5
        // Added a modifier to hardy pioneer
<span class="fc" id="L2233">        UnitType hardyPioneer = getUnitType(&quot;model.unit.hardyPioneer&quot;);</span>
<span class="fc" id="L2234">        if (hardyPioneer.getModifiers(Modifier.TILE_TYPE_CHANGE_PRODUCTION)</span>
<span class="pc bpc" id="L2235" title="1 of 2 branches missed.">            .isEmpty()) {</span>
<span class="nc" id="L2236">            Modifier m = new Modifier(Modifier.TILE_TYPE_CHANGE_PRODUCTION,</span>
                2.0f, Modifier.ModifierType.MULTIPLICATIVE);
<span class="nc" id="L2238">            Scope scope = new Scope();</span>
<span class="nc" id="L2239">            scope.setType(&quot;model.goods.lumber&quot;);</span>
<span class="nc" id="L2240">            m.addScope(scope);</span>
<span class="nc" id="L2241">            hardyPioneer.addModifier(m);</span>
        }

        // Added modifier to Coronado
<span class="fc bfc" id="L2245" title="All 2 branches covered.">        if (!coronado.hasModifier(Modifier.EXPOSED_TILES_RADIUS)) {</span>
<span class="fc" id="L2246">            coronado.addModifier(new Modifier(Modifier.EXPOSED_TILES_RADIUS,</span>
                    3.0f, Modifier.ModifierType.ADDITIVE, coronado, 0));
        }
        // end @compat 0.11.5
<span class="fc" id="L2250">    }</span>

    /**
     * Backward compatibility code to make sure this specification
     * contains a default value for every difficulty option.
     *
     * When a new difficulty option is added to the spec, add a
     * sensible default here.
     *
     * @return True if an option was missing and added.
     */
    private boolean fixDifficultyOptions() {
<span class="fc" id="L2262">        boolean ret = false;</span>
        String id;
        AbstractOption op;
        OptionGroup og;
        UnitListOption ulo;

        // SAVEGAME_VERSION == 11

        // For 0.10.6 we moved from a three level structure:
        //   difficultyLevels/&lt;difficulty&gt;/&lt;option&gt;
        // to a four level structure
        //   difficultyLevels/&lt;difficulty&gt;/&lt;group&gt;/&lt;option&gt;
        // so add the groups in, and move the options that could be present
        // in anything up to 0.10.5 into their destination groups.
<span class="fc" id="L2276">        ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_IMMIGRATION,</span>
            GameOptions.CROSSES_INCREMENT,
            GameOptions.RECRUIT_PRICE_INCREASE,
            GameOptions.LOWER_CAP_INCREASE,
            GameOptions.PRICE_INCREASE + &quot;.artillery&quot;,
            GameOptions.PRICE_INCREASE_PER_TYPE,
            GameOptions.EXPERT_STARTING_UNITS,
            GameOptions.IMMIGRANTS);
<span class="fc" id="L2284">        ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_NATIVES,</span>
            GameOptions.LAND_PRICE_FACTOR,
            GameOptions.NATIVE_CONVERT_PROBABILITY,
            GameOptions.BURN_PROBABILITY,
            GameOptions.NATIVE_DEMANDS,
            GameOptions.RUMOUR_DIFFICULTY,
            GameOptions.SHIP_TRADE_PENALTY,
            GameOptions.BUILD_ON_NATIVE_LAND,
            GameOptions.SETTLEMENT_NUMBER);
<span class="fc" id="L2293">        ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_MONARCH,</span>
            GameOptions.MONARCH_MEDDLING,
            GameOptions.TAX_ADJUSTMENT,
            GameOptions.MERCENARY_PRICE,
            GameOptions.MAXIMUM_TAX,
            GameOptions.MONARCH_SUPPORT,
            GameOptions.TREASURE_TRANSPORT_FEE,
            GameOptions.REF_FORCE,
            GameOptions.INTERVENTION_BELLS,
            GameOptions.INTERVENTION_TURNS,
            GameOptions.INTERVENTION_FORCE,
            GameOptions.MERCENARY_FORCE);
<span class="fc" id="L2305">        ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_GOVERNMENT,</span>
            GameOptions.BAD_GOVERNMENT_LIMIT,
            GameOptions.VERY_BAD_GOVERNMENT_LIMIT,
            GameOptions.GOOD_GOVERNMENT_LIMIT,
            GameOptions.VERY_GOOD_GOVERNMENT_LIMIT);
<span class="fc" id="L2310">        ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_OTHER,</span>
            GameOptions.STARTING_MONEY,
            GameOptions.FOUNDING_FATHER_FACTOR,
            GameOptions.ARREARS_FACTOR,
            GameOptions.UNITS_THAT_USE_NO_BELLS,
            GameOptions.TILE_PRODUCTION);
<span class="fc" id="L2316">        ret |= checkDifficultyOptionGroup(GameOptions.DIFFICULTY_CHEAT,</span>
            GameOptions.LIFT_BOYCOTT_CHEAT,
            GameOptions.EQUIP_SCOUT_CHEAT,
            GameOptions.LAND_UNIT_CHEAT,
            GameOptions.OFFENSIVE_NAVAL_UNIT_CHEAT,
            GameOptions.TRANSPORT_NAVAL_UNIT_CHEAT);

        // @compat 0.10.0
        // This used to be a game option.
<span class="fc" id="L2325">        ret |= checkDifficultyIntegerOption(GameOptions.SHIP_TRADE_PENALTY,</span>
                                            GameOptions.DIFFICULTY_NATIVES,
                                            -30);
        // end @compat 0.10.0

        // SAVEGAME_VERSION == 12

        // @compat 0.10.4
<span class="fc" id="L2333">        id = GameOptions.REF_FORCE; // Yes, really &quot;refSize&quot;</span>
<span class="fc" id="L2334">        ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2335" title="1 of 2 branches missed.">        if (ulo != null) {</span>
<span class="nc" id="L2336">            AbstractUnitOption regulars</span>
                = new AbstractUnitOption(id + &quot;.regulars&quot;, this);
<span class="nc" id="L2338">            regulars.setValue(new AbstractUnit(&quot;model.unit.kingsRegular&quot;,</span>
                                               &quot;model.role.infantry&quot;, 31));
<span class="nc" id="L2340">            ulo.getValue().add(regulars);</span>
<span class="nc" id="L2341">            AbstractUnitOption dragoons</span>
                = new AbstractUnitOption(id + &quot;.dragoons&quot;, this);
<span class="nc" id="L2343">            dragoons.setValue(new AbstractUnit(&quot;model.unit.kingsRegular&quot;,</span>
                                               &quot;model.role.cavalry&quot;, 15));
<span class="nc" id="L2345">            ulo.getValue().add(dragoons);</span>
<span class="nc" id="L2346">            AbstractUnitOption artillery</span>
                = new AbstractUnitOption(id + &quot;.artillery&quot;, this);
<span class="nc" id="L2348">            artillery.setValue(new AbstractUnit(&quot;model.unit.artillery&quot;,</span>
                                                DEFAULT_ROLE_ID, 14));
<span class="nc" id="L2350">            ulo.getValue().add(artillery);</span>
<span class="nc" id="L2351">            AbstractUnitOption menOfWar</span>
                = new AbstractUnitOption(id + &quot;.menOfWar&quot;, this);
<span class="nc" id="L2353">            menOfWar.setValue(new AbstractUnit(&quot;model.unit.manOWar&quot;,</span>
                                               DEFAULT_ROLE_ID, 8));
<span class="nc" id="L2355">            ulo.getValue().add(menOfWar);</span>
<span class="nc" id="L2356">            ret = true;</span>
        }
<span class="fc" id="L2358">        id = GameOptions.IMMIGRANTS;</span>
<span class="fc" id="L2359">        ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_IMMIGRATION);</span>
<span class="fc bfc" id="L2360" title="All 2 branches covered.">        if (ulo != null) {</span>
<span class="fc" id="L2361">            AbstractUnitOption i1</span>
                = new AbstractUnitOption(id + &quot;.1&quot;, this);
<span class="fc" id="L2363">            i1.setValue(new AbstractUnit(&quot;model.unit.masterCarpenter&quot;,</span>
                                         DEFAULT_ROLE_ID, 1));
<span class="fc" id="L2365">            ulo.getValue().add(i1);</span>
<span class="fc" id="L2366">            ret = true;</span>
        }
        // end @compat 0.10.4

        // @compat 0.10.5
<span class="fc" id="L2371">        ret |= checkDifficultyIntegerOption(GameOptions.INTERVENTION_BELLS,</span>
                                            GameOptions.DIFFICULTY_MONARCH,
                                            5000);
<span class="fc" id="L2374">        ret |= checkDifficultyIntegerOption(GameOptions.INTERVENTION_TURNS,</span>
                                            GameOptions.DIFFICULTY_MONARCH,
                                            52);
<span class="fc" id="L2377">        id = GameOptions.INTERVENTION_FORCE;</span>
<span class="fc" id="L2378">        ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2379" title="1 of 2 branches missed.">        if (ulo != null) {</span>
<span class="nc" id="L2380">            AbstractUnitOption regulars</span>
                = new AbstractUnitOption(id + &quot;.regulars&quot;, this);
<span class="nc" id="L2382">            regulars.setValue(new AbstractUnit(&quot;model.unit.colonialRegular&quot;,</span>
                                               &quot;model.role.soldier&quot;, 2));
<span class="nc" id="L2384">            ulo.getValue().add(regulars);</span>
<span class="nc" id="L2385">            AbstractUnitOption dragoons</span>
                = new AbstractUnitOption(id + &quot;.dragoons&quot;, this);
<span class="nc" id="L2387">            dragoons.setValue(new AbstractUnit(&quot;model.unit.colonialRegular&quot;,</span>
                                               &quot;model.role.dragoon&quot;, 2));
<span class="nc" id="L2389">            ulo.getValue().add(dragoons);</span>
<span class="nc" id="L2390">            AbstractUnitOption artillery</span>
                = new AbstractUnitOption(id + &quot;.artillery&quot;, this);
<span class="nc" id="L2392">            artillery.setValue(new AbstractUnit(&quot;model.unit.artillery&quot;,</span>
                                                DEFAULT_ROLE_ID, 2));
<span class="nc" id="L2394">            ulo.getValue().add(artillery);</span>
<span class="nc" id="L2395">            AbstractUnitOption menOfWar</span>
                = new AbstractUnitOption(id + &quot;.menOfWar&quot;, this);
<span class="nc" id="L2397">            menOfWar.setValue(new AbstractUnit(&quot;model.unit.manOWar&quot;,</span>
                                               DEFAULT_ROLE_ID, 2));
<span class="nc" id="L2399">            ulo.getValue().add(menOfWar);</span>
<span class="nc" id="L2400">            ret = true;</span>
        }
<span class="fc" id="L2402">        id = GameOptions.MERCENARY_FORCE;</span>
<span class="fc" id="L2403">        ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2404" title="1 of 2 branches missed.">        if (ulo != null) {</span>
<span class="nc" id="L2405">            AbstractUnitOption regulars</span>
                = new AbstractUnitOption(id + &quot;.regulars&quot;, this);
<span class="nc" id="L2407">            regulars.setValue(new AbstractUnit(&quot;model.unit.veteranSoldier&quot;,</span>
                                               &quot;model.role.soldier&quot;, 2));
<span class="nc" id="L2409">            ulo.getValue().add(regulars);</span>
<span class="nc" id="L2410">            AbstractUnitOption dragoons</span>
                = new AbstractUnitOption(id + &quot;.dragoons&quot;, this);
<span class="nc" id="L2412">            dragoons.setValue(new AbstractUnit(&quot;model.unit.veteranSoldier&quot;,</span>
                                               &quot;model.role.dragoon&quot;, 2));
<span class="nc" id="L2414">            ulo.getValue().add(dragoons);</span>
<span class="nc" id="L2415">            AbstractUnitOption artillery</span>
                = new AbstractUnitOption(id + &quot;.artillery&quot;, this);
<span class="nc" id="L2417">            artillery.setValue(new AbstractUnit(&quot;model.unit.artillery&quot;,</span>
                                                DEFAULT_ROLE_ID, 2));
<span class="nc" id="L2419">            ulo.getValue().add(artillery);</span>
<span class="nc" id="L2420">            AbstractUnitOption menOfWar</span>
                = new AbstractUnitOption(id + &quot;.menOfWar&quot;, this);
<span class="nc" id="L2422">            menOfWar.setValue(new AbstractUnit(&quot;model.unit.manOWar&quot;,</span>
                                               DEFAULT_ROLE_ID, 2));
<span class="nc" id="L2424">            ulo.getValue().add(menOfWar);</span>
<span class="nc" id="L2425">            ret = true;</span>
        }
<span class="fc" id="L2427">        ret |= checkDifficultyIntegerOption(GameOptions.GOOD_GOVERNMENT_LIMIT,</span>
                                            GameOptions.DIFFICULTY_GOVERNMENT,
                                            50);
<span class="fc" id="L2430">        ret |= checkDifficultyIntegerOption(GameOptions.VERY_GOOD_GOVERNMENT_LIMIT,</span>
                                            GameOptions.DIFFICULTY_GOVERNMENT,
                                            100);
<span class="fc" id="L2433">        ret |= checkDifficultyIntegerOption(GameOptions.LIFT_BOYCOTT_CHEAT,</span>
                                            GameOptions.DIFFICULTY_CHEAT,
                                            10);
<span class="fc" id="L2436">        ret |= checkDifficultyIntegerOption(GameOptions.EQUIP_SCOUT_CHEAT,</span>
                                            GameOptions.DIFFICULTY_CHEAT,
                                            10);
<span class="fc" id="L2439">        ret |= checkDifficultyIntegerOption(GameOptions.LAND_UNIT_CHEAT,</span>
                                            GameOptions.DIFFICULTY_CHEAT,
                                            10);
<span class="fc" id="L2442">        ret |= checkDifficultyIntegerOption(GameOptions.OFFENSIVE_NAVAL_UNIT_CHEAT,</span>
                                            GameOptions.DIFFICULTY_CHEAT,
                                            10);
<span class="fc" id="L2445">        ret |= checkDifficultyIntegerOption(GameOptions.TRANSPORT_NAVAL_UNIT_CHEAT,</span>
                                            GameOptions.DIFFICULTY_CHEAT,
                                            10);
        // end @compat 0.10.5

        // SAVEGAME_VERSION == 13

        // @compat 0.10.7
<span class="fc" id="L2453">        ret |= checkDifficultyIntegerOption(GameOptions.DESTROY_SETTLEMENT_SCORE,</span>
                                            GameOptions.DIFFICULTY_NATIVES,
                                            -5);
<span class="fc" id="L2456">        ret |= checkDifficultyIntegerOption(GameOptions.BAD_RUMOUR,</span>
                                            GameOptions.DIFFICULTY_OTHER,
                                            23);
<span class="fc" id="L2459">        ret |= checkDifficultyIntegerOption(GameOptions.GOOD_RUMOUR,</span>
                                            GameOptions.DIFFICULTY_OTHER,
                                            48);
<span class="fc" id="L2462">        ret |= checkDifficultyIntegerOption(GameOptions.OFFENSIVE_LAND_UNIT_CHEAT,</span>
                                            GameOptions.DIFFICULTY_CHEAT,
                                            4);
<span class="fc" id="L2465">        ret |= checkDifficultyIntegerOption(GameOptions.EQUIP_PIONEER_CHEAT,</span>
                                            GameOptions.DIFFICULTY_CHEAT,
                                            10);
        // end @compat 0.10.7

        // @compat 0.11.3
<span class="fc" id="L2471">        id = GameOptions.WAR_SUPPORT_FORCE;</span>
<span class="fc" id="L2472">        ulo = checkDifficultyUnitListOption(id, GameOptions.DIFFICULTY_MONARCH);</span>
<span class="pc bpc" id="L2473" title="1 of 2 branches missed.">        if (ulo != null) {</span>
<span class="nc" id="L2474">            AbstractUnitOption support = new AbstractUnitOption(id, this);</span>
<span class="nc" id="L2475">            support.setValue(new AbstractUnit(&quot;model.unit.veteranSoldier&quot;,</span>
                                              &quot;model.role.soldier&quot;, 4));
<span class="nc" id="L2477">            ulo.getValue().add(support);</span>
<span class="nc" id="L2478">            ret = true;</span>
        }
<span class="fc" id="L2480">        ret |= checkDifficultyIntegerOption(GameOptions.WAR_SUPPORT_GOLD,</span>
                                            GameOptions.DIFFICULTY_MONARCH,
                                            1500);
        // end @compat 0.11.3

<span class="fc" id="L2485">        return ret;</span>
    }

    private boolean checkDifficultyOptionGroup(String gr, String... ids) {
<span class="fc" id="L2489">        logger.info(&quot;Check group &quot; + gr);</span>
<span class="fc" id="L2490">        boolean ret = false;</span>
<span class="fc bfc" id="L2491" title="All 2 branches covered.">        for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L2492">            Option op = level.getOption(gr);</span>
            OptionGroup og;
<span class="pc bpc" id="L2494" title="1 of 2 branches missed.">            if (op instanceof OptionGroup) {</span>
<span class="fc" id="L2495">                og = (OptionGroup)op;</span>
            } else {
<span class="nc" id="L2497">                og = new OptionGroup(gr, this);</span>
<span class="nc" id="L2498">                level.add(og);</span>
<span class="nc" id="L2499">                og.setGroup(level.getId());</span>
<span class="nc" id="L2500">                ret = true;</span>
            }
<span class="fc bfc" id="L2502" title="All 2 branches covered.">            for (String id : ids) {</span>
<span class="fc" id="L2503">                op = level.remove(id);</span>
<span class="fc bfc" id="L2504" title="All 2 branches covered.">                if (op != null) {</span>
<span class="pc bpc" id="L2505" title="1 of 2 branches missed.">                    if (op instanceof AbstractOption) {</span>
<span class="fc" id="L2506">                        ((AbstractOption)op).setGroup(og.getId());</span>
                    }
<span class="fc" id="L2508">                    og.add(op);</span>
<span class="fc" id="L2509">                    ret = true;</span>
                }
            }
<span class="fc" id="L2512">        }</span>
<span class="fc" id="L2513">        return ret;</span>
    }

    private boolean checkDifficultyIntegerOption(String id, String gr,
                                                 int defaultValue) {
<span class="fc" id="L2518">        boolean ret = false;</span>
<span class="fc bfc" id="L2519" title="All 2 branches covered.">        for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L2520">            Option op = level.getOption(gr);</span>
<span class="pc bpc" id="L2521" title="1 of 2 branches missed.">            if (op instanceof OptionGroup) {</span>
<span class="fc" id="L2522">                OptionGroup og = (OptionGroup)op;</span>
<span class="pc bpc" id="L2523" title="1 of 2 branches missed.">                if ((op = og.getOption(id)) != null) continue;</span>
<span class="nc" id="L2524">                IntegerOption iop = new IntegerOption(id, this);</span>
<span class="nc" id="L2525">                iop.setGroup(gr);</span>
<span class="nc" id="L2526">                iop.setValue(defaultValue);</span>
<span class="nc" id="L2527">                og.add(iop);</span>
<span class="nc" id="L2528">                ret = true;</span>
            }
<span class="nc" id="L2530">        }</span>
<span class="pc bpc" id="L2531" title="1 of 2 branches missed.">        if (ret) {</span>
<span class="nc" id="L2532">            logger.info(&quot;Added difficulty integer option: &quot; + id);</span>
        }
<span class="fc" id="L2534">        return ret;</span>
    }
        
    private UnitListOption checkDifficultyUnitListOption(String id, String gr) {
<span class="fc" id="L2538">        UnitListOption ulo = null;</span>
<span class="fc bfc" id="L2539" title="All 2 branches covered.">        for (OptionGroup level : getDifficultyLevels()) {</span>
<span class="fc" id="L2540">            Option op = level.getOption(gr);</span>
<span class="pc bpc" id="L2541" title="1 of 2 branches missed.">            if (op instanceof OptionGroup) {</span>
<span class="fc" id="L2542">                OptionGroup og = (OptionGroup)op;</span>
<span class="fc bfc" id="L2543" title="All 2 branches covered.">                if (og.getOption(id) instanceof UnitListOption) continue;</span>
<span class="fc bfc" id="L2544" title="All 2 branches covered.">                if (ulo == null) ulo = new UnitListOption(id, this);</span>
<span class="fc" id="L2545">                og.add(ulo);</span>
            }
<span class="fc" id="L2547">        }</span>
<span class="fc bfc" id="L2548" title="All 2 branches covered.">        if (ulo != null) {</span>
<span class="fc" id="L2549">            logger.info(&quot;Added difficulty unit list option: &quot; + id);</span>
        }
<span class="fc" id="L2551">        return ulo;</span>
    }

    /**
     * Backward compatibility code to make sure this specification
     * contains a default value for every game option.
     *
     * When a new game option is added to the spec, add a sensible
     * default here.
     *
     * @return True if an option was missing and added.
     */
    public boolean fixGameOptions() {
<span class="fc" id="L2564">        boolean ret = false;</span>
        // SAVEGAME_VERSION == 11

        // @compat 0.10.0
<span class="fc" id="L2568">        ret |= checkOptionGroup(GameOptions.GAMEOPTIONS_YEARS);</span>
<span class="fc" id="L2569">        String[] years = {</span>
            GameOptions.STARTING_YEAR,
            GameOptions.SEASON_YEAR,
            GameOptions.MANDATORY_COLONY_YEAR,
            GameOptions.LAST_YEAR,
            GameOptions.LAST_COLONIAL_YEAR,
        };
<span class="fc" id="L2576">        int[] values = { 1492, 1600, 1600, 1850, 1800 };</span>
<span class="fc bfc" id="L2577" title="All 2 branches covered.">        for (int index = 0; index &lt; years.length; index++) {</span>
<span class="fc" id="L2578">            ret |= checkIntegerOption(years[index],</span>
                                      GameOptions.GAMEOPTIONS_YEARS,
                                      values[index]);
        }
<span class="fc" id="L2582">        ret |= checkBooleanOption(GameOptions.ENHANCED_MISSIONARIES,</span>
                                  GameOptions.GAMEOPTIONS_MAP, false);
<span class="fc" id="L2584">        ret |= checkBooleanOption(GameOptions.CONTINUE_FOUNDING_FATHER_RECRUITMENT,</span>
                                  GameOptions.GAMEOPTIONS_MAP, false);
<span class="fc" id="L2586">        ret |= checkIntegerOption(GameOptions.SETTLEMENT_LIMIT_MODIFIER,</span>
                                  GameOptions.GAMEOPTIONS_MAP, 0);
<span class="fc" id="L2588">        ret |= checkBooleanOption(GameOptions.SETTLEMENT_ACTIONS_CONTACT_CHIEF,</span>
                                  GameOptions.GAMEOPTIONS_MAP, false);
<span class="fc" id="L2590">        ret |= checkIntegerOption(GameOptions.STARTING_POSITIONS,</span>
                                  GameOptions.GAMEOPTIONS_MAP, 0);
<span class="fc" id="L2592">        ret |= checkBooleanOption(GameOptions.TELEPORT_REF,</span>
                                  GameOptions.GAMEOPTIONS_MAP, false);
        // end @compat 0.10.0

        // SAVEGAME_VERSION == 12

        // @compat 0.10.5
<span class="fc" id="L2599">        ret |= checkBooleanOption(GameOptions.ENABLE_UPKEEP,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, false);
<span class="fc" id="L2601">        ret |= checkIntegerOption(GameOptions.NATURAL_DISASTERS,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, 0);
<span class="fc" id="L2603">        ret |= checkIntegerOption(GameOptions.GIFT_PROBABILITY,</span>
                                  GameOptions.GAMEOPTIONS_MAP, 5);
<span class="fc" id="L2605">        ret |= checkIntegerOption(GameOptions.DEMAND_PROBABILITY,</span>
                                  GameOptions.GAMEOPTIONS_MAP, 10);
<span class="fc" id="L2607">        ret |= checkBooleanOption(GameOptions.EMPTY_TRADERS,</span>
                                  GameOptions.GAMEOPTIONS_MAP, false);
        // end @compat 0.10.5

        // SAVEGAME_VERSION == 13

        // @compat 0.10.7
<span class="fc" id="L2614">        ret |= checkBooleanOption(GameOptions.ONLY_NATURAL_IMPROVEMENTS,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, true);
<span class="fc" id="L2616">        ret |= checkIntegerOption(GameOptions.PEACE_PROBABILITY,</span>
                                  GameOptions.GAMEOPTIONS_MAP, 90);
<span class="fc" id="L2618">        ret |= checkIntegerOption(GameOptions.INITIAL_IMMIGRATION,</span>
                                  GameOptions.GAMEOPTIONS_MAP, 15);
<span class="fc" id="L2620">        ret |= checkIntegerOption(GameOptions.EUROPEAN_UNIT_IMMIGRATION_PENALTY,</span>
                                  GameOptions.GAMEOPTIONS_MAP, -4);
<span class="fc" id="L2622">        ret |= checkIntegerOption(GameOptions.PLAYER_IMMIGRATION_BONUS,</span>
                                  GameOptions.GAMEOPTIONS_MAP, 2);
<span class="fc" id="L2624">        ret |= checkBooleanOption(GameOptions.FOUND_COLONY_DURING_REBELLION,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, true);
        // end @compat 0.10.7

        // @compat 0.11.0
<span class="fc" id="L2629">        ret |= checkBooleanOption(GameOptions.BELL_ACCUMULATION_CAPPED,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, false);
<span class="fc" id="L2631">        ret |= checkBooleanOption(GameOptions.CAPTURE_UNITS_UNDER_REPAIR,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, false);
<span class="fc" id="L2633">        ret |= checkBooleanOption(GameOptions.PAY_FOR_BUILDING,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, true);
<span class="fc" id="L2635">        ret |= checkBooleanOption(GameOptions.CLEAR_HAMMERS_ON_CONSTRUCTION_SWITCH,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, false);
<span class="fc" id="L2637">        ret |= checkBooleanOption(GameOptions.CUSTOMS_ON_COAST,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, false);
<span class="fc" id="L2639">        ret |= checkBooleanOption(GameOptions.EQUIP_EUROPEAN_RECRUITS,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, true);
        // end @compat 0.11.0

        // @compat 0.11.3
<span class="fc" id="L2644">        ret |= checkIntegerOption(GameOptions.MISSION_INFLUENCE,</span>
                                  GameOptions.GAMEOPTIONS_MAP, -10);
<span class="fc" id="L2646">        ret |= checkIntegerOption(GameOptions.INDEPENDENCE_TURN,</span>
                                  GameOptions.GAMEOPTIONS_YEARS, 468);
<span class="fc" id="L2648">        ret |= checkTextOption(GameOptions.AGES,</span>
                               GameOptions.GAMEOPTIONS_YEARS, &quot;1600,1700&quot;);
<span class="fc" id="L2650">        ret |= checkIntegerOption(GameOptions.SEASONS,</span>
                                  GameOptions.GAMEOPTIONS_YEARS, 2);
<span class="fc" id="L2652">        ret |= checkBooleanOption(GameOptions.DISEMBARK_IN_COLONY,</span>
                                  GameOptions.GAMEOPTIONS_COLONY, false);
        // end @compat 0.11.3

<span class="fc" id="L2656">        return ret;</span>
    }

    /**
     * Backward compatibility code to make sure this specification
     * contains a default value for every map option.
     *
     * When a new map option is added to the spec, add a sensible
     * default here.
     *
     * @return True if an option was missing and added.
     */
    public boolean fixMapGeneratorOptions() {
<span class="fc" id="L2669">        boolean ret = false;</span>
        // SAVEGAME_VERSION == 11

        // @compat 0.10.0
<span class="fc" id="L2673">        ret |= checkIntegerOption(MapGeneratorOptions.MINIMUM_LATITUDE,</span>
                                  MapGeneratorOptions.MAPGENERATOROPTIONS_TERRAIN_GENERATOR,
                                  -90);
<span class="fc" id="L2676">        ret |= checkIntegerOption(MapGeneratorOptions.MAXIMUM_LATITUDE,</span>
                                  MapGeneratorOptions.MAPGENERATOROPTIONS_TERRAIN_GENERATOR,
                                  90);
        // end @compat 0.10.0

        // SAVEGAME_VERSION == 12
        // SAVEGAME_VERSION == 13

<span class="fc" id="L2684">        return ret;</span>
    }

    private boolean checkOptionGroup(String id) {
<span class="pc bpc" id="L2688" title="1 of 2 branches missed.">        if (allOptionGroups.containsKey(id)) return false;</span>
<span class="nc" id="L2689">        OptionGroup og = new OptionGroup(id, this);</span>
<span class="nc" id="L2690">        allOptionGroups.put(id, og);</span>
<span class="nc" id="L2691">        return true;</span>
    }

    private boolean checkBooleanOption(String id, String gr, boolean defaultValue) {
<span class="pc bpc" id="L2695" title="1 of 2 branches missed.">        if (hasOption(id)) return false;</span>
<span class="nc" id="L2696">        BooleanOption op = new BooleanOption(id, this);</span>
<span class="nc" id="L2697">        op.setGroup(gr);</span>
<span class="nc" id="L2698">        op.setValue(defaultValue);</span>
<span class="nc" id="L2699">        return checkOption(op);</span>
    }

    private boolean checkIntegerOption(String id, String gr, int defaultValue) {
<span class="pc bpc" id="L2703" title="1 of 2 branches missed.">        if (hasOption(id)) return false;</span>
<span class="nc" id="L2704">        IntegerOption op = new IntegerOption(id, this);</span>
<span class="nc" id="L2705">        op.setGroup(gr);</span>
<span class="nc" id="L2706">        op.setValue(defaultValue);</span>
<span class="nc" id="L2707">        return checkOption(op);</span>
    }

    private boolean checkStringOption(String id, String gr, String defaultValue) {
<span class="nc bnc" id="L2711" title="All 2 branches missed.">        if (hasOption(id)) return false;</span>
<span class="nc" id="L2712">        StringOption op = new StringOption(id, this);</span>
<span class="nc" id="L2713">        op.setGroup(gr);</span>
<span class="nc" id="L2714">        op.setValue(defaultValue);</span>
<span class="nc" id="L2715">        return checkOption(op);</span>
    }

    private boolean checkTextOption(String id, String gr, String defaultValue) {
<span class="pc bpc" id="L2719" title="1 of 2 branches missed.">        if (hasOption(id)) return false;</span>
<span class="nc" id="L2720">        TextOption op = new TextOption(id, this);</span>
<span class="nc" id="L2721">        op.setGroup(gr);</span>
<span class="nc" id="L2722">        op.setValue(defaultValue);</span>
<span class="nc" id="L2723">        return checkOption(op);</span>
    }

    private boolean checkOption(AbstractOption option) {
<span class="nc" id="L2727">        getOptionGroup(option.getGroup()).add(option);</span>
<span class="nc" id="L2728">        addAbstractOption(option);</span>
<span class="nc" id="L2729">        return true;</span>
    }
        


    // Serialization

    private static final String BUILDING_TYPES_TAG = &quot;building-types&quot;;
    private static final String DIFFICULTY_LEVEL_TAG = &quot;difficulty-level&quot;;
    private static final String DISASTERS_TAG = &quot;disasters&quot;;
    private static final String EUROPEAN_NATION_TYPES_TAG = &quot;european-nation-types&quot;;
    private static final String EVENTS_TAG = &quot;events&quot;;
    private static final String FOUNDING_FATHERS_TAG = &quot;founding-fathers&quot;;
    private static final String GOODS_TYPES_TAG = &quot;goods-types&quot;;
    private static final String INDIAN_NATION_TYPES_TAG = &quot;indian-nation-types&quot;;
    private static final String MODIFIERS_TAG = &quot;modifiers&quot;;
    private static final String NATIONS_TAG = &quot;nations&quot;;
    private static final String OPTIONS_TAG = &quot;options&quot;;
    private static final String RESOURCE_TYPES_TAG = &quot;resource-types&quot;;
    private static final String ROLES_TAG = &quot;roles&quot;;
    private static final String TILE_TYPES_TAG = &quot;tile-types&quot;;
    private static final String TILE_IMPROVEMENT_TYPES_TAG = &quot;tile-improvement-types&quot;;
    private static final String UNIT_TYPES_TAG = &quot;unit-types&quot;;
    private static final String VERSION_TAG = &quot;version&quot;;
    // @compat 0.10.x
    private static final String EQUIPMENT_TYPES_TAG = &quot;equipment-types&quot;;
    // end @compat 0.10.x
    // @compat 0.11.3
    private static final String OLD_DIFFICULTY_LEVEL_TAG = &quot;difficultyLevel&quot;;
    private static final String OLD_TILEIMPROVEMENT_TYPES_TAG = &quot;tileimprovement-types&quot;;
    // end @compat 0.11.3

    /**
     * Write an XML-representation of this object to the given stream.
     *
     * @param xw The &lt;code&gt;FreeColXMLWriter&lt;/code&gt; to write to.
     * @exception XMLStreamException if there are any problems writing
     *      to the stream.
     */
    protected void toXML(FreeColXMLWriter xw) throws XMLStreamException {
        // Start element
<span class="fc" id="L2770">        xw.writeStartElement(getXMLElementTagName());</span>

        // Add attributes
<span class="fc" id="L2773">        xw.writeAttribute(FreeColObject.ID_ATTRIBUTE_TAG, getId());</span>
<span class="pc bpc" id="L2774" title="1 of 2 branches missed.">        if (difficultyLevel != null) {</span>
<span class="fc" id="L2775">            xw.writeAttribute(DIFFICULTY_LEVEL_TAG, difficultyLevel);</span>
        }
<span class="pc bpc" id="L2777" title="1 of 2 branches missed.">        if (version != null) {</span>
<span class="fc" id="L2778">            xw.writeAttribute(VERSION_TAG, version);</span>
        }

        // copy the order of section in specification.xml
<span class="fc" id="L2782">        writeSection(xw, MODIFIERS_TAG, specialModifiers);</span>
<span class="fc" id="L2783">        writeSection(xw, EVENTS_TAG, events);</span>
<span class="fc" id="L2784">        writeSection(xw, DISASTERS_TAG, disasters);</span>
<span class="fc" id="L2785">        writeSection(xw, GOODS_TYPES_TAG, goodsTypeList);</span>
<span class="fc" id="L2786">        writeSection(xw, RESOURCE_TYPES_TAG, resourceTypeList);</span>
<span class="fc" id="L2787">        writeSection(xw, TILE_TYPES_TAG, tileTypeList);</span>
<span class="fc" id="L2788">        writeSection(xw, ROLES_TAG, roles);</span>
<span class="fc" id="L2789">        writeSection(xw, TILE_IMPROVEMENT_TYPES_TAG, tileImprovementTypeList);</span>
<span class="fc" id="L2790">        writeSection(xw, UNIT_TYPES_TAG, unitTypeList);</span>
<span class="fc" id="L2791">        writeSection(xw, BUILDING_TYPES_TAG, buildingTypeList);</span>
<span class="fc" id="L2792">        writeSection(xw, FOUNDING_FATHERS_TAG, foundingFathers);</span>
<span class="fc" id="L2793">        writeSection(xw, EUROPEAN_NATION_TYPES_TAG, europeanNationTypes);</span>
<span class="fc" id="L2794">        writeSection(xw, EUROPEAN_NATION_TYPES_TAG, REFNationTypes);</span>
<span class="fc" id="L2795">        writeSection(xw, INDIAN_NATION_TYPES_TAG, indianNationTypes);</span>
<span class="fc" id="L2796">        writeSection(xw, NATIONS_TAG, nations);</span>

        // option tree has been flattened
<span class="fc" id="L2799">        xw.writeStartElement(OPTIONS_TAG);</span>
<span class="fc bfc" id="L2800" title="All 2 branches covered.">        for (OptionGroup item : allOptionGroups.values()) {</span>
<span class="fc bfc" id="L2801" title="All 2 branches covered.">            if (item.getGroup().isEmpty()) item.toXML(xw);</span>
<span class="fc" id="L2802">        }</span>
<span class="fc" id="L2803">        xw.writeEndElement();</span>

        // End element
<span class="fc" id="L2806">        xw.writeEndElement();</span>

<span class="fc" id="L2808">    }</span>

    private &lt;T extends FreeColObject&gt; void writeSection(FreeColXMLWriter xw,
        String section, Collection&lt;T&gt; items) throws XMLStreamException {
<span class="fc" id="L2812">        xw.writeStartElement(section);</span>

<span class="fc bfc" id="L2814" title="All 2 branches covered.">        for (T item : items) item.toXML(xw);</span>

<span class="fc" id="L2816">        xw.writeEndElement();</span>
<span class="fc" id="L2817">    }</span>

    /**
     * Initializes this object from its XML-representation.
     *
     * @param xr The &lt;code&gt;FreeColXMLReader&lt;/code&gt; to read from.
     * @exception XMLStreamException if there are any problems reading
     *     the stream.
     */
    public void readFromXML(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L2827">        String newId = xr.readId();</span>
<span class="fc bfc" id="L2828" title="All 2 branches covered.">        if (id == null) id = newId; // don't overwrite id with parent id!</span>

<span class="pc bpc" id="L2830" title="1 of 2 branches missed.">        if (difficultyLevel == null) {</span>
<span class="fc" id="L2831">            difficultyLevel = xr.getAttribute(DIFFICULTY_LEVEL_TAG,</span>
                                              (String)null);
            // @compat 0.11.3
<span class="fc bfc" id="L2834" title="All 2 branches covered.">            if (difficultyLevel == null) {</span>
<span class="fc" id="L2835">                difficultyLevel = xr.getAttribute(OLD_DIFFICULTY_LEVEL_TAG,</span>
                                                  (String)null);
            }
            // end @compat 0.11.3
        }

<span class="fc" id="L2841">        version = xr.getAttribute(VERSION_TAG, (String)null);</span>

<span class="fc" id="L2843">        logger.fine(&quot;Reading specification &quot; + newId</span>
            + &quot; difficulty=&quot; + difficultyLevel
            + &quot; version=&quot; + version);

<span class="fc" id="L2847">        String parentId = xr.getAttribute(FreeColGameObjectType.EXTENDS_TAG,</span>
                                          (String)null);
<span class="fc bfc" id="L2849" title="All 2 branches covered.">        if (parentId != null) {</span>
            try {
<span class="fc" id="L2851">                FreeColTcFile parent = new FreeColTcFile(parentId);</span>
<span class="fc" id="L2852">                load(parent.getSpecificationInputStream());</span>
<span class="fc" id="L2853">                initialized = false;</span>
<span class="nc" id="L2854">            } catch (IOException e) {</span>
<span class="nc" id="L2855">                throw new XMLStreamException(&quot;Failed to open parent specification: &quot;, e);</span>
<span class="fc" id="L2856">            }</span>
        }

<span class="fc bfc" id="L2859" title="All 2 branches covered.">        while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L2860">            String childName = xr.getLocalName();</span>
            // @compat 0.10.x
            // Ideally we would handle role backward compatibility in
            // the type reader triggered by the &quot;roles&quot; section of the
            // spec.  Alas, specs pre-0.10.6 had no roles section.
            // The next section after roles in modern specs is
            // &quot;equipment-types&quot;, which is also the first place roles
            // are referred to directly, and better still is completely
            // replaced by roles in 0.11.x.  So this is the last chance
            // to fix any role omissions.
<span class="fc bfc" id="L2870" title="All 2 branches covered.">            if (&quot;equipment-types&quot;.equals(childName)) fixRoles();</span>
            // end @compat 0.10.x
<span class="fc" id="L2872">            ChildReader reader = readerMap.get(childName);</span>
<span class="pc bpc" id="L2873" title="1 of 2 branches missed.">            if (reader == null) {</span>
<span class="nc" id="L2874">                logger.warning(&quot;No reader found for: &quot; + childName);</span>
            } else {  
<span class="fc" id="L2876">                reader.readChildren(xr);</span>
            }
<span class="fc" id="L2878">        }</span>
<span class="fc" id="L2879">    }</span>

    /**
     * Gets the tag name of the root element representing this object.
     *
     * @return &quot;freecol-specification&quot;.
     */
    public static String getXMLElementTagName() {
<span class="fc" id="L2887">        return &quot;freecol-specification&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>