<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Monarch.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.common.model</a> &gt; <span class="el_source">Monarch.java</span></div><h1>Monarch.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.common.model;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Random;
import java.util.stream.Collectors;
import java.util.logging.Logger;

import javax.xml.stream.XMLStreamConstants;
import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.io.FreeColXMLWriter;
import net.sf.freecol.common.model.Player.PlayerType;
import net.sf.freecol.common.option.UnitListOption;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.RandomUtils.*;
import static net.sf.freecol.common.util.StringUtils.*;

/**
 * This class implements the player's monarch, whose functions prior to the
 * revolution include raising taxes, declaring war on other European countries,
 * and occasionally providing military support.
 */
public final class Monarch extends FreeColGameObject implements Named {

	/** The Constant logger. */
<span class="fc" id="L49">	private static final Logger logger = Logger.getLogger(Monarch.class.getName());</span>

	/**
	 * A group of units with a common origin and purpose.
	 */
	public class Force {

		/** The number of land units in the REF. */
<span class="fc" id="L57">		private final List&lt;AbstractUnit&gt; landUnits = new ArrayList&lt;&gt;();</span>

		/** The number of naval units in the REF. */
<span class="fc" id="L60">		private final List&lt;AbstractUnit&gt; navalUnits = new ArrayList&lt;&gt;();</span>

		// Internal variables that do not need serialization.
		/** The space required to transport all land units. */
		private int spaceRequired;

		/** The current naval transport capacity. */
		private int capacity;

		/**
		 * Empty constructor.
		 */
<span class="fc" id="L72">		public Force() {</span>
<span class="fc" id="L73">		}</span>

		/**
		 * Create a new Force.
		 *
		 * @param option
		 *            The &lt;code&gt;Option&lt;/code&gt; defining the force.
		 * @param ability
		 *            An optional ability name required of the units in the
		 *            force.
		 */
<span class="fc" id="L84">		public Force(UnitListOption option, String ability) {</span>
<span class="fc" id="L85">			final Specification spec = getSpecification();</span>
<span class="fc" id="L86">			List&lt;AbstractUnit&gt; units = option.getOptionValues();</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">			for (AbstractUnit unit : units) {</span>
<span class="fc" id="L88">				UnitType unitType = unit.getType(spec);</span>
<span class="pc bpc" id="L89" title="3 of 4 branches missed.">				if (ability == null || unitType.hasAbility(ability)) {</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">					if (unitType.hasAbility(Ability.NAVAL_UNIT)) {</span>
<span class="fc" id="L91">						navalUnits.add(unit);</span>
					} else {
<span class="fc" id="L93">						landUnits.add(unit);</span>
					}
				} else {
<span class="nc" id="L96">					logger.warning(&quot;Found unit lacking required ability \&quot;&quot; + ability + &quot;\&quot;: &quot; + unit);</span>
				}
<span class="fc" id="L98">			}</span>
<span class="fc" id="L99">			updateSpaceAndCapacity();</span>
<span class="fc" id="L100">		}</span>

		/**
		 * Gets the space required.
		 *
		 * @return the space required
		 */
		public final int getSpaceRequired() {
<span class="fc" id="L108">			return spaceRequired;</span>
		}

		/**
		 * Gets the capacity.
		 *
		 * @return the capacity
		 */
		public final int getCapacity() {
<span class="fc" id="L117">			return capacity;</span>
		}

		/**
		 * Update the space and capacity variables.
		 */
		public final void updateSpaceAndCapacity() {
<span class="fc" id="L124">			final Specification spec = getSpecification();</span>
<span class="fc" id="L125">			capacity = navalUnits.stream().filter(nu -&gt; nu.getType(spec).canCarryUnits())</span>
<span class="fc" id="L126">					.mapToInt(nu -&gt; nu.getType(spec).getSpace() * nu.getNumber()).sum();</span>
<span class="fc" id="L127">			spaceRequired = landUnits.stream().mapToInt(lu -&gt; lu.getType(spec).getSpaceTaken() * lu.getNumber()).sum();</span>
<span class="fc" id="L128">		}</span>

		/**
		 * Gets all units.
		 *
		 * @return A copy of the list of all units.
		 */
		public final List&lt;AbstractUnit&gt; getUnits() {
<span class="fc" id="L136">			List&lt;AbstractUnit&gt; result = getLandUnits();</span>
<span class="fc" id="L137">			result.addAll(getNavalUnits());</span>
<span class="fc" id="L138">			return result;</span>
		}

		/**
		 * Gets the naval units.
		 *
		 * @return A copy of the list of the naval units.
		 */
		public final List&lt;AbstractUnit&gt; getNavalUnits() {
<span class="fc" id="L147">			return AbstractUnit.deepCopy(navalUnits);</span>
		}

		/**
		 * Gets the land units.
		 *
		 * @return A list of the land units.
		 */
		public final List&lt;AbstractUnit&gt; getLandUnits() {
<span class="fc" id="L156">			return AbstractUnit.deepCopy(landUnits);</span>
		}

		/**
		 * Is this Force empty?.
		 *
		 * @return True if there are no land or naval units.
		 */
		public final boolean isEmpty() {
<span class="nc bnc" id="L165" title="All 4 branches missed.">			return landUnits.isEmpty() &amp;&amp; navalUnits.isEmpty();</span>
		}

		/**
		 * Adds units to this Force.
		 *
		 * @param au
		 *            The addition to this Force.
		 */
		public void add(AbstractUnit au) {
<span class="fc" id="L175">			final Specification spec = getSpecification();</span>
<span class="fc" id="L176">			final UnitType unitType = au.getType(spec);</span>
<span class="fc" id="L177">			final int n = au.getNumber();</span>
<span class="fc" id="L178">			boolean added = false;</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">			if (unitType.hasAbility(Ability.NAVAL_UNIT)) {</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">				for (AbstractUnit refUnit : navalUnits) {</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">					if (spec.getUnitType(refUnit.getId()) == unitType) {</span>
<span class="fc" id="L182">						refUnit.setNumber(refUnit.getNumber() + n);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">						if (unitType.canCarryUnits()) {</span>
<span class="fc" id="L184">							capacity += unitType.getSpace() * n;</span>
						}
<span class="fc" id="L186">						added = true;</span>
<span class="fc" id="L187">						break;</span>
					}
<span class="nc" id="L189">				}</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">				if (!added)</span>
<span class="fc" id="L191">					navalUnits.add(au);</span>
			} else {
<span class="fc bfc" id="L193" title="All 2 branches covered.">				for (AbstractUnit refUnit : landUnits) {</span>
<span class="pc bpc" id="L194" title="1 of 4 branches missed.">					if (spec.getUnitType(refUnit.getId()) == unitType &amp;&amp; refUnit.getRoleId().equals(au.getRoleId())) {</span>
<span class="nc" id="L195">						refUnit.setNumber(refUnit.getNumber() + n);</span>
<span class="nc" id="L196">						spaceRequired += unitType.getSpaceTaken() * n;</span>
<span class="nc" id="L197">						added = true;</span>
<span class="nc" id="L198">						break;</span>
					}
<span class="fc" id="L200">				}</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">				if (!added)</span>
<span class="fc" id="L202">					landUnits.add(au);</span>
			}
<span class="fc" id="L204">			updateSpaceAndCapacity();</span>
<span class="fc" id="L205">		}</span>

		/**
		 * Calculate the approximate offence power of this force.
		 *
		 * @param naval
		 *            If true, consider only naval units, otherwise consider the
		 *            land units.
		 * @return The approximate offence power.
		 */
		public double calculateStrength(boolean naval) {
<span class="fc bfc" id="L216" title="All 2 branches covered.">			return AbstractUnit.calculateStrength(getSpecification(), (naval) ? navalUnits : landUnits);</span>
		}

		/**
		 * Fix old REF roles.
		 */
		// @compat 0.10.x
		public void fixOldREFRoles() {
<span class="fc" id="L224">			Iterator&lt;AbstractUnit&gt; aui = landUnits.iterator();</span>
<span class="fc" id="L225">			List&lt;AbstractUnit&gt; todo = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">			while (aui.hasNext()) {</span>
<span class="fc" id="L227">				AbstractUnit au = aui.next();</span>
<span class="pc bpc" id="L228" title="2 of 4 branches missed.">				if (&quot;SOLDIER&quot;.equals(au.getRoleId()) || &quot;model.role.soldier&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L229">					au.setRoleId(&quot;model.role.infantry&quot;);</span>
<span class="nc" id="L230">					aui.remove();</span>
<span class="nc" id="L231">					todo.add(au);</span>
<span class="pc bpc" id="L232" title="2 of 4 branches missed.">				} else if (&quot;DRAGOON&quot;.equals(au.getRoleId()) || &quot;model.role.dragoon&quot;.equals(au.getRoleId())) {</span>
<span class="nc" id="L233">					au.setRoleId(&quot;model.role.cavalry&quot;);</span>
<span class="nc" id="L234">					aui.remove();</span>
<span class="nc" id="L235">					todo.add(au);</span>
				}
<span class="fc" id="L237">			}</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">			while (!todo.isEmpty())</span>
<span class="nc" id="L239">				add(todo.remove(0));</span>
<span class="fc" id="L240">		}</span>
		// end @compat 0.10.x

		// Serialization

		/** The Constant LAND_UNITS_TAG. */
		public static final String LAND_UNITS_TAG = &quot;landUnits&quot;;

		/** The Constant NAVAL_UNITS_TAG. */
		public static final String NAVAL_UNITS_TAG = &quot;navalUnits&quot;;
		// @compat 0.10.5
		// public for now, revert to private
		// end @compat

		/**
		 * To XML.
		 *
		 * @param xw
		 *            the xw
		 * @param tag
		 *            the tag
		 * @throws XMLStreamException
		 *             the XML stream exception
		 */
		public void toXML(FreeColXMLWriter xw, String tag) throws XMLStreamException {
<span class="fc" id="L265">			xw.writeStartElement(tag);</span>

<span class="fc" id="L267">			xw.writeStartElement(NAVAL_UNITS_TAG);</span>

<span class="fc bfc" id="L269" title="All 2 branches covered.">			for (AbstractUnit unit : navalUnits)</span>
<span class="fc" id="L270">				unit.toXML(xw);</span>

<span class="fc" id="L272">			xw.writeEndElement();</span>

<span class="fc" id="L274">			xw.writeStartElement(LAND_UNITS_TAG);</span>

<span class="fc bfc" id="L276" title="All 2 branches covered.">			for (AbstractUnit unit : landUnits)</span>
<span class="fc" id="L277">				unit.toXML(xw);</span>

<span class="fc" id="L279">			xw.writeEndElement();</span>

<span class="fc" id="L281">			xw.writeEndElement();</span>
<span class="fc" id="L282">		}</span>

		/**
		 * Read from XML.
		 *
		 * @param xr
		 *            the xr
		 * @throws XMLStreamException
		 *             the XML stream exception
		 */
		public void readFromXML(FreeColXMLReader xr) throws XMLStreamException {
			// Clear containers.
<span class="fc" id="L294">			navalUnits.clear();</span>
<span class="fc" id="L295">			landUnits.clear();</span>

<span class="fc bfc" id="L297" title="All 2 branches covered.">			while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L298">				final String tag = xr.getLocalName();</span>

<span class="fc bfc" id="L300" title="All 2 branches covered.">				if (LAND_UNITS_TAG.equals(tag)) {</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">					while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L302">						add(new AbstractUnit(xr));</span>
					}
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">				} else if (NAVAL_UNITS_TAG.equals(tag)) {</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">					while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="fc" id="L306">						add(new AbstractUnit(xr));</span>
					}
				} else {
<span class="nc" id="L309">					logger.warning(&quot;Bogus Force tag: &quot; + tag);</span>
				}
<span class="fc" id="L311">			}</span>
<span class="fc" id="L312">		}</span>
	}

	/** The minimum price for a monarch offer of mercenaries. */
	public static final int MONARCH_MINIMUM_PRICE = 200;

	/** The minimum price for a Hessian offer of mercenaries. */
	public static final int HESSIAN_MINIMUM_PRICE = 5000;

	/**
	 * The minimum tax rate (given in percentage) from where it can be lowered.
	 */
	public static final int MINIMUM_TAX_RATE = 20;

	/** The player of this monarch. */
	private Player player;

	/** Whether a frigate has been provided. */
<span class="fc" id="L330">	private boolean supportSea = false;</span>

	/** Whether displeasure has been incurred. */
<span class="fc" id="L333">	private boolean displeasure = false;</span>

	/** Constants describing monarch actions. */
<span class="pc" id="L336">	public static enum MonarchAction {</span>

		/** The no action. */
<span class="fc" id="L339">		NO_ACTION,</span>

		/** The raise tax act. */
<span class="fc" id="L342">		RAISE_TAX_ACT,</span>

		/** The raise tax war. */
<span class="fc" id="L345">		RAISE_TAX_WAR,</span>

		/** The force tax. */
<span class="fc" id="L348">		FORCE_TAX,</span>

		/** The lower tax war. */
<span class="fc" id="L351">		LOWER_TAX_WAR,</span>

		/** The lower tax other. */
<span class="fc" id="L354">		LOWER_TAX_OTHER,</span>

		/** The waive tax. */
<span class="fc" id="L357">		WAIVE_TAX,</span>

		/** The add to ref. */
<span class="fc" id="L360">		ADD_TO_REF,</span>

		/** The declare peace. */
<span class="fc" id="L363">		DECLARE_PEACE,</span>

		/** The declare war. */
<span class="fc" id="L366">		DECLARE_WAR,</span>

		/** The support land. */
<span class="fc" id="L369">		SUPPORT_LAND,</span>

		/** The support sea. */
<span class="fc" id="L372">		SUPPORT_SEA,</span>

		/** The monarch mercenaries. */
<span class="fc" id="L375">		MONARCH_MERCENARIES,</span>

		/** The hessian mercenaries. */
<span class="fc" id="L378">		HESSIAN_MERCENARIES,</span>

		/** The displeasure. */
<span class="fc" id="L381">		DISPLEASURE;</span>

		/**
		 * Get a key for this action.
		 *
		 * @return A message key.
		 */
		private String getKey() {
<span class="fc" id="L389">			return &quot;monarch.action.&quot; + getEnumKey(this);</span>
		}

		/**
		 * Gets the text key.
		 *
		 * @return the text key
		 */
		public String getTextKey() {
<span class="fc" id="L398">			return &quot;model.&quot; + getKey() + &quot;.text&quot;;</span>
		}

		/**
		 * Gets the yes key.
		 *
		 * @return the yes key
		 */
		public String getYesKey() {
<span class="nc" id="L407">			return &quot;model.&quot; + getKey() + &quot;.yes&quot;;</span>
		}

		/**
		 * Gets the no key.
		 *
		 * @return the no key
		 */
		public String getNoKey() {
<span class="nc" id="L416">			return &quot;model.&quot; + getKey() + &quot;.no&quot;;</span>
		}

		/**
		 * Gets the header key.
		 *
		 * @return the header key
		 */
		public String getHeaderKey() {
<span class="nc" id="L425">			return &quot;model.&quot; + getKey() + &quot;.header&quot;;</span>
		}
	}

	/**
	 * The Royal Expeditionary Force, which the Monarch will send to crush the
	 * player's rebellion.
	 */
	private Force expeditionaryForce;

	/**
	 * The Foreign Intervention Force, which some random country will send to
	 * support the player's rebellion.
	 */
	private Force interventionForce;

	// Caches. Do not serialize.
	/** The naval unit types suitable for support actions. */
<span class="fc" id="L443">	private List&lt;UnitType&gt; navalTypes = null;</span>
	/** The bombard unit types suitable for support actions. */
<span class="fc" id="L445">	private List&lt;UnitType&gt; bombardTypes = null;</span>
	/** The land unit types suitable for support actions. */
<span class="fc" id="L447">	private List&lt;UnitType&gt; landTypes = null;</span>
	/** The roles identifiers suitable for land units with support actions. */
<span class="fc" id="L449">	private Role mountedRole = null, armedRole = null, refMountedRole, refArmedRole;</span>
	/** The land unit types suitable for mercenary support. */
<span class="fc" id="L451">	private List&lt;UnitType&gt; mercenaryTypes = null;</span>
	/** The naval unit types suitable for the REF. */
<span class="fc" id="L453">	private List&lt;UnitType&gt; navalREFUnitTypes = null;</span>
	/** The land unit types suitable for the REF. */
<span class="fc" id="L455">	private List&lt;UnitType&gt; landREFUnitTypes = null;</span>

	/**
	 * Constructor.
	 *
	 * @param game
	 *            The enclosing &lt;code&gt;Game&lt;/code&gt;.
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; to create the &lt;code&gt;Monarch&lt;/code&gt;
	 *            for.
	 */
	public Monarch(Game game, Player player) {
<span class="fc" id="L467">		super(game);</span>

<span class="pc bpc" id="L469" title="1 of 2 branches missed.">		if (player == null) {</span>
<span class="nc" id="L470">			throw new IllegalStateException(&quot;player == null&quot;);</span>
		}
<span class="fc" id="L472">		this.player = player;</span>

		// The Forces rely on the spec, but in the client we have to
		// create a player(with monarch) before the spec arrives from
		// the server, so the Forces *must* be instantiated lazily.
<span class="fc" id="L477">	}</span>

	/**
	 * Initiates a new &lt;code&gt;Monarch&lt;/code&gt; with the given identifier. The
	 * object should later be initialized by calling
	 * {@link #readFromXML(FreeColXMLReader)}.
	 *
	 * @param game
	 *            The enclosing &lt;code&gt;Game&lt;/code&gt;.
	 * @param id
	 *            The object identifier.
	 */
	public Monarch(Game game, String id) {
<span class="fc" id="L490">		super(game, id);</span>

		// The Forces rely on the spec, but in the client we have to
		// create a player(with monarch) before the spec arrives from
		// the server, so the Forces *must* be instantiated lazily.
<span class="fc" id="L495">	}</span>

	/**
	 * Get the force describing the REF.
	 *
	 * @return The REF &lt;code&gt;Force&lt;/code&gt;.
	 */
	public Force getExpeditionaryForce() {
<span class="fc bfc" id="L503" title="All 2 branches covered.">		if (expeditionaryForce == null) {</span>
<span class="fc" id="L504">			final Specification spec = getSpecification();</span>
<span class="fc" id="L505">			expeditionaryForce = new Force((UnitListOption) spec.getOption(GameOptions.REF_FORCE), null);</span>
		}
<span class="fc" id="L507">		return expeditionaryForce;</span>
	}

	/**
	 * Get the force describing the Intervention Force.
	 *
	 * @return The intervention &lt;code&gt;Force&lt;/code&gt;.
	 */
	public Force getInterventionForce() {
<span class="fc bfc" id="L516" title="All 2 branches covered.">		if (interventionForce == null) {</span>
<span class="fc" id="L517">			final Specification spec = getSpecification();</span>
<span class="fc" id="L518">			interventionForce = new Force((UnitListOption) spec.getOption(GameOptions.INTERVENTION_FORCE), null);</span>
		}
<span class="fc" id="L520">		return interventionForce;</span>
	}

	/**
	 * Gets the force describing the Mercenary Force.
	 *
	 * This is never updated, and directly derived from the spec.
	 *
	 * @return The mercenary &lt;code&gt;Force&lt;/code&gt;.
	 */
	public Force getMercenaryForce() {
<span class="nc" id="L531">		final Specification spec = getSpecification();</span>
<span class="nc" id="L532">		return new Force((UnitListOption) spec.getOption(GameOptions.MERCENARY_FORCE), null);</span>
	}

	/**
	 * Get the war support force.
	 *
	 * This is never updated, and directly derived from the spec.
	 *
	 * @return The war support &lt;code&gt;Force&lt;/code&gt;.
	 */
	public Force getWarSupportForce() {
<span class="nc" id="L543">		final Specification spec = getSpecification();</span>
<span class="nc" id="L544">		return new Force((UnitListOption) spec.getOption(GameOptions.WAR_SUPPORT_FORCE), null);</span>
	}

	/**
	 * Gets the sea support status.
	 *
	 * @return Gets the sea support status.
	 */
	public boolean getSupportSea() {
<span class="nc" id="L553">		return supportSea;</span>
	}

	/**
	 * Sets the sea support status.
	 *
	 * @param supportSea
	 *            The new sea support status.
	 */
	public void setSupportSea(boolean supportSea) {
<span class="nc" id="L563">		this.supportSea = supportSea;</span>
<span class="nc" id="L564">	}</span>

	/**
	 * Gets the displeasure status.
	 *
	 * @return Gets the displeasure status.
	 */
	public boolean getDispleasure() {
<span class="nc" id="L572">		return displeasure;</span>
	}

	/**
	 * Sets the displeasure status.
	 *
	 * @param displeasure
	 *            The new displeasure status.
	 */
	public void setDispleasure(boolean displeasure) {
<span class="nc" id="L582">		this.displeasure = displeasure;</span>
<span class="nc" id="L583">	}</span>

	/**
	 * Gets the maximum tax rate in this game.
	 *
	 * @return The maximum tax rate in the game.
	 */
	private int taxMaximum() {
<span class="fc" id="L591">		return getSpecification().getInteger(GameOptions.MAXIMUM_TAX);</span>
	}

	/**
	 * Cache the unit types and roles for support and mercenary offers.
	 */
	private void initializeCaches() {
<span class="fc bfc" id="L598" title="All 2 branches covered.">		if (navalTypes != null)</span>
<span class="fc" id="L599">			return;</span>
<span class="fc" id="L600">		final Specification spec = getSpecification();</span>
<span class="fc" id="L601">		navalTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L602">		bombardTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L603">		landTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L604">		mercenaryTypes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L605">		navalREFUnitTypes = spec.getREFUnitTypes(true);</span>
<span class="fc" id="L606">		landREFUnitTypes = spec.getREFUnitTypes(false);</span>

<span class="fc bfc" id="L608" title="All 2 branches covered.">		for (UnitType unitType : spec.getUnitTypeList()) {</span>
<span class="fc bfc" id="L609" title="All 2 branches covered.">			if (unitType.hasAbility(Ability.SUPPORT_UNIT)) {</span>
<span class="fc bfc" id="L610" title="All 2 branches covered.">				if (unitType.hasAbility(Ability.NAVAL_UNIT)) {</span>
<span class="fc" id="L611">					navalTypes.add(unitType);</span>
<span class="fc bfc" id="L612" title="All 2 branches covered.">				} else if (unitType.hasAbility(Ability.BOMBARD)) {</span>
<span class="fc" id="L613">					bombardTypes.add(unitType);</span>
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">				} else if (unitType.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="fc" id="L615">					landTypes.add(unitType);</span>
				}
			}
<span class="fc bfc" id="L618" title="All 2 branches covered.">			if (unitType.hasAbility(Ability.MERCENARY_UNIT)) {</span>
<span class="fc" id="L619">				mercenaryTypes.add(unitType);</span>
			}
<span class="fc" id="L621">		}</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">		for (Role r : spec.getMilitaryRoles()) {</span>
<span class="fc" id="L623">			boolean ok = r.isAvailableTo(player, landTypes.get(0));</span>
<span class="fc" id="L624">			boolean armed = r.hasAbility(Ability.ARMED);</span>
<span class="fc" id="L625">			boolean mounted = r.hasAbility(Ability.MOUNTED);</span>
<span class="fc" id="L626">			boolean ref = r.requiresAbility(Ability.REF_UNIT);</span>
<span class="fc bfc" id="L627" title="All 4 branches covered.">			if (armed &amp;&amp; mounted) {</span>
<span class="pc bpc" id="L628" title="1 of 6 branches missed.">				if (ok &amp;&amp; !ref &amp;&amp; mountedRole == null) {</span>
<span class="fc" id="L629">					mountedRole = r;</span>
<span class="pc bpc" id="L630" title="1 of 6 branches missed.">				} else if (!ok &amp;&amp; ref &amp;&amp; refMountedRole == null) {</span>
<span class="fc" id="L631">					refMountedRole = r;</span>
				}
<span class="pc bpc" id="L633" title="1 of 4 branches missed.">			} else if (armed &amp;&amp; !mounted) {</span>
<span class="pc bpc" id="L634" title="2 of 6 branches missed.">				if (ok &amp;&amp; !ref &amp;&amp; armedRole == null) {</span>
<span class="fc" id="L635">					armedRole = r;</span>
<span class="pc bpc" id="L636" title="2 of 6 branches missed.">				} else if (!ok &amp;&amp; ref &amp;&amp; refArmedRole == null) {</span>
<span class="fc" id="L637">					refArmedRole = r;</span>
				}
			}
<span class="fc" id="L640">		}</span>

<span class="fc" id="L642">	}</span>

	/**
	 * Collects a list of potential enemies for this player.
	 *
	 * @return A list of potential enemy &lt;code&gt;Player&lt;/code&gt;s.
	 */
	public List&lt;Player&gt; collectPotentialEnemies() {
		// Benjamin Franklin puts an end to the monarch's interference
<span class="pc bpc" id="L651" title="1 of 2 branches missed.">		return (player.hasAbility(Ability.IGNORE_EUROPEAN_WARS)) ? Collections.&lt;Player&gt;emptyList()</span>
<span class="fc" id="L652">				: getGame().getLiveEuropeanPlayers(player).stream().filter(p -&gt; p.isPotentialEnemy(player))</span>
<span class="fc" id="L653">						.collect(Collectors.toList());</span>
	}

	/**
	 * Collects a list of potential friends for this player.
	 *
	 * Do not apply Franklin, he stops wars, not peace.
	 *
	 * @return A list of potential friendly &lt;code&gt;Player&lt;/code&gt;s.
	 */
	public List&lt;Player&gt; collectPotentialFriends() {
<span class="fc" id="L664">		return getGame().getLiveEuropeanPlayers(player).stream().filter(p -&gt; p.isPotentialFriend(player))</span>
<span class="fc" id="L665">				.collect(Collectors.toList());</span>
	}

	/**
	 * Checks if a specified action is valid at present.
	 *
	 * @param action
	 *            The &lt;code&gt;MonarchAction&lt;/code&gt; to check.
	 * @return True if the action is valid.
	 */
	public boolean actionIsValid(MonarchAction action) {
<span class="fc" id="L676">		initializeCaches();</span>

<span class="pc bpc" id="L678" title="5 of 13 branches missed.">		switch (action) {</span>
		case NO_ACTION:
<span class="fc" id="L680">			return true;</span>
		case RAISE_TAX_ACT:
		case RAISE_TAX_WAR:
<span class="fc bfc" id="L683" title="All 2 branches covered.">			return player.getTax() &lt; taxMaximum();</span>
		case FORCE_TAX:
<span class="nc" id="L685">			return false;</span>
		case LOWER_TAX_WAR:
		case LOWER_TAX_OTHER:
<span class="fc bfc" id="L688" title="All 2 branches covered.">			return player.getTax() &gt; MINIMUM_TAX_RATE + 10;</span>
		case WAIVE_TAX:
<span class="nc" id="L690">			return true;</span>
		case ADD_TO_REF:
<span class="pc bpc" id="L692" title="2 of 4 branches missed.">			return !(navalREFUnitTypes.isEmpty() || landREFUnitTypes.isEmpty());</span>
		case DECLARE_PEACE:
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">			return !collectPotentialFriends().isEmpty();</span>
		case DECLARE_WAR:
<span class="pc bpc" id="L696" title="1 of 2 branches missed.">			return !collectPotentialEnemies().isEmpty();</span>
		case SUPPORT_SEA:
<span class="pc bpc" id="L698" title="5 of 6 branches missed.">			return player.getAttackedByPrivateers() &amp;&amp; !getSupportSea() &amp;&amp; !getDispleasure();</span>
		case SUPPORT_LAND:
		case MONARCH_MERCENARIES:
<span class="nc bnc" id="L701" title="All 4 branches missed.">			return player.isAtWar() &amp;&amp; !getDispleasure();</span>
		case HESSIAN_MERCENARIES:
<span class="fc" id="L703">			return player.checkGold(HESSIAN_MINIMUM_PRICE);</span>
		case DISPLEASURE:
<span class="nc" id="L705">			return false;</span>
		default:
<span class="nc" id="L707">			throw new IllegalArgumentException(&quot;Bogus monarch action: &quot; + action);</span>
		}
	}

	/**
	 * Builds a weighted list of monarch actions.
	 *
	 * @return A weighted list of monarch actions.
	 */
	public List&lt;RandomChoice&lt;MonarchAction&gt;&gt; getActionChoices() {
<span class="fc" id="L717">		final Specification spec = getSpecification();</span>
<span class="fc" id="L718">		List&lt;RandomChoice&lt;MonarchAction&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L719">		int dx = 1 + spec.getInteger(GameOptions.MONARCH_MEDDLING);</span>
<span class="fc" id="L720">		int turn = getGame().getTurn().getNumber();</span>
<span class="fc" id="L721">		int grace = (6 - dx) * 10; // 10-50</span>

		// Nothing happens during the first few turns, if there are no
		// colonies, or after the revolution begins.
<span class="pc bpc" id="L725" title="1 of 6 branches missed.">		if (turn &lt; grace || player.getSettlements().isEmpty() || player.getPlayerType() != PlayerType.COLONIAL) {</span>
<span class="fc" id="L726">			return choices;</span>
		}

		// The more time has passed, the less likely the monarch will
		// do nothing.
<span class="fc" id="L731">		addIfValid(choices, MonarchAction.NO_ACTION, Math.max(200 - turn, 100));</span>
<span class="fc" id="L732">		addIfValid(choices, MonarchAction.RAISE_TAX_ACT, 5 + dx);</span>
<span class="fc" id="L733">		addIfValid(choices, MonarchAction.RAISE_TAX_WAR, 5 + dx);</span>
<span class="fc" id="L734">		addIfValid(choices, MonarchAction.LOWER_TAX_WAR, 5 - dx);</span>
<span class="fc" id="L735">		addIfValid(choices, MonarchAction.LOWER_TAX_OTHER, 5 - dx);</span>
<span class="fc" id="L736">		addIfValid(choices, MonarchAction.ADD_TO_REF, 10 + dx);</span>
<span class="fc" id="L737">		addIfValid(choices, MonarchAction.DECLARE_PEACE, 6 - dx);</span>
<span class="fc" id="L738">		addIfValid(choices, MonarchAction.DECLARE_WAR, 5 + dx);</span>
<span class="pc bpc" id="L739" title="1 of 2 branches missed.">		if (player.checkGold(MONARCH_MINIMUM_PRICE)) {</span>
<span class="nc" id="L740">			addIfValid(choices, MonarchAction.MONARCH_MERCENARIES, 6 - dx);</span>
<span class="pc bpc" id="L741" title="1 of 2 branches missed.">		} else if (dx &lt; 3) {</span>
<span class="nc" id="L742">			addIfValid(choices, MonarchAction.SUPPORT_LAND, 3 - dx);</span>
		}
<span class="fc" id="L744">		addIfValid(choices, MonarchAction.SUPPORT_SEA, 6 - dx);</span>
<span class="fc" id="L745">		addIfValid(choices, MonarchAction.HESSIAN_MERCENARIES, 6 - dx);</span>

<span class="fc" id="L747">		return choices;</span>
	}

	/**
	 * Convenience hack to check if an action is valid, and if so add it to a
	 * choice list with a given weight.
	 *
	 * @param choices
	 *            The list of choices.
	 * @param action
	 *            The &lt;code&gt;MonarchAction&lt;/code&gt; to check.
	 * @param weight
	 *            The weight to add the action with if valid.
	 */
	private void addIfValid(List&lt;RandomChoice&lt;MonarchAction&gt;&gt; choices, MonarchAction action, int weight) {
<span class="fc bfc" id="L762" title="All 2 branches covered.">		if (actionIsValid(action)) {</span>
<span class="fc" id="L763">			choices.add(new RandomChoice&lt;&gt;(action, weight));</span>
		}
<span class="fc" id="L765">	}</span>

	/**
	 * Calculates a tax raise.
	 *
	 * @param random
	 *            The &lt;code&gt;Random&lt;/code&gt; number source to use.
	 * @return The new tax rate.
	 */
	public int raiseTax(Random random) {
<span class="nc" id="L775">		final Specification spec = getSpecification();</span>
<span class="nc" id="L776">		int taxAdjustment = spec.getInteger(GameOptions.TAX_ADJUSTMENT);</span>
<span class="nc" id="L777">		int turn = getGame().getTurn().getNumber();</span>
<span class="nc" id="L778">		int oldTax = player.getTax();</span>
<span class="nc" id="L779">		int adjust = Math.max(1, (6 - taxAdjustment) * 10); // 20-60</span>
<span class="nc" id="L780">		adjust = 1 + randomInt(logger, &quot;Tax rise&quot;, random, 5 + turn / adjust);</span>
<span class="nc" id="L781">		return Math.min(oldTax + adjust, taxMaximum());</span>
	}

	/**
	 * Calculates a tax reduction.
	 *
	 * @param random
	 *            The &lt;code&gt;Random&lt;/code&gt; number source to use.
	 * @return The new tax rate.
	 */
	public int lowerTax(Random random) {
<span class="nc" id="L792">		final Specification spec = getSpecification();</span>
<span class="nc" id="L793">		int taxAdjustment = spec.getInteger(GameOptions.TAX_ADJUSTMENT);</span>
<span class="nc" id="L794">		int oldTax = player.getTax();</span>
<span class="nc" id="L795">		int adjust = Math.max(1, 10 - taxAdjustment); // 5-10</span>
<span class="nc" id="L796">		adjust = 1 + randomInt(logger, &quot;Tax reduction&quot;, random, adjust);</span>
<span class="nc" id="L797">		return Math.max(oldTax - adjust, Monarch.MINIMUM_TAX_RATE);</span>
	}

	// @compat 0.10.5
	/**
	 * Get a unit type for the REF navy. Bugfix workaround.
	 *
	 * @return A naval REF unit type.
	 */
	public UnitType getNavalREFUnitType() {
<span class="fc" id="L807">		initializeCaches();</span>
<span class="fc" id="L808">		return navalREFUnitTypes.get(0);</span>
	}
	// end @compat 0.10.5

	/**
	 * Gets units to be added to the Royal Expeditionary Force.
	 *
	 * @param random
	 *            The &lt;code&gt;Random&lt;/code&gt; number source to use.
	 * @return An addition to the Royal Expeditionary Force.
	 */
	public AbstractUnit chooseForREF(Random random) {
<span class="nc" id="L820">		initializeCaches();</span>

<span class="nc" id="L822">		final Specification spec = getSpecification();</span>
		// Preserve some extra naval capacity so that not all the REF
		// navy is completely loaded
		// FIXME: magic number 2.5 * Manowar-capacity = 15
<span class="nc" id="L826">		Force ref = getExpeditionaryForce();</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">		boolean needNaval = ref.getCapacity() &lt; ref.getSpaceRequired() + 15;</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">		List&lt;UnitType&gt; types = (needNaval) ? navalREFUnitTypes : landREFUnitTypes;</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">		if (types.isEmpty())</span>
<span class="nc" id="L830">			return null;</span>
<span class="nc" id="L831">		UnitType unitType = getRandomMember(logger, &quot;Choose REF unit&quot;, types, random);</span>
<span class="nc bnc" id="L832" title="All 4 branches missed.">		Role role = (needNaval || !unitType.hasAbility(Ability.CAN_BE_EQUIPPED)) ? spec.getDefaultRole()</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">				: (randomInt(logger, &quot;Choose land role&quot;, random, 3) == 0) ? refMountedRole : refArmedRole;</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">		int number = (needNaval) ? 1 : randomInt(logger, &quot;Choose land#&quot;, random, 3) + 1;</span>
<span class="nc" id="L835">		AbstractUnit result = new AbstractUnit(unitType, role.getId(), number);</span>
<span class="nc" id="L836">		logger.info(&quot;Add to &quot; + player.getDebugName() + &quot; REF: capacity=&quot; + ref.getCapacity() + &quot; spaceRequired=&quot;</span>
<span class="nc" id="L837">				+ ref.getSpaceRequired() + &quot; =&gt; &quot; + result);</span>
<span class="nc" id="L838">		return result;</span>
	}

	/**
	 * Update the intervention force, adding land units depending on turns
	 * passed, and naval units sufficient to transport all land units.
	 */
	public void updateInterventionForce() {
<span class="nc" id="L846">		Specification spec = getSpecification();</span>
<span class="nc" id="L847">		int interventionTurns = spec.getInteger(GameOptions.INTERVENTION_TURNS);</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">		if (interventionTurns &gt; 0) {</span>
<span class="nc" id="L849">			Force ivf = getInterventionForce();</span>
<span class="nc" id="L850">			int updates = getGame().getTurn().getNumber() / interventionTurns;</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">			for (AbstractUnit unit : ivf.getLandUnits()) {</span>
				// add units depending on current turn
<span class="nc" id="L853">				int value = unit.getNumber() + updates;</span>
<span class="nc" id="L854">				unit.setNumber(value);</span>
<span class="nc" id="L855">			}</span>
<span class="nc" id="L856">			ivf.updateSpaceAndCapacity();</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">			while (ivf.getCapacity() &lt; ivf.getSpaceRequired()) {</span>
<span class="nc" id="L858">				boolean progress = false;</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">				for (AbstractUnit ship : ivf.getNavalUnits()) {</span>
					// add ships until all units can be transported at once
<span class="nc bnc" id="L861" title="All 4 branches missed.">					if (ship.getType(spec).canCarryUnits() &amp;&amp; ship.getType(spec).getSpace() &gt; 0) {</span>
<span class="nc" id="L862">						int value = ship.getNumber() + 1;</span>
<span class="nc" id="L863">						ship.setNumber(value);</span>
<span class="nc" id="L864">						progress = true;</span>
					}
<span class="nc" id="L866">				}</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">				if (!progress)</span>
<span class="nc" id="L868">					break;</span>
<span class="nc" id="L869">				ivf.updateSpaceAndCapacity();</span>
<span class="nc" id="L870">			}</span>
		}
<span class="nc" id="L872">	}</span>

	/**
	 * Gets a additions to the colonial forces.
	 *
	 * @param random
	 *            The &lt;code&gt;Random&lt;/code&gt; number source to use.
	 * @param naval
	 *            If the addition should be a naval unit.
	 * @return An addition to the colonial forces.
	 */
	public List&lt;AbstractUnit&gt; getSupport(Random random, boolean naval) {
<span class="nc" id="L884">		initializeCaches();</span>

<span class="nc" id="L886">		final Specification spec = getSpecification();</span>
<span class="nc" id="L887">		List&lt;AbstractUnit&gt; support = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L889" title="All 2 branches missed.">		if (naval) {</span>
<span class="nc" id="L890">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose naval support&quot;, navalTypes, random),</span>
					Specification.DEFAULT_ROLE_ID, 1));
<span class="nc" id="L892">			setSupportSea(true);</span>
<span class="nc" id="L893">			return support;</span>
		}

		/**
		 * FIXME: we should use a total strength value, and randomly add
		 * individual units until that limit has been reached. E.g. given a
		 * value of 10, we might select two units with strength 5, or three
		 * units with strength 3 (plus one with strength 1, if there is one).
		 */
<span class="nc" id="L902">		int difficulty = spec.getInteger(GameOptions.MONARCH_SUPPORT);</span>
<span class="nc bnc" id="L903" title="All 6 branches missed.">		switch (difficulty) {</span>
		case 4:
<span class="nc" id="L905">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose bombard&quot;, bombardTypes, random),</span>
					Specification.DEFAULT_ROLE_ID, 1));
<span class="nc" id="L907">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L908">					mountedRole.getId(), 2));</span>
<span class="nc" id="L909">			break;</span>
		case 3:
<span class="nc" id="L911">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L912">					mountedRole.getId(), 2));</span>
<span class="nc" id="L913">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose soldier&quot;, landTypes, random),</span>
<span class="nc" id="L914">					armedRole.getId(), 1));</span>
<span class="nc" id="L915">			break;</span>
		case 2:
<span class="nc" id="L917">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L918">					mountedRole.getId(), 2));</span>
<span class="nc" id="L919">			break;</span>
		case 1:
<span class="nc" id="L921">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose mounted&quot;, landTypes, random),</span>
<span class="nc" id="L922">					mountedRole.getId(), 1));</span>
<span class="nc" id="L923">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose soldier&quot;, landTypes, random),</span>
<span class="nc" id="L924">					armedRole.getId(), 1));</span>
<span class="nc" id="L925">			break;</span>
		case 0:
<span class="nc" id="L927">			support.add(new AbstractUnit(getRandomMember(logger, &quot;Choose soldier&quot;, landTypes, random),</span>
<span class="nc" id="L928">					armedRole.getId(), 1));</span>
<span class="nc" id="L929">			break;</span>
		default:
			break;
		}
<span class="nc" id="L933">		return support;</span>
	}

	/**
	 * Check if the monarch provides support for a war.
	 *
	 * @param enemy
	 *            The enemy &lt;code&gt;Player&lt;/code&gt;.
	 * @param random
	 *            A pseudo-random number source.
	 * @return A list of &lt;code&gt;AbstractUnit&lt;/code&gt;s provided as support.
	 */
	public List&lt;AbstractUnit&gt; getWarSupport(Player enemy, Random random) {
<span class="nc" id="L946">		final Specification spec = getSpecification();</span>
<span class="nc" id="L947">		final double baseStrength = player.calculateStrength(false);</span>
<span class="nc" id="L948">		final double enemyStrength = enemy.calculateStrength(false);</span>
<span class="nc" id="L949">		final double strengthRatio = Player.strengthRatio(baseStrength, enemyStrength);</span>
<span class="nc" id="L950">		List&lt;AbstractUnit&gt; result = new ArrayList&lt;AbstractUnit&gt;();</span>
		// We do not really know what Col1 did to decide whether to
		// provide war support, so we have made something up.
		//
		// Strength ratios are in [0, 1]. Support is granted in negative
		// proportion to the base strength ratio, such that we always
		// support if the enemy is stronger (ratio &lt; 0.5), and never
		// support if the player is more than 50% stronger (ratio &gt;
		// 0.6). However if war support force sufficiently large with
		// respect to the current player and enemy forces it will be
		// reduced.
		// The principle at work is that the Crown is cautious/stingy.
<span class="nc" id="L962">		final double NOSUPPORT = 0.6;</span>
<span class="nc" id="L963">		double p = 10.0 * (NOSUPPORT - strengthRatio);</span>
<span class="nc bnc" id="L964" title="All 4 branches missed.">		if (p &gt;= 1.0 // Avoid calling randomDouble if unnecessary</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">				|| (p &gt; 0.0 &amp;&amp; p &gt; randomDouble(logger, &quot;War support?&quot;, random))) {</span>
<span class="nc" id="L966">			Force wsf = getWarSupportForce();</span>
<span class="nc" id="L967">			result.addAll(wsf.getUnits());</span>
			double supportStrength, fullRatio, strength, ratio;
<span class="nc" id="L969">			supportStrength = wsf.calculateStrength(false);</span>
<span class="nc" id="L970">			fullRatio = Player.strengthRatio(baseStrength + supportStrength, enemyStrength);</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">			if (fullRatio &lt; NOSUPPORT) { // Full support, some randomization</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">				for (AbstractUnit au : result) {</span>
<span class="nc" id="L973">					int amount = au.getNumber();</span>
<span class="nc" id="L974">					amount += randomInt(logger, &quot;Vary war force &quot; + au.getId(), random, 3) - 1;</span>
<span class="nc" id="L975">					au.setNumber(amount);</span>
<span class="nc" id="L976">				}</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">			} else if (enemyStrength &lt;= 0.0) { // Enemy is defenceless: 1 unit</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">				while (result.size() &gt; 1)</span>
<span class="nc" id="L979">					result.remove(0);</span>
<span class="nc" id="L980">				result.get(0).setNumber(1);</span>
			} else { // Reduce force until below NOSUPPORT or single unit/s
<span class="nc bnc" id="L982" title="All 2 branches missed.">				outer: for (AbstractUnit au : result) {</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">					for (int n = au.getNumber() - 1; n &gt;= 1; n--) {</span>
<span class="nc" id="L984">						au.setNumber(n);</span>
<span class="nc" id="L985">						strength = AbstractUnit.calculateStrength(spec, result);</span>
<span class="nc" id="L986">						ratio = Player.strengthRatio(baseStrength + strength, enemyStrength);</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">						if (ratio &lt; NOSUPPORT)</span>
<span class="nc" id="L988">							break outer;</span>
					}
<span class="nc" id="L990">				}</span>
			}
<span class="nc" id="L992">			strength = AbstractUnit.calculateStrength(spec, result);</span>
<span class="nc" id="L993">			ratio = Player.strengthRatio(baseStrength + strength, enemyStrength);</span>
<span class="nc" id="L994">			logger.finest(&quot;War support:&quot; + &quot; initially=&quot; + supportStrength + &quot;/&quot; + fullRatio + &quot; finally=&quot; + strength</span>
					+ &quot;/&quot; + ratio);
		}
<span class="nc" id="L997">		return result;</span>
	}

	/**
	 * Gets some units available as mercenaries.
	 *
	 * @param random
	 *            The &lt;code&gt;Random&lt;/code&gt; number source to use.
	 * @return A troop of mercenaries.
	 */
	public List&lt;AbstractUnit&gt; getMercenaries(Random random) {
<span class="nc" id="L1008">		initializeCaches();</span>

<span class="nc" id="L1010">		final Specification spec = getSpecification();</span>
<span class="nc" id="L1011">		final Role defaultRole = spec.getDefaultRole();</span>
<span class="nc" id="L1012">		final int mercPrice = spec.getInteger(GameOptions.MERCENARY_PRICE);</span>
<span class="nc" id="L1013">		List&lt;Role&gt; landRoles = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1014">		landRoles.add(armedRole);</span>
<span class="nc" id="L1015">		landRoles.add(mountedRole);</span>

		// FIXME: magic numbers for 2-4 mercs
<span class="nc" id="L1018">		List&lt;AbstractUnit&gt; mercs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1019">		int count = randomInt(logger, &quot;Mercenary count&quot;, random, 2) + 2;</span>
<span class="nc" id="L1020">		int price = 0;</span>
<span class="nc" id="L1021">		UnitType unitType = null;</span>
<span class="nc" id="L1022">		List&lt;UnitType&gt; unitTypes = new ArrayList&lt;&gt;(mercenaryTypes);</span>
<span class="nc bnc" id="L1023" title="All 4 branches missed.">		while (!unitTypes.isEmpty() &amp;&amp; count &gt; 0) {</span>
<span class="nc" id="L1024">			unitType = getRandomMember(logger, &quot;Merc unit&quot;, unitTypes, random);</span>
<span class="nc" id="L1025">			unitTypes.remove(unitType);</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">			Role role = (unitType.hasAbility(Ability.CAN_BE_EQUIPPED))</span>
<span class="nc" id="L1027">					? getRandomMember(logger, &quot;Merc role&quot;, landRoles, random) : defaultRole;</span>
<span class="nc" id="L1028">			int n = randomInt(logger, &quot;Merc count &quot; + unitType, random, Math.min(count, 2)) + 1;</span>
<span class="nc" id="L1029">			AbstractUnit au = new AbstractUnit(unitType, role.getId(), n);</span>
			for (;;) {
<span class="nc" id="L1031">				int newPrice = player.getPrice(au) * mercPrice / 100;</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">				if (player.checkGold(price + newPrice)) {</span>
<span class="nc" id="L1033">					mercs.add(au);</span>
<span class="nc" id="L1034">					price += newPrice;</span>
<span class="nc" id="L1035">					count -= n;</span>
<span class="nc" id="L1036">					break;</span>
				}
<span class="nc bnc" id="L1038" title="All 2 branches missed.">				if (--n &lt;= 0)</span>
<span class="nc" id="L1039">					break;</span>
<span class="nc" id="L1040">				au.setNumber(n);</span>
<span class="nc" id="L1041">			}</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">			if (count &lt;= 0)</span>
<span class="nc" id="L1043">				break;</span>
<span class="nc" id="L1044">		}</span>

		/* Always return something, even if it is not affordable */
<span class="nc bnc" id="L1047" title="All 4 branches missed.">		if (mercs.isEmpty() &amp;&amp; unitType != null) {</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">			Role r = (unitType.hasAbility(Ability.CAN_BE_EQUIPPED)) ? armedRole : defaultRole;</span>
<span class="nc" id="L1049">			mercs.add(new AbstractUnit(unitType, r.getId(), 1));</span>
		}
<span class="nc" id="L1051">		return mercs;</span>
	}

	// Interface Named

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String getNameKey() {
<span class="nc" id="L1061">		return this.player.getNation().getRulerNameKey();</span>
	}

	// Override FreeColGameObject

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int checkIntegrity(boolean fix) {
<span class="fc" id="L1071">		int result = super.checkIntegrity(fix);</span>
		// @compat 0.10.x
		// Detects/fixes bogus expeditionary force roles
<span class="fc" id="L1074">		List&lt;AbstractUnit&gt; todo = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1075">		Force ref = getExpeditionaryForce();</span>
<span class="fc" id="L1076">		Iterator&lt;AbstractUnit&gt; it = ref.getLandUnits().iterator();</span>
<span class="fc bfc" id="L1077" title="All 2 branches covered.">		while (it.hasNext()) {</span>
<span class="fc" id="L1078">			AbstractUnit au = it.next();</span>
<span class="pc bpc" id="L1079" title="1 of 2 branches missed.">			if (&quot;model.role.soldier&quot;.equals(au.getRoleId())) {</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">				if (fix) {</span>
<span class="nc" id="L1081">					au.setRoleId(&quot;model.role.infantry&quot;);</span>
<span class="nc" id="L1082">					result = 0;</span>
<span class="nc" id="L1083">					it.remove();</span>
<span class="nc" id="L1084">					todo.add(au);</span>
				} else {
<span class="nc" id="L1086">					return -1;</span>
				}
			}
<span class="pc bpc" id="L1089" title="1 of 2 branches missed.">			if (&quot;model.role.dragoon&quot;.equals(au.getRoleId())) {</span>
<span class="nc bnc" id="L1090" title="All 2 branches missed.">				if (fix) {</span>
<span class="nc" id="L1091">					au.setRoleId(&quot;model.role.cavalry&quot;);</span>
<span class="nc" id="L1092">					result = 0;</span>
<span class="nc" id="L1093">					it.remove();</span>
<span class="nc" id="L1094">					todo.add(au);</span>
				} else {
<span class="nc" id="L1096">					return -1;</span>
				}
			}
<span class="fc" id="L1099">		}</span>
<span class="pc bpc" id="L1100" title="1 of 2 branches missed.">		for (AbstractUnit au : todo)</span>
<span class="nc" id="L1101">			ref.add(au);</span>
		// end @compat 0.10.x
<span class="fc" id="L1103">		return result;</span>
	}

	// Serialization

	/** The Constant DISPLEASURE_TAG. */
	private static final String DISPLEASURE_TAG = &quot;displeasure&quot;;

	/** The Constant EXPEDITIONARY_FORCE_TAG. */
	private static final String EXPEDITIONARY_FORCE_TAG = &quot;expeditionaryForce&quot;;

	/** The Constant INTERVENTION_FORCE_TAG. */
	private static final String INTERVENTION_FORCE_TAG = &quot;interventionForce&quot;;

	/** The Constant PLAYER_TAG. */
	private static final String PLAYER_TAG = &quot;player&quot;;

	/** The Constant SUPPORT_SEA_TAG. */
	private static final String SUPPORT_SEA_TAG = &quot;supportSea&quot;;

	/** The Constant NAME_TAG. */
	// @compat 0.11.1
	private static final String NAME_TAG = &quot;name&quot;;
	// end @compat 0.11.1
	/** The Constant MERCENARY_FORCE_TAG. */
	// @compat 0.11.5
	private static final String MERCENARY_FORCE_TAG = &quot;mercenaryForce&quot;;
	// end @compat 0.11.5

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected void writeAttributes(FreeColXMLWriter xw) throws XMLStreamException {
<span class="fc" id="L1137">		super.writeAttributes(xw);</span>

<span class="fc" id="L1139">		xw.writeAttribute(PLAYER_TAG, this.player);</span>

<span class="pc bpc" id="L1141" title="1 of 2 branches missed.">		if (xw.validFor(this.player)) {</span>

<span class="fc" id="L1143">			xw.writeAttribute(SUPPORT_SEA_TAG, supportSea);</span>

<span class="fc" id="L1145">			xw.writeAttribute(DISPLEASURE_TAG, displeasure);</span>
		}
<span class="fc" id="L1147">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected void writeChildren(FreeColXMLWriter xw) throws XMLStreamException {
<span class="fc" id="L1154">		super.writeChildren(xw);</span>

<span class="pc bpc" id="L1156" title="1 of 2 branches missed.">		if (xw.validFor(this.player)) {</span>

<span class="fc" id="L1158">			getExpeditionaryForce().toXML(xw, EXPEDITIONARY_FORCE_TAG);</span>

<span class="fc" id="L1160">			getInterventionForce().toXML(xw, INTERVENTION_FORCE_TAG);</span>
		}
<span class="fc" id="L1162">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected void readAttributes(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L1169">		super.readAttributes(xr);</span>

<span class="fc" id="L1171">		player = xr.findFreeColGameObject(getGame(), PLAYER_TAG, Player.class, (Player) null, true);</span>

<span class="fc" id="L1173">		supportSea = xr.getAttribute(SUPPORT_SEA_TAG, false);</span>

<span class="fc" id="L1175">		displeasure = xr.getAttribute(DISPLEASURE_TAG, false);</span>
<span class="fc" id="L1176">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected void readChildren(FreeColXMLReader xr) throws XMLStreamException {
		// Provide dummy forces to read into.
<span class="pc bpc" id="L1184" title="1 of 2 branches missed.">		if (expeditionaryForce == null)</span>
<span class="fc" id="L1185">			expeditionaryForce = new Force();</span>
<span class="pc bpc" id="L1186" title="1 of 2 branches missed.">		if (interventionForce == null)</span>
<span class="fc" id="L1187">			interventionForce = new Force();</span>

<span class="fc" id="L1189">		super.readChildren(xr);</span>
<span class="fc" id="L1190">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected void readChild(FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L1197">		final String tag = xr.getLocalName();</span>

<span class="fc bfc" id="L1199" title="All 2 branches covered.">		if (EXPEDITIONARY_FORCE_TAG.equals(tag)) {</span>
<span class="fc" id="L1200">			expeditionaryForce.readFromXML(xr);</span>
			// @compat 0.11.3
<span class="fc" id="L1202">			expeditionaryForce.fixOldREFRoles();</span>
			// end @compat 0.11.3

<span class="pc bpc" id="L1205" title="1 of 2 branches missed.">		} else if (INTERVENTION_FORCE_TAG.equals(tag)) {</span>
<span class="fc" id="L1206">			interventionForce.readFromXML(xr);</span>

			// @compat 0.10.5
<span class="nc bnc" id="L1209" title="All 2 branches missed.">		} else if (Force.LAND_UNITS_TAG.equals(tag)) {</span>
<span class="nc" id="L1210">			expeditionaryForce.getLandUnits().clear();</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">			while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="nc" id="L1212">				AbstractUnit newUnit = new AbstractUnit(xr);</span>
<span class="nc" id="L1213">				expeditionaryForce.getLandUnits().add(newUnit);</span>
<span class="nc" id="L1214">			}</span>
			// end @compat

			// @compat 0.11.5
			// Mercenary force is never updated, and lives in the spec now, so
			// just read and discard it.
<span class="nc bnc" id="L1220" title="All 2 branches missed.">		} else if (MERCENARY_FORCE_TAG.equals(tag)) {</span>
<span class="nc" id="L1221">			new Force().readFromXML(xr);</span>
			// end @compat 0.11.5

			// @compat 0.10.5
<span class="nc bnc" id="L1225" title="All 2 branches missed.">		} else if (Force.NAVAL_UNITS_TAG.equals(tag)) {</span>
<span class="nc" id="L1226">			expeditionaryForce.getNavalUnits().clear();</span>
<span class="nc bnc" id="L1227" title="All 2 branches missed.">			while (xr.nextTag() != XMLStreamConstants.END_ELEMENT) {</span>
<span class="nc" id="L1228">				AbstractUnit newUnit = new AbstractUnit(xr);</span>
<span class="nc" id="L1229">				expeditionaryForce.getNavalUnits().add(newUnit);</span>
<span class="nc" id="L1230">			}</span>
			// end @compat

		} else {
<span class="nc" id="L1234">			super.readChild(xr);</span>
		}
<span class="fc" id="L1236">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String getXMLTagName() {
<span class="fc" id="L1243">		return getXMLElementTagName();</span>
	}

	/**
	 * Gets the tag name of the root element representing this object.
	 *
	 * @return &quot;monarch&quot;.
	 */
	public static String getXMLElementTagName() {
<span class="fc" id="L1252">		return &quot;monarch&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>