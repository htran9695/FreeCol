<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleMapGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.generator</a> &gt; <span class="el_source">SimpleMapGenerator.java</span></div><h1>SimpleMapGenerator.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.generator;

import java.io.File;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.logging.Logger;

import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.BuildingType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.EuropeanNationType;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.IndianNationType;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.LandMap;
import net.sf.freecol.common.model.LostCityRumour;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.Map.Position;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.NationType;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovement;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TileType;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.option.IntegerOption;
import net.sf.freecol.common.option.FileOption;
import net.sf.freecol.common.option.MapGeneratorOptions;
import net.sf.freecol.common.option.OptionGroup;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.server.FreeColServer;
import net.sf.freecol.server.model.ServerBuilding;
import net.sf.freecol.server.model.ServerColony;
import net.sf.freecol.server.model.ServerIndianSettlement;
import net.sf.freecol.server.model.ServerPlayer;
import net.sf.freecol.server.model.ServerRegion;
import net.sf.freecol.server.model.ServerUnit;

/**
 * Creates random maps and sets the starting locations for the players.
 *
 * No visibility implications here as this all happens pre-game, so no +/-vis
 * annotations are needed.
 */
public class SimpleMapGenerator implements MapGenerator {

	/** The Constant logger. */
<span class="fc" id="L90">	private static final Logger logger = Logger.getLogger(SimpleMapGenerator.class.getName());</span>

	/**
	 * To avoid starting positions too close to the poles, this percentage
	 * indicating how much of the half map close to the pole cannot be spawned
	 * on.
	 */
	private static final float MIN_DISTANCE_FROM_POLE = 0.30f;

	/**
	 * The Class Territory.
	 */
	private static class Territory {

		/** The region. */
		public ServerRegion region;

		/** The tile. */
		public Tile tile;

		/** The player. */
		public final Player player;

		/** The number of settlements. */
		public int numberOfSettlements;

		/**
		 * Instantiates a new territory.
		 *
		 * @param player
		 *            the player
		 * @param tile
		 *            the tile
		 */
<span class="nc" id="L124">		public Territory(Player player, Tile tile) {</span>
<span class="nc" id="L125">			this.player = player;</span>
<span class="nc" id="L126">			this.tile = tile;</span>
<span class="nc" id="L127">		}</span>

		/**
		 * Instantiates a new territory.
		 *
		 * @param player
		 *            the player
		 * @param region
		 *            the region
		 */
<span class="fc" id="L137">		public Territory(Player player, ServerRegion region) {</span>
<span class="fc" id="L138">			this.player = player;</span>
<span class="fc" id="L139">			this.region = region;</span>
<span class="fc" id="L140">		}</span>

		/**
		 * Gets the center tile.
		 *
		 * @param map
		 *            the map
		 * @return the center tile
		 */
		public Tile getCenterTile(Map map) {
<span class="fc bfc" id="L150" title="All 2 branches covered.">			if (tile != null)</span>
<span class="fc" id="L151">				return tile;</span>
<span class="fc" id="L152">			int[] xy = region.getCenter();</span>
<span class="fc" id="L153">			return map.getTile(xy[0], xy[1]);</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public String toString() {
<span class="nc" id="L161">			return player + &quot; territory at &quot; + region;</span>
		}
	}

	/** The game to generate for. */
	private final Game game;

	/** The random number source. */
	private final Random random;

	/** The cached map generator options. */
	private OptionGroup mapOptions;

	/** The cached specification to use. */
	private Specification spec;

	/** The game to selectively import from. */
	private Game importGame;

	/**
	 * Creates a &lt;code&gt;MapGenerator&lt;/code&gt;.
	 *
	 * @param game
	 *            The &lt;code&gt;Game&lt;/code&gt; to generate for.
	 * @param random
	 *            The &lt;code&gt;Random&lt;/code&gt; number source to use.
	 * @see #createMap
	 */
<span class="fc" id="L189">	public SimpleMapGenerator(Game game, Random random) {</span>
<span class="fc" id="L190">		this.game = game;</span>
<span class="fc" id="L191">		this.random = random;</span>
<span class="fc" id="L192">	}</span>

	/**
	 * Update the cached variables.
	 *
	 * @param checkImport
	 *            Check for an import file or not.
	 */
	private void recache(boolean checkImport) {
<span class="fc" id="L201">		this.mapOptions = game.getMapGeneratorOptions();</span>
<span class="fc" id="L202">		this.spec = game.getSpecification();</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">		File importFile = (checkImport)</span>
<span class="pc" id="L204">				? ((FileOption) this.mapOptions.getOption(MapGeneratorOptions.IMPORT_FILE)).getValue() : null;</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">		this.importGame = (importFile == null) ? null : FreeColServer.readGame(importFile, this.spec, null);</span>
<span class="fc" id="L206">	}</span>

	/**
	 * Gets the approximate number of land tiles.
	 *
	 * @return The approximate number of land tiles
	 */
	private int getApproximateLandCount() {
<span class="fc" id="L214">		return mapOptions.getInteger(MapGeneratorOptions.MAP_WIDTH)</span>
<span class="fc" id="L215">				* mapOptions.getInteger(MapGeneratorOptions.MAP_HEIGHT)</span>
<span class="fc" id="L216">				* mapOptions.getInteger(MapGeneratorOptions.LAND_MASS) / 100;</span>
	}

	/**
	 * Make lost city rumours on the given map.
	 *
	 * The number of rumours depends on the map size.
	 *
	 * @param map
	 *            The &lt;code&gt;Map&lt;/code&gt; to use.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void makeLostCityRumours(Map map, LogBuilder lb) {
<span class="fc" id="L230">		final boolean importRumours = mapOptions.getBoolean(MapGeneratorOptions.IMPORT_RUMOURS);</span>
<span class="pc bpc" id="L231" title="1 of 4 branches missed.">		if (importGame != null &amp;&amp; importRumours) {</span>
<span class="nc" id="L232">			int nLCRs = 0;</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">			for (Tile importTile : importGame.getMap().getAllTiles()) {</span>
<span class="nc" id="L234">				LostCityRumour rumour = importTile.getLostCityRumour();</span>
				// no rumor
<span class="nc bnc" id="L236" title="All 2 branches missed.">				if (rumour == null)</span>
<span class="nc" id="L237">					continue;</span>
<span class="nc" id="L238">				int x = importTile.getX();</span>
<span class="nc" id="L239">				int y = importTile.getY();</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">				if (map.isValid(x, y)) {</span>
<span class="nc" id="L241">					final Tile t = map.getTile(x, y);</span>
<span class="nc" id="L242">					rumour.setLocation(t);</span>
<span class="nc" id="L243">					t.addLostCityRumour(rumour);</span>
<span class="nc" id="L244">					nLCRs++;</span>
				}
<span class="nc" id="L246">			}</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">			if (nLCRs &gt; 0) {</span>
<span class="nc" id="L248">				lb.add(&quot;Imported &quot;, nLCRs, &quot; lost city rumours.\n&quot;);</span>
<span class="nc" id="L249">				return;</span>
			}
			// Otherwise fall through and create them
		}

<span class="fc" id="L254">		final int rumourNumber = mapOptions.getInteger(MapGeneratorOptions.RUMOUR_NUMBER);</span>
<span class="fc" id="L255">		int number = getApproximateLandCount() / rumourNumber;</span>
<span class="fc" id="L256">		int counter = 0;</span>

		// FIXME: Remove temporary fix:
<span class="fc bfc" id="L259" title="All 2 branches covered.">		if (importGame != null) {</span>
<span class="fc" id="L260">			number = map.getWidth() * map.getHeight() * 25 / (100 * 35);</span>
		}

<span class="fc bfc" id="L263" title="All 2 branches covered.">		for (int i = 0; i &lt; number; i++) {</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">			for (int tries = 0; tries &lt; 100; tries++) {</span>
<span class="fc" id="L265">				Tile t = map.getRandomLandTile(random);</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">				if (t.isPolar())</span>
<span class="fc" id="L267">					continue; // No polar lost cities</span>
<span class="pc bpc" id="L268" title="2 of 8 branches missed.">				if (t.isLand() &amp;&amp; !t.hasLostCityRumour() &amp;&amp; !t.hasSettlement() &amp;&amp; t.getUnitCount() == 0) {</span>
<span class="fc" id="L269">					LostCityRumour r = new LostCityRumour(t.getGame(), t);</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">					if (r.chooseType(null, random) == LostCityRumour.RumourType.MOUNDS</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">							&amp;&amp; t.getOwningSettlement() != null) {</span>
<span class="fc" id="L272">						r.setType(LostCityRumour.RumourType.MOUNDS);</span>
					}
<span class="fc" id="L274">					t.addLostCityRumour(r);</span>
<span class="fc" id="L275">					counter++;</span>
<span class="fc" id="L276">					break;</span>
				}
			}
		}
<span class="fc" id="L280">		lb.add(&quot;Created &quot;, counter, &quot; lost city rumours of maximum &quot;, number, &quot;.\n&quot;);</span>
<span class="fc" id="L281">	}</span>

	/**
	 * Import indian settlements.
	 *
	 * @param map
	 *            the map
	 * @param lb
	 *            the lb
	 * @return true, if successful
	 */
	private boolean importIndianSettlements(Map map, LogBuilder lb) {
<span class="nc" id="L293">		int nSettlements = 0;</span>

<span class="nc bnc" id="L295" title="All 2 branches missed.">		for (Player player : importGame.getLiveNativePlayers(null)) {</span>
<span class="nc" id="L296">			Player indian = game.getPlayerByNationId(player.getNationId());</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">			if (indian == null) {</span>
<span class="nc" id="L298">				Nation nation = spec.getNation(player.getNationId());</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">				if (nation == null) {</span>
<span class="nc" id="L300">					lb.add(&quot;Native nation &quot;, player.getNationId(), &quot; not found in spec.\n&quot;);</span>
<span class="nc" id="L301">					continue;</span>
				}
<span class="nc" id="L303">				indian = new ServerPlayer(game, false, nation, null, null);</span>
<span class="nc" id="L304">				lb.add(&quot;Imported new native nation &quot;, player.getNationId(), &quot;: &quot;, indian.getId(), &quot;\n&quot;);</span>
<span class="nc" id="L305">				game.addPlayer(indian);</span>
<span class="nc" id="L306">			} else {</span>
<span class="nc" id="L307">				lb.add(&quot;Found native nation &quot;, player.getNationId(), &quot; for import: &quot;, indian.getId(), &quot;\n&quot;);</span>
			}
<span class="nc" id="L309">		}</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">		for (Tile tile : importGame.getMap().getAllTiles()) {</span>
<span class="nc" id="L311">			IndianSettlement is = tile.getIndianSettlement();</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">			if (is == null)</span>
<span class="nc" id="L313">				continue;</span>
<span class="nc" id="L314">			Player indian = game.getPlayerByNationId(is.getOwner().getNationId());</span>
<span class="nc" id="L315">			ServerIndianSettlement settlement = new ServerIndianSettlement(game, indian, is.getName(),</span>
<span class="nc" id="L316">					map.getTile(tile.getX(), tile.getY()), is.isCapital(), is.getLearnableSkill(), null);</span>
<span class="nc" id="L317">			settlement.placeSettlement(false);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">			for (Tile t : is.getOwnedTiles()) {</span>
<span class="nc" id="L319">				map.getTile(t.getX(), t.getY()).changeOwnership(indian, settlement);</span>
<span class="nc" id="L320">			}</span>

<span class="nc" id="L322">			List&lt;Unit&gt; units = is.getUnitList();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">			if (units.isEmpty()) {</span>
<span class="nc" id="L324">				settlement.addUnits(random);</span>
			} else {
<span class="nc bnc" id="L326" title="All 2 branches missed.">				for (Unit unit : units) {</span>
<span class="nc" id="L327">					UnitType t = spec.getUnitType(unit.getType().getId());</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">					if (t != null) {</span>
<span class="nc" id="L329">						Unit u = new ServerUnit(game, settlement, indian, t);</span>
<span class="nc" id="L330">						settlement.add(u);</span>
<span class="nc" id="L331">						settlement.addOwnedUnit(u);</span>
					}
<span class="nc" id="L333">				}</span>
			}

<span class="nc" id="L336">			List&lt;Goods&gt; goods = is.getCompactGoods();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">			if (goods.isEmpty()) {</span>
<span class="nc" id="L338">				settlement.addRandomGoods(random);</span>
			} else {
<span class="nc bnc" id="L340" title="All 2 branches missed.">				for (Goods g : goods) {</span>
<span class="nc" id="L341">					GoodsType t = spec.getGoodsType(g.getType().getId());</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">					if (t != null) {</span>
<span class="nc" id="L343">						settlement.addGoods(t, g.getAmount());</span>
					}
<span class="nc" id="L345">				}</span>
			}
<span class="nc" id="L347">			settlement.setWantedGoods(is.getWantedGoods());</span>
<span class="nc" id="L348">			indian.addSettlement(settlement);</span>
<span class="nc" id="L349">			nSettlements++;</span>
<span class="nc" id="L350">		}</span>

<span class="nc bnc" id="L352" title="All 2 branches missed.">		if (nSettlements &gt; 0) {</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">			for (Tile t : importGame.getMap().getAllTiles()) {</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">				if (t.getOwner() == null)</span>
<span class="nc" id="L355">					continue;</span>
<span class="nc" id="L356">				Player owner = game.getPlayerByNationId(t.getOwner().getNationId());</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">				if (owner == null)</span>
<span class="nc" id="L358">					continue;</span>
<span class="nc" id="L359">				Tile tile = map.getTile(t.getX(), t.getY());</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">				if (tile == null)</span>
<span class="nc" id="L361">					continue;</span>
<span class="nc" id="L362">				tile.setOwner(owner);</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">				if (tile.getOwningSettlement() != null) {</span>
<span class="nc" id="L364">					String name = tile.getOwningSettlement().getName();</span>
<span class="nc" id="L365">					Settlement is = game.getSettlementByName(name);</span>
<span class="nc" id="L366">					tile.setOwningSettlement(is);</span>
				}
<span class="nc" id="L368">			}</span>
		}
<span class="nc" id="L370">		lb.add(&quot;Imported &quot;, nSettlements, &quot; native settlements.\n&quot;);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">		return nSettlements &gt; 0;</span>
	}

	/**
	 * Make the native settlements, at least a capital for every nation and
	 * random numbers of other settlements.
	 *
	 * @param map
	 *            The &lt;code&gt;Map&lt;/code&gt; to place the indian settlements on.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void makeNativeSettlements(final Map map, LogBuilder lb) {
<span class="fc" id="L384">		final boolean importSettlements = mapOptions.getBoolean(MapGeneratorOptions.IMPORT_SETTLEMENTS);</span>
<span class="pc bpc" id="L385" title="3 of 4 branches missed.">		if (importSettlements &amp;&amp; importGame != null) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">			if (importIndianSettlements(map, lb))</span>
<span class="nc" id="L387">				return;</span>
			// Fall through and create them
		}

<span class="fc" id="L391">		final Game game = map.getGame();</span>
<span class="fc" id="L392">		float shares = 0f;</span>
<span class="fc" id="L393">		List&lt;IndianSettlement&gt; settlements = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L394">		List&lt;Player&gt; indians = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L395">		HashMap&lt;String, Territory&gt; territoryMap = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L397" title="All 2 branches covered.">		for (Player player : game.getLiveNativePlayers(null)) {</span>
<span class="pc bpc" id="L398" title="1 of 4 branches missed.">			switch (player.getNationType().getNumberOfSettlements()) {</span>
			case HIGH:
<span class="fc" id="L400">				shares += 4;</span>
<span class="fc" id="L401">				break;</span>
			case AVERAGE:
<span class="fc" id="L403">				shares += 3;</span>
<span class="fc" id="L404">				break;</span>
			case LOW:
<span class="fc" id="L406">				shares += 2;</span>
				break;
			}
<span class="fc" id="L409">			indians.add(player);</span>
<span class="fc" id="L410">			List&lt;String&gt; regionKeys = ((IndianNationType) player.getNationType()).getRegionNames();</span>
<span class="fc" id="L411">			Territory territory = null;</span>
<span class="pc bpc" id="L412" title="2 of 4 branches missed.">			if (regionKeys == null || regionKeys.isEmpty()) {</span>
<span class="nc" id="L413">				territory = new Territory(player, map.getRandomLandTile(random));</span>
<span class="nc" id="L414">				territoryMap.put(player.getId(), territory);</span>
			} else {
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">				for (String key : regionKeys) {</span>
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">					if (territoryMap.get(key) == null) {</span>
<span class="fc" id="L418">						ServerRegion region = (ServerRegion) map.getRegionByKey(key);</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">						if (region == null) {</span>
<span class="nc" id="L420">							territory = new Territory(player, map.getRandomLandTile(random));</span>
						} else {
<span class="fc" id="L422">							territory = new Territory(player, region);</span>
						}
<span class="fc" id="L424">						territoryMap.put(key, territory);</span>
<span class="fc" id="L425">						lb.add(&quot;Allocated region &quot;, key, &quot; for &quot;, player, &quot;.\n&quot;);</span>
<span class="fc" id="L426">						break;</span>
					}
<span class="nc" id="L428">				}</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">				if (territory == null) {</span>
<span class="nc" id="L430">					lb.add(&quot;Failed to allocate preferred region &quot;, regionKeys.get(0), &quot; for &quot;, player.getNation(),</span>
							&quot;\n&quot;);
<span class="nc bnc" id="L432" title="All 2 branches missed.">					outer: for (String key : regionKeys) {</span>
<span class="nc" id="L433">						Territory otherTerritory = territoryMap.get(key);</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">						for (String otherKey : ((IndianNationType) otherTerritory.player.getNationType())</span>
<span class="nc" id="L435">								.getRegionNames()) {</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">							if (territoryMap.get(otherKey) == null) {</span>
<span class="nc" id="L437">								ServerRegion foundRegion = otherTerritory.region;</span>
<span class="nc" id="L438">								otherTerritory.region = (ServerRegion) map.getRegionByKey(otherKey);</span>
<span class="nc" id="L439">								territoryMap.put(otherKey, otherTerritory);</span>
<span class="nc" id="L440">								territory = new Territory(player, foundRegion);</span>
<span class="nc" id="L441">								territoryMap.put(key, territory);</span>
<span class="nc" id="L442">								break outer;</span>
							}
<span class="nc" id="L444">						}</span>
<span class="nc" id="L445">					}</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">					if (territory == null) {</span>
<span class="nc" id="L447">						lb.add(&quot;Unable to find free region for &quot;, player.getName(), &quot;\n&quot;);</span>
<span class="nc" id="L448">						territory = new Territory(player, map.getRandomLandTile(random));</span>
<span class="nc" id="L449">						territoryMap.put(player.getId(), territory);</span>
					}
				}
			}
<span class="fc" id="L453">		}</span>
<span class="fc bfc" id="L454" title="All 2 branches covered.">		if (indians.isEmpty())</span>
<span class="fc" id="L455">			return;</span>

		// Examine all the non-polar settleable tiles in a random
		// order picking out as many as possible suitable tiles for
		// native settlements such that can be guaranteed at least one
		// layer of surrounding tiles to own.
<span class="fc" id="L461">		List&lt;Tile&gt; allTiles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">		for (Tile t : map.getAllTiles())</span>
<span class="fc" id="L463">			allTiles.add(t);</span>
<span class="fc" id="L464">		randomShuffle(logger, &quot;All tile shuffle&quot;, allTiles, random);</span>
<span class="fc" id="L465">		final int minDistance = spec.getRangeOption(GameOptions.SETTLEMENT_NUMBER).getValue();</span>
<span class="fc" id="L466">		List&lt;Tile&gt; settlementTiles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">		for (Tile tile : allTiles) {</span>
<span class="fc bfc" id="L468" title="All 4 branches covered.">			if (!tile.isPolar() &amp;&amp; suitableForNativeSettlement(tile)</span>
<span class="fc bfc" id="L469" title="All 4 branches covered.">					&amp;&amp; none(settlementTiles, t -&gt; t.getDistanceTo(tile) &lt; minDistance))</span>
<span class="fc" id="L470">				settlementTiles.add(tile);</span>
<span class="fc" id="L471">		}</span>
<span class="fc" id="L472">		randomShuffle(logger, &quot;Settlement tiles&quot;, settlementTiles, random);</span>

		// Check number of settlements.
<span class="fc" id="L475">		int settlementsToPlace = settlementTiles.size();</span>
<span class="fc" id="L476">		float share = settlementsToPlace / shares;</span>
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">		if (settlementTiles.size() &lt; indians.size()) {</span>
			// FIXME: something drastic to boost the settlement number
<span class="nc" id="L479">			lb.add(&quot;There are only &quot;, settlementTiles.size(), &quot; settlement sites.\n&quot;, &quot; This is smaller than &quot;,</span>
<span class="nc" id="L480">					indians.size(), &quot; the number of tribes.\n&quot;);</span>
		}

		// Find the capitals
<span class="fc" id="L484">		List&lt;Territory&gt; territories = new ArrayList&lt;&gt;(territoryMap.values());</span>
<span class="fc" id="L485">		int settlementsPlaced = 0;</span>
<span class="fc bfc" id="L486" title="All 2 branches covered.">		for (Territory territory : territories) {</span>
<span class="pc bpc" id="L487" title="1 of 4 branches missed.">			switch (territory.player.getNationType().getNumberOfSettlements()) {</span>
			case HIGH:
<span class="fc" id="L489">				territory.numberOfSettlements = Math.round(4 * share);</span>
<span class="fc" id="L490">				break;</span>
			case AVERAGE:
<span class="fc" id="L492">				territory.numberOfSettlements = Math.round(3 * share);</span>
<span class="fc" id="L493">				break;</span>
			case LOW:
<span class="fc" id="L495">				territory.numberOfSettlements = Math.round(2 * share);</span>
				break;
			}
<span class="fc" id="L498">			int radius = territory.player.getNationType().getCapitalType().getClaimableRadius();</span>
<span class="fc" id="L499">			IndianSettlement is = placeCapital(map, territory, radius, new ArrayList&lt;&gt;(settlementTiles), lb);</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">			if (is != null) {</span>
<span class="fc" id="L501">				settlements.add(is);</span>
<span class="fc" id="L502">				settlementsPlaced++;</span>
<span class="fc" id="L503">				settlementTiles.remove(is.getTile());</span>
			}
<span class="fc" id="L505">		}</span>

		// Sort tiles from the edges of the map inward
<span class="fc" id="L508">		Collections.sort(settlementTiles, Tile.edgeDistanceComparator);</span>

		// Now place other settlements
<span class="fc bfc" id="L511" title="All 4 branches covered.">		while (!settlementTiles.isEmpty() &amp;&amp; !territories.isEmpty()) {</span>
<span class="fc" id="L512">			Tile tile = settlementTiles.remove(0);</span>
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">			if (tile.getOwner() != null)</span>
<span class="nc" id="L514">				continue; // No close overlap</span>

<span class="fc" id="L516">			Territory territory = getClosestTerritory(map, tile, territories);</span>
<span class="fc" id="L517">			int radius = territory.player.getNationType().getSettlementType(false).getClaimableRadius();</span>
			// Insist that the settlement can not be linear
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">			if (territory.player.getClaimableTiles(tile, radius).size() &gt; 2 * radius + 1) {</span>
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">				String name = (territory.region == null) ? &quot;default region&quot; : territory.region.toString();</span>
<span class="fc" id="L521">				lb.add(&quot;Placing a &quot;, territory.player, &quot; camp in region: &quot;, name, &quot; at tile: &quot;, tile, &quot;\n&quot;);</span>
<span class="fc" id="L522">				settlements.add(placeIndianSettlement(territory.player, false, tile, map, lb));</span>
<span class="fc" id="L523">				settlementsPlaced++;</span>
<span class="fc" id="L524">				territory.numberOfSettlements--;</span>
<span class="fc bfc" id="L525" title="All 2 branches covered.">				if (territory.numberOfSettlements &lt;= 0) {</span>
<span class="fc" id="L526">					territories.remove(territory);</span>
				}

			}
<span class="fc" id="L530">		}</span>

		// Grow some more tiles.
		// FIXME: move the magic numbers below to the spec
		// Also collect the skills provided
<span class="fc" id="L535">		HashMap&lt;UnitType, List&lt;IndianSettlement&gt;&gt; skills = new HashMap&lt;&gt;();</span>
<span class="fc" id="L536">		randomShuffle(logger, &quot;Settlements&quot;, settlements, random);</span>
<span class="fc bfc" id="L537" title="All 2 branches covered.">		for (IndianSettlement is : settlements) {</span>
<span class="fc" id="L538">			List&lt;Tile&gt; tiles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L539" title="All 2 branches covered.">			for (Tile tile : is.getOwnedTiles()) {</span>
<span class="fc bfc" id="L540" title="All 2 branches covered.">				for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc bfc" id="L541" title="All 2 branches covered.">					if (t.getOwningSettlement() == null) {</span>
<span class="fc" id="L542">						tiles.add(tile);</span>
<span class="fc" id="L543">						break;</span>
					}
<span class="fc" id="L545">				}</span>
<span class="fc" id="L546">			}</span>
<span class="fc" id="L547">			randomShuffle(logger, &quot;Settlement tiles&quot;, tiles, random);</span>
<span class="fc" id="L548">			int minGrow = is.getType().getMinimumGrowth();</span>
<span class="fc" id="L549">			int maxGrow = is.getType().getMaximumGrowth();</span>
<span class="pc bpc" id="L550" title="1 of 2 branches missed.">			if (maxGrow &gt; minGrow) {</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">				for (int i = randomInt(logger, &quot;Gdiff&quot;, random, maxGrow - minGrow) + minGrow; i &gt; 0; i--) {</span>
<span class="fc" id="L552">					Tile tile = findFreeNeighbouringTile(is, tiles);</span>
<span class="fc bfc" id="L553" title="All 2 branches covered.">					if (tile == null)</span>
<span class="fc" id="L554">						break;</span>
<span class="fc" id="L555">					tile.changeOwnership(is.getOwner(), is);</span>
<span class="fc" id="L556">					tiles.add(tile);</span>
				}
			}

			// Collect settlements by skill
<span class="fc" id="L561">			UnitType skill = is.getLearnableSkill();</span>
<span class="fc" id="L562">			List&lt;IndianSettlement&gt; isList = skills.get(skill);</span>
<span class="fc bfc" id="L563" title="All 2 branches covered.">			if (isList == null) {</span>
<span class="fc" id="L564">				isList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L565">				isList.add(is);</span>
<span class="fc" id="L566">				skills.put(skill, isList);</span>
			} else {
<span class="fc" id="L568">				isList.add(is);</span>
			}
<span class="fc" id="L570">		}</span>

		// Require that there be experts for all the new world goods types.
		// Collect the list of needed experts
<span class="fc" id="L574">		List&lt;UnitType&gt; expertsNeeded = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L575" title="All 2 branches covered.">		for (GoodsType goodsType : spec.getNewWorldGoodsTypeList()) {</span>
<span class="fc" id="L576">			UnitType expert = spec.getExpertForProducing(goodsType);</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">			if (!skills.containsKey(expert))</span>
<span class="fc" id="L578">				expertsNeeded.add(expert);</span>
<span class="fc" id="L579">		}</span>
		// Extract just the settlement lists.
<span class="fc" id="L581">		List&lt;List&lt;IndianSettlement&gt;&gt; isList = new ArrayList&lt;&gt;(skills.values());</span>
		// For each missing skill...
<span class="fc bfc" id="L583" title="All 2 branches covered.">		while (!expertsNeeded.isEmpty()) {</span>
<span class="fc" id="L584">			UnitType neededSkill = expertsNeeded.remove(0);</span>
<span class="fc" id="L585">			Collections.sort(isList, descendingListLengthComparator);</span>
<span class="fc" id="L586">			List&lt;IndianSettlement&gt; extras = isList.remove(0);</span>
<span class="fc" id="L587">			UnitType extraSkill = extras.get(0).getLearnableSkill();</span>
<span class="fc" id="L588">			List&lt;RandomChoice&lt;IndianSettlement&gt;&gt; choices = new ArrayList&lt;&gt;();</span>
			// ...look at the settlements with the most common skill
			// with a bit of favoritism to capitals as the needed skill
			// is so rare,...
<span class="fc bfc" id="L592" title="All 2 branches covered.">			for (IndianSettlement is : extras) {</span>
<span class="fc" id="L593">				IndianNationType nation = (IndianNationType) is.getOwner().getNationType();</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">				int cm = (is.isCapital()) ? 2 : 1;</span>
<span class="fc" id="L595">				RandomChoice&lt;IndianSettlement&gt; rc = null;</span>
<span class="fc bfc" id="L596" title="All 2 branches covered.">				for (RandomChoice&lt;UnitType&gt; c : nation.generateSkillsForTile(is.getTile())) {</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">					if (c.getObject() == neededSkill) {</span>
<span class="fc" id="L598">						rc = new RandomChoice&lt;&gt;(is, c.getProbability() * cm);</span>
<span class="fc" id="L599">						break;</span>
					}
<span class="fc" id="L601">				}</span>
<span class="fc bfc" id="L602" title="All 2 branches covered.">				choices.add((rc != null) ? rc : new RandomChoice&lt;&gt;(is, 1));</span>
<span class="fc" id="L603">			}</span>
<span class="pc bpc" id="L604" title="1 of 2 branches missed.">			if (!choices.isEmpty()) {</span>
				// ...and pick one that could do the missing job.
<span class="fc" id="L606">				IndianSettlement chose = RandomChoice.getWeightedRandom(logger, &quot;expert&quot;, choices, random);</span>
<span class="fc" id="L607">				lb.add(&quot;At &quot;, chose.getName(), &quot; replaced &quot;, extraSkill, &quot; (one of &quot;, extras.size(), &quot;)&quot;,</span>
						&quot; by missing &quot;, neededSkill, &quot;\n&quot;);
<span class="fc" id="L609">				chose.setLearnableSkill(neededSkill);</span>
<span class="fc" id="L610">				extras.remove(chose);</span>
<span class="fc" id="L611">				isList.add(0, extras); // Try to stay well sorted</span>
<span class="fc" id="L612">				List&lt;IndianSettlement&gt; neededList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L613">				neededList.add(chose);</span>
<span class="fc" id="L614">				isList.add(neededList);</span>
<span class="fc" id="L615">			} else { // `can not happen'</span>
<span class="nc" id="L616">				lb.add(&quot;Game is missing skill: &quot;, neededSkill, &quot;\n&quot;);</span>
			}
<span class="fc" id="L618">		}</span>
<span class="fc" id="L619">		lb.add(&quot;Settlement skills:&quot;);</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">		for (List&lt;IndianSettlement&gt; iss : isList) {</span>
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">			if (iss.isEmpty()) {</span>
<span class="nc" id="L622">				lb.add(&quot;  0 x &lt;none&gt;&quot;);</span>
			} else {
<span class="fc" id="L624">				lb.add(&quot;  &quot;, iss.size(), &quot; x &quot;, iss.get(0).getLearnableSkill().getSuffix());</span>
			}
<span class="fc" id="L626">		}</span>
<span class="fc" id="L627">		lb.add(&quot;\nCreated &quot;, settlementsPlaced, &quot; Indian settlements of maximum &quot;, settlementsToPlace, &quot;.\n&quot;);</span>
<span class="fc" id="L628">	}</span>

	/**
	 * Is a tile suitable for a native settlement? Require the tile be
	 * settleable, and at least half its neighbours also be settleable.
	 *
	 * FIXME: degrade the second test to usability, but wait until the
	 * natives-use-water situation is sorted.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to examine.
	 * @return True if this tile is suitable.
	 */
	private boolean suitableForNativeSettlement(Tile tile) {
<span class="fc bfc" id="L642" title="All 2 branches covered.">		if (!tile.getType().canSettle())</span>
<span class="fc" id="L643">			return false;</span>
<span class="fc" id="L644">		int good = 0, n = 0;</span>
<span class="fc bfc" id="L645" title="All 2 branches covered.">		for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc bfc" id="L646" title="All 2 branches covered.">			if (t.getType().canSettle())</span>
<span class="fc" id="L647">				good++;</span>
<span class="fc" id="L648">			n++;</span>
<span class="fc" id="L649">		}</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">		return good &gt;= n / 2;</span>
	}

	/**
	 * Find free neighbouring tile.
	 *
	 * @param is
	 *            the is
	 * @param tiles
	 *            the tiles
	 * @return the tile
	 */
	private Tile findFreeNeighbouringTile(IndianSettlement is, List&lt;Tile&gt; tiles) {
<span class="fc bfc" id="L663" title="All 2 branches covered.">		for (Tile tile : tiles) {</span>
<span class="fc bfc" id="L664" title="All 2 branches covered.">			for (Direction d : Direction.getRandomDirections(&quot;freeTile&quot;, logger, random)) {</span>
<span class="fc" id="L665">				Tile t = tile.getNeighbourOrNull(d);</span>
<span class="pc bpc" id="L666" title="1 of 6 branches missed.">				if ((t != null) &amp;&amp; (t.getOwningSettlement() == null) &amp;&amp; (is.getOwner().canClaimForSettlement(t)))</span>
<span class="fc" id="L667">					return t;</span>
			}
<span class="fc" id="L669">		}</span>
<span class="fc" id="L670">		return null;</span>
	}

	/**
	 * Gets the closest territory.
	 *
	 * @param map
	 *            the map
	 * @param tile
	 *            the tile
	 * @param territories
	 *            the territories
	 * @return the closest territory
	 */
	private Territory getClosestTerritory(Map map, Tile tile, List&lt;Territory&gt; territories) {
<span class="fc" id="L685">		Territory result = null;</span>
<span class="fc" id="L686">		int minimumDistance = Integer.MAX_VALUE;</span>
<span class="fc bfc" id="L687" title="All 2 branches covered.">		for (Territory territory : territories) {</span>
<span class="fc" id="L688">			int distance = map.getDistance(tile, territory.getCenterTile(map));</span>
<span class="fc bfc" id="L689" title="All 2 branches covered.">			if (distance &lt; minimumDistance) {</span>
<span class="fc" id="L690">				minimumDistance = distance;</span>
<span class="fc" id="L691">				result = territory;</span>
			}
<span class="fc" id="L693">		}</span>
<span class="fc" id="L694">		return result;</span>
	}

	/**
	 * Place a native capital in a territory.
	 *
	 * @param map
	 *            The &lt;code&gt;Map&lt;/code&gt; to place the settlement in.
	 * @param territory
	 *            The &lt;code&gt;Territory&lt;/code&gt; within the map.
	 * @param radius
	 *            The settlement radius.
	 * @param tiles
	 *            A list of &lt;code&gt;Tile&lt;/code&gt;s to select from.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @return The &lt;code&gt;IndianSettlement&lt;/code&gt; placed, or null if none placed.
	 */
	private IndianSettlement placeCapital(final Map map, Territory territory, int radius, List&lt;Tile&gt; tiles,
			LogBuilder lb) {
<span class="fc" id="L714">		final Tile center = territory.getCenterTile(map);</span>
<span class="fc" id="L715">		Collections.sort(tiles, new Comparator&lt;Tile&gt;() {</span>
			@Override
			public int compare(Tile t1, Tile t2) {
<span class="fc" id="L718">				return t1.getDistanceTo(center) - t2.getDistanceTo(center);</span>
			}
		});
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">		for (Tile t : tiles) {</span>
			// Choose this tile if it is free and half the expected tile
			// claim can succeed (preventing capitals on small islands).
<span class="fc bfc" id="L724" title="All 2 branches covered.">			if (territory.player.getClaimableTiles(t, radius).size() &gt;= (2 * radius + 1) * (2 * radius + 1) / 2) {</span>
<span class="pc bpc" id="L725" title="1 of 2 branches missed.">				String name = (territory.region == null) ? &quot;default region&quot; : territory.region.toString();</span>
<span class="fc" id="L726">				lb.add(&quot;Placing the &quot;, territory.player, &quot; capital in region: &quot;, name, &quot; at tile: &quot;, t, &quot;\n&quot;);</span>
<span class="fc" id="L727">				IndianSettlement is = placeIndianSettlement(territory.player, true, t, map, lb);</span>
<span class="fc" id="L728">				territory.numberOfSettlements--;</span>
<span class="fc" id="L729">				territory.tile = t;</span>
<span class="fc" id="L730">				return is;</span>
			}
<span class="fc" id="L732">		}</span>
<span class="nc" id="L733">		return null;</span>
	}

	/**
	 * Builds a &lt;code&gt;IndianSettlement&lt;/code&gt; at the given position.
	 *
	 * @param player
	 *            The player owning the new settlement.
	 * @param capital
	 *            &lt;code&gt;true&lt;/code&gt; if the settlement should be a
	 *            {@link IndianSettlement#isCapital() capital}.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to place the settlement.
	 * @param map
	 *            The map that should get a new settlement.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @return The &lt;code&gt;IndianSettlement&lt;/code&gt; just being placed on the map.
	 */
	private IndianSettlement placeIndianSettlement(Player player, boolean capital, Tile tile, Map map, LogBuilder lb) {
<span class="fc bfc" id="L753" title="All 2 branches covered.">		String name = (capital) ? player.getCapitalName(random) : player.getSettlementName(random);</span>
<span class="fc" id="L754">		UnitType skill = generateSkillForLocation(map, tile, player.getNationType());</span>
<span class="fc" id="L755">		ServerIndianSettlement settlement = new ServerIndianSettlement(map.getGame(), player, name, tile, capital,</span>
				skill, null);
<span class="fc" id="L757">		player.addSettlement(settlement);</span>
<span class="fc" id="L758">		lb.add(&quot;Generated skill for &quot;, settlement.getName(), &quot;: &quot;, settlement.getLearnableSkill().getSuffix(), &quot;\n&quot;);</span>

<span class="fc" id="L760">		settlement.placeSettlement(true);</span>
<span class="fc" id="L761">		settlement.addRandomGoods(random);</span>
<span class="fc" id="L762">		settlement.addUnits(random);</span>

<span class="fc" id="L764">		return settlement;</span>
	}

	/**
	 * Generates a skill that could be taught from a settlement on the given
	 * tile.
	 *
	 * @param map
	 *            The &lt;code&gt;Map&lt;/code&gt;.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; where the settlement will be located.
	 * @param nationType
	 *            The &lt;code&gt;NationType&lt;/code&gt; to generate a skill for.
	 * @return A skill that can be taught to Europeans.
	 */
	private UnitType generateSkillForLocation(Map map, Tile tile, NationType nationType) {
<span class="fc" id="L780">		List&lt;RandomChoice&lt;UnitType&gt;&gt; skills = ((IndianNationType) nationType).getSkills();</span>
<span class="fc" id="L781">		java.util.Map&lt;GoodsType, Integer&gt; scale = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L782" title="All 2 branches covered.">		for (RandomChoice&lt;UnitType&gt; skill : skills) {</span>
<span class="fc" id="L783">			scale.put(skill.getObject().getExpertProduction(), 1);</span>
<span class="fc" id="L784">		}</span>

<span class="fc bfc" id="L786" title="All 2 branches covered.">		for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc bfc" id="L787" title="All 2 branches covered.">			for (Entry&lt;GoodsType, Integer&gt; entry : scale.entrySet()) {</span>
<span class="fc" id="L788">				GoodsType goodsType = entry.getKey();</span>
<span class="fc" id="L789">				scale.put(goodsType, entry.getValue() + t.getPotentialProduction(goodsType, null));</span>
<span class="fc" id="L790">			}</span>
<span class="fc" id="L791">		}</span>

<span class="fc" id="L793">		List&lt;RandomChoice&lt;UnitType&gt;&gt; scaledSkills = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L794" title="All 2 branches covered.">		for (RandomChoice&lt;UnitType&gt; skill : skills) {</span>
<span class="fc" id="L795">			UnitType unitType = skill.getObject();</span>
<span class="fc" id="L796">			int scaleValue = scale.get(unitType.getExpertProduction());</span>
<span class="fc" id="L797">			scaledSkills.add(new RandomChoice&lt;&gt;(unitType, skill.getProbability() * scaleValue));</span>
<span class="fc" id="L798">		}</span>
<span class="fc" id="L799">		UnitType skill = RandomChoice.getWeightedRandom(null, null, scaledSkills, random);</span>
<span class="pc bpc" id="L800" title="1 of 2 branches missed.">		if (skill == null) {</span>
			// Seasoned Scout
<span class="nc" id="L802">			List&lt;UnitType&gt; unitList = map.getSpecification().getUnitTypesWithAbility(Ability.EXPERT_SCOUT);</span>
<span class="nc" id="L803">			return getRandomMember(logger, &quot;Scout&quot;, unitList, random);</span>
		} else {
<span class="fc" id="L805">			return skill;</span>
		}
	}

	/**
	 * Create two ships, one with a colonist, for each player, and select
	 * suitable starting positions.
	 *
	 * @param map
	 *            The &lt;code&gt;Map&lt;/code&gt; to place the european units on.
	 * @param players
	 *            The players to create &lt;code&gt;Settlement&lt;/code&gt;s and starting
	 *            locations for. That is; both indian and european players.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void createEuropeanUnits(Map map, List&lt;Player&gt; players, LogBuilder lb) {
<span class="fc" id="L822">		final int width = map.getWidth();</span>
<span class="fc" id="L823">		final int height = map.getHeight();</span>
<span class="fc" id="L824">		final int poleDistance = (int) (MIN_DISTANCE_FROM_POLE * height / 2);</span>

<span class="fc" id="L826">		List&lt;Player&gt; europeanPlayers = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L827" title="All 2 branches covered.">		for (Player player : players) {</span>
<span class="fc bfc" id="L828" title="All 2 branches covered.">			if (player.isREF()) {</span>
				// eastern edge of the map
<span class="fc" id="L830">				int x = width - 2;</span>
				// random latitude, not too close to the pole
<span class="fc" id="L832">				int y = randomInt(logger, &quot;Pole&quot;, random, height - 2 * poleDistance) + poleDistance;</span>
<span class="fc" id="L833">				player.setEntryLocation(map.getTile(x, y));</span>
<span class="fc" id="L834">				continue;</span>
			}
<span class="pc bpc" id="L836" title="1 of 2 branches missed.">			if (player.isEuropean())</span>
<span class="fc" id="L837">				europeanPlayers.add(player);</span>
<span class="fc" id="L838">		}</span>

<span class="fc" id="L840">		List&lt;Position&gt; positions = generateStartingPositions(map, europeanPlayers);</span>
<span class="fc" id="L841">		List&lt;Tile&gt; startingTiles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L842">		List&lt;Unit&gt; carriers = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L843">		List&lt;Unit&gt; passengers = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L845" title="All 2 branches covered.">		for (int index = 0; index &lt; europeanPlayers.size(); index++) {</span>
<span class="fc" id="L846">			Player player = europeanPlayers.get(index);</span>
<span class="fc" id="L847">			Position position = positions.get(index);</span>
<span class="fc" id="L848">			lb.add(&quot;Generating units for player &quot;, player, &quot;.\n&quot;);</span>

<span class="fc" id="L850">			carriers.clear();</span>
<span class="fc" id="L851">			passengers.clear();</span>
<span class="fc" id="L852">			List&lt;AbstractUnit&gt; unitList = ((EuropeanNationType) player.getNationType()).getStartingUnits();</span>
<span class="fc bfc" id="L853" title="All 2 branches covered.">			for (AbstractUnit startingUnit : unitList) {</span>
<span class="fc" id="L854">				UnitType type = startingUnit.getType(spec);</span>
<span class="fc" id="L855">				Role role = startingUnit.getRole(spec);</span>
<span class="fc" id="L856">				Unit newUnit = new ServerUnit(game, null, player, type, role);</span>
<span class="fc" id="L857">				newUnit.setName(player.getNameForUnit(type, random));</span>
<span class="fc bfc" id="L858" title="All 2 branches covered.">				if (newUnit.isNaval()) {</span>
<span class="pc bpc" id="L859" title="1 of 2 branches missed.">					if (newUnit.canCarryUnits()) {</span>
<span class="fc" id="L860">						newUnit.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L861">						carriers.add(newUnit);</span>
					}
				} else {
<span class="fc" id="L864">					newUnit.setState(Unit.UnitState.SENTRY);</span>
<span class="fc" id="L865">					passengers.add(newUnit);</span>
				}

<span class="fc" id="L868">			}</span>

<span class="fc" id="L870">			boolean startAtSea = true;</span>
<span class="pc bpc" id="L871" title="1 of 2 branches missed.">			if (carriers.isEmpty()) {</span>
<span class="nc" id="L872">				lb.add(&quot;No carriers defined for player &quot;, player, &quot;.\n&quot;);</span>
<span class="nc" id="L873">				startAtSea = false;</span>
			}

<span class="fc" id="L876">			Tile startTile = null;</span>
<span class="fc" id="L877">			int x = position.getX();</span>
<span class="fc" id="L878">			int y = position.getY();</span>
<span class="pc bpc" id="L879" title="1 of 2 branches missed.">			for (int i = 0; i &lt; 2 * map.getHeight(); i++) {</span>
<span class="pc bpc" id="L880" title="1 of 2 branches missed.">				int offset = (i % 2 == 0) ? i / 2 : -(1 + i / 2);</span>
<span class="fc" id="L881">				int row = y + offset;</span>
<span class="pc bpc" id="L882" title="2 of 4 branches missed.">				if (row &lt; 0 || row &gt;= map.getHeight())</span>
<span class="nc" id="L883">					continue;</span>
<span class="fc" id="L884">				startTile = findTileFor(map, row, x, startAtSea, lb);</span>
<span class="pc bpc" id="L885" title="1 of 2 branches missed.">				if (startTile != null) {</span>
<span class="pc bpc" id="L886" title="1 of 2 branches missed.">					if (startingTiles.contains(startTile)) {</span>
<span class="nc" id="L887">						startTile = null;</span>
					} else {
<span class="fc" id="L889">						startingTiles.add(startTile);</span>
<span class="fc" id="L890">						break;</span>
					}
				}
			}
<span class="pc bpc" id="L894" title="1 of 2 branches missed.">			if (startTile == null) {</span>
<span class="nc" id="L895">				LogBuilder lb2 = new LogBuilder(64);</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">				lb2.add(&quot;Failed to find start tile &quot;, ((startAtSea) ? &quot;at sea&quot; : &quot;on land&quot;), &quot; for player &quot;, player,</span>
<span class="nc" id="L897">						&quot; from (&quot;, x, &quot;,&quot;, y, &quot;) avoiding:&quot;);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">				for (Tile t : startingTiles)</span>
<span class="nc" id="L899">					lb2.add(&quot; &quot;, t);</span>
<span class="nc" id="L900">				lb2.add(&quot; with map: &quot;);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">				for (int xx = 0; xx &lt; map.getWidth(); xx++) {</span>
<span class="nc" id="L902">					lb2.add(&quot; &quot;, map.getTile(xx, y));</span>
				}
<span class="nc" id="L904">				throw new RuntimeException(lb2.toString());</span>
			}

<span class="fc" id="L907">			player.setEntryLocation(startTile);</span>

<span class="pc bpc" id="L909" title="1 of 2 branches missed.">			if (startAtSea) {</span>
<span class="fc bfc" id="L910" title="All 2 branches covered.">				for (Unit carrier : carriers) {</span>
<span class="fc" id="L911">					carrier.setLocation(startTile);</span>
<span class="fc" id="L912">					((ServerPlayer) player).exploreForUnit(carrier);</span>
<span class="fc" id="L913">				}</span>
<span class="fc bfc" id="L914" title="All 2 branches covered.">				passengers: for (Unit unit : passengers) {</span>
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">					for (Unit carrier : carriers) {</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">						if (carrier.canAdd(unit)) {</span>
<span class="fc" id="L917">							unit.setLocation(carrier);</span>
<span class="fc" id="L918">							continue passengers;</span>
						}
<span class="nc" id="L920">					}</span>
					// no space left on carriers
<span class="nc" id="L922">					unit.setLocation(player.getEurope());</span>
<span class="pc" id="L923">				}</span>
			} else {
<span class="nc bnc" id="L925" title="All 2 branches missed.">				for (Unit unit : passengers) {</span>
<span class="nc" id="L926">					unit.setLocation(startTile);</span>
<span class="nc" id="L927">					((ServerPlayer) player).exploreForUnit(unit);</span>
<span class="nc" id="L928">				}</span>
			}

<span class="pc bpc" id="L931" title="1 of 2 branches missed.">			if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.INIT)) {</span>
<span class="nc" id="L932">				createDebugUnits(map, player, startTile, lb);</span>
<span class="nc" id="L933">				IntegerOption op = spec.getIntegerOption(GameOptions.STARTING_MONEY);</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">				if (op != null)</span>
<span class="nc" id="L935">					op.setValue(10000);</span>
			}
		}
<span class="fc" id="L938">	}</span>

	/**
	 * Find tile for.
	 *
	 * @param map
	 *            the map
	 * @param row
	 *            the row
	 * @param start
	 *            the start
	 * @param startAtSea
	 *            the start at sea
	 * @param lb
	 *            the lb
	 * @return the tile
	 */
	private Tile findTileFor(Map map, int row, int start, boolean startAtSea, LogBuilder lb) {
<span class="fc" id="L956">		Tile tile = null;</span>
<span class="fc" id="L957">		Tile seas = null;</span>
<span class="pc bpc" id="L958" title="1 of 2 branches missed.">		int offset = (start == 0) ? 1 : -1;</span>
<span class="pc bpc" id="L959" title="2 of 4 branches missed.">		for (int x = start; 0 &lt;= x &amp;&amp; x &lt; map.getWidth(); x += offset) {</span>
<span class="fc" id="L960">			tile = map.getTile(x, row);</span>
<span class="fc bfc" id="L961" title="All 2 branches covered.">			if (tile.isDirectlyHighSeasConnected()) {</span>
<span class="fc" id="L962">				seas = tile;</span>
<span class="fc bfc" id="L963" title="All 2 branches covered.">			} else if (tile.isLand()) {</span>
<span class="pc bpc" id="L964" title="1 of 2 branches missed.">				return (startAtSea) ? seas : tile;</span>
			}
		}
<span class="nc" id="L967">		lb.add(&quot;No land in row &quot;, row, &quot;.\n&quot;);</span>
<span class="nc" id="L968">		return null;</span>
	}

	/**
	 * Creates the debug units.
	 *
	 * @param map
	 *            the map
	 * @param player
	 *            the player
	 * @param startTile
	 *            the start tile
	 * @param lb
	 *            the lb
	 */
	private void createDebugUnits(Map map, Player player, Tile startTile, LogBuilder lb) {
		// In debug mode give each player a few more units and a colony.
<span class="nc" id="L985">		UnitType unitType = spec.getUnitType(&quot;model.unit.galleon&quot;);</span>
<span class="nc" id="L986">		Unit unit4 = new ServerUnit(game, startTile, player, unitType);</span>
<span class="nc" id="L987">		unitType = spec.getUnitType(&quot;model.unit.privateer&quot;);</span>
<span class="nc" id="L988">		Unit privateer = new ServerUnit(game, startTile, player, unitType);</span>
<span class="nc" id="L989">		((ServerPlayer) player).exploreForUnit(privateer);</span>
<span class="nc" id="L990">		unitType = spec.getUnitType(&quot;model.unit.freeColonist&quot;);</span>
<span class="nc" id="L991">		Unit unit5 = new ServerUnit(game, unit4, player, unitType);</span>
<span class="nc" id="L992">		unitType = spec.getUnitType(&quot;model.unit.veteranSoldier&quot;);</span>
<span class="nc" id="L993">		Unit unit6 = new ServerUnit(game, unit4, player, unitType);</span>
<span class="nc" id="L994">		unitType = spec.getUnitType(&quot;model.unit.jesuitMissionary&quot;);</span>
<span class="nc" id="L995">		Unit unit7 = new ServerUnit(game, unit4, player, unitType);</span>

<span class="nc" id="L997">		Tile colonyTile = null;</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">		for (Tile tempTile : map.getCircleTiles(startTile, true, FreeColObject.INFINITY)) {</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">			if (tempTile.isPolar())</span>
<span class="nc" id="L1000">				continue; // No initial polar colonies</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">			if (player.canClaimToFoundSettlement(tempTile)) {</span>
<span class="nc" id="L1002">				colonyTile = tempTile;</span>
<span class="nc" id="L1003">				break;</span>
			}
<span class="nc" id="L1005">		}</span>

<span class="nc bnc" id="L1007" title="All 2 branches missed.">		if (colonyTile == null) {</span>
<span class="nc" id="L1008">			lb.add(&quot;Could not find a debug colony site.\n&quot;);</span>
<span class="nc" id="L1009">			return;</span>
		}
<span class="nc bnc" id="L1011" title="All 2 branches missed.">		colonyTile.setType(find(spec.getTileTypeList(), t -&gt; !t.isWater()));</span>
<span class="nc" id="L1012">		unitType = spec.getUnitType(&quot;model.unit.expertFarmer&quot;);</span>
<span class="nc" id="L1013">		Unit buildColonyUnit = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1014">		String colonyName = Messages.message(player.getNationLabel()) + &quot; &quot; + Messages.message(&quot;Colony&quot;);</span>
<span class="nc" id="L1015">		Colony colony = new ServerColony(game, player, colonyName, colonyTile);</span>
<span class="nc" id="L1016">		player.addSettlement(colony);</span>
<span class="nc" id="L1017">		colony.placeSettlement(true);</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">		for (Tile tile : colonyTile.getSurroundingTiles(1)) {</span>
<span class="nc bnc" id="L1019" title="All 6 branches missed.">			if (!tile.hasSettlement() &amp;&amp; (tile.getOwner() == null || !tile.getOwner().isEuropean())) {</span>
<span class="nc" id="L1020">				tile.changeOwnership(player, colony);</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">				if (tile.hasLostCityRumour()) {</span>
<span class="nc" id="L1022">					tile.removeLostCityRumour();</span>
				}
			}
<span class="nc" id="L1025">		}</span>
<span class="nc" id="L1026">		buildColonyUnit.setLocation(colony);</span>
<span class="nc bnc" id="L1027" title="All 2 branches missed.">		if (buildColonyUnit.getLocation() instanceof ColonyTile) {</span>
<span class="nc" id="L1028">			Tile ct = ((ColonyTile) buildColonyUnit.getLocation()).getWorkTile();</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">			for (TileType t : spec.getTileTypeList()) {</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">				if (!t.isWater()) {</span>
<span class="nc" id="L1031">					ct.setType(t);</span>
<span class="nc" id="L1032">					TileImprovementType plowType = map.getSpecification()</span>
<span class="nc" id="L1033">							.getTileImprovementType(&quot;model.improvement.plow&quot;);</span>
<span class="nc" id="L1034">					TileImprovement plow = new TileImprovement(game, ct, plowType);</span>
<span class="nc" id="L1035">					plow.setTurnsToComplete(0);</span>
<span class="nc" id="L1036">					ct.add(plow);</span>
<span class="nc" id="L1037">					break;</span>
				}
<span class="nc" id="L1039">			}</span>
		}
<span class="nc" id="L1041">		BuildingType schoolType = spec.getBuildingType(&quot;model.building.schoolhouse&quot;);</span>
<span class="nc" id="L1042">		Building schoolhouse = new ServerBuilding(game, colony, schoolType);</span>
<span class="nc" id="L1043">		colony.addBuilding(schoolhouse);</span>

<span class="nc" id="L1045">		unitType = spec.getUnitType(&quot;model.unit.elderStatesman&quot;);</span>
<span class="nc" id="L1046">		Unit statesman = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1047">		statesman.setLocation(colony.getWorkLocationFor(statesman, statesman.getType().getExpertProduction()));</span>

<span class="nc" id="L1049">		unitType = spec.getUnitType(&quot;model.unit.expertLumberJack&quot;);</span>
<span class="nc" id="L1050">		Unit lumberjack = new ServerUnit(game, colony, player, unitType);</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">		if (lumberjack.getLocation() instanceof ColonyTile) {</span>
<span class="nc" id="L1052">			Tile lt = ((ColonyTile) lumberjack.getLocation()).getWorkTile();</span>
<span class="nc bnc" id="L1053" title="All 2 branches missed.">			for (TileType t : spec.getTileTypeList()) {</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">				if (t.isForested()) {</span>
<span class="nc" id="L1055">					lt.setType(t);</span>
<span class="nc" id="L1056">					break;</span>
				}
<span class="nc" id="L1058">			}</span>
<span class="nc" id="L1059">			lumberjack.changeWorkType(lumberjack.getType().getExpertProduction());</span>
		}

<span class="nc" id="L1062">		unitType = spec.getUnitType(&quot;model.unit.masterCarpenter&quot;);</span>
<span class="nc" id="L1063">		Unit carpenter = new ServerUnit(game, colony, player, unitType);</span>

<span class="nc" id="L1065">		unitType = spec.getUnitType(&quot;model.unit.seasonedScout&quot;);</span>
<span class="nc" id="L1066">		Unit scout = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1067">		((ServerPlayer) player).exploreForUnit(scout);</span>

<span class="nc" id="L1069">		unitType = spec.getUnitType(&quot;model.unit.veteranSoldier&quot;);</span>
<span class="nc" id="L1070">		Unit unit8 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1071">		Unit unit9 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1072">		unitType = spec.getUnitType(&quot;model.unit.artillery&quot;);</span>
<span class="nc" id="L1073">		Unit unit10 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1074">		Unit unit11 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1075">		Unit unit12 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1076">		unitType = spec.getUnitType(&quot;model.unit.treasureTrain&quot;);</span>
<span class="nc" id="L1077">		Unit unit13 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1078">		unit13.setTreasureAmount(10000);</span>
<span class="nc" id="L1079">		unitType = spec.getUnitType(&quot;model.unit.wagonTrain&quot;);</span>
<span class="nc" id="L1080">		Unit unit14 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1081">		GoodsType cigarsType = spec.getGoodsType(&quot;model.goods.cigars&quot;);</span>
<span class="nc" id="L1082">		Goods cigards = new Goods(game, unit14, cigarsType, 5);</span>
<span class="nc" id="L1083">		unit14.add(cigards);</span>
<span class="nc" id="L1084">		unitType = spec.getUnitType(&quot;model.unit.jesuitMissionary&quot;);</span>
<span class="nc" id="L1085">		Unit unit15 = new ServerUnit(game, colonyTile, player, unitType);</span>
<span class="nc" id="L1086">		Unit unit16 = new ServerUnit(game, colonyTile, player, unitType);</span>

<span class="nc" id="L1088">		((ServerPlayer) player).exploreForSettlement(colony);</span>
<span class="nc" id="L1089">	}</span>

	/**
	 * Generate starting positions.
	 *
	 * @param map
	 *            the map
	 * @param players
	 *            the players
	 * @return the list
	 */
	private List&lt;Position&gt; generateStartingPositions(Map map, List&lt;Player&gt; players) {
<span class="fc" id="L1101">		int number = players.size();</span>
<span class="fc" id="L1102">		List&lt;Position&gt; positions = new ArrayList&lt;&gt;(number);</span>
<span class="fc bfc" id="L1103" title="All 2 branches covered.">		if (number &gt; 0) {</span>
<span class="fc" id="L1104">			int west = 0;</span>
<span class="fc" id="L1105">			int east = map.getWidth() - 1;</span>
<span class="pc bpc" id="L1106" title="3 of 4 branches missed.">			switch (spec.getInteger(GameOptions.STARTING_POSITIONS)) {</span>
			case GameOptions.STARTING_POSITIONS_CLASSIC:
<span class="fc" id="L1108">				int distance = map.getHeight() / number;</span>
<span class="fc" id="L1109">				int row = distance / 2;</span>
<span class="fc bfc" id="L1110" title="All 2 branches covered.">				for (int index = 0; index &lt; number; index++) {</span>
<span class="fc" id="L1111">					positions.add(new Position(east, row));</span>
<span class="fc" id="L1112">					row += distance;</span>
				}
<span class="fc" id="L1114">				randomShuffle(logger, &quot;Classic starting positions&quot;, positions, random);</span>
<span class="fc" id="L1115">				break;</span>
			case GameOptions.STARTING_POSITIONS_RANDOM:
<span class="nc" id="L1117">				distance = 2 * map.getHeight() / number;</span>
<span class="nc" id="L1118">				row = distance / 2;</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">				for (int index = 0; index &lt; number; index++) {</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">					if (index % 2 == 0) {</span>
<span class="nc" id="L1121">						positions.add(new Position(east, row));</span>
					} else {
<span class="nc" id="L1123">						positions.add(new Position(west, row));</span>
<span class="nc" id="L1124">						row += distance;</span>
					}
				}
<span class="nc" id="L1127">				randomShuffle(logger, &quot;Random starting positions&quot;, positions, random);</span>
<span class="nc" id="L1128">				break;</span>
			case GameOptions.STARTING_POSITIONS_HISTORICAL:
<span class="nc bnc" id="L1130" title="All 2 branches missed.">				for (Player player : players) {</span>
<span class="nc" id="L1131">					Nation nation = player.getNation();</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">					positions.add(new Position(nation.startsOnEastCoast() ? east : west,</span>
<span class="nc" id="L1133">							map.getRow(nation.getPreferredLatitude())));</span>
<span class="nc" id="L1134">				}</span>
				break;
			}
		}
<span class="fc" id="L1138">		return positions;</span>
	}

	// Implement MapGenerator

	/**
	 * {@inheritDoc}
	 */
	@Override
	public Map createEmptyMap(int width, int height, LogBuilder lb) {
<span class="nc" id="L1148">		recache(false); // Reload the options and specification</span>

<span class="nc" id="L1150">		return new TerrainGenerator(game, null, random).createMap(new LandMap(width, height), lb);</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public Map createMap(LogBuilder lb) {
<span class="fc" id="L1158">		recache(true); // Reload the options and specification</span>

		// Create land map.
<span class="fc bfc" id="L1161" title="All 2 branches covered.">		LandMap landMap = (importGame != null) ? new LandMap(importGame) : new LandMap(mapOptions, random);</span>

		// Create terrain.
<span class="fc" id="L1164">		Map map = new TerrainGenerator(game, importGame, random).createMap(landMap, lb);</span>

		// Decorate the map.
<span class="fc" id="L1167">		makeNativeSettlements(map, lb);</span>
<span class="fc" id="L1168">		makeLostCityRumours(map, lb);</span>
<span class="fc" id="L1169">		createEuropeanUnits(map, game.getLiveEuropeanPlayers(null), lb);</span>
<span class="fc" id="L1170">		return map;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>