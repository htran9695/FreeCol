<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerPlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.model</a> &gt; <span class="el_source">ServerPlayer.java</span></div><h1>ServerPlayer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.model;

import java.io.IOException;
import java.net.Socket;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.EnumMap;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;

import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.BuildingType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.CombatModel;
import net.sf.freecol.common.model.CombatModel.CombatResult;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.Disaster;
import net.sf.freecol.common.model.Effect;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.Event;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FoundingFather.FoundingFatherType;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.Monarch;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.StanceTradeItem;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.model.pathfinding.GoalDeciders;
import net.sf.freecol.common.networking.ChooseFoundingFatherMessage;
import net.sf.freecol.common.networking.Connection;
import net.sf.freecol.common.networking.DiplomacyMessage;
import net.sf.freecol.common.networking.FirstContactMessage;
import net.sf.freecol.common.networking.LootCargoMessage;
import net.sf.freecol.common.networking.MonarchActionMessage;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.server.control.ChangeSet;
import net.sf.freecol.server.control.ChangeSet.ChangePriority;
import net.sf.freecol.server.control.ChangeSet.See;

import org.w3c.dom.Element;


/**
 * A &lt;code&gt;Player&lt;/code&gt; with additional (server specific) information.
 *
 * That is: pointers to this player's
 * {@link Connection} and {@link Socket}
 */
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">public class ServerPlayer extends Player implements ServerModelObject {</span>

<span class="fc" id="L114">    private static final Logger logger = Logger.getLogger(ServerPlayer.class.getName());</span>

    // FIXME: move to options or spec?
    public static final int ALARM_RADIUS = 2;
    public static final int ALARM_TILE_IN_USE = 2;

    // checkForDeath results
    public static final int IS_DEAD = -1;
    public static final int IS_ALIVE = 0;
    public static final int AUTORECRUIT = 1;

    // Penalty for destroying a settlement (Col1)
    public static final int SCORE_SETTLEMENT_DESTROYED = -5;

    // Penalty for destroying a nation (FreeCol extension)
    public static final int SCORE_NATION_DESTROYED = -50;

    // Gold converts to score at 1 pt per 1000 gp (Col1)
    public static final double SCORE_GOLD = 0.001;

    // Score bonus for each founding father (Col1)
    public static final int SCORE_FOUNDING_FATHER = 5;

    // Percentage bonuses for being the 1st,2nd and 3rd player to
    // achieve independence. (Col1)
    public static final int SCORE_INDEPENDENCE_BONUS_FIRST = 100;
    public static final int SCORE_INDEPENDENCE_BONUS_SECOND = 50;
    public static final int SCORE_INDEPENDENCE_BONUS_THIRD = 25;

    /** The network socket to the player's client. */
    private Socket socket;

    /** The connection for this player. */
    private Connection connection;

<span class="fc" id="L149">    private boolean connected = false;</span>

    /** Remaining emigrants to select due to a fountain of youth */
<span class="fc" id="L152">    private int remainingEmigrants = 0;</span>

    /** Players with respect to which stance has changed. */
<span class="fc" id="L155">    private final List&lt;ServerPlayer&gt; stanceDirty = new ArrayList&lt;&gt;();</span>

    /** Accumulate extra trades here.  Do not serialize. */
<span class="fc" id="L158">    private final List&lt;AbstractGoods&gt; extraTrades = new ArrayList&lt;&gt;();</span>


    /**
     * Trivial constructor required for all ServerModelObjects.
     */
    public ServerPlayer(Game game, String id) {
<span class="fc" id="L165">        super(game, id);</span>
<span class="fc" id="L166">    }</span>

    /**
     * Creates a new ServerPlayer.
     *
     * @param game The &lt;code&gt;Game&lt;/code&gt; this object belongs to.
     * @param admin Whether the player is the game administrator or not.
     * @param nation The nation of the &lt;code&gt;Player&lt;/code&gt;.
     * @param socket The socket to the player's client.
     * @param connection The &lt;code&gt;Connection&lt;/code&gt; for the socket.
     */
    public ServerPlayer(Game game, boolean admin, Nation nation,
                        Socket socket, Connection connection) {
<span class="fc" id="L179">        super(game);</span>

<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (nation == null) throw new IllegalArgumentException(&quot;Null nation&quot;);</span>
<span class="fc" id="L182">        final Specification spec = getSpecification();</span>

<span class="fc" id="L184">        this.name = nation.getRulerName();</span>
<span class="fc" id="L185">        this.admin = admin;</span>
<span class="fc" id="L186">        this.nationId = nation.getId();</span>
<span class="fc" id="L187">        this.immigration = 0;</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">        if (nation.isUnknownEnemy()) { // virtual &quot;enemy privateer&quot; player</span>
<span class="fc" id="L189">            this.nationType = null;</span>
<span class="fc" id="L190">            this.playerType = PlayerType.COLONIAL;</span>
<span class="fc" id="L191">            this.europe = null;</span>
<span class="fc" id="L192">            this.monarch = null;</span>
<span class="fc" id="L193">            this.gold = 0;</span>
<span class="fc" id="L194">            this.setAI(true);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        } else if (nation.getType() != null) {</span>
<span class="fc" id="L196">            this.nationType = nation.getType();</span>
            try {
<span class="fc" id="L198">                addFeatures(nationType);</span>
<span class="nc" id="L199">            } catch (Throwable error) {</span>
<span class="nc" id="L200">                error.printStackTrace();</span>
<span class="fc" id="L201">            }</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">            if (nationType.isEuropean()) {</span>
                /*
                 * Setting the amount of gold to
                 * &quot;getGameOptions().getInteger(GameOptions.STARTING_MONEY)&quot;
                 *
                 * just before starting the game. See
                 * &quot;net.sf.freecol.server.control.PreGameController&quot;.
                 */
<span class="fc bfc" id="L210" title="All 2 branches covered.">                this.playerType = (nationType.isREF()) ? PlayerType.ROYAL</span>
                    : PlayerType.COLONIAL;
<span class="fc" id="L212">                this.europe = new ServerEurope(game, this);</span>
<span class="fc" id="L213">                initializeHighSeas();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">                if (this.playerType == PlayerType.COLONIAL) {</span>
<span class="fc" id="L215">                    this.monarch = new Monarch(game, this);</span>
                    // In BR#2615 misiulo reports that Col1 players start
                    // with 2 crosses.  This is surprising, but you could
                    // argue that some level of religious unrest might
                    // contribute to the fact there is an expedition to
                    // the new world underway.
<span class="fc" id="L221">                    this.immigration = spec.getInteger(GameOptions.PLAYER_IMMIGRATION_BONUS);</span>
                }
<span class="fc" id="L223">                this.gold = 0;</span>
            } else { // indians
<span class="fc" id="L225">                this.playerType = PlayerType.NATIVE;</span>
<span class="fc" id="L226">                this.gold = Player.GOLD_NOT_ACCOUNTED;</span>
            }
        } else {
<span class="nc" id="L229">            throw new IllegalArgumentException(&quot;Bogus nation: &quot; + nation);</span>
        }
<span class="fc" id="L231">        this.market = new Market(getGame(), this);</span>
<span class="fc" id="L232">        this.liberty = 0;</span>
<span class="fc" id="L233">        this.currentFather = null;</span>

<span class="fc" id="L235">        this.socket = socket;</span>
<span class="fc" id="L236">        this.connection = connection;</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">        connected = connection != null;</span>
<span class="fc" id="L238">    }</span>


    /**
     * Is this player is currently connected to the server?
     *
     * @return True if this player is currently connected to the server.
     */
    public boolean isConnected() {
<span class="fc" id="L247">        return connected;</span>
    }

    /**
     * Sets the &quot;connected&quot;-status of this player.
     *
     * @param connected Should be &lt;i&gt;true&lt;/i&gt; if this player is currently
     *         connected to the server and &lt;code&gt;false&lt;/code&gt; otherwise.
     * @see #isConnected
     */
    public void setConnected(boolean connected) {
<span class="fc" id="L258">        this.connected = connected;</span>
<span class="fc" id="L259">    }</span>

    /**
     * Gets the socket of this player.
     * @return The &lt;code&gt;Socket&lt;/code&gt;.
     */
    public Socket getSocket() {
<span class="nc" id="L266">        return socket;</span>
    }

    /**
     * Gets the connection of this player.
     *
     * @return The &lt;code&gt;Connection&lt;/code&gt;.
     */
    public Connection getConnection() {
<span class="fc" id="L275">        return connection;</span>
    }

    /**
     * Sets the connection of this player.
     *
     * @param connection The &lt;code&gt;Connection&lt;/code&gt;.
     */
    public void setConnection(Connection connection) {
<span class="fc" id="L284">        this.connection = connection;</span>
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">        connected = (connection != null);</span>
<span class="fc" id="L286">    }</span>

    /**
     * Send a change set to this player.
     *
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to send.
     */
    public void send(ChangeSet cs) {
<span class="fc" id="L294">        askElement(cs.build(this));</span>
<span class="fc" id="L295">    }</span>
    
    /**
     * Send an element to this player.
     * Do not use (sole use in send() above). This will go away.
     *
     * @param request An &lt;code&gt;Element&lt;/code&gt; containing the update.
     */
    private void askElement(Element request) {
<span class="pc bpc" id="L304" title="1 of 2 branches missed.">        if (this.connection == null) return;</span>

<span class="fc bfc" id="L306" title="All 2 branches covered.">        while (request != null) {</span>
            Element reply;
            try {
<span class="fc" id="L309">                reply = this.connection.ask(request);</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">                if (reply == null) break;</span>
<span class="nc" id="L311">            } catch (IOException e) {</span>
<span class="nc" id="L312">                logger.log(Level.WARNING, &quot;Could not send \&quot;&quot;</span>
<span class="nc" id="L313">                    + request.getTagName() + &quot;\&quot;-message.&quot;, e);</span>
<span class="nc" id="L314">                break;</span>
<span class="fc" id="L315">            }</span>

            try {
<span class="fc" id="L318">                request = this.connection.handle(reply);</span>
<span class="nc" id="L319">            } catch (FreeColException fce) {</span>
<span class="nc" id="L320">                logger.log(Level.WARNING, &quot;Exception processing reply \&quot;&quot;</span>
<span class="nc" id="L321">                    + reply.getTagName() + &quot;\&quot;-message.&quot;, fce);</span>
<span class="nc" id="L322">                break;</span>
<span class="fc" id="L323">            }</span>
<span class="fc" id="L324">        }</span>
<span class="fc" id="L325">    }</span>

    /**
     * Update the current father.
     *
     * @param ff The &lt;code&gt;FoundingFather&lt;/code&gt; to recruit.
     */
    public void updateCurrentFather(FoundingFather ff) {
<span class="nc" id="L333">        setCurrentFather(ff);</span>
<span class="nc" id="L334">        clearOfferedFathers();</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (ff != null) {</span>
<span class="nc" id="L336">            logger.finest(getId() + &quot; is recruiting &quot; + ff.getId()</span>
<span class="nc" id="L337">                + &quot; in &quot; + getGame().getTurn());</span>
        }
<span class="nc" id="L339">    }</span>

    /**
     * Accumulate extra trades.
     *
     * @param ag The &lt;code&gt;AbstractGoods&lt;/code&gt; describing the sale.
     */
    public void addExtraTrade(AbstractGoods ag) {
<span class="fc" id="L347">        extraTrades.add(ag);</span>
<span class="fc" id="L348">    }</span>

    /**
     * Flush the extra trades.
     *
     * @param random A pseudo-random number source.
     */
    public void flushExtraTrades(Random random) {
<span class="fc bfc" id="L356" title="All 2 branches covered.">        while (!extraTrades.isEmpty()) {</span>
<span class="fc" id="L357">            AbstractGoods ag = extraTrades.remove(0);</span>
<span class="fc" id="L358">            propagateToEuropeanMarkets(ag.getType(), ag.getAmount(), random);</span>
<span class="fc" id="L359">        }</span>
<span class="fc" id="L360">    }</span>

    /**
     * Performs initial randomizations for this player.
     *
     * @param random A pseudo-random number source.
     */
    public void randomizeGame(Random random) {
<span class="pc bpc" id="L368" title="2 of 6 branches missed.">        if (!isEuropean() || isREF() || isUnknownEnemy()) return;</span>
<span class="fc" id="L369">        final Specification spec = getGame().getSpecification();</span>

        // Set initial immigration target
<span class="fc" id="L372">        int i0 = spec.getInteger(GameOptions.INITIAL_IMMIGRATION);</span>
<span class="fc" id="L373">        immigrationRequired = (int)applyModifiers((float)i0, null,</span>
            Modifier.RELIGIOUS_UNREST_BONUS);

        // Add initial gold
<span class="fc" id="L377">        modifyGold(spec.getInteger(GameOptions.STARTING_MONEY));</span>

        // Choose starting immigrants
<span class="fc" id="L380">        ((ServerEurope)getEurope()).initializeMigration(random);</span>

        // Randomize the initial market prices
<span class="fc" id="L383">        Market market = getMarket();</span>
<span class="fc" id="L384">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L385">        boolean changed = false;</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">        for (GoodsType type : spec.getGoodsTypeList()) {</span>
<span class="fc" id="L387">            String prefix = &quot;model.option.&quot;</span>
<span class="fc" id="L388">                + type.getSuffix(&quot;model.goods.&quot;);</span>
            // these options are not available for all goods types
<span class="fc bfc" id="L390" title="All 2 branches covered.">            if (spec.hasOption(prefix + &quot;.minimumPrice&quot;)</span>
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">                &amp;&amp; spec.hasOption(prefix + &quot;.maximumPrice&quot;)) {</span>
<span class="fc" id="L392">                int min = spec.getInteger(prefix + &quot;.minimumPrice&quot;);</span>
<span class="fc" id="L393">                int max = spec.getInteger(prefix + &quot;.maximumPrice&quot;);</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">                if (max &lt; min) { // User error</span>
<span class="nc" id="L395">                    int bad = min;</span>
<span class="nc" id="L396">                    min = max;</span>
<span class="nc" id="L397">                    max = bad;</span>
<span class="pc bfc" id="L398" title="All 2 branches covered.">                } else if (max == min) continue;</span>
<span class="fc" id="L399">                int add = randomInt(null, null, random, max - min);</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">                if (add &gt; 0) {</span>
<span class="fc" id="L401">                    market.setInitialPrice(type, min + add);</span>
<span class="fc" id="L402">                    market.update(type);</span>
<span class="fc" id="L403">                    market.flushPriceChange(type);</span>
<span class="fc" id="L404">                    sb.append(&quot;, &quot;).append(type.getId())</span>
<span class="fc" id="L405">                        .append(&quot; -&gt; &quot;).append(min + add);</span>
<span class="fc" id="L406">                    changed = true;</span>
                }
            }
<span class="fc" id="L409">        }</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">        if (changed) {</span>
<span class="fc" id="L411">            logger.finest(&quot;randomizeGame(&quot; + getId() + &quot;) initial prices: &quot;</span>
<span class="fc" id="L412">                + sb.toString().substring(2));</span>
        }
<span class="fc" id="L414">    }</span>

    /**
     * Checks if this player has died.
     *
     * @return Negative if the player is dead, zero if they are ok,
     *      positive non-zero if the server should auto-recruit
     *      colonist units to keep this player alive.
     */
    public int checkForDeath() {
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">        if (isUnknownEnemy()) return IS_ALIVE;</span>
<span class="fc" id="L425">        final Specification spec = getGame().getSpecification();</span>
        /*
         * Die if: (isNative &amp;&amp; (no colonies or units))
         *      || ((rebel or independent) &amp;&amp; !(has coastal colony))
         *      || (isREF &amp;&amp; !(rebel nation left) &amp;&amp; (all units in Europe))
         *      || ((no units in New World)
         *         &amp;&amp; ((year &gt; 1600) || (cannot get a unit from Europe)))
         */
<span class="pc bpc" id="L433" title="4 of 6 branches missed.">        switch (getPlayerType()) {</span>
        case NATIVE: // All natives units are viable
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">            return (getUnits().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

        case COLONIAL: // Handle the hard case below
<span class="fc" id="L438">            break;</span>

        case REBEL: case INDEPENDENT:
            // Post-declaration European player needs a coastal colony
            // and can not hope for resupply from Europe.
<span class="nc bnc" id="L443" title="All 2 branches missed.">            return (getNumberOfPorts() &gt; 0) ? IS_ALIVE : IS_DEAD;</span>

        case ROYAL:
<span class="nc bnc" id="L446" title="All 2 branches missed.">            return (getRebels().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

        case UNDEAD:
<span class="nc bnc" id="L449" title="All 2 branches missed.">            return (getUnits().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

        default:
<span class="nc" id="L452">            throw new IllegalStateException(&quot;Bogus player type&quot;);</span>
        }

        // Quick check for a colony.  Do not log, this is the common case.
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">        if (!getColonies().isEmpty()) return IS_ALIVE;</span>

        // Do not kill the observing player during a debug run.
<span class="pc bpc" id="L459" title="3 of 4 branches missed.">        if (!isAI() &amp;&amp; FreeColDebugger.getDebugRunTurns() &gt;= 0) return IS_ALIVE;</span>

        // Do not kill the unknown enemy!
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">        if (isUnknownEnemy()) return IS_ALIVE;</span>

        // Traverse player units, look for valid carriers, colonists,
        // carriers with units, carriers with goods.
<span class="fc" id="L466">        boolean hasCarrier = false, hasColonist = false, hasEmbarked = false,</span>
<span class="fc" id="L467">            hasGoods = false;</span>
<span class="fc bfc" id="L468" title="All 2 branches covered.">        for (Unit unit : getUnits()) {</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">            if (unit.isCarrier()) {</span>
<span class="pc bpc" id="L470" title="1 of 2 branches missed.">                if (unit.hasGoodsCargo()) hasGoods = true;</span>
<span class="fc" id="L471">                hasCarrier = true;</span>
<span class="fc" id="L472">                continue;</span>
            }

            // Must be able to found new colony or capture units
<span class="pc bpc" id="L476" title="3 of 4 branches missed.">            if (!unit.isColonist() &amp;&amp; !unit.isOffensiveUnit()) continue;</span>
<span class="fc" id="L477">            hasColonist = true;</span>

            // Verify if unit is in new world, or on a carrier in new world
            Unit carrier;
<span class="fc bfc" id="L481" title="All 2 branches covered.">            if ((carrier = unit.getCarrier()) != null) {</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">                if (carrier.hasTile()) {</span>
<span class="nc" id="L483">                    logger.info(getName() + &quot; alive, unit &quot; + unit.getId()</span>
                        + &quot; (embarked) on map.&quot;);
<span class="nc" id="L485">                    return IS_ALIVE;</span>
                }
<span class="fc" id="L487">                hasEmbarked = true;</span>
            }
<span class="pc bpc" id="L489" title="1 of 4 branches missed.">            if (unit.hasTile() &amp;&amp; !unit.isInMission()) {</span>
<span class="fc" id="L490">                logger.info(getName() + &quot; alive, unit &quot; + unit.getId()</span>
                    + &quot; on map.&quot;);
<span class="fc" id="L492">                return IS_ALIVE;</span>
            }
<span class="fc" id="L494">        }</span>
        // The player does not have any valid units or settlements on the map.

<span class="fc" id="L497">        int mandatory = spec.getInteger(GameOptions.MANDATORY_COLONY_YEAR);</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">        if (getGame().getTurn().getYear() &gt;= mandatory) {</span>
            // After the season cutover year there must be a presence
            // in the New World.
<span class="fc" id="L501">            logger.info(getName() + &quot; dead, no presence &gt;= &quot; + mandatory);</span>
<span class="fc" id="L502">            return IS_DEAD;</span>
        }

        // No problems, unit available on carrier but off map, or goods
        // available to be sold.
<span class="fc bfc" id="L507" title="All 2 branches covered.">        if (hasEmbarked) {</span>
<span class="fc" id="L508">            logger.info(getName() + &quot; alive, has embarked unit.&quot;);</span>
<span class="fc" id="L509">            return IS_ALIVE;</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">        } else if (hasGoods) {</span>
<span class="nc" id="L511">            logger.info(getName() + &quot; alive, has cargo.&quot;);</span>
<span class="nc" id="L512">            return IS_ALIVE;</span>
        }

        // It is necessary to still have a carrier.
<span class="fc" id="L516">        final Europe europe = getEurope();</span>
<span class="fc" id="L517">        int goldNeeded = 0;</span>
<span class="fc bfc" id="L518" title="All 2 branches covered.">        if (!hasCarrier) {</span>
<span class="fc" id="L519">            int price = Integer.MAX_VALUE;</span>
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">            if (europe != null) {</span>
                for (UnitType type
<span class="fc bfc" id="L522" title="All 2 branches covered.">                         : spec.getUnitTypesWithAbility(Ability.NAVAL_UNIT)) {</span>
<span class="fc" id="L523">                    int p = europe.getUnitPrice(type);</span>
<span class="fc bfc" id="L524" title="All 4 branches covered.">                    if (p != UNDEFINED &amp;&amp; p &lt; price) price = p;</span>
<span class="fc" id="L525">                }</span>
            }
<span class="pc bpc" id="L527" title="1 of 4 branches missed.">            if (price == Integer.MAX_VALUE || !checkGold(price)) {</span>
<span class="fc" id="L528">                logger.info(getName() + &quot; dead, can not buy carrier.&quot;);</span>
<span class="fc" id="L529">                return IS_DEAD;</span>
            }
<span class="fc" id="L531">            goldNeeded += price;</span>
        }

        // A colonist is required.
<span class="fc bfc" id="L535" title="All 2 branches covered.">        if (hasColonist) {</span>
<span class="fc" id="L536">            logger.info(getName() + &quot; alive, has waiting colonist.&quot;);</span>
<span class="fc" id="L537">            return IS_ALIVE;</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">        } else if (europe == null) {</span>
<span class="nc" id="L539">            logger.info(getName() + &quot; dead, can not recruit.&quot;);</span>
<span class="nc" id="L540">            return IS_DEAD;</span>
        }
<span class="fc" id="L542">        UnitType unitType = null;</span>
<span class="fc" id="L543">        int price = europe.getRecruitPrice();</span>
<span class="fc bfc" id="L544" title="All 2 branches covered.">        for (UnitType type : spec.getUnitTypesWithAbility(Ability.FOUND_COLONY)) {</span>
<span class="fc" id="L545">            int p = europe.getUnitPrice(type);</span>
<span class="pc bpc" id="L546" title="1 of 4 branches missed.">            if (p != UNDEFINED &amp;&amp; p &lt; price) price = p;</span>
<span class="fc" id="L547">        }</span>
<span class="fc" id="L548">        goldNeeded += price;</span>
<span class="fc bfc" id="L549" title="All 2 branches covered.">        if (checkGold(goldNeeded)) {</span>
<span class="fc" id="L550">            logger.info(getName() + &quot; alive, can buy colonist.&quot;);</span>
<span class="fc" id="L551">            return IS_ALIVE;</span>
        }

        // Col1 auto-recruits a unit in Europe if you run out before
        // the cutover year.
<span class="fc" id="L556">        logger.info(getName() + &quot; survives by autorecruit.&quot;);</span>
<span class="fc" id="L557">        return AUTORECRUIT;</span>
    }

    /**
     * Check if a REF player has been defeated and should surrender.
     *
     * @return True if this REF player has been defeated.
     */
    public boolean checkForREFDefeat() {
<span class="nc bnc" id="L566" title="All 2 branches missed.">        if (!isREF()) {</span>
<span class="nc" id="L567">            throw new IllegalStateException(&quot;Checking for REF player defeat when player not REF.&quot;);</span>
        }

        // No one to fight?  Either the rebels are dead, or the REF
        // was already defeated and the rebels are independent.
        // Either way, it does not need to surrender.
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (getRebels().isEmpty()) return false;</span>

        // Not defeated if there are settlements.
<span class="nc bnc" id="L576" title="All 2 branches missed.">        if (!getSettlements().isEmpty()) return false;</span>

        // Not defeated if there is a non-zero navy and enough land units.
<span class="nc" id="L579">        final int landREFUnitsRequired = 7; // FIXME: magic number</span>
<span class="nc" id="L580">        final CombatModel cm = getGame().getCombatModel();</span>
<span class="nc" id="L581">        boolean naval = false;</span>
<span class="nc" id="L582">        int land = 0;</span>
<span class="nc" id="L583">        int power = 0;</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">        for (Unit u : getUnits()) {</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">            if (u.isNaval()) naval = true; else {</span>
<span class="nc bnc" id="L586" title="All 2 branches missed.">                if (u.hasAbility(Ability.REF_UNIT)) {</span>
<span class="nc" id="L587">                    land++;</span>
<span class="nc" id="L588">                    power += cm.getOffencePower(u, null);</span>
                }
            }
<span class="nc" id="L591">        }</span>
<span class="nc bnc" id="L592" title="All 4 branches missed.">        if (naval &amp;&amp; land &gt;= landREFUnitsRequired) return false;</span>

        // Still not defeated as long as military strength is greater
        // than the rebels.
<span class="nc" id="L596">        int rebelPower = 0;</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">        for (Player rebel : getRebels()) {</span>
<span class="nc" id="L598">            rebelPower += rebel.getUnits().stream()</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">                .filter(u -&gt; !u.isNaval())</span>
<span class="nc" id="L600">                .mapToDouble(u -&gt; cm.getOffencePower(u, null)).sum();</span>
<span class="nc" id="L601">        }</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">        if (power &gt; rebelPower) return false;</span>

        // REF is defeated
<span class="nc" id="L605">        return true;</span>
    }

    /**
     * Kill off a player and clear out its remains.
     *
     * +vis: Albeit killing the player makes visibility changes moot.
     * +til: Fixes the appearance changes too.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csKill(ChangeSet cs) {
<span class="nc" id="L617">        setDead(true);</span>
<span class="nc" id="L618">        cs.addPartial(See.all(), this, &quot;dead&quot;);</span>
<span class="nc" id="L619">        cs.addDead(this);</span>

        // Clean up missions and remove tension/alarm/stance.
<span class="nc bnc" id="L622" title="All 2 branches missed.">        for (Player other : getGame().getLivePlayers(this)) {</span>
<span class="nc bnc" id="L623" title="All 4 branches missed.">            if (isEuropean() &amp;&amp; other.isIndian()) {</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                for (IndianSettlement s : other.getIndianSettlements()) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                    if (s.hasMissionary(this)) {</span>
<span class="nc" id="L626">                        ((ServerIndianSettlement)s).csKillMissionary(null, cs);</span>
                    }
<span class="nc" id="L628">                    s.getTile().cacheUnseen();//+til</span>
<span class="nc" id="L629">                    ((ServerIndianSettlement)s).removeAlarm(this);//-til</span>
<span class="nc" id="L630">                }</span>
<span class="nc" id="L631">                other.removeTension(this);</span>
            }
<span class="nc" id="L633">            other.setStance(this, null);</span>
<span class="nc" id="L634">        }</span>

        // Remove settlements.  Update formerly owned tiles.
<span class="nc" id="L637">        List&lt;Settlement&gt; settlements = getSettlements();</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">        while (!settlements.isEmpty()) {</span>
<span class="nc" id="L639">            csDisposeSettlement(settlements.remove(0), cs);</span>
        }

        // Clean up remaining tile ownerships
<span class="nc bnc" id="L643" title="All 2 branches missed.">        for (Tile tile : getGame().getMap().getAllTiles()) {</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">            if (tile.getOwner() == this) {</span>
<span class="nc" id="L645">                tile.cacheUnseen();//+til</span>
<span class="nc" id="L646">                tile.changeOwnership(null, null);//-til</span>
<span class="nc" id="L647">                cs.add(See.perhaps().always(this), tile);</span>
            }
<span class="nc" id="L649">        }</span>

        // Remove units
<span class="nc" id="L652">        List&lt;Unit&gt; units = getUnits();</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">        while (!units.isEmpty()) {</span>
<span class="nc" id="L654">            Unit u = units.remove(0);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">            if (u.hasTile()) cs.add(See.perhaps(), u.getTile());</span>
<span class="nc" id="L656">            cs.addRemove(See.perhaps().always(this),</span>
<span class="nc" id="L657">                         u.getLocation(), u);//-vis(this)</span>
<span class="nc" id="L658">            u.dispose();</span>
<span class="nc" id="L659">        }</span>

        // Remove European stuff
<span class="nc bnc" id="L662" title="All 2 branches missed.">        if (market != null) {</span>
<span class="nc" id="L663">            market.dispose();</span>
<span class="nc" id="L664">            market = null;</span>
        }
<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (monarch != null) {</span>
<span class="nc" id="L667">            monarch.dispose();</span>
<span class="nc" id="L668">            monarch = null;</span>
        }
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (europe != null) {</span>
<span class="nc" id="L671">            europe.dispose();</span>
<span class="nc" id="L672">            europe = null;</span>
        }
<span class="nc" id="L674">        currentFather = null;</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">        if (foundingFathers != null) foundingFathers.clear();</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">        if (offeredFathers != null) offeredFathers.clear();</span>
        // FIXME: stance and tension?
<span class="nc bnc" id="L678" title="All 2 branches missed.">        if (tradeRoutes != null) tradeRoutes.clear();</span>
        // Retaining model messages for now
        // Retaining history for now
<span class="nc bnc" id="L681" title="All 2 branches missed.">        if (lastSales != null) lastSales = null;</span>
<span class="nc" id="L682">        featureContainer.clear();</span>

<span class="nc" id="L684">        invalidateCanSeeTiles();//+vis(this)</span>
<span class="nc" id="L685">    }</span>

    /**
     * Withdraw a player from the new world.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csWithdraw(ChangeSet cs) {
<span class="nc" id="L693">        cs.addMessage(See.all(),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="nc bnc" id="L695" title="All 4 branches missed.">                ((isEuropean() &amp;&amp; getPlayerType() == PlayerType.COLONIAL)</span>
                    ? &quot;model.player.dead.european&quot;
                    : &quot;model.player.dead.native&quot;),
                this)
<span class="nc" id="L699">            .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
<span class="nc" id="L700">        Game game = getGame();</span>
<span class="nc" id="L701">        cs.addGlobalHistory(game,</span>
<span class="nc" id="L702">            new HistoryEvent(game.getTurn(),</span>
                HistoryEvent.HistoryEventType.NATION_DESTROYED, null)
<span class="nc" id="L704">            .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
<span class="nc" id="L705">        csKill(cs);</span>
<span class="nc" id="L706">    }</span>


    public int getRemainingEmigrants() {
<span class="nc" id="L710">        return remainingEmigrants;</span>
    }

    public void setRemainingEmigrants(int emigrants) {
<span class="nc" id="L714">        remainingEmigrants = emigrants;</span>
<span class="nc" id="L715">    }</span>

    /**
     * Checks whether the current founding father has been recruited.
     *
     * @return The new founding father, or null if none available or ready.
     */
    public FoundingFather checkFoundingFather() {
<span class="nc" id="L723">        FoundingFather father = null;</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (currentFather != null) {</span>
<span class="nc" id="L725">            int extraLiberty = getRemainingFoundingFatherCost();</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">            if (extraLiberty &lt;= 0) {</span>
<span class="nc" id="L727">                boolean overflow = getSpecification()</span>
<span class="nc" id="L728">                    .getBoolean(GameOptions.SAVE_PRODUCTION_OVERFLOW);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">                setLiberty((overflow) ? -extraLiberty : 0);</span>
<span class="nc" id="L730">                father = currentFather;</span>
<span class="nc" id="L731">                currentFather = null;</span>
            }
        }
<span class="nc" id="L734">        return father;</span>
    }

    /**
     * Checks whether to start recruiting a founding father.
     *
     * @return True if a new father should be chosen.
     */
    public boolean canRecruitFoundingFather() {
<span class="nc" id="L743">        Specification spec = getGame().getSpecification();</span>
<span class="nc bnc" id="L744" title="All 3 branches missed.">        switch (getPlayerType()) {</span>
        case COLONIAL:
<span class="nc" id="L746">            break;</span>
        case REBEL: case INDEPENDENT:
<span class="nc bnc" id="L748" title="All 2 branches missed.">            if (!spec.getBoolean(GameOptions.CONTINUE_FOUNDING_FATHER_RECRUITMENT)) return false;</span>
            break;
        default:
<span class="nc" id="L751">            return false;</span>
        }
<span class="nc bnc" id="L753" title="All 4 branches missed.">        return canHaveFoundingFathers() &amp;&amp; currentFather == null</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">            &amp;&amp; !getSettlements().isEmpty()</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">            &amp;&amp; getFatherCount() &lt; spec.getFoundingFathers().size();</span>
    }

    /**
     * Build a list of random FoundingFathers, one per type.
     * Do not include any the player has or are not available.
     *
     * @param random A pseudo-random number source.
     * @return A list of FoundingFathers.
     */
    public List&lt;FoundingFather&gt; getRandomFoundingFathers(Random random) {
        // Build weighted random choice for each father type
<span class="nc" id="L767">        final Game game = getGame();</span>
<span class="nc" id="L768">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L769">        final int age = game.getAge();</span>
<span class="nc" id="L770">        EnumMap&lt;FoundingFatherType, List&lt;RandomChoice&lt;FoundingFather&gt;&gt;&gt; choices</span>
            = new EnumMap&lt;&gt;(FoundingFatherType.class);
<span class="nc bnc" id="L772" title="All 2 branches missed.">        for (FoundingFather father : spec.getFoundingFathers()) {</span>
<span class="nc bnc" id="L773" title="All 4 branches missed.">            if (!hasFather(father) &amp;&amp; father.isAvailableTo(this)) {</span>
<span class="nc" id="L774">                FoundingFatherType type = father.getType();</span>
<span class="nc" id="L775">                List&lt;RandomChoice&lt;FoundingFather&gt;&gt; rc = choices.get(type);</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">                if (rc == null) rc = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L777">                int weight = father.getWeight(age);</span>
<span class="nc" id="L778">                rc.add(new RandomChoice&lt;&gt;(father, weight));</span>
<span class="nc" id="L779">                choices.put(father.getType(), rc);</span>
            }
<span class="nc" id="L781">        }</span>

        // Select one from each father type
<span class="nc" id="L784">        List&lt;FoundingFather&gt; randomFathers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L785">        LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L786">        lb.add(&quot;Random fathers for &quot;, getDebugName());</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">        for (FoundingFatherType type : FoundingFatherType.values()) {</span>
<span class="nc" id="L788">            List&lt;RandomChoice&lt;FoundingFather&gt;&gt; rc = choices.get(type);</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">            if (rc != null) {</span>
<span class="nc" id="L790">                FoundingFather f = RandomChoice.getWeightedRandom(logger,</span>
                    &quot;Choose founding father&quot;, rc, random);
<span class="nc bnc" id="L792" title="All 2 branches missed.">                if (f != null) {</span>
<span class="nc" id="L793">                    randomFathers.add(f);</span>
<span class="nc" id="L794">                    lb.add(&quot;:&quot;, f.getSuffix());</span>
                }
            }
        }
<span class="nc" id="L798">        lb.log(logger, Level.INFO);</span>
<span class="nc" id="L799">        return randomFathers;</span>
    }

    /**
     * Add a HistoryEvent to this player.
     *
     * @param event The &lt;code&gt;HistoryEvent&lt;/code&gt; to add.
     */
    @Override
    public void addHistory(HistoryEvent event) {
<span class="fc" id="L809">        history.add(event);</span>
<span class="fc" id="L810">    }</span>

    /**
     * Update the current score for this player.
     *
     * Known incompatibility with the Col1 manual:
     * ``In addition, you get one point per liberty bell produced
     *   after foreign intervention''
     * However you are already getting a point per liberty bell
     * produced, so this implies you get no further liberty after
     * declaring independence!?, but it can then start again if the
     * foreign intervention happens (penalizing players who quickly
     * thrash the REF:-S).  Whatever this really means, it is
     * incompatible with our extensions to allow playing on (and
     * defeating other Europeans), so for now at least just leave the
     * simple liberty==score rule in place.
     *
     * @return True if the player score changed.
     */
    public boolean updateScore() {
<span class="nc" id="L830">        int oldScore = score;</span>
<span class="nc" id="L831">        score = getUnits().stream()</span>
<span class="nc" id="L832">                .mapToInt(u -&gt; u.getType().getScoreValue()).sum()</span>
<span class="nc" id="L833">            + getColonies().stream()</span>
<span class="nc" id="L834">                .mapToInt(c -&gt; c.getLiberty()).sum()</span>
<span class="nc" id="L835">            + SCORE_FOUNDING_FATHER * getFathers().size();</span>
<span class="nc" id="L836">        int gold = getGold();</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">        if (gold != GOLD_NOT_ACCOUNTED) {</span>
<span class="nc" id="L838">            score += (int)Math.floor(SCORE_GOLD * gold);</span>
        }
        
<span class="nc" id="L841">        int bonus = 0;</span>
<span class="nc bnc" id="L842" title="All 2 branches missed.">        for (HistoryEvent h : getHistory()) {</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">            if (getId().equals(h.getPlayerId())) {</span>
<span class="pc bnc" id="L844" title="All 2 branches missed.">                switch (h.getEventType()) {</span>
                case INDEPENDENCE:
<span class="nc bnc" id="L846" title="All 4 branches missed.">                    switch (h.getScore()) {</span>
<span class="nc" id="L847">                    case 0: bonus = SCORE_INDEPENDENCE_BONUS_FIRST; break;</span>
<span class="nc" id="L848">                    case 1: bonus = SCORE_INDEPENDENCE_BONUS_SECOND; break;</span>
<span class="nc" id="L849">                    case 2: bonus = SCORE_INDEPENDENCE_BONUS_THIRD; break;</span>
<span class="nc" id="L850">                    default: bonus = 0; break;</span>
                    }
                    break;
                default:
<span class="nc" id="L854">                    score += h.getScore();</span>
                    break;
                }
            }
<span class="nc" id="L858">        }</span>
<span class="nc" id="L859">        score += (score * bonus) / 100;</span>

<span class="nc bnc" id="L861" title="All 2 branches missed.">        return score != oldScore;</span>
    }

    /**
     * Checks if this &lt;code&gt;Player&lt;/code&gt; has explored the given
     * &lt;code&gt;Tile&lt;/code&gt;.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt;.
     * @return &lt;i&gt;true&lt;/i&gt; if the &lt;code&gt;Tile&lt;/code&gt; has been explored and
     *         &lt;i&gt;false&lt;/i&gt; otherwise.
     */
    @Override
    public boolean hasExplored(Tile tile) {
<span class="fc" id="L874">        return tile.isExploredBy(this);</span>
    }

    /**
     * Sets the given tile to be explored by this player and updates
     * the player's information about the tile.
     *
     * +til: Exploring the tile also updates the pet.
     *
     * @return True if the tile is newly explored by this action.
     */
    public boolean exploreTile(Tile tile) {
<span class="fc bfc" id="L886" title="All 2 branches covered.">        boolean ret = !hasExplored(tile);</span>
<span class="fc bfc" id="L887" title="All 2 branches covered.">        if (ret) tile.setExplored(this, true);</span>
<span class="fc" id="L888">        return ret;</span>
    }

    /**
     * Sets the tiles within the given &lt;code&gt;Unit&lt;/code&gt;'s line of
     * sight to be explored by this player.
     *
     * @param tiles A list of &lt;code&gt;Tile&lt;/code&gt;s.
     * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
     * @see #hasExplored
     */
    public Set&lt;Tile&gt; exploreTiles(Collection&lt;? extends Tile&gt; tiles) {
<span class="fc" id="L900">        Set&lt;Tile&gt; result = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L901" title="All 2 branches covered.">        for (Tile t : tiles) {</span>
<span class="fc bfc" id="L902" title="All 2 branches covered.">            if (exploreTile(t)) result.add(t);</span>
<span class="fc" id="L903">        }</span>
<span class="fc" id="L904">        return result;</span>
    }

    /**
     * Sets the tiles visible to a given settlement to be explored by
     * this player and updates the player's information about the
     * tiles.  Note that the player does not necessarily own the settlement
     * (e.g. missionary at native settlement).
     *
     * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
     */
    public Set&lt;Tile&gt; exploreForSettlement(Settlement settlement) {
<span class="fc" id="L916">        Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;(settlement.getOwnedTiles());</span>
<span class="fc" id="L917">        tiles.addAll(settlement.getTile().getSurroundingTiles(1,</span>
<span class="fc" id="L918">                     settlement.getLineOfSight()));</span>
<span class="fc" id="L919">        return exploreTiles(tiles);</span>
    }

    /**
     * Sets the tiles within the given &lt;code&gt;Unit&lt;/code&gt;'s line of
     * sight to be explored by this player.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt;.
     * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
     * @see #hasExplored
     */
    public Set&lt;Tile&gt; exploreForUnit(Unit unit) {
<span class="pc bpc" id="L931" title="3 of 6 branches missed.">        return (getGame() == null || getGame().getMap() == null || unit == null</span>
<span class="fc bfc" id="L932" title="All 2 branches covered.">            || !(unit.getLocation() instanceof Tile)) </span>
<span class="fc" id="L933">            ? Collections.&lt;Tile&gt;emptySet()</span>
<span class="fc" id="L934">            : exploreTiles(unit.getTile().getSurroundingTiles(0,</span>
<span class="fc" id="L935">                    unit.getLineOfSight()));</span>
    }

    /**
     * Makes the entire map visible or invisible.
     *
     * @param reveal If true, reveal the map, if false, hide it.
     * @return A list of tiles whose visibility changed.
     */
    public Set&lt;Tile&gt; exploreMap(boolean reveal) {
<span class="fc" id="L945">        Set&lt;Tile&gt; result = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L946" title="All 2 branches covered.">        for (Tile tile : getGame().getMap().getAllTiles()) {</span>
<span class="pc bpc" id="L947" title="1 of 2 branches missed.">            if (hasExplored(tile) != reveal) {</span>
<span class="fc" id="L948">                tile.setExplored(this, reveal);//-vis(this)</span>
<span class="fc" id="L949">                result.add(tile);</span>
            }
<span class="fc" id="L951">        }</span>
<span class="fc" id="L952">        invalidateCanSeeTiles();//+vis(this)</span>
<span class="pc bpc" id="L953" title="1 of 2 branches missed.">        if (!reveal) {</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">            for (Settlement s : getSettlements()) exploreForSettlement(s);</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">            for (Unit u : getUnits()) exploreForUnit(u);</span>
        }
<span class="fc" id="L957">        return result;</span>
    }

    /**
     * Try to reassign the ownership of a collection of tiles.
     *
     * Do it in two passes so the first successful claim does not give
     * a large advantage.
     *
     * @param tiles The collection of &lt;code&gt;Tile&lt;/code&gt;s to reassign.
     * @param prefer An optional &lt;code&gt;Player&lt;/code&gt; to prefer to reassign to.
     * @param avoid An optional &lt;code&gt;Settlement&lt;/code&gt; to consider last
     *     when making claims.
     */
    private static void reassignTiles(Collection&lt;Tile&gt; tiles,
                                      Player prefer,
                                      Settlement avoid) {
<span class="fc" id="L974">        HashMap&lt;Settlement, Integer&gt; votes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L975">        HashMap&lt;Tile, Settlement&gt; claims = new HashMap&lt;&gt;();</span>
        Settlement claimant;
<span class="fc bfc" id="L977" title="All 2 branches covered.">        for (Tile tile : tiles) {</span>
<span class="pc bpc" id="L978" title="1 of 2 branches missed.">            if (tile.isOccupied()) continue;</span>
<span class="fc" id="L979">            votes.clear();</span>
<span class="fc bfc" id="L980" title="All 2 branches covered.">            for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc" id="L981">                claimant = t.getOwningSettlement();</span>
<span class="fc bfc" id="L982" title="All 2 branches covered.">                if (claimant != null</span>
                    // BR#3375773 found a case where tiles were
                    // still owned by a settlement that had been
                    // previously destroyed.  These should be gone, but...
<span class="pc bpc" id="L986" title="1 of 2 branches missed.">                    &amp;&amp; !claimant.isDisposed()</span>
<span class="pc bpc" id="L987" title="1 of 2 branches missed.">                    &amp;&amp; claimant.getOwner() != null</span>
<span class="fc bfc" id="L988" title="All 2 branches covered.">                    &amp;&amp; claimant.getOwner().canOwnTile(tile)</span>
<span class="pc bpc" id="L989" title="1 of 2 branches missed.">                    &amp;&amp; (claimant.getOwner().isIndian()</span>
<span class="fc" id="L990">                        || claimant.getTile().getDistanceTo(tile)</span>
<span class="pc bpc" id="L991" title="1 of 2 branches missed.">                        &lt;= claimant.getRadius())) {</span>
                    // Weight claimant settlements:
                    //   settlements owned by the same player
                    //     &gt; settlements owned by same type of player
                    //     &gt; other settlements
<span class="pc bpc" id="L996" title="1 of 2 branches missed.">                    int value = (prefer == null) ? 1</span>
<span class="pc bpc" id="L997" title="1 of 2 branches missed.">                        : (claimant.getOwner() == prefer) ? 3</span>
<span class="nc" id="L998">                        : (claimant.getOwner().isEuropean()</span>
<span class="pc bnc" id="L999" title="All 2 branches missed.">                            == prefer.isEuropean()) ? 2</span>
                        : 1;
<span class="pc bpc" id="L1001" title="1 of 2 branches missed.">                    if (votes.get(claimant) != null) {</span>
<span class="nc" id="L1002">                        value += votes.get(claimant);</span>
                    }
<span class="fc" id="L1004">                    votes.put(claimant, value);</span>
                }
<span class="fc" id="L1006">            }</span>
<span class="fc" id="L1007">            boolean lastResort = false;</span>
<span class="fc" id="L1008">            int bestValue = 0;</span>
<span class="fc" id="L1009">            claimant = null;</span>
<span class="fc bfc" id="L1010" title="All 2 branches covered.">            for (Entry&lt;Settlement, Integer&gt; entry : votes.entrySet()) {</span>
<span class="pc bpc" id="L1011" title="1 of 2 branches missed.">                if (avoid == entry.getKey()) {</span>
<span class="fc" id="L1012">                    lastResort = true;</span>
<span class="fc" id="L1013">                    continue;</span>
                }
<span class="nc" id="L1015">                int value = entry.getValue();</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">                if (bestValue &lt; value) {</span>
<span class="nc" id="L1017">                    bestValue = value;</span>
<span class="nc" id="L1018">                    claimant = entry.getKey();</span>
                }
<span class="nc" id="L1020">            }</span>
<span class="pc bpc" id="L1021" title="1 of 4 branches missed.">            if (claimant == null &amp;&amp; lastResort) claimant = avoid;</span>
<span class="fc" id="L1022">            claims.put(tile, claimant);</span>
<span class="fc" id="L1023">        }</span>
<span class="fc bfc" id="L1024" title="All 2 branches covered.">        for (Entry&lt;Tile, Settlement&gt; e : claims.entrySet()) {</span>
<span class="fc" id="L1025">            Tile t = e.getKey();</span>
<span class="fc bfc" id="L1026" title="All 2 branches covered.">            if ((claimant = e.getValue()) == null) {</span>
<span class="fc" id="L1027">                t.changeOwnership(null, null);//-til</span>
            } else {
<span class="fc" id="L1029">                ServerPlayer newOwner = (ServerPlayer)claimant.getOwner();</span>
<span class="fc" id="L1030">                t.changeOwnership(newOwner, claimant);//-til</span>
            }
<span class="fc" id="L1032">        }</span>
<span class="fc" id="L1033">    }</span>

    /**
     * Create units from a list of abstract units.  Only used by
     * Europeans at present.
     *
     * -vis: Visibility issues depending on location.
     * -til: Tile appearance issue if created in a colony (not ATM)
     *
     * @param abstractUnits The list of &lt;code&gt;AbstractUnit&lt;/code&gt;s to
     *     create.
     * @param location The &lt;code&gt;Location&lt;/code&gt; where the units will
     *     be created.
     * @return A list of units created.
     */
    public List&lt;Unit&gt; createUnits(List&lt;AbstractUnit&gt; abstractUnits,
                                  Location location) {
<span class="pc bpc" id="L1050" title="1 of 2 branches missed.">        if (location == null) return Collections.&lt;Unit&gt;emptyList();</span>
<span class="fc" id="L1051">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L1053">        final Game game = getGame();</span>
<span class="fc" id="L1054">        final Specification spec = game.getSpecification();</span>
<span class="fc bfc" id="L1055" title="All 2 branches covered.">        for (AbstractUnit au : abstractUnits) {</span>
<span class="fc" id="L1056">            UnitType type = au.getType(spec);</span>
<span class="fc" id="L1057">            Role role = au.getRole(spec);</span>
            // @compat 0.10.x
            // The REF always had an exemption from the availability
            // rules.  We are transitioning to it being subject to the
            // normal rules, which requires REF nations to have the
            // INDEPENDENT_NATION ability (or they do not get
            // man-o-war).  We are also handling the role transition.
            //
            // Drop the isREF() branch when the compatibility code
            // goes away.
<span class="fc bfc" id="L1067" title="All 2 branches covered.">            if (isREF()) {</span>
<span class="pc bpc" id="L1068" title="1 of 2 branches missed.">                if (!role.isAvailableTo(this, type)) {</span>
<span class="nc bnc" id="L1069" title="All 12 branches missed.">                    if (null != role.getId()) switch (role.getId()) {</span>
                        case &quot;model.role.soldier&quot;:
<span class="nc" id="L1071">                            role = spec.getRole(&quot;model.role.infantry&quot;);</span>
<span class="nc" id="L1072">                            break;</span>
                        case &quot;model.role.dragoon&quot;:
<span class="nc" id="L1074">                            role = spec.getRole(&quot;model.role.cavalry&quot;);</span>
<span class="nc" id="L1075">                            break;</span>
                    }
                }
            } else {
<span class="pc bpc" id="L1079" title="1 of 2 branches missed.">                if (!type.isAvailableTo(this)) {</span>
<span class="nc" id="L1080">                    logger.warning(&quot;Ignoring abstract unit &quot; + au</span>
<span class="nc" id="L1081">                        + &quot; unavailable to: &quot; + getId());</span>
<span class="nc" id="L1082">                    continue;</span>
                }
<span class="pc bpc" id="L1084" title="1 of 2 branches missed.">                if (!role.isAvailableTo(this, type)) {</span>
<span class="nc" id="L1085">                    logger.warning(&quot;Ignoring abstract unit &quot; + au</span>
                        + &quot; with role &quot; + role
<span class="nc" id="L1087">                        + &quot; unavailable to: &quot; + getId());</span>
<span class="nc" id="L1088">                    continue;</span>
                }
            }
            // end @compat 0.10.x
<span class="fc bfc" id="L1092" title="All 2 branches covered.">            for (int i = 0; i &lt; au.getNumber(); i++) {</span>
<span class="fc" id="L1093">                ServerUnit su = new ServerUnit(game, location, this, type,</span>
                                               role);//-vis(this)
<span class="fc" id="L1095">                units.add(su);</span>
            }
<span class="fc" id="L1097">        }</span>
<span class="fc" id="L1098">        return units;</span>
    }

    /**
     * Embark the land units.  For all land units, find a naval unit
     * to carry it.  Fill greedily, so as if there is excess naval
     * capacity then the naval units at the end of the list will tend
     * to be empty or very lightly filled, allowing them to defend the
     * whole fleet at full strength.  Returns a list of units that
     * could not be placed on ships.
     *
     * -vis: Has visibility implications depending on the initial
     * location of the loaded units.  Usually ATM this is Europe which
     * is safe, but beware.
     * -til: Safe while in Europe though.
     *
     * @param landUnits A list of land units to put on ships.
     * @param navalUnits A list of ships to put land units on.
     * @param random A pseudo-random number source.
     * @return a list of units left over
     */
    public List&lt;Unit&gt; loadShips(List&lt;Unit&gt; landUnits,
                                List&lt;Unit&gt; navalUnits,
                                Random random) {
<span class="fc" id="L1122">        List&lt;Unit&gt; leftOver = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1123">        randomShuffle(logger, &quot;Naval load&quot;, navalUnits, random);</span>
<span class="fc" id="L1124">        randomShuffle(logger, &quot;Land load&quot;, landUnits, random);</span>
<span class="fc" id="L1125">        LogBuilder lb = new LogBuilder(256);</span>
<span class="fc" id="L1126">        lb.mark();</span>
<span class="fc bfc" id="L1127" title="All 2 branches covered.">        landUnit: for (Unit unit : landUnits) {</span>
<span class="pc bpc" id="L1128" title="1 of 2 branches missed.">            for (Unit carrier : navalUnits) {</span>
<span class="fc bfc" id="L1129" title="All 2 branches covered.">                if (carrier.canAdd(unit)) {</span>
<span class="fc" id="L1130">                    unit.setLocation(carrier);//-vis(owner)</span>
<span class="fc" id="L1131">                    lb.add(unit, &quot; -&gt; &quot;, carrier, &quot;, &quot;);</span>
<span class="fc" id="L1132">                    continue landUnit;</span>
                }
<span class="fc" id="L1134">            }</span>
<span class="nc" id="L1135">            leftOver.add(unit);</span>
<span class="nc" id="L1136">        }</span>
<span class="pc bpc" id="L1137" title="1 of 2 branches missed.">        if (lb.grew(&quot;Load ships: &quot;)) {</span>
<span class="fc" id="L1138">            lb.shrink(&quot;, &quot;);</span>
<span class="fc" id="L1139">            lb.log(logger, Level.FINEST);</span>
        }        
<span class="fc" id="L1141">        return leftOver;</span>
    }

    /**
     * Calculates the price of a group of mercenaries for this player.
     *
     * @param mercenaries A list of mercenaries to price.
     * @return The price.
     */
    public int priceMercenaries(List&lt;AbstractUnit&gt; mercenaries) {
<span class="nc" id="L1151">        int mercPrice = mercenaries.stream()</span>
<span class="nc" id="L1152">            .mapToInt(au -&gt; getPrice(au)).sum();</span>
<span class="nc bnc" id="L1153" title="All 2 branches missed.">        if (!checkGold(mercPrice)) mercPrice = getGold();</span>
<span class="nc" id="L1154">        return mercPrice;</span>
    }

    /**
     * Flush any market price changes.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the market has changed.
     */
    public boolean csFlushMarket(ChangeSet cs) {
<span class="fc" id="L1164">        Market market = getMarket();</span>
<span class="pc bpc" id="L1165" title="1 of 2 branches missed.">        if (market == null) return false;</span>
<span class="fc" id="L1166">        boolean ret = false;</span>
<span class="fc" id="L1167">        StringBuilder sb = new StringBuilder(32);</span>
<span class="fc" id="L1168">        sb.append(&quot;Flush market for &quot;).append(getId()).append(&quot;:&quot;);</span>
<span class="fc bfc" id="L1169" title="All 2 branches covered.">        for (GoodsType type : getSpecification().getGoodsTypeList()) {</span>
<span class="fc bfc" id="L1170" title="All 2 branches covered.">            if (csFlushMarket(type, cs)) {</span>
<span class="fc" id="L1171">                sb.append(&quot; &quot;).append(type.getId());</span>
<span class="fc" id="L1172">                ret = true;</span>
            }
<span class="fc" id="L1174">        }</span>
<span class="fc bfc" id="L1175" title="All 2 branches covered.">        if (ret) logger.finest(sb.toString());</span>
<span class="fc" id="L1176">        return ret;</span>
    }

    /**
     * Flush any market price changes for a specified goods type.
     *
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to check.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the market price had changed.
     */
    public boolean csFlushMarket(GoodsType type, ChangeSet cs) {
<span class="fc" id="L1187">        final Market market = getMarket();</span>
<span class="fc" id="L1188">        boolean ret = market.hasPriceChanged(type);</span>
<span class="fc bfc" id="L1189" title="All 2 branches covered.">        if (ret) {</span>
            // This type of goods has changed price, so we will update
            // the market and send a message as well.
<span class="fc" id="L1192">            cs.addMessage(See.only(this),</span>
<span class="fc" id="L1193">                          market.makePriceChangeMessage(type));</span>
<span class="fc" id="L1194">            market.flushPriceChange(type);</span>
<span class="fc" id="L1195">            cs.add(See.only(this), market.getMarketData(type));</span>
        }
<span class="fc" id="L1197">        return ret;</span>
    }

    /**
     * Buy goods in Europe.
     *
     * @param container The &lt;code&gt;GoodsContainer&lt;/code&gt; to carry the goods.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to buy.
     * @param amount The amount of goods to buy.
     * @return The amount actually removed from the market, or
     *     negative on failure.
     */
    public int buy(GoodsContainer container, GoodsType type, int amount) {
<span class="fc" id="L1210">        final Market market = getMarket();</span>
<span class="fc" id="L1211">        final int price = market.getBidPrice(type, amount);</span>
<span class="fc bfc" id="L1212" title="All 2 branches covered.">        if (!checkGold(price)) return -1;</span>

<span class="fc" id="L1214">        modifyGold(-price);</span>
<span class="fc" id="L1215">        market.modifySales(type, -amount);</span>
<span class="pc bpc" id="L1216" title="1 of 2 branches missed.">        if (container != null) container.addGoods(type, amount);</span>
<span class="fc" id="L1217">        market.modifyIncomeBeforeTaxes(type, -price);</span>
<span class="fc" id="L1218">        market.modifyIncomeAfterTaxes(type, -price);</span>
<span class="fc" id="L1219">        int marketAmount = (int)applyModifiers((float)amount,</span>
<span class="fc" id="L1220">            getGame().getTurn(), Modifier.TRADE_BONUS, type);</span>
<span class="fc" id="L1221">        market.addGoodsToMarket(type, -marketAmount);</span>
<span class="fc" id="L1222">        return marketAmount;</span>
    }

    /**
     * Sell goods in Europe.
     *
     * @param container An optional &lt;code&gt;GoodsContainer&lt;/code&gt;
     *     carrying the goods.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to sell.
     * @param amount The amount of goods to sell.
     * @return The amount actually added to the market, or negative on failure.
     */
    public int sell(GoodsContainer container, GoodsType type, int amount) {
<span class="fc" id="L1235">        final Market market = getMarket();</span>
<span class="fc" id="L1236">        final int tax = getTax();</span>
<span class="fc" id="L1237">        final int incomeBeforeTaxes = market.getSalePrice(type, amount);</span>
<span class="fc" id="L1238">        final int incomeAfterTaxes = ((100 - tax) * incomeBeforeTaxes) / 100;</span>
        
<span class="fc" id="L1240">        modifyGold(incomeAfterTaxes);</span>
<span class="fc" id="L1241">        market.modifySales(type, amount);</span>
<span class="fc bfc" id="L1242" title="All 2 branches covered.">        if (container != null) container.addGoods(type, -amount);</span>
<span class="fc" id="L1243">        market.modifyIncomeBeforeTaxes(type, incomeBeforeTaxes);</span>
<span class="fc" id="L1244">        market.modifyIncomeAfterTaxes(type, incomeAfterTaxes);</span>
<span class="fc" id="L1245">        int marketAmount = (int)applyModifiers((float)amount,</span>
<span class="fc" id="L1246">            getGame().getTurn(), Modifier.TRADE_BONUS, type);</span>
<span class="fc" id="L1247">        market.addGoodsToMarket(type, marketAmount);</span>
<span class="fc" id="L1248">        return marketAmount;</span>
    }

    /**
     * Adds a player to the list of players for whom the stance has changed.
     *
     * @param other The &lt;code&gt;ServerPlayer&lt;/code&gt; to add.
     */
    public void addStanceChange(ServerPlayer other) {
<span class="fc bfc" id="L1257" title="All 2 branches covered.">        if (!stanceDirty.contains(other)) stanceDirty.add(other);</span>
<span class="fc" id="L1258">    }</span>

    /**
     * Modifies stance.
     *
     * @param stance The new &lt;code&gt;Stance&lt;/code&gt;.
     * @param otherPlayer The &lt;code&gt;Player&lt;/code&gt; wrt which the stance changes.
     * @param symmetric If true, change the otherPlayer stance as well.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if there was a change in stance at all.
     */
    public boolean csChangeStance(Stance stance, ServerPlayer otherPlayer,
                                  boolean symmetric, ChangeSet cs) {
<span class="fc" id="L1271">        ServerPlayer other = otherPlayer;</span>
<span class="fc" id="L1272">        boolean change = false;</span>
<span class="fc" id="L1273">        Stance old = getStance(otherPlayer);</span>

<span class="fc bfc" id="L1275" title="All 2 branches covered.">        if (old != stance) {</span>
<span class="fc" id="L1276">            int modifier = old.getTensionModifier(stance);</span>
<span class="fc" id="L1277">            setStance(otherPlayer, stance);</span>
<span class="fc bfc" id="L1278" title="All 2 branches covered.">            if (modifier != 0) {</span>
<span class="fc" id="L1279">                csModifyTension(otherPlayer, modifier, cs);//+til</span>
            }
<span class="fc" id="L1281">            cs.addHistory(this, new HistoryEvent(getGame().getTurn(),</span>
<span class="fc" id="L1282">                    HistoryEvent.getEventTypeFromStance(stance), otherPlayer)</span>
<span class="fc" id="L1283">                .addStringTemplate(&quot;%nation%&quot;, otherPlayer.getNationLabel()));</span>
<span class="fc" id="L1284">            logger.info(&quot;Stance modification &quot; + getName()</span>
<span class="fc" id="L1285">                + &quot; &quot; + old + &quot; -&gt; &quot; + stance + &quot; wrt &quot; + otherPlayer.getName());</span>
<span class="fc" id="L1286">            this.addStanceChange(other);</span>
<span class="fc bfc" id="L1287" title="All 2 branches covered.">            if (old != Stance.UNCONTACTED) {</span>
<span class="fc" id="L1288">                cs.addMessage(See.only(other),</span>
                    new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="fc" id="L1290">                        stance.getStanceChangeKey(), this)</span>
<span class="fc" id="L1291">                    .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
            }
<span class="fc" id="L1293">            cs.addStance(See.only(this), this, stance, otherPlayer);</span>
<span class="fc" id="L1294">            cs.addStance(See.only(other), this, stance, otherPlayer);</span>
<span class="fc" id="L1295">            change = true;</span>
        }
<span class="fc bfc" id="L1297" title="All 4 branches covered.">        if (symmetric &amp;&amp; (old = otherPlayer.getStance(this)) != stance) {</span>
<span class="fc" id="L1298">            int modifier = old.getTensionModifier(stance);</span>
<span class="fc" id="L1299">            otherPlayer.setStance(this, stance);</span>
<span class="fc bfc" id="L1300" title="All 2 branches covered.">            if (modifier != 0) {</span>
<span class="fc" id="L1301">                other.csModifyTension(this, modifier, cs);//+til</span>
            }
<span class="fc" id="L1303">            cs.addHistory(otherPlayer, new HistoryEvent(getGame().getTurn(),</span>
<span class="fc" id="L1304">                    HistoryEvent.getEventTypeFromStance(stance), this)</span>
<span class="fc" id="L1305">                .addStringTemplate(&quot;%nation%&quot;, this.getNationLabel()));</span>
<span class="fc" id="L1306">            logger.info(&quot;Stance modification &quot; + otherPlayer.getName()</span>
                + &quot; &quot; + old + &quot; -&gt; &quot; + stance
<span class="fc" id="L1308">                + &quot; wrt &quot; + getName() + &quot; (symmetric)&quot;);</span>
<span class="fc" id="L1309">            other.addStanceChange(this);</span>
<span class="fc bfc" id="L1310" title="All 2 branches covered.">            if (old != Stance.UNCONTACTED) {</span>
<span class="fc" id="L1311">                cs.addMessage(See.only(this),</span>
                    new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="fc" id="L1313">                        stance.getStanceChangeKey(), otherPlayer)</span>
<span class="fc" id="L1314">                    .addStringTemplate(&quot;%nation%&quot;, otherPlayer.getNationLabel()));</span>
            }
<span class="fc" id="L1316">            cs.addStance(See.only(this), otherPlayer, stance, this);</span>
<span class="fc" id="L1317">            cs.addStance(See.only(other), otherPlayer, stance, this);</span>
<span class="fc" id="L1318">            change = true;</span>
        }

<span class="fc" id="L1321">        return change;</span>
    }

    /**
     * Modifies the hostility against the given player.
     *
     * +til: Handles tile modifications.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt;.
     * @param add The amount to add to the current tension level.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csModifyTension(Player player, int add, ChangeSet cs) {
<span class="fc" id="L1334">        csModifyTension(player, add, null, cs);</span>
<span class="fc" id="L1335">    }</span>

    /**
     * Modifies the hostility against the given player.
     *
     * +til: Handles tile modifications.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt;.
     * @param add The amount to add to the current tension level.
     * @param origin A &lt;code&gt;Settlement&lt;/code&gt; where the alarming event
     *     occurred.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csModifyTension(Player player, int add, Settlement origin,
                                ChangeSet cs) {
<span class="fc" id="L1350">        Tension.Level oldLevel = getTension(player).getLevel();</span>
<span class="fc" id="L1351">        getTension(player).modify(add);</span>
<span class="fc bfc" id="L1352" title="All 2 branches covered.">        if (oldLevel != getTension(player).getLevel()) {</span>
<span class="fc" id="L1353">            cs.add(See.only((ServerPlayer)player), this);</span>
        }

        // Propagate tension change as settlement alarm to all
        // settlements except the one that originated it (if any).
<span class="fc bfc" id="L1358" title="All 2 branches covered.">        if (isIndian()) {</span>
<span class="fc bfc" id="L1359" title="All 2 branches covered.">            for (IndianSettlement is : getIndianSettlements()) {</span>
<span class="fc bfc" id="L1360" title="All 4 branches covered.">                if (is == origin || !is.hasContacted(player)) continue;</span>
<span class="fc" id="L1361">                ((ServerIndianSettlement)is).csModifyAlarm(player, add,</span>
                                                           false, cs);//+til
<span class="fc" id="L1363">            }</span>
        }
<span class="fc" id="L1365">    }</span>

    /**
     * New turn for this player.
     *
     * @param random A &lt;code&gt;Random&lt;/code&gt; number source.
     * @param lb A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    @Override
    public void csNewTurn(Random random, LogBuilder lb, ChangeSet cs) {
<span class="fc" id="L1376">        lb.add(&quot;PLAYER &quot;, getName(), &quot;: &quot;);</span>

        // Settlements
<span class="fc" id="L1379">        List&lt;Settlement&gt; settlements = new ArrayList&lt;&gt;(getSettlements());</span>
<span class="fc" id="L1380">        int newSoL = 0, newImmigration = getImmigration();</span>
<span class="fc bfc" id="L1381" title="All 2 branches covered.">        for (Settlement settlement : settlements) {</span>
<span class="fc" id="L1382">            ((ServerModelObject)settlement).csNewTurn(random, lb, cs);</span>
<span class="fc" id="L1383">            newSoL += settlement.getSoL();</span>
<span class="fc" id="L1384">        }</span>
<span class="fc" id="L1385">        newImmigration = getImmigration() - newImmigration;</span>

<span class="fc" id="L1387">        int numberOfColonies = settlements.size();</span>
<span class="fc bfc" id="L1388" title="All 2 branches covered.">        if (numberOfColonies &gt; 0) {</span>
<span class="fc" id="L1389">            newSoL = newSoL / numberOfColonies;</span>
<span class="fc bfc" id="L1390" title="All 2 branches covered.">            if (oldSoL / 10 != newSoL / 10) {</span>
<span class="pc bpc" id="L1391" title="1 of 2 branches missed.">                cs.addMessage(See.only(this),</span>
                    new ModelMessage(ModelMessage.MessageType.SONS_OF_LIBERTY,
                                     (newSoL &gt; oldSoL)
                                     ? &quot;model.player.soLIncrease&quot;
                                     : &quot;model.player.soLDecrease&quot;, this)
<span class="fc" id="L1396">                              .addAmount(&quot;%oldSoL%&quot;, oldSoL)</span>
<span class="fc" id="L1397">                              .addAmount(&quot;%newSoL%&quot;, newSoL));</span>
            }
<span class="fc" id="L1399">            oldSoL = newSoL; // Remember SoL for check changes at next turn.</span>
        }

        // Europe.
<span class="fc bfc" id="L1403" title="All 2 branches covered.">        if (europe != null) {</span>
<span class="fc" id="L1404">            ((ServerModelObject) europe).csNewTurn(random, lb, cs);</span>
<span class="fc" id="L1405">            modifyImmigration(europe.getImmigration(newImmigration));</span>
        }
        // Units.
<span class="fc bfc" id="L1408" title="All 2 branches covered.">        for (Unit unit : new ArrayList&lt;&gt;(getUnits())) {</span>
            try {
<span class="fc" id="L1410">                ((ServerModelObject) unit).csNewTurn(random, lb, cs);</span>
<span class="nc" id="L1411">            } catch (ClassCastException e) {</span>
<span class="nc" id="L1412">                logger.log(Level.SEVERE, &quot;Not a ServerUnit: &quot; + unit.getId(), e);</span>
<span class="fc" id="L1413">            }</span>
<span class="fc" id="L1414">        }</span>

<span class="fc bfc" id="L1416" title="All 2 branches covered.">        if (isEuropean()) { // Update liberty and immigration</span>
            // Auto-emigrate if selection not allowed.
<span class="pc bpc" id="L1418" title="1 of 2 branches missed.">            if (hasAbility(Ability.SELECT_RECRUIT)) {</span>
<span class="nc" id="L1419">                cs.addPartial(See.only(this), this, &quot;immigration&quot;);</span>
            } else {
<span class="fc bfc" id="L1421" title="All 2 branches covered.">                while (checkEmigrate()) {</span>
<span class="fc" id="L1422">                    csEmigrate(MigrationType.getUnspecificSlot(),</span>
                               MigrationType.NORMAL, random, cs);
                }
            }
<span class="fc" id="L1426">            cs.addPartial(See.only(this), this, &quot;liberty&quot;);</span>

<span class="pc bpc" id="L1428" title="1 of 2 branches missed.">            if (getSpecification().getBoolean(GameOptions.ENABLE_UPKEEP)) {</span>
<span class="nc" id="L1429">                csPayUpkeep(random, cs);</span>
            }

<span class="fc" id="L1432">            int probability = getSpecification().getInteger(GameOptions.NATURAL_DISASTERS);</span>
<span class="pc bpc" id="L1433" title="1 of 2 branches missed.">            if (probability &gt; 0) {</span>
<span class="nc" id="L1434">                csNaturalDisasters(random, cs, probability);</span>
            }

<span class="pc bpc" id="L1437" title="1 of 2 branches missed.">            if (isRebel() &amp;&amp; interventionBells</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">                &gt;= getSpecification().getInteger(GameOptions.INTERVENTION_BELLS)) {</span>
<span class="nc" id="L1439">                interventionBells = Integer.MIN_VALUE;</span>
                
                // Enter near a port.
<span class="nc" id="L1442">                List&lt;Colony&gt; ports = getPorts();</span>
<span class="nc" id="L1443">                Colony port = getRandomMember(logger, &quot;Intervention port&quot;,</span>
                                              ports, random);
<span class="nc" id="L1445">                Tile portTile = port.getTile();</span>
<span class="nc" id="L1446">                Tile entry = getGame().getMap().searchCircle(portTile,</span>
<span class="nc" id="L1447">                    GoalDeciders.getSimpleHighSeasGoalDecider(),</span>
<span class="nc" id="L1448">                    portTile.getHighSeasCount()+1).getSafeTile(this, random);</span>
                
                // Create the force.
                // @compat 0.10.5
                // We used to nullify the monarch when declaring independence.
                // There are saved games out there where this happened
                // (see BR#2435).  Defend against NPE.
<span class="nc" id="L1455">                Monarch.Force ivf = null;</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">                if (getMonarch() != null</span>
                // end @compat 0.10.5
<span class="nc bnc" id="L1458" title="All 2 branches missed.">                    &amp;&amp; (ivf = getMonarch().getInterventionForce()) != null) {</span>
<span class="nc" id="L1459">                    List&lt;Unit&gt; landUnits = createUnits(ivf.getLandUnits(),</span>
                                                       entry);//-vis(this)
<span class="nc" id="L1461">                    List&lt;Unit&gt; navalUnits = createUnits(ivf.getNavalUnits(),</span>
                                                        entry);//-vis(this)
<span class="nc" id="L1463">                    List&lt;Unit&gt; leftOver = loadShips(landUnits, navalUnits,</span>
                                                    random);//-vis(this)
<span class="nc bnc" id="L1465" title="All 2 branches missed.">                    for (Unit unit : leftOver) {</span>
                        // no use for left over units
<span class="nc" id="L1467">                        logger.warning(&quot;Disposing of left over unit &quot; + unit);</span>
<span class="nc" id="L1468">                        unit.setLocationNoUpdate(null);//-vis: safe, off map</span>
<span class="nc" id="L1469">                        unit.dispose();//-vis: safe, never sighted</span>
<span class="nc" id="L1470">                    }</span>
<span class="nc" id="L1471">                    Set&lt;Tile&gt; tiles = exploreForUnit(navalUnits.get(0));</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">                    if (!tiles.contains(entry)) tiles.add(entry);</span>
<span class="nc" id="L1473">                    invalidateCanSeeTiles();//+vis(this)</span>
<span class="nc" id="L1474">                    cs.add(See.perhaps(), tiles);</span>
<span class="nc" id="L1475">                    cs.addMessage(See.only(this),</span>
                        new ModelMessage(ModelMessage.MessageType.DEFAULT,
                            &quot;model.player.interventionForceArrives&quot;,
                            this));
<span class="nc" id="L1479">                    logger.info(&quot;Intervention force (&quot;</span>
<span class="nc" id="L1480">                        + navalUnits.size() + &quot; naval, &quot;</span>
<span class="nc" id="L1481">                        + landUnits.size() + &quot; land, &quot;</span>
<span class="nc" id="L1482">                        + leftOver.size() + &quot; left over) arrives at &quot; + entry</span>
<span class="nc" id="L1483">                        + &quot;(for &quot; + port.getName() + &quot;)&quot;);</span>
                }
            }
        }

        // Update stances
<span class="fc bfc" id="L1489" title="All 2 branches covered.">        while (!stanceDirty.isEmpty()) {</span>
<span class="fc" id="L1490">            ServerPlayer s = stanceDirty.remove(0);</span>
<span class="fc" id="L1491">            Stance sta = getStance(s);</span>
<span class="pc bpc" id="L1492" title="1 of 2 branches missed.">            boolean war = sta == Stance.WAR;</span>
<span class="pc bpc" id="L1493" title="1 of 2 branches missed.">            if (sta == Stance.UNCONTACTED) continue;</span>
<span class="fc bfc" id="L1494" title="All 2 branches covered.">            for (Player p : getGame().getLiveEuropeanPlayers(this)) {</span>
<span class="fc" id="L1495">                ServerPlayer sp = (ServerPlayer) p;</span>
<span class="pc bpc" id="L1496" title="1 of 4 branches missed.">                if (p == s || !p.hasContacted(this)</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">                    || !p.hasContacted(s)) continue;</span>
<span class="nc bnc" id="L1498" title="All 4 branches missed.">                if (p.hasAbility(Ability.BETTER_FOREIGN_AFFAIRS_REPORT)</span>
                    || war) {
<span class="nc" id="L1500">                    cs.addStance(See.only(sp), this, sta, s);</span>
<span class="nc" id="L1501">                    cs.addMessage(See.only(sp),</span>
                        new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="nc" id="L1503">                            sta.getOtherStanceChangeKey(), this)</span>
<span class="nc" id="L1504">                        .addStringTemplate(&quot;%attacker%&quot;, getNationLabel())</span>
<span class="nc" id="L1505">                        .addStringTemplate(&quot;%defender%&quot;, s.getNationLabel()));</span>
                }
<span class="nc" id="L1507">            }</span>
<span class="fc" id="L1508">        }</span>
<span class="fc" id="L1509">    }</span>

    public void csPayUpkeep(Random random, ChangeSet cs) {
<span class="nc" id="L1512">        final Specification spec = getSpecification();</span>
<span class="nc" id="L1513">        final Disaster bankruptcy = spec.getDisaster(Disaster.BANKRUPTCY);</span>

<span class="nc" id="L1515">        boolean changed = false;</span>
<span class="nc" id="L1516">        int upkeep = getSettlements().stream()</span>
<span class="nc" id="L1517">            .mapToInt(s -&gt; s.getUpkeep()).sum();</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">        if (checkGold(upkeep)) {</span>
<span class="nc" id="L1519">            modifyGold(-upkeep);</span>
<span class="nc bnc" id="L1520" title="All 2 branches missed.">            if (getBankrupt()) {</span>
<span class="nc" id="L1521">                setBankrupt(false);</span>
<span class="nc" id="L1522">                changed = true;</span>
                // the only effects of a disaster that can be reversed
                // are the modifiers
<span class="nc bnc" id="L1525" title="All 2 branches missed.">                for (RandomChoice&lt;Effect&gt; effect: bankruptcy.getEffects()) {</span>
<span class="nc bnc" id="L1526" title="All 2 branches missed.">                    for (Modifier modifier : effect.getObject().getModifiers()) {</span>
<span class="nc" id="L1527">                        cs.addFeatureChange(this, this, modifier, false);</span>
<span class="nc" id="L1528">                    }</span>
<span class="nc" id="L1529">                }</span>
<span class="nc" id="L1530">                cs.addMessage(See.only(this),</span>
                    new ModelMessage(ModelMessage.MessageType.GOVERNMENT_EFFICIENCY,
                                     &quot;model.player.disaster.bankruptcy.stop&quot;, this));
            }
        } else {
<span class="nc" id="L1535">            modifyGold(-getGold());</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">            if (!getBankrupt()) {</span>
<span class="nc" id="L1537">                setBankrupt(true);</span>
<span class="nc" id="L1538">                changed = true;</span>
<span class="nc" id="L1539">                csApplyDisaster(random, null, bankruptcy, cs);</span>
<span class="nc" id="L1540">                cs.addMessage(See.only(this),</span>
                    new ModelMessage(ModelMessage.MessageType.GOVERNMENT_EFFICIENCY,
                                     &quot;model.player.disaster.bankruptcy.start&quot;, this));
            }
        }
<span class="nc bnc" id="L1545" title="All 2 branches missed.">        if (upkeep &gt; 0) cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">        if (changed) cs.addPartial(See.only(this), this, &quot;bankrupt&quot;);</span>
<span class="nc" id="L1547">    }</span>

    public void csNaturalDisasters(Random random, ChangeSet cs,
                                   int probability) {
<span class="nc bnc" id="L1551" title="All 2 branches missed.">        if (randomInt(logger, &quot;Natural disaster&quot;, random, 100) &lt; probability) {</span>
<span class="nc" id="L1552">            int size = getNumberOfSettlements();</span>
<span class="nc bnc" id="L1553" title="All 2 branches missed.">            if (size &lt; 1) return;</span>
            // randomly select a colony to start with, then generate
            // an appropriate disaster if possible, else continue with
            // the next colony
<span class="nc" id="L1557">            int start = randomInt(logger, &quot;select colony&quot;, random, size);</span>
<span class="nc bnc" id="L1558" title="All 2 branches missed.">            for (int index = 0; index &lt; size; index++) {</span>
<span class="nc" id="L1559">                Colony colony = getColonies().get((start + index) % size);</span>
<span class="nc" id="L1560">                List&lt;RandomChoice&lt;Disaster&gt;&gt; disasters = colony.getDisasters();</span>
<span class="nc bnc" id="L1561" title="All 2 branches missed.">                if (!disasters.isEmpty()) {</span>
<span class="nc" id="L1562">                    Disaster disaster = RandomChoice</span>
<span class="nc" id="L1563">                        .getWeightedRandom(logger, &quot;select disaster&quot;, disasters,</span>
                                           random);
<span class="nc" id="L1565">                    List&lt;ModelMessage&gt; messages = csApplyDisaster(random,</span>
                        colony, disaster, cs);
<span class="nc bnc" id="L1567" title="All 2 branches missed.">                    if (!messages.isEmpty()) {</span>
<span class="nc" id="L1568">                        cs.addMessage(See.only(this),</span>
                                      new ModelMessage(ModelMessage.MessageType.DEFAULT,
                                                       &quot;model.player.disaster.strikes&quot;, colony)
<span class="nc" id="L1571">                                      .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L1572">                                      .addName(&quot;%disaster%&quot;, disaster));</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">                        for (ModelMessage message : messages) {</span>
<span class="nc" id="L1574">                            cs.addMessage(See.only(this), message);</span>
<span class="nc" id="L1575">                        }</span>
<span class="nc" id="L1576">                        return;</span>
                    }
                }
            }
        }
<span class="nc" id="L1581">    }</span>

    /**
     * Apply the effects of the given &lt;code&gt;Disaster&lt;/code&gt; to the
     * given &lt;code&gt;Colony&lt;/code&gt;, or the &lt;code&gt;Player&lt;/code&gt; if the
     * &lt;code&gt;Colony&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;, and return a list of
     * appropriate &lt;code&gt;ModelMessage&lt;/code&gt;s. Note that a disaster
     * might have no effect on a particular colony. In that case, the
     * returned list is empty.
     *
     * @param random A &lt;code&gt;Random&lt;/code&gt; number source.
     * @param colony A &lt;code&gt;Colony&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt;.
     * @param disaster A &lt;code&gt;Disaster&lt;/code&gt; value.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return A list of &lt;code&gt;ModelMessage&lt;/code&gt;s, possibly empty.
     */
    public List&lt;ModelMessage&gt; csApplyDisaster(Random random, Colony colony,
                                              Disaster disaster, ChangeSet cs) {
<span class="nc" id="L1599">        StringBuilder sb = new StringBuilder(64);</span>
<span class="nc" id="L1600">        sb.append(&quot;Applying &quot;).append(disaster.getNumberOfEffects())</span>
<span class="nc" id="L1601">            .append(&quot; effect/s of disaster &quot;)</span>
<span class="nc" id="L1602">            .append(Messages.getName(disaster));</span>
<span class="nc bnc" id="L1603" title="All 2 branches missed.">        if (colony != null) sb.append(&quot; to &quot;).append(colony.getName());</span>
<span class="nc" id="L1604">        sb.append(&quot;:&quot;);</span>
<span class="nc" id="L1605">        List&lt;Effect&gt; effects = new ArrayList&lt;&gt;();</span>
<span class="pc bnc" id="L1606" title="All 4 branches missed.">        switch (disaster.getNumberOfEffects()) {</span>
        case ONE:
<span class="nc" id="L1608">            effects.add(RandomChoice.getWeightedRandom(logger,</span>
<span class="nc" id="L1609">                    &quot;Get effect of disaster&quot;, disaster.getEffects(), random));</span>
<span class="nc" id="L1610">            sb.append(&quot; &quot;).append(Messages.getName(effects.get(0)));</span>
<span class="nc" id="L1611">            break;</span>
        case SEVERAL:
<span class="nc bnc" id="L1613" title="All 2 branches missed.">            for (RandomChoice&lt;Effect&gt; effect : disaster.getEffects()) {</span>
<span class="nc" id="L1614">                if (randomInt(logger, &quot;Get effects of disaster&quot;, random, 100)</span>
<span class="nc bnc" id="L1615" title="All 2 branches missed.">                    &lt; effect.getProbability()) {</span>
<span class="nc" id="L1616">                    effects.add(effect.getObject());</span>
<span class="nc" id="L1617">                    sb.append(&quot; &quot;).append(Messages.getName(effect.getObject()));</span>
                }
<span class="nc" id="L1619">            }</span>
<span class="nc" id="L1620">            break;</span>
        case ALL:
<span class="nc bnc" id="L1622" title="All 2 branches missed.">            for (RandomChoice&lt;Effect&gt; effect : disaster.getEffects()) {</span>
<span class="nc" id="L1623">                effects.add(effect.getObject());</span>
<span class="nc" id="L1624">                sb.append(&quot; &quot;).append(Messages.getName(effect.getObject()));</span>
<span class="nc" id="L1625">            }</span>
        }
<span class="nc bnc" id="L1627" title="All 2 branches missed.">        if (effects.isEmpty()) sb.append(&quot; All avoided&quot;);</span>
<span class="nc" id="L1628">        logger.fine(sb.toString());</span>

<span class="nc" id="L1630">        boolean colonyDirty = false;</span>
<span class="nc" id="L1631">        List&lt;ModelMessage&gt; messages = new ArrayList&lt;&gt;();</span>
        OUTER:
<span class="nc bnc" id="L1633" title="All 2 branches missed.">        for (Effect effect : effects) {</span>
<span class="nc bnc" id="L1634" title="All 2 branches missed.">            if (colony == null) {</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">                for (Modifier modifier : effect.getModifiers()) {</span>
<span class="nc bnc" id="L1636" title="All 2 branches missed.">                    if (modifier.getDuration() &gt; 0) {</span>
<span class="nc" id="L1637">                        Modifier timedModifier = Modifier</span>
<span class="nc" id="L1638">                            .makeTimedModifier(modifier.getId(), modifier, getGame().getTurn());</span>
<span class="nc" id="L1639">                        modifier.setModifierIndex(Modifier.DISASTER_PRODUCTION_INDEX);</span>
<span class="nc" id="L1640">                        cs.addFeatureChange(this, this, timedModifier, true);</span>
<span class="nc" id="L1641">                    } else {</span>
<span class="nc" id="L1642">                        cs.addFeatureChange(this, this, modifier, true);</span>
                    }
<span class="nc" id="L1644">                }</span>
            } else {
<span class="nc bnc" id="L1646" title="All 2 branches missed.">                if (null != effect.getId()) {</span>
<span class="nc bnc" id="L1647" title="All 22 branches missed.">                    switch (effect.getId()) {</span>
                    case Effect.LOSS_OF_MONEY:
<span class="nc" id="L1649">                        int plunder = Math.max(1, colony.getPlunder(null, random) / 5);</span>
<span class="nc" id="L1650">                        modifyGold(-plunder);</span>
<span class="nc" id="L1651">                        cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc" id="L1652">                        messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1653">                                effect.getId(), this)</span>
<span class="nc" id="L1654">                            .addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="nc" id="L1655">                        break;</span>
                    case Effect.LOSS_OF_BUILDING:
<span class="nc" id="L1657">                        Building building = getBuildingForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1658" title="All 2 branches missed.">                        if (building != null) {</span>
                            // Add message before damaging building
<span class="nc" id="L1660">                            messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1661">                                    effect.getId(), colony)</span>
<span class="nc" id="L1662">                                .addNamed(&quot;%building%&quot;, building.getType()));</span>
<span class="nc" id="L1663">                            csDamageBuilding(building, cs);</span>
<span class="nc" id="L1664">                            colonyDirty = true;</span>
                        }
                        break;
                    case Effect.LOSS_OF_GOODS:
<span class="nc" id="L1668">                        Goods goods = getRandomMember(logger, &quot;select goods&quot;,</span>
<span class="nc" id="L1669">                            colony.getLootableGoodsList(),</span>
                            random);
<span class="nc bnc" id="L1671" title="All 2 branches missed.">                        if (goods != null) {</span>
<span class="nc" id="L1672">                            goods.setAmount(Math.min(goods.getAmount() / 2, 50));</span>
<span class="nc" id="L1673">                            colony.removeGoods(goods);</span>
<span class="nc" id="L1674">                            messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1675">                                    effect.getId(), colony)</span>
<span class="nc" id="L1676">                                .addStringTemplate(&quot;%goods%&quot;, goods.getLabel(true)));</span>
<span class="nc" id="L1677">                            colonyDirty = true;</span>
                        }
                        break;
                    case Effect.LOSS_OF_UNIT:
                        {
<span class="nc" id="L1682">                            Unit unit = getUnitForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1683" title="All 2 branches missed.">                            if (unit != null) {</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">                                if (colony.getUnitCount() == 1) {</span>
<span class="nc" id="L1685">                                    messages.clear();</span>
<span class="nc" id="L1686">                                    messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
                                            &quot;model.player.disaster.effect.colonyDestroyed&quot;, this)
<span class="nc" id="L1688">                                        .addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="nc" id="L1689">                                    csDisposeSettlement(colony, cs);</span>
<span class="nc" id="L1690">                                    colonyDirty = false;</span>
<span class="nc" id="L1691">                                    break OUTER; // No point proceeding</span>
                                }
<span class="nc" id="L1693">                                messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1694">                                        effect.getId(), colony)</span>
<span class="nc" id="L1695">                                    .addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L1696">                                cs.addRemove(See.only(this), null, unit);</span>
<span class="nc" id="L1697">                                unit.dispose();//-vis: Safe, entirely within colony</span>
<span class="nc" id="L1698">                                colonyDirty = true;</span>
                            }
                            break;
                        }
                    case Effect.DAMAGED_UNIT:
                        {
<span class="nc" id="L1704">                            Unit unit = getUnitForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1705" title="All 4 branches missed.">                            if (unit != null &amp;&amp; unit.isNaval()) {</span>
<span class="nc" id="L1706">                                Location repairLocation = unit.getRepairLocation();</span>
<span class="nc bnc" id="L1707" title="All 2 branches missed.">                                if (repairLocation == null) {</span>
<span class="nc" id="L1708">                                    messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1709">                                            effect.getId(), colony)</span>
<span class="nc" id="L1710">                                        .addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L1711">                                    csSinkShip(unit, null, cs);</span>
                                } else {
<span class="nc" id="L1713">                                    messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1714">                                            effect.getId(), colony)</span>
<span class="nc" id="L1715">                                        .addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L1716">                                    csDamageShip(unit, repairLocation, cs);</span>
                                }
<span class="nc" id="L1718">                                colonyDirty = true;</span>
<span class="nc" id="L1719">                            }</span>
                            break;
                        }
                    default:
<span class="nc" id="L1723">                        messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1724">                                effect.getId(), colony));</span>
<span class="nc bnc" id="L1725" title="All 2 branches missed.">                        for (Modifier modifier : effect.getModifiers()) {</span>
<span class="nc bnc" id="L1726" title="All 2 branches missed.">                            if (modifier.getDuration() &gt; 0) {</span>
<span class="nc" id="L1727">                                Modifier timedModifier = Modifier</span>
<span class="nc" id="L1728">                                    .makeTimedModifier(modifier.getId(), modifier, getGame().getTurn());</span>
<span class="nc" id="L1729">                                timedModifier.setModifierIndex(Modifier.DISASTER_PRODUCTION_INDEX);</span>
<span class="nc" id="L1730">                                cs.addFeatureChange(this, colony, timedModifier, true);</span>
<span class="nc" id="L1731">                            } else {</span>
<span class="nc" id="L1732">                                cs.addFeatureChange(this, colony, modifier, true);</span>
                            }
<span class="nc" id="L1734">                            colonyDirty = true;</span>
<span class="nc" id="L1735">                        }</span>
                        break;
                    }
                }
            }
<span class="nc" id="L1740">        }</span>
<span class="nc bnc" id="L1741" title="All 2 branches missed.">        if (colonyDirty) cs.add(See.perhaps(), colony);</span>
<span class="nc" id="L1742">        return messages;</span>
    }

    public Building getBuildingForEffect(Colony colony, Effect effect, Random random) {
<span class="nc" id="L1746">        List&lt;Building&gt; buildings = colony.getBurnableBuildings();</span>
<span class="nc bnc" id="L1747" title="All 2 branches missed.">        if (buildings.isEmpty()) return null;</span>
<span class="nc" id="L1748">        return getRandomMember(logger, &quot;Select building for effect&quot;,</span>
                               buildings, random);
    }

    public Unit getUnitForEffect(Colony colony, Effect effect, Random random) {
<span class="nc" id="L1753">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1754" title="All 2 branches missed.">        for (Unit unit : colony.getUnitList()) {</span>
<span class="nc bnc" id="L1755" title="All 2 branches missed.">            if (effect.appliesTo(unit.getType())) {</span>
<span class="nc" id="L1756">                units.add(unit);</span>
            }
<span class="nc" id="L1758">        }</span>
<span class="nc bnc" id="L1759" title="All 2 branches missed.">        for (Unit unit : colony.getTile().getUnitList()) {</span>
<span class="nc bnc" id="L1760" title="All 2 branches missed.">            if (effect.appliesTo(unit.getType())) {</span>
<span class="nc" id="L1761">                units.add(unit);</span>
            }
<span class="nc" id="L1763">        }</span>
<span class="nc bnc" id="L1764" title="All 2 branches missed.">        if (units.isEmpty()) return null;</span>
<span class="nc" id="L1765">        return getRandomMember(logger, &quot;Select unit for effect&quot;, units, random);</span>
    }

    /**
     * Propagate an European market trade to the other European markets.
     *
     * @param type The type of goods that was traded.
     * @param amount The amount of goods that was traded.
     * @param random A pseudo-random number source.
     */
    public void propagateToEuropeanMarkets(GoodsType type, int amount,
                                           Random random) {
<span class="pc bpc" id="L1777" title="1 of 2 branches missed.">        if (!type.isStorable()) return;</span>

        // Propagate 5-30% of the original change.
<span class="fc" id="L1780">        final int lowerBound = 5; // FIXME: to spec</span>
<span class="fc" id="L1781">        final int upperBound = 30;// FIXME: to spec</span>
<span class="fc" id="L1782">        amount *= randomInt(logger, &quot;Propagate goods&quot;, random,</span>
                            upperBound - lowerBound + 1) + lowerBound;
<span class="fc" id="L1784">        amount /= 100;</span>
<span class="fc bfc" id="L1785" title="All 2 branches covered.">        if (amount == 0) return;</span>

        // Do not need to update the clients here, these changes happen
        // while it is not their turn.
<span class="fc bfc" id="L1789" title="All 2 branches covered.">        for (Player p : getGame().getLiveEuropeanPlayers(this)) {</span>
<span class="fc" id="L1790">            Market market = p.getMarket();</span>
<span class="pc bpc" id="L1791" title="1 of 2 branches missed.">            if (market != null) market.addGoodsToMarket(type, amount);</span>
<span class="fc" id="L1792">        }</span>
<span class="fc" id="L1793">    }</span>

    /**
     * Add or remove a standard yearly amount of storable goods, and a
     * random extra amount of a random type.  Then push out all the
     * accumulated trades.
     *
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csYearlyGoodsAdjust(Random random, ChangeSet cs) {
<span class="fc" id="L1804">        final Game game = getGame();</span>
<span class="fc" id="L1805">        final List&lt;GoodsType&gt; goodsTypes = game.getSpecification()</span>
<span class="fc" id="L1806">            .getStorableGoodsTypeList();</span>
<span class="fc" id="L1807">        final Market market = getMarket();</span>

        // Pick a random type of storable goods to add/remove an extra
        // amount of.
        GoodsType extraType;
<span class="fc" id="L1812">        while (!(extraType = getRandomMember(logger, &quot;Choose goods type&quot;,</span>
<span class="pc bpc" id="L1813" title="1 of 2 branches missed.">                                             goodsTypes, random)).isStorable());</span>

        // Remove standard amount, and the extra amount.
<span class="fc bfc" id="L1816" title="All 2 branches covered.">        for (GoodsType type : goodsTypes) {</span>
<span class="fc bfc" id="L1817" title="All 2 branches covered.">            if (market.hasBeenTraded(type)) {</span>
<span class="fc" id="L1818">                boolean add = market.getAmountInMarket(type)</span>
<span class="fc bfc" id="L1819" title="All 2 branches covered.">                    &lt; type.getInitialAmount();</span>
<span class="fc" id="L1820">                int amount = game.getTurn().getNumber() / 10;</span>
<span class="fc bfc" id="L1821" title="All 2 branches covered.">                if (type == extraType) amount = 2 * amount + 1;</span>
<span class="pc bpc" id="L1822" title="1 of 2 branches missed.">                if (amount &lt;= 0) continue;</span>
<span class="fc" id="L1823">                amount = randomInt(logger, &quot;Market adjust &quot; + type,</span>
                                   random, amount);
<span class="fc bfc" id="L1825" title="All 2 branches covered.">                if (!add) amount = -amount;</span>
<span class="fc" id="L1826">                market.addGoodsToMarket(type, amount);</span>
<span class="fc" id="L1827">                logger.finest(getName() + &quot; adjust of &quot; + amount</span>
                              + &quot; &quot; + type
<span class="fc" id="L1829">                              + &quot;, total: &quot; + market.getAmountInMarket(type)</span>
<span class="fc" id="L1830">                              + &quot;, initial: &quot; + type.getInitialAmount());</span>
<span class="fc" id="L1831">                addExtraTrade(new AbstractGoods(type, amount));</span>
            }
<span class="fc" id="L1833">        }</span>

<span class="fc" id="L1835">        flushExtraTrades(random);</span>
<span class="fc" id="L1836">        csFlushMarket(cs);</span>
<span class="fc" id="L1837">    }</span>

    /**
     * Starts a new turn for a player.
     *
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csStartTurn(Random random, ChangeSet cs) {
<span class="nc" id="L1846">        Game game = getGame();</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">        if (isEuropean()) {</span>
<span class="nc" id="L1848">            csBombardEnemyShips(random, cs);</span>

<span class="nc" id="L1850">            csYearlyGoodsAdjust(random, cs);</span>

<span class="nc" id="L1852">            FoundingFather father = checkFoundingFather();</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">            if (father != null) {</span>
<span class="nc" id="L1854">                csAddFoundingFather(father, random, cs);</span>
<span class="nc" id="L1855">                clearOfferedFathers();</span>
            }

<span class="nc" id="L1858">            List&lt;FoundingFather&gt; ffs = getOfferedFathers();</span>
<span class="nc bnc" id="L1859" title="All 4 branches missed.">            if (canRecruitFoundingFather() &amp;&amp; ffs.isEmpty()) {</span>
<span class="nc" id="L1860">                ffs = getRandomFoundingFathers(random);</span>
<span class="nc" id="L1861">                setOfferedFathers(ffs);</span>
            }
<span class="nc bnc" id="L1863" title="All 2 branches missed.">            if (!ffs.isEmpty()) {</span>
<span class="nc" id="L1864">                cs.add(See.only(this), ChangePriority.CHANGE_EARLY,</span>
                    new ChooseFoundingFatherMessage(ffs, null));
            }

<span class="nc bnc" id="L1868" title="All 2 branches missed.">            if (updateScore()) {</span>
<span class="nc" id="L1869">                cs.addPartial(See.only(this), this, &quot;score&quot;);</span>
            }

<span class="nc bnc" id="L1872" title="All 2 branches missed.">        } else if (isIndian()) {</span>
            // We do not have to worry about Player level stance
            // changes driving Stance, as that is delegated to the AI.
            //
            // However we want to notify of individual settlements
            // that change tension level, but there are complex
            // interactions between settlement and player tensions.
            // The simple way to do it is just to save all old tension
            // levels and check if they have changed after applying
            // all the changes.
<span class="nc" id="L1882">            List&lt;IndianSettlement&gt; allSettlements = getIndianSettlements();</span>
            java.util.Map&lt;IndianSettlement,
<span class="nc" id="L1884">                java.util.Map&lt;Player, Tension.Level&gt;&gt; oldLevels = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1885" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L1886">                java.util.Map&lt;Player, Tension.Level&gt; oldLevel = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1887">                oldLevels.put(settlement, oldLevel);</span>
<span class="nc bnc" id="L1888" title="All 2 branches missed.">                for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc" id="L1889">                    Tension alarm = settlement.getAlarm(enemy);</span>
<span class="nc bnc" id="L1890" title="All 2 branches missed.">                    oldLevel.put(enemy,</span>
<span class="nc" id="L1891">                        (alarm == null) ? null : alarm.getLevel());</span>
<span class="nc" id="L1892">                }</span>
<span class="nc" id="L1893">            }</span>

            // Do the settlement alarms first.
<span class="nc bnc" id="L1896" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L1897">                java.util.Map&lt;Player, Integer&gt; extra = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1898" title="All 2 branches missed.">                for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc" id="L1899">                    extra.put(enemy, 0);</span>
<span class="nc" id="L1900">                }</span>

                // Look at the uses of tiles surrounding the settlement.
<span class="nc" id="L1903">                int alarmRadius = settlement.getRadius() + ALARM_RADIUS;</span>
<span class="nc bnc" id="L1904" title="All 2 branches missed.">                for (Tile tile: settlement.getTile()</span>
<span class="nc" id="L1905">                         .getSurroundingTiles(alarmRadius)) {</span>
<span class="nc" id="L1906">                    Colony colony = tile.getColony();</span>
<span class="nc bnc" id="L1907" title="All 2 branches missed.">                    if (tile.getFirstUnit() != null) { // Military units</span>
<span class="nc" id="L1908">                        Player enemy =  tile.getFirstUnit().getOwner();</span>
<span class="nc bnc" id="L1909" title="All 2 branches missed.">                        if (enemy.isEuropean()) {</span>
<span class="nc" id="L1910">                            Integer alarm = extra.get(enemy);</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">                            if (alarm == null) continue;</span>
<span class="nc" id="L1912">                            alarm += (int)tile.getUnitList().stream()</span>
<span class="nc bnc" id="L1913" title="All 4 branches missed.">                                .filter(u -&gt; u.isOffensiveUnit() &amp;&amp; !u.isNaval())</span>
<span class="nc" id="L1914">                                .mapToDouble(u -&gt; u.getType().getOffence()).sum();</span>
<span class="nc" id="L1915">                            extra.put(enemy, alarm);</span>
                        }
<span class="nc bnc" id="L1917" title="All 2 branches missed.">                    } else if (colony != null) { // Colonies</span>
<span class="nc" id="L1918">                        Player enemy = colony.getOwner();</span>
<span class="nc" id="L1919">                        extra.put(enemy, extra.get(enemy)</span>
                                  + ALARM_TILE_IN_USE
<span class="nc" id="L1921">                                  + colony.getUnitCount());</span>
<span class="nc bnc" id="L1922" title="All 2 branches missed.">                    } else if (tile.getOwningSettlement() != null) { // Control</span>
<span class="nc" id="L1923">                        Player enemy = tile.getOwningSettlement().getOwner();</span>
<span class="nc bnc" id="L1924" title="All 4 branches missed.">                        if (enemy != null &amp;&amp; enemy.isEuropean()) {</span>
<span class="nc" id="L1925">                            extra.put(enemy, extra.get(enemy)</span>
                                      + ALARM_TILE_IN_USE);
                        }
                    }
<span class="nc" id="L1929">                }</span>
                // Missionary helps reducing alarm a bit
<span class="nc bnc" id="L1931" title="All 2 branches missed.">                if (settlement.hasMissionary()) {</span>
<span class="nc" id="L1932">                    Unit missionary = settlement.getMissionary();</span>
<span class="nc" id="L1933">                    int missionAlarm = getGame().getSpecification()</span>
<span class="nc" id="L1934">                        .getInteger(GameOptions.MISSION_INFLUENCE);</span>
<span class="nc bnc" id="L1935" title="All 2 branches missed.">                    if (missionary.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L1936">                        missionAlarm *= 2;</span>
                    }
<span class="nc" id="L1938">                    Player enemy = missionary.getOwner();</span>
<span class="nc" id="L1939">                    extra.put(enemy,</span>
<span class="nc" id="L1940">                              extra.get(enemy) + missionAlarm);</span>
                }
                // Apply modifiers, and commit the total change.
<span class="nc bnc" id="L1943" title="All 2 branches missed.">                for (Entry&lt;Player, Integer&gt; entry : extra.entrySet()) {</span>
<span class="nc" id="L1944">                    Player player = entry.getKey();</span>
<span class="nc" id="L1945">                    int change = entry.getValue();</span>
<span class="nc bnc" id="L1946" title="All 2 branches missed.">                    if (change != 0) {</span>
<span class="nc" id="L1947">                        change = (int)player.applyModifiers((float)change,</span>
<span class="nc" id="L1948">                            game.getTurn(), Modifier.NATIVE_ALARM_MODIFIER);</span>
<span class="nc" id="L1949">                        ServerIndianSettlement sis</span>
                            = (ServerIndianSettlement)settlement;
<span class="nc" id="L1951">                        sis.csModifyAlarm(player, change,</span>
                                          true, cs);//+til
                    }
<span class="nc" id="L1954">                }</span>
<span class="nc" id="L1955">            }</span>

            // Calm down a bit at the whole-tribe level.
<span class="nc bnc" id="L1958" title="All 2 branches missed.">            for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc bnc" id="L1959" title="All 2 branches missed.">                if (getTension(enemy).getValue() &gt; 0) {</span>
<span class="nc" id="L1960">                    int change = -getTension(enemy).getValue()/100 - 4;</span>
<span class="nc" id="L1961">                    csModifyTension(enemy, change, cs);//+til</span>
                }
<span class="nc" id="L1963">            }</span>

            // Now collect the settlements that changed.
            // Update those that changed, and add messages for selected
            // worsening relation transitions.
<span class="nc bnc" id="L1968" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L1969">                java.util.Map&lt;Player, Tension.Level&gt; oldLevel</span>
<span class="nc" id="L1970">                    = oldLevels.get(settlement);</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                for (Entry&lt;Player, Tension.Level&gt; entry : oldLevel.entrySet()) {</span>
<span class="nc" id="L1972">                    Player enemy = entry.getKey();</span>
<span class="nc" id="L1973">                    Tension newTension = settlement.getAlarm(enemy);</span>
<span class="nc bnc" id="L1974" title="All 2 branches missed.">                    Tension.Level newLevel = (newTension == null) ? null</span>
<span class="nc" id="L1975">                        : newTension.getLevel();</span>
<span class="nc bnc" id="L1976" title="All 2 branches missed.">                    if (entry.getValue() == null</span>
<span class="nc bnc" id="L1977" title="All 2 branches missed.">                        || entry.getValue() == newLevel</span>
<span class="nc bnc" id="L1978" title="All 2 branches missed.">                        || !settlement.hasContacted(enemy)</span>
<span class="nc bnc" id="L1979" title="All 2 branches missed.">                        || !enemy.hasExplored(settlement.getTile()))</span>
<span class="nc" id="L1980">                        continue;</span>
<span class="nc" id="L1981">                    cs.add(See.only(null).perhaps((ServerPlayer)enemy),</span>
                           settlement);
                    // No messages about improving tension
<span class="nc bnc" id="L1984" title="All 2 branches missed.">                    if (newLevel == null</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">                        || (entry.getValue() != null </span>
<span class="nc" id="L1986">                            &amp;&amp; entry.getValue().getLimit()</span>
<span class="nc bnc" id="L1987" title="All 2 branches missed.">                            &gt; newLevel.getLimit())) continue;</span>
<span class="nc" id="L1988">                    String key = &quot;model.player.alarmIncrease.&quot;</span>
<span class="nc" id="L1989">                        + settlement.getAlarm(enemy).getKey();</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">                    if (!Messages.containsKey(key)) continue;</span>
<span class="nc" id="L1991">                    cs.addMessage(See.only((ServerPlayer)enemy),</span>
                        new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                                         key, settlement)
<span class="nc" id="L1994">                            .addStringTemplate(&quot;%nation%&quot;, getNationLabel())</span>
<span class="nc" id="L1995">                            .addStringTemplate(&quot;%enemy%&quot;, enemy.getNationLabel())</span>
<span class="nc" id="L1996">                            .addName(&quot;%settlement%&quot;, settlement.getName()));</span>
<span class="nc" id="L1997">                }</span>
<span class="nc" id="L1998">            }</span>

<span class="nc bnc" id="L2000" title="All 2 branches missed.">            for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L2001">                ((ServerIndianSettlement)settlement).csStartTurn(random, cs);</span>
<span class="nc" id="L2002">            }</span>
        }
<span class="nc" id="L2004">    }</span>

    /**
     * All player colonies bombard all available targets.
     *
     * @param random A random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csBombardEnemyShips(Random random, ChangeSet cs) {
<span class="nc bnc" id="L2013" title="All 2 branches missed.">        for (Colony colony : getColonies()) {</span>
<span class="nc bnc" id="L2014" title="All 2 branches missed.">            if (colony.canBombardEnemyShip()) {</span>
<span class="nc bnc" id="L2015" title="All 2 branches missed.">                for (Tile tile : colony.getTile().getSurroundingTiles(1)) {</span>
<span class="nc bnc" id="L2016" title="All 4 branches missed.">                    if (!tile.isLand() &amp;&amp; tile.getFirstUnit() != null</span>
<span class="nc bnc" id="L2017" title="All 2 branches missed.">                        &amp;&amp; tile.getFirstUnit().getOwner() != this) {</span>
<span class="nc bnc" id="L2018" title="All 2 branches missed.">                        for (Unit unit : tile.getUnitList()) {</span>
<span class="nc bnc" id="L2019" title="All 2 branches missed.">                            if (atWarWith(unit.getOwner())</span>
<span class="nc bnc" id="L2020" title="All 2 branches missed.">                                || unit.hasAbility(Ability.PIRACY)) {</span>
<span class="nc" id="L2021">                                csCombat(colony, unit, null, random, cs);</span>
                            }
<span class="nc" id="L2023">                        }</span>
                    }
<span class="nc" id="L2025">                }</span>
            }
<span class="nc" id="L2027">        }</span>
<span class="nc" id="L2028">    }</span>

    /**
     * Adds a founding father to a players continental congress.
     *
     * @param father The &lt;code&gt;FoundingFather&lt;/code&gt; to add.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csAddFoundingFather(FoundingFather father, Random random,
                                    ChangeSet cs) {
<span class="fc" id="L2039">        final Game game = getGame();</span>
<span class="fc" id="L2040">        final Specification spec = game.getSpecification();</span>
<span class="fc" id="L2041">        final ServerEurope europe = (ServerEurope)getEurope();</span>
<span class="fc" id="L2042">        final Turn turn = game.getTurn();</span>
<span class="fc" id="L2043">        boolean europeDirty = false, visibilityChange = false;</span>

        // FIXME: We do not want to have to update the whole player
        // just to get the FF into the client.  Use this hack until
        // the client gets proper containers.
<span class="fc" id="L2048">        cs.addFather(this, father);</span>
<span class="fc" id="L2049">        cs.addMessage(See.only(this),</span>
            new ModelMessage(ModelMessage.MessageType.SONS_OF_LIBERTY,
                             &quot;model.player.foundingFatherJoinedCongress&quot;,
                             this)
<span class="fc" id="L2053">                      .addNamed(&quot;%foundingFather%&quot;, father)</span>
<span class="fc" id="L2054">                      .add(&quot;%description%&quot;, father.getDescriptionKey()));</span>
<span class="fc" id="L2055">        cs.addHistory(this,</span>
            new HistoryEvent(turn,
                HistoryEvent.HistoryEventType.FOUNDING_FATHER, this)
<span class="fc" id="L2058">                    .addNamed(&quot;%father%&quot;, father));</span>

<span class="fc" id="L2060">        List&lt;AbstractUnit&gt; units = father.getUnits();</span>
<span class="pc bpc" id="L2061" title="2 of 6 branches missed.">        if (units != null &amp;&amp; !units.isEmpty() &amp;&amp; europe != null) {</span>
<span class="fc" id="L2062">            createUnits(father.getUnits(), europe);//-vis: safe, Europe</span>
<span class="fc" id="L2063">            europeDirty = true;</span>
        }

<span class="fc" id="L2066">        java.util.Map&lt;UnitType, UnitType&gt; upgrades = father.getUpgrades();</span>
<span class="pc bpc" id="L2067" title="1 of 2 branches missed.">        if (upgrades != null) {</span>
<span class="fc bfc" id="L2068" title="All 2 branches covered.">            for (Unit u : getUnits()) {</span>
<span class="fc" id="L2069">                UnitType newType = upgrades.get(u.getType());</span>
<span class="fc bfc" id="L2070" title="All 2 branches covered.">                if (newType != null) {</span>
<span class="fc" id="L2071">                    u.changeType(newType);//-vis(this)</span>
<span class="fc" id="L2072">                    visibilityChange = true;</span>
<span class="fc" id="L2073">                    cs.add(See.perhaps(), u);</span>
                }
<span class="fc" id="L2075">            }</span>
        }

<span class="fc bfc" id="L2078" title="All 2 branches covered.">        if (!father.getModifiers().isEmpty()) {</span>
<span class="fc" id="L2079">            cs.add(See.only(this), this);</span>
            // Some modifiers are special
<span class="pc bpc" id="L2081" title="1 of 2 branches missed.">            if (father.hasModifier(Modifier.LINE_OF_SIGHT_BONUS)) {</span>
<span class="nc" id="L2082">                List&lt;Tile&gt; tiles = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2083" title="All 2 branches missed.">                for (Colony c : getColonies()) {</span>
<span class="nc" id="L2084">                    tiles.addAll(exploreForSettlement(c));</span>
<span class="nc" id="L2085">                }</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">                for (Unit u : getUnits()) tiles.addAll(exploreForUnit(u));</span>
<span class="nc bnc" id="L2087" title="All 2 branches missed.">                if (hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
<span class="nc bnc" id="L2088" title="All 2 branches missed.">                    for (Player other : getGame().getLiveEuropeanPlayers(this)) {</span>
<span class="nc bnc" id="L2089" title="All 2 branches missed.">                        for (Colony c : other.getColonies()) {</span>
<span class="nc" id="L2090">                            tiles.addAll(exploreForSettlement(c));</span>
<span class="nc" id="L2091">                        }</span>
<span class="nc" id="L2092">                    }</span>
                }
<span class="nc" id="L2094">                cs.add(See.only(this), tiles);</span>
<span class="nc" id="L2095">                visibilityChange = true;</span>
<span class="pc bpc" id="L2096" title="1 of 2 branches missed.">            } else if (father.hasModifier(Modifier.SOL)) {</span>
<span class="nc bnc" id="L2097" title="All 2 branches missed.">                for (Colony c : getColonies()) {</span>
<span class="nc" id="L2098">                    c.addLiberty(0); // Kick the SoL and production bonus</span>
<span class="nc" id="L2099">                    c.invalidateCache();</span>
<span class="nc" id="L2100">                }</span>
            } else {
<span class="fc" id="L2102">                boolean recache = false;</span>
<span class="fc bfc" id="L2103" title="All 2 branches covered.">                for (Modifier m : father.getModifiers()) {</span>
<span class="fc" id="L2104">                    recache |= m.getId().startsWith(&quot;model.goods.&quot;);</span>
<span class="fc" id="L2105">                }</span>
<span class="fc bfc" id="L2106" title="All 2 branches covered.">                for (Colony c : getColonies()) c.invalidateCache();</span>
            }                
        }

<span class="fc bfc" id="L2110" title="All 2 branches covered.">        for (Event event : father.getEvents()) {</span>
<span class="fc" id="L2111">            String eventId = event.getId();</span>
<span class="fc bfc" id="L2112" title="All 2 branches covered.">            if (&quot;model.event.resetBannedMissions&quot;.equals(eventId)) {</span>
<span class="fc bfc" id="L2113" title="All 2 branches covered.">                for (Player p : game.getLiveNativePlayers(null)) {</span>
<span class="pc bpc" id="L2114" title="1 of 2 branches missed.">                    if (p.missionsBanned(this)) {</span>
<span class="nc" id="L2115">                        p.removeMissionBan(this);</span>
<span class="nc" id="L2116">                        cs.add(See.only(this), p);</span>
                    }
<span class="fc" id="L2118">                }</span>
<span class="fc bfc" id="L2119" title="All 2 branches covered.">            } else if (&quot;model.event.resetNativeAlarm&quot;.equals(eventId)) {</span>
<span class="fc bfc" id="L2120" title="All 2 branches covered.">                for (Player p : game.getLiveNativePlayers(null)) {</span>
<span class="fc bfc" id="L2121" title="All 2 branches covered.">                    if (!p.hasContacted(this)) continue;</span>
<span class="fc" id="L2122">                    p.setTension(this, new Tension(Tension.TENSION_MIN));</span>
<span class="fc bfc" id="L2123" title="All 2 branches covered.">                    for (IndianSettlement is : p.getIndianSettlements()) {</span>
<span class="pc bpc" id="L2124" title="1 of 2 branches missed.">                        if (is.hasContacted(this)) {</span>
<span class="fc" id="L2125">                            is.getTile().cacheUnseen();//+til</span>
<span class="fc" id="L2126">                            is.setAlarm(this,</span>
                                new Tension(Tension.TENSION_MIN));//-til
<span class="fc" id="L2128">                            cs.add(See.only(this), is);</span>
                        }
<span class="fc" id="L2130">                    }</span>
<span class="fc" id="L2131">                    csChangeStance(Stance.PEACE, (ServerPlayer)p, true, cs);</span>
<span class="fc" id="L2132">                }</span>

<span class="pc bpc" id="L2134" title="1 of 2 branches missed.">            } else if (&quot;model.event.boycottsLifted&quot;.equals(eventId)) {</span>
<span class="nc" id="L2135">                Market market = getMarket();</span>
<span class="nc bnc" id="L2136" title="All 2 branches missed.">                for (GoodsType goodsType : spec.getGoodsTypeList()) {</span>
<span class="nc bnc" id="L2137" title="All 2 branches missed.">                    if (market.getArrears(goodsType) &gt; 0) {</span>
<span class="nc" id="L2138">                        market.setArrears(goodsType, 0);</span>
<span class="nc" id="L2139">                        cs.add(See.only(this), market.getMarketData(goodsType));</span>
                    }
<span class="nc" id="L2141">                }</span>

<span class="pc bpc" id="L2143" title="1 of 2 branches missed.">            } else if (&quot;model.event.freeBuilding&quot;.equals(eventId)) {</span>
<span class="fc" id="L2144">                BuildingType type = spec.getBuildingType(event.getValue());</span>
<span class="fc bfc" id="L2145" title="All 2 branches covered.">                for (Colony colony : getColonies()) {</span>
<span class="fc" id="L2146">                    ((ServerColony)colony).csFreeBuilding(type, cs);</span>
<span class="fc" id="L2147">                }</span>

<span class="pc bnc" id="L2149" title="All 2 branches missed.">            } else if (&quot;model.event.seeAllColonies&quot;.equals(eventId)) {</span>
<span class="nc" id="L2150">                visibilityChange = true;//-vis(this), can now see other colonies</span>
<span class="nc bnc" id="L2151" title="All 2 branches missed.">                for (Tile t : game.getMap().getAllTiles()) {</span>
<span class="nc" id="L2152">                    Colony colony = t.getColony();</span>
<span class="nc bnc" id="L2153" title="All 2 branches missed.">                    if (colony == null) continue;</span>
<span class="nc" id="L2154">                    Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2155" title="All 2 branches missed.">                    if (exploreTile(t)) {</span>
<span class="nc bnc" id="L2156" title="All 2 branches missed.">                        if (!hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
                            // FreeCol ruleset adds this ability
                            // allowing full visibility of colony,
                            // whereas Col1 showed colonies as size 1.
<span class="nc" id="L2160">                            Tile c = t.copy(game, Tile.class);</span>
<span class="nc" id="L2161">                            c.getColony().setDisplayUnitCount(1);</span>
<span class="nc" id="L2162">                            t.setCachedTile(this, c);</span>
                        }
<span class="nc" id="L2164">                        tiles.add(t);</span>
                    }
                    // Revealed tiles in 11x11 block in Col1
<span class="nc" id="L2167">                    final int fullRadius = (int)father</span>
<span class="nc" id="L2168">                        .applyModifiers((float)colony.getLineOfSight(),</span>
                                        turn, Modifier.EXPOSED_TILES_RADIUS);
<span class="nc" id="L2170">                    tiles.addAll(exploreTiles(t.getSurroundingTiles(1,</span>
                                fullRadius)));
<span class="nc" id="L2172">                    cs.add(See.only(this), tiles);</span>
<span class="nc" id="L2173">                }</span>

<span class="nc bnc" id="L2175" title="All 4 branches missed.">            } else if (&quot;model.event.newRecruits&quot;.equals(eventId)</span>
                       &amp;&amp; europe != null) {
<span class="nc" id="L2177">                europeDirty = europe.replaceRecruits(random);</span>

<span class="nc bnc" id="L2179" title="All 2 branches missed.">            } else if (&quot;model.event.movementChange&quot;.equals(eventId)) {</span>
<span class="nc bnc" id="L2180" title="All 2 branches missed.">                for (Unit u : getUnits()) {</span>
<span class="nc bnc" id="L2181" title="All 2 branches missed.">                    if (u.getMovesLeft() &gt; 0) {</span>
<span class="nc" id="L2182">                        u.setMovesLeft(u.getInitialMovesLeft());</span>
<span class="nc" id="L2183">                        cs.addPartial(See.only(this), u, &quot;movesLeft&quot;);</span>
                    }
<span class="nc" id="L2185">                }</span>
            }
<span class="fc" id="L2187">        }</span>

<span class="fc bfc" id="L2189" title="All 2 branches covered.">        if (europeDirty) cs.add(See.only(this), europe);</span>
<span class="fc bfc" id="L2190" title="All 2 branches covered.">        if (visibilityChange) invalidateCanSeeTiles(); //+vis(this)</span>
<span class="fc" id="L2191">    }</span>

    /**
     * Get a list of free building types this player has access to
     * through its choice of founding fathers.  Used to upgrade newly
     * captured colonies.
     *
     * @return A list of free &lt;code&gt;BuildingType&lt;/code&gt;s.
     */
    public List&lt;BuildingType&gt; getFreeBuildingTypes() {
<span class="fc" id="L2201">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L2202">        List&lt;BuildingType&gt; result = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L2203" title="1 of 2 branches missed.">        for (FoundingFather ff : getFathers()) {</span>
<span class="nc bnc" id="L2204" title="All 2 branches missed.">            for (Event event : ff.getEvents()) {</span>
<span class="nc" id="L2205">                String eventId = event.getId();</span>
<span class="nc bnc" id="L2206" title="All 2 branches missed.">                if (&quot;model.event.freeBuilding&quot;.equals(eventId)) {</span>
<span class="nc" id="L2207">                    result.add(spec.getBuildingType(event.getValue()));</span>
                }
<span class="nc" id="L2209">            }</span>
<span class="nc" id="L2210">        }</span>
<span class="fc" id="L2211">        return result;</span>
    }

    /**
     * Claim land.
     *
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to claim.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to claim for.
     * @param price The price to pay for the land, which must agree
     *     with the owner valuation, unless negative which denotes stealing.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csClaimLand(Tile tile, Settlement settlement, int price,
                            ChangeSet cs) {
<span class="fc" id="L2225">        ServerPlayer owner = (ServerPlayer)tile.getOwner();</span>
<span class="fc" id="L2226">        Settlement ownerSettlement = tile.getOwningSettlement();</span>
<span class="fc" id="L2227">        tile.cacheUnseen();//+til</span>
<span class="fc" id="L2228">        tile.changeOwnership(this, settlement);//-vis(?),-til</span>

        // Update the tile and any now-angrier owners, and the player
        // gold if a price was paid.
<span class="fc" id="L2232">        cs.add(See.perhaps(), tile);</span>
<span class="pc bpc" id="L2233" title="1 of 2 branches missed.">        if (price &gt; 0) {</span>
<span class="nc" id="L2234">            modifyGold(-price);</span>
<span class="nc" id="L2235">            owner.modifyGold(price);</span>
<span class="nc" id="L2236">            cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="pc bpc" id="L2237" title="2 of 4 branches missed.">        } else if (price &lt; 0 &amp;&amp; owner.isIndian()) {</span>
<span class="fc" id="L2238">            ServerIndianSettlement is = (ServerIndianSettlement)ownerSettlement;</span>
<span class="pc bpc" id="L2239" title="1 of 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L2240">                owner.csModifyTension(this, Tension.TENSION_ADD_LAND_TAKEN,</span>
                                      cs);
            } else {
<span class="fc" id="L2243">                is.csModifyAlarm(this, Tension.TENSION_ADD_LAND_TAKEN,</span>
                                 true, cs);
            }
        }
<span class="pc bpc" id="L2247" title="1 of 2 branches missed.">        logger.finest(this.getName() + &quot; claimed &quot; + tile</span>
<span class="pc bpc" id="L2248" title="2 of 4 branches missed.">            + &quot; from &quot; + ((owner == null) ? &quot;no-one&quot; : owner.getName())</span>
            + &quot;, price: &quot; + ((price == 0) ? &quot;free&quot; : (price &lt; 0) ? &quot;stolen&quot;
<span class="pc" id="L2250">                : price));</span>
<span class="fc" id="L2251">    }</span>


    /**
     * A unit migrates from Europe.
     *
     * @param slot The slot within &lt;code&gt;Europe&lt;/code&gt; to select the unit from.
     * @param type The type of migration occurring.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csEmigrate(int slot, MigrationType type, Random random,
                           ChangeSet cs) {
        // Create the recruit, move it to the docks.
<span class="fc" id="L2265">        ServerEurope europe = (ServerEurope)getEurope();</span>
<span class="fc" id="L2266">        UnitType recruitType = europe.extractRecruitable(slot, random);</span>
<span class="fc" id="L2267">        final Game game = getGame();</span>
<span class="fc" id="L2268">        final Specification spec = game.getSpecification();</span>
<span class="pc bpc" id="L2269" title="1 of 2 branches missed.">        Role role = (spec.getBoolean(GameOptions.EQUIP_EUROPEAN_RECRUITS))</span>
<span class="pc" id="L2270">            ? recruitType.getDefaultRole()</span>
<span class="pc" id="L2271">            : spec.getDefaultRole();</span>
<span class="fc" id="L2272">        Unit unit = new ServerUnit(game, europe, this,</span>
                                   recruitType, role);//-vis: safe/Europe

        // Handle migration type specific changes.
<span class="pc bpc" id="L2276" title="4 of 5 branches missed.">        switch (type) {</span>
        case FOUNTAIN:
<span class="nc" id="L2278">            setRemainingEmigrants(getRemainingEmigrants() - 1);</span>
<span class="nc" id="L2279">            break;</span>
        case RECRUIT:
<span class="nc" id="L2281">            modifyGold(-europe.getRecruitPrice());</span>
<span class="nc" id="L2282">            cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc" id="L2283">            europe.increaseRecruitmentDifficulty();</span>
            // Fall through
        case NORMAL:
<span class="fc" id="L2286">            reduceImmigration();</span>
<span class="fc" id="L2287">            updateImmigrationRequired();</span>
<span class="fc" id="L2288">            cs.addPartial(See.only(this), this,</span>
                          &quot;immigration&quot;, &quot;immigrationRequired&quot;);
<span class="pc bpc" id="L2290" title="1 of 2 branches missed.">            if (!MigrationType.specificMigrantSlot(slot)) {</span>
<span class="fc" id="L2291">                cs.addMessage(See.only(this), getEmigrationMessage(unit));</span>
            }
            break;
        case SURVIVAL:
            // Add an informative message if this was a survival recruitment,
<span class="nc" id="L2296">            cs.addMessage(See.only(this),</span>
                new ModelMessage(ModelMessage.MessageType.UNIT_ADDED,
                                 &quot;model.player.autoRecruit&quot;,
                                 this, unit)
<span class="nc" id="L2300">                    .addNamed(&quot;%europe%&quot;, europe)</span>
<span class="nc" id="L2301">                    .addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L2302">            break;</span>
        default:
<span class="nc" id="L2304">            throw new IllegalArgumentException(&quot;Bogus migration type&quot;);</span>
        }
<span class="fc" id="L2306">        cs.add(See.only(this), europe);</span>
<span class="fc" id="L2307">    }</span>

    /**
     * Combat.
     *
     * @param attacker The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is attacking.
     * @param defender The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is defending.
     * @param crs A list of &lt;code&gt;CombatResult&lt;/code&gt;s defining the result.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csCombat(FreeColGameObject attacker,
                         FreeColGameObject defender,
                         List&lt;CombatResult&gt; crs,
                         Random random,
                         ChangeSet cs) throws IllegalStateException {
<span class="fc" id="L2323">        CombatModel combatModel = getGame().getCombatModel();</span>
<span class="fc" id="L2324">        boolean isAttack = combatModel.combatIsAttack(attacker, defender);</span>
<span class="fc" id="L2325">        boolean isBombard = combatModel.combatIsBombard(attacker, defender);</span>
<span class="fc" id="L2326">        Unit attackerUnit = null;</span>
<span class="fc" id="L2327">        Settlement attackerSettlement = null;</span>
<span class="fc" id="L2328">        Tile attackerTile = null;</span>
<span class="fc" id="L2329">        Unit defenderUnit = null;</span>
        //ServerPlayer attackerPlayer = null;
<span class="fc" id="L2331">        ServerPlayer defenderPlayer = null;</span>
<span class="fc" id="L2332">        Tile defenderTile = null;</span>
<span class="pc bpc" id="L2333" title="1 of 2 branches missed.">        if (isAttack) {</span>
<span class="fc" id="L2334">            attackerUnit = (Unit)attacker;</span>
            //attackerPlayer = (ServerPlayer)attackerUnit.getOwner();
<span class="fc" id="L2336">            attackerTile = attackerUnit.getTile();</span>
<span class="fc" id="L2337">            defenderUnit = (Unit)defender;</span>
<span class="fc" id="L2338">            defenderPlayer = (ServerPlayer)defenderUnit.getOwner();</span>
<span class="fc" id="L2339">            defenderTile = defenderUnit.getTile();</span>
<span class="fc" id="L2340">            boolean bombard = attackerUnit.hasAbility(Ability.BOMBARD);</span>
<span class="fc" id="L2341">            cs.addAttribute(See.only(this), &quot;sound&quot;,</span>
<span class="fc bfc" id="L2342" title="All 4 branches covered.">                (attackerUnit.isNaval()) ? &quot;sound.attack.naval&quot;</span>
                : (bombard) ? &quot;sound.attack.artillery&quot;
<span class="fc bfc" id="L2344" title="All 2 branches covered.">                : (attackerUnit.isMounted()) ? &quot;sound.attack.mounted&quot;</span>
                : &quot;sound.attack.foot&quot;);
<span class="fc bfc" id="L2346" title="All 2 branches covered.">            if (attackerUnit.getOwner().isIndian()</span>
<span class="pc bpc" id="L2347" title="1 of 2 branches missed.">                &amp;&amp; defenderPlayer.isEuropean()</span>
<span class="pc bpc" id="L2348" title="1 of 2 branches missed.">                &amp;&amp; defenderUnit.getLocation().getColony() != null</span>
<span class="pc bpc" id="L2349" title="1 of 2 branches missed.">                &amp;&amp; !defenderPlayer.atWarWith(attackerUnit.getOwner())) {</span>
<span class="nc" id="L2350">                StringTemplate attackerNation</span>
<span class="nc" id="L2351">                    = attackerUnit.getApparentOwnerName();</span>
<span class="nc" id="L2352">                Colony colony = defenderUnit.getLocation().getColony();</span>
<span class="nc" id="L2353">                cs.addMessage(See.only(defenderPlayer),</span>
                    new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                        &quot;combat.indianSurprise&quot;, colony)
<span class="nc" id="L2356">                    .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="nc" id="L2357">                    .addName(&quot;%colony%&quot;, colony.getName()));</span>
            }
<span class="pc bnc" id="L2359" title="All 2 branches missed.">        } else if (isBombard) {</span>
<span class="nc" id="L2360">            attackerSettlement = (Settlement)attacker;</span>
            //attackerPlayer = (ServerPlayer)attackerSettlement.getOwner();
<span class="nc" id="L2362">            attackerTile = attackerSettlement.getTile();</span>
<span class="nc" id="L2363">            defenderUnit = (Unit)defender;</span>
<span class="nc" id="L2364">            defenderPlayer = (ServerPlayer)defenderUnit.getOwner();</span>
<span class="nc" id="L2365">            defenderTile = defenderUnit.getTile();</span>
<span class="nc" id="L2366">            cs.addAttribute(See.only(this), &quot;sound&quot;, &quot;sound.attack.bombard&quot;);</span>
        } else {
<span class="nc" id="L2368">            throw new IllegalStateException(&quot;Bogus combat&quot;);</span>
        }
<span class="pc bpc" id="L2370" title="3 of 4 branches missed.">        assert defenderTile != null;</span>

        // If the combat results were not specified (usually the case),
        // query the combat model.
<span class="pc bpc" id="L2374" title="1 of 2 branches missed.">        if (crs == null) {</span>
<span class="nc" id="L2375">            crs = combatModel.generateAttackResult(random, attacker, defender);</span>
        }
<span class="pc bpc" id="L2377" title="1 of 2 branches missed.">        if (crs.isEmpty()) {</span>
<span class="nc" id="L2378">            throw new IllegalStateException(&quot;empty attack result&quot;);</span>
        }
        // Extract main result, insisting it is one of the fundamental cases,
        // and add the animation.
        // Set vis so that loser always sees things.
        // FIXME: Bombard animations
        See vis; // Visibility that insists on the loser seeing the result.
<span class="fc" id="L2385">        CombatResult result = crs.remove(0);</span>
<span class="pc bpc" id="L2386" title="2 of 4 branches missed.">        switch (result) {</span>
        case NO_RESULT:
<span class="nc" id="L2388">            vis = See.perhaps();</span>
<span class="nc" id="L2389">            break; // Do not animate if there is no result.</span>
        case WIN:
<span class="fc" id="L2391">            vis = See.perhaps().always(defenderPlayer);</span>
<span class="pc bpc" id="L2392" title="1 of 2 branches missed.">            if (isAttack) {</span>
<span class="pc bpc" id="L2393" title="2 of 4 branches missed.">                if (attackerTile == null</span>
                    || attackerTile == defenderTile
<span class="pc bpc" id="L2395" title="1 of 2 branches missed.">                    || !attackerTile.isAdjacent(defenderTile)) {</span>
<span class="nc" id="L2396">                    logger.warning(&quot;Bogus attack from &quot; + attackerTile</span>
                        + &quot; to &quot; + defenderTile
<span class="nc" id="L2398">                        + &quot;\n&quot; + FreeColDebugger.stackTraceToString());</span>
                } else {
<span class="fc" id="L2400">                    cs.addAttack(vis, attackerUnit, defenderUnit, true);</span>
                }
            }
            break;
        case LOSE:
<span class="fc" id="L2405">            vis = See.perhaps().always(this);</span>
<span class="pc bpc" id="L2406" title="1 of 2 branches missed.">            if (isAttack) {</span>
<span class="pc bpc" id="L2407" title="2 of 4 branches missed.">                if (attackerTile == null</span>
                    || attackerTile == defenderTile
<span class="pc bpc" id="L2409" title="1 of 2 branches missed.">                    || !attackerTile.isAdjacent(defenderTile)) {</span>
<span class="nc" id="L2410">                    logger.warning(&quot;Bogus attack from &quot; + attackerTile</span>
                        + &quot; to &quot; + defenderTile
<span class="nc" id="L2412">                        + &quot;\n&quot; + FreeColDebugger.stackTraceToString());</span>
                } else {
<span class="fc" id="L2414">                    cs.addAttack(vis, attackerUnit, defenderUnit, false);</span>
                }
            }
            break;
        default:
<span class="nc" id="L2419">            throw new IllegalStateException(&quot;generateAttackResult returned: &quot;</span>
                                            + result);
        }
        // Now process the details.
<span class="fc" id="L2423">        boolean attackerTileDirty = false;</span>
<span class="fc" id="L2424">        boolean defenderTileDirty = false;</span>
<span class="fc" id="L2425">        boolean moveAttacker = false;</span>
<span class="fc" id="L2426">        boolean burnedNativeCapital = false;</span>
<span class="fc" id="L2427">        Settlement settlement = defenderTile.getSettlement();</span>
<span class="fc" id="L2428">        Colony colony = defenderTile.getColony();</span>
<span class="fc bfc" id="L2429" title="All 2 branches covered.">        IndianSettlement natives = (settlement instanceof IndianSettlement)</span>
            ? (IndianSettlement) settlement
            : null;
<span class="fc" id="L2432">        int attackerTension = 0;</span>
<span class="fc" id="L2433">        int defenderTension = 0;</span>
<span class="fc bfc" id="L2434" title="All 2 branches covered.">        for (CombatResult cr : crs) {</span>
            boolean ok;
<span class="pc bpc" id="L2436" title="11 of 25 branches missed.">            switch (cr) {</span>
            case AUTOEQUIP_UNIT:
<span class="pc bpc" id="L2438" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; settlement != null;</span>
<span class="pc bpc" id="L2439" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2440">                    csAutoequipUnit(defenderUnit, settlement, cs);</span>
                }
                break;
            case BURN_MISSIONS:
<span class="nc bnc" id="L2444" title="All 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; natives != null
<span class="nc bnc" id="L2446" title="All 4 branches missed.">                    &amp;&amp; isEuropean() &amp;&amp; defenderPlayer.isIndian();</span>
<span class="nc bnc" id="L2447" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2448">                    defenderTileDirty |= natives.hasMissionary(this);</span>
<span class="nc" id="L2449">                    csBurnMissions(attackerUnit, natives, cs);</span>
                }
                break;
            case CAPTURE_AUTOEQUIP:
<span class="nc bnc" id="L2453" title="All 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; settlement != null;
<span class="nc bnc" id="L2455" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2456">                    csCaptureAutoEquip(attackerUnit, defenderUnit, cs);</span>
<span class="nc" id="L2457">                    attackerTileDirty = defenderTileDirty = true;</span>
                }
                break;
            case CAPTURE_COLONY:
<span class="pc bpc" id="L2461" title="3 of 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; colony != null
<span class="pc bpc" id="L2463" title="2 of 4 branches missed.">                    &amp;&amp; isEuropean() &amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2464" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2465">                    csCaptureColony(attackerUnit, (ServerColony)colony,</span>
                                    random, cs);
<span class="fc" id="L2467">                    attackerTileDirty = defenderTileDirty = false;</span>
<span class="fc" id="L2468">                    moveAttacker = true;</span>
<span class="fc" id="L2469">                    defenderTension += Tension.TENSION_ADD_MAJOR;</span>
                }
                break;
            case CAPTURE_CONVERT:
<span class="pc bpc" id="L2473" title="3 of 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; natives != null
<span class="pc bpc" id="L2475" title="2 of 4 branches missed.">                    &amp;&amp; isEuropean() &amp;&amp; defenderPlayer.isIndian();</span>
<span class="pc bpc" id="L2476" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2477">                    csCaptureConvert(attackerUnit, natives, random, cs);</span>
<span class="fc" id="L2478">                    attackerTileDirty = true;</span>
                }
                break;
            case CAPTURE_EQUIP:
<span class="pc bpc" id="L2482" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2483" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2484" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="nc" id="L2485">                        csCaptureEquip(attackerUnit, defenderUnit, cs);</span>
                    } else {
<span class="fc" id="L2487">                        csCaptureEquip(defenderUnit, attackerUnit, cs);</span>
                    }
<span class="fc" id="L2489">                    attackerTileDirty = defenderTileDirty = true;</span>
                }
                break;
            case CAPTURE_UNIT:
<span class="pc bpc" id="L2493" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2494" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2495" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2496">                        csCaptureUnit(attackerUnit, defenderUnit, cs);</span>
                    } else {
<span class="fc" id="L2498">                        csCaptureUnit(defenderUnit, attackerUnit, cs);</span>
                    }
<span class="fc" id="L2500">                    attackerTileDirty = true;</span>
<span class="fc" id="L2501">                    defenderTileDirty = false; // Added in csCaptureUnit</span>
                }
                break;
            case DAMAGE_COLONY_SHIPS:
<span class="nc bnc" id="L2505" title="All 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; colony != null;
<span class="nc bnc" id="L2507" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2508">                    csDamageColonyShips(attackerUnit, colony, cs);</span>
<span class="nc" id="L2509">                    defenderTileDirty = true;</span>
                }
                break;
            case DAMAGE_SHIP_ATTACK:
<span class="pc bpc" id="L2513" title="3 of 6 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
                    &amp;&amp; ((result == CombatResult.WIN) ? defenderUnit
<span class="pc bpc" id="L2515" title="1 of 2 branches missed.">                        : attackerUnit).isNaval();</span>
<span class="pc bpc" id="L2516" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2517" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2518">                        csDamageShipAttack(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2519">                        defenderTileDirty = true;</span>
                    } else {
<span class="nc" id="L2521">                        csDamageShipAttack(defenderUnit, attackerUnit, cs);</span>
<span class="nc" id="L2522">                        attackerTileDirty = true;</span>
                    }
                }
                break;
            case DAMAGE_SHIP_BOMBARD:
<span class="nc bnc" id="L2527" title="All 4 branches missed.">                ok = isBombard &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2528" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2529" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2530">                    csDamageShipBombard(attackerSettlement, defenderUnit, cs);</span>
<span class="nc" id="L2531">                    defenderTileDirty = true;</span>
                }
                break;
            case DEMOTE_UNIT:
<span class="pc bpc" id="L2535" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2536" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2537" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2538">                        csDemoteUnit(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2539">                        defenderTileDirty = true;</span>
                    } else {
<span class="fc" id="L2541">                        csDemoteUnit(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2542">                        attackerTileDirty = true;</span>
                    }
                }
                break;
            case DESTROY_COLONY:
<span class="pc bpc" id="L2547" title="3 of 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; colony != null
<span class="pc bpc" id="L2549" title="2 of 4 branches missed.">                    &amp;&amp; isIndian() &amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2550" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2551">                    csDestroyColony(attackerUnit, colony, random, cs);</span>
<span class="fc" id="L2552">                    attackerTileDirty = defenderTileDirty = true;</span>
<span class="fc" id="L2553">                    moveAttacker = true;</span>
<span class="fc" id="L2554">                    attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="fc" id="L2555">                    defenderTension += Tension.TENSION_ADD_MAJOR;</span>
                }
                break;
            case DESTROY_SETTLEMENT:
<span class="nc bnc" id="L2559" title="All 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; natives != null
<span class="nc bnc" id="L2561" title="All 2 branches missed.">                    &amp;&amp; defenderPlayer.isIndian();</span>
<span class="nc bnc" id="L2562" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2563">                    burnedNativeCapital = settlement.isCapital();</span>
<span class="nc" id="L2564">                    csDestroySettlement(attackerUnit, natives, random, cs);</span>
<span class="nc" id="L2565">                    attackerTileDirty = defenderTileDirty = true;</span>
<span class="nc" id="L2566">                    moveAttacker = true;</span>
<span class="nc" id="L2567">                    attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="nc bnc" id="L2568" title="All 2 branches missed.">                    if (!burnedNativeCapital) {</span>
<span class="nc" id="L2569">                        defenderTension += Tension.TENSION_ADD_MAJOR;</span>
                    }
                }
                break;
            case EVADE_ATTACK:
<span class="nc bnc" id="L2574" title="All 4 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.NO_RESULT</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2576" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2577">                    csEvadeAttack(attackerUnit, defenderUnit, cs);</span>
                }
                break;
            case EVADE_BOMBARD:
<span class="nc bnc" id="L2581" title="All 4 branches missed.">                ok = isBombard &amp;&amp; result == CombatResult.NO_RESULT</span>
<span class="nc bnc" id="L2582" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2583" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2584">                    csEvadeBombard(attackerSettlement, defenderUnit, cs);</span>
                }
                break;
            case LOOT_SHIP:
<span class="pc bpc" id="L2588" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
<span class="pc bpc" id="L2589" title="2 of 4 branches missed.">                    &amp;&amp; attackerUnit.isNaval() &amp;&amp; defenderUnit.isNaval();</span>
<span class="pc bpc" id="L2590" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2591" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2592">                        csLootShip(attackerUnit, defenderUnit, cs);</span>
                    } else {
<span class="nc" id="L2594">                        csLootShip(defenderUnit, attackerUnit, cs);</span>
                    }
                }
                break;
            case LOSE_AUTOEQUIP:
<span class="pc bpc" id="L2599" title="3 of 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; settlement != null;
<span class="pc bpc" id="L2601" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2602">                    csLoseAutoEquip(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2603">                    defenderTileDirty = true;</span>
                }
                break;
            case LOSE_EQUIP:
<span class="pc bpc" id="L2607" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2608" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2609" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2610">                        csLoseEquip(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2611">                        defenderTileDirty = true;</span>
                    } else {
<span class="fc" id="L2613">                        csLoseEquip(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2614">                        attackerTileDirty = true;</span>
                    }
                }
                break;
            case PILLAGE_COLONY:
<span class="pc bpc" id="L2619" title="3 of 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; colony != null
<span class="pc bpc" id="L2621" title="2 of 4 branches missed.">                    &amp;&amp; isIndian() &amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2622" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc" id="L2623">                    csPillageColony(attackerUnit, colony, random, cs);</span>
<span class="fc" id="L2624">                    defenderTileDirty = true;</span>
<span class="fc" id="L2625">                    attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
                }
                break;
            case PROMOTE_UNIT:
<span class="pc bpc" id="L2629" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2630" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="pc bpc" id="L2631" title="1 of 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2632">                        csPromoteUnit(attackerUnit, cs);</span>
<span class="fc" id="L2633">                        attackerTileDirty = true;</span>
                    } else {
<span class="nc" id="L2635">                        csPromoteUnit(defenderUnit, cs);</span>
<span class="nc" id="L2636">                        defenderTileDirty = true;</span>
                    }
                }
                break;
            case SINK_COLONY_SHIPS:
<span class="nc bnc" id="L2641" title="All 6 branches missed.">                ok = isAttack &amp;&amp; result == CombatResult.WIN</span>
                    &amp;&amp; colony != null;
<span class="nc bnc" id="L2643" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2644">                    csSinkColonyShips(attackerUnit, colony, cs);</span>
<span class="nc" id="L2645">                    defenderTileDirty = true;</span>
                }
                break;
            case SINK_SHIP_ATTACK:
<span class="nc bnc" id="L2649" title="All 6 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
                    &amp;&amp; ((result == CombatResult.WIN) ? defenderUnit
<span class="nc bnc" id="L2651" title="All 2 branches missed.">                        : attackerUnit).isNaval();</span>
<span class="nc bnc" id="L2652" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc bnc" id="L2653" title="All 2 branches missed.">                    if (result == CombatResult.WIN) {</span>
<span class="nc" id="L2654">                        csSinkShipAttack(attackerUnit, defenderUnit, cs);</span>
<span class="nc" id="L2655">                        defenderTileDirty = true;</span>
                    } else {
<span class="nc" id="L2657">                        csSinkShipAttack(defenderUnit, attackerUnit, cs);</span>
<span class="nc" id="L2658">                        attackerTileDirty = true;</span>
                    }
                }
                break;
            case SINK_SHIP_BOMBARD:
<span class="nc bnc" id="L2663" title="All 4 branches missed.">                ok = isBombard &amp;&amp; result == CombatResult.WIN</span>
<span class="nc bnc" id="L2664" title="All 2 branches missed.">                    &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2665" title="All 2 branches missed.">                if (ok) {</span>
<span class="nc" id="L2666">                    csSinkShipBombard(attackerSettlement, defenderUnit, cs);</span>
<span class="nc" id="L2667">                    defenderTileDirty = true;</span>
                }
                break;
            case SLAUGHTER_UNIT:
<span class="pc bpc" id="L2671" title="2 of 4 branches missed.">                ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2672" title="1 of 2 branches missed.">                if (ok) {</span>
<span class="fc bfc" id="L2673" title="All 2 branches covered.">                    if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2674">                        csSlaughterUnit(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2675">                        defenderTileDirty = true;</span>
<span class="fc" id="L2676">                        attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="fc" id="L2677">                        defenderTension += getSlaughterTension(defenderUnit);</span>
                    } else {
<span class="fc" id="L2679">                        csSlaughterUnit(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2680">                        attackerTileDirty = true;</span>
<span class="fc" id="L2681">                        attackerTension += getSlaughterTension(attackerUnit);</span>
<span class="fc" id="L2682">                        defenderTension -= Tension.TENSION_ADD_NORMAL;</span>
                    }
                }
                break;
            default:
<span class="nc" id="L2687">                ok = false;</span>
                break;
            }
<span class="pc bpc" id="L2690" title="1 of 2 branches missed.">            if (!ok) {</span>
<span class="nc" id="L2691">                throw new IllegalStateException(&quot;Attack (result=&quot; + result</span>
                                                + &quot;) has bogus subresult: &quot;
                                                + cr);
            }
<span class="fc" id="L2695">        }</span>

        // Handle stance and tension.
        // - Privateers do not provoke stance changes but can set the
        //     attackedByPrivateers flag
        // - Attacks among Europeans imply war
        // - Burning of a native capital results in surrender
        // - Other attacks involving natives do not imply war, but
        //     changes in Tension can drive Stance, however this is
        //     decided by the native AI in their turn so just adjust tension.
<span class="fc bfc" id="L2705" title="All 2 branches covered.">        if (attacker.hasAbility(Ability.PIRACY)) {</span>
<span class="pc bpc" id="L2706" title="1 of 2 branches missed.">            if (!defenderPlayer.getAttackedByPrivateers()) {</span>
<span class="fc" id="L2707">                defenderPlayer.setAttackedByPrivateers(true);</span>
<span class="fc" id="L2708">                cs.addPartial(See.only(defenderPlayer), defenderPlayer,</span>
                              &quot;attackedByPrivateers&quot;);
            }
<span class="pc bpc" id="L2711" title="1 of 2 branches missed.">        } else if (defender.hasAbility(Ability.PIRACY)) {</span>
            ; // do nothing
<span class="pc bpc" id="L2713" title="1 of 2 branches missed.">        } else if (burnedNativeCapital) {</span>
<span class="nc" id="L2714">            defenderPlayer.getTension(this).setValue(Tension.SURRENDERED);</span>
            // FIXME: just the tension
<span class="nc" id="L2716">            cs.add(See.perhaps().always(this), defenderPlayer);</span>
<span class="nc" id="L2717">            csChangeStance(Stance.PEACE, defenderPlayer, true, cs);</span>
<span class="nc bnc" id="L2718" title="All 2 branches missed.">            for (IndianSettlement is : defenderPlayer.getIndianSettlements()) {</span>
<span class="nc bnc" id="L2719" title="All 2 branches missed.">                if (is.hasContacted(this)) {</span>
<span class="nc" id="L2720">                    is.getAlarm(this).setValue(Tension.SURRENDERED);</span>
                    // Only update attacker with settlements that have
                    // been seen, as contact can occur with its members.
<span class="nc bnc" id="L2723" title="All 2 branches missed.">                    if (hasExplored(is.getTile())) {</span>
<span class="nc" id="L2724">                        cs.add(See.perhaps().always(this), is);</span>
                    } else {
<span class="nc" id="L2726">                        cs.add(See.only(defenderPlayer), is);</span>
                    }
                }
<span class="nc" id="L2729">            }</span>
<span class="fc bfc" id="L2730" title="All 4 branches covered.">        } else if (isEuropean() &amp;&amp; defenderPlayer.isEuropean()) {</span>
<span class="fc" id="L2731">            csChangeStance(Stance.WAR, defenderPlayer, true, cs);</span>
        } else { // At least one player is non-European
<span class="fc bfc" id="L2733" title="All 2 branches covered.">            if (isEuropean()) {</span>
<span class="fc" id="L2734">                csChangeStance(Stance.WAR, defenderPlayer, true, cs);</span>
<span class="pc bpc" id="L2735" title="1 of 2 branches missed.">            } else if (isIndian()) {</span>
<span class="pc bpc" id="L2736" title="1 of 2 branches missed.">                if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2737">                    attackerTension -= Tension.TENSION_ADD_MINOR;</span>
<span class="nc bnc" id="L2738" title="All 2 branches missed.">                } else if (result == CombatResult.LOSE) {</span>
<span class="nc" id="L2739">                    attackerTension += Tension.TENSION_ADD_MINOR;</span>
                }
            }
<span class="fc bfc" id="L2742" title="All 2 branches covered.">            if (defenderPlayer.isEuropean()) {</span>
<span class="fc" id="L2743">                defenderPlayer.csChangeStance(Stance.WAR, this, true, cs);</span>
<span class="pc bpc" id="L2744" title="1 of 2 branches missed.">            } else if (defenderPlayer.isIndian()) {</span>
<span class="fc bfc" id="L2745" title="All 2 branches covered.">                if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2746">                    defenderTension += Tension.TENSION_ADD_MINOR;</span>
<span class="pc bpc" id="L2747" title="1 of 2 branches missed.">                } else if (result == CombatResult.LOSE) {</span>
<span class="fc" id="L2748">                    defenderTension -= Tension.TENSION_ADD_MINOR;</span>
                }
            }
<span class="fc bfc" id="L2751" title="All 2 branches covered.">            if (attackerTension != 0) {</span>
<span class="fc" id="L2752">                this.csModifyTension(defenderPlayer,</span>
                                     attackerTension, cs);//+til
            }
<span class="fc bfc" id="L2755" title="All 2 branches covered.">            if (defenderTension != 0) {</span>
<span class="fc" id="L2756">                defenderPlayer.csModifyTension(this,</span>
                                               defenderTension, cs);//+til
            }
        }

        // Move the attacker if required.
<span class="fc bfc" id="L2762" title="All 2 branches covered.">        if (moveAttacker) {</span>
<span class="fc" id="L2763">            attackerUnit.setMovesLeft(attackerUnit.getInitialMovesLeft());</span>
<span class="fc" id="L2764">            ((ServerUnit) attackerUnit).csMove(defenderTile, random, cs);</span>
<span class="fc" id="L2765">            attackerUnit.setMovesLeft(0);</span>
            // Move adds in updates for the tiles, but...
<span class="fc" id="L2767">            attackerTileDirty = defenderTileDirty = false;</span>
            // ...with visibility of perhaps().
            // Thus the defender might see the change,
            // but because its settlement is gone it also might not.
            // So add in another defender-specific update.
            // The worst that can happen is a duplicate update.
<span class="fc" id="L2773">            cs.add(See.only(defenderPlayer), defenderTile);</span>
<span class="pc bpc" id="L2774" title="1 of 2 branches missed.">        } else if (isAttack) {</span>
            // The Revenger unit can attack multiple times, so spend
            // at least the eventual cost of moving to the tile.
            // Other units consume the entire move.
<span class="pc bpc" id="L2778" title="1 of 2 branches missed.">            if (attacker.hasAbility(Ability.MULTIPLE_ATTACKS)) {</span>
<span class="nc" id="L2779">                int movecost = attackerUnit.getMoveCost(defenderTile);</span>
<span class="nc" id="L2780">                attackerUnit.setMovesLeft(attackerUnit.getMovesLeft()</span>
                                          - movecost);
<span class="nc" id="L2782">            } else {</span>
<span class="fc" id="L2783">                attackerUnit.setMovesLeft(0);</span>
            }
<span class="fc bfc" id="L2785" title="All 2 branches covered.">            if (!attackerTileDirty) {</span>
<span class="fc" id="L2786">                cs.addPartial(See.only(this), attacker, &quot;movesLeft&quot;);</span>
            }
        }

        // Make sure we always update the attacker and defender tile
        // if it is not already done yet.
<span class="fc bfc" id="L2792" title="All 2 branches covered.">        if (attackerTileDirty) {</span>
<span class="pc bpc" id="L2793" title="1 of 2 branches missed.">            if (attackerSettlement != null) cs.remove(attackerSettlement);</span>
<span class="fc" id="L2794">            cs.add(vis, attackerTile);</span>
        }
<span class="fc bfc" id="L2796" title="All 2 branches covered.">        if (defenderTileDirty) {</span>
<span class="fc bfc" id="L2797" title="All 2 branches covered.">            if (settlement != null) cs.remove(settlement);</span>
<span class="fc" id="L2798">            cs.add(vis, defenderTile);</span>
        }
<span class="fc" id="L2800">    }</span>

    /**
     * Gets the amount to raise tension by when a unit is slaughtered.
     *
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that dies.
     * @return An amount to raise tension by.
     */
    private int getSlaughterTension(Unit loser) {
        // Tension rises faster when units die.
<span class="fc" id="L2810">        Settlement settlement = loser.getSettlement();</span>
<span class="pc bpc" id="L2811" title="1 of 2 branches missed.">        if (settlement != null) {</span>
<span class="nc bnc" id="L2812" title="All 2 branches missed.">            if (settlement instanceof IndianSettlement) {</span>
<span class="nc bnc" id="L2813" title="All 2 branches missed.">                return (settlement.isCapital())</span>
                    ? Tension.TENSION_ADD_CAPITAL_ATTACKED
                    : Tension.TENSION_ADD_SETTLEMENT_ATTACKED;
            } else {
<span class="nc" id="L2817">                return Tension.TENSION_ADD_NORMAL;</span>
            }
        } else { // attack in the open
<span class="pc bpc" id="L2820" title="1 of 2 branches missed.">            return (loser.getHomeIndianSettlement() != null)</span>
                ? Tension.TENSION_ADD_UNIT_DESTROYED
                : Tension.TENSION_ADD_MINOR;
        }
    }

    /**
     * Notifies of automatic arming.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is auto-equipping.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; being defended.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csAutoequipUnit(Unit unit, Settlement settlement,
                                 ChangeSet cs) {
<span class="fc" id="L2835">        ServerPlayer player = (ServerPlayer) unit.getOwner();</span>
<span class="fc" id="L2836">        cs.addMessage(See.only(player),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.automaticDefence&quot;, unit)
<span class="fc" id="L2839">            .addStringTemplate(&quot;%unit%&quot;, unit.getLabel())</span>
<span class="fc" id="L2840">            .addName(&quot;%colony%&quot;, settlement.getName()));</span>
<span class="fc" id="L2841">    }</span>

    /**
     * Burns a players missions.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; that was attacked.
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csBurnMissions(Unit attacker, IndianSettlement settlement,
                                ChangeSet cs) {
<span class="nc" id="L2852">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L2853">        StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="nc" id="L2854">        ServerPlayer nativePlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L2855">        StringTemplate nativeNation = nativePlayer.getNationLabel();</span>

        // Message only for the European player
<span class="nc" id="L2858">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.burnMissions&quot;, attacker, settlement)
<span class="nc" id="L2861">                      .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="nc" id="L2862">                      .addStringTemplate(&quot;%enemyNation%&quot;, nativeNation));</span>

        // Burn down the missions
<span class="nc" id="L2865">        boolean here = settlement.hasMissionary(attackerPlayer);</span>
<span class="nc bnc" id="L2866" title="All 2 branches missed.">        for (IndianSettlement s : nativePlayer.getIndianSettlements()) {</span>
<span class="nc bnc" id="L2867" title="All 2 branches missed.">            if (s.hasMissionary(attackerPlayer)) {</span>
<span class="nc" id="L2868">                ((ServerIndianSettlement)s).csKillMissionary(null, cs);</span>
            }
<span class="nc" id="L2870">        }</span>
        // Backtrack on updating this tile, avoiding duplication in csCombat
<span class="nc bnc" id="L2872" title="All 2 branches missed.">        if (here) cs.remove(settlement.getTile());</span>
<span class="nc" id="L2873">    }</span>

    /**
     * Defender auto equips but loses and attacker captures the equipment.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param defender The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureAutoEquip(Unit attacker, Unit defender,
                                    ChangeSet cs) {
<span class="nc" id="L2884">        Role role = defender.getAutomaticRole();</span>
<span class="nc" id="L2885">        csLoseAutoEquip(attacker, defender, cs);</span>
<span class="nc" id="L2886">        csCaptureEquipment(attacker, defender, role, cs);</span>
<span class="nc" id="L2887">    }</span>

    /**
     * Captures a colony.
     *
     * @param attacker The attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param colony The &lt;code&gt;ServerColony&lt;/code&gt; to capture.
     * @param random A pseudo-random number source.
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureColony(Unit attacker, ServerColony colony,
                                 Random random, ChangeSet cs) {
<span class="fc" id="L2899">        Game game = attacker.getGame();</span>
<span class="fc" id="L2900">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L2901">        StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="fc" id="L2902">        ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L2903">        StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>
<span class="fc" id="L2904">        Tile tile = colony.getTile();</span>
<span class="fc" id="L2905">        List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L2906">        units.addAll(colony.getUnitList());</span>
<span class="fc" id="L2907">        units.addAll(tile.getUnitList());</span>
<span class="fc" id="L2908">        int plunder = colony.getPlunder(attacker, random);</span>

        // Handle history and messages before colony handover
<span class="fc" id="L2911">        cs.addHistory(attackerPlayer,</span>
<span class="fc" id="L2912">            new HistoryEvent(game.getTurn(),</span>
                HistoryEvent.HistoryEventType.CONQUER_COLONY, attackerPlayer)
<span class="fc" id="L2914">                .addStringTemplate(&quot;%nation%&quot;, colonyNation)</span>
<span class="fc" id="L2915">                .addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L2916">        cs.addHistory(colonyPlayer,</span>
<span class="fc" id="L2917">            new HistoryEvent(game.getTurn(),</span>
                HistoryEvent.HistoryEventType.COLONY_CONQUERED, attackerPlayer)
<span class="fc" id="L2919">                      .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="fc" id="L2920">                      .addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L2921">        cs.addMessage(See.only(attackerPlayer),</span>
                      new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                                       &quot;combat.colonyCaptured&quot;, colony)
<span class="fc" id="L2924">                      .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L2925">                      .addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="fc" id="L2926">        cs.addMessage(See.only(colonyPlayer),</span>
                      new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                                       &quot;combat.colonyCapturedBy&quot;, tile)
<span class="fc" id="L2929">                      .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L2930">                      .addAmount(&quot;%amount%&quot;, plunder)</span>
<span class="fc" id="L2931">                      .addStringTemplate(&quot;%player%&quot;, attackerNation));</span>
<span class="fc" id="L2932">        colonyPlayer.csLoseLocation(colony, cs);</span>

        // Allocate some plunder
<span class="pc bpc" id="L2935" title="1 of 2 branches missed.">        if (plunder &gt; 0) {</span>
<span class="nc" id="L2936">            attackerPlayer.modifyGold(plunder);</span>
<span class="nc" id="L2937">            colonyPlayer.modifyGold(-plunder);</span>
<span class="nc" id="L2938">            cs.addPartial(See.only(attackerPlayer), attackerPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2939">            cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
        }

        // Remove goods party modifiers as they apply to a different monarch.
<span class="fc bfc" id="L2943" title="All 2 branches covered.">        for (Modifier m : colony.getModifiers()) {</span>
<span class="pc bpc" id="L2944" title="1 of 2 branches missed.">            if (Specification.COLONY_GOODS_PARTY_SOURCE == m.getSource()) {</span>
<span class="nc" id="L2945">                colony.removeModifier(m);</span>
            }
<span class="fc" id="L2947">        }</span>

        // The colony is falling, so allow other neighbours a chance
        // to claim its tiles.  Make sure units are ejected when a tile
        // is claimed.
<span class="fc" id="L2952">        Set&lt;Tile&gt; tiles = colony.getOwnedTiles();</span>
<span class="fc" id="L2953">        tile.cacheUnseen();</span>
<span class="fc" id="L2954">        tiles.remove(tile);</span>
<span class="fc bfc" id="L2955" title="All 2 branches covered.">        for (Tile t : tiles) {</span>
<span class="fc" id="L2956">            t.cacheUnseen();</span>
<span class="fc" id="L2957">            t.changeOwnership(null, null);//-til</span>
<span class="fc" id="L2958">        }</span>
<span class="fc" id="L2959">        reassignTiles(tiles, colonyPlayer, colony);//-til</span>
<span class="fc bfc" id="L2960" title="All 2 branches covered.">        for (Tile t : tiles) {</span>
<span class="fc bfc" id="L2961" title="All 2 branches covered.">            if (t.getOwningSettlement() != colony) {</span>
<span class="fc" id="L2962">                ColonyTile ct = colony.getColonyTile(t);</span>
<span class="fc" id="L2963">                colony.ejectUnits(ct, ct.getUnitList());</span>
            }
<span class="fc" id="L2965">        }</span>

        // Hand over the colony.  Inform former owner of loss of owned
        // tiles, and process possible increase in line of sight.
        // No need to display the colony tile or the attacker tile to
        // the attacking player as the unit is yet to move
<span class="fc" id="L2971">        Set&lt;Tile&gt; explored = colony//-til</span>
<span class="fc" id="L2972">            .csChangeOwner(attackerPlayer, cs);//-vis(attackerPlayer,colonyPlayer)</span>
<span class="fc" id="L2973">        explored.addAll(tiles);</span>
<span class="pc bpc" id="L2974" title="1 of 2 branches missed.">        if (attacker.hasTile()) explored.remove(attacker.getTile());</span>
<span class="fc" id="L2975">        cs.add(See.only(attackerPlayer), explored);</span>
<span class="fc" id="L2976">        cs.add(See.perhaps().always(colonyPlayer).except(attackerPlayer),</span>
               tiles);

        // Inform the former owner of loss of units, and add sound.
<span class="fc" id="L2980">        cs.addRemoves(See.only(colonyPlayer), null, units);</span>
<span class="fc" id="L2981">        cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;,</span>
                        &quot;sound.event.captureColony&quot;);

        // Ready to reset visibility
<span class="fc" id="L2985">        attackerPlayer.invalidateCanSeeTiles();//+vis(attackerPlayer)</span>
<span class="fc" id="L2986">        colonyPlayer.invalidateCanSeeTiles();//+vis(colonyPlayer)</span>
<span class="fc" id="L2987">    }</span>

    /**
     * Extracts a convert from a native settlement.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that is attacking.
     * @param is The &lt;code&gt;IndianSettlement&lt;/code&gt; under attack.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureConvert(Unit attacker, IndianSettlement is,
                                  Random random, ChangeSet cs) {
<span class="fc" id="L2999">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L3000">        ServerPlayer attackerPlayer = (ServerPlayer)attacker.getOwner();</span>
<span class="fc" id="L3001">        ServerPlayer nativePlayer = (ServerPlayer)is.getOwner();</span>
<span class="fc" id="L3002">        StringTemplate convertNation = nativePlayer.getNationLabel();</span>
<span class="fc" id="L3003">        List&lt;Unit&gt; units = is.getTile().getUnitList();</span>
<span class="pc bpc" id="L3004" title="1 of 2 branches missed.">        if (units.isEmpty()) units.addAll(is.getUnitList());</span>
<span class="fc" id="L3005">        ServerUnit convert = (ServerUnit)getRandomMember(logger,</span>
            &quot;Choose convert&quot;, units, random);
<span class="pc bpc" id="L3007" title="1 of 2 branches missed.">        if (nativePlayer.csChangeOwner(convert, attackerPlayer,</span>
                                       ChangeType.CONVERSION,
<span class="fc" id="L3009">                                       attacker.getTile(),</span>
                                       cs)) { //-vis(attackerPlayer)
<span class="fc" id="L3011">            convert.changeRole(spec.getDefaultRole(), 0);</span>
<span class="fc" id="L3012">            convert.setMovesLeft(0);</span>
<span class="fc" id="L3013">            convert.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3014">            cs.add(See.only(nativePlayer), is.getTile());</span>
<span class="fc" id="L3015">            cs.addMessage(See.only(attackerPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                                 &quot;combat.newConvertFromAttack&quot;, convert)
<span class="fc" id="L3018">                    .addStringTemplate(&quot;%nation%&quot;, convertNation)</span>
<span class="fc" id="L3019">                    .addStringTemplate(&quot;%unit%&quot;, convert.getLabel()));</span>
<span class="fc" id="L3020">            attackerPlayer.invalidateCanSeeTiles();//+vis(attackerPlayer)</span>
        }
<span class="fc" id="L3022">    }</span>

    /**
     * Captures equipment.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that captures equipment.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureEquip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3032">        Role role = loser.getRole();</span>
<span class="fc" id="L3033">        csLoseEquip(winner, loser, cs);</span>
<span class="fc" id="L3034">        csCaptureEquipment(winner, loser, role, cs);</span>
<span class="fc" id="L3035">    }</span>

    /**
     * Capture equipment.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that is capturing equipment.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that is losing equipment.
     * @param role The &lt;code&gt;Role&lt;/code&gt; wrest from the loser.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureEquipment(Unit winner, Unit loser,
                                    Role role, ChangeSet cs) {
<span class="fc" id="L3047">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3048">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3049">        Role newRole = winner.canCaptureEquipment(role);</span>
<span class="pc bpc" id="L3050" title="1 of 2 branches missed.">        if (newRole != null) {</span>
<span class="fc" id="L3051">            List&lt;AbstractGoods&gt; newGoods</span>
<span class="fc" id="L3052">                = winner.getGoodsDifference(newRole, 1);</span>
<span class="fc" id="L3053">            GoodsType goodsType = newGoods.get(0).getType(); // FIXME: generalize</span>
<span class="fc" id="L3054">            winner.changeRole(newRole, 1);</span>

            // Currently can not capture equipment back so this only
            // makes sense for native players, and the message is
            // native specific.
<span class="pc bpc" id="L3059" title="1 of 2 branches missed.">            if (winnerPlayer.isIndian()) {</span>
<span class="fc" id="L3060">                StringTemplate winnerNation = winnerPlayer.getNationLabel();</span>
<span class="fc" id="L3061">                cs.addMessage(See.only(loserPlayer),</span>
                              new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                                               &quot;combat.equipmentCaptured&quot;,
                                               winnerPlayer)
<span class="fc" id="L3065">                              .addStringTemplate(&quot;%nation%&quot;, winnerNation)</span>
<span class="fc" id="L3066">                              .addNamed(&quot;%equipment%&quot;, goodsType));</span>

                // CHEAT: Immediately transferring the captured goods
                // back to a potentially remote settlement is pretty
                // dubious.  Apparently Col1 did it.  Better would be
                // to give the capturing unit a go-home-with-plunder mission.
<span class="fc" id="L3072">                IndianSettlement settlement = winner.getHomeIndianSettlement();</span>
<span class="pc bpc" id="L3073" title="1 of 2 branches missed.">                if (settlement != null) {</span>
<span class="fc bfc" id="L3074" title="All 2 branches covered.">                    for (AbstractGoods ag : newGoods) {</span>
<span class="fc" id="L3075">                        settlement.addGoods(ag);</span>
<span class="fc" id="L3076">                        winnerPlayer.logCheat(&quot;teleported &quot; + ag</span>
<span class="fc" id="L3077">                            + &quot; back to &quot; + settlement.getName());</span>
<span class="fc" id="L3078">                    }</span>
<span class="fc" id="L3079">                    cs.add(See.only(winnerPlayer), settlement);</span>
                }
            }
        }
<span class="fc" id="L3083">    }</span>

    /**
     * Capture a unit.
     *
     * @param winner A &lt;code&gt;Unit&lt;/code&gt; that is capturing.
     * @param loser A &lt;code&gt;Unit&lt;/code&gt; to capture.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csCaptureUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3093">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3094">        StringTemplate loserNation = loserPlayer.getNationLabel();</span>
<span class="fc" id="L3095">        StringTemplate loserLocation = loser.getLocation()</span>
<span class="fc" id="L3096">            .getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3097">        StringTemplate oldName = loser.getLabel();</span>
<span class="fc" id="L3098">        String messageId = &quot;combat.unitCaptured.&quot;</span>
<span class="fc" id="L3099">            + loser.getType().getSuffix();</span>
<span class="fc" id="L3100">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3101">        StringTemplate winnerNation = winnerPlayer.getNationLabel();</span>
<span class="fc" id="L3102">        StringTemplate winnerLocation = winner.getLocation()</span>
<span class="fc" id="L3103">            .getLocationLabelFor(winnerPlayer);</span>

        // Capture the unit.  There are visibility implications for
        // both players because the captured unit might be the only
        // one on its tile, and the winner might have captured a unit
        // with greater line of sight.
<span class="fc" id="L3109">        Tile oldTile = loser.getTile();</span>
<span class="pc bpc" id="L3110" title="1 of 2 branches missed.">        ChangeType change = (winnerPlayer.isUndead()) ? ChangeType.UNDEAD</span>
            : ChangeType.CAPTURE;
<span class="pc bpc" id="L3112" title="1 of 2 branches missed.">        if (loserPlayer.csChangeOwner(loser, winnerPlayer, change,</span>
<span class="fc" id="L3113">                winner.getTile(), cs)) {//-vis(both)</span>
<span class="fc" id="L3114">            loser.setMovesLeft(0);</span>
<span class="fc" id="L3115">            loser.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3116">            cs.add(See.perhaps().always(loserPlayer), oldTile);</span>
            // Winner message post-capture when it owns the loser
<span class="fc" id="L3118">            cs.addMessage(See.only(winnerPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                    messageId, &quot;combat.unitCaptured&quot;, loser)
<span class="fc" id="L3121">                    .addStringTemplate(&quot;%nation%&quot;, loserNation)</span>
<span class="fc" id="L3122">                    .addStringTemplate(&quot;%unit%&quot;, oldName)</span>
<span class="fc" id="L3123">                    .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3124">                    .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3125">                    .addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
        }
<span class="fc" id="L3127">        cs.addMessage(See.only(loserPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
<span class="fc" id="L3129">                messageId, &quot;combat.unitCaptured&quot;, loser.getTile())</span>
<span class="fc" id="L3130">                .addStringTemplate(&quot;%nation%&quot;, loserNation)</span>
<span class="fc" id="L3131">                .addStringTemplate(&quot;%unit%&quot;, oldName)</span>
<span class="fc" id="L3132">                .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3133">                .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3134">               .addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="fc" id="L3135">        winnerPlayer.invalidateCanSeeTiles();//+vis(winnerPlayer)</span>
<span class="fc" id="L3136">        loserPlayer.invalidateCanSeeTiles();//+vis(loserPlayer)</span>
<span class="fc" id="L3137">    }</span>

    /**
     * Damages all ships in a colony in preparation for capture.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that is damaging.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to damage ships in.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageColonyShips(Unit attacker, Colony colony,
                                     ChangeSet cs) {
<span class="nc" id="L3148">        boolean captureRepairing = getSpecification()</span>
<span class="nc" id="L3149">            .getBoolean(GameOptions.CAPTURE_UNITS_UNDER_REPAIR);</span>
<span class="nc" id="L3150">        List&lt;Unit&gt; units = colony.getTile().getUnitList();</span>
<span class="nc bnc" id="L3151" title="All 2 branches missed.">        while (!units.isEmpty()) {</span>
<span class="nc" id="L3152">            Unit unit = units.remove(0);</span>
<span class="nc bnc" id="L3153" title="All 6 branches missed.">            if (unit.isNaval() &amp;&amp; !(captureRepairing &amp;&amp; unit.isDamaged())) {</span>
<span class="nc" id="L3154">                csDamageShipAttack(attacker, unit, cs);</span>
            }
<span class="nc" id="L3156">        }</span>
<span class="nc" id="L3157">    }</span>

    /**
     * Damage a ship through normal attack.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param ship The &lt;code&gt;Unit&lt;/code&gt; which is a ship to damage.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageShipAttack(Unit attacker, Unit ship, ChangeSet cs) {
<span class="fc" id="L3167">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3168">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3169">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="fc" id="L3170">        Location repair = ship.getRepairLocation();</span>
<span class="fc" id="L3171">        StringTemplate repairLoc = repair.getLocationLabelFor(shipPlayer);</span>
<span class="fc" id="L3172">        StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="fc" id="L3174">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.enemyShipDamaged&quot;, attacker)
<span class="fc" id="L3177">            .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3178">            .addStringTemplate(&quot;%enemyNation%&quot;, shipNation)</span>
<span class="fc" id="L3179">            .addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel()));</span>
<span class="fc" id="L3180">        cs.addMessage(See.only(shipPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.shipDamaged&quot;, ship)
<span class="fc" id="L3183">            .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="fc" id="L3184">            .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3185">            .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3186">            .addStringTemplate(&quot;%repairLocation%&quot;, repairLoc));</span>

<span class="fc" id="L3188">        csDamageShip(ship, repair, cs);</span>
<span class="fc" id="L3189">    }</span>

    /**
     * Damage a ship through bombard.
     *
     * @param settlement The attacker &lt;code&gt;Settlement&lt;/code&gt;.
     * @param ship The &lt;code&gt;Unit&lt;/code&gt; which is a ship to damage.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageShipBombard(Settlement settlement, Unit ship,
                                     ChangeSet cs) {
<span class="nc" id="L3200">        ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3201">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3202">        Location repair = ship.getRepairLocation();</span>
<span class="nc" id="L3203">        StringTemplate repairLoc = repair.getLocationLabelFor(shipPlayer);</span>
<span class="nc" id="L3204">        StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="nc" id="L3206">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.enemyShipDamagedByBombardment&quot;, settlement)
<span class="nc" id="L3209">            .addName(&quot;%colony%&quot;, settlement.getName())</span>
<span class="nc" id="L3210">            .addStringTemplate(&quot;%nation%&quot;, shipNation)</span>
<span class="nc" id="L3211">            .addStringTemplate(&quot;%unit%&quot;, ship.getLabel()));</span>
<span class="nc" id="L3212">        cs.addMessage(See.only(shipPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.shipDamagedByBombardment&quot;, ship)
<span class="nc" id="L3215">            .addName(&quot;%colony%&quot;, settlement.getName())</span>
<span class="nc" id="L3216">            .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3217">            .addStringTemplate(&quot;%repairLocation%&quot;, repairLoc));</span>

<span class="nc" id="L3219">        csDamageShip(ship, repair, cs);</span>
<span class="nc" id="L3220">    }</span>

    /**
     * Damage a ship.
     *
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to damage.
     * @param repair The &lt;code&gt;Location&lt;/code&gt; to send it to.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDamageShip(Unit ship, Location repair, ChangeSet cs) {
<span class="fc" id="L3230">        ServerPlayer player = (ServerPlayer) ship.getOwner();</span>

        // Lose the goods and units aboard
<span class="pc bpc" id="L3233" title="1 of 2 branches missed.">        for (Goods g : ship.getGoodsContainer().getCompactGoods()) {</span>
<span class="nc" id="L3234">            ship.remove(g);</span>
<span class="nc" id="L3235">        }</span>
<span class="fc bfc" id="L3236" title="All 2 branches covered.">        for (Unit u : ship.getUnitList()) {</span>
<span class="fc" id="L3237">            ship.remove(u);</span>
<span class="fc" id="L3238">            cs.addRemove(See.only(player), null, u);//-vis: safe, within unit</span>
<span class="fc" id="L3239">            u.dispose();</span>
<span class="fc" id="L3240">        }</span>

        // Damage the ship and send it off for repair
<span class="pc bpc" id="L3243" title="1 of 2 branches missed.">        Location shipLoc = (repair instanceof Colony) ? repair.getTile()</span>
            : repair;
<span class="fc" id="L3245">        ship.setHitPoints(1);</span>
<span class="fc" id="L3246">        ship.setDestination(null);</span>
<span class="fc" id="L3247">        ship.setLocation(shipLoc);//-vis(player)</span>
<span class="fc" id="L3248">        ship.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3249">        ship.setMovesLeft(0);</span>
<span class="fc" id="L3250">        cs.add(See.only(player), (FreeColGameObject)shipLoc);</span>
<span class="fc" id="L3251">        player.invalidateCanSeeTiles();//+vis(player)</span>
<span class="fc" id="L3252">    }</span>

    /**
     * Demotes a unit.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that won.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that lost and should be demoted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDemoteUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3262">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3263">        StringTemplate loserNation = loser.getApparentOwnerName();</span>
<span class="fc" id="L3264">        StringTemplate loserLocation = loser.getLocation()</span>
<span class="fc" id="L3265">            .getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3266">        StringTemplate oldName = loser.getLabel();</span>
<span class="fc" id="L3267">        String messageId = &quot;combat.unitDemoted.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3268">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3269">        StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3270">        StringTemplate winnerLocation = winner.getLocation()</span>
<span class="fc" id="L3271">            .getLocationLabelFor(winnerPlayer);</span>

<span class="fc" id="L3273">        UnitType type = loser.getTypeChange(ChangeType.DEMOTION, loserPlayer);</span>
<span class="pc bpc" id="L3274" title="2 of 4 branches missed.">        if (type == null || type == loser.getType()) {</span>
<span class="nc bnc" id="L3275" title="All 2 branches missed.">            logger.warning(&quot;Demotion failed, type=&quot;</span>
                + ((type == null) ? &quot;null&quot; : &quot;same type: &quot; + type));
<span class="nc" id="L3277">            return;</span>
        }
<span class="fc" id="L3279">        loser.changeType(type);//-vis(loserPlayer)</span>
<span class="fc" id="L3280">        loserPlayer.invalidateCanSeeTiles();//+vis(loserPlayer)</span>

<span class="fc" id="L3282">        cs.addMessage(See.only(winnerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                messageId, &quot;combat.unitDemoted&quot;, winner)
<span class="fc" id="L3285">            .addStringTemplate(&quot;%nation%&quot;, loserNation)</span>
<span class="fc" id="L3286">            .addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3287">            .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3288">            .addStringTemplate(&quot;%enemyNation%&quot;, winnerPlayer.getNationLabel())</span>
<span class="fc" id="L3289">            .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3290">            .addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
<span class="fc" id="L3291">        cs.addMessage(See.only(loserPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                messageId, &quot;combat.unitDemoted&quot;, loser)
<span class="fc" id="L3294">            .addStringTemplate(&quot;%nation%&quot;, loserPlayer.getNationLabel())</span>
<span class="fc" id="L3295">            .addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3296">            .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3297">            .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3298">            .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3299">            .addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="fc" id="L3300">    }</span>

    /**
     * Destroy a colony.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; that was attacked.
     * @param random A pseudo-random number source.
     * @param cs The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDestroyColony(Unit attacker, Colony colony, Random random,
                                 ChangeSet cs) {
<span class="fc" id="L3312">        Game game = attacker.getGame();</span>
<span class="fc" id="L3313">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3314">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3315">        ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L3316">        StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>
<span class="fc" id="L3317">        int plunder = colony.getPlunder(attacker, random);</span>

        // Handle history and messages before colony destruction.
<span class="fc" id="L3320">        cs.addHistory(colonyPlayer,</span>
<span class="fc" id="L3321">            new HistoryEvent(game.getTurn(),</span>
                HistoryEvent.HistoryEventType.COLONY_DESTROYED, attackerPlayer)
<span class="fc" id="L3323">            .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="fc" id="L3324">            .addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L3325">        cs.addMessage(See.only(colonyPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
<span class="fc" id="L3327">                &quot;combat.colonyBurning&quot;, colony.getTile())</span>
<span class="fc" id="L3328">            .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3329">            .addAmount(&quot;%amount%&quot;, plunder)</span>
<span class="fc" id="L3330">            .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="fc" id="L3331">            .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel()));</span>
<span class="fc" id="L3332">        cs.addMessage(See.all().except(colonyPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.enemyColonyBurning&quot;, colonyPlayer)
<span class="fc" id="L3335">            .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3336">            .addStringTemplate(&quot;%nation%&quot;, colonyNation)</span>
<span class="fc" id="L3337">            .addStringTemplate(&quot;%attackerNation%&quot;, attackerNation));</span>
<span class="fc" id="L3338">        colonyPlayer.csLoseLocation(colony, cs);</span>

        // Allocate some plunder.
<span class="pc bpc" id="L3341" title="1 of 2 branches missed.">        if (plunder &gt; 0) {</span>
<span class="nc" id="L3342">            attackerPlayer.modifyGold(plunder);</span>
<span class="nc" id="L3343">            colonyPlayer.modifyGold(-plunder);</span>
<span class="nc" id="L3344">            cs.addPartial(See.only(attackerPlayer), attackerPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3345">            cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
        }

        // Dispose of the colony and its contents.
<span class="fc" id="L3349">        csDisposeSettlement(colony, cs);</span>
<span class="fc" id="L3350">    }</span>

    /**
     * Destroys an Indian settlement.
     *
     * @param attacker an &lt;code&gt;Unit&lt;/code&gt; value
     * @param settlement an &lt;code&gt;IndianSettlement&lt;/code&gt; value
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csDestroySettlement(Unit attacker,
                                     IndianSettlement settlement,
                                     Random random, ChangeSet cs) {
<span class="nc" id="L3363">        final Game game = getGame();</span>
<span class="nc" id="L3364">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L3365">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L3366">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L3367">        ServerPlayer nativePlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3368">        StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="nc" id="L3369">        StringTemplate nativeNation = nativePlayer.getNationLabel();</span>
<span class="nc" id="L3370">        String settlementName = settlement.getName();</span>
<span class="nc" id="L3371">        boolean capital = settlement.isCapital();</span>
<span class="nc" id="L3372">        int plunder = settlement.getPlunder(attacker, random);</span>

        // Remaining units lose their home.
<span class="nc bnc" id="L3375" title="All 2 branches missed.">        for (Unit u : settlement.getOwnedUnits()) {</span>
<span class="nc" id="L3376">            u.setHomeIndianSettlement(null);</span>
<span class="nc" id="L3377">            cs.add(See.only(nativePlayer), u);</span>
<span class="nc" id="L3378">        }</span>
                
        // Destroy the settlement, update settlement tiles.
<span class="nc" id="L3381">        csDisposeSettlement(settlement, cs);</span>

        // Make the treasure train if there is treasure.
<span class="nc bnc" id="L3384" title="All 2 branches missed.">        if (plunder &gt; 0) {</span>
<span class="nc" id="L3385">            List&lt;UnitType&gt; unitTypes</span>
<span class="nc" id="L3386">                = spec.getUnitTypesWithAbility(Ability.CARRY_TREASURE);</span>
<span class="nc" id="L3387">            UnitType type = getRandomMember(logger, &quot;Choose train&quot;,</span>
                                            unitTypes, random);
<span class="nc" id="L3389">            Unit train = new ServerUnit(game, tile, attackerPlayer,</span>
                                        type);//-vis: safe, attacker on tile
<span class="nc" id="L3391">            train.setTreasureAmount(plunder);</span>
        }

        // This is an atrocity.
<span class="nc" id="L3395">        int score = spec.getInteger(GameOptions.DESTROY_SETTLEMENT_SCORE);</span>
<span class="nc" id="L3396">        HistoryEvent h = new HistoryEvent(game.getTurn(),</span>
            HistoryEvent.HistoryEventType.DESTROY_SETTLEMENT, this)
<span class="nc" id="L3398">            .addStringTemplate(&quot;%nation%&quot;, nativeNation)</span>
<span class="nc" id="L3399">            .addName(&quot;%settlement%&quot;, settlementName);</span>
<span class="nc" id="L3400">        h.setScore(score);</span>
<span class="nc" id="L3401">        cs.addHistory(attackerPlayer, h);</span>

        // Finish with messages and history.
<span class="nc" id="L3404">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                             &quot;combat.indianTreasure&quot;, attacker)
<span class="nc" id="L3407">                .addName(&quot;%settlement%&quot;, settlementName)</span>
<span class="nc" id="L3408">                .addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="nc bnc" id="L3409" title="All 2 branches missed.">        if (capital) {</span>
<span class="nc" id="L3410">            cs.addMessage(See.only(attackerPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                                 &quot;combat.nativeCapitalBurned&quot;, attacker)
<span class="nc" id="L3413">                    .addName(&quot;%name%&quot;, settlementName)</span>
<span class="nc" id="L3414">                    .addStringTemplate(&quot;%nation%&quot;, nativeNation));</span>
        }
<span class="nc bnc" id="L3416" title="All 2 branches missed.">        if (nativePlayer.checkForDeath() == IS_DEAD) {</span>
<span class="nc" id="L3417">            h = new HistoryEvent(game.getTurn(),</span>
                HistoryEvent.HistoryEventType.DESTROY_NATION, this)
<span class="nc" id="L3419">                .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="nc" id="L3420">                .addStringTemplate(&quot;%nativeNation%&quot;, nativeNation);</span>
<span class="nc" id="L3421">            h.setScore(SCORE_NATION_DESTROYED);</span>
<span class="nc" id="L3422">            cs.addGlobalHistory(game, h);</span>
        }
<span class="nc" id="L3424">        cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;,</span>
            &quot;sound.event.destroySettlement&quot;);
<span class="nc" id="L3426">    }</span>

    /**
     * Disposes of a settlement and reassign its tiles.
     *
     * +vis,til: Resolves the whole mess.
     *
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; under attack.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csDisposeSettlement(Settlement settlement, ChangeSet cs) {
<span class="fc" id="L3437">        logger.finest(&quot;Disposing of &quot; + settlement.getName());</span>
<span class="fc" id="L3438">        ServerPlayer owner = (ServerPlayer)settlement.getOwner();</span>
<span class="fc" id="L3439">        Set&lt;Tile&gt; owned = settlement.getOwnedTiles();</span>
<span class="fc bfc" id="L3440" title="All 2 branches covered.">        for (Tile t : owned) t.cacheUnseen();//+til</span>
<span class="fc" id="L3441">        Tile centerTile = settlement.getTile();</span>
<span class="fc" id="L3442">        ServerPlayer missionaryOwner = null;</span>
<span class="fc" id="L3443">        int radius = 0;</span>

        // Get rid of the any missionary first.
<span class="pc bpc" id="L3446" title="1 of 2 branches missed.">        if (settlement instanceof ServerIndianSettlement) {</span>
<span class="nc" id="L3447">            ServerIndianSettlement sis = (ServerIndianSettlement)settlement;</span>
<span class="nc bnc" id="L3448" title="All 2 branches missed.">            if (sis.hasMissionary()) {</span>
<span class="nc" id="L3449">                missionaryOwner = (ServerPlayer)sis.getMissionary().getOwner();</span>
<span class="nc" id="L3450">                radius = sis.getMissionaryLineOfSight();</span>
<span class="nc" id="L3451">                sis.csKillMissionary(true, cs);</span>
            }
        }
            
        // Get it off the map and off the owners list.
<span class="fc" id="L3456">        settlement.exciseSettlement();//-vis(owner),-til</span>
<span class="fc" id="L3457">        owner.removeSettlement(settlement);</span>
<span class="pc bpc" id="L3458" title="1 of 2 branches missed.">        if (owner.hasSettlement(settlement)) {</span>
<span class="nc" id="L3459">            throw new IllegalStateException(&quot;Still has settlement: &quot;</span>
                + settlement);
        }

        // Reassign the tiles owned by the settlement, if possible
<span class="fc" id="L3464">        reassignTiles(owned, owner, null);</span>

<span class="fc" id="L3466">        See vis = See.perhaps().always(owner);</span>
<span class="pc bpc" id="L3467" title="1 of 2 branches missed.">        if (missionaryOwner != null) vis.except(missionaryOwner);</span>
<span class="fc" id="L3468">        cs.add(vis, owned);</span>
<span class="fc" id="L3469">        cs.addRemove(vis, centerTile, settlement);//-vis(owner)</span>
<span class="fc" id="L3470">        settlement.dispose();</span>
<span class="fc" id="L3471">        owner.invalidateCanSeeTiles();//+vis(owner)</span>

        // Former missionary owner knows that the settlement fell.
<span class="pc bpc" id="L3474" title="1 of 2 branches missed.">        if (missionaryOwner != null) {</span>
<span class="nc" id="L3475">            List&lt;Tile&gt; surrounding = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L3476" title="All 2 branches missed.">            for (Tile t : centerTile.getSurroundingTiles(1, radius)) {</span>
<span class="nc bnc" id="L3477" title="All 2 branches missed.">                if (!owned.contains(t)) surrounding.add(t);</span>
<span class="nc" id="L3478">            }</span>
<span class="nc" id="L3479">            cs.add(See.only(missionaryOwner), owned);</span>
<span class="nc" id="L3480">            cs.add(See.only(missionaryOwner), surrounding);</span>
<span class="nc" id="L3481">            cs.addRemove(See.only(missionaryOwner), centerTile, settlement);</span>
<span class="nc" id="L3482">            missionaryOwner.invalidateCanSeeTiles();//+vis(missionaryOwner)</span>
<span class="nc bnc" id="L3483" title="All 2 branches missed.">            for (Tile t : surrounding) t.cacheUnseen(missionaryOwner);</span>
        }

        // Recache, should only show now cleared tiles to former owner.
<span class="fc bfc" id="L3487" title="All 2 branches covered.">        for (Tile t : owned) t.cacheUnseen();</span>
        // Center tile is special for native settlements.  Because
        // native settlement tiles are *always* cached, the cache
        // needs to be completely cleared for players that can see the
        // settlement is gone.
<span class="pc bpc" id="L3492" title="1 of 2 branches missed.">        if (settlement instanceof IndianSettlement) centerTile.seeTile();</span>
<span class="pc bpc" id="L3493" title="1 of 2 branches missed.">        if (missionaryOwner != null) centerTile.seeTile(missionaryOwner);</span>
<span class="fc" id="L3494">    }</span>

    /**
     * Evade a normal attack.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param defender A naval &lt;code&gt;Unit&lt;/code&gt; that evades the attacker.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csEvadeAttack(Unit attacker, Unit defender, ChangeSet cs) {
<span class="nc" id="L3504">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L3505">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="nc" id="L3506">        ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="nc" id="L3507">        StringTemplate defenderNation = defender.getApparentOwnerName();</span>

<span class="nc" id="L3509">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.enemyShipEvaded&quot;, attacker)
<span class="nc" id="L3512">            .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="nc" id="L3513">            .addStringTemplate(&quot;%enemyUnit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3514">            .addStringTemplate(&quot;%enemyNation%&quot;, defenderNation));</span>
<span class="nc" id="L3515">        cs.addMessage(See.only(defenderPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.shipEvaded&quot;, defender)
<span class="nc" id="L3518">            .addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3519">            .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel())</span>
<span class="nc" id="L3520">            .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation));</span>
<span class="nc" id="L3521">    }</span>

    /**
     * Evade a bombardment.
     *
     * @param settlement The attacker &lt;code&gt;Settlement&lt;/code&gt;.
     * @param defender A naval &lt;code&gt;Unit&lt;/code&gt; that evades the attacker.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csEvadeBombard(Settlement settlement, Unit defender,
                                ChangeSet cs) {
<span class="nc" id="L3532">        ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3533">        ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="nc" id="L3534">        StringTemplate defenderNation = defender.getApparentOwnerName();</span>

<span class="nc" id="L3536">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.shipEvadedBombardment&quot;, settlement)
<span class="nc" id="L3539">            .addName(&quot;%colony%&quot;, settlement.getName())</span>
<span class="nc" id="L3540">            .addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3541">            .addStringTemplate(&quot;%nation%&quot;, defenderNation));</span>
<span class="nc" id="L3542">        cs.addMessage(See.only(defenderPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.shipEvadedBombardment&quot;, defender)
<span class="nc" id="L3545">            .addName(&quot;%colony%&quot;, settlement.getName())</span>
<span class="nc" id="L3546">            .addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3547">            .addStringTemplate(&quot;%nation%&quot;, defenderNation));</span>
<span class="nc" id="L3548">    }</span>

    /**
     * Loot a ship.
     *
     * @param winner The winning naval &lt;code&gt;Unit&lt;/code&gt;.
     * @param loser The losing naval &lt;code&gt;Unit&lt;/code&gt;
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLootShip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3558">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3559">        List&lt;Goods&gt; capture = loser.getGoodsList();</span>
<span class="pc bpc" id="L3560" title="2 of 4 branches missed.">        if (!capture.isEmpty() &amp;&amp; winner.hasSpaceLeft()) {</span>
<span class="fc bfc" id="L3561" title="All 2 branches covered.">            for (Goods g : capture) g.setLocation(null);</span>
<span class="fc" id="L3562">            new LootSession(winner, loser, capture);</span>
<span class="fc" id="L3563">            cs.add(See.only(winnerPlayer), ChangeSet.ChangePriority.CHANGE_LATE,</span>
<span class="fc" id="L3564">                new LootCargoMessage(winner, loser.getId(), capture));</span>
        }
<span class="fc" id="L3566">        loser.getGoodsContainer().removeAll();</span>
<span class="fc" id="L3567">        loser.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3568">    }</span>

    /**
     * Unit auto equips but loses equipment.
     *
     * @param attacker The &lt;code&gt;Unit&lt;/code&gt; that attacked.
     * @param defender The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLoseAutoEquip(Unit attacker, Unit defender, ChangeSet cs) {
<span class="fc" id="L3578">        ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="fc" id="L3579">        StringTemplate defenderNation = defenderPlayer.getNationLabel();</span>
<span class="fc" id="L3580">        Settlement settlement = defender.getSettlement();</span>
<span class="fc" id="L3581">        StringTemplate defenderLocation = defender.getLocation()</span>
<span class="fc" id="L3582">            .getLocationLabelFor(defenderPlayer);</span>
<span class="fc" id="L3583">        Role role = defender.getAutomaticRole();</span>
<span class="fc" id="L3584">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3585">        StringTemplate attackerLocation = attacker.getLocation()</span>
<span class="fc" id="L3586">            .getLocationLabelFor(attackerPlayer);</span>
<span class="fc" id="L3587">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>

        // Autoequipment is not actually with the unit, it is stored
        // in the settlement of the unit.  Remove it from there.
<span class="fc bfc" id="L3591" title="All 2 branches covered.">        for (AbstractGoods ag : role.getRequiredGoods()) {</span>
<span class="fc" id="L3592">            settlement.removeGoods(ag);</span>
<span class="fc" id="L3593">        }</span>

<span class="fc" id="L3595">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.unitWinColony&quot;, attacker)
<span class="fc" id="L3598">            .addStringTemplate(&quot;%location%&quot;, attackerLocation)</span>
<span class="fc" id="L3599">            .addStringTemplate(&quot;%nation%&quot;, attackerPlayer.getNationLabel())</span>
<span class="fc" id="L3600">            .addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3601">            .addStringTemplate(&quot;%settlement%&quot;,</span>
<span class="fc" id="L3602">                settlement.getLocationLabelFor(attackerPlayer))</span>
<span class="fc" id="L3603">            .addStringTemplate(&quot;%enemyNation%&quot;, defenderNation)</span>
<span class="fc" id="L3604">            .addStringTemplate(&quot;%enemyUnit%&quot;, defender.getLabel()));</span>
<span class="fc" id="L3605">        cs.addMessage(See.only(defenderPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.unitLoseAutoEquip&quot;, defender)
<span class="fc" id="L3608">            .addStringTemplate(&quot;%location%&quot;, defenderLocation)</span>
<span class="fc" id="L3609">            .addStringTemplate(&quot;%nation%&quot;, defenderNation)</span>
<span class="fc" id="L3610">            .addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="fc" id="L3611">            .addStringTemplate(&quot;%settlement%&quot;,</span>
<span class="fc" id="L3612">                settlement.getLocationLabelFor(defenderPlayer))</span>
<span class="fc" id="L3613">            .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3614">            .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
<span class="fc" id="L3615">    }</span>

    /**
     * Unit drops some equipment.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that won.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; that lost and loses equipment.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLoseEquip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3625">        final Specification spec = getSpecification();</span>
<span class="fc" id="L3626">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3627">        StringTemplate loserNation = loserPlayer.getNationLabel();</span>
<span class="fc" id="L3628">        StringTemplate loserLocation = loser.getLocation()</span>
<span class="fc" id="L3629">            .getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3630">        StringTemplate oldName = loser.getLabel();</span>
<span class="fc" id="L3631">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3632">        StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3633">        StringTemplate winnerLocation = winner.getLocation()</span>
<span class="fc" id="L3634">            .getLocationLabelFor(winnerPlayer);</span>
<span class="fc" id="L3635">        Role role = loser.getRole();</span>

<span class="fc" id="L3637">        Role downgrade = role.getDowngrade();</span>
<span class="fc bfc" id="L3638" title="All 2 branches covered.">        if (downgrade != null) {</span>
<span class="fc" id="L3639">            loser.changeRole(downgrade, 1);</span>
        } else {
<span class="fc" id="L3641">            loser.changeRole(spec.getDefaultRole(), 0);</span>
        }

        // Account for possible loss of mobility due to horses going away.
<span class="fc" id="L3645">        loser.setMovesLeft(Math.min(loser.getMovesLeft(),</span>
<span class="fc" id="L3646">                                    loser.getInitialMovesLeft()));</span>

        String messageId;
<span class="fc bfc" id="L3649" title="All 2 branches covered.">        if (!loser.isArmed()) {</span>
<span class="fc" id="L3650">            messageId = &quot;combat.unitDemotedToUnarmed&quot;;</span>
<span class="fc" id="L3651">            loser.setState(Unit.UnitState.ACTIVE);</span>
        } else {
<span class="fc" id="L3653">            messageId = loser.getType().getId() + &quot;.demoted&quot;;</span>
        }

<span class="fc" id="L3656">        cs.addMessage(See.only(winnerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                messageId, &quot;combat.unitDemoted&quot;, winner)
<span class="fc" id="L3659">            .addStringTemplate(&quot;%nation%&quot;, loserNation)</span>
<span class="fc" id="L3660">            .addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3661">            .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3662">            .addStringTemplate(&quot;%enemyNation%&quot;, winnerPlayer.getNationLabel())</span>
<span class="fc" id="L3663">            .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3664">            .addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
<span class="fc" id="L3665">        cs.addMessage(See.only(loserPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                messageId, &quot;combat.unitDemoted&quot;, loser)
<span class="fc" id="L3668">            .addStringTemplate(&quot;%nation%&quot;, loserNation)</span>
<span class="fc" id="L3669">            .addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3670">            .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3671">            .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3672">            .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3673">            .addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="fc" id="L3674">    }</span>

    /**
     * Hook for when a player loses access to a location for whatever
     * reason.  Useful for disabling trade routes.
     *
     * @param loc The &lt;code&gt;Location&lt;/code&gt; that was lost.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csLoseLocation(Location loc, ChangeSet cs) {
<span class="pc bpc" id="L3684" title="1 of 2 branches missed.">        for (TradeRoute tr : getTradeRoutes()) {</span>
<span class="nc" id="L3685">            boolean suspend = false;</span>
<span class="nc" id="L3686">            Iterator&lt;TradeRouteStop&gt; trsi = tr.getStops().iterator();</span>
<span class="nc bnc" id="L3687" title="All 2 branches missed.">            while (trsi.hasNext()) {</span>
<span class="nc" id="L3688">                TradeRouteStop trs = trsi.next();</span>
<span class="nc bnc" id="L3689" title="All 2 branches missed.">                if (Map.isSameLocation(trs.getLocation(), loc)) {</span>
<span class="nc" id="L3690">                    suspend = true;</span>
<span class="nc" id="L3691">                    trsi.remove();</span>
                }
<span class="nc" id="L3693">            }</span>
<span class="nc bnc" id="L3694" title="All 2 branches missed.">            if (suspend) {</span>
<span class="nc bnc" id="L3695" title="All 2 branches missed.">                for (Unit u : tr.getAssignedUnits()) {</span>
<span class="nc" id="L3696">                    u.setTradeRoute(null);</span>
<span class="nc" id="L3697">                    cs.add(See.only(this), u);</span>
<span class="nc" id="L3698">                }</span>
<span class="nc" id="L3699">                cs.addMessage(See.only(this),</span>
                        new ModelMessage(ModelMessage.MessageType.GOODS_MOVEMENT,
                            &quot;combat.tradeRouteSuspended&quot;, this)
<span class="nc" id="L3702">                    .addName(&quot;%route%&quot;, tr.getName())</span>
<span class="nc" id="L3703">                    .addStringTemplate(&quot;%stop%&quot;, loc.getLocationLabel()));</span>
<span class="nc" id="L3704">                cs.add(See.only(this), tr);</span>
            }
<span class="nc" id="L3706">        }</span>
<span class="fc" id="L3707">    }</span>

    /**
     * Damage a building or a ship or steal some goods or gold.
     *
     * @param attacker The attacking &lt;code&gt;Unit&lt;/code&gt;.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to pillage.
     * @param random A pseudo-random number source.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csPillageColony(Unit attacker, Colony colony,
                                 Random random, ChangeSet cs) {
<span class="fc" id="L3719">        ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3720">        StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3721">        ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L3722">        StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>

        // Collect the damagable buildings, ships, movable goods.
<span class="fc" id="L3725">        List&lt;Building&gt; buildingList = colony.getBurnableBuildings();</span>
<span class="fc" id="L3726">        List&lt;Unit&gt; shipList = colony.getTile().getNavalUnits();</span>
<span class="fc" id="L3727">        List&lt;Goods&gt; goodsList = colony.getLootableGoodsList();</span>

        // Pick one, with one extra choice for stealing gold.
<span class="fc" id="L3730">        int pillage = randomInt(logger, &quot;Pillage choice&quot;, random,</span>
<span class="fc" id="L3731">            buildingList.size() + shipList.size() + goodsList.size()</span>
<span class="fc bfc" id="L3732" title="All 2 branches covered.">            + ((colony.canBePlundered()) ? 1 : 0));</span>
<span class="fc bfc" id="L3733" title="All 2 branches covered.">        if (pillage &lt; buildingList.size()) {</span>
<span class="fc" id="L3734">            Building building = buildingList.get(pillage);</span>
<span class="fc" id="L3735">            csDamageBuilding(building, cs);</span>
<span class="fc" id="L3736">            cs.addMessage(See.only(colonyPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                    &quot;combat.buildingDamaged&quot;, colony)
<span class="fc" id="L3739">                .addNamed(&quot;%building%&quot;, building)</span>
<span class="fc" id="L3740">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3741">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3742">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
<span class="fc bfc" id="L3743" title="All 2 branches covered.">        } else if (pillage &lt; buildingList.size() + shipList.size()) {</span>
<span class="fc" id="L3744">            Unit ship = shipList.get(pillage - buildingList.size());</span>
<span class="pc bpc" id="L3745" title="1 of 2 branches missed.">            if (ship.getRepairLocation() == null) {</span>
<span class="nc" id="L3746">                csSinkShipAttack(attacker, ship, cs);</span>
            } else {
<span class="fc" id="L3748">                csDamageShipAttack(attacker, ship, cs);</span>
            }
<span class="fc" id="L3750">        } else if (pillage &lt; buildingList.size() + shipList.size()</span>
<span class="fc bfc" id="L3751" title="All 2 branches covered.">                   + goodsList.size()) {</span>
<span class="fc" id="L3752">            Goods goods = goodsList.get(pillage - buildingList.size()</span>
<span class="fc" id="L3753">                - shipList.size());</span>
<span class="fc" id="L3754">            goods.setAmount(Math.min(goods.getAmount() / 2, 50));</span>
<span class="fc" id="L3755">            colony.removeGoods(goods);</span>
<span class="pc bpc" id="L3756" title="1 of 2 branches missed.">            if (attacker.canAdd(goods)) attacker.add(goods);</span>
<span class="fc" id="L3757">            cs.addMessage(See.only(colonyPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                    &quot;combat.goodsStolen&quot;, colony, goods)
<span class="fc" id="L3760">                .addAmount(&quot;%amount%&quot;, goods.getAmount())</span>
<span class="fc" id="L3761">                .addNamed(&quot;%goods%&quot;, goods.getType())</span>
<span class="fc" id="L3762">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3763">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3764">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>

<span class="fc" id="L3766">        } else {</span>
<span class="fc" id="L3767">            int plunder = Math.max(1, colony.getPlunder(attacker, random) / 5);</span>
<span class="fc" id="L3768">            colonyPlayer.modifyGold(-plunder);</span>
<span class="fc" id="L3769">            attackerPlayer.modifyGold(plunder);</span>
<span class="fc" id="L3770">            cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L3771">            cs.addMessage(See.only(colonyPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                    &quot;combat.indianPlunder&quot;, colony)
<span class="fc" id="L3774">                .addAmount(&quot;%amount%&quot;, plunder)</span>
<span class="fc" id="L3775">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3776">                .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3777">                .addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
        }
<span class="fc" id="L3779">        cs.addMessage(See.all().except(colonyPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.indianRaid&quot;, colonyPlayer)
<span class="fc" id="L3782">            .addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="fc" id="L3783">            .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3784">            .addStringTemplate(&quot;%colonyNation%&quot;, colonyNation));</span>
<span class="fc" id="L3785">    }</span>

    /**
     * Damage a building in a colony by downgrading it if possible and
     * destroying it otherwise.
     *
     * This is called as a result of pillaging, which always updates
     * the colony tile.
     *
     * @param building The &lt;code&gt;Building&lt;/code&gt; to damage.
     * @param cs a &lt;code&gt;ChangeSet&lt;/code&gt; value
     */
    private void csDamageBuilding(Building building, ChangeSet cs) {
<span class="fc" id="L3798">        ServerColony colony = (ServerColony)building.getColony();</span>
<span class="fc" id="L3799">        Tile copied = colony.getTile().getTileToCache();</span>
<span class="fc" id="L3800">        boolean changed = false;</span>
<span class="fc" id="L3801">        BuildingType type = building.getType();</span>
<span class="pc bpc" id="L3802" title="1 of 2 branches missed.">        if (type.getUpgradesFrom() == null) {</span>
<span class="fc" id="L3803">            changed = colony.ejectUnits(building, building.getUnitList());//-til</span>
<span class="fc" id="L3804">            colony.destroyBuilding(building);//-til</span>
<span class="fc" id="L3805">            changed |= building.getType().isDefenceType();</span>
<span class="fc" id="L3806">            cs.addRemove(See.only((ServerPlayer)colony.getOwner()), colony, </span>
                         building);//-vis: safe, buildings are ok
<span class="fc" id="L3808">            building.dispose();</span>
            // Have any abilities been removed that gate other production,
            // e.g. removing docks should shut down fishing.
<span class="fc bfc" id="L3811" title="All 2 branches covered.">            for (WorkLocation wl : colony.getAllWorkLocations()) {</span>
<span class="pc bpc" id="L3812" title="1 of 4 branches missed.">                if (!wl.isEmpty() &amp;&amp; !wl.canBeWorked()) {</span>
<span class="nc" id="L3813">                    changed |= colony.ejectUnits(wl, wl.getUnitList());//-til</span>
<span class="nc" id="L3814">                    logger.info(&quot;Units ejected from workLocation &quot;</span>
<span class="nc" id="L3815">                        + wl.getId() + &quot; on loss of &quot;</span>
<span class="nc" id="L3816">                        + building.getType().getSuffix());</span>
                }
<span class="fc" id="L3818">            }</span>
<span class="nc bnc" id="L3819" title="All 2 branches missed.">        } else if (building.canBeDamaged()) {</span>
<span class="nc" id="L3820">            changed = colony.ejectUnits(building, building.downgrade());//-til</span>
<span class="nc" id="L3821">            changed |= building.getType().isDefenceType();</span>
        } else {
<span class="nc" id="L3823">            return;</span>
        }
<span class="pc bpc" id="L3825" title="1 of 2 branches missed.">        if (changed) colony.getTile().cacheUnseen(copied);//+til</span>
<span class="pc bpc" id="L3826" title="1 of 2 branches missed.">        if (isAI()) {</span>
<span class="fc" id="L3827">            colony.firePropertyChange(Colony.REARRANGE_WORKERS, true, false);</span>
        }
<span class="fc" id="L3829">    }</span>


    /**
     * Promotes a unit.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that won and should be promoted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csPromoteUnit(Unit winner, ChangeSet cs) {
<span class="fc" id="L3839">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3840">        StringTemplate winnerNation = winnerPlayer.getNationLabel();</span>
<span class="fc" id="L3841">        StringTemplate oldName = winner.getLabel();</span>

<span class="fc" id="L3843">        UnitType type = winner.getTypeChange(ChangeType.PROMOTION,</span>
                                             winnerPlayer);
<span class="pc bpc" id="L3845" title="2 of 4 branches missed.">        if (type == null || type == winner.getType()) {</span>
<span class="nc bnc" id="L3846" title="All 2 branches missed.">            logger.warning(&quot;Promotion failed, type=&quot;</span>
                + ((type == null) ? &quot;null&quot; : &quot;same type: &quot; + type));
<span class="nc" id="L3848">            return;</span>
        }
<span class="fc" id="L3850">        winner.changeType(type);//-vis(winnerPlayer)</span>
<span class="fc" id="L3851">        winnerPlayer.invalidateCanSeeTiles();//+vis(winnerPlayer)</span>

<span class="fc" id="L3853">        cs.addMessage(See.only(winnerPlayer),</span>
                      new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                          &quot;combat.unitPromoted&quot;, winner)
<span class="fc" id="L3856">            .addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3857">            .addStringTemplate(&quot;%unit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3858">            .addStringTemplate(&quot;%nation%&quot;, winnerNation));</span>
<span class="fc" id="L3859">    }</span>

    /**
     * Sinks all ships in a colony.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to sink ships in.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkColonyShips(Unit attacker, Colony colony, ChangeSet cs) {
<span class="nc" id="L3869">        boolean captureRepairing = getSpecification()</span>
<span class="nc" id="L3870">            .getBoolean(GameOptions.CAPTURE_UNITS_UNDER_REPAIR);</span>
<span class="nc" id="L3871">        List&lt;Unit&gt; units = colony.getTile().getUnitList();</span>
<span class="nc bnc" id="L3872" title="All 2 branches missed.">        while (!units.isEmpty()) {</span>
<span class="nc" id="L3873">            Unit unit = units.remove(0);</span>
<span class="nc bnc" id="L3874" title="All 6 branches missed.">            if (unit.isNaval() &amp;&amp; !(captureRepairing &amp;&amp; unit.isDamaged())) {</span>
<span class="nc" id="L3875">                csSinkShipAttack(attacker, unit, cs);</span>
            }
<span class="nc" id="L3877">        }</span>
<span class="nc" id="L3878">    }</span>

    /**
     * Sinks this ship as result of a normal attack.
     *
     * @param attacker The attacker &lt;code&gt;Unit&lt;/code&gt;.
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkShipAttack(Unit attacker, Unit ship, ChangeSet cs) {
<span class="nc" id="L3888">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3889">        StringTemplate shipNation = ship.getApparentOwnerName();</span>
<span class="nc" id="L3890">        Unit attackerUnit = attacker;</span>
<span class="nc" id="L3891">        ServerPlayer attackerPlayer = (ServerPlayer) attackerUnit.getOwner();</span>
<span class="nc" id="L3892">        StringTemplate attackerNation = attackerUnit.getApparentOwnerName();</span>

<span class="nc" id="L3894">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.enemyShipSunk&quot;, attackerUnit)
<span class="nc" id="L3897">            .addStringTemplate(&quot;%unit%&quot;, attackerUnit.getLabel())</span>
<span class="nc" id="L3898">            .addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3899">            .addStringTemplate(&quot;%enemyNation%&quot;, shipNation));</span>
<span class="nc" id="L3900">        cs.addMessage(See.only(shipPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
<span class="nc" id="L3902">                &quot;combat.shipSunk&quot;, ship.getTile())</span>
<span class="nc" id="L3903">            .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3904">            .addStringTemplate(&quot;%enemyUnit%&quot;, attackerUnit.getLabel())</span>
<span class="nc" id="L3905">            .addStringTemplate(&quot;%enemyNation%&quot;, attackerNation));</span>

<span class="nc" id="L3907">        csSinkShip(ship, attackerPlayer, cs);</span>
<span class="nc" id="L3908">    }</span>

    /**
     * Sinks this ship as result of a bombard.
     *
     * @param settlement The bombarding &lt;code&gt;Settlement&lt;/code&gt;.
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkShipBombard(Settlement settlement, Unit ship,
                                   ChangeSet cs) {
<span class="nc" id="L3919">        ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3920">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3921">        StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="nc" id="L3923">        cs.addMessage(See.only(attackerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                &quot;combat.shipSunkByBombardment&quot;, settlement)
<span class="nc" id="L3926">            .addName(&quot;%colony%&quot;, settlement.getName())</span>
<span class="nc" id="L3927">            .addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3928">            .addStringTemplate(&quot;%nation%&quot;, shipNation));</span>
<span class="nc" id="L3929">        cs.addMessage(See.only(shipPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
<span class="nc" id="L3931">                &quot;combat.shipSunkByBombardment&quot;, ship.getTile())</span>
<span class="nc" id="L3932">            .addName(&quot;%colony%&quot;, settlement.getName())</span>
<span class="nc" id="L3933">            .addStringTemplate(&quot;%unit%&quot;, ship.getLabel()));</span>

<span class="nc" id="L3935">        csSinkShip(ship, attackerPlayer, cs);</span>
<span class="nc" id="L3936">    }</span>

    /**
     * Sink the ship.
     *
     * @param ship The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
     * @param attackerPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that
     * attacked, or null
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSinkShip(Unit ship, ServerPlayer attackerPlayer,
                            ChangeSet cs) {
<span class="nc" id="L3948">        ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3949">        cs.addRemove(See.perhaps().always(shipPlayer), ship.getLocation(),</span>
                     ship);//-vis(shipPlayer)
<span class="nc" id="L3951">        ship.dispose();</span>
<span class="nc" id="L3952">        shipPlayer.invalidateCanSeeTiles();//+vis(shipPlayer)</span>
<span class="nc bnc" id="L3953" title="All 2 branches missed.">        if (attackerPlayer != null) {</span>
<span class="nc" id="L3954">            cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;,</span>
                            &quot;sound.event.shipSunk&quot;);
        }
<span class="nc" id="L3957">    }</span>

    /**
     * Slaughter a unit.
     *
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that is slaughtering.
     * @param loser The &lt;code&gt;Unit&lt;/code&gt; to slaughter.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csSlaughterUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3967">        ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3968">        StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="pc bpc" id="L3969" title="1 of 2 branches missed.">        Location winnerLoc = (winner.isInColony()) ? winner.getColony()</span>
<span class="fc" id="L3970">            : winner.getLocation();</span>
<span class="fc" id="L3971">        StringTemplate winnerLocation</span>
<span class="fc" id="L3972">            = winnerLoc.getLocationLabelFor(winnerPlayer);</span>
<span class="fc" id="L3973">        ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3974">        StringTemplate loserNation = loser.getApparentOwnerName();</span>
<span class="fc bfc" id="L3975" title="All 2 branches covered.">        Location loserLoc = (loser.isInColony()) ? loser.getColony()</span>
<span class="fc" id="L3976">            : loser.getLocation();</span>
<span class="fc" id="L3977">        StringTemplate loserLocation</span>
<span class="fc" id="L3978">            = loserLoc.getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3979">        String messageId = &quot;combat.unitSlaughtered&quot;</span>
<span class="fc" id="L3980">            + loser.getType().getSuffix();</span>

<span class="fc" id="L3982">        cs.addMessage(See.only(winnerPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
                messageId, &quot;combat.unitSlaughtered&quot;, winner)
<span class="fc" id="L3985">            .addStringTemplate(&quot;%nation%&quot;, loserNation)</span>
<span class="fc" id="L3986">            .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3987">            .addStringTemplate(&quot;%enemyNation%&quot;, winnerPlayer.getNationLabel())</span>
<span class="fc" id="L3988">            .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3989">            .addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
<span class="fc" id="L3990">        cs.addMessage(See.only(loserPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT,
<span class="fc" id="L3992">                messageId, &quot;combat.unitSlaughtered&quot;, loser.getTile())</span>
<span class="fc" id="L3993">            .addStringTemplate(&quot;%nation%&quot;, loserPlayer.getNationLabel())</span>
<span class="fc" id="L3994">            .addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3995">            .addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3996">            .addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3997">            .addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="pc bpc" id="L3998" title="1 of 4 branches missed.">        if (loserPlayer.isIndian() &amp;&amp; loserPlayer.checkForDeath() == IS_DEAD) {</span>
<span class="nc" id="L3999">            StringTemplate nativeNation = loserPlayer.getNationLabel();</span>
<span class="nc" id="L4000">            cs.addGlobalHistory(getGame(),</span>
<span class="nc" id="L4001">                new HistoryEvent(getGame().getTurn(),</span>
                    HistoryEvent.HistoryEventType.DESTROY_NATION, winnerPlayer)
<span class="nc" id="L4003">                .addStringTemplate(&quot;%nation%&quot;, winnerNation)</span>
<span class="nc" id="L4004">                .addStringTemplate(&quot;%nativeNation%&quot;, nativeNation));</span>
        }

        // Destroy unit.  Note See.only visibility used to handle the
        // case that the unit is the last at a settlement.  If
        // See.perhaps was used there, the settlement will be gone
        // when perhaps() is processed, which would erroneously make
        // the unit visible.
<span class="fc bfc" id="L4012" title="All 2 branches covered.">        cs.addRemove((loserLoc.getSettlement() != null)</span>
<span class="fc" id="L4013">            ? See.only(loserPlayer)</span>
<span class="fc" id="L4014">            : See.perhaps().always(loserPlayer),</span>
            loserLoc, loser);//-vis(loserPlayer)
<span class="fc" id="L4016">        loser.dispose();</span>
<span class="fc" id="L4017">        loserPlayer.invalidateCanSeeTiles();//+vis(loserPlayer)</span>
<span class="fc" id="L4018">    }</span>

    /**
     * Updates the player view for each new tile on a supplied list,
     * and update a ChangeSet as well.
     *
     * @param newTiles A list of &lt;code&gt;Tile&lt;/code&gt;s to update.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csSeeNewTiles(Collection&lt;? extends Tile&gt; newTiles,
                              ChangeSet cs) {
<span class="fc" id="L4029">        exploreTiles(newTiles);</span>
<span class="fc" id="L4030">        cs.add(See.only(this), newTiles);</span>
<span class="fc" id="L4031">    }</span>

    /**
     * Make a tea party modifier for the current turn.
     *
     * Public for the test suite.
     *
     * @return A tea party &lt;code&gt;Modifier&lt;/code&gt;.
     */
    public Modifier makeTeaPartyModifier() {
<span class="fc" id="L4041">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L4042">        final Turn turn = getGame().getTurn();</span>
<span class="pc bpc" id="L4043" title="1 of 2 branches missed.">        for (Modifier modifier : spec.getModifiers(Modifier.COLONY_GOODS_PARTY)) {</span>
<span class="fc" id="L4044">            Modifier m = Modifier.makeTimedModifier(&quot;model.goods.bells&quot;,</span>
                                                    modifier, turn);
<span class="fc" id="L4046">            m.setModifierIndex(Modifier.PARTY_PRODUCTION_INDEX);</span>
<span class="fc" id="L4047">            return m;</span>
        }
<span class="nc" id="L4049">        return null;</span>
    }

    /**
     * Raises the players tax rate, or handles a goods party.
     *
     * @param tax The new tax rate.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to use in a goods party.
     * @param accepted Whether the tax raise was accepted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csRaiseTax(int tax, Goods goods, boolean accepted,
                           ChangeSet cs) {
<span class="nc" id="L4062">        GoodsType goodsType = goods.getType();</span>
<span class="nc" id="L4063">        Colony colony = (Colony) goods.getLocation();</span>
<span class="nc" id="L4064">        int amount = Math.min(goods.getAmount(), GoodsContainer.CARGO_SIZE);</span>
<span class="nc" id="L4065">        String monarchKey = getMonarchKey();</span>

<span class="nc bnc" id="L4067" title="All 2 branches missed.">        if (accepted) {</span>
<span class="nc" id="L4068">            csSetTax(tax, cs);</span>
<span class="nc" id="L4069">            logger.info(&quot;Accepted tax raise to: &quot; + tax);</span>
<span class="nc bnc" id="L4070" title="All 2 branches missed.">        } else if (colony.getGoodsCount(goodsType) &lt; amount) {</span>
            // Player has removed the goods from the colony,
            // so raise the tax anyway.
<span class="nc" id="L4073">            final int extraTax = 3; // FIXME, magic number</span>
<span class="nc" id="L4074">            csSetTax(tax + extraTax, cs);</span>
<span class="nc" id="L4075">            cs.add(See.only(this), ChangePriority.CHANGE_NORMAL,</span>
                new MonarchActionMessage(Monarch.MonarchAction.FORCE_TAX,
<span class="nc" id="L4077">                    StringTemplate.template(Monarch.MonarchAction.FORCE_TAX.getTextKey())</span>
<span class="nc" id="L4078">                    .addAmount(&quot;%amount%&quot;, tax + extraTax),</span>
                    monarchKey));
<span class="nc" id="L4080">            logger.info(&quot;Forced tax raise to: &quot; + (tax + extraTax));</span>
<span class="nc" id="L4081">        } else { // Tea party</span>
<span class="nc" id="L4082">            Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L4083">            colony.getGoodsContainer().saveState();</span>
<span class="nc" id="L4084">            colony.removeGoods(goodsType, amount);</span>

<span class="nc" id="L4086">            int arrears = market.getPaidForSale(goodsType)</span>
<span class="nc" id="L4087">                * spec.getInteger(GameOptions.ARREARS_FACTOR);</span>
<span class="nc" id="L4088">            Market market = getMarket();</span>
<span class="nc" id="L4089">            market.setArrears(goodsType, arrears);</span>

<span class="nc" id="L4091">            Modifier tpm = makeTeaPartyModifier();</span>
<span class="nc" id="L4092">            cs.addFeatureChange(this, colony, tpm, true);</span>
<span class="nc" id="L4093">            cs.add(See.only(this), colony.getGoodsContainer());</span>
<span class="nc" id="L4094">            cs.add(See.only(this), market.getMarketData(goodsType));</span>
            
<span class="nc" id="L4096">            String messageId = &quot;model.player.colonyGoodsParty.&quot;</span>
<span class="nc" id="L4097">                + goodsType.getSuffix();</span>
<span class="nc bnc" id="L4098" title="All 2 branches missed.">            if (!Messages.containsKey(messageId)) {</span>
<span class="nc bnc" id="L4099" title="All 2 branches missed.">                messageId = (colony.isLandLocked())</span>
                    ? &quot;model.player.colonyGoodsParty.landLocked&quot;
                    : &quot;model.player.colonyGoodsParty.harbour&quot;;
            }
<span class="nc" id="L4103">            cs.addMessage(See.only(this),</span>
                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                    messageId, this)
<span class="nc" id="L4106">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L4107">                .addAmount(&quot;%amount%&quot;, amount)</span>
<span class="nc" id="L4108">                .addNamed(&quot;%goods%&quot;, goodsType));</span>
<span class="nc" id="L4109">            cs.addAttribute(See.only(this), &quot;flush&quot;, Boolean.TRUE.toString());</span>
<span class="nc" id="L4110">            logger.info(&quot;Goods party at &quot; + colony.getName()</span>
                + &quot; with: &quot; + goods + &quot; arrears: &quot; + arrears);
<span class="nc bnc" id="L4112" title="All 2 branches missed.">            if (isAI()) { // Reset the goods wishes</span>
<span class="nc" id="L4113">                colony.firePropertyChange(Colony.REARRANGE_WORKERS,</span>
                                          goodsType, null);
            }
        }
<span class="nc" id="L4117">    }</span>

    /**
     * Handle the end of a session where the player has ignored a tax
     * increase demand.
     *
     * @param tax The new tax rate.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to use in a goods party.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void ignoreTax(int tax, Goods goods, ChangeSet cs) {
<span class="nc" id="L4128">        csRaiseTax(tax, goods, true, cs);</span>
<span class="nc" id="L4129">        cs.addMessage(See.only(this),</span>
            new ModelMessage(&quot;model.player.ignoredTax&quot;, this)
<span class="nc" id="L4131">                .addAmount(&quot;%amount%&quot;, tax));</span>
<span class="nc" id="L4132">    }</span>

    /**
     * Handle the end of a session where the player has ignored an
     * offer of mercenaries.
     *
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void ignoreMercenaries(ChangeSet cs) {
<span class="nc" id="L4141">        cs.addMessage(See.only(this),</span>
            new ModelMessage(&quot;model.player.ignoredMercenaries&quot;, this));
<span class="nc" id="L4143">    }</span>

    /**
     * Set the player tax rate.
     * If this requires a change to the bells bonuses, we have to update
     * the whole player (bah) because we can not yet independently update
     * the feature container.
     *
     * @param tax The new tax rate.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csSetTax(int tax, ChangeSet cs) {
<span class="nc" id="L4155">        setTax(tax);</span>
<span class="nc bnc" id="L4156" title="All 2 branches missed.">        if (recalculateBellsBonus()) {</span>
<span class="nc" id="L4157">            cs.add(See.only(this), this);</span>
        } else {
<span class="nc" id="L4159">            cs.addPartial(See.only(this), this, &quot;tax&quot;);</span>
        }
<span class="nc" id="L4161">    }</span>

    /**
     * Adds mercenaries that the player has accepted.
     *
     * @param mercs A list of mercenaries.
     * @param price The price to be charged for them.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csAddMercenaries(List&lt;AbstractUnit&gt; mercs, int price,
                                 ChangeSet cs) {
<span class="nc bnc" id="L4172" title="All 2 branches missed.">        if (checkGold(price)) {</span>
<span class="nc" id="L4173">            createUnits(mercs, getEurope());//-vis: safe, Europe</span>
<span class="nc" id="L4174">            cs.add(See.only(this), getEurope());</span>
<span class="nc" id="L4175">            modifyGold(-price);</span>
<span class="nc" id="L4176">            cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
        } else {
<span class="nc" id="L4178">            getMonarch().setDispleasure(true);</span>
<span class="nc" id="L4179">            cs.add(See.only(this), ChangePriority.CHANGE_NORMAL,</span>
                new MonarchActionMessage(Monarch.MonarchAction.DISPLEASURE,
<span class="nc" id="L4181">                    StringTemplate.template(Monarch.MonarchAction.DISPLEASURE.getTextKey()),</span>
<span class="nc" id="L4182">                    getMonarchKey()));</span>
        }
<span class="nc" id="L4184">    }</span>

    /**
     * Make contact between two nations if necessary.
     *
     * @param other The other &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if this was a first contact.
     */
    public boolean csContact(ServerPlayer other, ChangeSet cs) {
<span class="fc bfc" id="L4194" title="All 2 branches covered.">        if (hasContacted(other)) return false;</span>

        // Must be a first contact!
<span class="fc" id="L4197">        final Game game = getGame();</span>
<span class="fc" id="L4198">        Turn turn = game.getTurn();</span>
<span class="fc bfc" id="L4199" title="All 2 branches covered.">        if (isIndian()) {</span>
<span class="pc bpc" id="L4200" title="1 of 2 branches missed.">            if (other.isIndian()) {</span>
<span class="nc" id="L4201">                return false; // Ignore native-to-native contacts.</span>
            } else {
<span class="fc" id="L4203">                cs.addHistory(other, new HistoryEvent(turn,</span>
                        HistoryEvent.HistoryEventType.MEET_NATION, other)
<span class="fc" id="L4205">                    .addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
            }
        } else { // (serverPlayer.isEuropean)
<span class="fc" id="L4208">            cs.addHistory(this, new HistoryEvent(turn,</span>
                    HistoryEvent.HistoryEventType.MEET_NATION, other)
<span class="fc" id="L4210">                .addStringTemplate(&quot;%nation%&quot;, other.getNationLabel()));</span>
        }

<span class="fc" id="L4213">        logger.finest(&quot;First contact between &quot; + this.getId()</span>
<span class="fc" id="L4214">            + &quot; and &quot; + other.getId());</span>
<span class="fc" id="L4215">        return true;</span>
    }

    /**
     * Initiate first contact between this European and native player.
     *
     * @param other The native &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; contact is made at if this is
     *     a first landing in the new world and it is owned by the
     *     other player.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csNativeFirstContact(ServerPlayer other, Tile tile,
                                     ChangeSet cs) {
<span class="fc" id="L4229">        cs.add(See.only(this), ChangePriority.CHANGE_EARLY,</span>
            new FirstContactMessage(this, other, tile));
<span class="fc" id="L4231">        csChangeStance(Stance.PEACE, other, true, cs);</span>
<span class="fc bfc" id="L4232" title="All 2 branches covered.">        if (tile != null) {</span>
            // Establish a diplomacy session so that if the player
            // accepts the tile offer, we can verify that the offer
            // was made.
<span class="fc" id="L4236">            new DiplomacySession(tile.getFirstUnit(),</span>
<span class="fc" id="L4237">                                 tile.getOwningSettlement());</span>
        }
<span class="fc" id="L4239">    }</span>

    /**
     * Initiate first contact between this European and another
     * European player.
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; making contact.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; being contacted.
     * @param otherUnit The &lt;code&gt;Unit&lt;/code&gt; being contacted.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    public void csEuropeanFirstContact(Unit unit, Settlement settlement,
                                       Unit otherUnit, ChangeSet cs) {
<span class="nc" id="L4252">        final Game game = getGame();</span>

        ServerPlayer other;
<span class="nc bnc" id="L4255" title="All 2 branches missed.">        if (settlement != null) {</span>
<span class="nc" id="L4256">            other = (ServerPlayer)settlement.getOwner();</span>
<span class="nc bnc" id="L4257" title="All 2 branches missed.">        } else if (otherUnit != null) {</span>
<span class="nc" id="L4258">            other = (ServerPlayer)otherUnit.getOwner();</span>
        } else {
<span class="nc" id="L4260">            throw new IllegalArgumentException(&quot;Non-null settlement or &quot;</span>
                    + &quot;otherUnit required.&quot;);
        }
        
<span class="nc" id="L4264">        DiplomaticTrade agreement = new DiplomaticTrade(game,</span>
            DiplomaticTrade.TradeContext.CONTACT, this, other, null, 0);
<span class="nc" id="L4266">        agreement.add(new StanceTradeItem(game, this, other, Stance.PEACE));</span>
<span class="nc bnc" id="L4267" title="All 2 branches missed.">        DiplomacySession session = (settlement == null)</span>
            ? new DiplomacySession(unit, otherUnit)
            : new DiplomacySession(unit, settlement);
<span class="nc" id="L4270">        session.setAgreement(agreement);</span>
<span class="nc bnc" id="L4271" title="All 2 branches missed.">        cs.add(See.only(this), ChangePriority.CHANGE_LATE, (settlement == null)</span>
            ? new DiplomacyMessage(unit, otherUnit, agreement)
            : new DiplomacyMessage(unit, settlement, agreement));
<span class="nc" id="L4274">    }</span>

    /**
     * Change the owner of a unit or dispose of it if the change is
     * impossible.  Move the unit to a new location if necessary.
     * Also handle disappearance of any carried units that will now be
     * invisible to the new owner.
     *
     * -vis(owner,newOwner)
     *
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change ownership of.
     * @param newOwner The new owning &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param change An optional accompanying &lt;code&gt;ChangeType&lt;/code&gt;.
     * @param loc A optional new &lt;code&gt;Location&lt;/code&gt; for the unit.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the new owner can have this unit.
     */
    public boolean csChangeOwner(Unit unit, ServerPlayer newOwner,
                                 ChangeType change, Location loc,
                                 ChangeSet cs) {
<span class="fc bfc" id="L4294" title="All 2 branches covered.">        if (newOwner == this) return true; // No transfer needed</span>

<span class="fc" id="L4296">        final Tile oldTile = unit.getTile();</span>
<span class="fc" id="L4297">        UnitType mainType = unit.getTypeChange(change, newOwner);</span>
<span class="fc bfc" id="L4298" title="All 2 branches covered.">        if (mainType == null) mainType = unit.getType(); // No change needed.</span>
<span class="pc bpc" id="L4299" title="1 of 2 branches missed.">        if (!mainType.isAvailableTo(newOwner)) { // Can not have this unit.</span>
<span class="nc" id="L4300">            cs.addRemove(See.perhaps().always(this), oldTile, unit);</span>
<span class="nc" id="L4301">            unit.dispose();</span>
<span class="nc" id="L4302">            return false;</span>
        }

<span class="pc bpc" id="L4305" title="1 of 2 branches missed.">        for (Unit u : unit.getUnitList()) {</span>
<span class="nc" id="L4306">            UnitType type = u.getTypeChange(change, newOwner);</span>
<span class="nc bnc" id="L4307" title="All 2 branches missed.">            if (type == null) type = u.getType();</span>
<span class="nc bnc" id="L4308" title="All 2 branches missed.">            if (!type.isAvailableTo(newOwner)) {</span>
<span class="nc" id="L4309">                cs.addRemove(See.only(this), unit, u);</span>
<span class="nc" id="L4310">                u.dispose();</span>
            } else {
<span class="nc bnc" id="L4312" title="All 2 branches missed.">                if (!u.changeType(type)) {</span>
<span class="nc" id="L4313">                    throw new IllegalStateException(&quot;Type change failure: &quot;</span>
                        + u + &quot; -&gt; &quot; + type);
                }
            }
<span class="nc" id="L4317">        }</span>
<span class="pc bpc" id="L4318" title="1 of 4 branches missed.">        if (mainType != unit.getType() &amp;&amp; !unit.changeType(mainType)) {</span>
<span class="nc" id="L4319">            throw new IllegalStateException(&quot;Type change failure: &quot; + unit</span>
                + &quot; -&gt; &quot; + mainType);
        }
<span class="fc" id="L4322">        unit.changeOwner(newOwner);</span>
<span class="fc bfc" id="L4323" title="All 2 branches covered.">        if (loc != null) unit.setLocation(loc);</span>
<span class="pc bpc" id="L4324" title="1 of 2 branches missed.">        if (unit.isCarrier()) {</span>
<span class="nc" id="L4325">            cs.addRemoves(See.only(this), unit, unit.getUnitList());</span>
        }
<span class="fc" id="L4327">        cs.add(See.only(newOwner), newOwner.exploreForUnit(unit));</span>
<span class="fc" id="L4328">        return true;</span>
    }


    // Serialization

    /**
     * {@inheritDoc}
     */
    @Override
    public String toString() {
<span class="fc" id="L4339">        StringBuilder sb = new StringBuilder(64);</span>
<span class="fc" id="L4340">        sb.append(&quot;[ServerPlayer &quot;).append(getId())</span>
<span class="fc" id="L4341">            .append(&quot; &quot;).append(getName())</span>
<span class="fc" id="L4342">            .append(&quot; &quot;).append(connection)</span>
<span class="fc" id="L4343">            .append(&quot;]&quot;);</span>
<span class="fc" id="L4344">        return sb.toString();</span>
    }

    /**
     * Gets the tag name of the root element representing this object.
     *
     * @return &quot;serverPlayer&quot;
     */
    @Override
    public String getServerXMLElementTagName() {
<span class="fc" id="L4354">        return &quot;serverPlayer&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>