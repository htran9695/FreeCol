<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerPlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.model</a> &gt; <span class="el_source">ServerPlayer.java</span></div><h1>ServerPlayer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.model;

import java.io.IOException;
import java.net.Socket;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.EnumMap;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;

import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.BuildingType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.CombatModel;
import net.sf.freecol.common.model.CombatModel.CombatResult;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.Disaster;
import net.sf.freecol.common.model.Effect;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.Event;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FoundingFather.FoundingFatherType;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.Monarch;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.StanceTradeItem;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.model.pathfinding.GoalDeciders;
import net.sf.freecol.common.networking.ChooseFoundingFatherMessage;
import net.sf.freecol.common.networking.Connection;
import net.sf.freecol.common.networking.DiplomacyMessage;
import net.sf.freecol.common.networking.FirstContactMessage;
import net.sf.freecol.common.networking.LootCargoMessage;
import net.sf.freecol.common.networking.MonarchActionMessage;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.server.control.ChangeSet;
import net.sf.freecol.server.control.ChangeSet.ChangePriority;
import net.sf.freecol.server.control.ChangeSet.See;

import org.w3c.dom.Element;

/**
 * A &lt;code&gt;Player&lt;/code&gt; with additional (server specific) information.
 *
 * That is: pointers to this player's {@link Connection} and {@link Socket}
 */
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">public class ServerPlayer extends Player implements ServerModelObject {</span>

	/** The Constant logger. */
<span class="fc" id="L113">	private static final Logger logger = Logger.getLogger(ServerPlayer.class.getName());</span>

	/** The Constant ALARM_RADIUS. */
	// FIXME: move to options or spec?
	public static final int ALARM_RADIUS = 2;

	/** The Constant ALARM_TILE_IN_USE. */
	public static final int ALARM_TILE_IN_USE = 2;

	/** The Constant IS_DEAD. */
	// checkForDeath results
	public static final int IS_DEAD = -1;

	/** The Constant IS_ALIVE. */
	public static final int IS_ALIVE = 0;

	/** The Constant AUTORECRUIT. */
	public static final int AUTORECRUIT = 1;

	/** The Constant SCORE_SETTLEMENT_DESTROYED. */
	// Penalty for destroying a settlement (Col1)
	public static final int SCORE_SETTLEMENT_DESTROYED = -5;

	/** The Constant SCORE_NATION_DESTROYED. */
	// Penalty for destroying a nation (FreeCol extension)
	public static final int SCORE_NATION_DESTROYED = -50;

	/** The Constant SCORE_GOLD. */
	// Gold converts to score at 1 pt per 1000 gp (Col1)
	public static final double SCORE_GOLD = 0.001;

	/** The Constant SCORE_FOUNDING_FATHER. */
	// Score bonus for each founding father (Col1)
	public static final int SCORE_FOUNDING_FATHER = 5;

	// Percentage bonuses for being the 1st,2nd and 3rd player to
	/** The Constant SCORE_INDEPENDENCE_BONUS_FIRST. */
	// achieve independence. (Col1)
	public static final int SCORE_INDEPENDENCE_BONUS_FIRST = 100;

	/** The Constant SCORE_INDEPENDENCE_BONUS_SECOND. */
	public static final int SCORE_INDEPENDENCE_BONUS_SECOND = 50;

	/** The Constant SCORE_INDEPENDENCE_BONUS_THIRD. */
	public static final int SCORE_INDEPENDENCE_BONUS_THIRD = 25;

	/** The network socket to the player's client. */
	private Socket socket;

	/** The connection for this player. */
	private Connection connection;

	/** The connected. */
<span class="fc" id="L166">	private boolean connected = false;</span>

	/** Remaining emigrants to select due to a fountain of youth. */
<span class="fc" id="L169">	private int remainingEmigrants = 0;</span>

	/** Players with respect to which stance has changed. */
<span class="fc" id="L172">	private final List&lt;ServerPlayer&gt; stanceDirty = new ArrayList&lt;&gt;();</span>

	/** Accumulate extra trades here. Do not serialize. */
<span class="fc" id="L175">	private final List&lt;AbstractGoods&gt; extraTrades = new ArrayList&lt;&gt;();</span>

	/**
	 * Trivial constructor required for all ServerModelObjects.
	 *
	 * @param game
	 *            the game
	 * @param id
	 *            the id
	 */
	public ServerPlayer(Game game, String id) {
<span class="fc" id="L186">		super(game, id);</span>
<span class="fc" id="L187">	}</span>

	/**
	 * Creates a new ServerPlayer.
	 *
	 * @param game
	 *            The &lt;code&gt;Game&lt;/code&gt; this object belongs to.
	 * @param admin
	 *            Whether the player is the game administrator or not.
	 * @param nation
	 *            The nation of the &lt;code&gt;Player&lt;/code&gt;.
	 * @param socket
	 *            The socket to the player's client.
	 * @param connection
	 *            The &lt;code&gt;Connection&lt;/code&gt; for the socket.
	 */
	public ServerPlayer(Game game, boolean admin, Nation nation, Socket socket, Connection connection) {
<span class="fc" id="L204">		super(game);</span>

<span class="pc bpc" id="L206" title="1 of 2 branches missed.">		if (nation == null)</span>
<span class="nc" id="L207">			throw new IllegalArgumentException(&quot;Null nation&quot;);</span>
<span class="fc" id="L208">		final Specification spec = getSpecification();</span>

<span class="fc" id="L210">		this.name = nation.getRulerName();</span>
<span class="fc" id="L211">		this.admin = admin;</span>
<span class="fc" id="L212">		this.nationId = nation.getId();</span>
<span class="fc" id="L213">		this.immigration = 0;</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">		if (nation.isUnknownEnemy()) { // virtual &quot;enemy privateer&quot; player</span>
<span class="fc" id="L215">			this.nationType = null;</span>
<span class="fc" id="L216">			this.playerType = PlayerType.COLONIAL;</span>
<span class="fc" id="L217">			this.europe = null;</span>
<span class="fc" id="L218">			this.monarch = null;</span>
<span class="fc" id="L219">			this.gold = 0;</span>
<span class="fc" id="L220">			this.setAI(true);</span>
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">		} else if (nation.getType() != null) {</span>
<span class="fc" id="L222">			this.nationType = nation.getType();</span>
			try {
<span class="fc" id="L224">				addFeatures(nationType);</span>
<span class="nc" id="L225">			} catch (Throwable error) {</span>
<span class="nc" id="L226">				error.printStackTrace();</span>
<span class="fc" id="L227">			}</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">			if (nationType.isEuropean()) {</span>
				/*
				 * Setting the amount of gold to
				 * &quot;getGameOptions().getInteger(GameOptions.STARTING_MONEY)&quot;
				 *
				 * just before starting the game. See
				 * &quot;net.sf.freecol.server.control.PreGameController&quot;.
				 */
<span class="fc bfc" id="L236" title="All 2 branches covered.">				this.playerType = (nationType.isREF()) ? PlayerType.ROYAL : PlayerType.COLONIAL;</span>
<span class="fc" id="L237">				this.europe = new ServerEurope(game, this);</span>
<span class="fc" id="L238">				initializeHighSeas();</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">				if (this.playerType == PlayerType.COLONIAL) {</span>
<span class="fc" id="L240">					this.monarch = new Monarch(game, this);</span>
					// In BR#2615 misiulo reports that Col1 players start
					// with 2 crosses. This is surprising, but you could
					// argue that some level of religious unrest might
					// contribute to the fact there is an expedition to
					// the new world underway.
<span class="fc" id="L246">					this.immigration = spec.getInteger(GameOptions.PLAYER_IMMIGRATION_BONUS);</span>
				}
<span class="fc" id="L248">				this.gold = 0;</span>
			} else { // indians
<span class="fc" id="L250">				this.playerType = PlayerType.NATIVE;</span>
<span class="fc" id="L251">				this.gold = Player.GOLD_NOT_ACCOUNTED;</span>
			}
		} else {
<span class="nc" id="L254">			throw new IllegalArgumentException(&quot;Bogus nation: &quot; + nation);</span>
		}
<span class="fc" id="L256">		this.market = new Market(getGame(), this);</span>
<span class="fc" id="L257">		this.liberty = 0;</span>
<span class="fc" id="L258">		this.currentFather = null;</span>

<span class="fc" id="L260">		this.socket = socket;</span>
<span class="fc" id="L261">		this.connection = connection;</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">		connected = connection != null;</span>
<span class="fc" id="L263">	}</span>

	/**
	 * Is this player is currently connected to the server?.
	 *
	 * @return True if this player is currently connected to the server.
	 */
	public boolean isConnected() {
<span class="fc" id="L271">		return connected;</span>
	}

	/**
	 * Sets the &quot;connected&quot;-status of this player.
	 *
	 * @param connected
	 *            Should be &lt;i&gt;true&lt;/i&gt; if this player is currently connected to
	 *            the server and &lt;code&gt;false&lt;/code&gt; otherwise.
	 * @see #isConnected
	 */
	public void setConnected(boolean connected) {
<span class="fc" id="L283">		this.connected = connected;</span>
<span class="fc" id="L284">	}</span>

	/**
	 * Gets the socket of this player.
	 * 
	 * @return The &lt;code&gt;Socket&lt;/code&gt;.
	 */
	public Socket getSocket() {
<span class="nc" id="L292">		return socket;</span>
	}

	/**
	 * Gets the connection of this player.
	 *
	 * @return The &lt;code&gt;Connection&lt;/code&gt;.
	 */
	public Connection getConnection() {
<span class="fc" id="L301">		return connection;</span>
	}

	/**
	 * Sets the connection of this player.
	 *
	 * @param connection
	 *            The &lt;code&gt;Connection&lt;/code&gt;.
	 */
	public void setConnection(Connection connection) {
<span class="fc" id="L311">		this.connection = connection;</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">		connected = (connection != null);</span>
<span class="fc" id="L313">	}</span>

	/**
	 * Send a change set to this player.
	 *
	 * @param cs
	 *            The &lt;code&gt;ChangeSet&lt;/code&gt; to send.
	 */
	public void send(ChangeSet cs) {
<span class="fc" id="L322">		askElement(cs.build(this));</span>
<span class="fc" id="L323">	}</span>

	/**
	 * Send an element to this player. Do not use (sole use in send() above).
	 * This will go away.
	 *
	 * @param request
	 *            An &lt;code&gt;Element&lt;/code&gt; containing the update.
	 */
	private void askElement(Element request) {
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">		if (this.connection == null)</span>
<span class="nc" id="L334">			return;</span>

<span class="fc bfc" id="L336" title="All 2 branches covered.">		while (request != null) {</span>
			Element reply;
			try {
<span class="fc" id="L339">				reply = this.connection.ask(request);</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">				if (reply == null)</span>
<span class="fc" id="L341">					break;</span>
<span class="nc" id="L342">			} catch (IOException e) {</span>
<span class="nc" id="L343">				logger.log(Level.WARNING, &quot;Could not send \&quot;&quot; + request.getTagName() + &quot;\&quot;-message.&quot;, e);</span>
<span class="nc" id="L344">				break;</span>
<span class="fc" id="L345">			}</span>

			try {
<span class="fc" id="L348">				request = this.connection.handle(reply);</span>
<span class="nc" id="L349">			} catch (FreeColException fce) {</span>
<span class="nc" id="L350">				logger.log(Level.WARNING, &quot;Exception processing reply \&quot;&quot; + reply.getTagName() + &quot;\&quot;-message.&quot;, fce);</span>
<span class="nc" id="L351">				break;</span>
<span class="fc" id="L352">			}</span>
<span class="fc" id="L353">		}</span>
<span class="fc" id="L354">	}</span>

	/**
	 * Update the current father.
	 *
	 * @param ff
	 *            The &lt;code&gt;FoundingFather&lt;/code&gt; to recruit.
	 */
	public void updateCurrentFather(FoundingFather ff) {
<span class="nc" id="L363">		setCurrentFather(ff);</span>
<span class="nc" id="L364">		clearOfferedFathers();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">		if (ff != null) {</span>
<span class="nc" id="L366">			logger.finest(getId() + &quot; is recruiting &quot; + ff.getId() + &quot; in &quot; + getGame().getTurn());</span>
		}
<span class="nc" id="L368">	}</span>

	/**
	 * Accumulate extra trades.
	 *
	 * @param ag
	 *            The &lt;code&gt;AbstractGoods&lt;/code&gt; describing the sale.
	 */
	public void addExtraTrade(AbstractGoods ag) {
<span class="fc" id="L377">		extraTrades.add(ag);</span>
<span class="fc" id="L378">	}</span>

	/**
	 * Flush the extra trades.
	 *
	 * @param random
	 *            A pseudo-random number source.
	 */
	public void flushExtraTrades(Random random) {
<span class="fc bfc" id="L387" title="All 2 branches covered.">		while (!extraTrades.isEmpty()) {</span>
<span class="fc" id="L388">			AbstractGoods ag = extraTrades.remove(0);</span>
<span class="fc" id="L389">			propagateToEuropeanMarkets(ag.getType(), ag.getAmount(), random);</span>
<span class="fc" id="L390">		}</span>
<span class="fc" id="L391">	}</span>

	/**
	 * Performs initial randomizations for this player.
	 *
	 * @param random
	 *            A pseudo-random number source.
	 */
	public void randomizeGame(Random random) {
<span class="pc bpc" id="L400" title="2 of 6 branches missed.">		if (!isEuropean() || isREF() || isUnknownEnemy())</span>
<span class="fc" id="L401">			return;</span>
<span class="fc" id="L402">		final Specification spec = getGame().getSpecification();</span>

		// Set initial immigration target
<span class="fc" id="L405">		int i0 = spec.getInteger(GameOptions.INITIAL_IMMIGRATION);</span>
<span class="fc" id="L406">		immigrationRequired = (int) applyModifiers((float) i0, null, Modifier.RELIGIOUS_UNREST_BONUS);</span>

		// Add initial gold
<span class="fc" id="L409">		modifyGold(spec.getInteger(GameOptions.STARTING_MONEY));</span>

		// Choose starting immigrants
<span class="fc" id="L412">		((ServerEurope) getEurope()).initializeMigration(random);</span>

		// Randomize the initial market prices
<span class="fc" id="L415">		Market market = getMarket();</span>
<span class="fc" id="L416">		StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L417">		boolean changed = false;</span>
<span class="fc bfc" id="L418" title="All 2 branches covered.">		for (GoodsType type : spec.getGoodsTypeList()) {</span>
<span class="fc" id="L419">			String prefix = &quot;model.option.&quot; + type.getSuffix(&quot;model.goods.&quot;);</span>
			// these options are not available for all goods types
<span class="pc bpc" id="L421" title="1 of 4 branches missed.">			if (spec.hasOption(prefix + &quot;.minimumPrice&quot;) &amp;&amp; spec.hasOption(prefix + &quot;.maximumPrice&quot;)) {</span>
<span class="fc" id="L422">				int min = spec.getInteger(prefix + &quot;.minimumPrice&quot;);</span>
<span class="fc" id="L423">				int max = spec.getInteger(prefix + &quot;.maximumPrice&quot;);</span>
<span class="pc bpc" id="L424" title="1 of 2 branches missed.">				if (max &lt; min) { // User error</span>
<span class="nc" id="L425">					int bad = min;</span>
<span class="nc" id="L426">					min = max;</span>
<span class="nc" id="L427">					max = bad;</span>
<span class="pc bfc" id="L428" title="All 2 branches covered.">				} else if (max == min)</span>
<span class="fc" id="L429">					continue;</span>
<span class="fc" id="L430">				int add = randomInt(null, null, random, max - min);</span>
<span class="fc bfc" id="L431" title="All 2 branches covered.">				if (add &gt; 0) {</span>
<span class="fc" id="L432">					market.setInitialPrice(type, min + add);</span>
<span class="fc" id="L433">					market.update(type);</span>
<span class="fc" id="L434">					market.flushPriceChange(type);</span>
<span class="fc" id="L435">					sb.append(&quot;, &quot;).append(type.getId()).append(&quot; -&gt; &quot;).append(min + add);</span>
<span class="fc" id="L436">					changed = true;</span>
				}
			}
<span class="fc" id="L439">		}</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">		if (changed) {</span>
<span class="fc" id="L441">			logger.finest(&quot;randomizeGame(&quot; + getId() + &quot;) initial prices: &quot; + sb.toString().substring(2));</span>
		}
<span class="fc" id="L443">	}</span>

	/**
	 * Checks if this player has died.
	 *
	 * @return Negative if the player is dead, zero if they are ok, positive
	 *         non-zero if the server should auto-recruit colonist units to keep
	 *         this player alive.
	 */
	public int checkForDeath() {
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">		if (isUnknownEnemy())</span>
<span class="nc" id="L454">			return IS_ALIVE;</span>
<span class="fc" id="L455">		final Specification spec = getGame().getSpecification();</span>
		/*
		 * Die if: (isNative &amp;&amp; (no colonies or units)) || ((rebel or
		 * independent) &amp;&amp; !(has coastal colony)) || (isREF &amp;&amp; !(rebel nation
		 * left) &amp;&amp; (all units in Europe)) || ((no units in New World) &amp;&amp; ((year
		 * &gt; 1600) || (cannot get a unit from Europe)))
		 */
<span class="pc bpc" id="L462" title="4 of 6 branches missed.">		switch (getPlayerType()) {</span>
		case NATIVE: // All natives units are viable
<span class="pc bpc" id="L464" title="1 of 2 branches missed.">			return (getUnits().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

		case COLONIAL: // Handle the hard case below
<span class="fc" id="L467">			break;</span>

		case REBEL:
		case INDEPENDENT:
			// Post-declaration European player needs a coastal colony
			// and can not hope for resupply from Europe.
<span class="nc bnc" id="L473" title="All 2 branches missed.">			return (getNumberOfPorts() &gt; 0) ? IS_ALIVE : IS_DEAD;</span>

		case ROYAL:
<span class="nc bnc" id="L476" title="All 2 branches missed.">			return (getRebels().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

		case UNDEAD:
<span class="nc bnc" id="L479" title="All 2 branches missed.">			return (getUnits().isEmpty()) ? IS_DEAD : IS_ALIVE;</span>

		default:
<span class="nc" id="L482">			throw new IllegalStateException(&quot;Bogus player type&quot;);</span>
		}

		// Quick check for a colony. Do not log, this is the common case.
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">		if (!getColonies().isEmpty())</span>
<span class="nc" id="L487">			return IS_ALIVE;</span>

		// Do not kill the observing player during a debug run.
<span class="pc bpc" id="L490" title="3 of 4 branches missed.">		if (!isAI() &amp;&amp; FreeColDebugger.getDebugRunTurns() &gt;= 0)</span>
<span class="nc" id="L491">			return IS_ALIVE;</span>

		// Do not kill the unknown enemy!
<span class="pc bpc" id="L494" title="1 of 2 branches missed.">		if (isUnknownEnemy())</span>
<span class="nc" id="L495">			return IS_ALIVE;</span>

		// Traverse player units, look for valid carriers, colonists,
		// carriers with units, carriers with goods.
<span class="fc" id="L499">		boolean hasCarrier = false, hasColonist = false, hasEmbarked = false, hasGoods = false;</span>
<span class="fc bfc" id="L500" title="All 2 branches covered.">		for (Unit unit : getUnits()) {</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">			if (unit.isCarrier()) {</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">				if (unit.hasGoodsCargo())</span>
<span class="nc" id="L503">					hasGoods = true;</span>
<span class="fc" id="L504">				hasCarrier = true;</span>
<span class="fc" id="L505">				continue;</span>
			}

			// Must be able to found new colony or capture units
<span class="pc bpc" id="L509" title="3 of 4 branches missed.">			if (!unit.isColonist() &amp;&amp; !unit.isOffensiveUnit())</span>
<span class="nc" id="L510">				continue;</span>
<span class="fc" id="L511">			hasColonist = true;</span>

			// Verify if unit is in new world, or on a carrier in new world
			Unit carrier;
<span class="fc bfc" id="L515" title="All 2 branches covered.">			if ((carrier = unit.getCarrier()) != null) {</span>
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">				if (carrier.hasTile()) {</span>
<span class="nc" id="L517">					logger.info(getName() + &quot; alive, unit &quot; + unit.getId() + &quot; (embarked) on map.&quot;);</span>
<span class="nc" id="L518">					return IS_ALIVE;</span>
				}
<span class="fc" id="L520">				hasEmbarked = true;</span>
			}
<span class="pc bpc" id="L522" title="1 of 4 branches missed.">			if (unit.hasTile() &amp;&amp; !unit.isInMission()) {</span>
<span class="fc" id="L523">				logger.info(getName() + &quot; alive, unit &quot; + unit.getId() + &quot; on map.&quot;);</span>
<span class="fc" id="L524">				return IS_ALIVE;</span>
			}
<span class="fc" id="L526">		}</span>
		// The player does not have any valid units or settlements on the map.

<span class="fc" id="L529">		int mandatory = spec.getInteger(GameOptions.MANDATORY_COLONY_YEAR);</span>
<span class="fc bfc" id="L530" title="All 2 branches covered.">		if (getGame().getTurn().getYear() &gt;= mandatory) {</span>
			// After the season cutover year there must be a presence
			// in the New World.
<span class="fc" id="L533">			logger.info(getName() + &quot; dead, no presence &gt;= &quot; + mandatory);</span>
<span class="fc" id="L534">			return IS_DEAD;</span>
		}

		// No problems, unit available on carrier but off map, or goods
		// available to be sold.
<span class="fc bfc" id="L539" title="All 2 branches covered.">		if (hasEmbarked) {</span>
<span class="fc" id="L540">			logger.info(getName() + &quot; alive, has embarked unit.&quot;);</span>
<span class="fc" id="L541">			return IS_ALIVE;</span>
<span class="pc bpc" id="L542" title="1 of 2 branches missed.">		} else if (hasGoods) {</span>
<span class="nc" id="L543">			logger.info(getName() + &quot; alive, has cargo.&quot;);</span>
<span class="nc" id="L544">			return IS_ALIVE;</span>
		}

		// It is necessary to still have a carrier.
<span class="fc" id="L548">		final Europe europe = getEurope();</span>
<span class="fc" id="L549">		int goldNeeded = 0;</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">		if (!hasCarrier) {</span>
<span class="fc" id="L551">			int price = Integer.MAX_VALUE;</span>
<span class="pc bpc" id="L552" title="1 of 2 branches missed.">			if (europe != null) {</span>
<span class="fc bfc" id="L553" title="All 2 branches covered.">				for (UnitType type : spec.getUnitTypesWithAbility(Ability.NAVAL_UNIT)) {</span>
<span class="fc" id="L554">					int p = europe.getUnitPrice(type);</span>
<span class="fc bfc" id="L555" title="All 4 branches covered.">					if (p != UNDEFINED &amp;&amp; p &lt; price)</span>
<span class="fc" id="L556">						price = p;</span>
<span class="fc" id="L557">				}</span>
			}
<span class="pc bpc" id="L559" title="1 of 4 branches missed.">			if (price == Integer.MAX_VALUE || !checkGold(price)) {</span>
<span class="fc" id="L560">				logger.info(getName() + &quot; dead, can not buy carrier.&quot;);</span>
<span class="fc" id="L561">				return IS_DEAD;</span>
			}
<span class="fc" id="L563">			goldNeeded += price;</span>
		}

		// A colonist is required.
<span class="fc bfc" id="L567" title="All 2 branches covered.">		if (hasColonist) {</span>
<span class="fc" id="L568">			logger.info(getName() + &quot; alive, has waiting colonist.&quot;);</span>
<span class="fc" id="L569">			return IS_ALIVE;</span>
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">		} else if (europe == null) {</span>
<span class="nc" id="L571">			logger.info(getName() + &quot; dead, can not recruit.&quot;);</span>
<span class="nc" id="L572">			return IS_DEAD;</span>
		}
<span class="fc" id="L574">		UnitType unitType = null;</span>
<span class="fc" id="L575">		int price = europe.getRecruitPrice();</span>
<span class="fc bfc" id="L576" title="All 2 branches covered.">		for (UnitType type : spec.getUnitTypesWithAbility(Ability.FOUND_COLONY)) {</span>
<span class="fc" id="L577">			int p = europe.getUnitPrice(type);</span>
<span class="pc bpc" id="L578" title="1 of 4 branches missed.">			if (p != UNDEFINED &amp;&amp; p &lt; price)</span>
<span class="nc" id="L579">				price = p;</span>
<span class="fc" id="L580">		}</span>
<span class="fc" id="L581">		goldNeeded += price;</span>
<span class="fc bfc" id="L582" title="All 2 branches covered.">		if (checkGold(goldNeeded)) {</span>
<span class="fc" id="L583">			logger.info(getName() + &quot; alive, can buy colonist.&quot;);</span>
<span class="fc" id="L584">			return IS_ALIVE;</span>
		}

		// Col1 auto-recruits a unit in Europe if you run out before
		// the cutover year.
<span class="fc" id="L589">		logger.info(getName() + &quot; survives by autorecruit.&quot;);</span>
<span class="fc" id="L590">		return AUTORECRUIT;</span>
	}

	/**
	 * Check if a REF player has been defeated and should surrender.
	 *
	 * @return True if this REF player has been defeated.
	 */
	public boolean checkForREFDefeat() {
<span class="nc bnc" id="L599" title="All 2 branches missed.">		if (!isREF()) {</span>
<span class="nc" id="L600">			throw new IllegalStateException(&quot;Checking for REF player defeat when player not REF.&quot;);</span>
		}

		// No one to fight? Either the rebels are dead, or the REF
		// was already defeated and the rebels are independent.
		// Either way, it does not need to surrender.
<span class="nc bnc" id="L606" title="All 2 branches missed.">		if (getRebels().isEmpty())</span>
<span class="nc" id="L607">			return false;</span>

		// Not defeated if there are settlements.
<span class="nc bnc" id="L610" title="All 2 branches missed.">		if (!getSettlements().isEmpty())</span>
<span class="nc" id="L611">			return false;</span>

		// Not defeated if there is a non-zero navy and enough land units.
<span class="nc" id="L614">		final int landREFUnitsRequired = 7; // FIXME: magic number</span>
<span class="nc" id="L615">		final CombatModel cm = getGame().getCombatModel();</span>
<span class="nc" id="L616">		boolean naval = false;</span>
<span class="nc" id="L617">		int land = 0;</span>
<span class="nc" id="L618">		int power = 0;</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">		for (Unit u : getUnits()) {</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">			if (u.isNaval())</span>
<span class="nc" id="L621">				naval = true;</span>
			else {
<span class="nc bnc" id="L623" title="All 2 branches missed.">				if (u.hasAbility(Ability.REF_UNIT)) {</span>
<span class="nc" id="L624">					land++;</span>
<span class="nc" id="L625">					power += cm.getOffencePower(u, null);</span>
				}
			}
<span class="nc" id="L628">		}</span>
<span class="nc bnc" id="L629" title="All 4 branches missed.">		if (naval &amp;&amp; land &gt;= landREFUnitsRequired)</span>
<span class="nc" id="L630">			return false;</span>

		// Still not defeated as long as military strength is greater
		// than the rebels.
<span class="nc" id="L634">		int rebelPower = 0;</span>
<span class="nc bnc" id="L635" title="All 2 branches missed.">		for (Player rebel : getRebels()) {</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">			rebelPower += rebel.getUnits().stream().filter(u -&gt; !u.isNaval())</span>
<span class="nc" id="L637">					.mapToDouble(u -&gt; cm.getOffencePower(u, null)).sum();</span>
<span class="nc" id="L638">		}</span>
<span class="nc bnc" id="L639" title="All 2 branches missed.">		if (power &gt; rebelPower)</span>
<span class="nc" id="L640">			return false;</span>

		// REF is defeated
<span class="nc" id="L643">		return true;</span>
	}

	/**
	 * Kill off a player and clear out its remains.
	 *
	 * +vis: Albeit killing the player makes visibility changes moot. +til:
	 * Fixes the appearance changes too.
	 *
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csKill(ChangeSet cs) {
<span class="nc" id="L656">		setDead(true);</span>
<span class="nc" id="L657">		cs.addPartial(See.all(), this, &quot;dead&quot;);</span>
<span class="nc" id="L658">		cs.addDead(this);</span>

		// Clean up missions and remove tension/alarm/stance.
<span class="nc bnc" id="L661" title="All 2 branches missed.">		for (Player other : getGame().getLivePlayers(this)) {</span>
<span class="nc bnc" id="L662" title="All 4 branches missed.">			if (isEuropean() &amp;&amp; other.isIndian()) {</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">				for (IndianSettlement s : other.getIndianSettlements()) {</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">					if (s.hasMissionary(this)) {</span>
<span class="nc" id="L665">						((ServerIndianSettlement) s).csKillMissionary(null, cs);</span>
					}
<span class="nc" id="L667">					s.getTile().cacheUnseen();// +til</span>
<span class="nc" id="L668">					((ServerIndianSettlement) s).removeAlarm(this);// -til</span>
<span class="nc" id="L669">				}</span>
<span class="nc" id="L670">				other.removeTension(this);</span>
			}
<span class="nc" id="L672">			other.setStance(this, null);</span>
<span class="nc" id="L673">		}</span>

		// Remove settlements. Update formerly owned tiles.
<span class="nc" id="L676">		List&lt;Settlement&gt; settlements = getSettlements();</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">		while (!settlements.isEmpty()) {</span>
<span class="nc" id="L678">			csDisposeSettlement(settlements.remove(0), cs);</span>
		}

		// Clean up remaining tile ownerships
<span class="nc bnc" id="L682" title="All 2 branches missed.">		for (Tile tile : getGame().getMap().getAllTiles()) {</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">			if (tile.getOwner() == this) {</span>
<span class="nc" id="L684">				tile.cacheUnseen();// +til</span>
<span class="nc" id="L685">				tile.changeOwnership(null, null);// -til</span>
<span class="nc" id="L686">				cs.add(See.perhaps().always(this), tile);</span>
			}
<span class="nc" id="L688">		}</span>

		// Remove units
<span class="nc" id="L691">		List&lt;Unit&gt; units = getUnits();</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">		while (!units.isEmpty()) {</span>
<span class="nc" id="L693">			Unit u = units.remove(0);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">			if (u.hasTile())</span>
<span class="nc" id="L695">				cs.add(See.perhaps(), u.getTile());</span>
<span class="nc" id="L696">			cs.addRemove(See.perhaps().always(this), u.getLocation(), u);// -vis(this)</span>
<span class="nc" id="L697">			u.dispose();</span>
<span class="nc" id="L698">		}</span>

		// Remove European stuff
<span class="nc bnc" id="L701" title="All 2 branches missed.">		if (market != null) {</span>
<span class="nc" id="L702">			market.dispose();</span>
<span class="nc" id="L703">			market = null;</span>
		}
<span class="nc bnc" id="L705" title="All 2 branches missed.">		if (monarch != null) {</span>
<span class="nc" id="L706">			monarch.dispose();</span>
<span class="nc" id="L707">			monarch = null;</span>
		}
<span class="nc bnc" id="L709" title="All 2 branches missed.">		if (europe != null) {</span>
<span class="nc" id="L710">			europe.dispose();</span>
<span class="nc" id="L711">			europe = null;</span>
		}
<span class="nc" id="L713">		currentFather = null;</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">		if (foundingFathers != null)</span>
<span class="nc" id="L715">			foundingFathers.clear();</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">		if (offeredFathers != null)</span>
<span class="nc" id="L717">			offeredFathers.clear();</span>
		// FIXME: stance and tension?
<span class="nc bnc" id="L719" title="All 2 branches missed.">		if (tradeRoutes != null)</span>
<span class="nc" id="L720">			tradeRoutes.clear();</span>
		// Retaining model messages for now
		// Retaining history for now
<span class="nc bnc" id="L723" title="All 2 branches missed.">		if (lastSales != null)</span>
<span class="nc" id="L724">			lastSales = null;</span>
<span class="nc" id="L725">		featureContainer.clear();</span>

<span class="nc" id="L727">		invalidateCanSeeTiles();// +vis(this)</span>
<span class="nc" id="L728">	}</span>

	/**
	 * Withdraw a player from the new world.
	 *
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csWithdraw(ChangeSet cs) {
<span class="nc" id="L737">		cs.addMessage(See.all(),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="nc bnc" id="L739" title="All 4 branches missed.">						((isEuropean() &amp;&amp; getPlayerType() == PlayerType.COLONIAL) ? &quot;model.player.dead.european&quot;</span>
								: &quot;model.player.dead.native&quot;),
<span class="nc" id="L741">						this).addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
<span class="nc" id="L742">		Game game = getGame();</span>
<span class="nc" id="L743">		cs.addGlobalHistory(game, new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.NATION_DESTROYED, null)</span>
<span class="nc" id="L744">				.addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
<span class="nc" id="L745">		csKill(cs);</span>
<span class="nc" id="L746">	}</span>

	/**
	 * Gets the remaining emigrants.
	 *
	 * @return the remaining emigrants
	 */
	public int getRemainingEmigrants() {
<span class="nc" id="L754">		return remainingEmigrants;</span>
	}

	/**
	 * Sets the remaining emigrants.
	 *
	 * @param emigrants
	 *            the new remaining emigrants
	 */
	public void setRemainingEmigrants(int emigrants) {
<span class="nc" id="L764">		remainingEmigrants = emigrants;</span>
<span class="nc" id="L765">	}</span>

	/**
	 * Checks whether the current founding father has been recruited.
	 *
	 * @return The new founding father, or null if none available or ready.
	 */
	public FoundingFather checkFoundingFather() {
<span class="nc" id="L773">		FoundingFather father = null;</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">		if (currentFather != null) {</span>
<span class="nc" id="L775">			int extraLiberty = getRemainingFoundingFatherCost();</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">			if (extraLiberty &lt;= 0) {</span>
<span class="nc" id="L777">				boolean overflow = getSpecification().getBoolean(GameOptions.SAVE_PRODUCTION_OVERFLOW);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">				setLiberty((overflow) ? -extraLiberty : 0);</span>
<span class="nc" id="L779">				father = currentFather;</span>
<span class="nc" id="L780">				currentFather = null;</span>
			}
		}
<span class="nc" id="L783">		return father;</span>
	}

	/**
	 * Checks whether to start recruiting a founding father.
	 *
	 * @return True if a new father should be chosen.
	 */
	public boolean canRecruitFoundingFather() {
<span class="nc" id="L792">		Specification spec = getGame().getSpecification();</span>
<span class="nc bnc" id="L793" title="All 3 branches missed.">		switch (getPlayerType()) {</span>
		case COLONIAL:
<span class="nc" id="L795">			break;</span>
		case REBEL:
		case INDEPENDENT:
<span class="nc bnc" id="L798" title="All 2 branches missed.">			if (!spec.getBoolean(GameOptions.CONTINUE_FOUNDING_FATHER_RECRUITMENT))</span>
<span class="nc" id="L799">				return false;</span>
			break;
		default:
<span class="nc" id="L802">			return false;</span>
		}
<span class="nc bnc" id="L804" title="All 6 branches missed.">		return canHaveFoundingFathers() &amp;&amp; currentFather == null &amp;&amp; !getSettlements().isEmpty()</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">				&amp;&amp; getFatherCount() &lt; spec.getFoundingFathers().size();</span>
	}

	/**
	 * Build a list of random FoundingFathers, one per type. Do not include any
	 * the player has or are not available.
	 *
	 * @param random
	 *            A pseudo-random number source.
	 * @return A list of FoundingFathers.
	 */
	public List&lt;FoundingFather&gt; getRandomFoundingFathers(Random random) {
		// Build weighted random choice for each father type
<span class="nc" id="L818">		final Game game = getGame();</span>
<span class="nc" id="L819">		final Specification spec = game.getSpecification();</span>
<span class="nc" id="L820">		final int age = game.getAge();</span>
<span class="nc" id="L821">		EnumMap&lt;FoundingFatherType, List&lt;RandomChoice&lt;FoundingFather&gt;&gt;&gt; choices = new EnumMap&lt;&gt;(</span>
				FoundingFatherType.class);
<span class="nc bnc" id="L823" title="All 2 branches missed.">		for (FoundingFather father : spec.getFoundingFathers()) {</span>
<span class="nc bnc" id="L824" title="All 4 branches missed.">			if (!hasFather(father) &amp;&amp; father.isAvailableTo(this)) {</span>
<span class="nc" id="L825">				FoundingFatherType type = father.getType();</span>
<span class="nc" id="L826">				List&lt;RandomChoice&lt;FoundingFather&gt;&gt; rc = choices.get(type);</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">				if (rc == null)</span>
<span class="nc" id="L828">					rc = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L829">				int weight = father.getWeight(age);</span>
<span class="nc" id="L830">				rc.add(new RandomChoice&lt;&gt;(father, weight));</span>
<span class="nc" id="L831">				choices.put(father.getType(), rc);</span>
			}
<span class="nc" id="L833">		}</span>

		// Select one from each father type
<span class="nc" id="L836">		List&lt;FoundingFather&gt; randomFathers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L837">		LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L838">		lb.add(&quot;Random fathers for &quot;, getDebugName());</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">		for (FoundingFatherType type : FoundingFatherType.values()) {</span>
<span class="nc" id="L840">			List&lt;RandomChoice&lt;FoundingFather&gt;&gt; rc = choices.get(type);</span>
<span class="nc bnc" id="L841" title="All 2 branches missed.">			if (rc != null) {</span>
<span class="nc" id="L842">				FoundingFather f = RandomChoice.getWeightedRandom(logger, &quot;Choose founding father&quot;, rc, random);</span>
<span class="nc bnc" id="L843" title="All 2 branches missed.">				if (f != null) {</span>
<span class="nc" id="L844">					randomFathers.add(f);</span>
<span class="nc" id="L845">					lb.add(&quot;:&quot;, f.getSuffix());</span>
				}
			}
		}
<span class="nc" id="L849">		lb.log(logger, Level.INFO);</span>
<span class="nc" id="L850">		return randomFathers;</span>
	}

	/**
	 * Add a HistoryEvent to this player.
	 *
	 * @param event
	 *            The &lt;code&gt;HistoryEvent&lt;/code&gt; to add.
	 */
	@Override
	public void addHistory(HistoryEvent event) {
<span class="fc" id="L861">		history.add(event);</span>
<span class="fc" id="L862">	}</span>

	/**
	 * Update the current score for this player.
	 *
	 * Known incompatibility with the Col1 manual: ``In addition, you get one
	 * point per liberty bell produced after foreign intervention'' However you
	 * are already getting a point per liberty bell produced, so this implies
	 * you get no further liberty after declaring independence!?, but it can
	 * then start again if the foreign intervention happens (penalizing players
	 * who quickly thrash the REF:-S). Whatever this really means, it is
	 * incompatible with our extensions to allow playing on (and defeating other
	 * Europeans), so for now at least just leave the simple liberty==score rule
	 * in place.
	 *
	 * @return True if the player score changed.
	 */
	public boolean updateScore() {
<span class="nc" id="L880">		int oldScore = score;</span>
<span class="nc" id="L881">		score = getUnits().stream().mapToInt(u -&gt; u.getType().getScoreValue()).sum()</span>
<span class="nc" id="L882">				+ getColonies().stream().mapToInt(c -&gt; c.getLiberty()).sum()</span>
<span class="nc" id="L883">				+ SCORE_FOUNDING_FATHER * getFathers().size();</span>
<span class="nc" id="L884">		int gold = getGold();</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">		if (gold != GOLD_NOT_ACCOUNTED) {</span>
<span class="nc" id="L886">			score += (int) Math.floor(SCORE_GOLD * gold);</span>
		}

<span class="nc" id="L889">		int bonus = 0;</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">		for (HistoryEvent h : getHistory()) {</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">			if (getId().equals(h.getPlayerId())) {</span>
<span class="pc bnc" id="L892" title="All 2 branches missed.">				switch (h.getEventType()) {</span>
				case INDEPENDENCE:
<span class="nc bnc" id="L894" title="All 4 branches missed.">					switch (h.getScore()) {</span>
					case 0:
<span class="nc" id="L896">						bonus = SCORE_INDEPENDENCE_BONUS_FIRST;</span>
<span class="nc" id="L897">						break;</span>
					case 1:
<span class="nc" id="L899">						bonus = SCORE_INDEPENDENCE_BONUS_SECOND;</span>
<span class="nc" id="L900">						break;</span>
					case 2:
<span class="nc" id="L902">						bonus = SCORE_INDEPENDENCE_BONUS_THIRD;</span>
<span class="nc" id="L903">						break;</span>
					default:
<span class="nc" id="L905">						bonus = 0;</span>
<span class="nc" id="L906">						break;</span>
					}
					break;
				default:
<span class="nc" id="L910">					score += h.getScore();</span>
					break;
				}
			}
<span class="nc" id="L914">		}</span>
<span class="nc" id="L915">		score += (score * bonus) / 100;</span>

<span class="nc bnc" id="L917" title="All 2 branches missed.">		return score != oldScore;</span>
	}

	/**
	 * Checks if this &lt;code&gt;Player&lt;/code&gt; has explored the given
	 * &lt;code&gt;Tile&lt;/code&gt;.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt;.
	 * @return &lt;i&gt;true&lt;/i&gt; if the &lt;code&gt;Tile&lt;/code&gt; has been explored and
	 *         &lt;i&gt;false&lt;/i&gt; otherwise.
	 */
	@Override
	public boolean hasExplored(Tile tile) {
<span class="fc" id="L931">		return tile.isExploredBy(this);</span>
	}

	/**
	 * Sets the given tile to be explored by this player and updates the
	 * player's information about the tile.
	 * 
	 * +til: Exploring the tile also updates the pet.
	 *
	 * @param tile
	 *            the tile
	 * @return True if the tile is newly explored by this action.
	 */
	public boolean exploreTile(Tile tile) {
<span class="fc bfc" id="L945" title="All 2 branches covered.">		boolean ret = !hasExplored(tile);</span>
<span class="fc bfc" id="L946" title="All 2 branches covered.">		if (ret)</span>
<span class="fc" id="L947">			tile.setExplored(this, true);</span>
<span class="fc" id="L948">		return ret;</span>
	}

	/**
	 * Sets the tiles within the given &lt;code&gt;Unit&lt;/code&gt;'s line of sight to be
	 * explored by this player.
	 *
	 * @param tiles
	 *            A list of &lt;code&gt;Tile&lt;/code&gt;s.
	 * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
	 * @see #hasExplored
	 */
	public Set&lt;Tile&gt; exploreTiles(Collection&lt;? extends Tile&gt; tiles) {
<span class="fc" id="L961">		Set&lt;Tile&gt; result = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L962" title="All 2 branches covered.">		for (Tile t : tiles) {</span>
<span class="fc bfc" id="L963" title="All 2 branches covered.">			if (exploreTile(t))</span>
<span class="fc" id="L964">				result.add(t);</span>
<span class="fc" id="L965">		}</span>
<span class="fc" id="L966">		return result;</span>
	}

	/**
	 * Sets the tiles visible to a given settlement to be explored by this
	 * player and updates the player's information about the tiles. Note that
	 * the player does not necessarily own the settlement (e.g. missionary at
	 * native settlement).
	 *
	 * @param settlement
	 *            the settlement
	 * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
	 */
	public Set&lt;Tile&gt; exploreForSettlement(Settlement settlement) {
<span class="fc" id="L980">		Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;(settlement.getOwnedTiles());</span>
<span class="fc" id="L981">		tiles.addAll(settlement.getTile().getSurroundingTiles(1, settlement.getLineOfSight()));</span>
<span class="fc" id="L982">		return exploreTiles(tiles);</span>
	}

	/**
	 * Sets the tiles within the given &lt;code&gt;Unit&lt;/code&gt;'s line of sight to be
	 * explored by this player.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt;.
	 * @return A list of newly explored &lt;code&gt;Tile&lt;/code&gt;s.
	 * @see #hasExplored
	 */
	public Set&lt;Tile&gt; exploreForUnit(Unit unit) {
<span class="pc bpc" id="L995" title="3 of 6 branches missed.">		return (getGame() == null || getGame().getMap() == null || unit == null</span>
<span class="fc bfc" id="L996" title="All 2 branches covered.">				|| !(unit.getLocation() instanceof Tile)) ? Collections.&lt;Tile&gt;emptySet()</span>
<span class="fc" id="L997">						: exploreTiles(unit.getTile().getSurroundingTiles(0, unit.getLineOfSight()));</span>
	}

	/**
	 * Makes the entire map visible or invisible.
	 *
	 * @param reveal
	 *            If true, reveal the map, if false, hide it.
	 * @return A list of tiles whose visibility changed.
	 */
	public Set&lt;Tile&gt; exploreMap(boolean reveal) {
<span class="fc" id="L1008">		Set&lt;Tile&gt; result = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L1009" title="All 2 branches covered.">		for (Tile tile : getGame().getMap().getAllTiles()) {</span>
<span class="pc bpc" id="L1010" title="1 of 2 branches missed.">			if (hasExplored(tile) != reveal) {</span>
<span class="fc" id="L1011">				tile.setExplored(this, reveal);// -vis(this)</span>
<span class="fc" id="L1012">				result.add(tile);</span>
			}
<span class="fc" id="L1014">		}</span>
<span class="fc" id="L1015">		invalidateCanSeeTiles();// +vis(this)</span>
<span class="pc bpc" id="L1016" title="1 of 2 branches missed.">		if (!reveal) {</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">			for (Settlement s : getSettlements())</span>
<span class="nc" id="L1018">				exploreForSettlement(s);</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">			for (Unit u : getUnits())</span>
<span class="nc" id="L1020">				exploreForUnit(u);</span>
		}
<span class="fc" id="L1022">		return result;</span>
	}

	/**
	 * Try to reassign the ownership of a collection of tiles.
	 *
	 * Do it in two passes so the first successful claim does not give a large
	 * advantage.
	 *
	 * @param tiles
	 *            The collection of &lt;code&gt;Tile&lt;/code&gt;s to reassign.
	 * @param prefer
	 *            An optional &lt;code&gt;Player&lt;/code&gt; to prefer to reassign to.
	 * @param avoid
	 *            An optional &lt;code&gt;Settlement&lt;/code&gt; to consider last when
	 *            making claims.
	 */
	private static void reassignTiles(Collection&lt;Tile&gt; tiles, Player prefer, Settlement avoid) {
<span class="fc" id="L1040">		HashMap&lt;Settlement, Integer&gt; votes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1041">		HashMap&lt;Tile, Settlement&gt; claims = new HashMap&lt;&gt;();</span>
		Settlement claimant;
<span class="fc bfc" id="L1043" title="All 2 branches covered.">		for (Tile tile : tiles) {</span>
<span class="pc bpc" id="L1044" title="1 of 2 branches missed.">			if (tile.isOccupied())</span>
<span class="nc" id="L1045">				continue;</span>
<span class="fc" id="L1046">			votes.clear();</span>
<span class="fc bfc" id="L1047" title="All 2 branches covered.">			for (Tile t : tile.getSurroundingTiles(1)) {</span>
<span class="fc" id="L1048">				claimant = t.getOwningSettlement();</span>
<span class="fc bfc" id="L1049" title="All 2 branches covered.">				if (claimant != null</span>
						// BR#3375773 found a case where tiles were
						// still owned by a settlement that had been
						// previously destroyed. These should be gone, but...
<span class="pc bpc" id="L1053" title="2 of 6 branches missed.">						&amp;&amp; !claimant.isDisposed() &amp;&amp; claimant.getOwner() != null &amp;&amp; claimant.getOwner().canOwnTile(tile)</span>
<span class="pc bpc" id="L1054" title="1 of 2 branches missed.">						&amp;&amp; (claimant.getOwner().isIndian()</span>
<span class="pc bpc" id="L1055" title="1 of 2 branches missed.">								|| claimant.getTile().getDistanceTo(tile) &lt;= claimant.getRadius())) {</span>
					// Weight claimant settlements:
					// settlements owned by the same player
					// &gt; settlements owned by same type of player
					// &gt; other settlements
<span class="pc bpc" id="L1060" title="1 of 2 branches missed.">					int value = (prefer == null) ? 1</span>
<span class="pc bpc" id="L1061" title="1 of 2 branches missed.">							: (claimant.getOwner() == prefer) ? 3</span>
<span class="pc bnc" id="L1062" title="All 2 branches missed.">									: (claimant.getOwner().isEuropean() == prefer.isEuropean()) ? 2 : 1;</span>
<span class="pc bpc" id="L1063" title="1 of 2 branches missed.">					if (votes.get(claimant) != null) {</span>
<span class="nc" id="L1064">						value += votes.get(claimant);</span>
					}
<span class="fc" id="L1066">					votes.put(claimant, value);</span>
				}
<span class="fc" id="L1068">			}</span>
<span class="fc" id="L1069">			boolean lastResort = false;</span>
<span class="fc" id="L1070">			int bestValue = 0;</span>
<span class="fc" id="L1071">			claimant = null;</span>
<span class="fc bfc" id="L1072" title="All 2 branches covered.">			for (Entry&lt;Settlement, Integer&gt; entry : votes.entrySet()) {</span>
<span class="pc bpc" id="L1073" title="1 of 2 branches missed.">				if (avoid == entry.getKey()) {</span>
<span class="fc" id="L1074">					lastResort = true;</span>
<span class="fc" id="L1075">					continue;</span>
				}
<span class="nc" id="L1077">				int value = entry.getValue();</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">				if (bestValue &lt; value) {</span>
<span class="nc" id="L1079">					bestValue = value;</span>
<span class="nc" id="L1080">					claimant = entry.getKey();</span>
				}
<span class="nc" id="L1082">			}</span>
<span class="pc bpc" id="L1083" title="1 of 4 branches missed.">			if (claimant == null &amp;&amp; lastResort)</span>
<span class="fc" id="L1084">				claimant = avoid;</span>
<span class="fc" id="L1085">			claims.put(tile, claimant);</span>
<span class="fc" id="L1086">		}</span>
<span class="fc bfc" id="L1087" title="All 2 branches covered.">		for (Entry&lt;Tile, Settlement&gt; e : claims.entrySet()) {</span>
<span class="fc" id="L1088">			Tile t = e.getKey();</span>
<span class="fc bfc" id="L1089" title="All 2 branches covered.">			if ((claimant = e.getValue()) == null) {</span>
<span class="fc" id="L1090">				t.changeOwnership(null, null);// -til</span>
			} else {
<span class="fc" id="L1092">				ServerPlayer newOwner = (ServerPlayer) claimant.getOwner();</span>
<span class="fc" id="L1093">				t.changeOwnership(newOwner, claimant);// -til</span>
			}
<span class="fc" id="L1095">		}</span>
<span class="fc" id="L1096">	}</span>

	/**
	 * Create units from a list of abstract units. Only used by Europeans at
	 * present.
	 *
	 * -vis: Visibility issues depending on location. -til: Tile appearance
	 * issue if created in a colony (not ATM)
	 *
	 * @param abstractUnits
	 *            The list of &lt;code&gt;AbstractUnit&lt;/code&gt;s to create.
	 * @param location
	 *            The &lt;code&gt;Location&lt;/code&gt; where the units will be created.
	 * @return A list of units created.
	 */
	public List&lt;Unit&gt; createUnits(List&lt;AbstractUnit&gt; abstractUnits, Location location) {
<span class="pc bpc" id="L1112" title="1 of 2 branches missed.">		if (location == null)</span>
<span class="nc" id="L1113">			return Collections.&lt;Unit&gt;emptyList();</span>
<span class="fc" id="L1114">		List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L1116">		final Game game = getGame();</span>
<span class="fc" id="L1117">		final Specification spec = game.getSpecification();</span>
<span class="fc bfc" id="L1118" title="All 2 branches covered.">		for (AbstractUnit au : abstractUnits) {</span>
<span class="fc" id="L1119">			UnitType type = au.getType(spec);</span>
<span class="fc" id="L1120">			Role role = au.getRole(spec);</span>
			// @compat 0.10.x
			// The REF always had an exemption from the availability
			// rules. We are transitioning to it being subject to the
			// normal rules, which requires REF nations to have the
			// INDEPENDENT_NATION ability (or they do not get
			// man-o-war). We are also handling the role transition.
			//
			// Drop the isREF() branch when the compatibility code
			// goes away.
<span class="fc bfc" id="L1130" title="All 2 branches covered.">			if (isREF()) {</span>
<span class="pc bpc" id="L1131" title="1 of 2 branches missed.">				if (!role.isAvailableTo(this, type)) {</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">					if (null != role.getId())</span>
<span class="nc bnc" id="L1133" title="All 10 branches missed.">						switch (role.getId()) {</span>
						case &quot;model.role.soldier&quot;:
<span class="nc" id="L1135">							role = spec.getRole(&quot;model.role.infantry&quot;);</span>
<span class="nc" id="L1136">							break;</span>
						case &quot;model.role.dragoon&quot;:
<span class="nc" id="L1138">							role = spec.getRole(&quot;model.role.cavalry&quot;);</span>
<span class="nc" id="L1139">							break;</span>
						}
				}
			} else {
<span class="pc bpc" id="L1143" title="1 of 2 branches missed.">				if (!type.isAvailableTo(this)) {</span>
<span class="nc" id="L1144">					logger.warning(&quot;Ignoring abstract unit &quot; + au + &quot; unavailable to: &quot; + getId());</span>
<span class="nc" id="L1145">					continue;</span>
				}
<span class="pc bpc" id="L1147" title="1 of 2 branches missed.">				if (!role.isAvailableTo(this, type)) {</span>
<span class="nc" id="L1148">					logger.warning(</span>
<span class="nc" id="L1149">							&quot;Ignoring abstract unit &quot; + au + &quot; with role &quot; + role + &quot; unavailable to: &quot; + getId());</span>
<span class="nc" id="L1150">					continue;</span>
				}
			}
			// end @compat 0.10.x
<span class="fc bfc" id="L1154" title="All 2 branches covered.">			for (int i = 0; i &lt; au.getNumber(); i++) {</span>
<span class="fc" id="L1155">				ServerUnit su = new ServerUnit(game, location, this, type, role);// -vis(this)</span>
<span class="fc" id="L1156">				units.add(su);</span>
			}
<span class="fc" id="L1158">		}</span>
<span class="fc" id="L1159">		return units;</span>
	}

	/**
	 * Embark the land units. For all land units, find a naval unit to carry it.
	 * Fill greedily, so as if there is excess naval capacity then the naval
	 * units at the end of the list will tend to be empty or very lightly
	 * filled, allowing them to defend the whole fleet at full strength. Returns
	 * a list of units that could not be placed on ships.
	 *
	 * -vis: Has visibility implications depending on the initial location of
	 * the loaded units. Usually ATM this is Europe which is safe, but beware.
	 * -til: Safe while in Europe though.
	 *
	 * @param landUnits
	 *            A list of land units to put on ships.
	 * @param navalUnits
	 *            A list of ships to put land units on.
	 * @param random
	 *            A pseudo-random number source.
	 * @return a list of units left over
	 */
	public List&lt;Unit&gt; loadShips(List&lt;Unit&gt; landUnits, List&lt;Unit&gt; navalUnits, Random random) {
<span class="fc" id="L1182">		List&lt;Unit&gt; leftOver = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1183">		randomShuffle(logger, &quot;Naval load&quot;, navalUnits, random);</span>
<span class="fc" id="L1184">		randomShuffle(logger, &quot;Land load&quot;, landUnits, random);</span>
<span class="fc" id="L1185">		LogBuilder lb = new LogBuilder(256);</span>
<span class="fc" id="L1186">		lb.mark();</span>
<span class="fc bfc" id="L1187" title="All 2 branches covered.">		landUnit: for (Unit unit : landUnits) {</span>
<span class="pc bpc" id="L1188" title="1 of 2 branches missed.">			for (Unit carrier : navalUnits) {</span>
<span class="fc bfc" id="L1189" title="All 2 branches covered.">				if (carrier.canAdd(unit)) {</span>
<span class="fc" id="L1190">					unit.setLocation(carrier);// -vis(owner)</span>
<span class="fc" id="L1191">					lb.add(unit, &quot; -&gt; &quot;, carrier, &quot;, &quot;);</span>
<span class="fc" id="L1192">					continue landUnit;</span>
				}
<span class="fc" id="L1194">			}</span>
<span class="nc" id="L1195">			leftOver.add(unit);</span>
<span class="nc" id="L1196">		}</span>
<span class="pc bpc" id="L1197" title="1 of 2 branches missed.">		if (lb.grew(&quot;Load ships: &quot;)) {</span>
<span class="fc" id="L1198">			lb.shrink(&quot;, &quot;);</span>
<span class="fc" id="L1199">			lb.log(logger, Level.FINEST);</span>
		}
<span class="fc" id="L1201">		return leftOver;</span>
	}

	/**
	 * Calculates the price of a group of mercenaries for this player.
	 *
	 * @param mercenaries
	 *            A list of mercenaries to price.
	 * @return The price.
	 */
	public int priceMercenaries(List&lt;AbstractUnit&gt; mercenaries) {
<span class="nc" id="L1212">		int mercPrice = mercenaries.stream().mapToInt(au -&gt; getPrice(au)).sum();</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">		if (!checkGold(mercPrice))</span>
<span class="nc" id="L1214">			mercPrice = getGold();</span>
<span class="nc" id="L1215">		return mercPrice;</span>
	}

	/**
	 * Flush any market price changes.
	 *
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @return True if the market has changed.
	 */
	public boolean csFlushMarket(ChangeSet cs) {
<span class="fc" id="L1226">		Market market = getMarket();</span>
<span class="pc bpc" id="L1227" title="1 of 2 branches missed.">		if (market == null)</span>
<span class="nc" id="L1228">			return false;</span>
<span class="fc" id="L1229">		boolean ret = false;</span>
<span class="fc" id="L1230">		StringBuilder sb = new StringBuilder(32);</span>
<span class="fc" id="L1231">		sb.append(&quot;Flush market for &quot;).append(getId()).append(&quot;:&quot;);</span>
<span class="fc bfc" id="L1232" title="All 2 branches covered.">		for (GoodsType type : getSpecification().getGoodsTypeList()) {</span>
<span class="fc bfc" id="L1233" title="All 2 branches covered.">			if (csFlushMarket(type, cs)) {</span>
<span class="fc" id="L1234">				sb.append(&quot; &quot;).append(type.getId());</span>
<span class="fc" id="L1235">				ret = true;</span>
			}
<span class="fc" id="L1237">		}</span>
<span class="fc bfc" id="L1238" title="All 2 branches covered.">		if (ret)</span>
<span class="fc" id="L1239">			logger.finest(sb.toString());</span>
<span class="fc" id="L1240">		return ret;</span>
	}

	/**
	 * Flush any market price changes for a specified goods type.
	 *
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to check.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @return True if the market price had changed.
	 */
	public boolean csFlushMarket(GoodsType type, ChangeSet cs) {
<span class="fc" id="L1253">		final Market market = getMarket();</span>
<span class="fc" id="L1254">		boolean ret = market.hasPriceChanged(type);</span>
<span class="fc bfc" id="L1255" title="All 2 branches covered.">		if (ret) {</span>
			// This type of goods has changed price, so we will update
			// the market and send a message as well.
<span class="fc" id="L1258">			cs.addMessage(See.only(this), market.makePriceChangeMessage(type));</span>
<span class="fc" id="L1259">			market.flushPriceChange(type);</span>
<span class="fc" id="L1260">			cs.add(See.only(this), market.getMarketData(type));</span>
		}
<span class="fc" id="L1262">		return ret;</span>
	}

	/**
	 * Buy goods in Europe.
	 *
	 * @param container
	 *            The &lt;code&gt;GoodsContainer&lt;/code&gt; to carry the goods.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to buy.
	 * @param amount
	 *            The amount of goods to buy.
	 * @return The amount actually removed from the market, or negative on
	 *         failure.
	 */
	public int buy(GoodsContainer container, GoodsType type, int amount) {
<span class="fc" id="L1278">		final Market market = getMarket();</span>
<span class="fc" id="L1279">		final int price = market.getBidPrice(type, amount);</span>
<span class="fc bfc" id="L1280" title="All 2 branches covered.">		if (!checkGold(price))</span>
<span class="fc" id="L1281">			return -1;</span>

<span class="fc" id="L1283">		modifyGold(-price);</span>
<span class="fc" id="L1284">		market.modifySales(type, -amount);</span>
<span class="pc bpc" id="L1285" title="1 of 2 branches missed.">		if (container != null)</span>
<span class="fc" id="L1286">			container.addGoods(type, amount);</span>
<span class="fc" id="L1287">		market.modifyIncomeBeforeTaxes(type, -price);</span>
<span class="fc" id="L1288">		market.modifyIncomeAfterTaxes(type, -price);</span>
<span class="fc" id="L1289">		int marketAmount = (int) applyModifiers((float) amount, getGame().getTurn(), Modifier.TRADE_BONUS, type);</span>
<span class="fc" id="L1290">		market.addGoodsToMarket(type, -marketAmount);</span>
<span class="fc" id="L1291">		return marketAmount;</span>
	}

	/**
	 * Sell goods in Europe.
	 *
	 * @param container
	 *            An optional &lt;code&gt;GoodsContainer&lt;/code&gt; carrying the goods.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to sell.
	 * @param amount
	 *            The amount of goods to sell.
	 * @return The amount actually added to the market, or negative on failure.
	 */
	public int sell(GoodsContainer container, GoodsType type, int amount) {
<span class="fc" id="L1306">		final Market market = getMarket();</span>
<span class="fc" id="L1307">		final int tax = getTax();</span>
<span class="fc" id="L1308">		final int incomeBeforeTaxes = market.getSalePrice(type, amount);</span>
<span class="fc" id="L1309">		final int incomeAfterTaxes = ((100 - tax) * incomeBeforeTaxes) / 100;</span>

<span class="fc" id="L1311">		modifyGold(incomeAfterTaxes);</span>
<span class="fc" id="L1312">		market.modifySales(type, amount);</span>
<span class="fc bfc" id="L1313" title="All 2 branches covered.">		if (container != null)</span>
<span class="fc" id="L1314">			container.addGoods(type, -amount);</span>
<span class="fc" id="L1315">		market.modifyIncomeBeforeTaxes(type, incomeBeforeTaxes);</span>
<span class="fc" id="L1316">		market.modifyIncomeAfterTaxes(type, incomeAfterTaxes);</span>
<span class="fc" id="L1317">		int marketAmount = (int) applyModifiers((float) amount, getGame().getTurn(), Modifier.TRADE_BONUS, type);</span>
<span class="fc" id="L1318">		market.addGoodsToMarket(type, marketAmount);</span>
<span class="fc" id="L1319">		return marketAmount;</span>
	}

	/**
	 * Adds a player to the list of players for whom the stance has changed.
	 *
	 * @param other
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to add.
	 */
	public void addStanceChange(ServerPlayer other) {
<span class="fc bfc" id="L1329" title="All 2 branches covered.">		if (!stanceDirty.contains(other))</span>
<span class="fc" id="L1330">			stanceDirty.add(other);</span>
<span class="fc" id="L1331">	}</span>

	/**
	 * Modifies stance.
	 *
	 * @param stance
	 *            The new &lt;code&gt;Stance&lt;/code&gt;.
	 * @param otherPlayer
	 *            The &lt;code&gt;Player&lt;/code&gt; wrt which the stance changes.
	 * @param symmetric
	 *            If true, change the otherPlayer stance as well.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @return True if there was a change in stance at all.
	 */
	public boolean csChangeStance(Stance stance, ServerPlayer otherPlayer, boolean symmetric, ChangeSet cs) {
<span class="fc" id="L1347">		ServerPlayer other = otherPlayer;</span>
<span class="fc" id="L1348">		boolean change = false;</span>
<span class="fc" id="L1349">		Stance old = getStance(otherPlayer);</span>

<span class="fc bfc" id="L1351" title="All 2 branches covered.">		if (old != stance) {</span>
<span class="fc" id="L1352">			int modifier = old.getTensionModifier(stance);</span>
<span class="fc" id="L1353">			setStance(otherPlayer, stance);</span>
<span class="fc bfc" id="L1354" title="All 2 branches covered.">			if (modifier != 0) {</span>
<span class="fc" id="L1355">				csModifyTension(otherPlayer, modifier, cs);// +til</span>
			}
<span class="fc" id="L1357">			cs.addHistory(this,</span>
<span class="fc" id="L1358">					new HistoryEvent(getGame().getTurn(), HistoryEvent.getEventTypeFromStance(stance), otherPlayer)</span>
<span class="fc" id="L1359">							.addStringTemplate(&quot;%nation%&quot;, otherPlayer.getNationLabel()));</span>
<span class="fc" id="L1360">			logger.info(</span>
<span class="fc" id="L1361">					&quot;Stance modification &quot; + getName() + &quot; &quot; + old + &quot; -&gt; &quot; + stance + &quot; wrt &quot; + otherPlayer.getName());</span>
<span class="fc" id="L1362">			this.addStanceChange(other);</span>
<span class="fc bfc" id="L1363" title="All 2 branches covered.">			if (old != Stance.UNCONTACTED) {</span>
<span class="fc" id="L1364">				cs.addMessage(See.only(other),</span>
<span class="fc" id="L1365">						new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, stance.getStanceChangeKey(), this)</span>
<span class="fc" id="L1366">								.addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
			}
<span class="fc" id="L1368">			cs.addStance(See.only(this), this, stance, otherPlayer);</span>
<span class="fc" id="L1369">			cs.addStance(See.only(other), this, stance, otherPlayer);</span>
<span class="fc" id="L1370">			change = true;</span>
		}
<span class="fc bfc" id="L1372" title="All 4 branches covered.">		if (symmetric &amp;&amp; (old = otherPlayer.getStance(this)) != stance) {</span>
<span class="fc" id="L1373">			int modifier = old.getTensionModifier(stance);</span>
<span class="fc" id="L1374">			otherPlayer.setStance(this, stance);</span>
<span class="fc bfc" id="L1375" title="All 2 branches covered.">			if (modifier != 0) {</span>
<span class="fc" id="L1376">				other.csModifyTension(this, modifier, cs);// +til</span>
			}
<span class="fc" id="L1378">			cs.addHistory(otherPlayer,</span>
<span class="fc" id="L1379">					new HistoryEvent(getGame().getTurn(), HistoryEvent.getEventTypeFromStance(stance), this)</span>
<span class="fc" id="L1380">							.addStringTemplate(&quot;%nation%&quot;, this.getNationLabel()));</span>
<span class="fc" id="L1381">			logger.info(&quot;Stance modification &quot; + otherPlayer.getName() + &quot; &quot; + old + &quot; -&gt; &quot; + stance + &quot; wrt &quot;</span>
<span class="fc" id="L1382">					+ getName() + &quot; (symmetric)&quot;);</span>
<span class="fc" id="L1383">			other.addStanceChange(this);</span>
<span class="fc bfc" id="L1384" title="All 2 branches covered.">			if (old != Stance.UNCONTACTED) {</span>
<span class="fc" id="L1385">				cs.addMessage(See.only(this),</span>
<span class="fc" id="L1386">						new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, stance.getStanceChangeKey(),</span>
<span class="fc" id="L1387">								otherPlayer).addStringTemplate(&quot;%nation%&quot;, otherPlayer.getNationLabel()));</span>
			}
<span class="fc" id="L1389">			cs.addStance(See.only(this), otherPlayer, stance, this);</span>
<span class="fc" id="L1390">			cs.addStance(See.only(other), otherPlayer, stance, this);</span>
<span class="fc" id="L1391">			change = true;</span>
		}

<span class="fc" id="L1394">		return change;</span>
	}

	/**
	 * Modifies the hostility against the given player.
	 *
	 * +til: Handles tile modifications.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt;.
	 * @param add
	 *            The amount to add to the current tension level.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csModifyTension(Player player, int add, ChangeSet cs) {
<span class="fc" id="L1410">		csModifyTension(player, add, null, cs);</span>
<span class="fc" id="L1411">	}</span>

	/**
	 * Modifies the hostility against the given player.
	 *
	 * +til: Handles tile modifications.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt;.
	 * @param add
	 *            The amount to add to the current tension level.
	 * @param origin
	 *            A &lt;code&gt;Settlement&lt;/code&gt; where the alarming event occurred.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csModifyTension(Player player, int add, Settlement origin, ChangeSet cs) {
<span class="fc" id="L1428">		Tension.Level oldLevel = getTension(player).getLevel();</span>
<span class="fc" id="L1429">		getTension(player).modify(add);</span>
<span class="fc bfc" id="L1430" title="All 2 branches covered.">		if (oldLevel != getTension(player).getLevel()) {</span>
<span class="fc" id="L1431">			cs.add(See.only((ServerPlayer) player), this);</span>
		}

		// Propagate tension change as settlement alarm to all
		// settlements except the one that originated it (if any).
<span class="fc bfc" id="L1436" title="All 2 branches covered.">		if (isIndian()) {</span>
<span class="fc bfc" id="L1437" title="All 2 branches covered.">			for (IndianSettlement is : getIndianSettlements()) {</span>
<span class="fc bfc" id="L1438" title="All 4 branches covered.">				if (is == origin || !is.hasContacted(player))</span>
<span class="fc" id="L1439">					continue;</span>
<span class="fc" id="L1440">				((ServerIndianSettlement) is).csModifyAlarm(player, add, false, cs);// +til</span>
<span class="fc" id="L1441">			}</span>
		}
<span class="fc" id="L1443">	}</span>

	/**
	 * New turn for this player.
	 *
	 * @param random
	 *            A &lt;code&gt;Random&lt;/code&gt; number source.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	@Override
	public void csNewTurn(Random random, LogBuilder lb, ChangeSet cs) {
<span class="fc" id="L1457">		lb.add(&quot;PLAYER &quot;, getName(), &quot;: &quot;);</span>

		// Settlements
<span class="fc" id="L1460">		List&lt;Settlement&gt; settlements = new ArrayList&lt;&gt;(getSettlements());</span>
<span class="fc" id="L1461">		int newSoL = 0, newImmigration = getImmigration();</span>
<span class="fc bfc" id="L1462" title="All 2 branches covered.">		for (Settlement settlement : settlements) {</span>
<span class="fc" id="L1463">			((ServerModelObject) settlement).csNewTurn(random, lb, cs);</span>
<span class="fc" id="L1464">			newSoL += settlement.getSoL();</span>
<span class="fc" id="L1465">		}</span>
<span class="fc" id="L1466">		newImmigration = getImmigration() - newImmigration;</span>

<span class="fc" id="L1468">		int numberOfColonies = settlements.size();</span>
<span class="fc bfc" id="L1469" title="All 2 branches covered.">		if (numberOfColonies &gt; 0) {</span>
<span class="fc" id="L1470">			newSoL = newSoL / numberOfColonies;</span>
<span class="fc bfc" id="L1471" title="All 2 branches covered.">			if (oldSoL / 10 != newSoL / 10) {</span>
<span class="pc bpc" id="L1472" title="1 of 2 branches missed.">				cs.addMessage(See.only(this),</span>
						new ModelMessage(ModelMessage.MessageType.SONS_OF_LIBERTY,
								(newSoL &gt; oldSoL) ? &quot;model.player.soLIncrease&quot; : &quot;model.player.soLDecrease&quot;, this)
<span class="fc" id="L1475">										.addAmount(&quot;%oldSoL%&quot;, oldSoL).addAmount(&quot;%newSoL%&quot;, newSoL));</span>
			}
<span class="fc" id="L1477">			oldSoL = newSoL; // Remember SoL for check changes at next turn.</span>
		}

		// Europe.
<span class="fc bfc" id="L1481" title="All 2 branches covered.">		if (europe != null) {</span>
<span class="fc" id="L1482">			((ServerModelObject) europe).csNewTurn(random, lb, cs);</span>
<span class="fc" id="L1483">			modifyImmigration(europe.getImmigration(newImmigration));</span>
		}
		// Units.
<span class="fc bfc" id="L1486" title="All 2 branches covered.">		for (Unit unit : new ArrayList&lt;&gt;(getUnits())) {</span>
			try {
<span class="fc" id="L1488">				((ServerModelObject) unit).csNewTurn(random, lb, cs);</span>
<span class="nc" id="L1489">			} catch (ClassCastException e) {</span>
<span class="nc" id="L1490">				logger.log(Level.SEVERE, &quot;Not a ServerUnit: &quot; + unit.getId(), e);</span>
<span class="fc" id="L1491">			}</span>
<span class="fc" id="L1492">		}</span>

<span class="fc bfc" id="L1494" title="All 2 branches covered.">		if (isEuropean()) { // Update liberty and immigration</span>
			// Auto-emigrate if selection not allowed.
<span class="pc bpc" id="L1496" title="1 of 2 branches missed.">			if (hasAbility(Ability.SELECT_RECRUIT)) {</span>
<span class="nc" id="L1497">				cs.addPartial(See.only(this), this, &quot;immigration&quot;);</span>
			} else {
<span class="fc bfc" id="L1499" title="All 2 branches covered.">				while (checkEmigrate()) {</span>
<span class="fc" id="L1500">					csEmigrate(MigrationType.getUnspecificSlot(), MigrationType.NORMAL, random, cs);</span>
				}
			}
<span class="fc" id="L1503">			cs.addPartial(See.only(this), this, &quot;liberty&quot;);</span>

<span class="pc bpc" id="L1505" title="1 of 2 branches missed.">			if (getSpecification().getBoolean(GameOptions.ENABLE_UPKEEP)) {</span>
<span class="nc" id="L1506">				csPayUpkeep(random, cs);</span>
			}

<span class="fc" id="L1509">			int probability = getSpecification().getInteger(GameOptions.NATURAL_DISASTERS);</span>
<span class="pc bpc" id="L1510" title="1 of 2 branches missed.">			if (probability &gt; 0) {</span>
<span class="nc" id="L1511">				csNaturalDisasters(random, cs, probability);</span>
			}

<span class="pc bpc" id="L1514" title="3 of 4 branches missed.">			if (isRebel() &amp;&amp; interventionBells &gt;= getSpecification().getInteger(GameOptions.INTERVENTION_BELLS)) {</span>
<span class="nc" id="L1515">				interventionBells = Integer.MIN_VALUE;</span>

				// Enter near a port.
<span class="nc" id="L1518">				List&lt;Colony&gt; ports = getPorts();</span>
<span class="nc" id="L1519">				Colony port = getRandomMember(logger, &quot;Intervention port&quot;, ports, random);</span>
<span class="nc" id="L1520">				Tile portTile = port.getTile();</span>
<span class="nc" id="L1521">				Tile entry = getGame().getMap().searchCircle(portTile, GoalDeciders.getSimpleHighSeasGoalDecider(),</span>
<span class="nc" id="L1522">						portTile.getHighSeasCount() + 1).getSafeTile(this, random);</span>

				// Create the force.
				// @compat 0.10.5
				// We used to nullify the monarch when declaring independence.
				// There are saved games out there where this happened
				// (see BR#2435). Defend against NPE.
<span class="nc" id="L1529">				Monarch.Force ivf = null;</span>
<span class="nc bnc" id="L1530" title="All 2 branches missed.">				if (getMonarch() != null</span>
						// end @compat 0.10.5
<span class="nc bnc" id="L1532" title="All 2 branches missed.">						&amp;&amp; (ivf = getMonarch().getInterventionForce()) != null) {</span>
<span class="nc" id="L1533">					List&lt;Unit&gt; landUnits = createUnits(ivf.getLandUnits(), entry);// -vis(this)</span>
<span class="nc" id="L1534">					List&lt;Unit&gt; navalUnits = createUnits(ivf.getNavalUnits(), entry);// -vis(this)</span>
<span class="nc" id="L1535">					List&lt;Unit&gt; leftOver = loadShips(landUnits, navalUnits, random);// -vis(this)</span>
<span class="nc bnc" id="L1536" title="All 2 branches missed.">					for (Unit unit : leftOver) {</span>
						// no use for left over units
<span class="nc" id="L1538">						logger.warning(&quot;Disposing of left over unit &quot; + unit);</span>
<span class="nc" id="L1539">						unit.setLocationNoUpdate(null);// -vis: safe, off map</span>
<span class="nc" id="L1540">						unit.dispose();// -vis: safe, never sighted</span>
<span class="nc" id="L1541">					}</span>
<span class="nc" id="L1542">					Set&lt;Tile&gt; tiles = exploreForUnit(navalUnits.get(0));</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">					if (!tiles.contains(entry))</span>
<span class="nc" id="L1544">						tiles.add(entry);</span>
<span class="nc" id="L1545">					invalidateCanSeeTiles();// +vis(this)</span>
<span class="nc" id="L1546">					cs.add(See.perhaps(), tiles);</span>
<span class="nc" id="L1547">					cs.addMessage(See.only(this), new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
							&quot;model.player.interventionForceArrives&quot;, this));
<span class="nc" id="L1549">					logger.info(&quot;Intervention force (&quot; + navalUnits.size() + &quot; naval, &quot; + landUnits.size() + &quot; land, &quot;</span>
<span class="nc" id="L1550">							+ leftOver.size() + &quot; left over) arrives at &quot; + entry + &quot;(for &quot; + port.getName() + &quot;)&quot;);</span>
				}
			}
		}

		// Update stances
<span class="fc bfc" id="L1556" title="All 2 branches covered.">		while (!stanceDirty.isEmpty()) {</span>
<span class="fc" id="L1557">			ServerPlayer s = stanceDirty.remove(0);</span>
<span class="fc" id="L1558">			Stance sta = getStance(s);</span>
<span class="pc bpc" id="L1559" title="1 of 2 branches missed.">			boolean war = sta == Stance.WAR;</span>
<span class="pc bpc" id="L1560" title="1 of 2 branches missed.">			if (sta == Stance.UNCONTACTED)</span>
<span class="nc" id="L1561">				continue;</span>
<span class="fc bfc" id="L1562" title="All 2 branches covered.">			for (Player p : getGame().getLiveEuropeanPlayers(this)) {</span>
<span class="fc" id="L1563">				ServerPlayer sp = (ServerPlayer) p;</span>
<span class="pc bpc" id="L1564" title="3 of 6 branches missed.">				if (p == s || !p.hasContacted(this) || !p.hasContacted(s))</span>
<span class="nc" id="L1565">					continue;</span>
<span class="nc bnc" id="L1566" title="All 4 branches missed.">				if (p.hasAbility(Ability.BETTER_FOREIGN_AFFAIRS_REPORT) || war) {</span>
<span class="nc" id="L1567">					cs.addStance(See.only(sp), this, sta, s);</span>
<span class="nc" id="L1568">					cs.addMessage(See.only(sp),</span>
<span class="nc" id="L1569">							new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, sta.getOtherStanceChangeKey(),</span>
<span class="nc" id="L1570">									this).addStringTemplate(&quot;%attacker%&quot;, getNationLabel())</span>
<span class="nc" id="L1571">											.addStringTemplate(&quot;%defender%&quot;, s.getNationLabel()));</span>
				}
<span class="nc" id="L1573">			}</span>
<span class="fc" id="L1574">		}</span>
<span class="fc" id="L1575">	}</span>

	/**
	 * Cs pay upkeep.
	 *
	 * @param random
	 *            the random
	 * @param cs
	 *            the cs
	 */
	public void csPayUpkeep(Random random, ChangeSet cs) {
<span class="nc" id="L1586">		final Specification spec = getSpecification();</span>
<span class="nc" id="L1587">		final Disaster bankruptcy = spec.getDisaster(Disaster.BANKRUPTCY);</span>

<span class="nc" id="L1589">		boolean changed = false;</span>
<span class="nc" id="L1590">		int upkeep = getSettlements().stream().mapToInt(s -&gt; s.getUpkeep()).sum();</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">		if (checkGold(upkeep)) {</span>
<span class="nc" id="L1592">			modifyGold(-upkeep);</span>
<span class="nc bnc" id="L1593" title="All 2 branches missed.">			if (getBankrupt()) {</span>
<span class="nc" id="L1594">				setBankrupt(false);</span>
<span class="nc" id="L1595">				changed = true;</span>
				// the only effects of a disaster that can be reversed
				// are the modifiers
<span class="nc bnc" id="L1598" title="All 2 branches missed.">				for (RandomChoice&lt;Effect&gt; effect : bankruptcy.getEffects()) {</span>
<span class="nc bnc" id="L1599" title="All 2 branches missed.">					for (Modifier modifier : effect.getObject().getModifiers()) {</span>
<span class="nc" id="L1600">						cs.addFeatureChange(this, this, modifier, false);</span>
<span class="nc" id="L1601">					}</span>
<span class="nc" id="L1602">				}</span>
<span class="nc" id="L1603">				cs.addMessage(See.only(this), new ModelMessage(ModelMessage.MessageType.GOVERNMENT_EFFICIENCY,</span>
						&quot;model.player.disaster.bankruptcy.stop&quot;, this));
			}
		} else {
<span class="nc" id="L1607">			modifyGold(-getGold());</span>
<span class="nc bnc" id="L1608" title="All 2 branches missed.">			if (!getBankrupt()) {</span>
<span class="nc" id="L1609">				setBankrupt(true);</span>
<span class="nc" id="L1610">				changed = true;</span>
<span class="nc" id="L1611">				csApplyDisaster(random, null, bankruptcy, cs);</span>
<span class="nc" id="L1612">				cs.addMessage(See.only(this), new ModelMessage(ModelMessage.MessageType.GOVERNMENT_EFFICIENCY,</span>
						&quot;model.player.disaster.bankruptcy.start&quot;, this));
			}
		}
<span class="nc bnc" id="L1616" title="All 2 branches missed.">		if (upkeep &gt; 0)</span>
<span class="nc" id="L1617">			cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc bnc" id="L1618" title="All 2 branches missed.">		if (changed)</span>
<span class="nc" id="L1619">			cs.addPartial(See.only(this), this, &quot;bankrupt&quot;);</span>
<span class="nc" id="L1620">	}</span>

	/**
	 * Cs natural disasters.
	 *
	 * @param random
	 *            the random
	 * @param cs
	 *            the cs
	 * @param probability
	 *            the probability
	 */
	public void csNaturalDisasters(Random random, ChangeSet cs, int probability) {
<span class="nc bnc" id="L1633" title="All 2 branches missed.">		if (randomInt(logger, &quot;Natural disaster&quot;, random, 100) &lt; probability) {</span>
<span class="nc" id="L1634">			int size = getNumberOfSettlements();</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">			if (size &lt; 1)</span>
<span class="nc" id="L1636">				return;</span>
			// randomly select a colony to start with, then generate
			// an appropriate disaster if possible, else continue with
			// the next colony
<span class="nc" id="L1640">			int start = randomInt(logger, &quot;select colony&quot;, random, size);</span>
<span class="nc bnc" id="L1641" title="All 2 branches missed.">			for (int index = 0; index &lt; size; index++) {</span>
<span class="nc" id="L1642">				Colony colony = getColonies().get((start + index) % size);</span>
<span class="nc" id="L1643">				List&lt;RandomChoice&lt;Disaster&gt;&gt; disasters = colony.getDisasters();</span>
<span class="nc bnc" id="L1644" title="All 2 branches missed.">				if (!disasters.isEmpty()) {</span>
<span class="nc" id="L1645">					Disaster disaster = RandomChoice.getWeightedRandom(logger, &quot;select disaster&quot;, disasters, random);</span>
<span class="nc" id="L1646">					List&lt;ModelMessage&gt; messages = csApplyDisaster(random, colony, disaster, cs);</span>
<span class="nc bnc" id="L1647" title="All 2 branches missed.">					if (!messages.isEmpty()) {</span>
<span class="nc" id="L1648">						cs.addMessage(See.only(this),</span>
								new ModelMessage(ModelMessage.MessageType.DEFAULT, &quot;model.player.disaster.strikes&quot;,
<span class="nc" id="L1650">										colony).addName(&quot;%colony%&quot;, colony.getName()).addName(&quot;%disaster%&quot;, disaster));</span>
<span class="nc bnc" id="L1651" title="All 2 branches missed.">						for (ModelMessage message : messages) {</span>
<span class="nc" id="L1652">							cs.addMessage(See.only(this), message);</span>
<span class="nc" id="L1653">						}</span>
<span class="nc" id="L1654">						return;</span>
					}
				}
			}
		}
<span class="nc" id="L1659">	}</span>

	/**
	 * Apply the effects of the given &lt;code&gt;Disaster&lt;/code&gt; to the given
	 * &lt;code&gt;Colony&lt;/code&gt;, or the &lt;code&gt;Player&lt;/code&gt; if the
	 * &lt;code&gt;Colony&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;, and return a list of
	 * appropriate &lt;code&gt;ModelMessage&lt;/code&gt;s. Note that a disaster might have
	 * no effect on a particular colony. In that case, the returned list is
	 * empty.
	 *
	 * @param random
	 *            A &lt;code&gt;Random&lt;/code&gt; number source.
	 * @param colony
	 *            A &lt;code&gt;Colony&lt;/code&gt;, or &lt;code&gt;null&lt;/code&gt;.
	 * @param disaster
	 *            A &lt;code&gt;Disaster&lt;/code&gt; value.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @return A list of &lt;code&gt;ModelMessage&lt;/code&gt;s, possibly empty.
	 */
	public List&lt;ModelMessage&gt; csApplyDisaster(Random random, Colony colony, Disaster disaster, ChangeSet cs) {
<span class="nc" id="L1680">		StringBuilder sb = new StringBuilder(64);</span>
<span class="nc" id="L1681">		sb.append(&quot;Applying &quot;).append(disaster.getNumberOfEffects()).append(&quot; effect/s of disaster &quot;)</span>
<span class="nc" id="L1682">				.append(Messages.getName(disaster));</span>
<span class="nc bnc" id="L1683" title="All 2 branches missed.">		if (colony != null)</span>
<span class="nc" id="L1684">			sb.append(&quot; to &quot;).append(colony.getName());</span>
<span class="nc" id="L1685">		sb.append(&quot;:&quot;);</span>
<span class="nc" id="L1686">		List&lt;Effect&gt; effects = new ArrayList&lt;&gt;();</span>
<span class="pc bnc" id="L1687" title="All 4 branches missed.">		switch (disaster.getNumberOfEffects()) {</span>
		case ONE:
<span class="nc" id="L1689">			effects.add(</span>
<span class="nc" id="L1690">					RandomChoice.getWeightedRandom(logger, &quot;Get effect of disaster&quot;, disaster.getEffects(), random));</span>
<span class="nc" id="L1691">			sb.append(&quot; &quot;).append(Messages.getName(effects.get(0)));</span>
<span class="nc" id="L1692">			break;</span>
		case SEVERAL:
<span class="nc bnc" id="L1694" title="All 2 branches missed.">			for (RandomChoice&lt;Effect&gt; effect : disaster.getEffects()) {</span>
<span class="nc bnc" id="L1695" title="All 2 branches missed.">				if (randomInt(logger, &quot;Get effects of disaster&quot;, random, 100) &lt; effect.getProbability()) {</span>
<span class="nc" id="L1696">					effects.add(effect.getObject());</span>
<span class="nc" id="L1697">					sb.append(&quot; &quot;).append(Messages.getName(effect.getObject()));</span>
				}
<span class="nc" id="L1699">			}</span>
<span class="nc" id="L1700">			break;</span>
		case ALL:
<span class="nc bnc" id="L1702" title="All 2 branches missed.">			for (RandomChoice&lt;Effect&gt; effect : disaster.getEffects()) {</span>
<span class="nc" id="L1703">				effects.add(effect.getObject());</span>
<span class="nc" id="L1704">				sb.append(&quot; &quot;).append(Messages.getName(effect.getObject()));</span>
<span class="nc" id="L1705">			}</span>
		}
<span class="nc bnc" id="L1707" title="All 2 branches missed.">		if (effects.isEmpty())</span>
<span class="nc" id="L1708">			sb.append(&quot; All avoided&quot;);</span>
<span class="nc" id="L1709">		logger.fine(sb.toString());</span>

<span class="nc" id="L1711">		boolean colonyDirty = false;</span>
<span class="nc" id="L1712">		List&lt;ModelMessage&gt; messages = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1713" title="All 2 branches missed.">		OUTER: for (Effect effect : effects) {</span>
<span class="nc bnc" id="L1714" title="All 2 branches missed.">			if (colony == null) {</span>
<span class="nc bnc" id="L1715" title="All 2 branches missed.">				for (Modifier modifier : effect.getModifiers()) {</span>
<span class="nc bnc" id="L1716" title="All 2 branches missed.">					if (modifier.getDuration() &gt; 0) {</span>
<span class="nc" id="L1717">						Modifier timedModifier = Modifier.makeTimedModifier(modifier.getId(), modifier,</span>
<span class="nc" id="L1718">								getGame().getTurn());</span>
<span class="nc" id="L1719">						modifier.setModifierIndex(Modifier.DISASTER_PRODUCTION_INDEX);</span>
<span class="nc" id="L1720">						cs.addFeatureChange(this, this, timedModifier, true);</span>
<span class="nc" id="L1721">					} else {</span>
<span class="nc" id="L1722">						cs.addFeatureChange(this, this, modifier, true);</span>
					}
<span class="nc" id="L1724">				}</span>
			} else {
<span class="nc bnc" id="L1726" title="All 2 branches missed.">				if (null != effect.getId()) {</span>
<span class="nc bnc" id="L1727" title="All 22 branches missed.">					switch (effect.getId()) {</span>
					case Effect.LOSS_OF_MONEY:
<span class="nc" id="L1729">						int plunder = Math.max(1, colony.getPlunder(null, random) / 5);</span>
<span class="nc" id="L1730">						modifyGold(-plunder);</span>
<span class="nc" id="L1731">						cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc" id="L1732">						messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT, effect.getId(), this)</span>
<span class="nc" id="L1733">								.addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="nc" id="L1734">						break;</span>
					case Effect.LOSS_OF_BUILDING:
<span class="nc" id="L1736">						Building building = getBuildingForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1737" title="All 2 branches missed.">						if (building != null) {</span>
							// Add message before damaging building
<span class="nc" id="L1739">							messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT, effect.getId(), colony)</span>
<span class="nc" id="L1740">									.addNamed(&quot;%building%&quot;, building.getType()));</span>
<span class="nc" id="L1741">							csDamageBuilding(building, cs);</span>
<span class="nc" id="L1742">							colonyDirty = true;</span>
						}
						break;
					case Effect.LOSS_OF_GOODS:
<span class="nc" id="L1746">						Goods goods = getRandomMember(logger, &quot;select goods&quot;, colony.getLootableGoodsList(), random);</span>
<span class="nc bnc" id="L1747" title="All 2 branches missed.">						if (goods != null) {</span>
<span class="nc" id="L1748">							goods.setAmount(Math.min(goods.getAmount() / 2, 50));</span>
<span class="nc" id="L1749">							colony.removeGoods(goods);</span>
<span class="nc" id="L1750">							messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT, effect.getId(), colony)</span>
<span class="nc" id="L1751">									.addStringTemplate(&quot;%goods%&quot;, goods.getLabel(true)));</span>
<span class="nc" id="L1752">							colonyDirty = true;</span>
						}
						break;
					case Effect.LOSS_OF_UNIT: {
<span class="nc" id="L1756">						Unit unit = getUnitForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1757" title="All 2 branches missed.">						if (unit != null) {</span>
<span class="nc bnc" id="L1758" title="All 2 branches missed.">							if (colony.getUnitCount() == 1) {</span>
<span class="nc" id="L1759">								messages.clear();</span>
<span class="nc" id="L1760">								messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L1761">										&quot;model.player.disaster.effect.colonyDestroyed&quot;, this).addName(&quot;%colony%&quot;,</span>
<span class="nc" id="L1762">												colony.getName()));</span>
<span class="nc" id="L1763">								csDisposeSettlement(colony, cs);</span>
<span class="nc" id="L1764">								colonyDirty = false;</span>
<span class="nc" id="L1765">								break OUTER; // No point proceeding</span>
							}
<span class="nc" id="L1767">							messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT, effect.getId(), colony)</span>
<span class="nc" id="L1768">									.addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L1769">							cs.addRemove(See.only(this), null, unit);</span>
<span class="nc" id="L1770">							unit.dispose();// -vis: Safe, entirely within colony</span>
<span class="nc" id="L1771">							colonyDirty = true;</span>
						}
						break;
					}
					case Effect.DAMAGED_UNIT: {
<span class="nc" id="L1776">						Unit unit = getUnitForEffect(colony, effect, random);</span>
<span class="nc bnc" id="L1777" title="All 4 branches missed.">						if (unit != null &amp;&amp; unit.isNaval()) {</span>
<span class="nc" id="L1778">							Location repairLocation = unit.getRepairLocation();</span>
<span class="nc bnc" id="L1779" title="All 2 branches missed.">							if (repairLocation == null) {</span>
<span class="nc" id="L1780">								messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT, effect.getId(), colony)</span>
<span class="nc" id="L1781">										.addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L1782">								csSinkShip(unit, null, cs);</span>
							} else {
<span class="nc" id="L1784">								messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT, effect.getId(), colony)</span>
<span class="nc" id="L1785">										.addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L1786">								csDamageShip(unit, repairLocation, cs);</span>
							}
<span class="nc" id="L1788">							colonyDirty = true;</span>
<span class="nc" id="L1789">						}</span>
						break;
					}
					default:
<span class="nc" id="L1793">						messages.add(new ModelMessage(ModelMessage.MessageType.DEFAULT, effect.getId(), colony));</span>
<span class="nc bnc" id="L1794" title="All 2 branches missed.">						for (Modifier modifier : effect.getModifiers()) {</span>
<span class="nc bnc" id="L1795" title="All 2 branches missed.">							if (modifier.getDuration() &gt; 0) {</span>
<span class="nc" id="L1796">								Modifier timedModifier = Modifier.makeTimedModifier(modifier.getId(), modifier,</span>
<span class="nc" id="L1797">										getGame().getTurn());</span>
<span class="nc" id="L1798">								timedModifier.setModifierIndex(Modifier.DISASTER_PRODUCTION_INDEX);</span>
<span class="nc" id="L1799">								cs.addFeatureChange(this, colony, timedModifier, true);</span>
<span class="nc" id="L1800">							} else {</span>
<span class="nc" id="L1801">								cs.addFeatureChange(this, colony, modifier, true);</span>
							}
<span class="nc" id="L1803">							colonyDirty = true;</span>
<span class="nc" id="L1804">						}</span>
						break;
					}
				}
			}
<span class="nc" id="L1809">		}</span>
<span class="nc bnc" id="L1810" title="All 2 branches missed.">		if (colonyDirty)</span>
<span class="nc" id="L1811">			cs.add(See.perhaps(), colony);</span>
<span class="nc" id="L1812">		return messages;</span>
	}

	/**
	 * Gets the building for effect.
	 *
	 * @param colony
	 *            the colony
	 * @param effect
	 *            the effect
	 * @param random
	 *            the random
	 * @return the building for effect
	 */
	public Building getBuildingForEffect(Colony colony, Effect effect, Random random) {
<span class="nc" id="L1827">		List&lt;Building&gt; buildings = colony.getBurnableBuildings();</span>
<span class="nc bnc" id="L1828" title="All 2 branches missed.">		if (buildings.isEmpty())</span>
<span class="nc" id="L1829">			return null;</span>
<span class="nc" id="L1830">		return getRandomMember(logger, &quot;Select building for effect&quot;, buildings, random);</span>
	}

	/**
	 * Gets the unit for effect.
	 *
	 * @param colony
	 *            the colony
	 * @param effect
	 *            the effect
	 * @param random
	 *            the random
	 * @return the unit for effect
	 */
	public Unit getUnitForEffect(Colony colony, Effect effect, Random random) {
<span class="nc" id="L1845">		List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1846" title="All 2 branches missed.">		for (Unit unit : colony.getUnitList()) {</span>
<span class="nc bnc" id="L1847" title="All 2 branches missed.">			if (effect.appliesTo(unit.getType())) {</span>
<span class="nc" id="L1848">				units.add(unit);</span>
			}
<span class="nc" id="L1850">		}</span>
<span class="nc bnc" id="L1851" title="All 2 branches missed.">		for (Unit unit : colony.getTile().getUnitList()) {</span>
<span class="nc bnc" id="L1852" title="All 2 branches missed.">			if (effect.appliesTo(unit.getType())) {</span>
<span class="nc" id="L1853">				units.add(unit);</span>
			}
<span class="nc" id="L1855">		}</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">		if (units.isEmpty())</span>
<span class="nc" id="L1857">			return null;</span>
<span class="nc" id="L1858">		return getRandomMember(logger, &quot;Select unit for effect&quot;, units, random);</span>
	}

	/**
	 * Propagate an European market trade to the other European markets.
	 *
	 * @param type
	 *            The type of goods that was traded.
	 * @param amount
	 *            The amount of goods that was traded.
	 * @param random
	 *            A pseudo-random number source.
	 */
	public void propagateToEuropeanMarkets(GoodsType type, int amount, Random random) {
<span class="pc bpc" id="L1872" title="1 of 2 branches missed.">		if (!type.isStorable())</span>
<span class="nc" id="L1873">			return;</span>

		// Propagate 5-30% of the original change.
<span class="fc" id="L1876">		final int lowerBound = 5; // FIXME: to spec</span>
<span class="fc" id="L1877">		final int upperBound = 30;// FIXME: to spec</span>
<span class="fc" id="L1878">		amount *= randomInt(logger, &quot;Propagate goods&quot;, random, upperBound - lowerBound + 1) + lowerBound;</span>
<span class="fc" id="L1879">		amount /= 100;</span>
<span class="fc bfc" id="L1880" title="All 2 branches covered.">		if (amount == 0)</span>
<span class="fc" id="L1881">			return;</span>

		// Do not need to update the clients here, these changes happen
		// while it is not their turn.
<span class="fc bfc" id="L1885" title="All 2 branches covered.">		for (Player p : getGame().getLiveEuropeanPlayers(this)) {</span>
<span class="fc" id="L1886">			Market market = p.getMarket();</span>
<span class="pc bpc" id="L1887" title="1 of 2 branches missed.">			if (market != null)</span>
<span class="fc" id="L1888">				market.addGoodsToMarket(type, amount);</span>
<span class="fc" id="L1889">		}</span>
<span class="fc" id="L1890">	}</span>

	/**
	 * Add or remove a standard yearly amount of storable goods, and a random
	 * extra amount of a random type. Then push out all the accumulated trades.
	 *
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csYearlyGoodsAdjust(Random random, ChangeSet cs) {
<span class="fc" id="L1902">		final Game game = getGame();</span>
<span class="fc" id="L1903">		final List&lt;GoodsType&gt; goodsTypes = game.getSpecification().getStorableGoodsTypeList();</span>
<span class="fc" id="L1904">		final Market market = getMarket();</span>

		// Pick a random type of storable goods to add/remove an extra
		// amount of.
		GoodsType extraType;
<span class="pc bpc" id="L1909" title="1 of 2 branches missed.">		while (!(extraType = getRandomMember(logger, &quot;Choose goods type&quot;, goodsTypes, random)).isStorable())</span>
<span class="nc" id="L1910">			;</span>

		// Remove standard amount, and the extra amount.
<span class="fc bfc" id="L1913" title="All 2 branches covered.">		for (GoodsType type : goodsTypes) {</span>
<span class="fc bfc" id="L1914" title="All 2 branches covered.">			if (market.hasBeenTraded(type)) {</span>
<span class="fc bfc" id="L1915" title="All 2 branches covered.">				boolean add = market.getAmountInMarket(type) &lt; type.getInitialAmount();</span>
<span class="fc" id="L1916">				int amount = game.getTurn().getNumber() / 10;</span>
<span class="fc bfc" id="L1917" title="All 2 branches covered.">				if (type == extraType)</span>
<span class="fc" id="L1918">					amount = 2 * amount + 1;</span>
<span class="pc bpc" id="L1919" title="1 of 2 branches missed.">				if (amount &lt;= 0)</span>
<span class="nc" id="L1920">					continue;</span>
<span class="fc" id="L1921">				amount = randomInt(logger, &quot;Market adjust &quot; + type, random, amount);</span>
<span class="fc bfc" id="L1922" title="All 2 branches covered.">				if (!add)</span>
<span class="fc" id="L1923">					amount = -amount;</span>
<span class="fc" id="L1924">				market.addGoodsToMarket(type, amount);</span>
<span class="fc" id="L1925">				logger.finest(getName() + &quot; adjust of &quot; + amount + &quot; &quot; + type + &quot;, total: &quot;</span>
<span class="fc" id="L1926">						+ market.getAmountInMarket(type) + &quot;, initial: &quot; + type.getInitialAmount());</span>
<span class="fc" id="L1927">				addExtraTrade(new AbstractGoods(type, amount));</span>
			}
<span class="fc" id="L1929">		}</span>

<span class="fc" id="L1931">		flushExtraTrades(random);</span>
<span class="fc" id="L1932">		csFlushMarket(cs);</span>
<span class="fc" id="L1933">	}</span>

	/**
	 * Starts a new turn for a player.
	 *
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csStartTurn(Random random, ChangeSet cs) {
<span class="nc" id="L1944">		Game game = getGame();</span>
<span class="nc bnc" id="L1945" title="All 2 branches missed.">		if (isEuropean()) {</span>
<span class="nc" id="L1946">			csBombardEnemyShips(random, cs);</span>

<span class="nc" id="L1948">			csYearlyGoodsAdjust(random, cs);</span>

<span class="nc" id="L1950">			FoundingFather father = checkFoundingFather();</span>
<span class="nc bnc" id="L1951" title="All 2 branches missed.">			if (father != null) {</span>
<span class="nc" id="L1952">				csAddFoundingFather(father, random, cs);</span>
<span class="nc" id="L1953">				clearOfferedFathers();</span>
			}

<span class="nc" id="L1956">			List&lt;FoundingFather&gt; ffs = getOfferedFathers();</span>
<span class="nc bnc" id="L1957" title="All 4 branches missed.">			if (canRecruitFoundingFather() &amp;&amp; ffs.isEmpty()) {</span>
<span class="nc" id="L1958">				ffs = getRandomFoundingFathers(random);</span>
<span class="nc" id="L1959">				setOfferedFathers(ffs);</span>
			}
<span class="nc bnc" id="L1961" title="All 2 branches missed.">			if (!ffs.isEmpty()) {</span>
<span class="nc" id="L1962">				cs.add(See.only(this), ChangePriority.CHANGE_EARLY, new ChooseFoundingFatherMessage(ffs, null));</span>
			}

<span class="nc bnc" id="L1965" title="All 2 branches missed.">			if (updateScore()) {</span>
<span class="nc" id="L1966">				cs.addPartial(See.only(this), this, &quot;score&quot;);</span>
			}

<span class="nc bnc" id="L1969" title="All 2 branches missed.">		} else if (isIndian()) {</span>
			// We do not have to worry about Player level stance
			// changes driving Stance, as that is delegated to the AI.
			//
			// However we want to notify of individual settlements
			// that change tension level, but there are complex
			// interactions between settlement and player tensions.
			// The simple way to do it is just to save all old tension
			// levels and check if they have changed after applying
			// all the changes.
<span class="nc" id="L1979">			List&lt;IndianSettlement&gt; allSettlements = getIndianSettlements();</span>
<span class="nc" id="L1980">			java.util.Map&lt;IndianSettlement, java.util.Map&lt;Player, Tension.Level&gt;&gt; oldLevels = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1981" title="All 2 branches missed.">			for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L1982">				java.util.Map&lt;Player, Tension.Level&gt; oldLevel = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1983">				oldLevels.put(settlement, oldLevel);</span>
<span class="nc bnc" id="L1984" title="All 2 branches missed.">				for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc" id="L1985">					Tension alarm = settlement.getAlarm(enemy);</span>
<span class="nc bnc" id="L1986" title="All 2 branches missed.">					oldLevel.put(enemy, (alarm == null) ? null : alarm.getLevel());</span>
<span class="nc" id="L1987">				}</span>
<span class="nc" id="L1988">			}</span>

			// Do the settlement alarms first.
<span class="nc bnc" id="L1991" title="All 2 branches missed.">			for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L1992">				java.util.Map&lt;Player, Integer&gt; extra = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1993" title="All 2 branches missed.">				for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc" id="L1994">					extra.put(enemy, 0);</span>
<span class="nc" id="L1995">				}</span>

				// Look at the uses of tiles surrounding the settlement.
<span class="nc" id="L1998">				int alarmRadius = settlement.getRadius() + ALARM_RADIUS;</span>
<span class="nc bnc" id="L1999" title="All 2 branches missed.">				for (Tile tile : settlement.getTile().getSurroundingTiles(alarmRadius)) {</span>
<span class="nc" id="L2000">					Colony colony = tile.getColony();</span>
<span class="nc bnc" id="L2001" title="All 2 branches missed.">					if (tile.getFirstUnit() != null) { // Military units</span>
<span class="nc" id="L2002">						Player enemy = tile.getFirstUnit().getOwner();</span>
<span class="nc bnc" id="L2003" title="All 2 branches missed.">						if (enemy.isEuropean()) {</span>
<span class="nc" id="L2004">							Integer alarm = extra.get(enemy);</span>
<span class="nc bnc" id="L2005" title="All 2 branches missed.">							if (alarm == null)</span>
<span class="nc" id="L2006">								continue;</span>
<span class="nc bnc" id="L2007" title="All 4 branches missed.">							alarm += (int) tile.getUnitList().stream().filter(u -&gt; u.isOffensiveUnit() &amp;&amp; !u.isNaval())</span>
<span class="nc" id="L2008">									.mapToDouble(u -&gt; u.getType().getOffence()).sum();</span>
<span class="nc" id="L2009">							extra.put(enemy, alarm);</span>
						}
<span class="nc bnc" id="L2011" title="All 2 branches missed.">					} else if (colony != null) { // Colonies</span>
<span class="nc" id="L2012">						Player enemy = colony.getOwner();</span>
<span class="nc" id="L2013">						extra.put(enemy, extra.get(enemy) + ALARM_TILE_IN_USE + colony.getUnitCount());</span>
<span class="nc bnc" id="L2014" title="All 2 branches missed.">					} else if (tile.getOwningSettlement() != null) { // Control</span>
<span class="nc" id="L2015">						Player enemy = tile.getOwningSettlement().getOwner();</span>
<span class="nc bnc" id="L2016" title="All 4 branches missed.">						if (enemy != null &amp;&amp; enemy.isEuropean()) {</span>
<span class="nc" id="L2017">							extra.put(enemy, extra.get(enemy) + ALARM_TILE_IN_USE);</span>
						}
					}
<span class="nc" id="L2020">				}</span>
				// Missionary helps reducing alarm a bit
<span class="nc bnc" id="L2022" title="All 2 branches missed.">				if (settlement.hasMissionary()) {</span>
<span class="nc" id="L2023">					Unit missionary = settlement.getMissionary();</span>
<span class="nc" id="L2024">					int missionAlarm = getGame().getSpecification().getInteger(GameOptions.MISSION_INFLUENCE);</span>
<span class="nc bnc" id="L2025" title="All 2 branches missed.">					if (missionary.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L2026">						missionAlarm *= 2;</span>
					}
<span class="nc" id="L2028">					Player enemy = missionary.getOwner();</span>
<span class="nc" id="L2029">					extra.put(enemy, extra.get(enemy) + missionAlarm);</span>
				}
				// Apply modifiers, and commit the total change.
<span class="nc bnc" id="L2032" title="All 2 branches missed.">				for (Entry&lt;Player, Integer&gt; entry : extra.entrySet()) {</span>
<span class="nc" id="L2033">					Player player = entry.getKey();</span>
<span class="nc" id="L2034">					int change = entry.getValue();</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">					if (change != 0) {</span>
<span class="nc" id="L2036">						change = (int) player.applyModifiers((float) change, game.getTurn(),</span>
								Modifier.NATIVE_ALARM_MODIFIER);
<span class="nc" id="L2038">						ServerIndianSettlement sis = (ServerIndianSettlement) settlement;</span>
<span class="nc" id="L2039">						sis.csModifyAlarm(player, change, true, cs);// +til</span>
					}
<span class="nc" id="L2041">				}</span>
<span class="nc" id="L2042">			}</span>

			// Calm down a bit at the whole-tribe level.
<span class="nc bnc" id="L2045" title="All 2 branches missed.">			for (Player enemy : game.getLiveEuropeanPlayers(this)) {</span>
<span class="nc bnc" id="L2046" title="All 2 branches missed.">				if (getTension(enemy).getValue() &gt; 0) {</span>
<span class="nc" id="L2047">					int change = -getTension(enemy).getValue() / 100 - 4;</span>
<span class="nc" id="L2048">					csModifyTension(enemy, change, cs);// +til</span>
				}
<span class="nc" id="L2050">			}</span>

			// Now collect the settlements that changed.
			// Update those that changed, and add messages for selected
			// worsening relation transitions.
<span class="nc bnc" id="L2055" title="All 2 branches missed.">			for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L2056">				java.util.Map&lt;Player, Tension.Level&gt; oldLevel = oldLevels.get(settlement);</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">				for (Entry&lt;Player, Tension.Level&gt; entry : oldLevel.entrySet()) {</span>
<span class="nc" id="L2058">					Player enemy = entry.getKey();</span>
<span class="nc" id="L2059">					Tension newTension = settlement.getAlarm(enemy);</span>
<span class="nc bnc" id="L2060" title="All 2 branches missed.">					Tension.Level newLevel = (newTension == null) ? null : newTension.getLevel();</span>
<span class="nc bnc" id="L2061" title="All 6 branches missed.">					if (entry.getValue() == null || entry.getValue() == newLevel || !settlement.hasContacted(enemy)</span>
<span class="nc bnc" id="L2062" title="All 2 branches missed.">							|| !enemy.hasExplored(settlement.getTile()))</span>
<span class="nc" id="L2063">						continue;</span>
<span class="nc" id="L2064">					cs.add(See.only(null).perhaps((ServerPlayer) enemy), settlement);</span>
					// No messages about improving tension
<span class="nc bnc" id="L2066" title="All 2 branches missed.">					if (newLevel == null</span>
<span class="nc bnc" id="L2067" title="All 4 branches missed.">							|| (entry.getValue() != null &amp;&amp; entry.getValue().getLimit() &gt; newLevel.getLimit()))</span>
<span class="nc" id="L2068">						continue;</span>
<span class="nc" id="L2069">					String key = &quot;model.player.alarmIncrease.&quot; + settlement.getAlarm(enemy).getKey();</span>
<span class="nc bnc" id="L2070" title="All 2 branches missed.">					if (!Messages.containsKey(key))</span>
<span class="nc" id="L2071">						continue;</span>
<span class="nc" id="L2072">					cs.addMessage(See.only((ServerPlayer) enemy),</span>
							new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, key, settlement)
<span class="nc" id="L2074">									.addStringTemplate(&quot;%nation%&quot;, getNationLabel())</span>
<span class="nc" id="L2075">									.addStringTemplate(&quot;%enemy%&quot;, enemy.getNationLabel())</span>
<span class="nc" id="L2076">									.addName(&quot;%settlement%&quot;, settlement.getName()));</span>
<span class="nc" id="L2077">				}</span>
<span class="nc" id="L2078">			}</span>

<span class="nc bnc" id="L2080" title="All 2 branches missed.">			for (IndianSettlement settlement : allSettlements) {</span>
<span class="nc" id="L2081">				((ServerIndianSettlement) settlement).csStartTurn(random, cs);</span>
<span class="nc" id="L2082">			}</span>
		}
<span class="nc" id="L2084">	}</span>

	/**
	 * All player colonies bombard all available targets.
	 *
	 * @param random
	 *            A random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csBombardEnemyShips(Random random, ChangeSet cs) {
<span class="nc bnc" id="L2095" title="All 2 branches missed.">		for (Colony colony : getColonies()) {</span>
<span class="nc bnc" id="L2096" title="All 2 branches missed.">			if (colony.canBombardEnemyShip()) {</span>
<span class="nc bnc" id="L2097" title="All 2 branches missed.">				for (Tile tile : colony.getTile().getSurroundingTiles(1)) {</span>
<span class="nc bnc" id="L2098" title="All 6 branches missed.">					if (!tile.isLand() &amp;&amp; tile.getFirstUnit() != null &amp;&amp; tile.getFirstUnit().getOwner() != this) {</span>
<span class="nc bnc" id="L2099" title="All 2 branches missed.">						for (Unit unit : tile.getUnitList()) {</span>
<span class="nc bnc" id="L2100" title="All 4 branches missed.">							if (atWarWith(unit.getOwner()) || unit.hasAbility(Ability.PIRACY)) {</span>
<span class="nc" id="L2101">								csCombat(colony, unit, null, random, cs);</span>
							}
<span class="nc" id="L2103">						}</span>
					}
<span class="nc" id="L2105">				}</span>
			}
<span class="nc" id="L2107">		}</span>
<span class="nc" id="L2108">	}</span>

	/**
	 * Adds a founding father to a players continental congress.
	 *
	 * @param father
	 *            The &lt;code&gt;FoundingFather&lt;/code&gt; to add.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csAddFoundingFather(FoundingFather father, Random random, ChangeSet cs) {
<span class="fc" id="L2121">		final Game game = getGame();</span>
<span class="fc" id="L2122">		final Specification spec = game.getSpecification();</span>
<span class="fc" id="L2123">		final ServerEurope europe = (ServerEurope) getEurope();</span>
<span class="fc" id="L2124">		final Turn turn = game.getTurn();</span>
<span class="fc" id="L2125">		boolean europeDirty = false, visibilityChange = false;</span>

		// FIXME: We do not want to have to update the whole player
		// just to get the FF into the client. Use this hack until
		// the client gets proper containers.
<span class="fc" id="L2130">		cs.addFather(this, father);</span>
<span class="fc" id="L2131">		cs.addMessage(See.only(this),</span>
				new ModelMessage(ModelMessage.MessageType.SONS_OF_LIBERTY, &quot;model.player.foundingFatherJoinedCongress&quot;,
<span class="fc" id="L2133">						this).addNamed(&quot;%foundingFather%&quot;, father).add(&quot;%description%&quot;, father.getDescriptionKey()));</span>
<span class="fc" id="L2134">		cs.addHistory(this, new HistoryEvent(turn, HistoryEvent.HistoryEventType.FOUNDING_FATHER, this)</span>
<span class="fc" id="L2135">				.addNamed(&quot;%father%&quot;, father));</span>

<span class="fc" id="L2137">		List&lt;AbstractUnit&gt; units = father.getUnits();</span>
<span class="pc bpc" id="L2138" title="2 of 6 branches missed.">		if (units != null &amp;&amp; !units.isEmpty() &amp;&amp; europe != null) {</span>
<span class="fc" id="L2139">			createUnits(father.getUnits(), europe);// -vis: safe, Europe</span>
<span class="fc" id="L2140">			europeDirty = true;</span>
		}

<span class="fc" id="L2143">		java.util.Map&lt;UnitType, UnitType&gt; upgrades = father.getUpgrades();</span>
<span class="pc bpc" id="L2144" title="1 of 2 branches missed.">		if (upgrades != null) {</span>
<span class="fc bfc" id="L2145" title="All 2 branches covered.">			for (Unit u : getUnits()) {</span>
<span class="fc" id="L2146">				UnitType newType = upgrades.get(u.getType());</span>
<span class="fc bfc" id="L2147" title="All 2 branches covered.">				if (newType != null) {</span>
<span class="fc" id="L2148">					u.changeType(newType);// -vis(this)</span>
<span class="fc" id="L2149">					visibilityChange = true;</span>
<span class="fc" id="L2150">					cs.add(See.perhaps(), u);</span>
				}
<span class="fc" id="L2152">			}</span>
		}

<span class="fc bfc" id="L2155" title="All 2 branches covered.">		if (!father.getModifiers().isEmpty()) {</span>
<span class="fc" id="L2156">			cs.add(See.only(this), this);</span>
			// Some modifiers are special
<span class="pc bpc" id="L2158" title="1 of 2 branches missed.">			if (father.hasModifier(Modifier.LINE_OF_SIGHT_BONUS)) {</span>
<span class="nc" id="L2159">				List&lt;Tile&gt; tiles = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">				for (Colony c : getColonies()) {</span>
<span class="nc" id="L2161">					tiles.addAll(exploreForSettlement(c));</span>
<span class="nc" id="L2162">				}</span>
<span class="nc bnc" id="L2163" title="All 2 branches missed.">				for (Unit u : getUnits())</span>
<span class="nc" id="L2164">					tiles.addAll(exploreForUnit(u));</span>
<span class="nc bnc" id="L2165" title="All 2 branches missed.">				if (hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
<span class="nc bnc" id="L2166" title="All 2 branches missed.">					for (Player other : getGame().getLiveEuropeanPlayers(this)) {</span>
<span class="nc bnc" id="L2167" title="All 2 branches missed.">						for (Colony c : other.getColonies()) {</span>
<span class="nc" id="L2168">							tiles.addAll(exploreForSettlement(c));</span>
<span class="nc" id="L2169">						}</span>
<span class="nc" id="L2170">					}</span>
				}
<span class="nc" id="L2172">				cs.add(See.only(this), tiles);</span>
<span class="nc" id="L2173">				visibilityChange = true;</span>
<span class="pc bpc" id="L2174" title="1 of 2 branches missed.">			} else if (father.hasModifier(Modifier.SOL)) {</span>
<span class="nc bnc" id="L2175" title="All 2 branches missed.">				for (Colony c : getColonies()) {</span>
<span class="nc" id="L2176">					c.addLiberty(0); // Kick the SoL and production bonus</span>
<span class="nc" id="L2177">					c.invalidateCache();</span>
<span class="nc" id="L2178">				}</span>
			} else {
<span class="fc" id="L2180">				boolean recache = false;</span>
<span class="fc bfc" id="L2181" title="All 2 branches covered.">				for (Modifier m : father.getModifiers()) {</span>
<span class="fc" id="L2182">					recache |= m.getId().startsWith(&quot;model.goods.&quot;);</span>
<span class="fc" id="L2183">				}</span>
<span class="fc bfc" id="L2184" title="All 2 branches covered.">				for (Colony c : getColonies())</span>
<span class="fc" id="L2185">					c.invalidateCache();</span>
			}
		}

<span class="fc bfc" id="L2189" title="All 2 branches covered.">		for (Event event : father.getEvents()) {</span>
<span class="fc" id="L2190">			String eventId = event.getId();</span>
<span class="fc bfc" id="L2191" title="All 2 branches covered.">			if (&quot;model.event.resetBannedMissions&quot;.equals(eventId)) {</span>
<span class="fc bfc" id="L2192" title="All 2 branches covered.">				for (Player p : game.getLiveNativePlayers(null)) {</span>
<span class="pc bpc" id="L2193" title="1 of 2 branches missed.">					if (p.missionsBanned(this)) {</span>
<span class="nc" id="L2194">						p.removeMissionBan(this);</span>
<span class="nc" id="L2195">						cs.add(See.only(this), p);</span>
					}
<span class="fc" id="L2197">				}</span>
<span class="fc bfc" id="L2198" title="All 2 branches covered.">			} else if (&quot;model.event.resetNativeAlarm&quot;.equals(eventId)) {</span>
<span class="fc bfc" id="L2199" title="All 2 branches covered.">				for (Player p : game.getLiveNativePlayers(null)) {</span>
<span class="fc bfc" id="L2200" title="All 2 branches covered.">					if (!p.hasContacted(this))</span>
<span class="fc" id="L2201">						continue;</span>
<span class="fc" id="L2202">					p.setTension(this, new Tension(Tension.TENSION_MIN));</span>
<span class="fc bfc" id="L2203" title="All 2 branches covered.">					for (IndianSettlement is : p.getIndianSettlements()) {</span>
<span class="pc bpc" id="L2204" title="1 of 2 branches missed.">						if (is.hasContacted(this)) {</span>
<span class="fc" id="L2205">							is.getTile().cacheUnseen();// +til</span>
<span class="fc" id="L2206">							is.setAlarm(this, new Tension(Tension.TENSION_MIN));// -til</span>
<span class="fc" id="L2207">							cs.add(See.only(this), is);</span>
						}
<span class="fc" id="L2209">					}</span>
<span class="fc" id="L2210">					csChangeStance(Stance.PEACE, (ServerPlayer) p, true, cs);</span>
<span class="fc" id="L2211">				}</span>

<span class="pc bpc" id="L2213" title="1 of 2 branches missed.">			} else if (&quot;model.event.boycottsLifted&quot;.equals(eventId)) {</span>
<span class="nc" id="L2214">				Market market = getMarket();</span>
<span class="nc bnc" id="L2215" title="All 2 branches missed.">				for (GoodsType goodsType : spec.getGoodsTypeList()) {</span>
<span class="nc bnc" id="L2216" title="All 2 branches missed.">					if (market.getArrears(goodsType) &gt; 0) {</span>
<span class="nc" id="L2217">						market.setArrears(goodsType, 0);</span>
<span class="nc" id="L2218">						cs.add(See.only(this), market.getMarketData(goodsType));</span>
					}
<span class="nc" id="L2220">				}</span>

<span class="pc bpc" id="L2222" title="1 of 2 branches missed.">			} else if (&quot;model.event.freeBuilding&quot;.equals(eventId)) {</span>
<span class="fc" id="L2223">				BuildingType type = spec.getBuildingType(event.getValue());</span>
<span class="fc bfc" id="L2224" title="All 2 branches covered.">				for (Colony colony : getColonies()) {</span>
<span class="fc" id="L2225">					((ServerColony) colony).csFreeBuilding(type, cs);</span>
<span class="fc" id="L2226">				}</span>

<span class="pc bnc" id="L2228" title="All 2 branches missed.">			} else if (&quot;model.event.seeAllColonies&quot;.equals(eventId)) {</span>
<span class="nc" id="L2229">				visibilityChange = true;// -vis(this), can now see other</span>
										// colonies
<span class="nc bnc" id="L2231" title="All 2 branches missed.">				for (Tile t : game.getMap().getAllTiles()) {</span>
<span class="nc" id="L2232">					Colony colony = t.getColony();</span>
<span class="nc bnc" id="L2233" title="All 2 branches missed.">					if (colony == null)</span>
<span class="nc" id="L2234">						continue;</span>
<span class="nc" id="L2235">					Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2236" title="All 2 branches missed.">					if (exploreTile(t)) {</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">						if (!hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
							// FreeCol ruleset adds this ability
							// allowing full visibility of colony,
							// whereas Col1 showed colonies as size 1.
<span class="nc" id="L2241">							Tile c = t.copy(game, Tile.class);</span>
<span class="nc" id="L2242">							c.getColony().setDisplayUnitCount(1);</span>
<span class="nc" id="L2243">							t.setCachedTile(this, c);</span>
						}
<span class="nc" id="L2245">						tiles.add(t);</span>
					}
					// Revealed tiles in 11x11 block in Col1
<span class="nc" id="L2248">					final int fullRadius = (int) father.applyModifiers((float) colony.getLineOfSight(), turn,</span>
							Modifier.EXPOSED_TILES_RADIUS);
<span class="nc" id="L2250">					tiles.addAll(exploreTiles(t.getSurroundingTiles(1, fullRadius)));</span>
<span class="nc" id="L2251">					cs.add(See.only(this), tiles);</span>
<span class="nc" id="L2252">				}</span>

<span class="nc bnc" id="L2254" title="All 4 branches missed.">			} else if (&quot;model.event.newRecruits&quot;.equals(eventId) &amp;&amp; europe != null) {</span>
<span class="nc" id="L2255">				europeDirty = europe.replaceRecruits(random);</span>

<span class="nc bnc" id="L2257" title="All 2 branches missed.">			} else if (&quot;model.event.movementChange&quot;.equals(eventId)) {</span>
<span class="nc bnc" id="L2258" title="All 2 branches missed.">				for (Unit u : getUnits()) {</span>
<span class="nc bnc" id="L2259" title="All 2 branches missed.">					if (u.getMovesLeft() &gt; 0) {</span>
<span class="nc" id="L2260">						u.setMovesLeft(u.getInitialMovesLeft());</span>
<span class="nc" id="L2261">						cs.addPartial(See.only(this), u, &quot;movesLeft&quot;);</span>
					}
<span class="nc" id="L2263">				}</span>
			}
<span class="fc" id="L2265">		}</span>

<span class="fc bfc" id="L2267" title="All 2 branches covered.">		if (europeDirty)</span>
<span class="fc" id="L2268">			cs.add(See.only(this), europe);</span>
<span class="fc bfc" id="L2269" title="All 2 branches covered.">		if (visibilityChange)</span>
<span class="fc" id="L2270">			invalidateCanSeeTiles(); // +vis(this)</span>
<span class="fc" id="L2271">	}</span>

	/**
	 * Get a list of free building types this player has access to through its
	 * choice of founding fathers. Used to upgrade newly captured colonies.
	 *
	 * @return A list of free &lt;code&gt;BuildingType&lt;/code&gt;s.
	 */
	public List&lt;BuildingType&gt; getFreeBuildingTypes() {
<span class="fc" id="L2280">		final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L2281">		List&lt;BuildingType&gt; result = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L2282" title="1 of 2 branches missed.">		for (FoundingFather ff : getFathers()) {</span>
<span class="nc bnc" id="L2283" title="All 2 branches missed.">			for (Event event : ff.getEvents()) {</span>
<span class="nc" id="L2284">				String eventId = event.getId();</span>
<span class="nc bnc" id="L2285" title="All 2 branches missed.">				if (&quot;model.event.freeBuilding&quot;.equals(eventId)) {</span>
<span class="nc" id="L2286">					result.add(spec.getBuildingType(event.getValue()));</span>
				}
<span class="nc" id="L2288">			}</span>
<span class="nc" id="L2289">		}</span>
<span class="fc" id="L2290">		return result;</span>
	}

	/**
	 * Claim land.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to claim.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; to claim for.
	 * @param price
	 *            The price to pay for the land, which must agree with the owner
	 *            valuation, unless negative which denotes stealing.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csClaimLand(Tile tile, Settlement settlement, int price, ChangeSet cs) {
<span class="fc" id="L2307">		ServerPlayer owner = (ServerPlayer) tile.getOwner();</span>
<span class="fc" id="L2308">		Settlement ownerSettlement = tile.getOwningSettlement();</span>
<span class="fc" id="L2309">		tile.cacheUnseen();// +til</span>
<span class="fc" id="L2310">		tile.changeOwnership(this, settlement);// -vis(?),-til</span>

		// Update the tile and any now-angrier owners, and the player
		// gold if a price was paid.
<span class="fc" id="L2314">		cs.add(See.perhaps(), tile);</span>
<span class="pc bpc" id="L2315" title="1 of 2 branches missed.">		if (price &gt; 0) {</span>
<span class="nc" id="L2316">			modifyGold(-price);</span>
<span class="nc" id="L2317">			owner.modifyGold(price);</span>
<span class="nc" id="L2318">			cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="pc bpc" id="L2319" title="2 of 4 branches missed.">		} else if (price &lt; 0 &amp;&amp; owner.isIndian()) {</span>
<span class="fc" id="L2320">			ServerIndianSettlement is = (ServerIndianSettlement) ownerSettlement;</span>
<span class="pc bpc" id="L2321" title="1 of 2 branches missed.">			if (is == null) {</span>
<span class="nc" id="L2322">				owner.csModifyTension(this, Tension.TENSION_ADD_LAND_TAKEN, cs);</span>
			} else {
<span class="fc" id="L2324">				is.csModifyAlarm(this, Tension.TENSION_ADD_LAND_TAKEN, true, cs);</span>
			}
		}
<span class="pc bpc" id="L2327" title="3 of 6 branches missed.">		logger.finest(this.getName() + &quot; claimed &quot; + tile + &quot; from &quot; + ((owner == null) ? &quot;no-one&quot; : owner.getName())</span>
<span class="pc" id="L2328">				+ &quot;, price: &quot; + ((price == 0) ? &quot;free&quot; : (price &lt; 0) ? &quot;stolen&quot; : price));</span>
<span class="fc" id="L2329">	}</span>

	/**
	 * A unit migrates from Europe.
	 *
	 * @param slot
	 *            The slot within &lt;code&gt;Europe&lt;/code&gt; to select the unit from.
	 * @param type
	 *            The type of migration occurring.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csEmigrate(int slot, MigrationType type, Random random, ChangeSet cs) {
		// Create the recruit, move it to the docks.
<span class="fc" id="L2345">		ServerEurope europe = (ServerEurope) getEurope();</span>
<span class="fc" id="L2346">		UnitType recruitType = europe.extractRecruitable(slot, random);</span>
<span class="fc" id="L2347">		final Game game = getGame();</span>
<span class="fc" id="L2348">		final Specification spec = game.getSpecification();</span>
<span class="pc bpc" id="L2349" title="1 of 2 branches missed.">		Role role = (spec.getBoolean(GameOptions.EQUIP_EUROPEAN_RECRUITS)) ? recruitType.getDefaultRole()</span>
<span class="pc" id="L2350">				: spec.getDefaultRole();</span>
<span class="fc" id="L2351">		Unit unit = new ServerUnit(game, europe, this, recruitType, role);// -vis:</span>
																			// safe/Europe

		// Handle migration type specific changes.
<span class="pc bpc" id="L2355" title="4 of 5 branches missed.">		switch (type) {</span>
		case FOUNTAIN:
<span class="nc" id="L2357">			setRemainingEmigrants(getRemainingEmigrants() - 1);</span>
<span class="nc" id="L2358">			break;</span>
		case RECRUIT:
<span class="nc" id="L2360">			modifyGold(-europe.getRecruitPrice());</span>
<span class="nc" id="L2361">			cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
<span class="nc" id="L2362">			europe.increaseRecruitmentDifficulty();</span>
			// Fall through
		case NORMAL:
<span class="fc" id="L2365">			reduceImmigration();</span>
<span class="fc" id="L2366">			updateImmigrationRequired();</span>
<span class="fc" id="L2367">			cs.addPartial(See.only(this), this, &quot;immigration&quot;, &quot;immigrationRequired&quot;);</span>
<span class="pc bpc" id="L2368" title="1 of 2 branches missed.">			if (!MigrationType.specificMigrantSlot(slot)) {</span>
<span class="fc" id="L2369">				cs.addMessage(See.only(this), getEmigrationMessage(unit));</span>
			}
			break;
		case SURVIVAL:
			// Add an informative message if this was a survival recruitment,
<span class="nc" id="L2374">			cs.addMessage(See.only(this),</span>
					new ModelMessage(ModelMessage.MessageType.UNIT_ADDED, &quot;model.player.autoRecruit&quot;, this, unit)
<span class="nc" id="L2376">							.addNamed(&quot;%europe%&quot;, europe).addStringTemplate(&quot;%unit%&quot;, unit.getLabel()));</span>
<span class="nc" id="L2377">			break;</span>
		default:
<span class="nc" id="L2379">			throw new IllegalArgumentException(&quot;Bogus migration type&quot;);</span>
		}
<span class="fc" id="L2381">		cs.add(See.only(this), europe);</span>
<span class="fc" id="L2382">	}</span>

	/**
	 * Combat.
	 *
	 * @param attacker
	 *            The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is attacking.
	 * @param defender
	 *            The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is defending.
	 * @param crs
	 *            A list of &lt;code&gt;CombatResult&lt;/code&gt;s defining the result.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @throws IllegalStateException
	 *             the illegal state exception
	 */
	public void csCombat(FreeColGameObject attacker, FreeColGameObject defender, List&lt;CombatResult&gt; crs, Random random,
			ChangeSet cs) throws IllegalStateException {
<span class="fc" id="L2402">		CombatModel combatModel = getGame().getCombatModel();</span>
<span class="fc" id="L2403">		boolean isAttack = combatModel.combatIsAttack(attacker, defender);</span>
<span class="fc" id="L2404">		boolean isBombard = combatModel.combatIsBombard(attacker, defender);</span>
<span class="fc" id="L2405">		Unit attackerUnit = null;</span>
<span class="fc" id="L2406">		Settlement attackerSettlement = null;</span>
<span class="fc" id="L2407">		Tile attackerTile = null;</span>
<span class="fc" id="L2408">		Unit defenderUnit = null;</span>
		// ServerPlayer attackerPlayer = null;
<span class="fc" id="L2410">		ServerPlayer defenderPlayer = null;</span>
<span class="fc" id="L2411">		Tile defenderTile = null;</span>
<span class="pc bpc" id="L2412" title="1 of 2 branches missed.">		if (isAttack) {</span>
<span class="fc" id="L2413">			attackerUnit = (Unit) attacker;</span>
			// attackerPlayer = (ServerPlayer)attackerUnit.getOwner();
<span class="fc" id="L2415">			attackerTile = attackerUnit.getTile();</span>
<span class="fc" id="L2416">			defenderUnit = (Unit) defender;</span>
<span class="fc" id="L2417">			defenderPlayer = (ServerPlayer) defenderUnit.getOwner();</span>
<span class="fc" id="L2418">			defenderTile = defenderUnit.getTile();</span>
<span class="fc" id="L2419">			boolean bombard = attackerUnit.hasAbility(Ability.BOMBARD);</span>
<span class="fc" id="L2420">			cs.addAttribute(See.only(this), &quot;sound&quot;,</span>
<span class="fc bfc" id="L2421" title="All 4 branches covered.">					(attackerUnit.isNaval()) ? &quot;sound.attack.naval&quot;</span>
							: (bombard) ? &quot;sound.attack.artillery&quot;
<span class="fc bfc" id="L2423" title="All 2 branches covered.">									: (attackerUnit.isMounted()) ? &quot;sound.attack.mounted&quot; : &quot;sound.attack.foot&quot;);</span>
<span class="pc bpc" id="L2424" title="1 of 4 branches missed.">			if (attackerUnit.getOwner().isIndian() &amp;&amp; defenderPlayer.isEuropean()</span>
<span class="pc bpc" id="L2425" title="1 of 2 branches missed.">					&amp;&amp; defenderUnit.getLocation().getColony() != null</span>
<span class="pc bpc" id="L2426" title="1 of 2 branches missed.">					&amp;&amp; !defenderPlayer.atWarWith(attackerUnit.getOwner())) {</span>
<span class="nc" id="L2427">				StringTemplate attackerNation = attackerUnit.getApparentOwnerName();</span>
<span class="nc" id="L2428">				Colony colony = defenderUnit.getLocation().getColony();</span>
<span class="nc" id="L2429">				cs.addMessage(See.only(defenderPlayer),</span>
						new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.indianSurprise&quot;, colony)
<span class="nc" id="L2431">								.addStringTemplate(&quot;%nation%&quot;, attackerNation).addName(&quot;%colony%&quot;, colony.getName()));</span>
			}
<span class="pc bnc" id="L2433" title="All 2 branches missed.">		} else if (isBombard) {</span>
<span class="nc" id="L2434">			attackerSettlement = (Settlement) attacker;</span>
			// attackerPlayer = (ServerPlayer)attackerSettlement.getOwner();
<span class="nc" id="L2436">			attackerTile = attackerSettlement.getTile();</span>
<span class="nc" id="L2437">			defenderUnit = (Unit) defender;</span>
<span class="nc" id="L2438">			defenderPlayer = (ServerPlayer) defenderUnit.getOwner();</span>
<span class="nc" id="L2439">			defenderTile = defenderUnit.getTile();</span>
<span class="nc" id="L2440">			cs.addAttribute(See.only(this), &quot;sound&quot;, &quot;sound.attack.bombard&quot;);</span>
		} else {
<span class="nc" id="L2442">			throw new IllegalStateException(&quot;Bogus combat&quot;);</span>
		}
<span class="pc bpc" id="L2444" title="3 of 4 branches missed.">		assert defenderTile != null;</span>

		// If the combat results were not specified (usually the case),
		// query the combat model.
<span class="pc bpc" id="L2448" title="1 of 2 branches missed.">		if (crs == null) {</span>
<span class="nc" id="L2449">			crs = combatModel.generateAttackResult(random, attacker, defender);</span>
		}
<span class="pc bpc" id="L2451" title="1 of 2 branches missed.">		if (crs.isEmpty()) {</span>
<span class="nc" id="L2452">			throw new IllegalStateException(&quot;empty attack result&quot;);</span>
		}
		// Extract main result, insisting it is one of the fundamental cases,
		// and add the animation.
		// Set vis so that loser always sees things.
		// FIXME: Bombard animations
		See vis; // Visibility that insists on the loser seeing the result.
<span class="fc" id="L2459">		CombatResult result = crs.remove(0);</span>
<span class="pc bpc" id="L2460" title="2 of 4 branches missed.">		switch (result) {</span>
		case NO_RESULT:
<span class="nc" id="L2462">			vis = See.perhaps();</span>
<span class="nc" id="L2463">			break; // Do not animate if there is no result.</span>
		case WIN:
<span class="fc" id="L2465">			vis = See.perhaps().always(defenderPlayer);</span>
<span class="pc bpc" id="L2466" title="1 of 2 branches missed.">			if (isAttack) {</span>
<span class="pc bpc" id="L2467" title="3 of 6 branches missed.">				if (attackerTile == null || attackerTile == defenderTile || !attackerTile.isAdjacent(defenderTile)) {</span>
<span class="nc" id="L2468">					logger.warning(&quot;Bogus attack from &quot; + attackerTile + &quot; to &quot; + defenderTile + &quot;\n&quot;</span>
<span class="nc" id="L2469">							+ FreeColDebugger.stackTraceToString());</span>
				} else {
<span class="fc" id="L2471">					cs.addAttack(vis, attackerUnit, defenderUnit, true);</span>
				}
			}
			break;
		case LOSE:
<span class="fc" id="L2476">			vis = See.perhaps().always(this);</span>
<span class="pc bpc" id="L2477" title="1 of 2 branches missed.">			if (isAttack) {</span>
<span class="pc bpc" id="L2478" title="3 of 6 branches missed.">				if (attackerTile == null || attackerTile == defenderTile || !attackerTile.isAdjacent(defenderTile)) {</span>
<span class="nc" id="L2479">					logger.warning(&quot;Bogus attack from &quot; + attackerTile + &quot; to &quot; + defenderTile + &quot;\n&quot;</span>
<span class="nc" id="L2480">							+ FreeColDebugger.stackTraceToString());</span>
				} else {
<span class="fc" id="L2482">					cs.addAttack(vis, attackerUnit, defenderUnit, false);</span>
				}
			}
			break;
		default:
<span class="nc" id="L2487">			throw new IllegalStateException(&quot;generateAttackResult returned: &quot; + result);</span>
		}
		// Now process the details.
<span class="fc" id="L2490">		boolean attackerTileDirty = false;</span>
<span class="fc" id="L2491">		boolean defenderTileDirty = false;</span>
<span class="fc" id="L2492">		boolean moveAttacker = false;</span>
<span class="fc" id="L2493">		boolean burnedNativeCapital = false;</span>
<span class="fc" id="L2494">		Settlement settlement = defenderTile.getSettlement();</span>
<span class="fc" id="L2495">		Colony colony = defenderTile.getColony();</span>
<span class="fc bfc" id="L2496" title="All 2 branches covered.">		IndianSettlement natives = (settlement instanceof IndianSettlement) ? (IndianSettlement) settlement : null;</span>
<span class="fc" id="L2497">		int attackerTension = 0;</span>
<span class="fc" id="L2498">		int defenderTension = 0;</span>
<span class="fc bfc" id="L2499" title="All 2 branches covered.">		for (CombatResult cr : crs) {</span>
			boolean ok;
<span class="pc bpc" id="L2501" title="11 of 25 branches missed.">			switch (cr) {</span>
			case AUTOEQUIP_UNIT:
<span class="pc bpc" id="L2503" title="2 of 4 branches missed.">				ok = isAttack &amp;&amp; settlement != null;</span>
<span class="pc bpc" id="L2504" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc" id="L2505">					csAutoequipUnit(defenderUnit, settlement, cs);</span>
				}
				break;
			case BURN_MISSIONS:
<span class="nc bnc" id="L2509" title="All 8 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; natives != null &amp;&amp; isEuropean()</span>
<span class="nc bnc" id="L2510" title="All 2 branches missed.">						&amp;&amp; defenderPlayer.isIndian();</span>
<span class="nc bnc" id="L2511" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2512">					defenderTileDirty |= natives.hasMissionary(this);</span>
<span class="nc" id="L2513">					csBurnMissions(attackerUnit, natives, cs);</span>
				}
				break;
			case CAPTURE_AUTOEQUIP:
<span class="nc bnc" id="L2517" title="All 6 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; settlement != null;</span>
<span class="nc bnc" id="L2518" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2519">					csCaptureAutoEquip(attackerUnit, defenderUnit, cs);</span>
<span class="nc" id="L2520">					attackerTileDirty = defenderTileDirty = true;</span>
				}
				break;
			case CAPTURE_COLONY:
<span class="pc bpc" id="L2524" title="4 of 8 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; colony != null &amp;&amp; isEuropean()</span>
<span class="pc bpc" id="L2525" title="1 of 2 branches missed.">						&amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2526" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc" id="L2527">					csCaptureColony(attackerUnit, (ServerColony) colony, random, cs);</span>
<span class="fc" id="L2528">					attackerTileDirty = defenderTileDirty = false;</span>
<span class="fc" id="L2529">					moveAttacker = true;</span>
<span class="fc" id="L2530">					defenderTension += Tension.TENSION_ADD_MAJOR;</span>
				}
				break;
			case CAPTURE_CONVERT:
<span class="pc bpc" id="L2534" title="4 of 8 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; natives != null &amp;&amp; isEuropean()</span>
<span class="pc bpc" id="L2535" title="1 of 2 branches missed.">						&amp;&amp; defenderPlayer.isIndian();</span>
<span class="pc bpc" id="L2536" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc" id="L2537">					csCaptureConvert(attackerUnit, natives, random, cs);</span>
<span class="fc" id="L2538">					attackerTileDirty = true;</span>
				}
				break;
			case CAPTURE_EQUIP:
<span class="pc bpc" id="L2542" title="2 of 4 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2543" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="pc bpc" id="L2544" title="1 of 2 branches missed.">					if (result == CombatResult.WIN) {</span>
<span class="nc" id="L2545">						csCaptureEquip(attackerUnit, defenderUnit, cs);</span>
					} else {
<span class="fc" id="L2547">						csCaptureEquip(defenderUnit, attackerUnit, cs);</span>
					}
<span class="fc" id="L2549">					attackerTileDirty = defenderTileDirty = true;</span>
				}
				break;
			case CAPTURE_UNIT:
<span class="pc bpc" id="L2553" title="2 of 4 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2554" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc bfc" id="L2555" title="All 2 branches covered.">					if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2556">						csCaptureUnit(attackerUnit, defenderUnit, cs);</span>
					} else {
<span class="fc" id="L2558">						csCaptureUnit(defenderUnit, attackerUnit, cs);</span>
					}
<span class="fc" id="L2560">					attackerTileDirty = true;</span>
<span class="fc" id="L2561">					defenderTileDirty = false; // Added in csCaptureUnit</span>
				}
				break;
			case DAMAGE_COLONY_SHIPS:
<span class="nc bnc" id="L2565" title="All 6 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; colony != null;</span>
<span class="nc bnc" id="L2566" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2567">					csDamageColonyShips(attackerUnit, colony, cs);</span>
<span class="nc" id="L2568">					defenderTileDirty = true;</span>
				}
				break;
			case DAMAGE_SHIP_ATTACK:
<span class="pc bpc" id="L2572" title="3 of 6 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
<span class="pc bpc" id="L2573" title="1 of 2 branches missed.">						&amp;&amp; ((result == CombatResult.WIN) ? defenderUnit : attackerUnit).isNaval();</span>
<span class="pc bpc" id="L2574" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="pc bpc" id="L2575" title="1 of 2 branches missed.">					if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2576">						csDamageShipAttack(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2577">						defenderTileDirty = true;</span>
					} else {
<span class="nc" id="L2579">						csDamageShipAttack(defenderUnit, attackerUnit, cs);</span>
<span class="nc" id="L2580">						attackerTileDirty = true;</span>
					}
				}
				break;
			case DAMAGE_SHIP_BOMBARD:
<span class="nc bnc" id="L2585" title="All 6 branches missed.">				ok = isBombard &amp;&amp; result == CombatResult.WIN &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2586" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2587">					csDamageShipBombard(attackerSettlement, defenderUnit, cs);</span>
<span class="nc" id="L2588">					defenderTileDirty = true;</span>
				}
				break;
			case DEMOTE_UNIT:
<span class="pc bpc" id="L2592" title="2 of 4 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2593" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc bfc" id="L2594" title="All 2 branches covered.">					if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2595">						csDemoteUnit(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2596">						defenderTileDirty = true;</span>
					} else {
<span class="fc" id="L2598">						csDemoteUnit(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2599">						attackerTileDirty = true;</span>
					}
				}
				break;
			case DESTROY_COLONY:
<span class="pc bpc" id="L2604" title="4 of 8 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; colony != null &amp;&amp; isIndian()</span>
<span class="pc bpc" id="L2605" title="1 of 2 branches missed.">						&amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2606" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc" id="L2607">					csDestroyColony(attackerUnit, colony, random, cs);</span>
<span class="fc" id="L2608">					attackerTileDirty = defenderTileDirty = true;</span>
<span class="fc" id="L2609">					moveAttacker = true;</span>
<span class="fc" id="L2610">					attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="fc" id="L2611">					defenderTension += Tension.TENSION_ADD_MAJOR;</span>
				}
				break;
			case DESTROY_SETTLEMENT:
<span class="nc bnc" id="L2615" title="All 8 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; natives != null &amp;&amp; defenderPlayer.isIndian();</span>
<span class="nc bnc" id="L2616" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2617">					burnedNativeCapital = settlement.isCapital();</span>
<span class="nc" id="L2618">					csDestroySettlement(attackerUnit, natives, random, cs);</span>
<span class="nc" id="L2619">					attackerTileDirty = defenderTileDirty = true;</span>
<span class="nc" id="L2620">					moveAttacker = true;</span>
<span class="nc" id="L2621">					attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="nc bnc" id="L2622" title="All 2 branches missed.">					if (!burnedNativeCapital) {</span>
<span class="nc" id="L2623">						defenderTension += Tension.TENSION_ADD_MAJOR;</span>
					}
				}
				break;
			case EVADE_ATTACK:
<span class="nc bnc" id="L2628" title="All 6 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.NO_RESULT &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2629" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2630">					csEvadeAttack(attackerUnit, defenderUnit, cs);</span>
				}
				break;
			case EVADE_BOMBARD:
<span class="nc bnc" id="L2634" title="All 6 branches missed.">				ok = isBombard &amp;&amp; result == CombatResult.NO_RESULT &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2635" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2636">					csEvadeBombard(attackerSettlement, defenderUnit, cs);</span>
				}
				break;
			case LOOT_SHIP:
<span class="pc bpc" id="L2640" title="4 of 8 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT &amp;&amp; attackerUnit.isNaval() &amp;&amp; defenderUnit.isNaval();</span>
<span class="pc bpc" id="L2641" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="pc bpc" id="L2642" title="1 of 2 branches missed.">					if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2643">						csLootShip(attackerUnit, defenderUnit, cs);</span>
					} else {
<span class="nc" id="L2645">						csLootShip(defenderUnit, attackerUnit, cs);</span>
					}
				}
				break;
			case LOSE_AUTOEQUIP:
<span class="pc bpc" id="L2650" title="3 of 6 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; settlement != null;</span>
<span class="pc bpc" id="L2651" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc" id="L2652">					csLoseAutoEquip(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2653">					defenderTileDirty = true;</span>
				}
				break;
			case LOSE_EQUIP:
<span class="pc bpc" id="L2657" title="2 of 4 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2658" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc bfc" id="L2659" title="All 2 branches covered.">					if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2660">						csLoseEquip(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2661">						defenderTileDirty = true;</span>
					} else {
<span class="fc" id="L2663">						csLoseEquip(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2664">						attackerTileDirty = true;</span>
					}
				}
				break;
			case PILLAGE_COLONY:
<span class="pc bpc" id="L2669" title="4 of 8 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; colony != null &amp;&amp; isIndian()</span>
<span class="pc bpc" id="L2670" title="1 of 2 branches missed.">						&amp;&amp; defenderPlayer.isEuropean();</span>
<span class="pc bpc" id="L2671" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc" id="L2672">					csPillageColony(attackerUnit, colony, random, cs);</span>
<span class="fc" id="L2673">					defenderTileDirty = true;</span>
<span class="fc" id="L2674">					attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
				}
				break;
			case PROMOTE_UNIT:
<span class="pc bpc" id="L2678" title="2 of 4 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2679" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="pc bpc" id="L2680" title="1 of 2 branches missed.">					if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2681">						csPromoteUnit(attackerUnit, cs);</span>
<span class="fc" id="L2682">						attackerTileDirty = true;</span>
					} else {
<span class="nc" id="L2684">						csPromoteUnit(defenderUnit, cs);</span>
<span class="nc" id="L2685">						defenderTileDirty = true;</span>
					}
				}
				break;
			case SINK_COLONY_SHIPS:
<span class="nc bnc" id="L2690" title="All 6 branches missed.">				ok = isAttack &amp;&amp; result == CombatResult.WIN &amp;&amp; colony != null;</span>
<span class="nc bnc" id="L2691" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2692">					csSinkColonyShips(attackerUnit, colony, cs);</span>
<span class="nc" id="L2693">					defenderTileDirty = true;</span>
				}
				break;
			case SINK_SHIP_ATTACK:
<span class="nc bnc" id="L2697" title="All 6 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT</span>
<span class="nc bnc" id="L2698" title="All 2 branches missed.">						&amp;&amp; ((result == CombatResult.WIN) ? defenderUnit : attackerUnit).isNaval();</span>
<span class="nc bnc" id="L2699" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc bnc" id="L2700" title="All 2 branches missed.">					if (result == CombatResult.WIN) {</span>
<span class="nc" id="L2701">						csSinkShipAttack(attackerUnit, defenderUnit, cs);</span>
<span class="nc" id="L2702">						defenderTileDirty = true;</span>
					} else {
<span class="nc" id="L2704">						csSinkShipAttack(defenderUnit, attackerUnit, cs);</span>
<span class="nc" id="L2705">						attackerTileDirty = true;</span>
					}
				}
				break;
			case SINK_SHIP_BOMBARD:
<span class="nc bnc" id="L2710" title="All 6 branches missed.">				ok = isBombard &amp;&amp; result == CombatResult.WIN &amp;&amp; defenderUnit.isNaval();</span>
<span class="nc bnc" id="L2711" title="All 2 branches missed.">				if (ok) {</span>
<span class="nc" id="L2712">					csSinkShipBombard(attackerSettlement, defenderUnit, cs);</span>
<span class="nc" id="L2713">					defenderTileDirty = true;</span>
				}
				break;
			case SLAUGHTER_UNIT:
<span class="pc bpc" id="L2717" title="2 of 4 branches missed.">				ok = isAttack &amp;&amp; result != CombatResult.NO_RESULT;</span>
<span class="pc bpc" id="L2718" title="1 of 2 branches missed.">				if (ok) {</span>
<span class="fc bfc" id="L2719" title="All 2 branches covered.">					if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2720">						csSlaughterUnit(attackerUnit, defenderUnit, cs);</span>
<span class="fc" id="L2721">						defenderTileDirty = true;</span>
<span class="fc" id="L2722">						attackerTension -= Tension.TENSION_ADD_NORMAL;</span>
<span class="fc" id="L2723">						defenderTension += getSlaughterTension(defenderUnit);</span>
					} else {
<span class="fc" id="L2725">						csSlaughterUnit(defenderUnit, attackerUnit, cs);</span>
<span class="fc" id="L2726">						attackerTileDirty = true;</span>
<span class="fc" id="L2727">						attackerTension += getSlaughterTension(attackerUnit);</span>
<span class="fc" id="L2728">						defenderTension -= Tension.TENSION_ADD_NORMAL;</span>
					}
				}
				break;
			default:
<span class="nc" id="L2733">				ok = false;</span>
				break;
			}
<span class="pc bpc" id="L2736" title="1 of 2 branches missed.">			if (!ok) {</span>
<span class="nc" id="L2737">				throw new IllegalStateException(&quot;Attack (result=&quot; + result + &quot;) has bogus subresult: &quot; + cr);</span>
			}
<span class="fc" id="L2739">		}</span>

		// Handle stance and tension.
		// - Privateers do not provoke stance changes but can set the
		// attackedByPrivateers flag
		// - Attacks among Europeans imply war
		// - Burning of a native capital results in surrender
		// - Other attacks involving natives do not imply war, but
		// changes in Tension can drive Stance, however this is
		// decided by the native AI in their turn so just adjust tension.
<span class="fc bfc" id="L2749" title="All 2 branches covered.">		if (attacker.hasAbility(Ability.PIRACY)) {</span>
<span class="pc bpc" id="L2750" title="1 of 2 branches missed.">			if (!defenderPlayer.getAttackedByPrivateers()) {</span>
<span class="fc" id="L2751">				defenderPlayer.setAttackedByPrivateers(true);</span>
<span class="fc" id="L2752">				cs.addPartial(See.only(defenderPlayer), defenderPlayer, &quot;attackedByPrivateers&quot;);</span>
			}
<span class="pc bpc" id="L2754" title="1 of 2 branches missed.">		} else if (defender.hasAbility(Ability.PIRACY)) {</span>
			; // do nothing
<span class="pc bpc" id="L2756" title="1 of 2 branches missed.">		} else if (burnedNativeCapital) {</span>
<span class="nc" id="L2757">			defenderPlayer.getTension(this).setValue(Tension.SURRENDERED);</span>
			// FIXME: just the tension
<span class="nc" id="L2759">			cs.add(See.perhaps().always(this), defenderPlayer);</span>
<span class="nc" id="L2760">			csChangeStance(Stance.PEACE, defenderPlayer, true, cs);</span>
<span class="nc bnc" id="L2761" title="All 2 branches missed.">			for (IndianSettlement is : defenderPlayer.getIndianSettlements()) {</span>
<span class="nc bnc" id="L2762" title="All 2 branches missed.">				if (is.hasContacted(this)) {</span>
<span class="nc" id="L2763">					is.getAlarm(this).setValue(Tension.SURRENDERED);</span>
					// Only update attacker with settlements that have
					// been seen, as contact can occur with its members.
<span class="nc bnc" id="L2766" title="All 2 branches missed.">					if (hasExplored(is.getTile())) {</span>
<span class="nc" id="L2767">						cs.add(See.perhaps().always(this), is);</span>
					} else {
<span class="nc" id="L2769">						cs.add(See.only(defenderPlayer), is);</span>
					}
				}
<span class="nc" id="L2772">			}</span>
<span class="fc bfc" id="L2773" title="All 4 branches covered.">		} else if (isEuropean() &amp;&amp; defenderPlayer.isEuropean()) {</span>
<span class="fc" id="L2774">			csChangeStance(Stance.WAR, defenderPlayer, true, cs);</span>
		} else { // At least one player is non-European
<span class="fc bfc" id="L2776" title="All 2 branches covered.">			if (isEuropean()) {</span>
<span class="fc" id="L2777">				csChangeStance(Stance.WAR, defenderPlayer, true, cs);</span>
<span class="pc bpc" id="L2778" title="1 of 2 branches missed.">			} else if (isIndian()) {</span>
<span class="pc bpc" id="L2779" title="1 of 2 branches missed.">				if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2780">					attackerTension -= Tension.TENSION_ADD_MINOR;</span>
<span class="nc bnc" id="L2781" title="All 2 branches missed.">				} else if (result == CombatResult.LOSE) {</span>
<span class="nc" id="L2782">					attackerTension += Tension.TENSION_ADD_MINOR;</span>
				}
			}
<span class="fc bfc" id="L2785" title="All 2 branches covered.">			if (defenderPlayer.isEuropean()) {</span>
<span class="fc" id="L2786">				defenderPlayer.csChangeStance(Stance.WAR, this, true, cs);</span>
<span class="pc bpc" id="L2787" title="1 of 2 branches missed.">			} else if (defenderPlayer.isIndian()) {</span>
<span class="fc bfc" id="L2788" title="All 2 branches covered.">				if (result == CombatResult.WIN) {</span>
<span class="fc" id="L2789">					defenderTension += Tension.TENSION_ADD_MINOR;</span>
<span class="pc bpc" id="L2790" title="1 of 2 branches missed.">				} else if (result == CombatResult.LOSE) {</span>
<span class="fc" id="L2791">					defenderTension -= Tension.TENSION_ADD_MINOR;</span>
				}
			}
<span class="fc bfc" id="L2794" title="All 2 branches covered.">			if (attackerTension != 0) {</span>
<span class="fc" id="L2795">				this.csModifyTension(defenderPlayer, attackerTension, cs);// +til</span>
			}
<span class="fc bfc" id="L2797" title="All 2 branches covered.">			if (defenderTension != 0) {</span>
<span class="fc" id="L2798">				defenderPlayer.csModifyTension(this, defenderTension, cs);// +til</span>
			}
		}

		// Move the attacker if required.
<span class="fc bfc" id="L2803" title="All 2 branches covered.">		if (moveAttacker) {</span>
<span class="fc" id="L2804">			attackerUnit.setMovesLeft(attackerUnit.getInitialMovesLeft());</span>
<span class="fc" id="L2805">			((ServerUnit) attackerUnit).csMove(defenderTile, random, cs);</span>
<span class="fc" id="L2806">			attackerUnit.setMovesLeft(0);</span>
			// Move adds in updates for the tiles, but...
<span class="fc" id="L2808">			attackerTileDirty = defenderTileDirty = false;</span>
			// ...with visibility of perhaps().
			// Thus the defender might see the change,
			// but because its settlement is gone it also might not.
			// So add in another defender-specific update.
			// The worst that can happen is a duplicate update.
<span class="fc" id="L2814">			cs.add(See.only(defenderPlayer), defenderTile);</span>
<span class="pc bpc" id="L2815" title="1 of 2 branches missed.">		} else if (isAttack) {</span>
			// The Revenger unit can attack multiple times, so spend
			// at least the eventual cost of moving to the tile.
			// Other units consume the entire move.
<span class="pc bpc" id="L2819" title="1 of 2 branches missed.">			if (attacker.hasAbility(Ability.MULTIPLE_ATTACKS)) {</span>
<span class="nc" id="L2820">				int movecost = attackerUnit.getMoveCost(defenderTile);</span>
<span class="nc" id="L2821">				attackerUnit.setMovesLeft(attackerUnit.getMovesLeft() - movecost);</span>
<span class="nc" id="L2822">			} else {</span>
<span class="fc" id="L2823">				attackerUnit.setMovesLeft(0);</span>
			}
<span class="fc bfc" id="L2825" title="All 2 branches covered.">			if (!attackerTileDirty) {</span>
<span class="fc" id="L2826">				cs.addPartial(See.only(this), attacker, &quot;movesLeft&quot;);</span>
			}
		}

		// Make sure we always update the attacker and defender tile
		// if it is not already done yet.
<span class="fc bfc" id="L2832" title="All 2 branches covered.">		if (attackerTileDirty) {</span>
<span class="pc bpc" id="L2833" title="1 of 2 branches missed.">			if (attackerSettlement != null)</span>
<span class="nc" id="L2834">				cs.remove(attackerSettlement);</span>
<span class="fc" id="L2835">			cs.add(vis, attackerTile);</span>
		}
<span class="fc bfc" id="L2837" title="All 2 branches covered.">		if (defenderTileDirty) {</span>
<span class="fc bfc" id="L2838" title="All 2 branches covered.">			if (settlement != null)</span>
<span class="fc" id="L2839">				cs.remove(settlement);</span>
<span class="fc" id="L2840">			cs.add(vis, defenderTile);</span>
		}
<span class="fc" id="L2842">	}</span>

	/**
	 * Gets the amount to raise tension by when a unit is slaughtered.
	 *
	 * @param loser
	 *            The &lt;code&gt;Unit&lt;/code&gt; that dies.
	 * @return An amount to raise tension by.
	 */
	private int getSlaughterTension(Unit loser) {
		// Tension rises faster when units die.
<span class="fc" id="L2853">		Settlement settlement = loser.getSettlement();</span>
<span class="pc bpc" id="L2854" title="1 of 2 branches missed.">		if (settlement != null) {</span>
<span class="nc bnc" id="L2855" title="All 2 branches missed.">			if (settlement instanceof IndianSettlement) {</span>
<span class="nc bnc" id="L2856" title="All 2 branches missed.">				return (settlement.isCapital()) ? Tension.TENSION_ADD_CAPITAL_ATTACKED</span>
						: Tension.TENSION_ADD_SETTLEMENT_ATTACKED;
			} else {
<span class="nc" id="L2859">				return Tension.TENSION_ADD_NORMAL;</span>
			}
		} else { // attack in the open
<span class="pc bpc" id="L2862" title="1 of 2 branches missed.">			return (loser.getHomeIndianSettlement() != null) ? Tension.TENSION_ADD_UNIT_DESTROYED</span>
					: Tension.TENSION_ADD_MINOR;
		}
	}

	/**
	 * Notifies of automatic arming.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is auto-equipping.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; being defended.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csAutoequipUnit(Unit unit, Settlement settlement, ChangeSet cs) {
<span class="fc" id="L2878">		ServerPlayer player = (ServerPlayer) unit.getOwner();</span>
<span class="fc" id="L2879">		cs.addMessage(See.only(player),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.automaticDefence&quot;, unit)
<span class="fc" id="L2881">						.addStringTemplate(&quot;%unit%&quot;, unit.getLabel()).addName(&quot;%colony%&quot;, settlement.getName()));</span>
<span class="fc" id="L2882">	}</span>

	/**
	 * Burns a players missions.
	 *
	 * @param attacker
	 *            The &lt;code&gt;Unit&lt;/code&gt; that attacked.
	 * @param settlement
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; that was attacked.
	 * @param cs
	 *            The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csBurnMissions(Unit attacker, IndianSettlement settlement, ChangeSet cs) {
<span class="nc" id="L2895">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L2896">		StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="nc" id="L2897">		ServerPlayer nativePlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L2898">		StringTemplate nativeNation = nativePlayer.getNationLabel();</span>

		// Message only for the European player
<span class="nc" id="L2901">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.burnMissions&quot;, attacker, settlement)
<span class="nc" id="L2903">						.addStringTemplate(&quot;%nation%&quot;, attackerNation).addStringTemplate(&quot;%enemyNation%&quot;,</span>
								nativeNation));

		// Burn down the missions
<span class="nc" id="L2907">		boolean here = settlement.hasMissionary(attackerPlayer);</span>
<span class="nc bnc" id="L2908" title="All 2 branches missed.">		for (IndianSettlement s : nativePlayer.getIndianSettlements()) {</span>
<span class="nc bnc" id="L2909" title="All 2 branches missed.">			if (s.hasMissionary(attackerPlayer)) {</span>
<span class="nc" id="L2910">				((ServerIndianSettlement) s).csKillMissionary(null, cs);</span>
			}
<span class="nc" id="L2912">		}</span>
		// Backtrack on updating this tile, avoiding duplication in csCombat
<span class="nc bnc" id="L2914" title="All 2 branches missed.">		if (here)</span>
<span class="nc" id="L2915">			cs.remove(settlement.getTile());</span>
<span class="nc" id="L2916">	}</span>

	/**
	 * Defender auto equips but loses and attacker captures the equipment.
	 *
	 * @param attacker
	 *            The &lt;code&gt;Unit&lt;/code&gt; that attacked.
	 * @param defender
	 *            The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csCaptureAutoEquip(Unit attacker, Unit defender, ChangeSet cs) {
<span class="nc" id="L2929">		Role role = defender.getAutomaticRole();</span>
<span class="nc" id="L2930">		csLoseAutoEquip(attacker, defender, cs);</span>
<span class="nc" id="L2931">		csCaptureEquipment(attacker, defender, role, cs);</span>
<span class="nc" id="L2932">	}</span>

	/**
	 * Captures a colony.
	 *
	 * @param attacker
	 *            The attacking &lt;code&gt;Unit&lt;/code&gt;.
	 * @param colony
	 *            The &lt;code&gt;ServerColony&lt;/code&gt; to capture.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csCaptureColony(Unit attacker, ServerColony colony, Random random, ChangeSet cs) {
<span class="fc" id="L2947">		Game game = attacker.getGame();</span>
<span class="fc" id="L2948">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L2949">		StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="fc" id="L2950">		ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L2951">		StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>
<span class="fc" id="L2952">		Tile tile = colony.getTile();</span>
<span class="fc" id="L2953">		List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L2954">		units.addAll(colony.getUnitList());</span>
<span class="fc" id="L2955">		units.addAll(tile.getUnitList());</span>
<span class="fc" id="L2956">		int plunder = colony.getPlunder(attacker, random);</span>

		// Handle history and messages before colony handover
<span class="fc" id="L2959">		cs.addHistory(attackerPlayer,</span>
<span class="fc" id="L2960">				new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.CONQUER_COLONY, attackerPlayer)</span>
<span class="fc" id="L2961">						.addStringTemplate(&quot;%nation%&quot;, colonyNation).addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L2962">		cs.addHistory(colonyPlayer,</span>
<span class="fc" id="L2963">				new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.COLONY_CONQUERED, attackerPlayer)</span>
<span class="fc" id="L2964">						.addStringTemplate(&quot;%nation%&quot;, attackerNation).addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L2965">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.colonyCaptured&quot;, colony)
<span class="fc" id="L2967">						.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="fc" id="L2968">		cs.addMessage(See.only(colonyPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.colonyCapturedBy&quot;, tile)
<span class="fc" id="L2970">						.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%amount%&quot;, plunder)</span>
<span class="fc" id="L2971">						.addStringTemplate(&quot;%player%&quot;, attackerNation));</span>
<span class="fc" id="L2972">		colonyPlayer.csLoseLocation(colony, cs);</span>

		// Allocate some plunder
<span class="pc bpc" id="L2975" title="1 of 2 branches missed.">		if (plunder &gt; 0) {</span>
<span class="nc" id="L2976">			attackerPlayer.modifyGold(plunder);</span>
<span class="nc" id="L2977">			colonyPlayer.modifyGold(-plunder);</span>
<span class="nc" id="L2978">			cs.addPartial(See.only(attackerPlayer), attackerPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2979">			cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
		}

		// Remove goods party modifiers as they apply to a different monarch.
<span class="fc bfc" id="L2983" title="All 2 branches covered.">		for (Modifier m : colony.getModifiers()) {</span>
<span class="pc bpc" id="L2984" title="1 of 2 branches missed.">			if (Specification.COLONY_GOODS_PARTY_SOURCE == m.getSource()) {</span>
<span class="nc" id="L2985">				colony.removeModifier(m);</span>
			}
<span class="fc" id="L2987">		}</span>

		// The colony is falling, so allow other neighbours a chance
		// to claim its tiles. Make sure units are ejected when a tile
		// is claimed.
<span class="fc" id="L2992">		Set&lt;Tile&gt; tiles = colony.getOwnedTiles();</span>
<span class="fc" id="L2993">		tile.cacheUnseen();</span>
<span class="fc" id="L2994">		tiles.remove(tile);</span>
<span class="fc bfc" id="L2995" title="All 2 branches covered.">		for (Tile t : tiles) {</span>
<span class="fc" id="L2996">			t.cacheUnseen();</span>
<span class="fc" id="L2997">			t.changeOwnership(null, null);// -til</span>
<span class="fc" id="L2998">		}</span>
<span class="fc" id="L2999">		reassignTiles(tiles, colonyPlayer, colony);// -til</span>
<span class="fc bfc" id="L3000" title="All 2 branches covered.">		for (Tile t : tiles) {</span>
<span class="fc bfc" id="L3001" title="All 2 branches covered.">			if (t.getOwningSettlement() != colony) {</span>
<span class="fc" id="L3002">				ColonyTile ct = colony.getColonyTile(t);</span>
<span class="fc" id="L3003">				colony.ejectUnits(ct, ct.getUnitList());</span>
			}
<span class="fc" id="L3005">		}</span>

		// Hand over the colony. Inform former owner of loss of owned
		// tiles, and process possible increase in line of sight.
		// No need to display the colony tile or the attacker tile to
		// the attacking player as the unit is yet to move
<span class="fc" id="L3011">		Set&lt;Tile&gt; explored = colony// -til</span>
<span class="fc" id="L3012">				.csChangeOwner(attackerPlayer, cs);// -vis(attackerPlayer,colonyPlayer)</span>
<span class="fc" id="L3013">		explored.addAll(tiles);</span>
<span class="pc bpc" id="L3014" title="1 of 2 branches missed.">		if (attacker.hasTile())</span>
<span class="fc" id="L3015">			explored.remove(attacker.getTile());</span>
<span class="fc" id="L3016">		cs.add(See.only(attackerPlayer), explored);</span>
<span class="fc" id="L3017">		cs.add(See.perhaps().always(colonyPlayer).except(attackerPlayer), tiles);</span>

		// Inform the former owner of loss of units, and add sound.
<span class="fc" id="L3020">		cs.addRemoves(See.only(colonyPlayer), null, units);</span>
<span class="fc" id="L3021">		cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;, &quot;sound.event.captureColony&quot;);</span>

		// Ready to reset visibility
<span class="fc" id="L3024">		attackerPlayer.invalidateCanSeeTiles();// +vis(attackerPlayer)</span>
<span class="fc" id="L3025">		colonyPlayer.invalidateCanSeeTiles();// +vis(colonyPlayer)</span>
<span class="fc" id="L3026">	}</span>

	/**
	 * Extracts a convert from a native settlement.
	 *
	 * @param attacker
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is attacking.
	 * @param is
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; under attack.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csCaptureConvert(Unit attacker, IndianSettlement is, Random random, ChangeSet cs) {
<span class="fc" id="L3041">		final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L3042">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3043">		ServerPlayer nativePlayer = (ServerPlayer) is.getOwner();</span>
<span class="fc" id="L3044">		StringTemplate convertNation = nativePlayer.getNationLabel();</span>
<span class="fc" id="L3045">		List&lt;Unit&gt; units = is.getTile().getUnitList();</span>
<span class="pc bpc" id="L3046" title="1 of 2 branches missed.">		if (units.isEmpty())</span>
<span class="fc" id="L3047">			units.addAll(is.getUnitList());</span>
<span class="fc" id="L3048">		ServerUnit convert = (ServerUnit) getRandomMember(logger, &quot;Choose convert&quot;, units, random);</span>
<span class="pc bpc" id="L3049" title="1 of 2 branches missed.">		if (nativePlayer.csChangeOwner(convert, attackerPlayer, ChangeType.CONVERSION, attacker.getTile(), cs)) { // -vis(attackerPlayer)</span>
<span class="fc" id="L3050">			convert.changeRole(spec.getDefaultRole(), 0);</span>
<span class="fc" id="L3051">			convert.setMovesLeft(0);</span>
<span class="fc" id="L3052">			convert.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3053">			cs.add(See.only(nativePlayer), is.getTile());</span>
<span class="fc" id="L3054">			cs.addMessage(See.only(attackerPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.newConvertFromAttack&quot;, convert)
<span class="fc" id="L3056">							.addStringTemplate(&quot;%nation%&quot;, convertNation).addStringTemplate(&quot;%unit%&quot;,</span>
<span class="fc" id="L3057">									convert.getLabel()));</span>
<span class="fc" id="L3058">			attackerPlayer.invalidateCanSeeTiles();// +vis(attackerPlayer)</span>
		}
<span class="fc" id="L3060">	}</span>

	/**
	 * Captures equipment.
	 *
	 * @param winner
	 *            The &lt;code&gt;Unit&lt;/code&gt; that captures equipment.
	 * @param loser
	 *            The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csCaptureEquip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3073">		Role role = loser.getRole();</span>
<span class="fc" id="L3074">		csLoseEquip(winner, loser, cs);</span>
<span class="fc" id="L3075">		csCaptureEquipment(winner, loser, role, cs);</span>
<span class="fc" id="L3076">	}</span>

	/**
	 * Capture equipment.
	 *
	 * @param winner
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is capturing equipment.
	 * @param loser
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is losing equipment.
	 * @param role
	 *            The &lt;code&gt;Role&lt;/code&gt; wrest from the loser.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csCaptureEquipment(Unit winner, Unit loser, Role role, ChangeSet cs) {
<span class="fc" id="L3091">		ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3092">		ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3093">		Role newRole = winner.canCaptureEquipment(role);</span>
<span class="pc bpc" id="L3094" title="1 of 2 branches missed.">		if (newRole != null) {</span>
<span class="fc" id="L3095">			List&lt;AbstractGoods&gt; newGoods = winner.getGoodsDifference(newRole, 1);</span>
<span class="fc" id="L3096">			GoodsType goodsType = newGoods.get(0).getType(); // FIXME:</span>
																// generalize
<span class="fc" id="L3098">			winner.changeRole(newRole, 1);</span>

			// Currently can not capture equipment back so this only
			// makes sense for native players, and the message is
			// native specific.
<span class="pc bpc" id="L3103" title="1 of 2 branches missed.">			if (winnerPlayer.isIndian()) {</span>
<span class="fc" id="L3104">				StringTemplate winnerNation = winnerPlayer.getNationLabel();</span>
<span class="fc" id="L3105">				cs.addMessage(See.only(loserPlayer),</span>
						new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.equipmentCaptured&quot;,
<span class="fc" id="L3107">								winnerPlayer).addStringTemplate(&quot;%nation%&quot;, winnerNation).addNamed(&quot;%equipment%&quot;,</span>
										goodsType));

				// CHEAT: Immediately transferring the captured goods
				// back to a potentially remote settlement is pretty
				// dubious. Apparently Col1 did it. Better would be
				// to give the capturing unit a go-home-with-plunder mission.
<span class="fc" id="L3114">				IndianSettlement settlement = winner.getHomeIndianSettlement();</span>
<span class="pc bpc" id="L3115" title="1 of 2 branches missed.">				if (settlement != null) {</span>
<span class="fc bfc" id="L3116" title="All 2 branches covered.">					for (AbstractGoods ag : newGoods) {</span>
<span class="fc" id="L3117">						settlement.addGoods(ag);</span>
<span class="fc" id="L3118">						winnerPlayer.logCheat(&quot;teleported &quot; + ag + &quot; back to &quot; + settlement.getName());</span>
<span class="fc" id="L3119">					}</span>
<span class="fc" id="L3120">					cs.add(See.only(winnerPlayer), settlement);</span>
				}
			}
		}
<span class="fc" id="L3124">	}</span>

	/**
	 * Capture a unit.
	 *
	 * @param winner
	 *            A &lt;code&gt;Unit&lt;/code&gt; that is capturing.
	 * @param loser
	 *            A &lt;code&gt;Unit&lt;/code&gt; to capture.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csCaptureUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3137">		ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3138">		StringTemplate loserNation = loserPlayer.getNationLabel();</span>
<span class="fc" id="L3139">		StringTemplate loserLocation = loser.getLocation().getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3140">		StringTemplate oldName = loser.getLabel();</span>
<span class="fc" id="L3141">		String messageId = &quot;combat.unitCaptured.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3142">		ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3143">		StringTemplate winnerNation = winnerPlayer.getNationLabel();</span>
<span class="fc" id="L3144">		StringTemplate winnerLocation = winner.getLocation().getLocationLabelFor(winnerPlayer);</span>

		// Capture the unit. There are visibility implications for
		// both players because the captured unit might be the only
		// one on its tile, and the winner might have captured a unit
		// with greater line of sight.
<span class="fc" id="L3150">		Tile oldTile = loser.getTile();</span>
<span class="pc bpc" id="L3151" title="1 of 2 branches missed.">		ChangeType change = (winnerPlayer.isUndead()) ? ChangeType.UNDEAD : ChangeType.CAPTURE;</span>
<span class="pc bpc" id="L3152" title="1 of 2 branches missed.">		if (loserPlayer.csChangeOwner(loser, winnerPlayer, change, winner.getTile(), cs)) {// -vis(both)</span>
<span class="fc" id="L3153">			loser.setMovesLeft(0);</span>
<span class="fc" id="L3154">			loser.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3155">			cs.add(See.perhaps().always(loserPlayer), oldTile);</span>
			// Winner message post-capture when it owns the loser
<span class="fc" id="L3157">			cs.addMessage(See.only(winnerPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitCaptured&quot;, loser)
<span class="fc" id="L3159">							.addStringTemplate(&quot;%nation%&quot;, loserNation).addStringTemplate(&quot;%unit%&quot;, oldName)</span>
<span class="fc" id="L3160">							.addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3161">							.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3162">							.addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
		}
<span class="fc" id="L3164">		cs.addMessage(See.only(loserPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitCaptured&quot;,
<span class="fc" id="L3166">						loser.getTile()).addStringTemplate(&quot;%nation%&quot;, loserNation).addStringTemplate(&quot;%unit%&quot;, oldName)</span>
<span class="fc" id="L3167">								.addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3168">								.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3169">								.addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="fc" id="L3170">		winnerPlayer.invalidateCanSeeTiles();// +vis(winnerPlayer)</span>
<span class="fc" id="L3171">		loserPlayer.invalidateCanSeeTiles();// +vis(loserPlayer)</span>
<span class="fc" id="L3172">	}</span>

	/**
	 * Damages all ships in a colony in preparation for capture.
	 *
	 * @param attacker
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is damaging.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to damage ships in.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csDamageColonyShips(Unit attacker, Colony colony, ChangeSet cs) {
<span class="nc" id="L3185">		boolean captureRepairing = getSpecification().getBoolean(GameOptions.CAPTURE_UNITS_UNDER_REPAIR);</span>
<span class="nc" id="L3186">		List&lt;Unit&gt; units = colony.getTile().getUnitList();</span>
<span class="nc bnc" id="L3187" title="All 2 branches missed.">		while (!units.isEmpty()) {</span>
<span class="nc" id="L3188">			Unit unit = units.remove(0);</span>
<span class="nc bnc" id="L3189" title="All 6 branches missed.">			if (unit.isNaval() &amp;&amp; !(captureRepairing &amp;&amp; unit.isDamaged())) {</span>
<span class="nc" id="L3190">				csDamageShipAttack(attacker, unit, cs);</span>
			}
<span class="nc" id="L3192">		}</span>
<span class="nc" id="L3193">	}</span>

	/**
	 * Damage a ship through normal attack.
	 *
	 * @param attacker
	 *            The attacker &lt;code&gt;Unit&lt;/code&gt;.
	 * @param ship
	 *            The &lt;code&gt;Unit&lt;/code&gt; which is a ship to damage.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csDamageShipAttack(Unit attacker, Unit ship, ChangeSet cs) {
<span class="fc" id="L3206">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3207">		StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3208">		ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="fc" id="L3209">		Location repair = ship.getRepairLocation();</span>
<span class="fc" id="L3210">		StringTemplate repairLoc = repair.getLocationLabelFor(shipPlayer);</span>
<span class="fc" id="L3211">		StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="fc" id="L3213">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.enemyShipDamaged&quot;, attacker)
<span class="fc" id="L3215">						.addStringTemplate(&quot;%unit%&quot;, attacker.getLabel()).addStringTemplate(&quot;%enemyNation%&quot;, shipNation)</span>
<span class="fc" id="L3216">						.addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel()));</span>
<span class="fc" id="L3217">		cs.addMessage(See.only(shipPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipDamaged&quot;, ship)
<span class="fc" id="L3219">						.addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="fc" id="L3220">						.addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3221">						.addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3222">						.addStringTemplate(&quot;%repairLocation%&quot;, repairLoc));</span>

<span class="fc" id="L3224">		csDamageShip(ship, repair, cs);</span>
<span class="fc" id="L3225">	}</span>

	/**
	 * Damage a ship through bombard.
	 *
	 * @param settlement
	 *            The attacker &lt;code&gt;Settlement&lt;/code&gt;.
	 * @param ship
	 *            The &lt;code&gt;Unit&lt;/code&gt; which is a ship to damage.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csDamageShipBombard(Settlement settlement, Unit ship, ChangeSet cs) {
<span class="nc" id="L3238">		ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3239">		ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3240">		Location repair = ship.getRepairLocation();</span>
<span class="nc" id="L3241">		StringTemplate repairLoc = repair.getLocationLabelFor(shipPlayer);</span>
<span class="nc" id="L3242">		StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="nc" id="L3244">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.enemyShipDamagedByBombardment&quot;,
<span class="nc" id="L3246">						settlement).addName(&quot;%colony%&quot;, settlement.getName()).addStringTemplate(&quot;%nation%&quot;, shipNation)</span>
<span class="nc" id="L3247">								.addStringTemplate(&quot;%unit%&quot;, ship.getLabel()));</span>
<span class="nc" id="L3248">		cs.addMessage(See.only(shipPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipDamagedByBombardment&quot;, ship)
<span class="nc" id="L3250">						.addName(&quot;%colony%&quot;, settlement.getName()).addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3251">						.addStringTemplate(&quot;%repairLocation%&quot;, repairLoc));</span>

<span class="nc" id="L3253">		csDamageShip(ship, repair, cs);</span>
<span class="nc" id="L3254">	}</span>

	/**
	 * Damage a ship.
	 *
	 * @param ship
	 *            The naval &lt;code&gt;Unit&lt;/code&gt; to damage.
	 * @param repair
	 *            The &lt;code&gt;Location&lt;/code&gt; to send it to.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csDamageShip(Unit ship, Location repair, ChangeSet cs) {
<span class="fc" id="L3267">		ServerPlayer player = (ServerPlayer) ship.getOwner();</span>

		// Lose the goods and units aboard
<span class="pc bpc" id="L3270" title="1 of 2 branches missed.">		for (Goods g : ship.getGoodsContainer().getCompactGoods()) {</span>
<span class="nc" id="L3271">			ship.remove(g);</span>
<span class="nc" id="L3272">		}</span>
<span class="fc bfc" id="L3273" title="All 2 branches covered.">		for (Unit u : ship.getUnitList()) {</span>
<span class="fc" id="L3274">			ship.remove(u);</span>
<span class="fc" id="L3275">			cs.addRemove(See.only(player), null, u);// -vis: safe, within unit</span>
<span class="fc" id="L3276">			u.dispose();</span>
<span class="fc" id="L3277">		}</span>

		// Damage the ship and send it off for repair
<span class="pc bpc" id="L3280" title="1 of 2 branches missed.">		Location shipLoc = (repair instanceof Colony) ? repair.getTile() : repair;</span>
<span class="fc" id="L3281">		ship.setHitPoints(1);</span>
<span class="fc" id="L3282">		ship.setDestination(null);</span>
<span class="fc" id="L3283">		ship.setLocation(shipLoc);// -vis(player)</span>
<span class="fc" id="L3284">		ship.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3285">		ship.setMovesLeft(0);</span>
<span class="fc" id="L3286">		cs.add(See.only(player), (FreeColGameObject) shipLoc);</span>
<span class="fc" id="L3287">		player.invalidateCanSeeTiles();// +vis(player)</span>
<span class="fc" id="L3288">	}</span>

	/**
	 * Demotes a unit.
	 *
	 * @param winner
	 *            The &lt;code&gt;Unit&lt;/code&gt; that won.
	 * @param loser
	 *            The &lt;code&gt;Unit&lt;/code&gt; that lost and should be demoted.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csDemoteUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3301">		ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3302">		StringTemplate loserNation = loser.getApparentOwnerName();</span>
<span class="fc" id="L3303">		StringTemplate loserLocation = loser.getLocation().getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3304">		StringTemplate oldName = loser.getLabel();</span>
<span class="fc" id="L3305">		String messageId = &quot;combat.unitDemoted.&quot; + loser.getType().getSuffix();</span>
<span class="fc" id="L3306">		ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3307">		StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3308">		StringTemplate winnerLocation = winner.getLocation().getLocationLabelFor(winnerPlayer);</span>

<span class="fc" id="L3310">		UnitType type = loser.getTypeChange(ChangeType.DEMOTION, loserPlayer);</span>
<span class="pc bpc" id="L3311" title="2 of 4 branches missed.">		if (type == null || type == loser.getType()) {</span>
<span class="nc bnc" id="L3312" title="All 2 branches missed.">			logger.warning(&quot;Demotion failed, type=&quot; + ((type == null) ? &quot;null&quot; : &quot;same type: &quot; + type));</span>
<span class="nc" id="L3313">			return;</span>
		}
<span class="fc" id="L3315">		loser.changeType(type);// -vis(loserPlayer)</span>
<span class="fc" id="L3316">		loserPlayer.invalidateCanSeeTiles();// +vis(loserPlayer)</span>

<span class="fc" id="L3318">		cs.addMessage(See.only(winnerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitDemoted&quot;, winner)
<span class="fc" id="L3320">						.addStringTemplate(&quot;%nation%&quot;, loserNation).addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3321">						.addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3322">						.addStringTemplate(&quot;%enemyNation%&quot;, winnerPlayer.getNationLabel())</span>
<span class="fc" id="L3323">						.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3324">						.addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
<span class="fc" id="L3325">		cs.addMessage(See.only(loserPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitDemoted&quot;, loser)
<span class="fc" id="L3327">						.addStringTemplate(&quot;%nation%&quot;, loserPlayer.getNationLabel())</span>
<span class="fc" id="L3328">						.addStringTemplate(&quot;%oldName%&quot;, oldName).addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3329">						.addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3330">						.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3331">						.addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="fc" id="L3332">	}</span>

	/**
	 * Destroy a colony.
	 *
	 * @param attacker
	 *            The &lt;code&gt;Unit&lt;/code&gt; that attacked.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; that was attacked.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            The &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csDestroyColony(Unit attacker, Colony colony, Random random, ChangeSet cs) {
<span class="fc" id="L3347">		Game game = attacker.getGame();</span>
<span class="fc" id="L3348">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3349">		StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3350">		ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L3351">		StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>
<span class="fc" id="L3352">		int plunder = colony.getPlunder(attacker, random);</span>

		// Handle history and messages before colony destruction.
<span class="fc" id="L3355">		cs.addHistory(colonyPlayer,</span>
<span class="fc" id="L3356">				new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.COLONY_DESTROYED, attackerPlayer)</span>
<span class="fc" id="L3357">						.addStringTemplate(&quot;%nation%&quot;, attackerNation).addName(&quot;%colony%&quot;, colony.getName()));</span>
<span class="fc" id="L3358">		cs.addMessage(See.only(colonyPlayer),</span>
<span class="fc" id="L3359">				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.colonyBurning&quot;, colony.getTile())</span>
<span class="fc" id="L3360">						.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%amount%&quot;, plunder)</span>
<span class="fc" id="L3361">						.addStringTemplate(&quot;%nation%&quot;, attackerNation)</span>
<span class="fc" id="L3362">						.addStringTemplate(&quot;%unit%&quot;, attacker.getLabel()));</span>
<span class="fc" id="L3363">		cs.addMessage(See.all().except(colonyPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.enemyColonyBurning&quot;, colonyPlayer)
<span class="fc" id="L3365">						.addName(&quot;%colony%&quot;, colony.getName()).addStringTemplate(&quot;%nation%&quot;, colonyNation)</span>
<span class="fc" id="L3366">						.addStringTemplate(&quot;%attackerNation%&quot;, attackerNation));</span>
<span class="fc" id="L3367">		colonyPlayer.csLoseLocation(colony, cs);</span>

		// Allocate some plunder.
<span class="pc bpc" id="L3370" title="1 of 2 branches missed.">		if (plunder &gt; 0) {</span>
<span class="nc" id="L3371">			attackerPlayer.modifyGold(plunder);</span>
<span class="nc" id="L3372">			colonyPlayer.modifyGold(-plunder);</span>
<span class="nc" id="L3373">			cs.addPartial(See.only(attackerPlayer), attackerPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3374">			cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
		}

		// Dispose of the colony and its contents.
<span class="fc" id="L3378">		csDisposeSettlement(colony, cs);</span>
<span class="fc" id="L3379">	}</span>

	/**
	 * Destroys an Indian settlement.
	 *
	 * @param attacker
	 *            an &lt;code&gt;Unit&lt;/code&gt; value
	 * @param settlement
	 *            an &lt;code&gt;IndianSettlement&lt;/code&gt; value
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csDestroySettlement(Unit attacker, IndianSettlement settlement, Random random, ChangeSet cs) {
<span class="nc" id="L3394">		final Game game = getGame();</span>
<span class="nc" id="L3395">		final Specification spec = game.getSpecification();</span>
<span class="nc" id="L3396">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L3397">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L3398">		ServerPlayer nativePlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3399">		StringTemplate attackerNation = attackerPlayer.getNationLabel();</span>
<span class="nc" id="L3400">		StringTemplate nativeNation = nativePlayer.getNationLabel();</span>
<span class="nc" id="L3401">		String settlementName = settlement.getName();</span>
<span class="nc" id="L3402">		boolean capital = settlement.isCapital();</span>
<span class="nc" id="L3403">		int plunder = settlement.getPlunder(attacker, random);</span>

		// Remaining units lose their home.
<span class="nc bnc" id="L3406" title="All 2 branches missed.">		for (Unit u : settlement.getOwnedUnits()) {</span>
<span class="nc" id="L3407">			u.setHomeIndianSettlement(null);</span>
<span class="nc" id="L3408">			cs.add(See.only(nativePlayer), u);</span>
<span class="nc" id="L3409">		}</span>

		// Destroy the settlement, update settlement tiles.
<span class="nc" id="L3412">		csDisposeSettlement(settlement, cs);</span>

		// Make the treasure train if there is treasure.
<span class="nc bnc" id="L3415" title="All 2 branches missed.">		if (plunder &gt; 0) {</span>
<span class="nc" id="L3416">			List&lt;UnitType&gt; unitTypes = spec.getUnitTypesWithAbility(Ability.CARRY_TREASURE);</span>
<span class="nc" id="L3417">			UnitType type = getRandomMember(logger, &quot;Choose train&quot;, unitTypes, random);</span>
<span class="nc" id="L3418">			Unit train = new ServerUnit(game, tile, attackerPlayer, type);// -vis:</span>
																			// safe,
																			// attacker
																			// on
																			// tile
<span class="nc" id="L3423">			train.setTreasureAmount(plunder);</span>
		}

		// This is an atrocity.
<span class="nc" id="L3427">		int score = spec.getInteger(GameOptions.DESTROY_SETTLEMENT_SCORE);</span>
<span class="nc" id="L3428">		HistoryEvent h = new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.DESTROY_SETTLEMENT, this)</span>
<span class="nc" id="L3429">				.addStringTemplate(&quot;%nation%&quot;, nativeNation).addName(&quot;%settlement%&quot;, settlementName);</span>
<span class="nc" id="L3430">		h.setScore(score);</span>
<span class="nc" id="L3431">		cs.addHistory(attackerPlayer, h);</span>

		// Finish with messages and history.
<span class="nc" id="L3434">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.indianTreasure&quot;, attacker)
<span class="nc" id="L3436">						.addName(&quot;%settlement%&quot;, settlementName).addAmount(&quot;%amount%&quot;, plunder));</span>
<span class="nc bnc" id="L3437" title="All 2 branches missed.">		if (capital) {</span>
<span class="nc" id="L3438">			cs.addMessage(See.only(attackerPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;combat.nativeCapitalBurned&quot;, attacker)
<span class="nc" id="L3440">							.addName(&quot;%name%&quot;, settlementName).addStringTemplate(&quot;%nation%&quot;, nativeNation));</span>
		}
<span class="nc bnc" id="L3442" title="All 2 branches missed.">		if (nativePlayer.checkForDeath() == IS_DEAD) {</span>
<span class="nc" id="L3443">			h = new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.DESTROY_NATION, this)</span>
<span class="nc" id="L3444">					.addStringTemplate(&quot;%nation%&quot;, attackerNation).addStringTemplate(&quot;%nativeNation%&quot;, nativeNation);</span>
<span class="nc" id="L3445">			h.setScore(SCORE_NATION_DESTROYED);</span>
<span class="nc" id="L3446">			cs.addGlobalHistory(game, h);</span>
		}
<span class="nc" id="L3448">		cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;, &quot;sound.event.destroySettlement&quot;);</span>
<span class="nc" id="L3449">	}</span>

	/**
	 * Disposes of a settlement and reassign its tiles.
	 *
	 * +vis,til: Resolves the whole mess.
	 *
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; under attack.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csDisposeSettlement(Settlement settlement, ChangeSet cs) {
<span class="fc" id="L3462">		logger.finest(&quot;Disposing of &quot; + settlement.getName());</span>
<span class="fc" id="L3463">		ServerPlayer owner = (ServerPlayer) settlement.getOwner();</span>
<span class="fc" id="L3464">		Set&lt;Tile&gt; owned = settlement.getOwnedTiles();</span>
<span class="fc bfc" id="L3465" title="All 2 branches covered.">		for (Tile t : owned)</span>
<span class="fc" id="L3466">			t.cacheUnseen();// +til</span>
<span class="fc" id="L3467">		Tile centerTile = settlement.getTile();</span>
<span class="fc" id="L3468">		ServerPlayer missionaryOwner = null;</span>
<span class="fc" id="L3469">		int radius = 0;</span>

		// Get rid of the any missionary first.
<span class="pc bpc" id="L3472" title="1 of 2 branches missed.">		if (settlement instanceof ServerIndianSettlement) {</span>
<span class="nc" id="L3473">			ServerIndianSettlement sis = (ServerIndianSettlement) settlement;</span>
<span class="nc bnc" id="L3474" title="All 2 branches missed.">			if (sis.hasMissionary()) {</span>
<span class="nc" id="L3475">				missionaryOwner = (ServerPlayer) sis.getMissionary().getOwner();</span>
<span class="nc" id="L3476">				radius = sis.getMissionaryLineOfSight();</span>
<span class="nc" id="L3477">				sis.csKillMissionary(true, cs);</span>
			}
		}

		// Get it off the map and off the owners list.
<span class="fc" id="L3482">		settlement.exciseSettlement();// -vis(owner),-til</span>
<span class="fc" id="L3483">		owner.removeSettlement(settlement);</span>
<span class="pc bpc" id="L3484" title="1 of 2 branches missed.">		if (owner.hasSettlement(settlement)) {</span>
<span class="nc" id="L3485">			throw new IllegalStateException(&quot;Still has settlement: &quot; + settlement);</span>
		}

		// Reassign the tiles owned by the settlement, if possible
<span class="fc" id="L3489">		reassignTiles(owned, owner, null);</span>

<span class="fc" id="L3491">		See vis = See.perhaps().always(owner);</span>
<span class="pc bpc" id="L3492" title="1 of 2 branches missed.">		if (missionaryOwner != null)</span>
<span class="nc" id="L3493">			vis.except(missionaryOwner);</span>
<span class="fc" id="L3494">		cs.add(vis, owned);</span>
<span class="fc" id="L3495">		cs.addRemove(vis, centerTile, settlement);// -vis(owner)</span>
<span class="fc" id="L3496">		settlement.dispose();</span>
<span class="fc" id="L3497">		owner.invalidateCanSeeTiles();// +vis(owner)</span>

		// Former missionary owner knows that the settlement fell.
<span class="pc bpc" id="L3500" title="1 of 2 branches missed.">		if (missionaryOwner != null) {</span>
<span class="nc" id="L3501">			List&lt;Tile&gt; surrounding = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L3502" title="All 2 branches missed.">			for (Tile t : centerTile.getSurroundingTiles(1, radius)) {</span>
<span class="nc bnc" id="L3503" title="All 2 branches missed.">				if (!owned.contains(t))</span>
<span class="nc" id="L3504">					surrounding.add(t);</span>
<span class="nc" id="L3505">			}</span>
<span class="nc" id="L3506">			cs.add(See.only(missionaryOwner), owned);</span>
<span class="nc" id="L3507">			cs.add(See.only(missionaryOwner), surrounding);</span>
<span class="nc" id="L3508">			cs.addRemove(See.only(missionaryOwner), centerTile, settlement);</span>
<span class="nc" id="L3509">			missionaryOwner.invalidateCanSeeTiles();// +vis(missionaryOwner)</span>
<span class="nc bnc" id="L3510" title="All 2 branches missed.">			for (Tile t : surrounding)</span>
<span class="nc" id="L3511">				t.cacheUnseen(missionaryOwner);</span>
		}

		// Recache, should only show now cleared tiles to former owner.
<span class="fc bfc" id="L3515" title="All 2 branches covered.">		for (Tile t : owned)</span>
<span class="fc" id="L3516">			t.cacheUnseen();</span>
		// Center tile is special for native settlements. Because
		// native settlement tiles are *always* cached, the cache
		// needs to be completely cleared for players that can see the
		// settlement is gone.
<span class="pc bpc" id="L3521" title="1 of 2 branches missed.">		if (settlement instanceof IndianSettlement)</span>
<span class="nc" id="L3522">			centerTile.seeTile();</span>
<span class="pc bpc" id="L3523" title="1 of 2 branches missed.">		if (missionaryOwner != null)</span>
<span class="nc" id="L3524">			centerTile.seeTile(missionaryOwner);</span>
<span class="fc" id="L3525">	}</span>

	/**
	 * Evade a normal attack.
	 *
	 * @param attacker
	 *            The attacker &lt;code&gt;Unit&lt;/code&gt;.
	 * @param defender
	 *            A naval &lt;code&gt;Unit&lt;/code&gt; that evades the attacker.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csEvadeAttack(Unit attacker, Unit defender, ChangeSet cs) {
<span class="nc" id="L3538">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="nc" id="L3539">		StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="nc" id="L3540">		ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="nc" id="L3541">		StringTemplate defenderNation = defender.getApparentOwnerName();</span>

<span class="nc" id="L3543">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.enemyShipEvaded&quot;, attacker)
<span class="nc" id="L3545">						.addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="nc" id="L3546">						.addStringTemplate(&quot;%enemyUnit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3547">						.addStringTemplate(&quot;%enemyNation%&quot;, defenderNation));</span>
<span class="nc" id="L3548">		cs.addMessage(See.only(defenderPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipEvaded&quot;, defender)
<span class="nc" id="L3550">						.addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3551">						.addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel())</span>
<span class="nc" id="L3552">						.addStringTemplate(&quot;%enemyNation%&quot;, attackerNation));</span>
<span class="nc" id="L3553">	}</span>

	/**
	 * Evade a bombardment.
	 *
	 * @param settlement
	 *            The attacker &lt;code&gt;Settlement&lt;/code&gt;.
	 * @param defender
	 *            A naval &lt;code&gt;Unit&lt;/code&gt; that evades the attacker.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csEvadeBombard(Settlement settlement, Unit defender, ChangeSet cs) {
<span class="nc" id="L3566">		ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3567">		ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="nc" id="L3568">		StringTemplate defenderNation = defender.getApparentOwnerName();</span>

<span class="nc" id="L3570">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipEvadedBombardment&quot;, settlement)
<span class="nc" id="L3572">						.addName(&quot;%colony%&quot;, settlement.getName()).addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3573">						.addStringTemplate(&quot;%nation%&quot;, defenderNation));</span>
<span class="nc" id="L3574">		cs.addMessage(See.only(defenderPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipEvadedBombardment&quot;, defender)
<span class="nc" id="L3576">						.addName(&quot;%colony%&quot;, settlement.getName()).addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="nc" id="L3577">						.addStringTemplate(&quot;%nation%&quot;, defenderNation));</span>
<span class="nc" id="L3578">	}</span>

	/**
	 * Loot a ship.
	 *
	 * @param winner
	 *            The winning naval &lt;code&gt;Unit&lt;/code&gt;.
	 * @param loser
	 *            The losing naval &lt;code&gt;Unit&lt;/code&gt;
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csLootShip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3591">		ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3592">		List&lt;Goods&gt; capture = loser.getGoodsList();</span>
<span class="pc bpc" id="L3593" title="2 of 4 branches missed.">		if (!capture.isEmpty() &amp;&amp; winner.hasSpaceLeft()) {</span>
<span class="fc bfc" id="L3594" title="All 2 branches covered.">			for (Goods g : capture)</span>
<span class="fc" id="L3595">				g.setLocation(null);</span>
<span class="fc" id="L3596">			new LootSession(winner, loser, capture);</span>
<span class="fc" id="L3597">			cs.add(See.only(winnerPlayer), ChangeSet.ChangePriority.CHANGE_LATE,</span>
<span class="fc" id="L3598">					new LootCargoMessage(winner, loser.getId(), capture));</span>
		}
<span class="fc" id="L3600">		loser.getGoodsContainer().removeAll();</span>
<span class="fc" id="L3601">		loser.setState(Unit.UnitState.ACTIVE);</span>
<span class="fc" id="L3602">	}</span>

	/**
	 * Unit auto equips but loses equipment.
	 *
	 * @param attacker
	 *            The &lt;code&gt;Unit&lt;/code&gt; that attacked.
	 * @param defender
	 *            The &lt;code&gt;Unit&lt;/code&gt; that defended and loses equipment.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csLoseAutoEquip(Unit attacker, Unit defender, ChangeSet cs) {
<span class="fc" id="L3615">		ServerPlayer defenderPlayer = (ServerPlayer) defender.getOwner();</span>
<span class="fc" id="L3616">		StringTemplate defenderNation = defenderPlayer.getNationLabel();</span>
<span class="fc" id="L3617">		Settlement settlement = defender.getSettlement();</span>
<span class="fc" id="L3618">		StringTemplate defenderLocation = defender.getLocation().getLocationLabelFor(defenderPlayer);</span>
<span class="fc" id="L3619">		Role role = defender.getAutomaticRole();</span>
<span class="fc" id="L3620">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3621">		StringTemplate attackerLocation = attacker.getLocation().getLocationLabelFor(attackerPlayer);</span>
<span class="fc" id="L3622">		StringTemplate attackerNation = attacker.getApparentOwnerName();</span>

		// Autoequipment is not actually with the unit, it is stored
		// in the settlement of the unit. Remove it from there.
<span class="fc bfc" id="L3626" title="All 2 branches covered.">		for (AbstractGoods ag : role.getRequiredGoods()) {</span>
<span class="fc" id="L3627">			settlement.removeGoods(ag);</span>
<span class="fc" id="L3628">		}</span>

<span class="fc" id="L3630">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.unitWinColony&quot;, attacker)
<span class="fc" id="L3632">						.addStringTemplate(&quot;%location%&quot;, attackerLocation)</span>
<span class="fc" id="L3633">						.addStringTemplate(&quot;%nation%&quot;, attackerPlayer.getNationLabel())</span>
<span class="fc" id="L3634">						.addStringTemplate(&quot;%unit%&quot;, attacker.getLabel())</span>
<span class="fc" id="L3635">						.addStringTemplate(&quot;%settlement%&quot;, settlement.getLocationLabelFor(attackerPlayer))</span>
<span class="fc" id="L3636">						.addStringTemplate(&quot;%enemyNation%&quot;, defenderNation)</span>
<span class="fc" id="L3637">						.addStringTemplate(&quot;%enemyUnit%&quot;, defender.getLabel()));</span>
<span class="fc" id="L3638">		cs.addMessage(See.only(defenderPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.unitLoseAutoEquip&quot;, defender)
<span class="fc" id="L3640">						.addStringTemplate(&quot;%location%&quot;, defenderLocation).addStringTemplate(&quot;%nation%&quot;, defenderNation)</span>
<span class="fc" id="L3641">						.addStringTemplate(&quot;%unit%&quot;, defender.getLabel())</span>
<span class="fc" id="L3642">						.addStringTemplate(&quot;%settlement%&quot;, settlement.getLocationLabelFor(defenderPlayer))</span>
<span class="fc" id="L3643">						.addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3644">						.addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
<span class="fc" id="L3645">	}</span>

	/**
	 * Unit drops some equipment.
	 *
	 * @param winner
	 *            The &lt;code&gt;Unit&lt;/code&gt; that won.
	 * @param loser
	 *            The &lt;code&gt;Unit&lt;/code&gt; that lost and loses equipment.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csLoseEquip(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3658">		final Specification spec = getSpecification();</span>
<span class="fc" id="L3659">		ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3660">		StringTemplate loserNation = loserPlayer.getNationLabel();</span>
<span class="fc" id="L3661">		StringTemplate loserLocation = loser.getLocation().getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3662">		StringTemplate oldName = loser.getLabel();</span>
<span class="fc" id="L3663">		ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3664">		StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="fc" id="L3665">		StringTemplate winnerLocation = winner.getLocation().getLocationLabelFor(winnerPlayer);</span>
<span class="fc" id="L3666">		Role role = loser.getRole();</span>

<span class="fc" id="L3668">		Role downgrade = role.getDowngrade();</span>
<span class="fc bfc" id="L3669" title="All 2 branches covered.">		if (downgrade != null) {</span>
<span class="fc" id="L3670">			loser.changeRole(downgrade, 1);</span>
		} else {
<span class="fc" id="L3672">			loser.changeRole(spec.getDefaultRole(), 0);</span>
		}

		// Account for possible loss of mobility due to horses going away.
<span class="fc" id="L3676">		loser.setMovesLeft(Math.min(loser.getMovesLeft(), loser.getInitialMovesLeft()));</span>

		String messageId;
<span class="fc bfc" id="L3679" title="All 2 branches covered.">		if (!loser.isArmed()) {</span>
<span class="fc" id="L3680">			messageId = &quot;combat.unitDemotedToUnarmed&quot;;</span>
<span class="fc" id="L3681">			loser.setState(Unit.UnitState.ACTIVE);</span>
		} else {
<span class="fc" id="L3683">			messageId = loser.getType().getId() + &quot;.demoted&quot;;</span>
		}

<span class="fc" id="L3686">		cs.addMessage(See.only(winnerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitDemoted&quot;, winner)
<span class="fc" id="L3688">						.addStringTemplate(&quot;%nation%&quot;, loserNation).addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3689">						.addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L3690">						.addStringTemplate(&quot;%enemyNation%&quot;, winnerPlayer.getNationLabel())</span>
<span class="fc" id="L3691">						.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3692">						.addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
<span class="fc" id="L3693">		cs.addMessage(See.only(loserPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitDemoted&quot;, loser)
<span class="fc" id="L3695">						.addStringTemplate(&quot;%nation%&quot;, loserNation).addStringTemplate(&quot;%oldName%&quot;, oldName)</span>
<span class="fc" id="L3696">						.addStringTemplate(&quot;%unit%&quot;, loser.getLabel()).addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L3697">						.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3698">						.addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="fc" id="L3699">	}</span>

	/**
	 * Hook for when a player loses access to a location for whatever reason.
	 * Useful for disabling trade routes.
	 *
	 * @param loc
	 *            The &lt;code&gt;Location&lt;/code&gt; that was lost.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csLoseLocation(Location loc, ChangeSet cs) {
<span class="pc bpc" id="L3711" title="1 of 2 branches missed.">		for (TradeRoute tr : getTradeRoutes()) {</span>
<span class="nc" id="L3712">			boolean suspend = false;</span>
<span class="nc" id="L3713">			Iterator&lt;TradeRouteStop&gt; trsi = tr.getStops().iterator();</span>
<span class="nc bnc" id="L3714" title="All 2 branches missed.">			while (trsi.hasNext()) {</span>
<span class="nc" id="L3715">				TradeRouteStop trs = trsi.next();</span>
<span class="nc bnc" id="L3716" title="All 2 branches missed.">				if (Map.isSameLocation(trs.getLocation(), loc)) {</span>
<span class="nc" id="L3717">					suspend = true;</span>
<span class="nc" id="L3718">					trsi.remove();</span>
				}
<span class="nc" id="L3720">			}</span>
<span class="nc bnc" id="L3721" title="All 2 branches missed.">			if (suspend) {</span>
<span class="nc bnc" id="L3722" title="All 2 branches missed.">				for (Unit u : tr.getAssignedUnits()) {</span>
<span class="nc" id="L3723">					u.setTradeRoute(null);</span>
<span class="nc" id="L3724">					cs.add(See.only(this), u);</span>
<span class="nc" id="L3725">				}</span>
<span class="nc" id="L3726">				cs.addMessage(See.only(this),</span>
						new ModelMessage(ModelMessage.MessageType.GOODS_MOVEMENT, &quot;combat.tradeRouteSuspended&quot;, this)
<span class="nc" id="L3728">								.addName(&quot;%route%&quot;, tr.getName()).addStringTemplate(&quot;%stop%&quot;, loc.getLocationLabel()));</span>
<span class="nc" id="L3729">				cs.add(See.only(this), tr);</span>
			}
<span class="nc" id="L3731">		}</span>
<span class="fc" id="L3732">	}</span>

	/**
	 * Damage a building or a ship or steal some goods or gold.
	 *
	 * @param attacker
	 *            The attacking &lt;code&gt;Unit&lt;/code&gt;.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to pillage.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csPillageColony(Unit attacker, Colony colony, Random random, ChangeSet cs) {
<span class="fc" id="L3747">		ServerPlayer attackerPlayer = (ServerPlayer) attacker.getOwner();</span>
<span class="fc" id="L3748">		StringTemplate attackerNation = attacker.getApparentOwnerName();</span>
<span class="fc" id="L3749">		ServerPlayer colonyPlayer = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L3750">		StringTemplate colonyNation = colonyPlayer.getNationLabel();</span>

		// Collect the damagable buildings, ships, movable goods.
<span class="fc" id="L3753">		List&lt;Building&gt; buildingList = colony.getBurnableBuildings();</span>
<span class="fc" id="L3754">		List&lt;Unit&gt; shipList = colony.getTile().getNavalUnits();</span>
<span class="fc" id="L3755">		List&lt;Goods&gt; goodsList = colony.getLootableGoodsList();</span>

		// Pick one, with one extra choice for stealing gold.
<span class="fc" id="L3758">		int pillage = randomInt(logger, &quot;Pillage choice&quot;, random,</span>
<span class="fc bfc" id="L3759" title="All 2 branches covered.">				buildingList.size() + shipList.size() + goodsList.size() + ((colony.canBePlundered()) ? 1 : 0));</span>
<span class="fc bfc" id="L3760" title="All 2 branches covered.">		if (pillage &lt; buildingList.size()) {</span>
<span class="fc" id="L3761">			Building building = buildingList.get(pillage);</span>
<span class="fc" id="L3762">			csDamageBuilding(building, cs);</span>
<span class="fc" id="L3763">			cs.addMessage(See.only(colonyPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.buildingDamaged&quot;, colony)
<span class="fc" id="L3765">							.addNamed(&quot;%building%&quot;, building).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3766">							.addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3767">							.addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
<span class="fc bfc" id="L3768" title="All 2 branches covered.">		} else if (pillage &lt; buildingList.size() + shipList.size()) {</span>
<span class="fc" id="L3769">			Unit ship = shipList.get(pillage - buildingList.size());</span>
<span class="pc bpc" id="L3770" title="1 of 2 branches missed.">			if (ship.getRepairLocation() == null) {</span>
<span class="nc" id="L3771">				csSinkShipAttack(attacker, ship, cs);</span>
			} else {
<span class="fc" id="L3773">				csDamageShipAttack(attacker, ship, cs);</span>
			}
<span class="fc bfc" id="L3775" title="All 2 branches covered.">		} else if (pillage &lt; buildingList.size() + shipList.size() + goodsList.size()) {</span>
<span class="fc" id="L3776">			Goods goods = goodsList.get(pillage - buildingList.size() - shipList.size());</span>
<span class="fc" id="L3777">			goods.setAmount(Math.min(goods.getAmount() / 2, 50));</span>
<span class="fc" id="L3778">			colony.removeGoods(goods);</span>
<span class="pc bpc" id="L3779" title="1 of 2 branches missed.">			if (attacker.canAdd(goods))</span>
<span class="fc" id="L3780">				attacker.add(goods);</span>
<span class="fc" id="L3781">			cs.addMessage(See.only(colonyPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.goodsStolen&quot;, colony, goods)
<span class="fc" id="L3783">							.addAmount(&quot;%amount%&quot;, goods.getAmount()).addNamed(&quot;%goods%&quot;, goods.getType())</span>
<span class="fc" id="L3784">							.addName(&quot;%colony%&quot;, colony.getName()).addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3785">							.addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>

<span class="fc" id="L3787">		} else {</span>
<span class="fc" id="L3788">			int plunder = Math.max(1, colony.getPlunder(attacker, random) / 5);</span>
<span class="fc" id="L3789">			colonyPlayer.modifyGold(-plunder);</span>
<span class="fc" id="L3790">			attackerPlayer.modifyGold(plunder);</span>
<span class="fc" id="L3791">			cs.addPartial(See.only(colonyPlayer), colonyPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L3792">			cs.addMessage(See.only(colonyPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.indianPlunder&quot;, colony)
<span class="fc" id="L3794">							.addAmount(&quot;%amount%&quot;, plunder).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3795">							.addStringTemplate(&quot;%enemyNation%&quot;, attackerNation)</span>
<span class="fc" id="L3796">							.addStringTemplate(&quot;%enemyUnit%&quot;, attacker.getLabel()));</span>
		}
<span class="fc" id="L3798">		cs.addMessage(See.all().except(colonyPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.indianRaid&quot;, colonyPlayer)
<span class="fc" id="L3800">						.addStringTemplate(&quot;%nation%&quot;, attackerNation).addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="fc" id="L3801">						.addStringTemplate(&quot;%colonyNation%&quot;, colonyNation));</span>
<span class="fc" id="L3802">	}</span>

	/**
	 * Damage a building in a colony by downgrading it if possible and
	 * destroying it otherwise.
	 *
	 * This is called as a result of pillaging, which always updates the colony
	 * tile.
	 *
	 * @param building
	 *            The &lt;code&gt;Building&lt;/code&gt; to damage.
	 * @param cs
	 *            a &lt;code&gt;ChangeSet&lt;/code&gt; value
	 */
	private void csDamageBuilding(Building building, ChangeSet cs) {
<span class="fc" id="L3817">		ServerColony colony = (ServerColony) building.getColony();</span>
<span class="fc" id="L3818">		Tile copied = colony.getTile().getTileToCache();</span>
<span class="fc" id="L3819">		boolean changed = false;</span>
<span class="fc" id="L3820">		BuildingType type = building.getType();</span>
<span class="pc bpc" id="L3821" title="1 of 2 branches missed.">		if (type.getUpgradesFrom() == null) {</span>
<span class="fc" id="L3822">			changed = colony.ejectUnits(building, building.getUnitList());// -til</span>
<span class="fc" id="L3823">			colony.destroyBuilding(building);// -til</span>
<span class="fc" id="L3824">			changed |= building.getType().isDefenceType();</span>
<span class="fc" id="L3825">			cs.addRemove(See.only((ServerPlayer) colony.getOwner()), colony, building);// -vis:</span>
																						// safe,
																						// buildings
																						// are
																						// ok
<span class="fc" id="L3830">			building.dispose();</span>
			// Have any abilities been removed that gate other production,
			// e.g. removing docks should shut down fishing.
<span class="fc bfc" id="L3833" title="All 2 branches covered.">			for (WorkLocation wl : colony.getAllWorkLocations()) {</span>
<span class="pc bpc" id="L3834" title="1 of 4 branches missed.">				if (!wl.isEmpty() &amp;&amp; !wl.canBeWorked()) {</span>
<span class="nc" id="L3835">					changed |= colony.ejectUnits(wl, wl.getUnitList());// -til</span>
<span class="nc" id="L3836">					logger.info(&quot;Units ejected from workLocation &quot; + wl.getId() + &quot; on loss of &quot;</span>
<span class="nc" id="L3837">							+ building.getType().getSuffix());</span>
				}
<span class="fc" id="L3839">			}</span>
<span class="nc bnc" id="L3840" title="All 2 branches missed.">		} else if (building.canBeDamaged()) {</span>
<span class="nc" id="L3841">			changed = colony.ejectUnits(building, building.downgrade());// -til</span>
<span class="nc" id="L3842">			changed |= building.getType().isDefenceType();</span>
		} else {
<span class="nc" id="L3844">			return;</span>
		}
<span class="pc bpc" id="L3846" title="1 of 2 branches missed.">		if (changed)</span>
<span class="nc" id="L3847">			colony.getTile().cacheUnseen(copied);// +til</span>
<span class="pc bpc" id="L3848" title="1 of 2 branches missed.">		if (isAI()) {</span>
<span class="fc" id="L3849">			colony.firePropertyChange(Colony.REARRANGE_WORKERS, true, false);</span>
		}
<span class="fc" id="L3851">	}</span>

	/**
	 * Promotes a unit.
	 *
	 * @param winner
	 *            The &lt;code&gt;Unit&lt;/code&gt; that won and should be promoted.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csPromoteUnit(Unit winner, ChangeSet cs) {
<span class="fc" id="L3862">		ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3863">		StringTemplate winnerNation = winnerPlayer.getNationLabel();</span>
<span class="fc" id="L3864">		StringTemplate oldName = winner.getLabel();</span>

<span class="fc" id="L3866">		UnitType type = winner.getTypeChange(ChangeType.PROMOTION, winnerPlayer);</span>
<span class="pc bpc" id="L3867" title="2 of 4 branches missed.">		if (type == null || type == winner.getType()) {</span>
<span class="nc bnc" id="L3868" title="All 2 branches missed.">			logger.warning(&quot;Promotion failed, type=&quot; + ((type == null) ? &quot;null&quot; : &quot;same type: &quot; + type));</span>
<span class="nc" id="L3869">			return;</span>
		}
<span class="fc" id="L3871">		winner.changeType(type);// -vis(winnerPlayer)</span>
<span class="fc" id="L3872">		winnerPlayer.invalidateCanSeeTiles();// +vis(winnerPlayer)</span>

<span class="fc" id="L3874">		cs.addMessage(See.only(winnerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.unitPromoted&quot;, winner)
<span class="fc" id="L3876">						.addStringTemplate(&quot;%oldName%&quot;, oldName).addStringTemplate(&quot;%unit%&quot;, winner.getLabel())</span>
<span class="fc" id="L3877">						.addStringTemplate(&quot;%nation%&quot;, winnerNation));</span>
<span class="fc" id="L3878">	}</span>

	/**
	 * Sinks all ships in a colony.
	 *
	 * @param attacker
	 *            The attacker &lt;code&gt;Unit&lt;/code&gt;.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to sink ships in.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csSinkColonyShips(Unit attacker, Colony colony, ChangeSet cs) {
<span class="nc" id="L3891">		boolean captureRepairing = getSpecification().getBoolean(GameOptions.CAPTURE_UNITS_UNDER_REPAIR);</span>
<span class="nc" id="L3892">		List&lt;Unit&gt; units = colony.getTile().getUnitList();</span>
<span class="nc bnc" id="L3893" title="All 2 branches missed.">		while (!units.isEmpty()) {</span>
<span class="nc" id="L3894">			Unit unit = units.remove(0);</span>
<span class="nc bnc" id="L3895" title="All 6 branches missed.">			if (unit.isNaval() &amp;&amp; !(captureRepairing &amp;&amp; unit.isDamaged())) {</span>
<span class="nc" id="L3896">				csSinkShipAttack(attacker, unit, cs);</span>
			}
<span class="nc" id="L3898">		}</span>
<span class="nc" id="L3899">	}</span>

	/**
	 * Sinks this ship as result of a normal attack.
	 *
	 * @param attacker
	 *            The attacker &lt;code&gt;Unit&lt;/code&gt;.
	 * @param ship
	 *            The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csSinkShipAttack(Unit attacker, Unit ship, ChangeSet cs) {
<span class="nc" id="L3912">		ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3913">		StringTemplate shipNation = ship.getApparentOwnerName();</span>
<span class="nc" id="L3914">		Unit attackerUnit = attacker;</span>
<span class="nc" id="L3915">		ServerPlayer attackerPlayer = (ServerPlayer) attackerUnit.getOwner();</span>
<span class="nc" id="L3916">		StringTemplate attackerNation = attackerUnit.getApparentOwnerName();</span>

<span class="nc" id="L3918">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.enemyShipSunk&quot;, attackerUnit)
<span class="nc" id="L3920">						.addStringTemplate(&quot;%unit%&quot;, attackerUnit.getLabel())</span>
<span class="nc" id="L3921">						.addStringTemplate(&quot;%enemyUnit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3922">						.addStringTemplate(&quot;%enemyNation%&quot;, shipNation));</span>
<span class="nc" id="L3923">		cs.addMessage(See.only(shipPlayer),</span>
<span class="nc" id="L3924">				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipSunk&quot;, ship.getTile())</span>
<span class="nc" id="L3925">						.addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3926">						.addStringTemplate(&quot;%enemyUnit%&quot;, attackerUnit.getLabel())</span>
<span class="nc" id="L3927">						.addStringTemplate(&quot;%enemyNation%&quot;, attackerNation));</span>

<span class="nc" id="L3929">		csSinkShip(ship, attackerPlayer, cs);</span>
<span class="nc" id="L3930">	}</span>

	/**
	 * Sinks this ship as result of a bombard.
	 *
	 * @param settlement
	 *            The bombarding &lt;code&gt;Settlement&lt;/code&gt;.
	 * @param ship
	 *            The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csSinkShipBombard(Settlement settlement, Unit ship, ChangeSet cs) {
<span class="nc" id="L3943">		ServerPlayer attackerPlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L3944">		ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3945">		StringTemplate shipNation = ship.getApparentOwnerName();</span>

<span class="nc" id="L3947">		cs.addMessage(See.only(attackerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipSunkByBombardment&quot;, settlement)
<span class="nc" id="L3949">						.addName(&quot;%colony%&quot;, settlement.getName()).addStringTemplate(&quot;%unit%&quot;, ship.getLabel())</span>
<span class="nc" id="L3950">						.addStringTemplate(&quot;%nation%&quot;, shipNation));</span>
<span class="nc" id="L3951">		cs.addMessage(See.only(shipPlayer),</span>
<span class="nc" id="L3952">				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, &quot;combat.shipSunkByBombardment&quot;, ship.getTile())</span>
<span class="nc" id="L3953">						.addName(&quot;%colony%&quot;, settlement.getName()).addStringTemplate(&quot;%unit%&quot;, ship.getLabel()));</span>

<span class="nc" id="L3955">		csSinkShip(ship, attackerPlayer, cs);</span>
<span class="nc" id="L3956">	}</span>

	/**
	 * Sink the ship.
	 *
	 * @param ship
	 *            The naval &lt;code&gt;Unit&lt;/code&gt; to sink.
	 * @param attackerPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that attacked, or null
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csSinkShip(Unit ship, ServerPlayer attackerPlayer, ChangeSet cs) {
<span class="nc" id="L3969">		ServerPlayer shipPlayer = (ServerPlayer) ship.getOwner();</span>
<span class="nc" id="L3970">		cs.addRemove(See.perhaps().always(shipPlayer), ship.getLocation(), ship);// -vis(shipPlayer)</span>
<span class="nc" id="L3971">		ship.dispose();</span>
<span class="nc" id="L3972">		shipPlayer.invalidateCanSeeTiles();// +vis(shipPlayer)</span>
<span class="nc bnc" id="L3973" title="All 2 branches missed.">		if (attackerPlayer != null) {</span>
<span class="nc" id="L3974">			cs.addAttribute(See.only(attackerPlayer), &quot;sound&quot;, &quot;sound.event.shipSunk&quot;);</span>
		}
<span class="nc" id="L3976">	}</span>

	/**
	 * Slaughter a unit.
	 *
	 * @param winner
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is slaughtering.
	 * @param loser
	 *            The &lt;code&gt;Unit&lt;/code&gt; to slaughter.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csSlaughterUnit(Unit winner, Unit loser, ChangeSet cs) {
<span class="fc" id="L3989">		ServerPlayer winnerPlayer = (ServerPlayer) winner.getOwner();</span>
<span class="fc" id="L3990">		StringTemplate winnerNation = winner.getApparentOwnerName();</span>
<span class="pc bpc" id="L3991" title="1 of 2 branches missed.">		Location winnerLoc = (winner.isInColony()) ? winner.getColony() : winner.getLocation();</span>
<span class="fc" id="L3992">		StringTemplate winnerLocation = winnerLoc.getLocationLabelFor(winnerPlayer);</span>
<span class="fc" id="L3993">		ServerPlayer loserPlayer = (ServerPlayer) loser.getOwner();</span>
<span class="fc" id="L3994">		StringTemplate loserNation = loser.getApparentOwnerName();</span>
<span class="fc bfc" id="L3995" title="All 2 branches covered.">		Location loserLoc = (loser.isInColony()) ? loser.getColony() : loser.getLocation();</span>
<span class="fc" id="L3996">		StringTemplate loserLocation = loserLoc.getLocationLabelFor(loserPlayer);</span>
<span class="fc" id="L3997">		String messageId = &quot;combat.unitSlaughtered&quot; + loser.getType().getSuffix();</span>

<span class="fc" id="L3999">		cs.addMessage(See.only(winnerPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitSlaughtered&quot;, winner)
<span class="fc" id="L4001">						.addStringTemplate(&quot;%nation%&quot;, loserNation).addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L4002">						.addStringTemplate(&quot;%enemyNation%&quot;, winnerPlayer.getNationLabel())</span>
<span class="fc" id="L4003">						.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L4004">						.addStringTemplate(&quot;%location%&quot;, winnerLocation));</span>
<span class="fc" id="L4005">		cs.addMessage(See.only(loserPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.COMBAT_RESULT, messageId, &quot;combat.unitSlaughtered&quot;,
<span class="fc" id="L4007">						loser.getTile()).addStringTemplate(&quot;%nation%&quot;, loserPlayer.getNationLabel())</span>
<span class="fc" id="L4008">								.addStringTemplate(&quot;%unit%&quot;, loser.getLabel())</span>
<span class="fc" id="L4009">								.addStringTemplate(&quot;%enemyNation%&quot;, winnerNation)</span>
<span class="fc" id="L4010">								.addStringTemplate(&quot;%enemyUnit%&quot;, winner.getLabel())</span>
<span class="fc" id="L4011">								.addStringTemplate(&quot;%location%&quot;, loserLocation));</span>
<span class="pc bpc" id="L4012" title="1 of 4 branches missed.">		if (loserPlayer.isIndian() &amp;&amp; loserPlayer.checkForDeath() == IS_DEAD) {</span>
<span class="nc" id="L4013">			StringTemplate nativeNation = loserPlayer.getNationLabel();</span>
<span class="nc" id="L4014">			cs.addGlobalHistory(getGame(),</span>
<span class="nc" id="L4015">					new HistoryEvent(getGame().getTurn(), HistoryEvent.HistoryEventType.DESTROY_NATION, winnerPlayer)</span>
<span class="nc" id="L4016">							.addStringTemplate(&quot;%nation%&quot;, winnerNation).addStringTemplate(&quot;%nativeNation%&quot;,</span>
									nativeNation));
		}

		// Destroy unit. Note See.only visibility used to handle the
		// case that the unit is the last at a settlement. If
		// See.perhaps was used there, the settlement will be gone
		// when perhaps() is processed, which would erroneously make
		// the unit visible.
<span class="fc bfc" id="L4025" title="All 2 branches covered.">		cs.addRemove((loserLoc.getSettlement() != null) ? See.only(loserPlayer) : See.perhaps().always(loserPlayer),</span>
				loserLoc, loser);// -vis(loserPlayer)
<span class="fc" id="L4027">		loser.dispose();</span>
<span class="fc" id="L4028">		loserPlayer.invalidateCanSeeTiles();// +vis(loserPlayer)</span>
<span class="fc" id="L4029">	}</span>

	/**
	 * Updates the player view for each new tile on a supplied list, and update
	 * a ChangeSet as well.
	 *
	 * @param newTiles
	 *            A list of &lt;code&gt;Tile&lt;/code&gt;s to update.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csSeeNewTiles(Collection&lt;? extends Tile&gt; newTiles, ChangeSet cs) {
<span class="fc" id="L4041">		exploreTiles(newTiles);</span>
<span class="fc" id="L4042">		cs.add(See.only(this), newTiles);</span>
<span class="fc" id="L4043">	}</span>

	/**
	 * Make a tea party modifier for the current turn.
	 *
	 * Public for the test suite.
	 *
	 * @return A tea party &lt;code&gt;Modifier&lt;/code&gt;.
	 */
	public Modifier makeTeaPartyModifier() {
<span class="fc" id="L4053">		final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L4054">		final Turn turn = getGame().getTurn();</span>
<span class="pc bpc" id="L4055" title="1 of 2 branches missed.">		for (Modifier modifier : spec.getModifiers(Modifier.COLONY_GOODS_PARTY)) {</span>
<span class="fc" id="L4056">			Modifier m = Modifier.makeTimedModifier(&quot;model.goods.bells&quot;, modifier, turn);</span>
<span class="fc" id="L4057">			m.setModifierIndex(Modifier.PARTY_PRODUCTION_INDEX);</span>
<span class="fc" id="L4058">			return m;</span>
		}
<span class="nc" id="L4060">		return null;</span>
	}

	/**
	 * Raises the players tax rate, or handles a goods party.
	 *
	 * @param tax
	 *            The new tax rate.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to use in a goods party.
	 * @param accepted
	 *            Whether the tax raise was accepted.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csRaiseTax(int tax, Goods goods, boolean accepted, ChangeSet cs) {
<span class="nc" id="L4076">		GoodsType goodsType = goods.getType();</span>
<span class="nc" id="L4077">		Colony colony = (Colony) goods.getLocation();</span>
<span class="nc" id="L4078">		int amount = Math.min(goods.getAmount(), GoodsContainer.CARGO_SIZE);</span>
<span class="nc" id="L4079">		String monarchKey = getMonarchKey();</span>

<span class="nc bnc" id="L4081" title="All 2 branches missed.">		if (accepted) {</span>
<span class="nc" id="L4082">			csSetTax(tax, cs);</span>
<span class="nc" id="L4083">			logger.info(&quot;Accepted tax raise to: &quot; + tax);</span>
<span class="nc bnc" id="L4084" title="All 2 branches missed.">		} else if (colony.getGoodsCount(goodsType) &lt; amount) {</span>
			// Player has removed the goods from the colony,
			// so raise the tax anyway.
<span class="nc" id="L4087">			final int extraTax = 3; // FIXME, magic number</span>
<span class="nc" id="L4088">			csSetTax(tax + extraTax, cs);</span>
<span class="nc" id="L4089">			cs.add(See.only(this), ChangePriority.CHANGE_NORMAL,</span>
					new MonarchActionMessage(Monarch.MonarchAction.FORCE_TAX,
<span class="nc" id="L4091">							StringTemplate.template(Monarch.MonarchAction.FORCE_TAX.getTextKey()).addAmount(&quot;%amount%&quot;,</span>
<span class="nc" id="L4092">									tax + extraTax),</span>
							monarchKey));
<span class="nc" id="L4094">			logger.info(&quot;Forced tax raise to: &quot; + (tax + extraTax));</span>
<span class="nc" id="L4095">		} else { // Tea party</span>
<span class="nc" id="L4096">			Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L4097">			colony.getGoodsContainer().saveState();</span>
<span class="nc" id="L4098">			colony.removeGoods(goodsType, amount);</span>

<span class="nc" id="L4100">			int arrears = market.getPaidForSale(goodsType) * spec.getInteger(GameOptions.ARREARS_FACTOR);</span>
<span class="nc" id="L4101">			Market market = getMarket();</span>
<span class="nc" id="L4102">			market.setArrears(goodsType, arrears);</span>

<span class="nc" id="L4104">			Modifier tpm = makeTeaPartyModifier();</span>
<span class="nc" id="L4105">			cs.addFeatureChange(this, colony, tpm, true);</span>
<span class="nc" id="L4106">			cs.add(See.only(this), colony.getGoodsContainer());</span>
<span class="nc" id="L4107">			cs.add(See.only(this), market.getMarketData(goodsType));</span>

<span class="nc" id="L4109">			String messageId = &quot;model.player.colonyGoodsParty.&quot; + goodsType.getSuffix();</span>
<span class="nc bnc" id="L4110" title="All 2 branches missed.">			if (!Messages.containsKey(messageId)) {</span>
<span class="nc bnc" id="L4111" title="All 2 branches missed.">				messageId = (colony.isLandLocked()) ? &quot;model.player.colonyGoodsParty.landLocked&quot;</span>
						: &quot;model.player.colonyGoodsParty.harbour&quot;;
			}
<span class="nc" id="L4114">			cs.addMessage(See.only(this),</span>
					new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, messageId, this)
<span class="nc" id="L4116">							.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%amount%&quot;, amount).addNamed(&quot;%goods%&quot;,</span>
									goodsType));
<span class="nc" id="L4118">			cs.addAttribute(See.only(this), &quot;flush&quot;, Boolean.TRUE.toString());</span>
<span class="nc" id="L4119">			logger.info(&quot;Goods party at &quot; + colony.getName() + &quot; with: &quot; + goods + &quot; arrears: &quot; + arrears);</span>
<span class="nc bnc" id="L4120" title="All 2 branches missed.">			if (isAI()) { // Reset the goods wishes</span>
<span class="nc" id="L4121">				colony.firePropertyChange(Colony.REARRANGE_WORKERS, goodsType, null);</span>
			}
		}
<span class="nc" id="L4124">	}</span>

	/**
	 * Handle the end of a session where the player has ignored a tax increase
	 * demand.
	 *
	 * @param tax
	 *            The new tax rate.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to use in a goods party.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void ignoreTax(int tax, Goods goods, ChangeSet cs) {
<span class="nc" id="L4138">		csRaiseTax(tax, goods, true, cs);</span>
<span class="nc" id="L4139">		cs.addMessage(See.only(this), new ModelMessage(&quot;model.player.ignoredTax&quot;, this).addAmount(&quot;%amount%&quot;, tax));</span>
<span class="nc" id="L4140">	}</span>

	/**
	 * Handle the end of a session where the player has ignored an offer of
	 * mercenaries.
	 *
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void ignoreMercenaries(ChangeSet cs) {
<span class="nc" id="L4150">		cs.addMessage(See.only(this), new ModelMessage(&quot;model.player.ignoredMercenaries&quot;, this));</span>
<span class="nc" id="L4151">	}</span>

	/**
	 * Set the player tax rate. If this requires a change to the bells bonuses,
	 * we have to update the whole player (bah) because we can not yet
	 * independently update the feature container.
	 *
	 * @param tax
	 *            The new tax rate.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csSetTax(int tax, ChangeSet cs) {
<span class="nc" id="L4164">		setTax(tax);</span>
<span class="nc bnc" id="L4165" title="All 2 branches missed.">		if (recalculateBellsBonus()) {</span>
<span class="nc" id="L4166">			cs.add(See.only(this), this);</span>
		} else {
<span class="nc" id="L4168">			cs.addPartial(See.only(this), this, &quot;tax&quot;);</span>
		}
<span class="nc" id="L4170">	}</span>

	/**
	 * Adds mercenaries that the player has accepted.
	 *
	 * @param mercs
	 *            A list of mercenaries.
	 * @param price
	 *            The price to be charged for them.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csAddMercenaries(List&lt;AbstractUnit&gt; mercs, int price, ChangeSet cs) {
<span class="nc bnc" id="L4183" title="All 2 branches missed.">		if (checkGold(price)) {</span>
<span class="nc" id="L4184">			createUnits(mercs, getEurope());// -vis: safe, Europe</span>
<span class="nc" id="L4185">			cs.add(See.only(this), getEurope());</span>
<span class="nc" id="L4186">			modifyGold(-price);</span>
<span class="nc" id="L4187">			cs.addPartial(See.only(this), this, &quot;gold&quot;);</span>
		} else {
<span class="nc" id="L4189">			getMonarch().setDispleasure(true);</span>
<span class="nc" id="L4190">			cs.add(See.only(this), ChangePriority.CHANGE_NORMAL,</span>
					new MonarchActionMessage(Monarch.MonarchAction.DISPLEASURE,
<span class="nc" id="L4192">							StringTemplate.template(Monarch.MonarchAction.DISPLEASURE.getTextKey()), getMonarchKey()));</span>
		}
<span class="nc" id="L4194">	}</span>

	/**
	 * Make contact between two nations if necessary.
	 *
	 * @param other
	 *            The other &lt;code&gt;ServerPlayer&lt;/code&gt;.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @return True if this was a first contact.
	 */
	public boolean csContact(ServerPlayer other, ChangeSet cs) {
<span class="fc bfc" id="L4206" title="All 2 branches covered.">		if (hasContacted(other))</span>
<span class="fc" id="L4207">			return false;</span>

		// Must be a first contact!
<span class="fc" id="L4210">		final Game game = getGame();</span>
<span class="fc" id="L4211">		Turn turn = game.getTurn();</span>
<span class="fc bfc" id="L4212" title="All 2 branches covered.">		if (isIndian()) {</span>
<span class="pc bpc" id="L4213" title="1 of 2 branches missed.">			if (other.isIndian()) {</span>
<span class="nc" id="L4214">				return false; // Ignore native-to-native contacts.</span>
			} else {
<span class="fc" id="L4216">				cs.addHistory(other, new HistoryEvent(turn, HistoryEvent.HistoryEventType.MEET_NATION, other)</span>
<span class="fc" id="L4217">						.addStringTemplate(&quot;%nation%&quot;, getNationLabel()));</span>
			}
		} else { // (serverPlayer.isEuropean)
<span class="fc" id="L4220">			cs.addHistory(this, new HistoryEvent(turn, HistoryEvent.HistoryEventType.MEET_NATION, other)</span>
<span class="fc" id="L4221">					.addStringTemplate(&quot;%nation%&quot;, other.getNationLabel()));</span>
		}

<span class="fc" id="L4224">		logger.finest(&quot;First contact between &quot; + this.getId() + &quot; and &quot; + other.getId());</span>
<span class="fc" id="L4225">		return true;</span>
	}

	/**
	 * Initiate first contact between this European and native player.
	 *
	 * @param other
	 *            The native &lt;code&gt;ServerPlayer&lt;/code&gt;.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; contact is made at if this is a first
	 *            landing in the new world and it is owned by the other player.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csNativeFirstContact(ServerPlayer other, Tile tile, ChangeSet cs) {
<span class="fc" id="L4240">		cs.add(See.only(this), ChangePriority.CHANGE_EARLY, new FirstContactMessage(this, other, tile));</span>
<span class="fc" id="L4241">		csChangeStance(Stance.PEACE, other, true, cs);</span>
<span class="fc bfc" id="L4242" title="All 2 branches covered.">		if (tile != null) {</span>
			// Establish a diplomacy session so that if the player
			// accepts the tile offer, we can verify that the offer
			// was made.
<span class="fc" id="L4246">			new DiplomacySession(tile.getFirstUnit(), tile.getOwningSettlement());</span>
		}
<span class="fc" id="L4248">	}</span>

	/**
	 * Initiate first contact between this European and another European player.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; making contact.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; being contacted.
	 * @param otherUnit
	 *            The &lt;code&gt;Unit&lt;/code&gt; being contacted.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csEuropeanFirstContact(Unit unit, Settlement settlement, Unit otherUnit, ChangeSet cs) {
<span class="nc" id="L4263">		final Game game = getGame();</span>

		ServerPlayer other;
<span class="nc bnc" id="L4266" title="All 2 branches missed.">		if (settlement != null) {</span>
<span class="nc" id="L4267">			other = (ServerPlayer) settlement.getOwner();</span>
<span class="nc bnc" id="L4268" title="All 2 branches missed.">		} else if (otherUnit != null) {</span>
<span class="nc" id="L4269">			other = (ServerPlayer) otherUnit.getOwner();</span>
		} else {
<span class="nc" id="L4271">			throw new IllegalArgumentException(&quot;Non-null settlement or &quot; + &quot;otherUnit required.&quot;);</span>
		}

<span class="nc" id="L4274">		DiplomaticTrade agreement = new DiplomaticTrade(game, DiplomaticTrade.TradeContext.CONTACT, this, other, null,</span>
				0);
<span class="nc" id="L4276">		agreement.add(new StanceTradeItem(game, this, other, Stance.PEACE));</span>
<span class="nc bnc" id="L4277" title="All 2 branches missed.">		DiplomacySession session = (settlement == null) ? new DiplomacySession(unit, otherUnit)</span>
				: new DiplomacySession(unit, settlement);
<span class="nc" id="L4279">		session.setAgreement(agreement);</span>
<span class="nc bnc" id="L4280" title="All 2 branches missed.">		cs.add(See.only(this), ChangePriority.CHANGE_LATE, (settlement == null)</span>
				? new DiplomacyMessage(unit, otherUnit, agreement) : new DiplomacyMessage(unit, settlement, agreement));
<span class="nc" id="L4282">	}</span>

	/**
	 * Change the owner of a unit or dispose of it if the change is impossible.
	 * Move the unit to a new location if necessary. Also handle disappearance
	 * of any carried units that will now be invisible to the new owner.
	 *
	 * -vis(owner,newOwner)
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to change ownership of.
	 * @param newOwner
	 *            The new owning &lt;code&gt;ServerPlayer&lt;/code&gt;.
	 * @param change
	 *            An optional accompanying &lt;code&gt;ChangeType&lt;/code&gt;.
	 * @param loc
	 *            A optional new &lt;code&gt;Location&lt;/code&gt; for the unit.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @return True if the new owner can have this unit.
	 */
	public boolean csChangeOwner(Unit unit, ServerPlayer newOwner, ChangeType change, Location loc, ChangeSet cs) {
<span class="fc bfc" id="L4304" title="All 2 branches covered.">		if (newOwner == this)</span>
<span class="fc" id="L4305">			return true; // No transfer needed</span>

<span class="fc" id="L4307">		final Tile oldTile = unit.getTile();</span>
<span class="fc" id="L4308">		UnitType mainType = unit.getTypeChange(change, newOwner);</span>
<span class="fc bfc" id="L4309" title="All 2 branches covered.">		if (mainType == null)</span>
<span class="fc" id="L4310">			mainType = unit.getType(); // No change needed.</span>
<span class="pc bpc" id="L4311" title="1 of 2 branches missed.">		if (!mainType.isAvailableTo(newOwner)) { // Can not have this unit.</span>
<span class="nc" id="L4312">			cs.addRemove(See.perhaps().always(this), oldTile, unit);</span>
<span class="nc" id="L4313">			unit.dispose();</span>
<span class="nc" id="L4314">			return false;</span>
		}

<span class="pc bpc" id="L4317" title="1 of 2 branches missed.">		for (Unit u : unit.getUnitList()) {</span>
<span class="nc" id="L4318">			UnitType type = u.getTypeChange(change, newOwner);</span>
<span class="nc bnc" id="L4319" title="All 2 branches missed.">			if (type == null)</span>
<span class="nc" id="L4320">				type = u.getType();</span>
<span class="nc bnc" id="L4321" title="All 2 branches missed.">			if (!type.isAvailableTo(newOwner)) {</span>
<span class="nc" id="L4322">				cs.addRemove(See.only(this), unit, u);</span>
<span class="nc" id="L4323">				u.dispose();</span>
			} else {
<span class="nc bnc" id="L4325" title="All 2 branches missed.">				if (!u.changeType(type)) {</span>
<span class="nc" id="L4326">					throw new IllegalStateException(&quot;Type change failure: &quot; + u + &quot; -&gt; &quot; + type);</span>
				}
			}
<span class="nc" id="L4329">		}</span>
<span class="pc bpc" id="L4330" title="1 of 4 branches missed.">		if (mainType != unit.getType() &amp;&amp; !unit.changeType(mainType)) {</span>
<span class="nc" id="L4331">			throw new IllegalStateException(&quot;Type change failure: &quot; + unit + &quot; -&gt; &quot; + mainType);</span>
		}
<span class="fc" id="L4333">		unit.changeOwner(newOwner);</span>
<span class="fc bfc" id="L4334" title="All 2 branches covered.">		if (loc != null)</span>
<span class="fc" id="L4335">			unit.setLocation(loc);</span>
<span class="pc bpc" id="L4336" title="1 of 2 branches missed.">		if (unit.isCarrier()) {</span>
<span class="nc" id="L4337">			cs.addRemoves(See.only(this), unit, unit.getUnitList());</span>
		}
<span class="fc" id="L4339">		cs.add(See.only(newOwner), newOwner.exploreForUnit(unit));</span>
<span class="fc" id="L4340">		return true;</span>
	}

	// Serialization

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String toString() {
<span class="fc" id="L4350">		StringBuilder sb = new StringBuilder(64);</span>
<span class="fc" id="L4351">		sb.append(&quot;[ServerPlayer &quot;).append(getId()).append(&quot; &quot;).append(getName()).append(&quot; &quot;).append(connection)</span>
<span class="fc" id="L4352">				.append(&quot;]&quot;);</span>
<span class="fc" id="L4353">		return sb.toString();</span>
	}

	/**
	 * Gets the tag name of the root element representing this object.
	 *
	 * @return &quot;serverPlayer&quot;
	 */
	@Override
	public String getServerXMLElementTagName() {
<span class="fc" id="L4363">		return &quot;serverPlayer&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>