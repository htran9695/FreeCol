<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerUnit.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.model</a> &gt; <span class="el_source">ServerUnit.java</span></div><h1>ServerUnit.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.model;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;
import java.util.Random;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.i18n.NameCache;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.CombatModel;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighSeas;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.LostCityRumour;
import net.sf.freecol.common.model.LostCityRumour.RumourType;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.Region;
import net.sf.freecol.common.model.Resource;
import net.sf.freecol.common.model.ResourceType;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovement;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TileType;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.networking.NewLandNameMessage;
import net.sf.freecol.common.networking.NewRegionNameMessage;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.server.control.ChangeSet;
import net.sf.freecol.server.control.ChangeSet.ChangePriority;
import net.sf.freecol.server.control.ChangeSet.See;

/**
 * Server version of a unit.
 */
public class ServerUnit extends Unit implements ServerModelObject {

	/** The Constant logger. */
<span class="fc" id="L85">	private static final Logger logger = Logger.getLogger(ServerUnit.class.getName());</span>

	/**
	 * Trivial constructor required for all ServerModelObjects.
	 *
	 * @param game
	 *            the game
	 * @param id
	 *            the id
	 */
	public ServerUnit(Game game, String id) {
<span class="fc" id="L96">		super(game, id);</span>
<span class="fc" id="L97">	}</span>

	/**
	 * Creates a new ServerUnit.
	 *
	 * -vis: Visibility issues depending on location. -til: Changes appearance
	 * if unit goes into a colony.
	 *
	 * @param game
	 *            The &lt;code&gt;Game&lt;/code&gt; in which this unit belongs.
	 * @param location
	 *            The &lt;code&gt;Location&lt;/code&gt; to place this at.
	 * @param owner
	 *            The &lt;code&gt;Player&lt;/code&gt; owning this unit.
	 * @param type
	 *            The type of the unit.
	 */
	public ServerUnit(Game game, Location location, Player owner, UnitType type) {
<span class="fc" id="L115">		this(game, location, owner, type, type.getDefaultRole());</span>
<span class="fc" id="L116">	}</span>

	/**
	 * Create a new ServerUnit from a template.
	 *
	 * Note all FCGOTs are looked up in the specification by id, allowing the
	 * template to derive from a different specification as might happen when
	 * loading a scenario map.
	 *
	 * -vis: Visibility issues depending on location. -til: Changes appearance
	 * if unit goes into a colony.
	 *
	 * @param game
	 *            The &lt;code&gt;Game&lt;/code&gt; in which this unit belongs.
	 * @param location
	 *            The &lt;code&gt;Location&lt;/code&gt; to place this at.
	 * @param template
	 *            A &lt;code&gt;Unit&lt;/code&gt; to copy from.
	 */
	public ServerUnit(Game game, Location location, Unit template) {
<span class="nc" id="L136">		this(game, location, game.getPlayerByNationId(template.getOwner().getNationId()),</span>
<span class="nc" id="L137">				game.getSpecification().getUnitType(template.getType().getId()),</span>
<span class="nc" id="L138">				game.getSpecification().getDefaultRole());</span>

<span class="nc" id="L140">		final Specification spec = getSpecification();</span>
<span class="nc" id="L141">		setNationality(template.getNationality());</span>
<span class="nc" id="L142">		setEthnicity(template.getEthnicity());</span>
<span class="nc" id="L143">		workLeft = template.getWorkLeft();</span>
<span class="nc" id="L144">		workType = spec.getGoodsType(template.getWorkType().getId());</span>
<span class="nc" id="L145">		movesLeft = template.getMovesLeft();</span>
<span class="nc" id="L146">		hitPoints = template.getType().getHitPoints();</span>
<span class="nc" id="L147">		changeRole(spec.getRole(template.getRole().getId()), template.getRoleCount());</span>
<span class="nc" id="L148">		setStateUnchecked(template.getState());</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">		if (getType().canCarryGoods()) {</span>
<span class="nc" id="L150">			setGoodsContainer(new GoodsContainer(game, this));</span>
		}
<span class="nc" id="L152">		this.visibleGoodsCount = -1;</span>
<span class="nc" id="L153">	}</span>

	/**
	 * Creates a new ServerUnit.
	 *
	 * -vis: Visibility issues depending on location. -til: Changes appearance
	 * if unit goes into a colony.
	 *
	 * @param game
	 *            The &lt;code&gt;Game&lt;/code&gt; in which this unit belongs.
	 * @param location
	 *            The &lt;code&gt;Location&lt;/code&gt; to place this at.
	 * @param owner
	 *            The &lt;code&gt;Player&lt;/code&gt; owning this unit.
	 * @param type
	 *            The type of the unit.
	 * @param role
	 *            The role of the unit.
	 */
	public ServerUnit(Game game, Location location, Player owner, UnitType type, Role role) {
<span class="fc" id="L173">		super(game);</span>

<span class="fc" id="L175">		UnitType newType = type.getTargetType(ChangeType.CREATION, owner);</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">		this.unitType = (newType == null) ? type : newType;</span>
<span class="fc" id="L177">		this.owner = owner;</span>
<span class="fc" id="L178">		this.state = UnitState.ACTIVE; // placeholder</span>
<span class="fc" id="L179">		this.role = getSpecification().getDefaultRole(); // placeholder</span>
<span class="fc" id="L180">		this.location = null;</span>
<span class="fc" id="L181">		this.entryLocation = null;</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">		if (unitType.hasAbility(Ability.PERSON)) {</span>
<span class="fc" id="L183">			this.nationality = owner.getNationId();</span>
<span class="fc" id="L184">			this.ethnicity = nationality;</span>
		} else {
<span class="fc" id="L186">			this.nationality = null;</span>
<span class="fc" id="L187">			this.ethnicity = null;</span>
		}

<span class="fc" id="L190">		this.workLeft = -1;</span>
<span class="fc" id="L191">		this.workType = null;</span>
<span class="fc" id="L192">		this.movesLeft = getInitialMovesLeft();</span>
<span class="fc" id="L193">		this.hitPoints = unitType.getHitPoints();</span>
<span class="fc" id="L194">		this.experienceType = null;</span>
<span class="fc" id="L195">		this.experience = 0;</span>
<span class="fc" id="L196">		this.workImprovement = null;</span>
<span class="fc" id="L197">		this.student = this.teacher = null;</span>
<span class="fc" id="L198">		this.turnsOfTraining = 0;</span>
<span class="fc" id="L199">		this.indianSettlement = null;</span>
<span class="fc" id="L200">		this.hitPoints = unitType.getHitPoints();</span>
<span class="fc" id="L201">		this.destination = null;</span>
<span class="fc" id="L202">		this.tradeRoute = null;</span>
<span class="fc" id="L203">		this.currentStop = -1;</span>
<span class="fc" id="L204">		this.treasureAmount = 0;</span>
<span class="fc" id="L205">		this.attrition = 0;</span>
<span class="fc" id="L206">		this.visibleGoodsCount = -1;</span>

		// Fix up role, state and location now other values are present.
<span class="fc" id="L209">		changeRole(role, role.getMaximumCount());</span>
<span class="fc" id="L210">		setStateUnchecked(state);</span>
<span class="fc" id="L211">		setLocation(location);// -vis(owner),-til</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">		if (getType().canCarryGoods()) {</span>
<span class="fc" id="L213">			setGoodsContainer(new GoodsContainer(game, this));</span>
		}

<span class="fc" id="L216">		owner.addUnit(this);</span>
<span class="fc" id="L217">	}</span>

	/**
	 * New turn for this unit.
	 *
	 * @param random
	 *            A &lt;code&gt;Random&lt;/code&gt; number source.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	@Override
	public void csNewTurn(Random random, LogBuilder lb, ChangeSet cs) {
<span class="fc" id="L231">		lb.add(this);</span>
<span class="fc" id="L232">		ServerPlayer owner = (ServerPlayer) getOwner();</span>
<span class="fc" id="L233">		Specification spec = getSpecification();</span>
<span class="fc" id="L234">		Location loc = getLocation();</span>
<span class="fc" id="L235">		boolean locDirty = false;</span>
<span class="fc" id="L236">		boolean unitDirty = false;</span>

		// Attrition. Do it first as the unit might die.
<span class="fc bfc" id="L239" title="All 4 branches covered.">		if (loc instanceof Tile &amp;&amp; !((Tile) loc).hasSettlement()) {</span>
<span class="fc" id="L240">			int attrition = getAttrition() + 1;</span>
<span class="fc" id="L241">			setAttrition(attrition);</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">			if (attrition &gt; getType().getMaximumAttrition()) {</span>
<span class="nc" id="L243">				cs.addMessage(See.only(owner),</span>
						new ModelMessage(ModelMessage.MessageType.UNIT_LOST, &quot;model.unit.attrition&quot;, this)
<span class="nc" id="L245">								.addStringTemplate(&quot;%unit%&quot;, getLabel()).addStringTemplate(&quot;%location%&quot;,</span>
<span class="nc" id="L246">										loc.getLocationLabelFor(owner)));</span>
<span class="nc" id="L247">				cs.add(See.perhaps(), (Tile) loc);</span>
<span class="nc" id="L248">				cs.addRemove(See.perhaps().always(owner), loc, this);// -vis(owner)</span>
<span class="nc" id="L249">				this.dispose();</span>
<span class="nc" id="L250">				owner.invalidateCanSeeTiles();// +vis(owner)</span>
<span class="nc" id="L251">				lb.add(&quot;, &quot;);</span>
<span class="nc" id="L252">				return;</span>
			}
<span class="fc" id="L254">		} else {</span>
<span class="fc" id="L255">			setAttrition(0);</span>
		}

		// Check for experience-promotion.
		GoodsType produce;
		UnitType learn;
<span class="pc bpc" id="L261" title="1 of 6 branches missed.">		if (isInColony() &amp;&amp; (produce = getWorkType()) != null &amp;&amp; (learn = spec.getExpertForProducing(produce)) != null</span>
<span class="fc bfc" id="L262" title="All 4 branches covered.">				&amp;&amp; learn != getType() &amp;&amp; getType().canBeUpgraded(learn, ChangeType.EXPERIENCE)) {</span>
<span class="fc" id="L263">			int maximumExperience = getType().getMaximumExperience();</span>
<span class="fc" id="L264">			int maxValue = (100 * maximumExperience)</span>
<span class="fc" id="L265">					/ getType().getUnitTypeChange(learn).getProbability(ChangeType.EXPERIENCE);</span>
<span class="pc bpc" id="L266" title="1 of 4 branches missed.">			if (maxValue &gt; 0 &amp;&amp; randomInt(logger, &quot;Experience&quot;, random, maxValue) &lt; Math.min(getExperience(),</span>
					maximumExperience)) {
<span class="fc" id="L268">				StringTemplate oldName = getLabel();</span>
<span class="fc" id="L269">				changeType(learn);// -vis: safe within colony</span>
<span class="fc" id="L270">				cs.addMessage(See.only(owner),</span>
<span class="fc" id="L271">						new ModelMessage(ModelMessage.MessageType.UNIT_IMPROVED, &quot;model.unit.experience&quot;, getColony(),</span>
<span class="fc" id="L272">								this).addStringTemplate(&quot;%oldName%&quot;, oldName).addStringTemplate(&quot;%unit%&quot;, getLabel())</span>
<span class="fc" id="L273">										.addName(&quot;%colony%&quot;, getColony().getName()));</span>
<span class="fc" id="L274">				lb.add(&quot; experience upgrade to &quot;, getType());</span>
<span class="fc" id="L275">				unitDirty = true;</span>
			}
		}

		// Update moves left.
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">		if (isInMission()) {</span>
<span class="nc" id="L281">			getTile().updateIndianSettlement(owner);</span>
<span class="nc" id="L282">			setMovesLeft(0);</span>
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">		} else if (isDamaged()) {</span>
<span class="nc" id="L284">			setMovesLeft(0);</span>
		} else {
<span class="fc" id="L286">			setMovesLeft(getInitialMovesLeft());</span>
		}

<span class="fc bfc" id="L289" title="All 2 branches covered.">		if (getWorkLeft() &gt; 0) {</span>
<span class="fc" id="L290">			unitDirty = true;</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">			switch (getState()) {</span>
			case IMPROVING:
				// Has the improvement been completed already? Do nothing.
<span class="fc" id="L294">				TileImprovement ti = getWorkImprovement();</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">				if (ti == null // Another unit on the tile completed it first</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">						|| ti.isComplete()) {</span>
<span class="nc" id="L297">					setState(UnitState.ACTIVE);</span>
<span class="nc" id="L298">					setWorkLeft(-1);</span>
				} else {
					// Otherwise do work
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">					int amount = (getType().hasAbility(Ability.EXPERT_PIONEER)) ? 2 : 1;</span>
<span class="fc" id="L302">					int turns = ti.getTurnsToComplete();</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">					if ((turns -= amount) &lt; 0)</span>
<span class="fc" id="L304">						turns = 0;</span>
<span class="fc" id="L305">					ti.setTurnsToComplete(turns);</span>
<span class="fc" id="L306">					setWorkLeft(turns);</span>
<span class="fc bfc" id="L307" title="All 4 branches covered.">					if (ti.isRoad() &amp;&amp; ti.isComplete()) {</span>
<span class="fc" id="L308">						ti.updateRoadConnections(true);</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">						for (Tile t : loc.getTile().getSurroundingTiles(1)) {</span>
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">							if (t.hasRoad())</span>
<span class="nc" id="L311">								cs.add(See.perhaps(), t);</span>
<span class="fc" id="L312">						}</span>
<span class="fc" id="L313">						locDirty = true;</span>
					}
				}
<span class="fc" id="L316">				break;</span>
			default:
<span class="nc" id="L318">				setWorkLeft(getWorkLeft() - 1);</span>
				break;
			}

<span class="pc bpc" id="L322" title="3 of 4 branches missed.">			if (loc instanceof HighSeas &amp;&amp; getOwner().isREF()) {</span>
				// Swift travel to America for the REF
<span class="nc" id="L324">				setWorkLeft(0);</span>
			}
		}

<span class="pc bpc" id="L328" title="1 of 2 branches missed.">		if (getState() == UnitState.SKIPPED) {</span>
<span class="nc" id="L329">			setState(UnitState.ACTIVE);</span>
<span class="nc" id="L330">			unitDirty = true;</span>
		}

<span class="fc bfc" id="L333" title="All 2 branches covered.">		if (getWorkLeft() &lt;= 0) {</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">			if (getLocation() instanceof HighSeas) {</span>
<span class="nc" id="L335">				final Europe europe = owner.getEurope();</span>
<span class="nc" id="L336">				final Location dst = getDestination();</span>
<span class="nc" id="L337">				Location result = resolveDestination();</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">				if (result == europe) {</span>
<span class="nc" id="L339">					lb.add(&quot; arrives in Europe&quot;);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">					if (getTradeRoute() == null) {</span>
<span class="nc" id="L341">						setDestination(null);</span>
<span class="nc" id="L342">						cs.addMessage(See.only(owner), new ModelMessage(ModelMessage.MessageType.DEFAULT,</span>
<span class="nc" id="L343">								&quot;model.unit.arriveInEurope&quot;, europe, this).addNamed(&quot;%europe%&quot;, europe));</span>
					}
<span class="nc" id="L345">					setState(UnitState.ACTIVE);</span>
<span class="nc" id="L346">					setLocation(europe);// -vis: safe/Europe</span>
<span class="nc" id="L347">					cs.add(See.only(owner), owner.getHighSeas());</span>
<span class="nc" id="L348">					locDirty = true;</span>
				} else {
<span class="nc bnc" id="L350" title="All 2 branches missed.">					if (!(result instanceof Tile)) {</span>
<span class="nc" id="L351">						logger.warning(&quot;Unit has unsupported destination: &quot; + dst + &quot; -&gt; &quot; + result);</span>
<span class="nc" id="L352">						result = getEntryLocation().getTile();</span>
					}
<span class="nc" id="L354">					Tile tile = result.getTile().getSafeTile(owner, random);</span>
<span class="nc" id="L355">					lb.add(&quot; arrives in America at &quot;, tile);</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">					if (dst != null) {</span>
<span class="nc" id="L357">						lb.add(&quot; sailing for &quot;, dst);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">						if (dst instanceof Map)</span>
<span class="nc" id="L359">							setDestination(null);</span>
					}
<span class="nc" id="L361">					csMove(tile, random, cs);</span>
<span class="nc" id="L362">					locDirty = unitDirty = false; // loc update present</span>
				}
<span class="nc" id="L364">			} else {</span>
<span class="pc bpc" id="L365" title="2 of 4 branches missed.">				switch (getState()) {</span>
				case ACTIVE:
				case FORTIFIED:
				case SENTRY:
				case IN_COLONY:
<span class="fc" id="L370">					break; // These states are stable</span>
				case IMPROVING:
<span class="fc" id="L372">					csImproveTile(random, cs);</span>
<span class="fc" id="L373">					setWorkImprovement(null);</span>
<span class="fc" id="L374">					locDirty = true;</span>
<span class="fc" id="L375">					break;</span>
				case FORTIFYING:
<span class="nc" id="L377">					setState(UnitState.FORTIFIED);</span>
<span class="nc" id="L378">					unitDirty = true;</span>
<span class="nc" id="L379">					break;</span>
				case SKIPPED:
				default:
<span class="nc" id="L382">					lb.add(&quot; work completed, bad state: &quot;, getState());</span>
<span class="nc" id="L383">					setState(UnitState.ACTIVE);</span>
<span class="nc" id="L384">					unitDirty = true;</span>
					break;
				}
			}
		}

<span class="fc bfc" id="L390" title="All 2 branches covered.">		if (locDirty) {</span>
<span class="fc" id="L391">			cs.add(See.perhaps(), (FreeColGameObject) getLocation());</span>
<span class="fc bfc" id="L392" title="All 2 branches covered.">		} else if (unitDirty) {</span>
<span class="fc" id="L393">			cs.add(See.perhaps(), this);</span>
		} else {
<span class="fc" id="L395">			cs.addPartial(See.only(owner), this, &quot;movesLeft&quot;);</span>
		}
<span class="fc" id="L397">		lb.add(&quot;, &quot;);</span>
<span class="fc" id="L398">	}</span>

	/**
	 * Completes a tile improvement.
	 *
	 * +til: Resolves the change of appearance.
	 *
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csImproveTile(Random random, ChangeSet cs) {
<span class="fc" id="L411">		Tile tile = getTile();</span>
<span class="fc" id="L412">		tile.cacheUnseen();// +til</span>
<span class="fc" id="L413">		AbstractGoods deliver = getWorkImprovement().getType().getProduction(tile.getType());</span>
<span class="fc bfc" id="L414" title="All 2 branches covered.">		if (deliver != null) { // Deliver goods if any</span>
<span class="fc" id="L415">			final Turn turn = getGame().getTurn();</span>
<span class="fc" id="L416">			int amount = deliver.getAmount();</span>
<span class="fc" id="L417">			amount = (int) this.applyModifiers(amount, turn, Modifier.TILE_TYPE_CHANGE_PRODUCTION, deliver.getType());</span>
<span class="fc" id="L418">			Settlement settlement = tile.getOwningSettlement();</span>
<span class="pc bpc" id="L419" title="1 of 4 branches missed.">			if (settlement != null &amp;&amp; owner.owns(settlement)) {</span>
<span class="fc" id="L420">				amount = (int) settlement.applyModifiers(amount, turn, Modifier.TILE_TYPE_CHANGE_PRODUCTION,</span>
<span class="fc" id="L421">						deliver.getType());</span>
<span class="fc" id="L422">				settlement.addGoods(deliver.getType(), amount);</span>
			}
		}

		// Finish up
<span class="fc" id="L427">		TileImprovement ti = getWorkImprovement();</span>
<span class="fc" id="L428">		TileType changeType = ti.getChange(tile.getType());</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">		if (changeType != null) {</span>
			// Changes like clearing a forest need to be completed,
			// whereas for changes like road building the improvement
			// is already added and now complete.
<span class="fc" id="L433">			tile.changeType(changeType);// -til</span>
		}

		// Does a resource get exposed?
<span class="fc" id="L437">		TileImprovementType tileImprovementType = ti.getType();</span>
<span class="fc" id="L438">		int exposeResource = tileImprovementType.getExposeResourcePercent();</span>
<span class="pc bpc" id="L439" title="1 of 4 branches missed.">		if (exposeResource &gt; 0 &amp;&amp; !tile.hasResource()) {</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">			if (randomInt(logger, &quot;Expose resource&quot;, random, 100) &lt; exposeResource) {</span>
<span class="fc" id="L441">				ResourceType resType = RandomChoice.getWeightedRandom(logger, &quot;Resource type&quot;,</span>
<span class="fc" id="L442">						tile.getType().getWeightedResources(), random);</span>
<span class="fc" id="L443">				int minValue = resType.getMinValue();</span>
<span class="fc" id="L444">				int maxValue = resType.getMaxValue();</span>
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">				int value = minValue + ((minValue == maxValue) ? 0</span>
<span class="pc" id="L446">						: randomInt(logger, &quot;Resource quantity&quot;, random, maxValue - minValue + 1));</span>
<span class="fc" id="L447">				tile.addResource(new Resource(getGame(), tile, resType, value));// -til</span>
			}
		}

		// Expend equipment.
<span class="fc bfc" id="L452" title="All 2 branches covered.">		if (changeRoleCount(-ti.getType().getExpendedAmount())) {</span>
			// FIXME: assumes tools, make more generic, use
			// ti.getType().getRequiredRole().getRequiredGoods()
<span class="fc" id="L455">			ServerPlayer owner = (ServerPlayer) getOwner();</span>
<span class="fc" id="L456">			StringTemplate locName = getLocation().getLocationLabelFor(owner);</span>
<span class="fc" id="L457">			String messageId = getType() + &quot;.noMoreTools&quot;;</span>
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">			if (!Messages.containsKey(messageId)) {</span>
<span class="nc" id="L459">				messageId = &quot;model.unit.noMoreTools&quot;;</span>
			}
<span class="fc" id="L461">			cs.addMessage(See.only(owner), new ModelMessage(ModelMessage.MessageType.WARNING, messageId, this)</span>
<span class="fc" id="L462">					.addStringTemplate(&quot;%unit%&quot;, getLabel()).addStringTemplate(&quot;%location%&quot;, locName));</span>
		}

		// Cancel other co-located improvements of the same type
<span class="fc bfc" id="L466" title="All 2 branches covered.">		for (Unit unit : tile.getUnitList()) {</span>
<span class="fc bfc" id="L467" title="All 4 branches covered.">			if (unit.getWorkImprovement() != null &amp;&amp; unit.getWorkImprovement().getType() == ti.getType()</span>
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">					&amp;&amp; unit.getState() == UnitState.IMPROVING) {</span>
<span class="fc" id="L469">				unit.setWorkLeft(-1);</span>
<span class="fc" id="L470">				unit.setWorkImprovement(null);</span>
<span class="fc" id="L471">				unit.setState(UnitState.ACTIVE);</span>
<span class="fc" id="L472">				unit.setMovesLeft(0);</span>
			}
<span class="fc" id="L474">		}</span>
<span class="fc" id="L475">	}</span>

	/**
	 * Embark a unit.
	 *
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; to embark on.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csEmbark(Unit carrier, ChangeSet cs) {
<span class="fc" id="L486">		final ServerPlayer owner = (ServerPlayer) getOwner();</span>

<span class="fc" id="L488">		Location oldLocation = getLocation();</span>
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">		Colony colony = (oldLocation instanceof WorkLocation) ? getColony() : null;</span>
<span class="pc bpc" id="L490" title="1 of 2 branches missed.">		if (colony != null)</span>
<span class="nc" id="L491">			oldLocation.getTile().cacheUnseen();// +til</span>
<span class="fc" id="L492">		setLocation(carrier);// -vis: only if on a different tile</span>
								// -til if moving from colony
<span class="fc" id="L494">		setMovesLeft(0);</span>
<span class="pc bpc" id="L495" title="1 of 2 branches missed.">		cs.add(See.only(owner), (colony != null) ? colony : (FreeColGameObject) oldLocation);</span>
<span class="pc bpc" id="L496" title="1 of 2 branches missed.">		if (carrier.getLocation() != oldLocation) {</span>
<span class="fc" id="L497">			cs.add(See.only(owner), carrier);</span>
		}
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">		if (oldLocation instanceof Tile) {</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">			if (carrier.getTile() != oldLocation) {</span>
<span class="fc" id="L501">				cs.addMove(See.only(owner), this, oldLocation, carrier.getTile());</span>
<span class="fc" id="L502">				owner.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
			}
<span class="fc" id="L504">			cs.addDisappear(owner, (Tile) oldLocation, this);</span>
		}
<span class="fc" id="L506">	}</span>

	/**
	 * Repair a unit.
	 *
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csRepairUnit(ChangeSet cs) {
<span class="nc" id="L515">		ServerPlayer owner = (ServerPlayer) getOwner();</span>
<span class="nc" id="L516">		setHitPoints(getHitPoints() + 1);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">		if (!isDamaged()) {</span>
<span class="nc" id="L518">			Location loc = getLocation();</span>
<span class="nc" id="L519">			cs.addMessage(See.only(owner),</span>
					new ModelMessage(&quot;model.unit.unitRepaired&quot;, this, (FreeColGameObject) loc)
<span class="nc" id="L521">							.addStringTemplate(&quot;%unit%&quot;, getLabel()).addStringTemplate(&quot;%repairLocation%&quot;,</span>
<span class="nc" id="L522">									loc.getLocationLabelFor(owner)));</span>
<span class="nc" id="L523">			setState(UnitState.ACTIVE);</span>
		}
<span class="nc" id="L525">		cs.addPartial(See.only(owner), this, &quot;hitPoints&quot;);</span>
<span class="nc" id="L526">	}</span>

	/**
	 * If a unit moves, check if an opposing naval unit slows it down. Note that
	 * the unit moves are reduced here.
	 *
	 * @param newTile
	 *            The &lt;code&gt;Tile&lt;/code&gt; the unit is moving to.
	 * @param random
	 *            A pseudo-random number source.
	 * @return Either an enemy unit that causes a slowdown, or null if none.
	 */
	private Unit getSlowedBy(Tile newTile, Random random) {
<span class="fc" id="L539">		Player player = getOwner();</span>
<span class="fc" id="L540">		Game game = getGame();</span>
<span class="fc" id="L541">		CombatModel combatModel = game.getCombatModel();</span>
<span class="fc" id="L542">		boolean pirate = hasAbility(Ability.PIRACY);</span>
<span class="fc" id="L543">		Unit attacker = null;</span>
<span class="fc" id="L544">		double attackPower = 0, totalAttackPower = 0;</span>

<span class="pc bpc" id="L546" title="1 of 4 branches missed.">		if (!isNaval() || getMovesLeft() &lt;= 0)</span>
<span class="fc" id="L547">			return null;</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">		for (Tile tile : newTile.getSurroundingTiles(1)) {</span>
			// Ships in settlements do not slow enemy ships, but:
			// FIXME: should a fortress slow a ship?
			Player enemy;
<span class="nc bnc" id="L552" title="All 6 branches missed.">			if (tile.isLand() || tile.getColony() != null || tile.getFirstUnit() == null</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">					|| (enemy = tile.getFirstUnit().getOwner()) == player)</span>
<span class="nc" id="L554">				continue;</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">			for (Unit enemyUnit : tile.getUnitList()) {</span>
<span class="nc bnc" id="L556" title="All 4 branches missed.">				if ((pirate || enemyUnit.hasAbility(Ability.PIRACY)</span>
<span class="nc bnc" id="L557" title="All 6 branches missed.">						|| (enemyUnit.isOffensiveUnit() &amp;&amp; player.atWarWith(enemy))) &amp;&amp; enemyUnit.isNaval()</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">						&amp;&amp; combatModel.getOffencePower(enemyUnit, this) &gt; attackPower) {</span>
<span class="nc" id="L559">					attackPower = combatModel.getOffencePower(enemyUnit, this);</span>
<span class="nc" id="L560">					totalAttackPower += attackPower;</span>
<span class="nc" id="L561">					attacker = enemyUnit;</span>
				}
<span class="nc" id="L563">			}</span>
<span class="nc" id="L564">		}</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">		if (attacker != null) {</span>
<span class="nc" id="L566">			double defencePower = combatModel.getDefencePower(attacker, this);</span>
<span class="nc" id="L567">			double totalProbability = totalAttackPower + defencePower;</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">			if (randomInt(logger, &quot;Slowed&quot;, random, (int) Math.round(totalProbability + 1)) &lt; totalAttackPower) {</span>
<span class="nc" id="L569">				int diff = Math.max(0, (int) Math.round(totalAttackPower - defencePower));</span>
<span class="nc" id="L570">				int moves = Math.min(9, 3 + diff / 3);</span>
<span class="nc" id="L571">				setMovesLeft(getMovesLeft() - moves);</span>
<span class="nc" id="L572">				logger.info(getId() + &quot; slowed by &quot; + attacker.getId() + &quot; by &quot; + Integer.toString(moves) + &quot; moves.&quot;);</span>
<span class="nc" id="L573">			} else {</span>
<span class="nc" id="L574">				attacker = null;</span>
			}
		}
<span class="nc" id="L577">		return attacker;</span>
	}

	/**
	 * Explores a lost city, finding a native burial ground.
	 *
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to add changes to.
	 */
	private void csNativeBurialGround(ChangeSet cs) {
<span class="nc" id="L587">		ServerPlayer serverPlayer = (ServerPlayer) getOwner();</span>
<span class="nc" id="L588">		Tile tile = getTile();</span>
<span class="nc" id="L589">		ServerPlayer indianPlayer = (ServerPlayer) tile.getOwner();</span>
<span class="nc" id="L590">		serverPlayer.csContact(indianPlayer, cs);</span>
<span class="nc" id="L591">		indianPlayer.csModifyTension(serverPlayer, Tension.Level.HATEFUL.getLimit(), cs);// +til</span>
<span class="nc" id="L592">		serverPlayer.csChangeStance(Stance.WAR, indianPlayer, true, cs);</span>
<span class="nc" id="L593">		cs.addMessage(See.only(serverPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR,
<span class="nc" id="L595">						RumourType.BURIAL_GROUND.getDescriptionKey(), serverPlayer, this).addStringTemplate(&quot;%nation%&quot;,</span>
<span class="nc" id="L596">								indianPlayer.getNationLabel()));</span>
<span class="nc" id="L597">	}</span>

	/**
	 * Explore a lost city.
	 *
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to add changes to.
	 * @return True if the unit survives.
	 */
	private boolean csExploreLostCityRumour(Random random, ChangeSet cs) {
<span class="nc" id="L609">		ServerPlayer serverPlayer = (ServerPlayer) getOwner();</span>
<span class="nc" id="L610">		Tile tile = getTile();</span>
<span class="nc" id="L611">		LostCityRumour lostCity = tile.getLostCityRumour();</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">		if (lostCity == null)</span>
<span class="nc" id="L613">			return true;</span>

<span class="nc" id="L615">		Game game = getGame();</span>
<span class="nc" id="L616">		Specification spec = game.getSpecification();</span>
<span class="nc" id="L617">		int difficulty = spec.getInteger(GameOptions.RUMOUR_DIFFICULTY);</span>
<span class="nc" id="L618">		int dx = 10 - difficulty;</span>
		UnitType unitType;
<span class="nc" id="L620">		Unit newUnit = null;</span>
<span class="nc" id="L621">		List&lt;UnitType&gt; treasureUnitTypes = spec.getUnitTypesWithAbility(Ability.CARRY_TREASURE);</span>

<span class="nc" id="L623">		RumourType rumour = lostCity.getType();</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">		if (rumour == null) {</span>
<span class="nc" id="L625">			rumour = lostCity.chooseType(this, random);</span>
		}
		// Filter out failing cases that could only occur if the
		// type was explicitly set in debug mode.
<span class="pc bnc" id="L629" title="All 3 branches missed.">		switch (rumour) {</span>
		case BURIAL_GROUND:
		case MOUNDS:
<span class="nc bnc" id="L632" title="All 4 branches missed.">			if (tile.getOwner() == null || !tile.getOwner().isIndian()) {</span>
<span class="nc" id="L633">				rumour = RumourType.NOTHING;</span>
			}
			break;
		case LEARN:
<span class="nc bnc" id="L637" title="All 2 branches missed.">			if (getType().getUnitTypesLearntInLostCity().isEmpty()) {</span>
<span class="nc" id="L638">				rumour = RumourType.NOTHING;</span>
			}
			break;
		default:
			break;
		}

		// Mounds are a special case that degrade to other cases.
<span class="nc bnc" id="L646" title="All 2 branches missed.">		boolean mounds = rumour == RumourType.MOUNDS;</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">		if (mounds) {</span>
<span class="nc" id="L648">			boolean done = false;</span>
<span class="nc" id="L649">			boolean nothing = false;</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">			while (!done) {</span>
<span class="nc" id="L651">				rumour = lostCity.chooseType(this, random);</span>
<span class="nc bnc" id="L652" title="All 5 branches missed.">				switch (rumour) {</span>
				case NOTHING: // Do not accept nothing-result the first time.
<span class="nc bnc" id="L654" title="All 2 branches missed.">					if (nothing) {</span>
<span class="nc" id="L655">						done = true;</span>
					} else {
<span class="nc" id="L657">						nothing = true;</span>
					}
<span class="nc" id="L659">					break;</span>
				case EXPEDITION_VANISHES:
				case TRIBAL_CHIEF:
<span class="nc" id="L662">					done = true;</span>
<span class="nc" id="L663">					break;</span>
				case RUINS:
<span class="nc" id="L665">					done = true;</span>
					// Misiulo confirms that in Col1 deSoto does *not*
					// protect against a burial ground at the same
					// time as a ruins find!
<span class="nc bnc" id="L669" title="All 2 branches missed.">					if (randomInt(logger, &quot;Ruins+Burial&quot;, random, 100) &gt;= spec.getInteger(GameOptions.BAD_RUMOUR))</span>
<span class="nc" id="L670">						break;</span>
					// Fall through
				case BURIAL_GROUND:
<span class="nc bnc" id="L673" title="All 4 branches missed.">					if (tile.getOwner() != null &amp;&amp; tile.getOwner().isIndian()) {</span>
<span class="nc" id="L674">						csNativeBurialGround(cs);</span>
					}
<span class="nc" id="L676">					done = true;</span>
<span class="nc" id="L677">					break;</span>
				default:
					; // unacceptable result for mounds
				}
			}
		}

<span class="nc" id="L684">		logger.info(&quot;Unit &quot; + getId() + &quot; is exploring rumour &quot; + rumour);</span>
<span class="nc" id="L685">		boolean result = true;</span>
<span class="nc" id="L686">		String key = rumour.getDescriptionKey();</span>
<span class="nc bnc" id="L687" title="All 10 branches missed.">		switch (rumour) {</span>
		case BURIAL_GROUND:
<span class="nc" id="L689">			csNativeBurialGround(cs);</span>
<span class="nc" id="L690">			break;</span>
		case EXPEDITION_VANISHES:
<span class="nc" id="L692">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR, key, serverPlayer));
<span class="nc" id="L694">			result = false;</span>
<span class="nc" id="L695">			break;</span>
		case NOTHING:
<span class="nc" id="L697">			cs.addMessage(See.only(serverPlayer), lostCity.getNothingMessage(serverPlayer, mounds, random));</span>
<span class="nc" id="L698">			break;</span>
		case LEARN:
<span class="nc" id="L700">			StringTemplate oldName = getLabel();</span>
<span class="nc" id="L701">			List&lt;UnitType&gt; learnTypes = getType().getUnitTypesLearntInLostCity();</span>
<span class="nc" id="L702">			unitType = getRandomMember(logger, &quot;Choose learn&quot;, learnTypes, random);</span>
<span class="nc" id="L703">			changeType(unitType);// -vis(serverPlayer)</span>
<span class="nc" id="L704">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L705">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR, key, serverPlayer, this)
<span class="nc" id="L707">							.addStringTemplate(&quot;%unit%&quot;, oldName).addNamed(&quot;%type%&quot;, getType()));</span>
<span class="nc" id="L708">			break;</span>
		case TRIBAL_CHIEF:
<span class="nc" id="L710">			int chiefAmount = randomInt(logger, &quot;Chief base amount&quot;, random, dx * 10) + dx * 5;</span>
<span class="nc" id="L711">			serverPlayer.modifyGold(chiefAmount);</span>
<span class="nc" id="L712">			cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR,
<span class="nc" id="L715">							((mounds) ? rumour.getAlternateDescriptionKey(&quot;mounds&quot;) : key), serverPlayer, this)</span>
<span class="nc" id="L716">									.addAmount(&quot;%money%&quot;, chiefAmount));</span>
<span class="nc" id="L717">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L718">			break;</span>
		case COLONIST:
<span class="nc" id="L720">			List&lt;UnitType&gt; foundTypes = spec.getUnitTypesWithAbility(Ability.FOUND_IN_LOST_CITY);</span>
<span class="nc" id="L721">			unitType = getRandomMember(logger, &quot;Choose found&quot;, foundTypes, random);</span>
<span class="nc" id="L722">			newUnit = new ServerUnit(game, tile, serverPlayer, unitType);// -vis:</span>
																			// safe,
																			// scout
																			// on
																			// tile
<span class="nc" id="L727">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR, key, serverPlayer, newUnit));
<span class="nc" id="L729">			break;</span>
		case CIBOLA:
<span class="nc" id="L731">			String cityName = NameCache.getNextCityOfCibola();</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">			if (cityName != null) {</span>
<span class="nc" id="L733">				int treasureAmount = randomInt(logger, &quot;Base treasure amount&quot;, random, dx * 600) + dx * 300;</span>
<span class="nc" id="L734">				unitType = getRandomMember(logger, &quot;Choose train&quot;, treasureUnitTypes, random);</span>
<span class="nc" id="L735">				newUnit = new ServerUnit(game, tile, serverPlayer, unitType);// -vis:</span>
																				// safe,
																				// scout
																				// on
																				// tile
<span class="nc" id="L740">				newUnit.setTreasureAmount(treasureAmount);</span>
<span class="nc" id="L741">				cs.addMessage(See.only(serverPlayer),</span>
						new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR, key, serverPlayer, newUnit)
<span class="nc" id="L743">								.addName(&quot;%city%&quot;, cityName).addAmount(&quot;%money%&quot;, treasureAmount));</span>
<span class="nc" id="L744">				cs.addGlobalHistory(game,</span>
<span class="nc" id="L745">						new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.CITY_OF_GOLD, serverPlayer)</span>
<span class="nc" id="L746">								.addStringTemplate(&quot;%nation%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L747">								.addName(&quot;%city%&quot;, cityName).addAmount(&quot;%treasure%&quot;, treasureAmount));</span>
<span class="nc" id="L748">				break;</span>
			}
			// Fall through, found all the cities of gold.
		case RUINS:
<span class="nc" id="L752">			int ruinsAmount = randomInt(logger, &quot;Base ruins amount&quot;, random, dx * 2) * 300 + 50;</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">			if (ruinsAmount &lt; 500) { // FIXME: remove magic number</span>
<span class="nc" id="L754">				serverPlayer.modifyGold(ruinsAmount);</span>
<span class="nc" id="L755">				cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
			} else {
<span class="nc" id="L757">				unitType = getRandomMember(logger, &quot;Choose train&quot;, treasureUnitTypes, random);</span>
<span class="nc" id="L758">				newUnit = new ServerUnit(game, tile, serverPlayer, unitType);// -vis:</span>
																				// safe,
																				// scout
																				// on
																				// tile
<span class="nc" id="L763">				newUnit.setTreasureAmount(ruinsAmount);</span>
			}
<span class="nc bnc" id="L765" title="All 2 branches missed.">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR,
<span class="nc bnc" id="L767" title="All 2 branches missed.">							((mounds) ? rumour.getAlternateDescriptionKey(&quot;mounds&quot;) : key), serverPlayer,</span>
<span class="nc" id="L768">							((newUnit != null) ? newUnit : this)).addAmount(&quot;%money%&quot;, ruinsAmount));</span>
<span class="nc" id="L769">			break;</span>
		case FOUNTAIN_OF_YOUTH:
<span class="nc" id="L771">			ServerEurope europe = (ServerEurope) serverPlayer.getEurope();</span>
<span class="nc bnc" id="L772" title="All 2 branches missed.">			if (europe == null) {</span>
				// FoY should now be disabled for non-colonial
				// players, but leave this in for now as it is harmless.
<span class="nc" id="L775">				cs.addMessage(See.only(serverPlayer), new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR,</span>
<span class="nc" id="L776">						rumour.getAlternateDescriptionKey(&quot;noEurope&quot;), serverPlayer, this));</span>
			} else {
<span class="nc bnc" id="L778" title="All 2 branches missed.">				if (serverPlayer.isAI()) { // FIXME: let the AI select</span>
<span class="nc" id="L779">					europe.generateFountainRecruits(dx, random);</span>
<span class="nc" id="L780">					cs.add(See.only(serverPlayer), europe);</span>
				} else {
					// Remember, and ask player to select
<span class="nc" id="L783">					serverPlayer.setRemainingEmigrants(dx);</span>
<span class="nc" id="L784">					cs.addTrivial(See.only(serverPlayer), &quot;fountainOfYouth&quot;, ChangeSet.ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L785">							&quot;migrants&quot;, Integer.toString(dx));</span>
				}
<span class="nc" id="L787">				cs.addMessage(See.only(serverPlayer),</span>
						new ModelMessage(ModelMessage.MessageType.LOST_CITY_RUMOUR, key, serverPlayer, this));
<span class="nc" id="L789">				cs.addAttribute(See.only(serverPlayer), &quot;sound&quot;, &quot;sound.event.fountainOfYouth&quot;);</span>
			}
<span class="nc" id="L791">			break;</span>
		case NO_SUCH_RUMOUR:
		case MOUNDS:
		default:
<span class="nc" id="L795">			logger.warning(&quot;Bogus rumour type: &quot; + rumour);</span>
			break;
		}
<span class="nc" id="L798">		tile.cacheUnseen();// +til</span>
<span class="nc" id="L799">		tile.removeLostCityRumour();// -til</span>
<span class="nc" id="L800">		return result;</span>
	}

	/**
	 * Activate sentried units on a tile.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to activate sentries on.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csActivateSentries(Tile tile, ChangeSet cs) {
<span class="fc bfc" id="L812" title="All 2 branches covered.">		for (Unit u : tile.getUnitList()) {</span>
<span class="pc bpc" id="L813" title="1 of 2 branches missed.">			if (u.getState() == UnitState.SENTRY) {</span>
<span class="nc" id="L814">				u.setState(UnitState.ACTIVE);</span>
<span class="nc" id="L815">				cs.add(See.perhaps(), u);</span>
			}
<span class="fc" id="L817">		}</span>
<span class="fc" id="L818">	}</span>

	/**
	 * Collects the tiles surrounding this unit that the player can not
	 * currently see, but now should as a result of a move.
	 *
	 * @param tile
	 *            The center tile to look from.
	 * @return A list of new tiles to see.
	 */
	public List&lt;Tile&gt; collectNewTiles(Tile tile) {
<span class="fc" id="L829">		final int los = getLineOfSight();</span>
<span class="fc bfc" id="L830" title="All 2 branches covered.">		return tile.getSurroundingTiles(0, los).stream().filter(t -&gt; !getOwner().canSee(t))</span>
<span class="fc" id="L831">				.collect(Collectors.toList());</span>
	}

	/**
	 * Move a unit.
	 *
	 * @param newTile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to move to.
	 * @param random
	 *            A pseudo-random number source.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	public void csMove(Tile newTile, Random random, ChangeSet cs) {
<span class="fc" id="L845">		final ServerPlayer serverPlayer = (ServerPlayer) getOwner();</span>

		// Plan to update tiles that could not be seen before but will
		// now be within the line-of-sight.
<span class="fc" id="L849">		final Location oldLocation = getLocation();</span>
<span class="pc bpc" id="L850" title="1 of 2 branches missed.">		List&lt;Tile&gt; oldTiles = (oldLocation.getTile() == null) ? Collections.&lt;Tile&gt;emptyList()</span>
<span class="fc" id="L851">				: oldLocation.getTile().getSurroundingTiles(1, getLineOfSight());</span>
<span class="fc" id="L852">		List&lt;Tile&gt; newTiles = collectNewTiles(newTile);</span>

		// Update unit state.
<span class="fc" id="L855">		setState(UnitState.ACTIVE);</span>
<span class="fc" id="L856">		setStateToAllChildren(UnitState.SENTRY);</span>
<span class="pc bpc" id="L857" title="1 of 2 branches missed.">		if (oldLocation instanceof HighSeas) {</span>
			; // Do not try to calculate move cost from Europe!
<span class="pc bpc" id="L859" title="1 of 2 branches missed.">		} else if (oldLocation instanceof Unit) {</span>
<span class="nc" id="L860">			setMovesLeft(0); // Disembark always consumes all moves.</span>
		} else {
<span class="pc bpc" id="L862" title="1 of 2 branches missed.">			if (getMoveCost(newTile) &lt;= 0) {</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">				logger.warning(&quot;Move of unit: &quot; + getId() + &quot; from: &quot;</span>
<span class="nc" id="L864">						+ ((oldLocation == null) ? &quot;null&quot; : oldLocation.getTile().getId()) + &quot; to: &quot; + newTile.getId()</span>
<span class="nc" id="L865">						+ &quot; has bogus cost: &quot; + getMoveCost(newTile));</span>
<span class="nc" id="L866">				setMovesLeft(0);</span>
			}
<span class="fc" id="L868">			setMovesLeft(getMovesLeft() - getMoveCost(newTile));</span>
		}

		// Do the move and explore a rumour if needed.
<span class="pc bpc" id="L872" title="1 of 2 branches missed.">		if (oldLocation instanceof WorkLocation) {</span>
<span class="nc" id="L873">			oldLocation.getTile().cacheUnseen();// +til</span>
		}
<span class="fc" id="L875">		setLocation(newTile);// -vis(serverPlayer),-til if in colony</span>
<span class="pc bpc" id="L876" title="5 of 6 branches missed.">		if (newTile.hasLostCityRumour() &amp;&amp; serverPlayer.isEuropean() &amp;&amp; !csExploreLostCityRumour(random, cs)) {</span>
<span class="nc" id="L877">			cs.addRemove(See.perhaps().always(serverPlayer), oldLocation, this);// -vis(serverPlayer)</span>
<span class="nc" id="L878">			this.dispose();</span>
		}
<span class="fc" id="L880">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>

		// Update tiles that are now invisible.
<span class="fc" id="L883">		Iterator&lt;Tile&gt; it = oldTiles.iterator();</span>
<span class="fc bfc" id="L884" title="All 2 branches covered.">		while (it.hasNext()) {</span>
<span class="fc bfc" id="L885" title="All 2 branches covered.">			if (serverPlayer.canSee(it.next()))</span>
<span class="fc" id="L886">				it.remove();</span>
		}
<span class="fc bfc" id="L888" title="All 2 branches covered.">		if (!oldTiles.isEmpty())</span>
<span class="fc" id="L889">			cs.add(See.only(serverPlayer), oldTiles);</span>
		// Unless moving in from off-map, update the old location and
		// make sure the move is always visible even if the unit
		// dies (including the animation). However, dead units
		// make no discoveries. Always update the new tile.
<span class="pc bpc" id="L894" title="1 of 2 branches missed.">		if (oldLocation instanceof Tile) {</span>
<span class="fc" id="L895">			cs.addMove(See.perhaps().always(serverPlayer), this, oldLocation, newTile);</span>
<span class="fc" id="L896">			cs.add(See.perhaps().always(serverPlayer), (FreeColGameObject) oldLocation);</span>
		} else {
<span class="nc" id="L898">			cs.add(See.only(serverPlayer), (FreeColGameObject) oldLocation);</span>
		}
<span class="fc" id="L900">		cs.add(See.perhaps().always(serverPlayer), newTile);</span>
<span class="pc bpc" id="L901" title="1 of 2 branches missed.">		if (isDisposed())</span>
<span class="nc" id="L902">			return;</span>
<span class="fc" id="L903">		serverPlayer.csSeeNewTiles(newTiles, cs);</span>

<span class="fc bfc" id="L905" title="All 2 branches covered.">		if (newTile.isLand()) {</span>
			Settlement settlement;
<span class="fc" id="L907">			Unit unit = null;</span>
			int d;
			// Claim land for tribe?
<span class="fc bfc" id="L910" title="All 2 branches covered.">			if ((newTile.getOwner() == null</span>
<span class="pc bpc" id="L911" title="1 of 4 branches missed.">					|| (newTile.getOwner().isEuropean() &amp;&amp; newTile.getOwningSettlement() == null))</span>
<span class="pc bpc" id="L912" title="1 of 4 branches missed.">					&amp;&amp; serverPlayer.isIndian() &amp;&amp; (settlement = getHomeIndianSettlement()) != null</span>
<span class="nc" id="L913">					&amp;&amp; ((d = newTile.getDistanceTo(settlement.getTile())) &lt; (settlement.getRadius()</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">							+ settlement.getType().getExtraClaimableRadius()))</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">					&amp;&amp; randomInt(logger, &quot;Claim tribal land&quot;, random, d + 1) == 0) {</span>
<span class="nc" id="L916">				newTile.cacheUnseen();// +til</span>
<span class="nc" id="L917">				newTile.changeOwnership(serverPlayer, settlement);// -til</span>
			}

			// Check for first landing
<span class="fc" id="L921">			String newLand = null;</span>
<span class="pc bpc" id="L922" title="1 of 2 branches missed.">			boolean firstLanding = !serverPlayer.isNewLandNamed();</span>
<span class="pc bpc" id="L923" title="1 of 4 branches missed.">			if (serverPlayer.isEuropean() &amp;&amp; firstLanding) {</span>
<span class="fc" id="L924">				newLand = serverPlayer.getNameForNewLand();</span>
				// Set the default value now to prevent multiple attempts.
				// The user setNewLandName can override.
<span class="fc" id="L927">				serverPlayer.setNewLandName(newLand);</span>
<span class="fc" id="L928">				cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE, new NewLandNameMessage(this, newLand));</span>
<span class="fc" id="L929">				logger.finest(&quot;First landing for &quot; + serverPlayer + &quot; at &quot; + newTile + &quot; with &quot; + this);</span>
			}

			// Check for new contacts.
<span class="fc" id="L933">			List&lt;ServerPlayer&gt; pending = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L934" title="All 2 branches covered.">			for (Tile t : newTile.getSurroundingTiles(1, 1)) {</span>
<span class="pc bpc" id="L935" title="2 of 4 branches missed.">				if (t == null || !t.isLand()) {</span>
<span class="nc" id="L936">					continue; // Invalid tile for contact</span>
				}

<span class="fc" id="L939">				settlement = t.getSettlement();</span>
<span class="fc bfc" id="L940" title="All 2 branches covered.">				ServerPlayer other = (settlement != null) ? (ServerPlayer) settlement.getOwner()</span>
<span class="fc bfc" id="L941" title="All 2 branches covered.">						: ((unit = t.getFirstUnit()) != null) ? (ServerPlayer) unit.getOwner() : null;</span>
<span class="pc bpc" id="L942" title="2 of 6 branches missed.">				if (other == null || other == serverPlayer || pending.contains(other))</span>
<span class="nc" id="L943">					continue; // No contact</span>
<span class="fc bfc" id="L944" title="All 2 branches covered.">				if (serverPlayer.csContact(other, cs)) {</span>
					// First contact. Note contact pending because
					// European first contact now requires a diplomacy
					// interaction to complete before leaving UNCONTACTED
					// state.
<span class="fc" id="L949">					pending.add(other);</span>
<span class="fc bfc" id="L950" title="All 2 branches covered.">					if (serverPlayer.isEuropean()) {</span>
<span class="pc bpc" id="L951" title="1 of 2 branches missed.">						if (other.isIndian()) {</span>
<span class="pc bpc" id="L952" title="1 of 4 branches missed.">							Tile offer = (firstLanding &amp;&amp; other.owns(newTile)) ? newTile : null;</span>
<span class="fc" id="L953">							serverPlayer.csNativeFirstContact(other, offer, cs);</span>
<span class="fc" id="L954">						} else {</span>
<span class="nc" id="L955">							serverPlayer.csEuropeanFirstContact(this, settlement, unit, cs);</span>
						}
					} else {
<span class="pc bpc" id="L958" title="1 of 2 branches missed.">						if (other.isIndian()) {</span>
							; // Do nothing
						} else {
<span class="fc" id="L961">							other.csNativeFirstContact(serverPlayer, null, cs);</span>
						}
					}
				}

				// Initialize alarm for native settlements or units and
				// notify of contact.
<span class="fc" id="L968">				ServerPlayer contactPlayer = serverPlayer;</span>
<span class="fc bfc" id="L969" title="All 2 branches covered.">				IndianSettlement is = (settlement instanceof IndianSettlement) ? (IndianSettlement) settlement : null;</span>
<span class="pc bpc" id="L970" title="1 of 8 branches missed.">				if (is != null || (unit != null &amp;&amp; (is = unit.getHomeIndianSettlement()) != null)</span>
<span class="fc bfc" id="L971" title="All 2 branches covered.">						|| (unit != null &amp;&amp; (contactPlayer = (ServerPlayer) unit.getOwner()).isEuropean()</span>
<span class="pc bpc" id="L972" title="3 of 4 branches missed.">								&amp;&amp; (is = getHomeIndianSettlement()) != null &amp;&amp; is.getTile() != null)) {</span>
<span class="fc" id="L973">					Tile copied = is.getTile().getTileToCache();</span>
<span class="pc bpc" id="L974" title="1 of 4 branches missed.">					if (contactPlayer.hasExplored(is.getTile()) &amp;&amp; is.setContacted(contactPlayer)) {// -til</span>
<span class="fc" id="L975">						is.getTile().cacheUnseen(copied);// +til</span>
<span class="fc" id="L976">						cs.add(See.only(contactPlayer), is);</span>
						// First European contact with native settlement.
<span class="fc" id="L978">						StringTemplate nation = is.getOwner().getNationLabel();</span>
<span class="fc" id="L979">						cs.addMessage(See.only(contactPlayer),</span>
								new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
										&quot;model.unit.nativeSettlementContact&quot;, this, is)
<span class="fc" id="L982">												.addStringTemplate(&quot;%nation%&quot;, nation)</span>
<span class="fc" id="L983">												.addName(&quot;%settlement%&quot;, is.getName()));</span>
<span class="fc" id="L984">						logger.finest(</span>
<span class="fc" id="L985">								&quot;First contact between &quot; + contactPlayer.getId() + &quot; and &quot; + is + &quot; at &quot; + newTile);</span>
					}
				}
<span class="fc" id="L988">				csActivateSentries(t, cs);</span>
<span class="fc" id="L989">			}</span>
<span class="fc" id="L990">		} else { // water</span>
<span class="fc bfc" id="L991" title="All 2 branches covered.">			for (Tile t : newTile.getSurroundingTiles(1, 1)) {</span>
<span class="pc bpc" id="L992" title="2 of 6 branches missed.">				if (t == null || t.isLand() || t.getFirstUnit() == null) {</span>
<span class="fc" id="L993">					continue;</span>
				}
<span class="pc bpc" id="L995" title="1 of 2 branches missed.">				if (t.getFirstUnit().getOwner() != serverPlayer)</span>
<span class="fc" id="L996">					csActivateSentries(t, cs);</span>
<span class="fc" id="L997">			}</span>
		}

		// Disembark in colony.
<span class="pc bpc" id="L1001" title="3 of 6 branches missed.">		if (isCarrier() &amp;&amp; !isEmpty() &amp;&amp; newTile.getColony() != null</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">				&amp;&amp; getSpecification().getBoolean(GameOptions.DISEMBARK_IN_COLONY)) {</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">			for (Unit u : getUnitList()) {</span>
<span class="nc" id="L1004">				((ServerUnit) u).csMove(newTile, random, cs);</span>
<span class="nc" id="L1005">			}</span>
<span class="nc" id="L1006">			setMovesLeft(0);</span>
		}

		// Check for slowing units.
<span class="fc" id="L1010">		Unit slowedBy = getSlowedBy(newTile, random);</span>
<span class="pc bpc" id="L1011" title="1 of 2 branches missed.">		if (slowedBy != null) {</span>
<span class="nc" id="L1012">			StringTemplate enemy = slowedBy.getApparentOwnerName();</span>
<span class="nc" id="L1013">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;model.unit.slowed&quot;, this, slowedBy)
<span class="nc" id="L1015">							.addStringTemplate(&quot;%unit%&quot;, getLabel(UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1016">							.addStringTemplate(&quot;%enemyUnit%&quot;, slowedBy.getLabel(UnitLabelType.NATIONAL))</span>
<span class="nc" id="L1017">							.addStringTemplate(&quot;%enemyNation%&quot;, enemy));</span>
		}

		// Check for region discovery
<span class="fc" id="L1021">		Region region = newTile.getDiscoverableRegion();</span>
<span class="pc bpc" id="L1022" title="3 of 6 branches missed.">		if (serverPlayer.isEuropean() &amp;&amp; region != null &amp;&amp; region.getDiscoverer() == null) {</span>
<span class="nc" id="L1023">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L1024">					new NewRegionNameMessage(region, newTile, this, serverPlayer.getNameForRegion(region)));</span>
<span class="nc" id="L1025">			region.setDiscoverer(getId());</span>
		}
<span class="fc" id="L1027">	}</span>

	// Serialization

	/**
	 * Returns the tag name of the root element representing this object.
	 *
	 * @return &quot;serverUnit&quot;
	 */
	@Override
	public String getServerXMLElementTagName() {
<span class="fc" id="L1038">		return &quot;serverUnit&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>