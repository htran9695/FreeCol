<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>REFAIPlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.ai</a> &gt; <span class="el_source">REFAIPlayer.java</span></div><h1>REFAIPlayer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.ai;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Random;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.pathfinding.CostDeciders;
import net.sf.freecol.common.model.pathfinding.GoalDecider;
import net.sf.freecol.common.model.pathfinding.GoalDeciders;
import net.sf.freecol.common.util.LogBuilder;
import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.common.util.Utils;
import net.sf.freecol.server.ai.mission.DefendSettlementMission;
import net.sf.freecol.server.ai.mission.Mission;
import net.sf.freecol.server.ai.mission.TransportMission;
import net.sf.freecol.server.ai.mission.PrivateerMission;
import net.sf.freecol.server.ai.mission.UnitSeekAndDestroyMission;
import net.sf.freecol.server.model.ServerPlayer;

/**
 * Objects of this class contains AI-information for a single REF player.
 *
 * For now, mostly just the EuropeanAIPlayer, with a few tweaks.
 */
public class REFAIPlayer extends EuropeanAIPlayer {

	/** The Constant logger. */
<span class="fc" id="L70">	private static final Logger logger = Logger.getLogger(REFAIPlayer.class.getName());</span>

	/** Limit on the number of REF units chasing a single hostile unit. */
	private static final int UNIT_USAD_THRESHOLD = 5;

	/** Container class for REF target colony information. */
	private static class TargetTuple implements Comparable&lt;TargetTuple&gt; {

		/** The colony. */
		public final Colony colony;

		/** The path. */
		public final PathNode path;

		/** The score. */
		public double score;

		/** The disembark tile. */
		public Tile disembarkTile;

		/** The entry. */
		public Tile entry;

		/**
		 * Instantiates a new target tuple.
		 *
		 * @param colony
		 *            the colony
		 * @param path
		 *            the path
		 * @param score
		 *            the score
		 */
<span class="nc" id="L103">		public TargetTuple(Colony colony, PathNode path, double score) {</span>
<span class="nc" id="L104">			this.colony = colony;</span>
<span class="nc" id="L105">			this.path = path;</span>
<span class="nc" id="L106">			this.score = score;</span>
<span class="nc" id="L107">			this.disembarkTile = null;</span>
<span class="nc" id="L108">			this.entry = null;</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			if (path != null) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">				for (PathNode p = path; p != null; p = p.next) {</span>
<span class="nc" id="L111">					Tile t = p.getTile();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">					if (t != null) {</span>
<span class="nc" id="L113">						this.entry = t;</span>
<span class="nc" id="L114">						break;</span>
					}
				}
			}
<span class="nc" id="L118">		}</span>

		// Implement Comparable&lt;TargetTuple&gt;

		/*
		 * (non-Javadoc)
		 * 
		 * @see java.lang.Comparable#compareTo(java.lang.Object)
		 */
		@Override
		public int compareTo(TargetTuple other) {
<span class="nc" id="L129">			double cmp = other.score - score;</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">			return (cmp &lt; 0.0) ? -1 : (cmp &gt; 0.0) ? 1 : 0;</span>
		}

		// Override Object

		/**
		 * {@inheritDoc}
		 */
		@Override
		public boolean equals(Object other) {
<span class="nc bnc" id="L140" title="All 2 branches missed.">			if (other instanceof TargetTuple) {</span>
<span class="nc bnc" id="L141" title="All 2 branches missed.">				return this.compareTo((TargetTuple) other) == 0;</span>
			}
<span class="nc" id="L143">			return super.equals(other);</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public int hashCode() {
<span class="nc" id="L151">			int hash = super.hashCode();</span>
<span class="nc" id="L152">			hash = 37 * hash + Utils.hashCode(colony);</span>
<span class="nc" id="L153">			hash = 37 * hash + Utils.hashCode(path);</span>
<span class="nc" id="L154">			hash = 37 * hash + Utils.hashCode(score);</span>
<span class="nc" id="L155">			hash = 37 * hash + Utils.hashCode(disembarkTile);</span>
<span class="nc" id="L156">			return 37 * hash + Utils.hashCode(entry);</span>
		}
	}

	/** The Constant seekAndDestroyRange. */
	private static final int seekAndDestroyRange = 12;

	/** Map of target to count. */
<span class="pc" id="L164">	private final Map&lt;Location, Integer&gt; targetMap = new HashMap&lt;&gt;();</span>

	/**
	 * Creates a new &lt;code&gt;REFAIPlayer&lt;/code&gt;.
	 *
	 * @param aiMain
	 *            The main AI-class.
	 * @param player
	 *            The player that should be associated with this
	 *            &lt;code&gt;REFAIPlayer&lt;/code&gt;.
	 */
	public REFAIPlayer(AIMain aiMain, ServerPlayer player) {
<span class="fc" id="L176">		super(aiMain, player);</span>

<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		uninitialized = getPlayer() == null;</span>
<span class="fc" id="L179">	}</span>

	/**
	 * Creates a new &lt;code&gt;REFAIPlayer&lt;/code&gt;.
	 *
	 * @param aiMain
	 *            The main AI-object.
	 * @param xr
	 *            The input stream containing the XML.
	 * @throws XMLStreamException
	 *             if a problem was encountered during parsing.
	 */
	public REFAIPlayer(AIMain aiMain, FreeColXMLReader xr) throws XMLStreamException {
<span class="nc" id="L192">		super(aiMain, xr);</span>

<span class="nc bnc" id="L194" title="All 2 branches missed.">		uninitialized = getPlayer() == null;</span>
<span class="nc" id="L195">	}</span>

	/**
	 * Find suitable colony targets.
	 *
	 * @param aiu
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to search with.
	 * @param port
	 *            If true, insist on the colonies being ports.
	 * @param aiCarrier
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to use as a carrier.
	 * @return A list of &lt;code&gt;TargetTuple&lt;/code&gt; target choices.
	 */
	private List&lt;TargetTuple&gt; findColonyTargets(AIUnit aiu, boolean port, AIUnit aiCarrier) {
<span class="nc" id="L209">		final Player player = getPlayer();</span>
<span class="nc" id="L210">		final Unit unit = aiu.getUnit();</span>
<span class="nc" id="L211">		final Unit carrier = aiCarrier.getUnit();</span>
<span class="nc" id="L212">		final List&lt;TargetTuple&gt; targets = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		for (Player p : player.getRebels()) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">			for (Colony c : p.getColonies()) {</span>
<span class="nc bnc" id="L215" title="All 4 branches missed.">				if (port &amp;&amp; !c.isConnectedPort())</span>
<span class="nc" id="L216">					continue;</span>
<span class="nc" id="L217">				PathNode path = unit.findPath(carrier, c, carrier, null);</span>
<span class="nc bnc" id="L218" title="All 2 branches missed.">				if (path == null)</span>
<span class="nc" id="L219">					continue;</span>
<span class="nc" id="L220">				int score = UnitSeekAndDestroyMission.scorePath(aiu, path);</span>
<span class="nc" id="L221">				targets.add(new TargetTuple(c, path, score));</span>
<span class="nc" id="L222">			}</span>
<span class="nc" id="L223">		}</span>

		// Increase score for drydock/s, musket and tools suppliers,
		// but decrease for fortifications.
		// FIXME: use Modifiers?
<span class="nc" id="L228">		final int percentTwiddle = 20; // Perturb score by +/-20%</span>
<span class="nc" id="L229">		int[] twiddle = randomInts(logger, &quot;REF target twiddle&quot;, getAIRandom(), 2 * percentTwiddle + 1, targets.size());</span>
<span class="nc" id="L230">		int twidx = 0;</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		for (TargetTuple t : targets) {</span>
<span class="nc" id="L232">			t.score *= 0.01 * (101 - Math.min(100, t.colony.getSoL()));</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">			for (Building b : t.colony.getBuildings()) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">				if (b.getLevel() &gt; 1) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">					if (b.hasAbility(Ability.REPAIR_UNITS))</span>
<span class="nc" id="L236">						t.score *= 1.5;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">					for (AbstractGoods ag : b.getOutputs()) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">						if (ag.getType().isMilitaryGoods()) {</span>
<span class="nc" id="L239">							t.score *= 2.0;</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">						} else if (ag.getType().isBuildingMaterial() &amp;&amp; ag.getType().isRefined()) {</span>
<span class="nc" id="L241">							t.score *= 1.5;</span>
						}
<span class="nc" id="L243">					}</span>
				}
<span class="nc" id="L245">			}</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">			int stockade = (!t.colony.hasStockade()) ? 0 : t.colony.getStockade().getLevel();</span>
<span class="nc" id="L247">			t.score *= (6 - stockade) / 6.0;</span>
<span class="nc" id="L248">			t.score *= 1.0 + 0.01 * (twiddle[twidx++] - percentTwiddle);</span>
<span class="nc" id="L249">		}</span>
<span class="nc" id="L250">		Collections.sort(targets);</span>

<span class="nc" id="L252">		LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L253">		lb.add(&quot;REF found colony targets:&quot;);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">		for (TargetTuple t : targets)</span>
<span class="nc" id="L255">			lb.add(&quot; &quot;, t.colony, &quot;(&quot;, t.score, &quot;)&quot;);</span>
<span class="nc" id="L256">		lb.log(logger, Level.FINE);</span>
<span class="nc" id="L257">		return targets;</span>
	}

	/**
	 * Initialize the REF. - Find the initial target - Give valid missions to
	 * all the units
	 *
	 * Note that we can not rely on normal AI processing as the &quot;teleporting&quot;
	 * Col1-style REF needs to be placed on the map before its first turn
	 * starts, so the server should ask this AI where it should arrive on the
	 * map.
	 *
	 * Note also that to find a target we can not just call getMilitaryMission
	 * and aim for it as the getMilitaryMission scoring includes distance from
	 * starting point, which is what we are trying to determine. So, just choose
	 * the best coastal colony.
	 *
	 * FIXME: Mission assignment is done here because ATM the European AI is
	 * prone to send ships full of troops off to attack the rebel navy. If this
	 * is fixed check if the normal mission assignment works and drop it from
	 * here.
	 *
	 * @param teleport
	 *            &quot;Teleporting&quot; in is allowed.
	 * @return True if the initialization succeeds.
	 */
	public boolean initialize(boolean teleport) {
<span class="nc" id="L284">		final AIMain aiMain = getAIMain();</span>
<span class="nc" id="L285">		final Random aiRandom = getAIRandom();</span>
		// Find a representative offensive land unit to use to search
		// for the initial target.
<span class="nc bnc" id="L288" title="All 4 branches missed.">		AIUnit aiUnit = find(getAIUnits(), aiu -&gt; !aiu.getUnit().isNaval() &amp;&amp; aiu.getUnit().isOffensiveUnit());</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">		if (aiUnit == null) {</span>
<span class="nc" id="L290">			logger.warning(&quot;REF has no army?!?&quot;);</span>
<span class="nc" id="L291">			return false;</span>
		}
<span class="nc" id="L293">		final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L294">		final Unit carrier = unit.getCarrier();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">		if (carrier == null) {</span>
<span class="nc" id="L296">			logger.warning(&quot;REF land unit not on a carrier: &quot; + unit);</span>
<span class="nc" id="L297">			return false;</span>
		}
<span class="nc" id="L299">		final AIUnit aiCarrier = aiMain.getAIUnit(carrier);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">		if (aiCarrier == null) {</span>
<span class="nc" id="L301">			logger.warning(&quot;REF naval unit missing: &quot; + carrier);</span>
<span class="nc" id="L302">			return false;</span>
		}

<span class="nc" id="L305">		List&lt;TargetTuple&gt; targets = findColonyTargets(aiUnit, true, aiCarrier);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		if (targets.isEmpty()) {</span>
<span class="nc" id="L307">			logger.warning(&quot;REF found no targets.&quot;);</span>
<span class="nc" id="L308">			return false;</span>
		}

<span class="nc" id="L311">		final Player rebel = targets.get(0).colony.getOwner();</span>
<span class="nc" id="L312">		double ratio = getStrengthRatio(rebel);</span>
<span class="nc" id="L313">		int n = targets.size();</span>
<span class="nc" id="L314">		LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L315">		lb.add(&quot;REF attacking &quot;, rebel.getName(), &quot; ratio=&quot;, ratio);</span>

		// For each target search from the target position to find a
		// Tile to disembark to. If teleporting in, the navy will
		// appear at this location, otherwise at the best entry
		// location for it.
<span class="nc" id="L321">		int fail = 0;</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">		for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L323">			final TargetTuple t = targets.get(i);</span>
<span class="nc" id="L324">			final GoalDecider gd = GoalDeciders.getDisembarkGoalDecider(t.colony.getTile());</span>
<span class="nc" id="L325">			PathNode path = unit.search(t.entry, gd, null, 10, carrier);</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">			if (path == null) {</span>
<span class="nc" id="L327">				t.disembarkTile = null;</span>
<span class="nc" id="L328">				fail++;</span>
			} else {
				// Step forward to the point the unit is about to
				// disembark. This is where the carrier should teleport to.
<span class="nc" id="L332">				t.disembarkTile = path.getTransportDropNode().previous.getTile();</span>
			}
		}
<span class="nc bnc" id="L335" title="All 2 branches missed.">		if (fail &gt; 0) {</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">			if (fail &lt; n) { // Drop targets without a decent disembark tile</span>
<span class="nc" id="L337">				lb.add(&quot; (&quot;);</span>
<span class="nc" id="L338">				int i = 0;</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">				while (i &lt; targets.size()) {</span>
<span class="nc" id="L340">					final TargetTuple t = targets.get(i);</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">					if (t.disembarkTile == null) {</span>
<span class="nc" id="L342">						lb.add(&quot; &quot;, t.colony);</span>
<span class="nc" id="L343">						targets.remove(i);</span>
<span class="nc" id="L344">						n--;</span>
					} else {
<span class="nc" id="L346">						i++;</span>
					}
<span class="nc" id="L348">				}</span>
<span class="nc" id="L349">				lb.add(&quot;)&quot;);</span>
<span class="nc" id="L350">			} else { // They were all bad, just use the existing simple path</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">				for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L352">					final TargetTuple t = targets.get(i);</span>
<span class="nc" id="L353">					t.disembarkTile = t.path.getTransportDropNode().previous.getTile();</span>
				}
			}
		}
		// Reset N, now we have eliminated bad landing sites.
<span class="nc bnc" id="L358" title="All 4 branches missed.">		n = (ratio &lt; 1.0) ? 1 // Just go for one place</span>
<span class="nc" id="L359">				: (ratio &lt; 2.0) ? Math.min(2, targets.size()) : Math.min(3, targets.size());</span>
<span class="nc" id="L360">		lb.add(&quot; =&gt; #targets=&quot;, n);</span>

<span class="nc bnc" id="L362" title="All 2 branches missed.">		if (!teleport) {</span>
			// Try to arrive on the map without being seen, while retaining
			// a path to the disembark tile that is at worst one turn
			// slower than the existing one.
<span class="nc" id="L366">			GoalDecider stealthGD = GoalDeciders.getComposedGoalDecider(true, GoalDeciders.getHighSeasGoalDecider(),</span>
<span class="nc" id="L367">					GoalDeciders.getStealthyGoalDecider(rebel));</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">			for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L369">				final TargetTuple t = targets.get(i);</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">				if (!rebel.canSee(t.entry))</span>
<span class="nc" id="L371">					continue;</span>
<span class="nc" id="L372">				PathNode path = carrier.search(t.disembarkTile, stealthGD,</span>
<span class="nc" id="L373">						CostDeciders.avoidSettlementsAndBlockingUnits(), t.path.getTotalTurns() + 1, null);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">				if (path != null) {</span>
<span class="nc" id="L375">					t.entry = path.getLastNode().getTile();</span>
<span class="nc" id="L376">					t.score *= 1.5; // Prefer invisible paths</span>
				}
			}
<span class="nc" id="L379">			Collections.sort(targets); // Re-sort with new scores</span>
		}

		// Give the land units seek-and-destroy missions for the
		// target. A valid target is needed before giving the carrier
		// a valid transport missions. Send roughly 2/3 of the force
		// at the best target, decreasing from there.
<span class="nc" id="L386">		List&lt;AIUnit&gt; navy = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L387">		Iterator&lt;AIUnit&gt; auIterator = getAIUnits().iterator();</span>
<span class="nc" id="L388">		int land = getPlayer().getNumberOfKingLandUnits();</span>
		int used;
		Mission m;
<span class="nc bnc" id="L391" title="All 2 branches missed.">		for (int i = 0; i &lt; n; i++) {</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">			if (!auIterator.hasNext())</span>
<span class="nc" id="L393">				break;</span>
<span class="nc" id="L394">			final TargetTuple t = targets.get(i);</span>
<span class="nc" id="L395">			lb.add(&quot;\n  Attack &quot;, t.colony, &quot; from &quot;, t.entry, &quot; via &quot;, t.disembarkTile, &quot; with &quot;);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">			while (auIterator.hasNext()) {</span>
<span class="nc" id="L397">				AIUnit aiu = auIterator.next();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">				if (!aiu.getUnit().isNaval())</span>
<span class="nc" id="L399">					continue;</span>
<span class="nc" id="L400">				Unit ship = aiu.getUnit();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">				if (ship.isEmpty()) {</span>
<span class="nc" id="L402">					navy.add(aiu);</span>
<span class="nc" id="L403">					continue;</span>
				}
<span class="nc bnc" id="L405" title="All 2 branches missed.">				if (teleport) {</span>
<span class="nc" id="L406">					ship.setEntryLocation(t.disembarkTile);</span>
				} else {
<span class="nc" id="L408">					ship.setEntryLocation(t.entry);</span>
				}
<span class="nc" id="L410">				lb.add(&quot;[&quot;, ship);</span>
<span class="nc" id="L411">				lb.mark();</span>
<span class="nc" id="L412">				used = 0;</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">				for (Unit u : aiu.getUnit().getUnitList()) {</span>
<span class="nc" id="L414">					AIUnit laiu = aiMain.getAIUnit(u);</span>
<span class="nc" id="L415">					m = getSeekAndDestroyMission(laiu, t.colony);</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">					if (m != null)</span>
<span class="nc" id="L417">						lb.add(&quot; &quot;, m);</span>
<span class="nc" id="L418">					used++;</span>
<span class="nc" id="L419">				}</span>
<span class="nc" id="L420">				m = getTransportMission(aiu);</span>
<span class="nc" id="L421">				lb.grew(&quot; &quot;, m);</span>
<span class="nc" id="L422">				lb.add(&quot; ]&quot;);</span>
<span class="nc bnc" id="L423" title="All 4 branches missed.">				if (i &lt; n - 1 &amp;&amp; used &gt;= (int) Math.floor(land * 0.66)) {</span>
<span class="nc" id="L424">					land -= used;</span>
<span class="nc" id="L425">					break;</span>
				}
<span class="nc" id="L427">			}</span>
		}

		// Try to find some rebel naval units near the entry locations
		// for the targets.
<span class="nc" id="L432">		final List&lt;Unit&gt; rebelNavy = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L433">		final GoalDecider navyGD = new GoalDecider() {</span>
			@Override
			public PathNode getGoal() {
<span class="nc" id="L436">				return null;</span>
			}

			@Override
			public boolean hasSubGoals() {
<span class="nc" id="L441">				return true;</span>
			}

			@Override
			public boolean check(Unit unit, PathNode pathNode) {
<span class="nc" id="L446">				Tile tile = pathNode.getTile();</span>
<span class="nc bnc" id="L447" title="All 8 branches missed.">				if (tile != null &amp;&amp; !tile.isEmpty() &amp;&amp; !tile.isLand() &amp;&amp; rebel.owns(tile.getFirstUnit())) {</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">					for (Unit u : tile.getUnitList()) {</span>
<span class="nc bnc" id="L449" title="All 6 branches missed.">						if (u.isOffensiveUnit() &amp;&amp; u.isNaval() &amp;&amp; !rebelNavy.contains(u))</span>
<span class="nc" id="L450">							rebelNavy.add(u);</span>
<span class="nc" id="L451">					}</span>
				}
<span class="nc" id="L453">				return false;</span>
			}
		};
<span class="nc bnc" id="L456" title="All 2 branches missed.">		for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L457">			carrier.search(targets.get(i).entry, navyGD, null, carrier.getInitialMovesLeft() * 2, null);</span>
		}

		// Attack naval targets.
<span class="nc" id="L461">		final Comparator&lt;Unit&gt; militaryStrength = getGame().getCombatModel().getMilitaryStrengthComparator();</span>
<span class="nc" id="L462">		Collections.sort(rebelNavy, militaryStrength);</span>
<span class="nc" id="L463">		Iterator&lt;Unit&gt; ui = rebelNavy.iterator();</span>
<span class="nc" id="L464">		List&lt;Tile&gt; entries = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L465">		entries.add(rebel.getEntryLocation().getTile());</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">		while (!navy.isEmpty()) {</span>
<span class="nc" id="L467">			final AIUnit aiu = navy.remove(0);</span>
<span class="nc" id="L468">			final Unit u = aiu.getUnit();</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">			final Unit enemy = (ui.hasNext()) ? ui.next() : null;</span>
			Tile start;
<span class="nc bnc" id="L471" title="All 2 branches missed.">			if (enemy == null) {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">				if ((m = getWanderHostileMission(aiu)) != null) {</span>
<span class="nc" id="L473">					start = getRandomMember(logger, &quot;REF patrol entry&quot;, entries, aiRandom);</span>
<span class="nc" id="L474">					u.setEntryLocation(start);</span>
<span class="nc" id="L475">					lb.add(&quot;\n  Patrol from &quot;, start, &quot; with &quot;, m);</span>
				}
			} else {
<span class="nc bnc" id="L478" title="All 2 branches missed.">				if ((m = getSeekAndDestroyMission(aiu, enemy)) != null) {</span>
<span class="nc" id="L479">					start = u.getBestEntryTile(enemy.getTile());</span>
<span class="nc" id="L480">					u.setEntryLocation(start);</span>
<span class="nc" id="L481">					entries.add(start);</span>
<span class="nc" id="L482">					lb.add(&quot;\n  Suppress &quot;, enemy, &quot; from &quot;, start, &quot; with &quot;, m);</span>
				}
			}
<span class="nc" id="L485">		}</span>
<span class="nc" id="L486">		lb.log(logger, Level.FINE);</span>
<span class="nc" id="L487">		return true;</span>
	}

	/**
	 * Require more transport missions, recruiting from the privateering
	 * missions.
	 *
	 * @param nt
	 *            The number of transport missions required.
	 * @param transports
	 *            The list of &lt;code&gt;AIUnit&lt;/code&gt;s with a transport mission.
	 * @param privateers
	 *            The list of &lt;code&gt;AIUnit&lt;/code&gt;s with a privateer mission.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @return A list of new &lt;code&gt;AIUnit&lt;/code&gt;s with transport missions.
	 */
	private List&lt;AIUnit&gt; requireTransports(int nt, List&lt;AIUnit&gt; transports, List&lt;AIUnit&gt; privateers, LogBuilder lb) {
		Mission m;
<span class="nc" id="L506">		List&lt;AIUnit&gt; naval = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L507">		List&lt;AIUnit&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L508" title="All 2 branches missed.">		if (transports.size() &lt; nt) {</span>
			// Recruit privateers not currently chasing a unit.
			// Collect privateers that are on the map.
<span class="nc bnc" id="L511" title="All 2 branches missed.">			for (AIUnit aiu : privateers) {</span>
<span class="nc" id="L512">				Location target = aiu.getMission().getTarget();</span>
<span class="nc bnc" id="L513" title="All 4 branches missed.">				if (target instanceof Unit &amp;&amp; aiu.getUnit().hasTile()) {</span>
<span class="nc" id="L514">					naval.add(aiu);</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">				} else if ((m = getTransportMission(aiu)) != null) {</span>
<span class="nc" id="L516">					lb.add(&quot; notarget &quot;, m);</span>
<span class="nc" id="L517">					result.add(aiu);</span>
				}
<span class="nc" id="L519">			}</span>
		}
<span class="nc bnc" id="L521" title="All 2 branches missed.">		if (transports.size() &lt; nt) {</span>
			// Sort by longest distance to target
<span class="nc" id="L523">			Collections.sort(naval, new Comparator&lt;AIUnit&gt;() {</span>
				@Override
				public int compare(AIUnit a1, AIUnit a2) {
<span class="nc" id="L526">					int d1 = a1.getMission(PrivateerMission.class).getDistanceToTarget();</span>
<span class="nc" id="L527">					int d2 = a2.getMission(PrivateerMission.class).getDistanceToTarget();</span>
<span class="nc" id="L528">					return d1 - d2;</span>
				}
			});
<span class="nc bnc" id="L531" title="All 2 branches missed.">			while (!naval.isEmpty()) {</span>
<span class="nc" id="L532">				AIUnit aiu = naval.remove(0);</span>
<span class="nc" id="L533">				int distance = aiu.getMission(PrivateerMission.class).getDistanceToTarget();</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">				if ((m = getTransportMission(aiu)) != null) {</span>
<span class="nc" id="L535">					lb.add(&quot; REQUIRED &quot;, distance, &quot; &quot;, m);</span>
<span class="nc" id="L536">					result.add(aiu);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">					if (result.size() + transports.size() &gt;= nt)</span>
<span class="nc" id="L538">						break;</span>
				}
<span class="nc" id="L540">			}</span>
		}
<span class="nc" id="L542">		privateers.removeAll(result);</span>
<span class="nc" id="L543">		transports.addAll(result);</span>
<span class="nc" id="L544">		return result;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected Stance determineStance(Player other) {
<span class="nc" id="L552">		final Player player = getPlayer();</span>
		// The REF is always at war with its own rebels.
<span class="nc bnc" id="L554" title="All 4 branches missed.">		return (other.getREFPlayer() == player) ? ((other.isRebel()) ? Stance.WAR : Stance.PEACE)</span>
<span class="nc bnc" id="L555" title="All 4 branches missed.">				: (other.atWarWith(player)) ? Stance.WAR : (!player.getRebels().isEmpty()) ? Stance.PEACE // Focus!</span>
<span class="nc" id="L556">						: super.determineStance(other);</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void giveNormalMissions(LogBuilder lb) {
<span class="nc" id="L564">		final Player player = getPlayer();</span>
<span class="nc" id="L565">		final Map&lt;Location, List&lt;AIUnit&gt;&gt; idlers = new HashMap&lt;&gt;();</span>
<span class="nc" id="L566">		List&lt;AIUnit&gt; privateers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L567">		List&lt;AIUnit&gt; transports = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L568">		List&lt;AIUnit&gt; todo = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L569">		List&lt;AIUnit&gt; land = new ArrayList&lt;&gt;();</span>
		Mission m;
		Colony colony;
<span class="nc" id="L572">		lb.add(&quot;\n  REF mission changes:&quot;);</span>

		// Collect the REF units, the privateers, the transports, the
		// unemployed navy, and the unemployed land units.
<span class="nc" id="L576">		targetMap.clear();</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">		for (AIUnit aiu : getAIUnits()) {</span>
<span class="nc" id="L578">			Unit u = aiu.getUnit();</span>
<span class="nc bnc" id="L579" title="All 4 branches missed.">			if (u.isDisposed() || !u.hasAbility(Ability.REF_UNIT))</span>
<span class="nc" id="L580">				continue;</span>
<span class="nc" id="L581">			Mission mission = aiu.getMission();</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">			if (u.isNaval()) {</span>
<span class="nc bnc" id="L583" title="All 4 branches missed.">				if (mission == null || !mission.isValid()) {</span>
<span class="nc" id="L584">					todo.add(aiu);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">				} else if (mission instanceof TransportMission) {</span>
<span class="nc" id="L586">					transports.add(aiu);</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">				} else if (mission instanceof PrivateerMission) {</span>
<span class="nc" id="L588">					privateers.add(aiu);</span>
<span class="nc" id="L589">					Location loc = mission.getTarget();</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">					if (loc != null)</span>
<span class="nc" id="L591">						incrementMapCount(targetMap, loc);</span>
<span class="nc" id="L592">				} else {</span>
<span class="nc" id="L593">					todo.add(aiu);</span>
				}
			} else {
<span class="nc bnc" id="L596" title="All 2 branches missed.">				if (mission == null) {</span>
<span class="nc" id="L597">					land.add(aiu);</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">				} else if (mission instanceof DefendSettlementMission) {</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">					if (mission.isValid()) {</span>
<span class="nc" id="L600">						colony = (Colony) mission.getTarget();</span>
						// Bleed off excessive defenders.
<span class="nc bnc" id="L602" title="All 4 branches missed.">						if (u.isAtLocation(colony) &amp;&amp; !colony.isBadlyDefended()</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">								&amp;&amp; randomInt(logger, &quot;REF defend &quot; + colony.getName(), getAIRandom(), 3) == 0) {</span>
<span class="nc" id="L604">							land.add(aiu);</span>
						} else {
<span class="nc" id="L606">							incrementMapCount(targetMap, mission.getTarget());</span>
						}
					} else {
<span class="nc" id="L609">						land.add(aiu);</span>
					}
<span class="nc bnc" id="L611" title="All 2 branches missed.">				} else if (mission instanceof UnitSeekAndDestroyMission) {</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">					if (mission.isValid()) {</span>
<span class="nc" id="L613">						incrementMapCount(targetMap, mission.getTarget());</span>
<span class="nc" id="L614">						continue;</span>
					}
<span class="nc" id="L616">					land.add(aiu);</span>
				} else {
<span class="nc" id="L618">					land.add(aiu);</span>
				}
			}
<span class="nc" id="L621">		}</span>

		// Use free naval units as transports.
<span class="nc bnc" id="L624" title="All 2 branches missed.">		for (AIUnit aiu : todo) {</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">			if ((m = getTransportMission(aiu)) != null) {</span>
<span class="nc" id="L626">				lb.add(&quot; &quot;, m);</span>
<span class="nc" id="L627">				transports.add(aiu);</span>
			}
<span class="nc" id="L629">		}</span>
<span class="nc" id="L630">		todo.clear();</span>

		// Insist on a minimum number of transports.
<span class="nc" id="L633">		int nt = Math.max(3, privateers.size() / 10);</span>
<span class="nc" id="L634">		requireTransports(nt, transports, privateers, lb);</span>

		// Use up the free land units:
		// - mop up nearby hostile targets (but do not all rush after
		// one loose wagon!)
		// - if idle at a well defended port, consider further attacks below
		// - defend the closest settlement needing defence
		// - defend the closest port
		// - go idle in a port
<span class="nc bnc" id="L643" title="All 2 branches missed.">		for (AIUnit aiu : land) {</span>
<span class="nc" id="L644">			Location target = UnitSeekAndDestroyMission.findTarget(aiu, seekAndDestroyRange, false);</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">			if (target != null) {</span>
<span class="nc bnc" id="L646" title="All 2 branches missed.">				int count = (targetMap.containsKey(target)) ? targetMap.get(target) : 0;</span>
<span class="nc bnc" id="L647" title="All 4 branches missed.">				if (target instanceof Unit &amp;&amp; count &lt; UNIT_USAD_THRESHOLD</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">						&amp;&amp; (m = getSeekAndDestroyMission(aiu, target)) != null) {</span>
<span class="nc" id="L649">					lb.add(&quot; NEW-SEEK-&quot;, count, &quot; &quot;, m);</span>
<span class="nc" id="L650">					incrementMapCount(targetMap, target);</span>
<span class="nc" id="L651">					continue;</span>
<span class="nc bnc" id="L652" title="All 4 branches missed.">				} else if (target instanceof Settlement &amp;&amp; (m = getSeekAndDestroyMission(aiu, target)) != null) {</span>
<span class="nc" id="L653">					lb.add(&quot; NEW-SEEK &quot;, m);</span>
<span class="nc" id="L654">					incrementMapCount(targetMap, target);</span>
<span class="nc" id="L655">					continue;</span>
				} else {
<span class="nc" id="L657">					throw new RuntimeException(&quot;Bogus target: &quot; + target);</span>
				}
			}

			// Find units idle at a port
<span class="nc" id="L662">			final Unit u = aiu.getUnit();</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">			if (u.isInEurope()) {</span>
<span class="nc" id="L664">				appendToMapList(idlers, player.getEurope(), aiu);</span>
<span class="nc" id="L665">				continue;</span>
<span class="nc bnc" id="L666" title="All 4 branches missed.">			} else if ((colony = u.getColony()) != null &amp;&amp; colony.isConnectedPort()) {</span>
<span class="nc" id="L667">				appendToMapList(idlers, colony, aiu);</span>
<span class="nc" id="L668">				continue;</span>
			}

			// Go defend the nearest colony needing defence
<span class="nc" id="L672">			Colony best = u.getClosestColony(getBadlyDefended().stream().map(AIColony::getColony));</span>
<span class="nc bnc" id="L673" title="All 4 branches missed.">			if (best != null &amp;&amp; (m = getDefendSettlementMission(aiu, best)) != null) {</span>
<span class="nc" id="L674">				lb.add(&quot; GO-DEFEND-&quot;, best.getName(), &quot; &quot;, m);</span>
<span class="nc" id="L675">				incrementMapCount(targetMap, best);</span>
<span class="nc" id="L676">				continue;</span>
			}

			// Just go defend the nearest port. Once there and enough
			// defenders are clearly allocated, some will be made available
			// to launch new attacks.
<span class="nc" id="L682">			PathNode path = u.findOurNearestPort();</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">			colony = (path == null) ? null : path.getLastNode().getTile().getColony();</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">			if (colony != null &amp;&amp; (m = getDefendSettlementMission(aiu, colony)) != null) {</span>
<span class="nc" id="L685">				lb.add(&quot; GOTO-&quot;, colony.getName(), &quot; &quot;, m);</span>
<span class="nc" id="L686">				incrementMapCount(targetMap, colony);</span>
<span class="nc" id="L687">				continue;</span>
			}

			// Just go somewhere and idle.
<span class="nc" id="L691">			m = getIdleAtSettlementMission(aiu);</span>
<span class="nc" id="L692">			lb.add(&quot; &quot;, m);</span>
<span class="nc" id="L693">		}</span>

		// Try to find new attacks for units left idling at ports.
<span class="nc bnc" id="L696" title="All 2 branches missed.">		if (!idlers.isEmpty()) {</span>
			// See what transport is present at a colony already.
<span class="nc" id="L698">			requireTransports(0, transports, privateers, lb);</span>
<span class="nc" id="L699">			todo.clear();</span>
<span class="nc" id="L700">			Map&lt;Location, List&lt;AIUnit&gt;&gt; ready = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">			for (AIUnit aiu : transports) {</span>
<span class="nc" id="L702">				TransportMission tm = aiu.getMission(TransportMission.class);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">				if (!tm.isEmpty())</span>
<span class="nc" id="L704">					continue;</span>
<span class="nc" id="L705">				Unit u = aiu.getUnit();</span>
				Location key;
<span class="nc bnc" id="L707" title="All 4 branches missed.">				if (u.isInEurope() &amp;&amp; idlers.containsKey(key = player.getEurope())) {</span>
<span class="nc" id="L708">					appendToMapList(ready, key, aiu);</span>
<span class="nc bnc" id="L709" title="All 4 branches missed.">				} else if ((key = u.getColony()) != null &amp;&amp; idlers.containsKey(key)) {</span>
<span class="nc" id="L710">					appendToMapList(ready, key, aiu);</span>
				} else {
<span class="nc" id="L712">					todo.add(aiu);</span>
				}
<span class="nc" id="L714">			}</span>

			// If there are idle units and carriers present at the
			// same colony, load the carriers and launch new USAD
			// missions with them. Collect the ports that still
			// contain idle units, and accumulate the amount of space
			// needed to move the units.
<span class="nc" id="L721">			List&lt;Location&gt; idlePorts = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L722">			List&lt;AIUnit&gt; aiCarriers = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L723">			int space = 0;</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">			for (Entry&lt;Location, List&lt;AIUnit&gt;&gt; e : idlers.entrySet()) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">				if (e.getValue() == null)</span>
<span class="nc" id="L726">					continue;</span>
<span class="nc" id="L727">				aiCarriers.clear();</span>
<span class="nc" id="L728">				Location key = e.getKey();</span>
<span class="nc bnc" id="L729" title="All 4 branches missed.">				if (!ready.containsKey(key) || ready.get(key).isEmpty())</span>
<span class="nc" id="L730">					continue; // No carrier here</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">				landUnit: for (AIUnit aiu : e.getValue()) {</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">					for (AIUnit aiCarrier : ready.get(key)) {</span>
<span class="nc" id="L733">						Unit carrier = aiCarrier.getUnit();</span>
<span class="nc bnc" id="L734" title="All 4 branches missed.">						if (carrier.canAdd(aiu.getUnit()) &amp;&amp; aiu.joinTransport(carrier, null)) {</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">							if (!aiCarriers.contains(aiCarrier)) {</span>
<span class="nc" id="L736">								aiCarriers.add(aiCarrier);</span>
							}
							continue landUnit;
						}
<span class="nc" id="L740">					}</span>
<span class="nc" id="L741">				}</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">				if (aiCarriers.isEmpty())</span>
<span class="nc" id="L743">					continue; // Did not load</span>

				// Choose a target colony. Pick a representative unit
				// to plan with, but if it happens to have a target already
				// keep that.
<span class="nc" id="L748">				AIUnit found = null;</span>
<span class="nc" id="L749">				Colony target = null;</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">				for (AIUnit aiCarrier : aiCarriers) {</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">					for (Unit u : aiCarrier.getUnit().getUnitList()) {</span>
<span class="nc bnc" id="L752" title="All 4 branches missed.">						if (u.hasAbility(Ability.REF_UNIT) &amp;&amp; (found = getAIUnit(u)) != null)</span>
<span class="nc" id="L753">							break;</span>
<span class="nc" id="L754">					}</span>
<span class="nc bnc" id="L755" title="All 8 branches missed.">					if (found != null &amp;&amp; (m = found.getMission()) != null &amp;&amp; m.isValid()</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">							&amp;&amp; m instanceof UnitSeekAndDestroyMission &amp;&amp; m.getTarget() instanceof Colony) {</span>
<span class="nc" id="L757">						target = (Colony) m.getTarget();</span>
<span class="nc" id="L758">						break;</span>
					}
<span class="nc" id="L760">				}</span>
<span class="nc bnc" id="L761" title="All 2 branches missed.">				if (target == null) {</span>
<span class="nc" id="L762">					AIUnit aiCarrier = getAIUnit(found.getUnit().getCarrier());</span>
<span class="nc" id="L763">					List&lt;TargetTuple&gt; ct = findColonyTargets(found, true, aiCarrier);</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">					if (ct.isEmpty()) {</span>
<span class="nc" id="L765">						ct = findColonyTargets(found, false, aiCarrier);</span>
					}
<span class="nc bnc" id="L767" title="All 2 branches missed.">					if (!ct.isEmpty()) {</span>
<span class="nc" id="L768">						target = ct.get(0).colony;</span>
					}
				}
<span class="nc bnc" id="L771" title="All 2 branches missed.">				if (target == null)</span>
<span class="nc" id="L772">					continue; // No target for these idlers</span>

				// Send them to destroy the target
<span class="nc bnc" id="L775" title="All 2 branches missed.">				for (AIUnit aiCarrier : aiCarriers) {</span>
<span class="nc" id="L776">					TransportMission tm = aiCarrier.getMission(TransportMission.class);</span>
					AIUnit aiu;
<span class="nc bnc" id="L778" title="All 2 branches missed.">					for (Unit u : aiCarrier.getUnit().getUnitList()) {</span>
<span class="nc bnc" id="L779" title="All 4 branches missed.">						if (u.hasAbility(Ability.REF_UNIT) &amp;&amp; (aiu = getAIUnit(u)) != null</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">								&amp;&amp; (m = getSeekAndDestroyMission(aiu, target)) != null) {</span>
<span class="nc" id="L781">							lb.add(&quot; IDLER-&gt;&quot;, target, &quot; &quot;, m);</span>
<span class="nc" id="L782">							tm.queueTransportable(aiu, false, lb);</span>
<span class="nc" id="L783">							e.getValue().remove(aiu);</span>
						}
<span class="nc" id="L785">					}</span>
<span class="nc" id="L786">				}</span>

				// Are there more idle units waiting here?
<span class="nc bnc" id="L789" title="All 2 branches missed.">				if (!e.getValue().isEmpty()) {</span>
<span class="nc" id="L790">					idlePorts.add(key);</span>
<span class="nc" id="L791">					space += e.getValue().stream().mapToInt(aiu -&gt; aiu.getUnit().getSpaceTaken()).sum();</span>
				}
<span class="nc" id="L793">			}</span>

<span class="nc bnc" id="L795" title="All 2 branches missed.">			if (!idlePorts.isEmpty()) {</span>
				// Do we need to switch more units from privateering
				// to transport?
<span class="nc bnc" id="L798" title="All 2 branches missed.">				for (AIUnit aiu : todo) {</span>
<span class="nc" id="L799">					space -= aiu.getUnit().getCargoCapacity() - aiu.getUnit().getCargoSpaceTaken();</span>
<span class="nc" id="L800">				}</span>
<span class="nc" id="L801">				nt = todo.size();</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">				if (space &lt; 0) {</span>
<span class="nc" id="L803">					nt += -space / 5 + 1; // Quick and dirty hack</span>
<span class="nc" id="L804">					requireTransports(nt, todo, privateers, lb);</span>
				}

				// Send transports to the idle ports, preferring the ones
				// with the most units.
<span class="nc" id="L809">				Collections.sort(idlePorts, new Comparator&lt;Location&gt;() {</span>
					@Override
					public int compare(Location l1, Location l2) {
<span class="nc" id="L812">						return idlers.get(l1).size() - idlers.get(l2).size();</span>
					}
				});
<span class="nc" id="L815">				boolean bad = false;</span>
<span class="nc bnc" id="L816" title="All 4 branches missed.">				while (!bad &amp;&amp; !todo.isEmpty()) {</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">					for (Location l : idlePorts) {</span>
<span class="nc" id="L818">						int bestValue = Unit.MANY_TURNS;</span>
<span class="nc" id="L819">						AIUnit best = null;</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">						for (AIUnit aiu : todo) {</span>
<span class="nc" id="L821">							int value = aiu.getUnit().getTurnsToReach(l);</span>
<span class="nc bnc" id="L822" title="All 2 branches missed.">							if (bestValue &gt; value) {</span>
<span class="nc" id="L823">								bestValue = value;</span>
<span class="nc" id="L824">								best = aiu;</span>
							}
<span class="nc" id="L826">						}</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">						if (best == null) {</span>
<span class="nc" id="L828">							bad = true;</span>
<span class="nc" id="L829">							continue;</span>
						}
<span class="nc" id="L831">						todo.remove(best);</span>
<span class="nc" id="L832">						best.getMission().setTarget(l);</span>
<span class="nc" id="L833">						lb.add(&quot; retarget &quot;, best, &quot; to &quot;, l, &quot;(&quot;, idlers.get(l).size(), &quot;)&quot;);</span>
<span class="nc" id="L834">					}</span>
				}
			}
		}

		// Fall back to the normal EuropeanAI behaviour for remaining units.
<span class="nc" id="L840">		super.giveNormalMissions(lb);</span>
<span class="nc" id="L841">	}</span>

	// AI Player interface
	// Inherit everything from EuropeanAIPlayer except the following overrides.

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void startWorking() {
<span class="nc" id="L851">		final Player player = getPlayer();</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">		if (!player.isWorkForREF()) {</span>
<span class="nc" id="L853">			logger.warning(&quot;No work for REF: &quot; + player);</span>
<span class="nc" id="L854">			return;</span>
		}

<span class="nc" id="L857">		super.startWorking();</span>

		// Always allocate transport for all land units in Europe.
<span class="nc" id="L860">		List&lt;TransportMission&gt; transport = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L861">		List&lt;TransportableAIObject&gt; land = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L862" title="All 2 branches missed.">		for (AIUnit aiu : getAIUnits()) {</span>
<span class="nc" id="L863">			final Unit u = aiu.getUnit();</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">			if (u.isNaval()) {</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">				if (aiu.hasMission(TransportMission.class)) {</span>
<span class="nc" id="L866">					transport.add(aiu.getMission(TransportMission.class));</span>
				}
			} else {
<span class="nc bnc" id="L869" title="All 2 branches missed.">				if (u.isInEurope())</span>
<span class="nc" id="L870">					land.add(aiu);</span>
			}
<span class="nc" id="L872">		}</span>
<span class="nc bnc" id="L873" title="All 4 branches missed.">		if (!land.isEmpty() &amp;&amp; !transport.isEmpty()) {</span>
<span class="nc" id="L874">			LogBuilder lb = new LogBuilder(256);</span>
<span class="nc" id="L875">			allocateTransportables(land, transport, lb);</span>
<span class="nc" id="L876">			lb.log(logger, Level.FINE);</span>
		}
<span class="nc" id="L878">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int adjustMission(AIUnit aiUnit, PathNode path, Class type, int value) {
<span class="nc bnc" id="L885" title="All 2 branches missed.">		if (value &gt; 0) {</span>
<span class="nc bnc" id="L886" title="All 2 branches missed.">			if (type == DefendSettlementMission.class) {</span>
				// REF garrisons thinly.
<span class="nc" id="L888">				Location loc = DefendSettlementMission.extractTarget(aiUnit, path);</span>
<span class="nc bnc" id="L889" title="All 4 branches missed.">				if (loc instanceof Colony &amp;&amp; !((Colony) loc).isBadlyDefended()) {</span>
<span class="nc" id="L890">					return Integer.MIN_VALUE;</span>
				}
<span class="nc bnc" id="L892" title="All 2 branches missed.">			} else if (type == UnitSeekAndDestroyMission.class) {</span>
<span class="nc" id="L893">				Location target = UnitSeekAndDestroyMission.extractTarget(aiUnit, path);</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">				if (target instanceof Settlement) {</span>
					// Value connected settlements highly.
					// Initially, accept no others.
<span class="nc bnc" id="L897" title="All 2 branches missed.">					if (((Settlement) target).isConnectedPort()) {</span>
<span class="nc" id="L898">						value += 500;</span>
					} else {
<span class="nc bnc" id="L900" title="All 2 branches missed.">						if (getPlayer().getNumberOfSettlements() &lt;= 0) {</span>
<span class="nc" id="L901">							return Integer.MIN_VALUE;</span>
						}
					}
<span class="nc bnc" id="L904" title="All 2 branches missed.">				} else if (target instanceof Unit) {</span>
					// Do not chase units until at least one colony is captured.
<span class="nc bnc" id="L906" title="All 2 branches missed.">					if (getPlayer().getNumberOfSettlements() &lt;= 0) {</span>
<span class="nc" id="L907">						return Integer.MIN_VALUE;</span>
					}
					// Do not chase the same unit!
<span class="nc bnc" id="L910" title="All 4 branches missed.">					if (any(getAIUnits().stream().filter(aiu -&gt; aiu != aiUnit)</span>
<span class="nc" id="L911">							.map(aiu -&gt; aiu.getMission(UnitSeekAndDestroyMission.class)),</span>
<span class="nc bnc" id="L912" title="All 6 branches missed.">							m -&gt; m != null &amp;&amp; m.getTarget() instanceof Unit &amp;&amp; (Unit) m.getTarget() == target))</span>
<span class="nc" id="L913">						return Integer.MIN_VALUE;</span>
					// The REF is more interested in colonies.
<span class="nc" id="L915">					value /= 2;</span>
				}
			}
		}
<span class="nc" id="L919">		return value;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>