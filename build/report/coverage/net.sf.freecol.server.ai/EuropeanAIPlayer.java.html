<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EuropeanAIPlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.ai</a> &gt; <span class="el_source">EuropeanAIPlayer.java</span></div><h1>EuropeanAIPlayer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.ai;

import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.Building;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.DiplomaticTrade.TradeStatus;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.FeatureContainer;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.GoldTradeItem;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.PlayerType;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StanceTradeItem;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TradeItem;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.pathfinding.CostDeciders;
import net.sf.freecol.common.model.pathfinding.GoalDeciders;
import net.sf.freecol.common.networking.NetworkConstants;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;

import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;

import net.sf.freecol.server.ai.mission.BuildColonyMission;
import net.sf.freecol.server.ai.mission.CashInTreasureTrainMission;
import net.sf.freecol.server.ai.mission.DefendSettlementMission;
import net.sf.freecol.server.ai.mission.IdleAtSettlementMission;
import net.sf.freecol.server.ai.mission.Mission;
import net.sf.freecol.server.ai.mission.MissionaryMission;
import net.sf.freecol.server.ai.mission.PioneeringMission;
import net.sf.freecol.server.ai.mission.PrivateerMission;
import net.sf.freecol.server.ai.mission.ScoutingMission;
import net.sf.freecol.server.ai.mission.TransportMission;
import net.sf.freecol.server.ai.mission.UnitSeekAndDestroyMission;
import net.sf.freecol.server.ai.mission.UnitWanderHostileMission;
import net.sf.freecol.server.ai.mission.WishRealizationMission;
import net.sf.freecol.server.ai.mission.WorkInsideColonyMission;
import net.sf.freecol.server.model.ServerPlayer;

/**
 * Objects of this class contains AI-information for a single European
 * {@link Player} and is used for controlling this player.
 *
 * The method {@link #startWorking} gets called by the
 * {@link AIInGameInputHandler} when it is this player's turn.
 */
public class EuropeanAIPlayer extends AIPlayer {

	/** The Constant logger. */
<span class="fc" id="L110">	private static final Logger logger = Logger.getLogger(EuropeanAIPlayer.class.getName());</span>

	/** Maximum number of turns to travel to a building site. */
	private static final int buildingRange = 5;

	/** Maximum number of turns to travel to a cash in location. */
	private static final int cashInRange = 20;

	/** Maximum number of turns to travel to a missionary target. */
	private static final int missionaryRange = 20;

	/**
	 * Maximum number of turns to travel to make progress on pioneering. This is
	 * low-ish because it is usually more efficient to ship the tools where they
	 * are needed and either create a new pioneer on site or send a hardy
	 * pioneer on horseback. The AI is probably smart enough to do the former
	 * already, and one day the latter.
	 */
	private static final int pioneeringRange = 10;

	/**
	 * Maximum number of turns to travel to a privateering target. Low number
	 * because of large naval moves.
	 */
	private static final int privateerRange = 1;

	/** Maximum number of turns to travel to a scouting target. */
	private static final int scoutingRange = 20;

	/**
	 * A comparator to sort units by suitability for a BuildColonyMission.
	 *
	 * Favours unequipped freeColonists, and other unskilled over experts. Also
	 * favour units on the map.
	 */
<span class="fc" id="L145">	private static final Comparator&lt;AIUnit&gt; builderComparator = new Comparator&lt;AIUnit&gt;() {</span>
		private int score(AIUnit a) {
			Unit unit;
<span class="nc bnc" id="L148" title="All 6 branches missed.">			if (a == null || (unit = a.getUnit()) == null || BuildColonyMission.invalidReason(a) != null)</span>
<span class="nc" id="L149">				return -1000;</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">			int base = (!unit.hasDefaultRole()) ? 0</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">					: (unit.getSkillLevel() &gt; 0) ? 100 : 500 + 100 * unit.getSkillLevel();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (unit.hasTile())</span>
<span class="nc" id="L153">				base += 50;</span>
<span class="nc" id="L154">			return base;</span>
		}

		@Override
		public int compare(AIUnit a1, AIUnit a2) {
<span class="nc" id="L159">			return score(a2) - score(a1);</span>
		}
	};

	/**
	 * A comparator to sort units by suitability for a PioneeringMission.
	 *
	 * We do not check if a unit is near to a colony that can provide tools, as
	 * that is likely to be too expensive. FIXME: perhaps we should.
	 */
<span class="fc" id="L169">	public static final Comparator&lt;AIUnit&gt; pioneerComparator = new Comparator&lt;AIUnit&gt;() {</span>
		private int score(AIUnit a) {
			Unit unit;
<span class="nc bnc" id="L172" title="All 4 branches missed.">			return (a == null || (unit = a.getUnit()) == null) ? -1000 : unit.getPioneerScore();</span>
		}

		@Override
		public int compare(AIUnit a1, AIUnit a2) {
<span class="nc" id="L177">			return score(a2) - score(a1);</span>
		}
	};

	/**
	 * A comparator to sort units by suitability for a ScoutingMission.
	 *
	 * We do not check if a unit is near to a colony that can provide horses, as
	 * that is likely to be too expensive. FIXME: perhaps we should.
	 */
<span class="fc" id="L187">	public static final Comparator&lt;AIUnit&gt; scoutComparator = new Comparator&lt;AIUnit&gt;() {</span>
		private int score(AIUnit a) {
			Unit unit;
<span class="nc bnc" id="L190" title="All 4 branches missed.">			return (a == null || (unit = a.getUnit()) == null) ? -1000 : unit.getScoutScore();</span>
		}

		@Override
		public int compare(AIUnit a1, AIUnit a2) {
<span class="nc" id="L195">			return score(a2) - score(a1);</span>
		}
	};

	// These should be final, but need the spec.

	/** Cheat chances. */
	private static int liftBoycottCheatPercent;

	/** The equip scout cheat percent. */
	private static int equipScoutCheatPercent;

	/** The equip pioneer cheat percent. */
	private static int equipPioneerCheatPercent;

	/** The land unit cheat percent. */
	private static int landUnitCheatPercent;

	/** The offensive land unit cheat percent. */
	private static int offensiveLandUnitCheatPercent;

	/** The offensive naval unit cheat percent. */
	private static int offensiveNavalUnitCheatPercent;

	/** The transport naval unit cheat percent. */
	private static int transportNavalUnitCheatPercent;
	/** The pioneer role. */
<span class="fc" id="L222">	private static Role pioneerRole = null;</span>
	/** The scouting role. */
<span class="fc" id="L224">	private static Role scoutRole = null;</span>

	// Caches/internals. Do not serialize.

	/**
	 * Stores temporary information for sessions (trading with another player
	 * etc).
	 */
<span class="fc" id="L232">	private final java.util.Map&lt;String, Integer&gt; sessionRegister = new HashMap&lt;&gt;();</span>

	/**
	 * A cached map of Tile to best TileImprovementPlan. Used to choose a tile
	 * improvement for a pioneer to work on.
	 */
<span class="fc" id="L238">	private final java.util.Map&lt;Tile, TileImprovementPlan&gt; tipMap = new HashMap&lt;&gt;();</span>

	/**
	 * A cached map of destination Location to Wishes awaiting transport.
	 */
<span class="fc" id="L243">	private final java.util.Map&lt;Location, List&lt;Wish&gt;&gt; transportDemand = new HashMap&lt;&gt;();</span>

	/** A cached list of transportables awaiting transport. */
<span class="fc" id="L246">	private final List&lt;TransportableAIObject&gt; transportSupply = new ArrayList&lt;&gt;();</span>

	/**
	 * A mapping of goods type to the goods wishes where a colony has requested
	 * that goods type. Used to retarget goods that have gone astray.
	 */
<span class="fc" id="L252">	private final java.util.Map&lt;GoodsType, List&lt;GoodsWish&gt;&gt; goodsWishes = new HashMap&lt;&gt;();</span>

	/**
	 * A mapping of unit type to the worker wishes for that type. Used to
	 * allocate WishRealizationMissions for units.
	 */
<span class="fc" id="L258">	private final java.util.Map&lt;UnitType, List&lt;WorkerWish&gt;&gt; workerWishes = new HashMap&lt;&gt;();</span>

	/**
	 * A mapping of contiguity number to number of wagons needed in that
	 * landmass.
	 */
<span class="fc" id="L264">	private final java.util.Map&lt;Integer, Integer&gt; wagonsNeeded = new HashMap&lt;&gt;();</span>

	/** The colonies that start the turn badly defended. */
<span class="fc" id="L267">	private final List&lt;AIColony&gt; badlyDefended = new ArrayList&lt;&gt;();</span>

	/**
	 * Current estimate of the number of new &lt;code&gt;BuildColonyMission&lt;/code&gt;s to
	 * create.
	 */
<span class="fc" id="L273">	private int nBuilders = 0;</span>

	/**
	 * Current estimate of the number of new &lt;code&gt;PioneeringMission&lt;/code&gt;s to
	 * create.
	 */
<span class="fc" id="L279">	private int nPioneers = 0;</span>

	/**
	 * Current estimate of the number of new &lt;code&gt;ScoutingMission&lt;/code&gt;s to
	 * create.
	 */
<span class="fc" id="L285">	private int nScouts = 0;</span>

	/** Count of the number of transports needing a naval unit. */
<span class="fc" id="L288">	private int nNavalCarrier = 0;</span>

	/**
	 * Creates a new &lt;code&gt;EuropeanAIPlayer&lt;/code&gt;.
	 *
	 * @param aiMain
	 *            The main AI-class.
	 * @param player
	 *            The player that should be associated with this
	 *            &lt;code&gt;AIPlayer&lt;/code&gt;.
	 */
	public EuropeanAIPlayer(AIMain aiMain, ServerPlayer player) {
<span class="fc" id="L300">		super(aiMain, player);</span>

<span class="pc bpc" id="L302" title="1 of 2 branches missed.">		uninitialized = getPlayer() == null;</span>
<span class="fc" id="L303">	}</span>

	/**
	 * Creates a new &lt;code&gt;AIPlayer&lt;/code&gt;.
	 *
	 * @param aiMain
	 *            The main AI-object.
	 * @param xr
	 *            The input stream containing the XML.
	 * @throws XMLStreamException
	 *             if a problem was encountered during parsing.
	 */
	public EuropeanAIPlayer(AIMain aiMain, FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L316">		super(aiMain, xr);</span>

<span class="pc bpc" id="L318" title="1 of 2 branches missed.">		uninitialized = getPlayer() == null;</span>
<span class="fc" id="L319">	}</span>

	/**
	 * Initialize the static fields that would be final but for needing the
	 * specification.
	 *
	 * @param spec
	 *            The &lt;code&gt;Specification&lt;/code&gt; to initialize from.
	 */
	public static synchronized void initializeFromSpecification(Specification spec) {
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">		if (pioneerRole != null)</span>
<span class="nc" id="L330">			return;</span>
<span class="fc" id="L331">		pioneerRole = spec.getRoleWithAbility(Ability.IMPROVE_TERRAIN, null);</span>
<span class="fc" id="L332">		scoutRole = spec.getRoleWithAbility(Ability.SPEAK_WITH_CHIEF, null);</span>
<span class="fc" id="L333">		liftBoycottCheatPercent = spec.getInteger(GameOptions.LIFT_BOYCOTT_CHEAT);</span>
<span class="fc" id="L334">		equipScoutCheatPercent = spec.getInteger(GameOptions.EQUIP_SCOUT_CHEAT);</span>
<span class="fc" id="L335">		equipPioneerCheatPercent = spec.getInteger(GameOptions.EQUIP_PIONEER_CHEAT);</span>
<span class="fc" id="L336">		landUnitCheatPercent = spec.getInteger(GameOptions.LAND_UNIT_CHEAT);</span>
<span class="fc" id="L337">		offensiveLandUnitCheatPercent = spec.getInteger(GameOptions.OFFENSIVE_LAND_UNIT_CHEAT);</span>
<span class="fc" id="L338">		offensiveNavalUnitCheatPercent = spec.getInteger(GameOptions.OFFENSIVE_NAVAL_UNIT_CHEAT);</span>
<span class="fc" id="L339">		transportNavalUnitCheatPercent = spec.getInteger(GameOptions.TRANSPORT_NAVAL_UNIT_CHEAT);</span>
<span class="fc" id="L340">	}</span>

	/**
	 * Get the list of badly defended colonies.
	 *
	 * @return A list of &lt;code&gt;AIColony&lt;/code&gt;s that were badly defended at the
	 *         start of this turn.
	 */
	protected List&lt;AIColony&gt; getBadlyDefended() {
<span class="nc" id="L349">		return badlyDefended;</span>
	}

	/**
	 * Simple initialization of AI missions given that we know the starting
	 * conditions.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void initializeMissions(LogBuilder lb) {
<span class="fc" id="L360">		final AIMain aiMain = getAIMain();</span>
<span class="fc" id="L361">		List&lt;AIUnit&gt; aiUnits = getAIUnits();</span>
<span class="fc" id="L362">		lb.add(&quot;\n  Initialize &quot;);</span>

		// Find all the carriers with potential colony builders on board,
		// give them missions.
<span class="fc" id="L366">		final Map map = getGame().getMap();</span>
<span class="fc" id="L367">		final int maxRange = map.getWidth() + map.getHeight();</span>
		Location target;
		Mission m;
		TransportMission tm;
<span class="fc bfc" id="L371" title="All 2 branches covered.">		for (AIUnit aiCarrier : aiUnits) {</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">			if (aiCarrier.hasMission())</span>
<span class="fc" id="L373">				continue;</span>
<span class="nc" id="L374">			Unit carrier = aiCarrier.getUnit();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">			if (!carrier.isNaval())</span>
<span class="nc" id="L376">				continue;</span>
<span class="nc" id="L377">			target = null;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">			for (Unit u : carrier.getUnitList()) {</span>
<span class="nc" id="L379">				AIUnit aiu = aiMain.getAIUnit(u);</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">				for (int range = buildingRange; range &lt; maxRange; range += buildingRange) {</span>
<span class="nc" id="L381">					target = BuildColonyMission.findTarget(aiu, range, false);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">					if (target != null)</span>
<span class="nc" id="L383">						break;</span>
				}
<span class="nc bnc" id="L385" title="All 2 branches missed.">				if (target == null) {</span>
<span class="nc" id="L386">					throw new RuntimeException(&quot;Initial colony fail!&quot;);</span>
				}
<span class="nc bnc" id="L388" title="All 2 branches missed.">				if ((m = getBuildColonyMission(aiu, target)) != null) {</span>
<span class="nc" id="L389">					lb.add(m, &quot;, &quot;);</span>
				}
<span class="nc" id="L391">			}</span>
			// Initialize the carrier mission after the cargo units
			// have a valid mission so that the transport list and
			// mission target do not break.
<span class="nc" id="L395">			tm = (TransportMission) getTransportMission(aiCarrier);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">			if (tm != null) {</span>
<span class="nc" id="L397">				lb.add(tm);</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">				for (Unit u : carrier.getUnitList()) {</span>
<span class="nc" id="L399">					AIUnit aiu = getAIMain().getAIUnit(u);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">					if (aiu == null)</span>
<span class="nc" id="L401">						continue;</span>
<span class="nc" id="L402">					tm.queueTransportable(aiu, false, lb);</span>
<span class="nc" id="L403">				}</span>
			}
<span class="nc" id="L405">		}</span>

		// Put in some backup missions.
<span class="fc" id="L408">		lb.mark();</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">		for (AIUnit aiu : aiUnits) {</span>
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">			if (aiu.hasMission())</span>
<span class="fc" id="L411">				continue;</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">			if ((m = getSimpleMission(aiu)) != null)</span>
<span class="nc" id="L413">				lb.add(m, &quot;, &quot;);</span>
<span class="nc" id="L414">		}</span>
<span class="pc bpc" id="L415" title="1 of 2 branches missed.">		if (lb.grew(&quot;\n  Backup: &quot;))</span>
<span class="nc" id="L416">			lb.shrink(&quot;, &quot;);</span>
<span class="fc" id="L417">	}</span>

	/**
	 * Cheat by adding gold to guarantee the player has a minimum amount.
	 *
	 * @param amount
	 *            The minimum amount of gold required.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	public void cheatGold(int amount, LogBuilder lb) {
<span class="nc" id="L428">		final Player player = getPlayer();</span>
<span class="nc" id="L429">		int gold = player.getGold();</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">		if (gold &lt; amount) {</span>
<span class="nc" id="L431">			amount -= gold;</span>
<span class="nc" id="L432">			player.modifyGold(amount);</span>
<span class="nc" id="L433">			lb.add(&quot;added &quot;, amount, &quot; gold&quot;);</span>
		}
<span class="nc" id="L435">		player.logCheat(amount + &quot; gold&quot;);</span>
<span class="nc" id="L436">	}</span>

	/**
	 * Cheats for the AI. Please try to centralize cheats here.
	 *
	 * FIXME: Remove when the AI is good enough.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void cheat(LogBuilder lb) {
<span class="fc" id="L447">		final AIMain aiMain = getAIMain();</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">		if (!aiMain.getFreeColServer().getSinglePlayer())</span>
<span class="nc" id="L449">			return;</span>

<span class="fc" id="L451">		final Player player = getPlayer();</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">		if (player.getPlayerType() != PlayerType.COLONIAL)</span>
<span class="nc" id="L453">			return;</span>
<span class="fc" id="L454">		lb.mark();</span>

<span class="fc" id="L456">		final Specification spec = getSpecification();</span>
<span class="fc" id="L457">		final Game game = getGame();</span>
<span class="fc" id="L458">		final Market market = player.getMarket();</span>
<span class="fc" id="L459">		final Europe europe = player.getEurope();</span>
<span class="fc" id="L460">		final Random air = getAIRandom();</span>
<span class="fc" id="L461">		final List&lt;GoodsType&gt; arrears = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L462" title="1 of 2 branches missed.">		if (market != null) {</span>
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">			arrears.addAll(spec.getGoodsTypeList().stream().filter(gt -&gt; market.getArrears(gt) &gt; 0)</span>
<span class="fc" id="L464">					.collect(Collectors.toList()));</span>
		}
<span class="fc" id="L466">		final int nCheats = arrears.size() + 6; // 6 cheats + arrears</span>
<span class="fc" id="L467">		int[] randoms = randomInts(logger, &quot;cheats&quot;, air, 100, nCheats);</span>
<span class="fc" id="L468">		int cheatIndex = 0;</span>

<span class="pc bpc" id="L470" title="1 of 2 branches missed.">		for (GoodsType goodsType : arrears) {</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">			if (randoms[cheatIndex++] &lt; liftBoycottCheatPercent) {</span>
<span class="nc" id="L472">				market.setArrears(goodsType, 0);</span>
				// Just remove one goods party modifier (we can not
				// currently identify which modifier applies to which
				// goods type, but that is not worth fixing for the
				// benefit of `temporary' cheat code). If we do not
				// do this, AI colonies accumulate heaps of party
				// modifiers because of the cheat boycott removal.
<span class="nc bnc" id="L479" title="All 2 branches missed.">				findOne: for (Colony c : player.getColonies()) {</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">					for (Modifier m : c.getModifiers()) {</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">						if (Specification.COLONY_GOODS_PARTY_SOURCE == m.getSource()) {</span>
<span class="nc" id="L482">							c.removeModifier(m);</span>
<span class="nc" id="L483">							lb.add(&quot;lift-boycott at &quot;, c, &quot;, &quot;);</span>
<span class="nc" id="L484">							player.logCheat(&quot;lift boycott at &quot; + c.getName());</span>
<span class="nc" id="L485">							break findOne;</span>
						}
<span class="nc" id="L487">					}</span>
<span class="nc" id="L488">				}</span>
			}
<span class="nc" id="L490">		}</span>

<span class="pc bpc" id="L492" title="3 of 6 branches missed.">		if (!europe.isEmpty() &amp;&amp; scoutsNeeded() &gt; 0 &amp;&amp; randoms[cheatIndex++] &lt; equipScoutCheatPercent) {</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">			for (Unit u : europe.getUnitList()) {</span>
<span class="nc bnc" id="L494" title="All 4 branches missed.">				if (u.hasDefaultRole() &amp;&amp; u.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="nc" id="L495">					cheatGold(europe.priceGoods(u.getGoodsDifference(scoutRole, 1)), lb);</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">					if (getAIUnit(u).equipForRole(spec.getRoleWithAbility(Ability.SPEAK_WITH_CHIEF, null))) {</span>
<span class="nc" id="L497">						lb.add(&quot; to equip scout &quot;, u, &quot;, &quot;);</span>
<span class="nc" id="L498">						player.logCheat(&quot;Equip scout &quot; + u.toShortString());</span>
					}
					break;
				}
<span class="nc" id="L502">			}</span>
		}

<span class="pc bpc" id="L505" title="4 of 6 branches missed.">		if (!europe.isEmpty() &amp;&amp; pioneersNeeded() &gt; 0 &amp;&amp; randoms[cheatIndex++] &lt; equipPioneerCheatPercent) {</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">			for (Unit u : europe.getUnitList()) {</span>
<span class="nc bnc" id="L507" title="All 4 branches missed.">				if (u.hasDefaultRole() &amp;&amp; u.hasAbility(Ability.CAN_BE_EQUIPPED)) {</span>
<span class="nc" id="L508">					cheatGold(europe.priceGoods(u.getGoodsDifference(pioneerRole, 1)), lb);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">					if (getAIUnit(u).equipForRole(spec.getRoleWithAbility(Ability.IMPROVE_TERRAIN, null))) {</span>
<span class="nc" id="L510">						lb.add(&quot; to equip pioneer &quot;, u, &quot;, &quot;);</span>
<span class="nc" id="L511">						player.logCheat(&quot;Equip pioneer &quot; + u.toShortString());</span>
					}
					break;
				}
<span class="nc" id="L515">			}</span>
		}

<span class="pc bpc" id="L518" title="1 of 2 branches missed.">		if (randoms[cheatIndex++] &lt; landUnitCheatPercent) {</span>
<span class="nc" id="L519">			WorkerWish bestWish = null;</span>
<span class="nc" id="L520">			int bestValue = Integer.MIN_VALUE;</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">			for (UnitType ut : workerWishes.keySet()) {</span>
<span class="nc" id="L522">				List&lt;WorkerWish&gt; wl = workerWishes.get(ut);</span>
<span class="nc bnc" id="L523" title="All 8 branches missed.">				if (wl == null || wl.isEmpty() || ut == null || !ut.isAvailableTo(player)</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">						|| europe.getUnitPrice(ut) == UNDEFINED)</span>
<span class="nc" id="L525">					continue;</span>
<span class="nc" id="L526">				WorkerWish ww = wl.get(0);</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">				if (bestValue &lt; ww.getValue()) {</span>
<span class="nc" id="L528">					bestValue = ww.getValue();</span>
<span class="nc" id="L529">					bestWish = ww;</span>
				}
<span class="nc" id="L531">			}</span>

			int cost;
<span class="nc bnc" id="L534" title="All 2 branches missed.">			if (bestWish != null) {</span>
<span class="nc" id="L535">				cost = europe.getUnitPrice(bestWish.getUnitType());</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">			} else if (player.getImmigration() &lt; player.getImmigrationRequired() / 2) {</span>
<span class="nc" id="L537">				cost = player.getRecruitPrice();</span>
			} else {
<span class="nc" id="L539">				cost = INFINITY;</span>
			}
<span class="nc bnc" id="L541" title="All 2 branches missed.">			if (cost != INFINITY) {</span>
<span class="nc" id="L542">				cheatGold(cost, lb);</span>
				AIUnit aiu;
<span class="nc bnc" id="L544" title="All 2 branches missed.">				if (bestWish == null) {</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">					if ((aiu = recruitAIUnitInEurope(-1)) != null) {</span>
						// let giveNormalMissions look after the mission
<span class="nc" id="L547">						lb.add(&quot; to recruit &quot;, aiu.getUnit(), &quot;, &quot;);</span>
					}
				} else {
<span class="nc bnc" id="L550" title="All 2 branches missed.">					if ((aiu = trainAIUnitInEurope(bestWish.getUnitType())) != null) {</span>
<span class="nc" id="L551">						Mission m = getWishRealizationMission(aiu, bestWish);</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">						if (m != null) {</span>
<span class="nc" id="L553">							lb.add(&quot; to train for &quot;, m, &quot;, &quot;);</span>
						} else {
<span class="nc" id="L555">							lb.add(&quot; to train &quot;, aiu.getUnit(), &quot;, &quot;);</span>
						}
					}
				}
<span class="nc bnc" id="L559" title="All 2 branches missed.">				if (aiu != null)</span>
<span class="nc" id="L560">					player.logCheat(&quot;Make &quot; + aiu.getUnit());</span>
			}
		}

<span class="pc bpc" id="L564" title="5 of 6 branches missed.">		if (game.getTurn().getNumber() &gt; 300 &amp;&amp; player.isAtWar()</span>
				&amp;&amp; randoms[cheatIndex++] &lt; offensiveLandUnitCheatPercent) {
			// Find a target to attack.
<span class="nc" id="L567">			Location target = null;</span>
			// - collect enemies, prefer not to antagonize the strong or
			// crush the weak
<span class="nc" id="L570">			List&lt;Player&gt; enemies = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L571">			List&lt;Player&gt; preferred = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">			for (Player p : game.getLivePlayers(player)) {</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">				if (player.atWarWith(p)) {</span>
<span class="nc" id="L574">					enemies.add(p);</span>
<span class="nc" id="L575">					double strength = getStrengthRatio(p);</span>
<span class="nc bnc" id="L576" title="All 4 branches missed.">					if (strength &lt; 3.0 / 2.0 &amp;&amp; strength &gt; 2.0 / 3.0) {</span>
<span class="nc" id="L577">						preferred.add(p);</span>
					}
				}
<span class="nc" id="L580">			}</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">			if (!preferred.isEmpty()) {</span>
<span class="nc" id="L582">				enemies.clear();</span>
<span class="nc" id="L583">				enemies.addAll(preferred);</span>
			}
<span class="nc" id="L585">			List&lt;Colony&gt; colonies = player.getColonies();</span>
			// Few colonies? Attack the weakest European port
<span class="nc bnc" id="L587" title="All 2 branches missed.">			if (colonies.size() &lt; 3) {</span>
<span class="nc" id="L588">				List&lt;Colony&gt; targets = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">				for (Player p : enemies) {</span>
<span class="nc bnc" id="L590" title="All 2 branches missed.">					if (p.isEuropean())</span>
<span class="nc" id="L591">						targets.addAll(p.getColonies());</span>
<span class="nc" id="L592">				}</span>
<span class="nc" id="L593">				double targetScore = -1;</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">				for (Colony c : targets) {</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">					if (c.isConnectedPort()) {</span>
<span class="nc" id="L596">						double score = 100000.0 / c.getUnitCount();</span>
<span class="nc" id="L597">						Building stockade = c.getStockade();</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">						score /= (stockade == null) ? 1.0 : (stockade.getLevel() + 1.5);</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">						if (targetScore &lt; score) {</span>
<span class="nc" id="L600">							targetScore = score;</span>
<span class="nc" id="L601">							target = c;</span>
						}
					}
<span class="nc" id="L604">				}</span>
			}
			// Otherwise attack something near a weak colony
<span class="nc bnc" id="L607" title="All 4 branches missed.">			if (target == null &amp;&amp; !colonies.isEmpty()) {</span>
<span class="nc" id="L608">				List&lt;AIColony&gt; bad = new ArrayList&lt;&gt;(getBadlyDefended());</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">				if (bad.isEmpty())</span>
<span class="nc" id="L610">					bad.addAll(getAIColonies());</span>
<span class="nc" id="L611">				AIColony defend = getRandomMember(logger, &quot;AIColony to defend&quot;, bad, air);</span>
<span class="nc" id="L612">				Tile center = defend.getColony().getTile();</span>
<span class="nc" id="L613">				Tile t = game.getMap().searchCircle(center, GoalDeciders.getEnemySettlementGoalDecider(enemies), 30);</span>
<span class="nc bnc" id="L614" title="All 2 branches missed.">				if (t != null)</span>
<span class="nc" id="L615">					target = t.getSettlement();</span>
			}
<span class="nc bnc" id="L617" title="All 2 branches missed.">			if (target != null) {</span>
<span class="nc" id="L618">				List&lt;Unit&gt; mercs = ((ServerPlayer) player).createUnits(player.getMonarch().getMercenaries(air), europe);</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">				for (Unit u : mercs) {</span>
<span class="nc" id="L620">					AIUnit aiu = getAIUnit(u);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">					if (aiu == null)</span>
<span class="nc" id="L622">						continue; // Can not happen</span>
<span class="nc" id="L623">					player.logCheat(&quot;Enlist &quot; + aiu.getUnit());</span>
<span class="nc" id="L624">					Mission m = getSeekAndDestroyMission(aiu, target);</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">					if (m != null) {</span>
<span class="nc" id="L626">						lb.add(&quot;enlisted &quot;, m, &quot;, &quot;);</span>
					} else {
<span class="nc" id="L628">						lb.add(&quot;enlisted &quot;, aiu.getUnit(), &quot;, &quot;);</span>
					}
<span class="nc" id="L630">				}</span>
			}
		}

		// Always cheat a new armed ship if the navy is destroyed,
		// otherwise if the navy is below average the chance to cheat
		// is proportional to how badly below average.
<span class="fc" id="L637">		double naval = getNavalStrengthRatio();</span>
<span class="pc bpc" id="L638" title="4 of 6 branches missed.">		int nNaval = (player.getUnitCount(true) == 0) ? 100</span>
				: (0.0f &lt; naval &amp;&amp; naval &lt; 0.5f) ? (int) (naval * offensiveNavalUnitCheatPercent) : -1;
<span class="fc" id="L640">		List&lt;RandomChoice&lt;UnitType&gt;&gt; rc = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L641" title="1 of 2 branches missed.">		if (randoms[cheatIndex++] &lt; nNaval) {</span>
<span class="nc" id="L642">			rc.clear();</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">			for (UnitType unitType : spec.getUnitTypeList()) {</span>
<span class="nc bnc" id="L644" title="All 6 branches missed.">				if (unitType.hasAbility(Ability.NAVAL_UNIT) &amp;&amp; unitType.isAvailableTo(player) &amp;&amp; unitType.hasPrice()</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">						&amp;&amp; unitType.isOffensive()) {</span>
<span class="nc" id="L646">					int weight = 100000 / europe.getUnitPrice(unitType);</span>
<span class="nc" id="L647">					rc.add(new RandomChoice&lt;&gt;(unitType, weight));</span>
				}
<span class="nc" id="L649">			}</span>
<span class="nc" id="L650">			cheatUnit(rc, &quot;offensive-naval&quot;, lb);</span>
		}
		// Only cheat carriers if they have work to do.
<span class="pc bpc" id="L653" title="1 of 2 branches missed.">		int nCarrier = (nNavalCarrier &gt; 0) ? transportNavalUnitCheatPercent : -1;</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">		if (randoms[cheatIndex++] &lt; nCarrier) {</span>
<span class="nc" id="L655">			rc.clear();</span>
<span class="nc bnc" id="L656" title="All 2 branches missed.">			for (UnitType unitType : spec.getUnitTypeList()) {</span>
<span class="nc bnc" id="L657" title="All 6 branches missed.">				if (unitType.hasAbility(Ability.NAVAL_UNIT) &amp;&amp; unitType.isAvailableTo(player) &amp;&amp; unitType.hasPrice()</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">						&amp;&amp; unitType.getSpace() &gt; 0) {</span>
<span class="nc" id="L659">					int weight = 100000 / europe.getUnitPrice(unitType);</span>
<span class="nc" id="L660">					rc.add(new RandomChoice&lt;&gt;(unitType, weight));</span>
				}
<span class="nc" id="L662">			}</span>
<span class="nc" id="L663">			cheatUnit(rc, &quot;transport-naval&quot;, lb);</span>
		}

<span class="pc bpc" id="L666" title="1 of 2 branches missed.">		if (lb.grew(&quot;\n  Cheats: &quot;))</span>
<span class="nc" id="L667">			lb.shrink(&quot;, &quot;);</span>
<span class="fc" id="L668">	}</span>

	/**
	 * Cheat-build a unit in Europe.
	 *
	 * @param rc
	 *            A list of random choices to choose from.
	 * @param what
	 *            A description of the unit.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @return The &lt;code&gt;AIUnit&lt;/code&gt; built.
	 */
	private AIUnit cheatUnit(List&lt;RandomChoice&lt;UnitType&gt;&gt; rc, String what, LogBuilder lb) {
<span class="nc" id="L682">		UnitType unitToPurchase = RandomChoice.getWeightedRandom(logger, &quot;Cheat which unit&quot;, rc, getAIRandom());</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">		return (unitToPurchase == null) ? null : cheatUnit(unitToPurchase, what, lb);</span>
	}

	/**
	 * Cheat-build a unit in Europe.
	 *
	 * @param unitType
	 *            The &lt;code&gt;UnitType&lt;/code&gt; to build.
	 * @param what
	 *            A description of the unit.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @return The &lt;code&gt;AIUnit&lt;/code&gt; built.
	 */
	private AIUnit cheatUnit(UnitType unitType, String what, LogBuilder lb) {
<span class="nc" id="L698">		final Player player = getPlayer();</span>
<span class="nc" id="L699">		final Europe europe = player.getEurope();</span>
<span class="nc" id="L700">		int cost = europe.getUnitPrice(unitType);</span>
<span class="nc" id="L701">		cheatGold(cost, lb);</span>
<span class="nc" id="L702">		AIUnit result = trainAIUnitInEurope(unitType);</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">		lb.add(&quot; to build &quot;, what, &quot; &quot;, unitType.getSuffix(), ((result != null) ? &quot;&quot; : &quot;(failed)&quot;), &quot;, &quot;);</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">		if (result == null)</span>
<span class="nc" id="L705">			return null;</span>
<span class="nc" id="L706">		player.logCheat(&quot;Build &quot; + result.getUnit());</span>
<span class="nc" id="L707">		return result;</span>
	}

	/**
	 * Assign transportable units and goods to available carriers.
	 *
	 * These supply driven assignments supplement the demand driven calls inside
	 * TransportMission.
	 *
	 * @param transportables
	 *            A list of &lt;code&gt;TransportableAIObject&lt;/code&gt;s to allocated
	 *            transport for.
	 * @param missions
	 *            A list of &lt;code&gt;TransportMission&lt;/code&gt;s to potentially assign
	 *            more transportables to.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	public void allocateTransportables(List&lt;TransportableAIObject&gt; transportables, List&lt;TransportMission&gt; missions,
			LogBuilder lb) {
<span class="pc bpc" id="L727" title="1 of 2 branches missed.">		if (transportables.isEmpty())</span>
<span class="fc" id="L728">			return;</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">		if (missions.isEmpty())</span>
<span class="nc" id="L730">			return;</span>

<span class="nc" id="L732">		lb.add(&quot;\n  Allocate Transport cargo=&quot;, transportables.size(), &quot; carriers=&quot;, missions.size());</span>
		// for (TransportableAIObject t : urgent) lb.add(&quot; &quot;, t);
		// lb.add(&quot; -&gt;&quot;);
		// for (Mission m : missions) lb.add(&quot; &quot;, m);

<span class="nc" id="L737">		LogBuilder lb2 = new LogBuilder(0);</span>
		TransportMission best;
		float bestValue;
		boolean present;
<span class="nc" id="L741">		int i = 0;</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">		outer: while (i &lt; transportables.size()) {</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">			if (missions.isEmpty())</span>
<span class="nc" id="L744">				break;</span>
<span class="nc" id="L745">			TransportableAIObject t = transportables.get(i);</span>
<span class="nc" id="L746">			lb.add(&quot; for &quot;, t);</span>
<span class="nc" id="L747">			best = null;</span>
<span class="nc" id="L748">			bestValue = 0.0f;</span>
<span class="nc" id="L749">			present = false;</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">			for (TransportMission tm : missions) {</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">				if (!tm.spaceAvailable(t))</span>
<span class="nc" id="L752">					continue;</span>
<span class="nc" id="L753">				Cargo cargo = tm.makeCargo(t, lb2);</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">				if (cargo == null) { // Serious problem with this cargo</span>
<span class="nc" id="L755">					transportables.remove(i);</span>
<span class="nc" id="L756">					continue outer;</span>
				}
<span class="nc" id="L758">				int turns = cargo.getTurns();</span>
				float value;
<span class="nc bnc" id="L760" title="All 2 branches missed.">				if (turns == 0) {</span>
<span class="nc" id="L761">					value = tm.destinationCapacity();</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">					if (!present)</span>
<span class="nc" id="L763">						bestValue = 0.0f; // reset</span>
<span class="nc" id="L764">					present = true;</span>
				} else {
<span class="nc bnc" id="L766" title="All 2 branches missed.">					value = (present) ? -1.0f : (float) t.getTransportPriority() / turns;</span>
				}
<span class="nc bnc" id="L768" title="All 2 branches missed.">				if (bestValue &lt; value) {</span>
<span class="nc" id="L769">					bestValue = value;</span>
<span class="nc" id="L770">					best = tm;</span>
				}
<span class="nc" id="L772">			}</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">			if (best == null) {</span>
<span class="nc" id="L774">				lb.add(&quot; nothing found&quot;);</span>
			} else {
<span class="nc" id="L776">				lb.add(&quot; &quot;, best.getUnit(), &quot; chosen&quot;);</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">				if (best.queueTransportable(t, false, lb)) {</span>
<span class="nc" id="L778">					claimTransportable(t);</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">					if (best.destinationCapacity() &lt;= 0) {</span>
<span class="nc" id="L780">						missions.remove(best);</span>
					}
				} else {
<span class="nc" id="L783">					missions.remove(best);</span>
				}
			}
<span class="nc" id="L786">			i++;</span>
<span class="nc" id="L787">		}</span>
<span class="nc" id="L788">	}</span>

	/**
	 * Brings gifts to nice players with nearby colonies.
	 *
	 * FIXME: European players can also bring gifts! However, this might be
	 * folded into a trade mission, since European gifts are just a special case
	 * of trading.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void bringGifts(LogBuilder lb) {
<span class="fc" id="L801">		return;</span>
	}

	/**
	 * Demands goods from players with nearby colonies.
	 *
	 * FIXME: European players can also demand tribute!
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void demandTribute(LogBuilder lb) {
<span class="fc" id="L813">		return;</span>
	}

	// Tile Improvement handling

	/**
	 * Rebuilds a map of locations to TileImprovementPlans.
	 *
	 * Called by startWorking at the start of every turn. Public for the test
	 * suite.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	public void buildTipMap(LogBuilder lb) {
<span class="fc" id="L828">		tipMap.clear();</span>
<span class="fc bfc" id="L829" title="All 2 branches covered.">		for (AIColony aic : getAIColonies()) {</span>
<span class="fc bfc" id="L830" title="All 2 branches covered.">			for (TileImprovementPlan tip : aic.getTileImprovementPlans()) {</span>
<span class="pc bpc" id="L831" title="2 of 4 branches missed.">				if (tip == null || tip.isComplete()) {</span>
<span class="nc" id="L832">					aic.removeTileImprovementPlan(tip);</span>
<span class="pc bpc" id="L833" title="1 of 2 branches missed.">				} else if (tip.getPioneer() != null) {</span>
					; // Do nothing, remove when complete
<span class="pc bpc" id="L835" title="1 of 2 branches missed.">				} else if (!tip.validate()) {</span>
<span class="nc" id="L836">					aic.removeTileImprovementPlan(tip);</span>
<span class="nc" id="L837">					tip.dispose();</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">				} else if (tip.getTarget() == null) {</span>
<span class="nc" id="L839">					logger.warning(&quot;No target for tip: &quot; + tip);</span>
				} else {
<span class="fc" id="L841">					TileImprovementPlan other = tipMap.get(tip.getTarget());</span>
<span class="pc bpc" id="L842" title="3 of 4 branches missed.">					if (other == null || other.getValue() &lt; tip.getValue()) {</span>
<span class="fc" id="L843">						tipMap.put(tip.getTarget(), tip);</span>
					}
				}
<span class="fc" id="L846">			}</span>
<span class="fc" id="L847">		}</span>
<span class="pc bpc" id="L848" title="1 of 2 branches missed.">		if (!tipMap.isEmpty()) {</span>
<span class="fc" id="L849">			lb.add(&quot;\n  Improvements:&quot;);</span>
<span class="fc bfc" id="L850" title="All 2 branches covered.">			for (Tile t : tipMap.keySet()) {</span>
<span class="fc" id="L851">				TileImprovementPlan tip = tipMap.get(t);</span>
<span class="fc" id="L852">				AIUnit pioneer = tip.getPioneer();</span>
<span class="fc" id="L853">				lb.add(&quot; &quot;, t, &quot;=&quot;, tip.getType().getSuffix());</span>
<span class="pc bpc" id="L854" title="1 of 2 branches missed.">				if (pioneer != null)</span>
<span class="nc" id="L855">					lb.add(&quot;/&quot;, pioneer.getUnit());</span>
<span class="fc" id="L856">			}</span>
		}
<span class="fc" id="L858">	}</span>

	/**
	 * Update the tip map with tips from a new colony.
	 *
	 * @param aic
	 *            The new &lt;code&gt;AIColony&lt;/code&gt;.
	 */
	private void updateTipMap(AIColony aic) {
<span class="nc bnc" id="L867" title="All 2 branches missed.">		for (TileImprovementPlan tip : aic.getTileImprovementPlans()) {</span>
<span class="nc" id="L868">			tipMap.put(tip.getTarget(), tip);</span>
<span class="nc" id="L869">		}</span>
<span class="nc" id="L870">	}</span>

	/**
	 * Gets the best plan for a tile from the tipMap.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to lookup.
	 * @return The best plan for a tile.
	 */
	public TileImprovementPlan getBestPlan(Tile tile) {
<span class="pc bpc" id="L880" title="1 of 2 branches missed.">		return (tipMap == null) ? null : tipMap.get(tile);</span>
	}

	/**
	 * Gets the best plan for a colony from the tipMap.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to check.
	 * @return The tile with the best plan for a colony, or null if none found.
	 */
	public Tile getBestPlanTile(Colony colony) {
<span class="nc" id="L891">		TileImprovementPlan best = null;</span>
<span class="nc" id="L892">		int bestValue = Integer.MIN_VALUE;</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">		for (Tile t : colony.getOwnedTiles()) {</span>
<span class="nc" id="L894">			TileImprovementPlan tip = tipMap.get(t);</span>
<span class="nc bnc" id="L895" title="All 4 branches missed.">			if (tip != null &amp;&amp; tip.getValue() &gt; bestValue) {</span>
<span class="nc" id="L896">				bestValue = tip.getValue();</span>
<span class="nc" id="L897">				best = tip;</span>
			}
<span class="nc" id="L899">		}</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">		return (best == null) ? null : best.getTarget();</span>
	}

	/**
	 * Remove a &lt;code&gt;TileImprovementPlan&lt;/code&gt; from the relevant colony.
	 *
	 * @param plan
	 *            the plan
	 */
	public void removeTileImprovementPlan(TileImprovementPlan plan) {
<span class="pc bpc" id="L910" title="1 of 2 branches missed.">		if (plan == null)</span>
<span class="nc" id="L911">			return;</span>
<span class="pc bpc" id="L912" title="1 of 2 branches missed.">		if (plan.getTarget() != null)</span>
<span class="fc" id="L913">			tipMap.remove(plan.getTarget());</span>
<span class="pc bpc" id="L914" title="1 of 2 branches missed.">		for (AIColony aic : getAIColonies()) {</span>
<span class="pc bpc" id="L915" title="1 of 2 branches missed.">			if (aic.removeTileImprovementPlan(plan))</span>
<span class="fc" id="L916">				break;</span>
<span class="nc" id="L917">		}</span>
<span class="fc" id="L918">	}</span>

	// Transport handling

	/**
	 * Update the transport of a unit following a target change.
	 *
	 * If the target has changed - drop all non-boarded transport unless the
	 * target is the same - dump boarded transport with no target - requeue all
	 * boarded transport unless the target is the same
	 *
	 * @param aiu
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param oldTarget
	 *            The old target &lt;code&gt;Location&lt;/code&gt;.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	public void updateTransport(AIUnit aiu, Location oldTarget, LogBuilder lb) {
<span class="fc" id="L937">		final AIUnit aiCarrier = aiu.getTransport();</span>
<span class="fc" id="L938">		final Mission newMission = aiu.getMission();</span>
<span class="pc bpc" id="L939" title="1 of 2 branches missed.">		final Location newTarget = (newMission == null) ? null : newMission.getTarget();</span>
		TransportMission tm;
<span class="pc bpc" id="L941" title="3 of 4 branches missed.">		if (aiCarrier != null &amp;&amp; (tm = aiCarrier.getMission(TransportMission.class)) != null</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">				&amp;&amp; !Map.isSameLocation(oldTarget, newTarget)) {</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">			if (aiu.getUnit().getLocation() != aiCarrier.getUnit()) {</span>
<span class="nc" id="L944">				lb.add(&quot;, drop transport &quot;, aiCarrier.getUnit());</span>
<span class="nc" id="L945">				aiu.dropTransport();</span>
<span class="nc bnc" id="L946" title="All 2 branches missed.">			} else if (newTarget == null) {</span>
<span class="nc" id="L947">				tm.dumpTransportable(aiu, lb);</span>
			} else {
<span class="nc" id="L949">				tm.requeueTransportable(aiu, lb);</span>
			}
		}
<span class="fc" id="L952">	}</span>

	/**
	 * Checks if a transportable needs transport.
	 *
	 * @param t
	 *            The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
	 * @return True if no transport is already present or the transportable is
	 *         already aboard a carrier, and there is a well defined source and
	 *         destination location.
	 */
	private boolean requestsTransport(TransportableAIObject t) {
<span class="nc bnc" id="L964" title="All 6 branches missed.">		return t.getTransport() == null &amp;&amp; t.getTransportDestination() != null &amp;&amp; t.getTransportSource() != null</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">				&amp;&amp; !(t.getLocation() instanceof Unit);</span>
	}

	/**
	 * Checks that the carrier assigned to a transportable is has a transport
	 * mission and the transport is queued thereon.
	 *
	 * @param t
	 *            The &lt;code&gt;TransportableAIObject&lt;/code&gt; to check.
	 * @return True if all is well.
	 */
	private boolean checkTransport(TransportableAIObject t) {
<span class="nc" id="L977">		AIUnit aiCarrier = t.getTransport();</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">		if (aiCarrier == null)</span>
<span class="nc" id="L979">			return false;</span>
<span class="nc" id="L980">		TransportMission tm = aiCarrier.getMission(TransportMission.class);</span>
<span class="nc bnc" id="L981" title="All 4 branches missed.">		if (tm != null &amp;&amp; tm.isTransporting(t))</span>
<span class="nc" id="L982">			return true;</span>
<span class="nc" id="L983">		t.changeTransport(null);</span>
<span class="nc" id="L984">		return false;</span>
	}

	/**
	 * Gets the needed wagons for a tile/contiguity.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to derive the contiguity from.
	 * @return The number of wagons needed.
	 */
	public int getNeededWagons(Tile tile) {
<span class="pc bpc" id="L995" title="1 of 2 branches missed.">		if (tile != null) {</span>
<span class="fc" id="L996">			int contig = tile.getContiguity();</span>
<span class="pc bpc" id="L997" title="1 of 2 branches missed.">			if (contig &gt; 0) {</span>
<span class="nc" id="L998">				Integer i = wagonsNeeded.get(contig);</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">				if (i != null)</span>
<span class="nc" id="L1000">					return i;</span>
			}
		}
<span class="fc" id="L1003">		return 0;</span>
	}

	/**
	 * Changes the needed wagons map for a specified tile/contiguity. If the
	 * change is zero, that is a special flag that a connected port is
	 * available, and thus that the map should be initialized for that
	 * contiguity.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to derive the contiguity from.
	 * @param amount
	 *            The change to make.
	 */
	private void changeNeedWagon(Tile tile, int amount) {
<span class="nc bnc" id="L1018" title="All 2 branches missed.">		if (tile == null)</span>
<span class="nc" id="L1019">			return;</span>
<span class="nc" id="L1020">		int contig = tile.getContiguity();</span>
<span class="nc bnc" id="L1021" title="All 2 branches missed.">		if (contig &gt; 0) {</span>
<span class="nc" id="L1022">			Integer i = wagonsNeeded.get(contig);</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">			if (i == null) {</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">				if (amount == 0)</span>
<span class="nc" id="L1025">					wagonsNeeded.put(contig, 0);</span>
			} else {
<span class="nc" id="L1027">				wagonsNeeded.put(contig, i + amount);</span>
			}
		}
<span class="nc" id="L1030">	}</span>

	/**
	 * Rebuild the transport maps. Count the number of transports requiring
	 * naval/land carriers.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void buildTransportMaps(LogBuilder lb) {
<span class="fc" id="L1040">		transportDemand.clear();</span>
<span class="fc" id="L1041">		transportSupply.clear();</span>
<span class="fc" id="L1042">		wagonsNeeded.clear();</span>
<span class="fc" id="L1043">		nNavalCarrier = 0;</span>

		// Prime the wagonsNeeded map with contiguities with a connected port
<span class="pc bpc" id="L1046" title="1 of 2 branches missed.">		for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L1047">			Colony colony = aic.getColony();</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">			if (colony.isConnectedPort())</span>
<span class="nc" id="L1049">				changeNeedWagon(colony.getTile(), 0);</span>
<span class="nc" id="L1050">		}</span>

<span class="fc bfc" id="L1052" title="All 2 branches covered.">		for (AIUnit aiu : getAIUnits()) {</span>
<span class="pc bpc" id="L1053" title="2 of 4 branches missed.">			if (aiu.hasMission() &amp;&amp; !aiu.getMission().isValid())</span>
<span class="fc" id="L1054">				continue;</span>
<span class="nc" id="L1055">			Unit u = aiu.getUnit();</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">			if (u.isCarrier()) {</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">				if (u.isNaval()) {</span>
<span class="nc" id="L1058">					nNavalCarrier--;</span>
				} else {
<span class="nc" id="L1060">					changeNeedWagon(u.getTile(), -1);</span>
				}
			} else {
<span class="nc" id="L1063">				checkTransport(aiu);</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">				if (requestsTransport(aiu)) {</span>
<span class="nc" id="L1065">					transportSupply.add(aiu);</span>
<span class="nc" id="L1066">					aiu.incrementTransportPriority();</span>
<span class="nc" id="L1067">					nNavalCarrier++;</span>
				}
			}
<span class="nc" id="L1070">		}</span>

<span class="pc bpc" id="L1072" title="1 of 2 branches missed.">		for (AIColony aic : getAIColonies()) {</span>
<span class="nc bnc" id="L1073" title="All 2 branches missed.">			for (AIGoods aig : aic.getExportGoods()) {</span>
<span class="nc" id="L1074">				checkTransport(aig);</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">				if (requestsTransport(aig)) {</span>
<span class="nc" id="L1076">					transportSupply.add(aig);</span>
<span class="nc" id="L1077">					aig.incrementTransportPriority();</span>
<span class="nc" id="L1078">					Location src = aig.getTransportSource();</span>
<span class="nc" id="L1079">					Location dst = aig.getTransportDestination();</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">					if (!Map.isSameContiguity(src, dst)) {</span>
<span class="nc" id="L1081">						nNavalCarrier++;</span>
					}
				}
<span class="nc" id="L1084">			}</span>
<span class="nc" id="L1085">			Colony colony = aic.getColony();</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">			if (!colony.isConnectedPort()) {</span>
<span class="nc" id="L1087">				changeNeedWagon(colony.getTile(), 1);</span>
			}
<span class="nc" id="L1089">		}</span>

<span class="pc bpc" id="L1091" title="1 of 2 branches missed.">		for (Wish w : getWishes()) {</span>
<span class="nc" id="L1092">			TransportableAIObject t = w.getTransportable();</span>
<span class="nc bnc" id="L1093" title="All 6 branches missed.">			if (t != null &amp;&amp; t.getTransport() == null &amp;&amp; t.getTransportDestination() != null) {</span>
<span class="nc" id="L1094">				Location loc = Location.upLoc(t.getTransportDestination());</span>
<span class="nc" id="L1095">				appendToMapList(transportDemand, loc, w);</span>
			}
<span class="nc" id="L1097">		}</span>

<span class="pc bpc" id="L1099" title="1 of 2 branches missed.">		if (!transportSupply.isEmpty()) {</span>
<span class="nc" id="L1100">			lb.add(&quot;\n  Transport Supply:&quot;);</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">			for (TransportableAIObject t : transportSupply) {</span>
<span class="nc" id="L1102">				lb.add(&quot; &quot;, t.getTransportPriority(), &quot;+&quot;, t);</span>
<span class="nc" id="L1103">			}</span>
		}
<span class="pc bpc" id="L1105" title="1 of 2 branches missed.">		if (!transportDemand.isEmpty()) {</span>
<span class="nc" id="L1106">			lb.add(&quot;\n  Transport Demand:&quot;);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">			for (Location ld : transportDemand.keySet()) {</span>
<span class="nc" id="L1108">				lb.add(&quot;\n    &quot;, ld, &quot;[&quot;);</span>
<span class="nc bnc" id="L1109" title="All 2 branches missed.">				for (Wish w : transportDemand.get(ld))</span>
<span class="nc" id="L1110">					lb.add(&quot; &quot;, w);</span>
<span class="nc" id="L1111">				lb.add(&quot; ]&quot;);</span>
<span class="nc" id="L1112">			}</span>
		}
<span class="fc" id="L1114">	}</span>

	/**
	 * Gets the most urgent transportables.
	 *
	 * @return The most urgent 10% of the available transportables.
	 */
	public List&lt;TransportableAIObject&gt; getUrgentTransportables() {
<span class="fc" id="L1122">		List&lt;TransportableAIObject&gt; urgent = new ArrayList&lt;&gt;(transportSupply);</span>
		// Do not let the list exceed 10% of all transports
<span class="fc" id="L1124">		Collections.sort(urgent);</span>
<span class="fc" id="L1125">		int urge = urgent.size();</span>
<span class="fc" id="L1126">		urge = Math.max(2, (urge + 5) / 10);</span>
<span class="pc bpc" id="L1127" title="1 of 2 branches missed.">		while (urgent.size() &gt; urge)</span>
<span class="nc" id="L1128">			urgent.remove(urge);</span>
<span class="fc" id="L1129">		return urgent;</span>
	}

	/**
	 * Allows a TransportMission to signal that it has taken responsibility for
	 * a TransportableAIObject.
	 *
	 * @param t
	 *            The &lt;code&gt;TransportableAIObject&lt;/code&gt; being claimed.
	 * @return True if the transportable was claimed from the supply map.
	 */
	public boolean claimTransportable(TransportableAIObject t) {
<span class="nc" id="L1141">		return transportSupply.remove(t);</span>
	}

	/**
	 * Rearrange colonies, collecting workers that now need a
	 * WorkInsideColonyMission.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 * @return A collection of &lt;code&gt;AIUnit&lt;/code&gt;s that need work.
	 */
	private Collection&lt;AIUnit&gt; rearrangeColonies(LogBuilder lb) {
<span class="fc" id="L1153">		Set&lt;AIUnit&gt; workers = new HashSet&lt;&gt;();</span>
<span class="pc bpc" id="L1154" title="1 of 2 branches missed.">		for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L1155">			workers.addAll(aic.rearrangeWorkers(lb));</span>
<span class="nc" id="L1156">		}</span>
<span class="fc" id="L1157">		return workers;</span>
	}

	// Wish handling

	/**
	 * Suppress European trade in a goods type. A goods party and boycott is
	 * incoming.
	 *
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to suppress.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void suppressEuropeanTrade(GoodsType type, LogBuilder lb) {
<span class="nc" id="L1172">		final Player player = getPlayer();</span>
<span class="nc" id="L1173">		final Europe europe = player.getEurope();</span>

<span class="nc" id="L1175">		lb.add(&quot;  Suppressing trade in &quot;, type.getSuffix());</span>
<span class="nc" id="L1176">		List&lt;Unit&gt; units = new ArrayList&lt;&gt;(europe.getUnitList());</span>
<span class="nc" id="L1177">		units.addAll(player.getHighSeas().getUnitList());</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">		for (Unit u : units) {</span>
			int amount;
			AIUnit aiu;
<span class="nc bnc" id="L1181" title="All 6 branches missed.">			if (u.isCarrier() &amp;&amp; (amount = u.getGoodsCount(type)) &gt; 0 &amp;&amp; (aiu = getAIUnit(u)) != null</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">					&amp;&amp; AIMessage.askUnloadGoods(type, amount, aiu)) {</span>
<span class="nc" id="L1183">				lb.add(&quot;, &quot;, u, &quot; sold &quot;, amount);</span>
			}
<span class="nc" id="L1185">		}</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">		for (AIUnit aiu : getAIUnits()) {</span>
<span class="nc" id="L1187">			TransportMission tm = aiu.getMission(TransportMission.class);</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">			if (tm != null)</span>
<span class="nc" id="L1189">				tm.suppressEuropeanTrade(type, lb);</span>
<span class="nc" id="L1190">		}</span>

<span class="nc" id="L1192">		int n = 0;</span>
<span class="nc" id="L1193">		List&lt;GoodsWish&gt; wishes = goodsWishes.get(type);</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">		if (wishes != null) {</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">			for (GoodsWish gw : wishes) {</span>
<span class="nc bnc" id="L1196" title="All 4 branches missed.">				if (gw.getGoodsType() == type &amp;&amp; gw.getDestination() == europe) {</span>
<span class="nc bnc" id="L1197" title="All 2 branches missed.">					if (gw.getTransportable() instanceof AIGoods) {</span>
<span class="nc" id="L1198">						AIGoods aig = (AIGoods) gw.getTransportable();</span>
<span class="nc" id="L1199">						consumeGoodsWish(aig, gw);</span>
<span class="nc" id="L1200">						aig.setTransportDestination(null);</span>
					}
<span class="nc" id="L1202">					gw.dispose();</span>
<span class="nc" id="L1203">					n++;</span>
				}
<span class="nc" id="L1205">			}</span>
<span class="nc bnc" id="L1206" title="All 2 branches missed.">			if (n &gt; 0)</span>
<span class="nc" id="L1207">				lb.add(&quot;, dropped &quot;, n, &quot; goods wishes&quot;);</span>
		}
<span class="nc" id="L1209">		lb.add(&quot;.&quot;);</span>
<span class="nc" id="L1210">	}</span>

	/**
	 * Gets a list of the wishes at a given location for a unit type.
	 *
	 * @param loc
	 *            The &lt;code&gt;Location&lt;/code&gt; to look for wishes at.
	 * @param type
	 *            The &lt;code&gt;UnitType&lt;/code&gt; to look for.
	 * @return A list of &lt;code&gt;WorkerWish&lt;/code&gt;es.
	 */
	public List&lt;WorkerWish&gt; getWorkerWishesAt(Location loc, UnitType type) {
<span class="nc" id="L1222">		List&lt;Wish&gt; demand = transportDemand.get(Location.upLoc(loc));</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">		if (demand == null)</span>
<span class="nc" id="L1224">			return Collections.&lt;WorkerWish&gt;emptyList();</span>
<span class="nc" id="L1225">		List&lt;WorkerWish&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1226" title="All 2 branches missed.">		for (Wish w : demand) {</span>
<span class="nc bnc" id="L1227" title="All 4 branches missed.">			if (w instanceof WorkerWish &amp;&amp; ((WorkerWish) w).getUnitType() == type) {</span>
<span class="nc" id="L1228">				result.add((WorkerWish) w);</span>
			}
<span class="nc" id="L1230">		}</span>
<span class="nc" id="L1231">		return result;</span>
	}

	/**
	 * Gets a list of the wishes at a given location for a goods type.
	 *
	 * @param loc
	 *            The &lt;code&gt;Location&lt;/code&gt; to look for wishes at.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to look for.
	 * @return A list of &lt;code&gt;GoodsWish&lt;/code&gt;es.
	 */
	public List&lt;GoodsWish&gt; getGoodsWishesAt(Location loc, GoodsType type) {
<span class="nc" id="L1244">		List&lt;Wish&gt; demand = transportDemand.get(Location.upLoc(loc));</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">		if (demand == null)</span>
<span class="nc" id="L1246">			return Collections.&lt;GoodsWish&gt;emptyList();</span>
<span class="nc" id="L1247">		List&lt;GoodsWish&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1248" title="All 2 branches missed.">		for (Wish w : demand) {</span>
<span class="nc bnc" id="L1249" title="All 4 branches missed.">			if (w instanceof GoodsWish &amp;&amp; ((GoodsWish) w).getGoodsType() == type) {</span>
<span class="nc" id="L1250">				result.add((GoodsWish) w);</span>
			}
<span class="nc" id="L1252">		}</span>
<span class="nc" id="L1253">		return result;</span>
	}

	/**
	 * Gets the best worker wish for a carrier unit.
	 *
	 * @param aiUnit
	 *            The carrier &lt;code&gt;AIUnit&lt;/code&gt;.
	 * @param unitType
	 *            The &lt;code&gt;UnitType&lt;/code&gt; to find a wish for.
	 * @return The best worker wish for the unit.
	 */
	public WorkerWish getBestWorkerWish(AIUnit aiUnit, UnitType unitType) {
<span class="nc" id="L1266">		List&lt;WorkerWish&gt; wishes = workerWishes.get(unitType);</span>
<span class="nc bnc" id="L1267" title="All 2 branches missed.">		if (wishes == null)</span>
<span class="nc" id="L1268">			return null;</span>

<span class="nc" id="L1270">		final Unit carrier = aiUnit.getUnit();</span>
<span class="nc" id="L1271">		WorkerWish carried = null;</span>
<span class="nc" id="L1272">		WorkerWish other = null;</span>
<span class="nc" id="L1273">		double bestCarriedValue = -1.0, bestOtherValue = -1.0;</span>
<span class="nc bnc" id="L1274" title="All 2 branches missed.">		for (WorkerWish w : wishes) {</span>
<span class="nc" id="L1275">			int turns = carrier.getTurnsToReach(w.getDestination());</span>
<span class="nc bnc" id="L1276" title="All 2 branches missed.">			if (turns &lt; Unit.MANY_TURNS) {</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">				if (bestCarriedValue &lt; (double) w.getValue() / turns) {</span>
<span class="nc" id="L1278">					bestCarriedValue = (double) w.getValue() / turns;</span>
<span class="nc" id="L1279">					carried = w;</span>
				}
			} else {
<span class="nc bnc" id="L1282" title="All 2 branches missed.">				if (bestOtherValue &lt; w.getValue()) {</span>
<span class="nc" id="L1283">					bestOtherValue = w.getValue();</span>
<span class="nc" id="L1284">					other = w;</span>
				}
			}
<span class="nc" id="L1287">		}</span>
<span class="nc bnc" id="L1288" title="All 4 branches missed.">		return (carried != null) ? carried : (other != null) ? other : null;</span>
	}

	/**
	 * Gets the best goods wish for a carrier unit.
	 *
	 * @param aiUnit
	 *            The carrier &lt;code&gt;AIUnit&lt;/code&gt;.
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to wish for.
	 * @return The best &lt;code&gt;GoodsWish&lt;/code&gt; for the unit.
	 */
	public GoodsWish getBestGoodsWish(AIUnit aiUnit, GoodsType goodsType) {
<span class="nc" id="L1301">		List&lt;GoodsWish&gt; wishes = goodsWishes.get(goodsType);</span>
<span class="nc bnc" id="L1302" title="All 2 branches missed.">		if (wishes == null)</span>
<span class="nc" id="L1303">			return null;</span>

<span class="nc" id="L1305">		final Unit carrier = aiUnit.getUnit();</span>
<span class="nc" id="L1306">		double bestValue = 0.0f;</span>
<span class="nc" id="L1307">		GoodsWish best = null;</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">		for (GoodsWish w : wishes) {</span>
<span class="nc" id="L1309">			int turns = carrier.getTurnsToReach(carrier.getLocation(), w.getDestination());</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">			if (turns &gt;= Unit.MANY_TURNS)</span>
<span class="nc" id="L1311">				continue;</span>
<span class="nc" id="L1312">			double value = (double) w.getValue() / turns;</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">			if (bestValue &lt; value) {</span>
<span class="nc" id="L1314">				bestValue = value;</span>
<span class="nc" id="L1315">				best = w;</span>
			}
<span class="nc" id="L1317">		}</span>
<span class="nc" id="L1318">		return best;</span>
	}

	/**
	 * Rebuilds the goods and worker wishes maps.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void buildWishMaps(LogBuilder lb) {
<span class="nc bnc" id="L1328" title="All 2 branches missed.">		for (UnitType unitType : getSpecification().getUnitTypeList()) {</span>
<span class="nc" id="L1329">			List&lt;WorkerWish&gt; wl = workerWishes.get(unitType);</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">			if (wl == null) {</span>
<span class="nc" id="L1331">				workerWishes.put(unitType, new ArrayList&lt;WorkerWish&gt;());</span>
			} else {
<span class="nc" id="L1333">				wl.clear();</span>
			}
<span class="nc" id="L1335">		}</span>
<span class="nc bnc" id="L1336" title="All 2 branches missed.">		for (GoodsType goodsType : getSpecification().getStorableGoodsTypeList()) {</span>
<span class="nc" id="L1337">			List&lt;GoodsWish&gt; gl = goodsWishes.get(goodsType);</span>
<span class="nc bnc" id="L1338" title="All 2 branches missed.">			if (gl == null) {</span>
<span class="nc" id="L1339">				goodsWishes.put(goodsType, new ArrayList&lt;GoodsWish&gt;());</span>
			} else {
<span class="nc" id="L1341">				gl.clear();</span>
			}
<span class="nc" id="L1343">		}</span>

<span class="nc bnc" id="L1345" title="All 2 branches missed.">		for (Wish w : getWishes()) {</span>
<span class="nc bnc" id="L1346" title="All 2 branches missed.">			if (w instanceof WorkerWish) {</span>
<span class="nc" id="L1347">				WorkerWish ww = (WorkerWish) w;</span>
<span class="nc bnc" id="L1348" title="All 2 branches missed.">				if (ww.getTransportable() == null) {</span>
<span class="nc" id="L1349">					appendToMapList(workerWishes, ww.getUnitType(), ww);</span>
				}
<span class="nc bnc" id="L1351" title="All 2 branches missed.">			} else if (w instanceof GoodsWish) {</span>
<span class="nc" id="L1352">				GoodsWish gw = (GoodsWish) w;</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">				if (gw.getDestination() instanceof Colony) {</span>
<span class="nc" id="L1354">					appendToMapList(goodsWishes, gw.getGoodsType(), gw);</span>
				}
			}
<span class="nc" id="L1357">		}</span>

<span class="nc bnc" id="L1359" title="All 2 branches missed.">		if (!workerWishes.isEmpty()) {</span>
<span class="nc" id="L1360">			lb.add(&quot;\n  Wishes (workers):&quot;);</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">			for (UnitType ut : workerWishes.keySet()) {</span>
<span class="nc" id="L1362">				List&lt;WorkerWish&gt; wl = workerWishes.get(ut);</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">				if (!wl.isEmpty()) {</span>
<span class="nc" id="L1364">					lb.add(&quot;\n    &quot;, ut.getSuffix(), &quot;:&quot;);</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">					for (WorkerWish ww : wl) {</span>
<span class="nc" id="L1366">						lb.add(&quot; &quot;, ww.getDestination(), &quot;(&quot;, ww.getValue(), &quot;)&quot;);</span>
<span class="nc" id="L1367">					}</span>
				}
<span class="nc" id="L1369">			}</span>
		}
<span class="nc bnc" id="L1371" title="All 2 branches missed.">		if (!goodsWishes.isEmpty()) {</span>
<span class="nc" id="L1372">			lb.add(&quot;\n  Wishes (goods):&quot;);</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">			for (GoodsType gt : goodsWishes.keySet()) {</span>
<span class="nc" id="L1374">				List&lt;GoodsWish&gt; gl = goodsWishes.get(gt);</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">				if (!gl.isEmpty()) {</span>
<span class="nc" id="L1376">					lb.add(&quot;\n    &quot;, gt.getSuffix(), &quot;:&quot;);</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">					for (GoodsWish gw : gl) {</span>
<span class="nc" id="L1378">						lb.add(&quot; &quot;, gw.getDestination(), &quot;(&quot;, gw.getValue(), &quot;)&quot;);</span>
<span class="nc" id="L1379">					}</span>
				}
<span class="nc" id="L1381">			}</span>
		}
<span class="nc" id="L1383">	}</span>

	/**
	 * Notify that a wish has been completed. Called from AIColony.
	 *
	 * @param w
	 *            The &lt;code&gt;Wish&lt;/code&gt; to complete.
	 */
	public void completeWish(Wish w) {
<span class="nc bnc" id="L1392" title="All 2 branches missed.">		if (w instanceof WorkerWish) {</span>
<span class="nc" id="L1393">			WorkerWish ww = (WorkerWish) w;</span>
<span class="nc" id="L1394">			List&lt;WorkerWish&gt; wl = workerWishes.get(ww.getUnitType());</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">			if (wl != null)</span>
<span class="nc" id="L1396">				wl.remove(ww);</span>
<span class="nc bnc" id="L1397" title="All 2 branches missed.">		} else if (w instanceof GoodsWish) {</span>
<span class="nc" id="L1398">			GoodsWish gw = (GoodsWish) w;</span>
<span class="nc" id="L1399">			List&lt;GoodsWish&gt; gl = goodsWishes.get(gw.getGoodsType());</span>
<span class="nc bnc" id="L1400" title="All 2 branches missed.">			if (gl != null)</span>
<span class="nc" id="L1401">				gl.remove(gw);</span>
<span class="nc" id="L1402">		} else {</span>
<span class="nc" id="L1403">			throw new IllegalStateException(&quot;Bogus wish: &quot; + w);</span>
		}
<span class="nc" id="L1405">	}</span>

	/**
	 * Consume a WorkerWish, yielding a WishRealizationMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param ww
	 *            The &lt;code&gt;WorkerWish&lt;/code&gt; to consume.
	 */
	public void consumeWorkerWish(AIUnit aiUnit, WorkerWish ww) {
<span class="nc" id="L1416">		final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L1417">		List&lt;WorkerWish&gt; wwL = workerWishes.get(unit.getType());</span>
<span class="nc" id="L1418">		wwL.remove(ww);</span>
<span class="nc" id="L1419">		List&lt;Wish&gt; wl = transportDemand.get(ww.getDestination());</span>
<span class="nc bnc" id="L1420" title="All 2 branches missed.">		if (wl != null)</span>
<span class="nc" id="L1421">			wl.remove(ww);</span>
<span class="nc" id="L1422">		ww.setTransportable(aiUnit);</span>
<span class="nc" id="L1423">	}</span>

	/**
	 * Consume a GoodsWish.
	 *
	 * @param aig
	 *            The &lt;code&gt;AIGoods&lt;/code&gt; to use.
	 * @param gw
	 *            The &lt;code&gt;GoodsWish&lt;/code&gt; to consume.
	 */
	public void consumeGoodsWish(AIGoods aig, GoodsWish gw) {
<span class="nc" id="L1434">		final Goods goods = aig.getGoods();</span>
<span class="nc" id="L1435">		List&lt;GoodsWish&gt; gwL = goodsWishes.get(goods.getType());</span>
<span class="nc" id="L1436">		gwL.remove(gw);</span>
<span class="nc" id="L1437">		List&lt;Wish&gt; wl = transportDemand.get(gw.getDestination());</span>
<span class="nc bnc" id="L1438" title="All 2 branches missed.">		if (wl != null)</span>
<span class="nc" id="L1439">			wl.remove(gw);</span>
<span class="nc" id="L1440">		gw.setTransportable(aig);</span>
<span class="nc" id="L1441">	}</span>

	// Useful public routines

	/**
	 * Gets the number of units that should build a colony.
	 *
	 * This is the desired total number, not the actual number which would take
	 * into account the number of existing BuildColonyMissions.
	 *
	 * @return The desired number of colony builders for this player.
	 */
	public int buildersNeeded() {
<span class="fc" id="L1454">		Player player = getPlayer();</span>
<span class="pc bpc" id="L1455" title="1 of 2 branches missed.">		if (!player.canBuildColonies())</span>
<span class="nc" id="L1456">			return 0;</span>

<span class="fc" id="L1458">		int nColonies = 0, nPorts = 0, nWorkers = 0, nEuropean = 0;</span>
<span class="pc bpc" id="L1459" title="1 of 2 branches missed.">		for (Settlement settlement : player.getSettlements()) {</span>
<span class="nc" id="L1460">			nColonies++;</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">			if (settlement.isConnectedPort())</span>
<span class="nc" id="L1462">				nPorts++;</span>
<span class="nc bnc" id="L1463" title="All 2 branches missed.">			for (Unit u : settlement.getUnitList()) {</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">				if (u.isPerson())</span>
<span class="nc" id="L1465">					nWorkers++;</span>
<span class="nc" id="L1466">			}</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">			for (Unit u : settlement.getTile().getUnitList()) {</span>
<span class="nc bnc" id="L1468" title="All 2 branches missed.">				if (u.isPerson())</span>
<span class="nc" id="L1469">					nWorkers++;</span>
<span class="nc" id="L1470">			}</span>
<span class="nc" id="L1471">		}</span>
<span class="fc" id="L1472">		Europe europe = player.getEurope();</span>
<span class="pc bpc" id="L1473" title="1 of 2 branches missed.">		if (europe != null) {</span>
<span class="fc bfc" id="L1474" title="All 2 branches covered.">			for (Unit u : europe.getUnitList()) {</span>
<span class="pc bpc" id="L1475" title="1 of 2 branches missed.">				if (u.isPerson())</span>
<span class="nc" id="L1476">					nEuropean++;</span>
<span class="fc" id="L1477">			}</span>
		}

		// If would be good to have at least two colonies, and at least
		// one port. After that, determine the ratio of workers to colonies
		// (which should be the average colony size), and if that is above
		// a threshold, send out another colonist.
		// The threshold probably should be configurable. 2 is too
		// low IMHO as it makes a lot of brittle colonies, 3 is too
		// high at least initially as it makes it hard for the initial
		// colonies to become substantial. For now, arbitrarily choose e.
<span class="pc bpc" id="L1488" title="9 of 10 branches missed.">		return (nColonies == 0 || nPorts == 0) ? 2</span>
				: ((nPorts &lt;= 1) &amp;&amp; (nWorkers + nEuropean) &gt;= 3) ? 1
						: ((double) (nWorkers + nEuropean) / nColonies &gt; Math.E) ? 1 : 0;
	}

	/**
	 * How many pioneers should we have?
	 *
	 * This is the desired total number, not the actual number which would take
	 * into account the number of existing PioneeringMissions.
	 *
	 * @return The desired number of pioneers for this player.
	 */
	public int pioneersNeeded() {
<span class="fc" id="L1502">		return (tipMap.size() + 1) / 2;</span>
	}

	/**
	 * How many scouts should we have?
	 *
	 * This is the desired total number, not the actual number which would take
	 * into account the number of existing ScoutingMissions.
	 *
	 * Current scheme for European AIs is to use up to three scouts in the early
	 * part of the game, then one.
	 *
	 * @return The desired number of scouts for this player.
	 */
	public int scoutsNeeded() {
<span class="fc" id="L1517">		return 3 - (getGame().getTurn().getNumber() / 100);</span>
	}

	/**
	 * Asks the server to recruit a unit in Europe on behalf of the AIPlayer.
	 *
	 * FIXME: Move this to a specialized Handler class (AIEurope?) FIXME: Give
	 * protected access?
	 *
	 * @param slot
	 *            The migration slot to recruit from.
	 * @return The new AIUnit created by this action or null on failure.
	 */
	public AIUnit recruitAIUnitInEurope(int slot) {
<span class="nc" id="L1531">		AIUnit aiUnit = null;</span>
<span class="nc" id="L1532">		Europe europe = getPlayer().getEurope();</span>
<span class="nc bnc" id="L1533" title="All 2 branches missed.">		if (europe == null)</span>
<span class="nc" id="L1534">			return null;</span>
<span class="nc" id="L1535">		int n = europe.getUnitCount();</span>
<span class="nc" id="L1536">		final String selectAbility = Ability.SELECT_RECRUIT;</span>
<span class="nc bnc" id="L1537" title="All 2 branches missed.">		if (!Europe.MigrationType.validMigrantSlot(slot)) {</span>
<span class="nc bnc" id="L1538" title="All 2 branches missed.">			slot = (getPlayer().hasAbility(selectAbility)) ? Europe.MigrationType.getDefaultSlot()</span>
<span class="nc" id="L1539">					: Europe.MigrationType.getUnspecificSlot();</span>
		}
<span class="nc bnc" id="L1541" title="All 4 branches missed.">		if (AIMessage.askEmigrate(this, slot) &amp;&amp; europe.getUnitCount() == n + 1) {</span>
<span class="nc" id="L1542">			aiUnit = getAIUnit(europe.getUnitList().get(n));</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">			if (aiUnit != null)</span>
<span class="nc" id="L1544">				addAIUnit(aiUnit);</span>
		}
<span class="nc" id="L1546">		return aiUnit;</span>
	}

	/**
	 * Helper function for server communication - Ask the server to train a unit
	 * in Europe on behalf of the AIGetPlayer().
	 * 
	 * FIXME: Move this to a specialized Handler class (AIEurope?) FIXME: Give
	 * protected access?
	 *
	 * @param unitType
	 *            the unit type
	 * @return the new AIUnit created by this action. May be null.
	 */
	public AIUnit trainAIUnitInEurope(UnitType unitType) {
<span class="nc bnc" id="L1561" title="All 2 branches missed.">		if (unitType == null) {</span>
<span class="nc" id="L1562">			throw new IllegalArgumentException(&quot;Invalid UnitType.&quot;);</span>
		}

<span class="nc" id="L1565">		AIUnit aiUnit = null;</span>
<span class="nc" id="L1566">		Europe europe = getPlayer().getEurope();</span>
<span class="nc bnc" id="L1567" title="All 2 branches missed.">		if (europe == null)</span>
<span class="nc" id="L1568">			return null;</span>
<span class="nc" id="L1569">		int n = europe.getUnitCount();</span>

<span class="nc bnc" id="L1571" title="All 4 branches missed.">		if (AIMessage.askTrainUnitInEurope(this, unitType) &amp;&amp; europe.getUnitCount() == n + 1) {</span>
<span class="nc" id="L1572">			aiUnit = getAIUnit(europe.getUnitList().get(n));</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">			if (aiUnit != null)</span>
<span class="nc" id="L1574">				addAIUnit(aiUnit);</span>
		}
<span class="nc" id="L1576">		return aiUnit;</span>
	}

	/**
	 * Gets the wishes for all this player's colonies, sorted by the
	 * {@link Wish#getValue value}.
	 *
	 * @return A list of wishes.
	 */
	public List&lt;Wish&gt; getWishes() {
<span class="fc" id="L1586">		List&lt;Wish&gt; wishes = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L1587" title="1 of 2 branches missed.">		for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L1588">			wishes.addAll(aic.getWishes());</span>
<span class="nc" id="L1589">		}</span>
<span class="fc" id="L1590">		Collections.sort(wishes);</span>
<span class="fc" id="L1591">		return wishes;</span>
	}

	// Diplomacy support

	/**
	 * Determines the stances towards each player.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void determineStances(LogBuilder lb) {
<span class="fc" id="L1603">		final ServerPlayer serverPlayer = (ServerPlayer) getPlayer();</span>
<span class="fc" id="L1604">		lb.mark();</span>

<span class="fc bfc" id="L1606" title="All 2 branches covered.">		for (Player p : getGame().getLivePlayers(serverPlayer)) {</span>
<span class="fc" id="L1607">			Stance newStance = determineStance(p);</span>
<span class="pc bpc" id="L1608" title="1 of 2 branches missed.">			if (newStance != serverPlayer.getStance(p)) {</span>
<span class="nc bnc" id="L1609" title="All 4 branches missed.">				if (newStance == Stance.WAR &amp;&amp; peaceHolds(p)) {</span>
					; // Peace treaty holds for now
				} else {
<span class="nc" id="L1612">					getAIMain().getFreeColServer().getInGameController().changeStance(serverPlayer, newStance,</span>
							(ServerPlayer) p, true);
<span class="nc" id="L1614">					lb.add(&quot; &quot;, p.getDebugName(), &quot;-&gt;&quot;, newStance, &quot;, &quot;);</span>
				}
			}
<span class="fc" id="L1617">		}</span>
<span class="pc bpc" id="L1618" title="1 of 2 branches missed.">		if (lb.grew(&quot;\n  Stance changes:&quot;))</span>
<span class="nc" id="L1619">			lb.shrink(&quot;, &quot;);</span>
<span class="fc" id="L1620">	}</span>

	/**
	 * See if a recent peace treaty still has force.
	 *
	 * @param p
	 *            The &lt;code&gt;Player&lt;/code&gt; to check for a peace treaty with.
	 * @return True if peace gets another chance.
	 */
	private boolean peaceHolds(Player p) {
<span class="nc" id="L1630">		final Player player = getPlayer();</span>
<span class="nc" id="L1631">		final Turn turn = getGame().getTurn();</span>
<span class="nc" id="L1632">		final double peaceProb = getSpecification().getInteger(GameOptions.PEACE_PROBABILITY) / 100.0;</span>

<span class="nc" id="L1634">		int peaceTurn = -1;</span>
<span class="nc bnc" id="L1635" title="All 2 branches missed.">		for (HistoryEvent h : player.getHistory()) {</span>
<span class="nc bnc" id="L1636" title="All 4 branches missed.">			if (p.getId().equals(h.getPlayerId()) &amp;&amp; h.getTurn().getNumber() &gt; peaceTurn) {</span>
<span class="nc bnc" id="L1637" title="All 3 branches missed.">				switch (h.getEventType()) {</span>
				case MAKE_PEACE:
				case FORM_ALLIANCE:
<span class="nc" id="L1640">					peaceTurn = h.getTurn().getNumber();</span>
<span class="nc" id="L1641">					break;</span>
				case DECLARE_WAR:
<span class="nc" id="L1643">					peaceTurn = -1;</span>
<span class="nc" id="L1644">					break;</span>
				default:
					break;
				}
			}
<span class="nc" id="L1649">		}</span>
<span class="nc bnc" id="L1650" title="All 2 branches missed.">		if (peaceTurn &lt; 0)</span>
<span class="nc" id="L1651">			return false;</span>

<span class="nc" id="L1653">		int n = turn.getNumber() - peaceTurn;</span>
<span class="nc" id="L1654">		float prob = (float) Math.pow(peaceProb, n);</span>
		// Apply Franklin's modifier
<span class="nc" id="L1656">		prob = p.applyModifiers(prob, turn, Modifier.PEACE_TREATY);</span>
<span class="nc bnc" id="L1657" title="All 4 branches missed.">		return prob &gt; 0.0f &amp;&amp; (randomInt(logger, &quot;Peace holds?&quot;, getAIRandom(), 100) &lt; (int) (100.0f * prob));</span>
	}

	/**
	 * Get a nation summary for another player.
	 *
	 * @param other
	 *            The other &lt;code&gt;Player&lt;/code&gt; to get the summary for.
	 * @return The current &lt;code&gt;NationSummary&lt;/code&gt; for a player.
	 */
	protected NationSummary getNationSummary(Player other) {
<span class="fc" id="L1668">		Player player = getPlayer();</span>
<span class="fc" id="L1669">		NationSummary ns = player.getNationSummary(other);</span>
<span class="pc bpc" id="L1670" title="1 of 2 branches missed.">		if (ns == null) {</span>
<span class="fc" id="L1671">			ns = AIMessage.askGetNationSummary(this, other);</span>
<span class="fc" id="L1672">			player.putNationSummary(other, ns);</span>
		}
<span class="fc" id="L1674">		return ns;</span>
	}

	/**
	 * Get the land force strength ratio of this player with respect to another.
	 *
	 * @param other
	 *            The other &lt;code&gt;Player&lt;/code&gt;.
	 * @return The strength ratio (strength/sum(strengths)).
	 */
	protected double getStrengthRatio(Player other) {
<span class="nc" id="L1685">		return getPlayer().getStrengthRatio(other, false);</span>
	}

	/**
	 * Is this player lagging in naval strength? Calculate the ratio of its
	 * naval strength to the average strength of other European colonial powers.
	 *
	 * @return The naval strength ratio, or negative if there are no other
	 *         European colonial nations.
	 */
	protected double getNavalStrengthRatio() {
<span class="fc" id="L1696">		final Player player = getPlayer();</span>
<span class="fc" id="L1697">		double navalAverage = 0.0;</span>
<span class="fc" id="L1698">		double navalStrength = 0.0;</span>
<span class="fc" id="L1699">		int nPlayers = 0;</span>
<span class="fc bfc" id="L1700" title="All 2 branches covered.">		for (Player p : getGame().getLiveEuropeanPlayers(player)) {</span>
<span class="pc bpc" id="L1701" title="1 of 2 branches missed.">			if (p.isREF())</span>
<span class="nc" id="L1702">				continue;</span>
<span class="fc" id="L1703">			NationSummary ns = getNationSummary(p);</span>
<span class="pc bpc" id="L1704" title="1 of 2 branches missed.">			if (p == player) {</span>
<span class="nc" id="L1705">				navalStrength = ns.getNavalStrength();</span>
			} else {
<span class="fc" id="L1707">				int st = ns.getNavalStrength();</span>
<span class="pc bpc" id="L1708" title="1 of 2 branches missed.">				if (st &gt;= 0)</span>
<span class="fc" id="L1709">					navalAverage += st;</span>
<span class="fc" id="L1710">				nPlayers++;</span>
			}
<span class="fc" id="L1712">		}</span>
<span class="pc bpc" id="L1713" title="2 of 4 branches missed.">		if (nPlayers &lt;= 0 || navalStrength &lt; 0)</span>
<span class="nc" id="L1714">			return -1.0;</span>
<span class="fc" id="L1715">		navalAverage /= nPlayers;</span>
<span class="pc bpc" id="L1716" title="1 of 2 branches missed.">		return (navalAverage == 0.0) ? -1.0 : navalStrength / navalAverage;</span>
	}

	/**
	 * Reject a trade agreement, except if a Franklin-derived stance is
	 * supplied.
	 *
	 * @param stance
	 *            A stance &lt;code&gt;TradeItem&lt;/code&gt;.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to reset.
	 * @return The &lt;code&gt;TradeStatus&lt;/code&gt; for the agreement.
	 */
	private TradeStatus rejectAgreement(TradeItem stance, DiplomaticTrade agreement) {
<span class="nc bnc" id="L1730" title="All 2 branches missed.">		if (stance == null)</span>
<span class="nc" id="L1731">			return TradeStatus.REJECT_TRADE;</span>

<span class="nc" id="L1733">		agreement.clear();</span>
<span class="nc" id="L1734">		agreement.add(stance);</span>
<span class="nc" id="L1735">		return TradeStatus.PROPOSE_TRADE;</span>
	}

	// Mission handling

	/**
	 * Ensures all units have a mission.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	protected void giveNormalMissions(LogBuilder lb) {
<span class="fc" id="L1747">		final AIMain aiMain = getAIMain();</span>
<span class="fc" id="L1748">		final Player player = getPlayer();</span>
<span class="fc" id="L1749">		java.util.Map&lt;Unit, String&gt; reasons = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1750">		BuildColonyMission bcm = null;</span>
		Mission m;

<span class="fc" id="L1753">		nBuilders = buildersNeeded();</span>
<span class="fc" id="L1754">		nPioneers = pioneersNeeded();</span>
<span class="fc" id="L1755">		nScouts = scoutsNeeded();</span>

<span class="fc" id="L1757">		List&lt;AIUnit&gt; aiUnits = getAIUnits();</span>
<span class="fc" id="L1758">		List&lt;AIUnit&gt; navalUnits = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1759">		List&lt;AIUnit&gt; done = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1760">		List&lt;TransportMission&gt; transportMissions = new ArrayList&lt;&gt;();</span>

		// For all units, check if it is a candidate for a new
		// mission. If it is not a candidate remove it from the
		// aiUnits list (reporting why not). Adjust the
		// Build/Pioneer/Scout counts according to the existing valid
		// missions. Accumulate potentially usable transport missions.
<span class="fc" id="L1767">		lb.mark();</span>
<span class="fc bfc" id="L1768" title="All 2 branches covered.">		for (AIUnit aiUnit : aiUnits) {</span>
<span class="fc" id="L1769">			final Unit unit = aiUnit.getUnit();</span>
<span class="fc" id="L1770">			final Colony colony = unit.getColony();</span>
<span class="fc" id="L1771">			m = aiUnit.getMission();</span>
<span class="fc bfc" id="L1772" title="All 2 branches covered.">			final Location oldTarget = (m == null) ? null : m.getTarget();</span>

<span class="pc bpc" id="L1774" title="2 of 4 branches missed.">			if (unit.isUninitialized() || unit.isDisposed()) {</span>
<span class="nc" id="L1775">				reasons.put(unit, &quot;Invalid&quot;);</span>

<span class="pc bpc" id="L1777" title="1 of 2 branches missed.">			} else if (unit.isDamaged()) { // Damaged units must wait</span>
<span class="pc bpc" id="L1778" title="1 of 2 branches missed.">				if (!(m instanceof IdleAtSettlementMission)) {</span>
<span class="pc bpc" id="L1779" title="1 of 2 branches missed.">					if ((m = getIdleAtSettlementMission(aiUnit)) != null) {</span>
<span class="nc" id="L1780">						lb.add(&quot;, &quot;, m);</span>
					}
				}
<span class="fc" id="L1783">				reasons.put(unit, &quot;Damaged&quot;);</span>

<span class="nc bnc" id="L1785" title="All 4 branches missed.">			} else if (unit.getState() == UnitState.IN_COLONY &amp;&amp; colony.getUnitCount() &lt;= 1) {</span>
				// The unit has its hand full keeping the colony alive.
<span class="nc bnc" id="L1787" title="All 2 branches missed.">				if (!(m instanceof WorkInsideColonyMission)</span>
<span class="nc bnc" id="L1788" title="All 2 branches missed.">						&amp;&amp; (m = getWorkInsideColonyMission(aiUnit, aiMain.getAIColony(colony))) != null) {</span>
<span class="nc" id="L1789">					logger.warning(aiUnit + &quot; should WorkInsideColony at &quot; + colony.getName());</span>
<span class="nc" id="L1790">					lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1791">					updateTransport(aiUnit, oldTarget, lb);</span>
				}
<span class="nc" id="L1793">				reasons.put(unit, &quot;Vital&quot;);</span>

<span class="nc bnc" id="L1795" title="All 2 branches missed.">			} else if (unit.isInMission()) {</span>
<span class="nc" id="L1796">				reasons.put(unit, &quot;Mission&quot;);</span>

<span class="nc bnc" id="L1798" title="All 6 branches missed.">			} else if (m != null &amp;&amp; m.isValid() &amp;&amp; !m.isOneTime()) {</span>
<span class="nc bnc" id="L1799" title="All 2 branches missed.">				if (m instanceof BuildColonyMission) {</span>
<span class="nc" id="L1800">					bcm = (BuildColonyMission) m;</span>
<span class="nc" id="L1801">					nBuilders--;</span>
<span class="nc bnc" id="L1802" title="All 2 branches missed.">				} else if (m instanceof PioneeringMission) {</span>
<span class="nc" id="L1803">					nPioneers--;</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">				} else if (m instanceof ScoutingMission) {</span>
<span class="nc" id="L1805">					nScouts--;</span>
<span class="nc bnc" id="L1806" title="All 2 branches missed.">				} else if (m instanceof TransportMission) {</span>
<span class="nc" id="L1807">					TransportMission tm = (TransportMission) m;</span>
					// Consider reassigning quiescent transport
					// missions to privateer missions
<span class="nc bnc" id="L1810" title="All 6 branches missed.">					if (tm.isEmpty() &amp;&amp; unit.isNaval() &amp;&amp; unit.isOffensiveUnit()) {</span>
<span class="nc" id="L1811">						navalUnits.add(aiUnit);</span>
<span class="nc" id="L1812">						done.add(aiUnit);</span>
<span class="nc" id="L1813">						continue;</span>
					}
					// If there is capacity in this mission, consider adding
					// more cargoes
<span class="nc bnc" id="L1817" title="All 2 branches missed.">					if (tm.destinationCapacity() &gt; 0) {</span>
<span class="nc" id="L1818">						transportMissions.add(tm);</span>
					}
<span class="nc bnc" id="L1820" title="All 2 branches missed.">				} else if (m instanceof PrivateerMission) {</span>
<span class="nc bnc" id="L1821" title="All 2 branches missed.">					if (!(m.getTarget() instanceof Unit)) {</span>
						// Privateering but not chasing a unit, consider
						// reassigning to transport.
<span class="nc" id="L1824">						navalUnits.add(aiUnit);</span>
<span class="nc" id="L1825">						done.add(aiUnit);</span>
<span class="nc" id="L1826">						continue;</span>
					}
				}
<span class="nc" id="L1829">				reasons.put(unit, &quot;Valid&quot;);</span>

<span class="nc bnc" id="L1831" title="All 2 branches missed.">			} else if (unit.isNaval()) {</span>
<span class="nc" id="L1832">				navalUnits.add(aiUnit);</span>

<span class="nc bnc" id="L1834" title="All 2 branches missed.">			} else if (unit.isAtSea()) { // Wait for it to emerge</span>
<span class="nc" id="L1835">				reasons.put(unit, &quot;At-Sea&quot;);</span>

			} else { // Needs mission
				continue;
			}
<span class="fc" id="L1840">			done.add(aiUnit);</span>
<span class="fc" id="L1841">		}</span>
<span class="fc" id="L1842">		aiUnits.removeAll(done);</span>
<span class="fc" id="L1843">		done.clear();</span>

		// First try to satisfy the demand for missions with a defined
		// quota. Builders first to keep weak players in the game,
		// scouts next as they are profitable. Pile onto any
		// exisiting building mission if there are no colonies.
<span class="pc bpc" id="L1849" title="2 of 4 branches missed.">		if (player.getNumberOfSettlements() &lt;= 0 &amp;&amp; bcm != null) {</span>
<span class="nc" id="L1850">			final Location bcmTarget = bcm.getTarget();</span>
<span class="nc" id="L1851">			Collections.sort(aiUnits, builderComparator);</span>
<span class="nc bnc" id="L1852" title="All 2 branches missed.">			for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">				final Location oldTarget = ((m = aiUnit.getMission()) == null) ? null : m.getTarget();</span>
<span class="nc bnc" id="L1854" title="All 2 branches missed.">				if ((m = getBuildColonyMission(aiUnit, bcmTarget)) == null)</span>
<span class="nc" id="L1855">					continue;</span>
<span class="nc" id="L1856">				lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1857">				updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1858">				done.add(aiUnit);</span>
<span class="nc bnc" id="L1859" title="All 2 branches missed.">				if (requestsTransport(aiUnit))</span>
<span class="nc" id="L1860">					transportSupply.add(aiUnit);</span>
<span class="nc" id="L1861">				reasons.put(aiUnit.getUnit(), &quot;0Builder&quot;);</span>
<span class="nc" id="L1862">			}</span>
<span class="nc" id="L1863">			aiUnits.removeAll(done);</span>
<span class="nc" id="L1864">			done.clear();</span>
		}
<span class="pc bpc" id="L1866" title="1 of 2 branches missed.">		if (nBuilders &gt; 0) {</span>
<span class="fc" id="L1867">			Collections.sort(aiUnits, builderComparator);</span>
<span class="pc bpc" id="L1868" title="1 of 2 branches missed.">			for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc bnc" id="L1869" title="All 2 branches missed.">				final Location oldTarget = ((m = aiUnit.getMission()) == null) ? null : m.getTarget();</span>
<span class="nc bnc" id="L1870" title="All 2 branches missed.">				if ((m = getBuildColonyMission(aiUnit, null)) == null)</span>
<span class="nc" id="L1871">					continue;</span>
<span class="nc" id="L1872">				lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1873">				updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1874">				done.add(aiUnit);</span>
<span class="nc bnc" id="L1875" title="All 2 branches missed.">				if (requestsTransport(aiUnit))</span>
<span class="nc" id="L1876">					transportSupply.add(aiUnit);</span>
<span class="nc" id="L1877">				reasons.put(aiUnit.getUnit(), &quot;Builder&quot; + nBuilders);</span>
<span class="nc bnc" id="L1878" title="All 2 branches missed.">				if (--nBuilders &lt;= 0)</span>
<span class="nc" id="L1879">					break;</span>
<span class="nc" id="L1880">			}</span>
<span class="fc" id="L1881">			aiUnits.removeAll(done);</span>
<span class="fc" id="L1882">			done.clear();</span>
		}
<span class="pc bpc" id="L1884" title="1 of 2 branches missed.">		if (nScouts &gt; 0) {</span>
<span class="fc" id="L1885">			Collections.sort(aiUnits, scoutComparator);</span>
<span class="pc bpc" id="L1886" title="1 of 2 branches missed.">			for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc bnc" id="L1887" title="All 2 branches missed.">				final Location oldTarget = ((m = aiUnit.getMission()) == null) ? null : m.getTarget();</span>
<span class="nc" id="L1888">				final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1889" title="All 2 branches missed.">				if ((m = getScoutingMission(aiUnit)) == null)</span>
<span class="nc" id="L1890">					continue;</span>
<span class="nc" id="L1891">				lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1892">				updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1893">				done.add(aiUnit);</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">				if (requestsTransport(aiUnit))</span>
<span class="nc" id="L1895">					transportSupply.add(aiUnit);</span>
<span class="nc" id="L1896">				reasons.put(unit, &quot;Scout&quot; + nScouts);</span>
<span class="nc bnc" id="L1897" title="All 2 branches missed.">				if (--nScouts &lt;= 0)</span>
<span class="nc" id="L1898">					break;</span>
<span class="nc" id="L1899">			}</span>
<span class="fc" id="L1900">			aiUnits.removeAll(done);</span>
<span class="fc" id="L1901">			done.clear();</span>
		}
<span class="pc bpc" id="L1903" title="1 of 2 branches missed.">		if (nPioneers &gt; 0) {</span>
<span class="nc" id="L1904">			Collections.sort(aiUnits, pioneerComparator);</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">			for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L1906">				final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1907" title="All 2 branches missed.">				final Location oldTarget = ((m = aiUnit.getMission()) == null) ? null : m.getTarget();</span>
<span class="nc bnc" id="L1908" title="All 2 branches missed.">				if ((m = getPioneeringMission(aiUnit, null)) == null)</span>
<span class="nc" id="L1909">					continue;</span>
<span class="nc" id="L1910">				lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1911">				updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1912">				done.add(aiUnit);</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">				if (requestsTransport(aiUnit))</span>
<span class="nc" id="L1914">					transportSupply.add(aiUnit);</span>
<span class="nc" id="L1915">				reasons.put(unit, &quot;Pioneer&quot; + nPioneers);</span>
<span class="nc bnc" id="L1916" title="All 2 branches missed.">				if (--nPioneers &lt;= 0)</span>
<span class="nc" id="L1917">					break;</span>
<span class="nc" id="L1918">			}</span>
<span class="nc" id="L1919">			aiUnits.removeAll(done);</span>
<span class="nc" id="L1920">			done.clear();</span>
		}

		// Give the remaining land units a valid mission.
<span class="pc bpc" id="L1924" title="1 of 2 branches missed.">		for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L1925">			final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1926" title="All 2 branches missed.">			final Location oldTarget = ((m = aiUnit.getMission()) == null) ? null : m.getTarget();</span>
<span class="nc bnc" id="L1927" title="All 2 branches missed.">			if ((m = getSimpleMission(aiUnit)) == null)</span>
<span class="nc" id="L1928">				continue;</span>
<span class="nc" id="L1929">			lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1930">			updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1931">			reasons.put(unit, &quot;New-Land&quot;);</span>
<span class="nc" id="L1932">			done.add(aiUnit);</span>
<span class="nc bnc" id="L1933" title="All 2 branches missed.">			if (requestsTransport(aiUnit))</span>
<span class="nc" id="L1934">				transportSupply.add(aiUnit);</span>
<span class="nc" id="L1935">		}</span>
<span class="fc" id="L1936">		aiUnits.removeAll(done);</span>
<span class="fc" id="L1937">		done.clear();</span>

		// Process the free naval units, possibly adding to the usable
		// transport missions.
<span class="pc bpc" id="L1941" title="1 of 2 branches missed.">		for (AIUnit aiUnit : navalUnits) {</span>
<span class="nc" id="L1942">			final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L1943" title="All 4 branches missed.">			Mission old = ((m = aiUnit.getMission()) != null &amp;&amp; m.isValid()) ? m : null;</span>
<span class="nc bnc" id="L1944" title="All 2 branches missed.">			if ((m = getSimpleMission(aiUnit)) == null)</span>
<span class="nc" id="L1945">				continue;</span>
<span class="nc bnc" id="L1946" title="All 2 branches missed.">			lb.add(&quot;, &quot;, m, ((m == old) ? &quot; (preserved)&quot; : &quot; (new)&quot;));</span>
<span class="nc" id="L1947">			reasons.put(unit, &quot;New-Naval&quot;);</span>
<span class="nc" id="L1948">			done.add(aiUnit);</span>
<span class="nc bnc" id="L1949" title="All 2 branches missed.">			if (m instanceof TransportMission) {</span>
<span class="nc" id="L1950">				TransportMission tm = (TransportMission) m;</span>
<span class="nc bnc" id="L1951" title="All 2 branches missed.">				if (tm.destinationCapacity() &gt; 0) {</span>
<span class="nc" id="L1952">					transportMissions.add(tm);</span>
				}
				// A new transport mission might have retargeted
				// its passengers into new valid missions.
<span class="nc bnc" id="L1956" title="All 2 branches missed.">				for (Unit u : aiUnit.getUnit().getUnitList()) {</span>
<span class="nc" id="L1957">					AIUnit aiu = getAIUnit(u);</span>
<span class="nc" id="L1958">					Mission um = aiu.getMission();</span>
<span class="nc bnc" id="L1959" title="All 6 branches missed.">					if (um != null &amp;&amp; um.isValid() &amp;&amp; aiUnits.contains(aiu)) {</span>
<span class="nc" id="L1960">						aiUnits.remove(aiu);</span>
<span class="nc" id="L1961">						reasons.put(aiu.getUnit(), &quot;TNew&quot;);</span>
					}
<span class="nc" id="L1963">				}</span>
			}
<span class="nc" id="L1965">		}</span>
<span class="fc" id="L1966">		navalUnits.removeAll(done);</span>
<span class="fc" id="L1967">		done.clear();</span>

		// Give remaining units the fallback mission.
<span class="fc" id="L1970">		aiUnits.addAll(navalUnits);</span>
<span class="fc" id="L1971">		List&lt;Colony&gt; ports = null;</span>
<span class="fc" id="L1972">		int nPorts = player.getNumberOfPorts();</span>
<span class="pc bpc" id="L1973" title="1 of 2 branches missed.">		for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L1974">			final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L1975">			m = aiUnit.getMission();</span>
<span class="nc bnc" id="L1976" title="All 2 branches missed.">			final Location oldTarget = (m == null) ? null : m.getTarget();</span>
<span class="nc bnc" id="L1977" title="All 6 branches missed.">			if (m != null &amp;&amp; m.isValid() &amp;&amp; !m.isOneTime()) {</span>
<span class="nc" id="L1978">				logger.warning(&quot;Trying fallback mission for unit &quot; + unit + &quot; with valid mission &quot; + m + &quot; reason &quot;</span>
<span class="nc" id="L1979">						+ reasons.get(unit));</span>
<span class="nc" id="L1980">				continue;</span>
			}

<span class="nc bnc" id="L1983" title="All 6 branches missed.">			if (unit.isInEurope() &amp;&amp; unit.isPerson() &amp;&amp; nPorts &gt; 0) {</span>
				// Choose a port to add to
<span class="nc bnc" id="L1985" title="All 2 branches missed.">				if (ports == null)</span>
<span class="nc" id="L1986">					ports = player.getPorts();</span>
<span class="nc" id="L1987">				Colony c = ports.remove(0);</span>
<span class="nc" id="L1988">				AIColony aic = aiMain.getAIColony(c);</span>
<span class="nc bnc" id="L1989" title="All 2 branches missed.">				if ((m = getWorkInsideColonyMission(aiUnit, aic)) != null) {</span>
<span class="nc" id="L1990">					lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L1991">					updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L1992">					reasons.put(unit, &quot;To-work&quot;);</span>
<span class="nc" id="L1993">					ports.add(c);</span>
				}

<span class="nc bnc" id="L1996" title="All 2 branches missed.">			} else if (m instanceof IdleAtSettlementMission) {</span>
<span class="nc" id="L1997">				reasons.put(unit, &quot;Idle&quot;); // already idle</span>
			} else {
<span class="nc bnc" id="L1999" title="All 2 branches missed.">				if ((m = getIdleAtSettlementMission(aiUnit)) != null) {</span>
<span class="nc" id="L2000">					lb.add(&quot;, &quot;, m);</span>
<span class="nc" id="L2001">					updateTransport(aiUnit, oldTarget, lb);</span>
<span class="nc" id="L2002">					reasons.put(unit, &quot;Idle&quot;);</span>
				}
			}
<span class="nc" id="L2005">		}</span>
<span class="fc" id="L2006">		lb.grew(&quot;\n  Mission changes&quot;);</span>

		// Now see if transport can be found
<span class="fc" id="L2009">		allocateTransportables(getUrgentTransportables(), transportMissions, lb);</span>

		// Log
<span class="pc bpc" id="L2012" title="1 of 2 branches missed.">		if (!aiUnits.isEmpty()) {</span>
<span class="nc" id="L2013">			lb.add(&quot;\n  Free Land Units:&quot;);</span>
<span class="nc bnc" id="L2014" title="All 2 branches missed.">			for (AIUnit aiu : aiUnits) {</span>
<span class="nc" id="L2015">				lb.add(&quot; &quot;, aiu.getUnit());</span>
<span class="nc" id="L2016">			}</span>
		}
<span class="pc bpc" id="L2018" title="1 of 2 branches missed.">		if (!navalUnits.isEmpty()) {</span>
<span class="nc" id="L2019">			lb.add(&quot;\n  Free Naval Units:&quot;);</span>
<span class="nc bnc" id="L2020" title="All 2 branches missed.">			for (AIUnit aiu : navalUnits) {</span>
<span class="nc" id="L2021">				lb.add(&quot; &quot;, aiu.getUnit());</span>
<span class="nc" id="L2022">			}</span>
		}
<span class="fc" id="L2024">		lb.add(&quot;\n  Missions(colonies=&quot;, player.getNumberOfSettlements(), &quot; builders=&quot;, nBuilders, &quot; pioneers=&quot;,</span>
<span class="fc" id="L2025">				nPioneers, &quot; scouts=&quot;, nScouts, &quot; naval-carriers=&quot;, nNavalCarrier, &quot;)&quot;);</span>
<span class="fc" id="L2026">		logMissions(reasons, lb);</span>
<span class="fc" id="L2027">	}</span>

	/**
	 * Choose a mission for an AIUnit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to choose for.
	 * @return A suitable &lt;code&gt;Mission&lt;/code&gt;, or null if none found.
	 */
	public Mission getSimpleMission(AIUnit aiUnit) {
<span class="nc" id="L2037">		final Unit unit = aiUnit.getUnit();</span>
		Mission m, ret;
<span class="nc bnc" id="L2039" title="All 4 branches missed.">		final Mission old = ((m = aiUnit.getMission()) != null &amp;&amp; m.isValid()) ? m : null;</span>

<span class="nc bnc" id="L2041" title="All 2 branches missed.">		if (unit.isNaval()) {</span>
<span class="nc bnc" id="L2042" title="All 2 branches missed.">			ret = (old instanceof PrivateerMission) ? old</span>
<span class="nc bnc" id="L2043" title="All 4 branches missed.">					: ((m = getPrivateerMission(aiUnit, null)) != null) ? m</span>
							: (old instanceof TransportMission) ? old
<span class="nc bnc" id="L2045" title="All 4 branches missed.">									: ((m = getTransportMission(aiUnit)) != null) ? m</span>
											: (old instanceof UnitSeekAndDestroyMission) ? old
<span class="nc bnc" id="L2047" title="All 4 branches missed.">													: ((m = getSeekAndDestroyMission(aiUnit, 8)) != null) ? m</span>
															: (old instanceof UnitWanderHostileMission) ? old
<span class="nc" id="L2049">																	: getWanderHostileMission(aiUnit);</span>

<span class="nc bnc" id="L2051" title="All 2 branches missed.">		} else if (unit.isCarrier()) {</span>
<span class="nc" id="L2052">			ret = getTransportMission(aiUnit);</span>

		} else {
			// CashIn missions are obvious
<span class="nc bnc" id="L2056" title="All 2 branches missed.">			ret = (old instanceof CashInTreasureTrainMission) ? old</span>
<span class="nc bnc" id="L2057" title="All 2 branches missed.">					: ((m = getCashInTreasureTrainMission(aiUnit)) != null) ? m</span>

							// Working in colony is obvious
<span class="nc bnc" id="L2060" title="All 4 branches missed.">							: (unit.isInColony() &amp;&amp; old instanceof WorkInsideColonyMission) ? old</span>
<span class="nc bnc" id="L2061" title="All 6 branches missed.">									: (unit.isInColony() &amp;&amp; (m = getWorkInsideColonyMission(aiUnit, null)) != null) ? m</span>

											// Try to maintain local defence
											: (old instanceof DefendSettlementMission) ? old
<span class="nc bnc" id="L2065" title="All 2 branches missed.">													: ((m = getDefendCurrentSettlementMission(aiUnit)) != null) ? m</span>

															// REF override
<span class="nc bnc" id="L2068" title="All 4 branches missed.">															: (unit.hasAbility(Ability.REF_UNIT))</span>
																	? ((old instanceof UnitSeekAndDestroyMission) ? old
<span class="nc bnc" id="L2070" title="All 2 branches missed.">																			: ((m = getSeekAndDestroyMission(aiUnit,</span>
																					12)) != null)
																							? m
<span class="nc" id="L2073">																							: (m = getWanderHostileMission(</span>
																									aiUnit)))

																	// Favour
																	// wish
																	// realization
																	// for
																	// expert
																	// units
<span class="nc bnc" id="L2082" title="All 6 branches missed.">																	: (unit.isColonist() &amp;&amp; unit.getSkillLevel() &gt; 0</span>
																			&amp;&amp; old instanceof WishRealizationMission)
																					? old
<span class="nc bnc" id="L2085" title="All 2 branches missed.">																					: (unit.isColonist()</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">																							&amp;&amp; unit.getSkillLevel() &gt; 0</span>
<span class="nc bnc" id="L2087" title="All 2 branches missed.">																							&amp;&amp; (m = getWishRealizationMission(</span>
																									aiUnit,
																									null)) != null) ? m

																											// Ordinary
																											// defence
<span class="nc bnc" id="L2093" title="All 4 branches missed.">																											: ((m = getDefendSettlementMission(</span>
																													aiUnit,
																													false)) != null)
																															? m

																															// Try
																															// nearby
																															// offence
																															: (old instanceof UnitSeekAndDestroyMission)
																																	? old
<span class="nc bnc" id="L2103" title="All 4 branches missed.">																																	: ((m = getSeekAndDestroyMission(</span>
																																			aiUnit,
																																			8)) != null)
																																					? m

																																					// Missionary
																																					// missions
																																					// are
																																					// only
																																					// available
																																					// to
																																					// some
																																					// units
																																					: (old instanceof MissionaryMission)
																																							? old
<span class="nc bnc" id="L2118" title="All 4 branches missed.">																																							: ((m = getMissionaryMission(</span>
																																									aiUnit)) != null)
																																											? m

																																											// Try
																																											// to
																																											// satisfy
																																											// any
																																											// remaining
																																											// wishes,
																																											// such
																																											// as
																																											// population
																																											: (old instanceof WishRealizationMission)
																																													? old
<span class="nc bnc" id="L2133" title="All 2 branches missed.">																																													: ((m = getWishRealizationMission(</span>
																																															aiUnit,
																																															null)) != null)
																																																	? m

																																																	// Another
																																																	// try
																																																	// to
																																																	// defend,
																																																	// with
																																																	// relaxed
																																																	// cost
																																																	// decider
<span class="nc bnc" id="L2146" title="All 2 branches missed.">																																																	: ((m = getDefendSettlementMission(</span>
																																																			aiUnit,
																																																			true)) != null)
																																																					? m

																																																					// Another
																																																					// try
																																																					// to
																																																					// attack,
																																																					// at
																																																					// longer
																																																					// range
<span class="nc bnc" id="L2158" title="All 4 branches missed.">																																																					: ((m = getSeekAndDestroyMission(</span>
																																																							aiUnit,
																																																							16)) != null)
																																																									? m

																																																									// Leftover
																																																									// offensive
																																																									// units
																																																									// should
																																																									// go
																																																									// out
																																																									// looking
																																																									// for
																																																									// trouble
																																																									: (old instanceof UnitWanderHostileMission)
																																																											? old
<span class="nc bnc" id="L2174" title="All 2 branches missed.">																																																											: ((m = getWanderHostileMission(</span>
																																																													aiUnit)) != null)
																																																															? m

																																																															: null;
		}
<span class="nc" id="L2180">		return ret;</span>
	}

	// Mission creation convenience routines.
	// Aggregated here for uniformity. Might have been more logical
	// to disperse them to the individual classes.

	/**
	 * Gets a new BuildColonyMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param target
	 *            An optional target &lt;code&gt;Location&lt;/code&gt;.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getBuildColonyMission(AIUnit aiUnit, Location target) {
<span class="nc" id="L2197">		String reason = BuildColonyMission.invalidReason(aiUnit);</span>
<span class="nc bnc" id="L2198" title="All 2 branches missed.">		if (reason != null)</span>
<span class="nc" id="L2199">			return null;</span>
<span class="nc" id="L2200">		final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2201" title="All 2 branches missed.">		if (target == null) {</span>
<span class="nc" id="L2202">			target = BuildColonyMission.findTarget(aiUnit, buildingRange, unit.isInEurope());</span>
		}
<span class="nc bnc" id="L2204" title="All 2 branches missed.">		return (target == null) ? null : new BuildColonyMission(getAIMain(), aiUnit, target);</span>
	}

	/**
	 * Gets a new CashInTreasureTrainMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getCashInTreasureTrainMission(AIUnit aiUnit) {
<span class="nc" id="L2215">		String reason = CashInTreasureTrainMission.invalidReason(aiUnit);</span>
<span class="nc bnc" id="L2216" title="All 2 branches missed.">		if (reason != null)</span>
<span class="nc" id="L2217">			return null;</span>
<span class="nc" id="L2218">		final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L2219">		Location loc = CashInTreasureTrainMission.findTarget(aiUnit, cashInRange, unit.isInEurope());</span>
<span class="nc bnc" id="L2220" title="All 2 branches missed.">		return (loc == null) ? null : new CashInTreasureTrainMission(getAIMain(), aiUnit, loc);</span>
	}

	/**
	 * Gets a new DefendSettlementMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param relaxed
	 *            Use a relaxed cost decider to choose the target.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getDefendSettlementMission(AIUnit aiUnit, boolean relaxed) {
<span class="nc bnc" id="L2233" title="All 2 branches missed.">		if (DefendSettlementMission.invalidReason(aiUnit) != null)</span>
<span class="nc" id="L2234">			return null;</span>
<span class="nc" id="L2235">		final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L2236">		final Location loc = unit.getLocation();</span>
<span class="nc" id="L2237">		double worstValue = 1000000.0;</span>
<span class="nc" id="L2238">		Colony worstColony = null;</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">		for (AIColony aic : getAIColonies()) {</span>
<span class="nc" id="L2240">			Colony colony = aic.getColony();</span>
<span class="nc bnc" id="L2241" title="All 2 branches missed.">			if (aic.isBadlyDefended()) {</span>
<span class="nc bnc" id="L2242" title="All 2 branches missed.">				if (unit.isAtLocation(colony.getTile())) {</span>
<span class="nc" id="L2243">					worstColony = colony;</span>
<span class="nc" id="L2244">					break;</span>
				}
<span class="nc bnc" id="L2246" title="All 2 branches missed.">				int ttr = 1 + unit.getTurnsToReach(loc, colony.getTile(), unit.getCarrier(),</span>
<span class="nc" id="L2247">						((relaxed) ? CostDeciders.numberOfTiles() : null));</span>
<span class="nc bnc" id="L2248" title="All 2 branches missed.">				if (ttr &gt;= Unit.MANY_TURNS)</span>
<span class="nc" id="L2249">					continue;</span>
<span class="nc" id="L2250">				double value = colony.getDefenceRatio() * 100.0 / ttr;</span>
<span class="nc bnc" id="L2251" title="All 2 branches missed.">				if (worstValue &gt; value) {</span>
<span class="nc" id="L2252">					worstValue = value;</span>
<span class="nc" id="L2253">					worstColony = colony;</span>
				}
			}
<span class="nc" id="L2256">		}</span>
<span class="nc bnc" id="L2257" title="All 2 branches missed.">		return (worstColony == null) ? null : getDefendSettlementMission(aiUnit, worstColony);</span>
	}

	/**
	 * Gets a new MissionaryMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getMissionaryMission(AIUnit aiUnit) {
<span class="nc bnc" id="L2268" title="All 2 branches missed.">		if (MissionaryMission.prepare(aiUnit) != null)</span>
<span class="nc" id="L2269">			return null;</span>
<span class="nc" id="L2270">		Location loc = MissionaryMission.findTarget(aiUnit, missionaryRange, true);</span>
<span class="nc bnc" id="L2271" title="All 2 branches missed.">		if (loc == null) {</span>
<span class="nc" id="L2272">			aiUnit.equipForRole(getSpecification().getDefaultRole());</span>
<span class="nc" id="L2273">			return null;</span>
		}
<span class="nc" id="L2275">		return new MissionaryMission(getAIMain(), aiUnit, loc);</span>
	}

	/**
	 * Gets a new PioneeringMission for a unit.
	 *
	 * FIXME: pioneers to make roads between colonies
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param target
	 *            An optional target &lt;code&gt;Location&lt;/code&gt;.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getPioneeringMission(AIUnit aiUnit, Location target) {
<span class="nc bnc" id="L2290" title="All 2 branches missed.">		if (PioneeringMission.prepare(aiUnit) != null)</span>
<span class="nc" id="L2291">			return null;</span>
<span class="nc bnc" id="L2292" title="All 2 branches missed.">		if (target == null) {</span>
<span class="nc" id="L2293">			target = PioneeringMission.findTarget(aiUnit, pioneeringRange, true);</span>
		}
<span class="nc bnc" id="L2295" title="All 2 branches missed.">		if (target == null) {</span>
<span class="nc" id="L2296">			Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2297" title="All 4 branches missed.">			if (unit.isInEurope() || unit.getSettlement() != null) {</span>
<span class="nc" id="L2298">				aiUnit.equipForRole(getSpecification().getDefaultRole());</span>
			}
<span class="nc" id="L2300">			return null;</span>
		}
<span class="nc" id="L2302">		return new PioneeringMission(getAIMain(), aiUnit, target);</span>
	}

	/**
	 * Gets a new PrivateerMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param target
	 *            An optional target &lt;code&gt;Location&lt;/code&gt;.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getPrivateerMission(AIUnit aiUnit, Location target) {
<span class="nc bnc" id="L2315" title="All 2 branches missed.">		if (PrivateerMission.invalidReason(aiUnit) != null)</span>
<span class="nc" id="L2316">			return null;</span>
<span class="nc bnc" id="L2317" title="All 2 branches missed.">		if (target == null) {</span>
<span class="nc" id="L2318">			target = PrivateerMission.findTarget(aiUnit, privateerRange, true);</span>
		}
<span class="nc bnc" id="L2320" title="All 2 branches missed.">		return (target == null) ? null : new PrivateerMission(getAIMain(), aiUnit, target);</span>
	}

	/**
	 * Gets a new ScoutingMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getScoutingMission(AIUnit aiUnit) {
<span class="nc bnc" id="L2331" title="All 2 branches missed.">		if (ScoutingMission.prepare(aiUnit) != null)</span>
<span class="nc" id="L2332">			return null;</span>
<span class="nc" id="L2333">		Location loc = ScoutingMission.findTarget(aiUnit, scoutingRange, true);</span>
<span class="nc bnc" id="L2334" title="All 2 branches missed.">		if (loc == null) {</span>
<span class="nc" id="L2335">			Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2336" title="All 4 branches missed.">			if (unit.isInEurope() || unit.getSettlement() != null) {</span>
<span class="nc" id="L2337">				aiUnit.equipForRole(getSpecification().getDefaultRole());</span>
			}
<span class="nc" id="L2339">			return null;</span>
		}
<span class="nc" id="L2341">		return new ScoutingMission(getAIMain(), aiUnit, loc);</span>
	}

	/**
	 * Gets a new TransportMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getTransportMission(AIUnit aiUnit) {
<span class="nc bnc" id="L2352" title="All 2 branches missed.">		if (TransportMission.invalidReason(aiUnit) != null)</span>
<span class="nc" id="L2353">			return null;</span>
<span class="nc" id="L2354">		return new TransportMission(getAIMain(), aiUnit);</span>
	}

	/**
	 * Gets a new WishRealizationMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param wish
	 *            An optional &lt;code&gt;WorkerWish&lt;/code&gt; to realize.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getWishRealizationMission(AIUnit aiUnit, WorkerWish wish) {
<span class="nc bnc" id="L2367" title="All 2 branches missed.">		if (WishRealizationMission.invalidReason(aiUnit) != null)</span>
<span class="nc" id="L2368">			return null;</span>
<span class="nc" id="L2369">		final Unit unit = aiUnit.getUnit();</span>
<span class="nc bnc" id="L2370" title="All 2 branches missed.">		if (wish == null) {</span>
<span class="nc" id="L2371">			wish = getBestWorkerWish(aiUnit, unit.getType());</span>
		}
<span class="nc bnc" id="L2373" title="All 2 branches missed.">		if (wish == null)</span>
<span class="nc" id="L2374">			return null;</span>
<span class="nc" id="L2375">		consumeWorkerWish(aiUnit, wish);</span>
<span class="nc" id="L2376">		return new WishRealizationMission(getAIMain(), aiUnit, wish);</span>
	}

	/**
	 * Gets a WorkInsideColonyMission for a unit.
	 *
	 * @param aiUnit
	 *            The &lt;code&gt;AIUnit&lt;/code&gt; to check.
	 * @param aiColony
	 *            An optional &lt;code&gt;AIColony&lt;/code&gt; to work at.
	 * @return A new mission, or null if impossible.
	 */
	public Mission getWorkInsideColonyMission(AIUnit aiUnit, AIColony aiColony) {
<span class="pc bpc" id="L2389" title="1 of 2 branches missed.">		if (WorkInsideColonyMission.invalidReason(aiUnit) != null)</span>
<span class="nc" id="L2390">			return null;</span>
<span class="pc bpc" id="L2391" title="1 of 2 branches missed.">		if (aiColony == null) {</span>
<span class="nc" id="L2392">			aiColony = getAIColony(aiUnit.getUnit().getColony());</span>
		}
<span class="pc bpc" id="L2394" title="1 of 2 branches missed.">		return (aiColony == null) ? null : new WorkInsideColonyMission(getAIMain(), aiUnit, aiColony);</span>
	}

	// AIPlayer interface

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected Stance determineStance(Player other) {
<span class="fc" id="L2404">		final Player player = getPlayer();</span>
<span class="pc bpc" id="L2405" title="1 of 2 branches missed.">		return (other.isREF())</span>
<span class="nc bnc" id="L2406" title="All 2 branches missed.">				? ((player.getREFPlayer() == other)</span>
						// At war with our REF if rebel, otherwise at peace.
<span class="nc bnc" id="L2408" title="All 2 branches missed.">						? ((player.isRebel()) ? Stance.WAR : Stance.PEACE)</span>
						// Do not mess with other player's REF unless they
						// conquer
						// their rebellious colonies.
<span class="pc bnc" id="L2412" title="All 2 branches missed.">						: ((!other.getRebels().isEmpty()) ? Stance.PEACE : super.determineStance(other)))</span>
				// Use normal stance determination for non-REF nations.
<span class="fc" id="L2414">				: super.determineStance(other);</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void removeAIColony(AIColony aic) {
<span class="fc" id="L2422">		final Colony colony = aic.getColony();</span>

<span class="fc" id="L2424">		Set&lt;TileImprovementPlan&gt; tips = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L2425" title="All 2 branches covered.">		for (Tile t : colony.getOwnedTiles()) {</span>
<span class="fc" id="L2426">			TileImprovementPlan tip = tipMap.remove(t);</span>
<span class="pc bpc" id="L2427" title="1 of 2 branches missed.">			if (tip != null)</span>
<span class="nc" id="L2428">				tips.add(tip);</span>
<span class="fc" id="L2429">		}</span>

<span class="pc bpc" id="L2431" title="1 of 2 branches missed.">		for (AIGoods aig : aic.getExportGoods()) {</span>
<span class="nc bnc" id="L2432" title="All 2 branches missed.">			if (Map.isSameLocation(aig.getLocation(), colony)) {</span>
<span class="nc" id="L2433">				aig.changeTransport(null);</span>
<span class="nc" id="L2434">				aig.dispose();</span>
			}
<span class="nc" id="L2436">		}</span>

<span class="fc" id="L2438">		transportDemand.remove(colony);</span>

<span class="fc" id="L2440">		Set&lt;Wish&gt; wishes = new HashSet&lt;&gt;(aic.getWishes());</span>
<span class="fc bfc" id="L2441" title="All 2 branches covered.">		for (AIUnit aiu : getAIUnits()) {</span>
<span class="fc" id="L2442">			PioneeringMission pm = aiu.getMission(PioneeringMission.class);</span>
<span class="pc bpc" id="L2443" title="1 of 2 branches missed.">			if (pm != null) {</span>
<span class="nc bnc" id="L2444" title="All 2 branches missed.">				if (tips.contains(pm.getTileImprovementPlan())) {</span>
<span class="nc" id="L2445">					logger.info(pm + &quot; collapses with loss of &quot; + colony);</span>
<span class="nc" id="L2446">					aiu.changeMission(null);</span>
				}
				continue;
			}
<span class="fc" id="L2450">			WishRealizationMission wm = aiu.getMission(WishRealizationMission.class);</span>
<span class="pc bpc" id="L2451" title="1 of 2 branches missed.">			if (wm != null) {</span>
<span class="nc bnc" id="L2452" title="All 2 branches missed.">				if (wishes.contains(wm.getWish())) {</span>
<span class="nc" id="L2453">					logger.info(wm + &quot; collapses with loss of &quot; + colony);</span>
<span class="nc" id="L2454">					aiu.changeMission(null);</span>
				}
				continue;
			}
<span class="fc" id="L2458">		}</span>
<span class="fc" id="L2459">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void startWorking() {
<span class="fc" id="L2466">		final Player player = getPlayer();</span>
<span class="fc" id="L2467">		final Turn turn = getGame().getTurn();</span>
<span class="fc" id="L2468">		final Specification spec = getSpecification();</span>
<span class="fc" id="L2469">		initializeFromSpecification(spec);</span>

		// This is happening, very rarely. Hopefully now fixed by
		// synchronizing access to AIMain.aiObjects.
<span class="pc bpc" id="L2473" title="1 of 2 branches missed.">		if (getAIMain().getAIPlayer(player) != this) {</span>
<span class="nc" id="L2474">			throw new RuntimeException(&quot;EuropeanAIPlayer integrity fail&quot;);</span>
		}
<span class="fc" id="L2476">		sessionRegister.clear();</span>
<span class="fc" id="L2477">		clearAIUnits();</span>
<span class="fc" id="L2478">		player.clearNationCache();</span>
<span class="fc" id="L2479">		badlyDefended.clear();</span>

		// Note call to getAIUnits(). This triggers
		// AIPlayer.createAIUnits which we want to do early, certainly
		// before cheat() or other operations that might make new units
		// happen.
<span class="fc" id="L2485">		LogBuilder lb = new LogBuilder(1024);</span>
<span class="fc" id="L2486">		int colonyCount = getAIColonies().size();</span>
<span class="fc" id="L2487">		lb.add(player.getDebugName(), &quot; in &quot;, turn, &quot;/&quot;, turn.getNumber(), &quot; units=&quot;, getAIUnits().size(), &quot; colonies=&quot;,</span>
<span class="pc bpc" id="L2488" title="1 of 2 branches missed.">				colonyCount, &quot; declare=&quot;, (player.checkDeclareIndependence() == null), &quot; v-land-REF=&quot;,</span>
<span class="fc" id="L2489">				player.getRebelStrengthRatio(false), &quot; v-naval-REF=&quot;, player.getRebelStrengthRatio(true));</span>
<span class="pc bpc" id="L2490" title="1 of 2 branches missed.">		if (turn.isFirstTurn())</span>
<span class="fc" id="L2491">			initializeMissions(lb);</span>
<span class="fc" id="L2492">		determineStances(lb);</span>

<span class="pc bpc" id="L2494" title="1 of 2 branches missed.">		if (colonyCount &gt; 0) {</span>
<span class="nc" id="L2495">			lb.add(&quot;\n  Badly defended:&quot;); // FIXME: prioritize defence</span>
<span class="nc bnc" id="L2496" title="All 2 branches missed.">			for (AIColony aic : getAIColonies()) {</span>
<span class="nc bnc" id="L2497" title="All 2 branches missed.">				if (aic.isBadlyDefended()) {</span>
<span class="nc" id="L2498">					badlyDefended.add(aic);</span>
<span class="nc" id="L2499">					lb.add(&quot; &quot;, aic.getColony());</span>
				}
<span class="nc" id="L2501">			}</span>

<span class="nc" id="L2503">			lb.add(&quot;\n  Update colonies:&quot;);</span>
<span class="nc bnc" id="L2504" title="All 2 branches missed.">			for (AIColony aic : getAIColonies())</span>
<span class="nc" id="L2505">				aic.update(lb);</span>

<span class="nc" id="L2507">			buildTipMap(lb);</span>
<span class="nc" id="L2508">			buildWishMaps(lb);</span>
		}
<span class="fc" id="L2510">		cheat(lb);</span>
<span class="fc" id="L2511">		buildTransportMaps(lb);</span>

		// Note order of operations below. We allow rearrange et al to run
		// even when there are no movable units left because this expedites
		// mission assignment.
<span class="fc" id="L2516">		List&lt;AIUnit&gt; aiUnits = getAIUnits();</span>
<span class="pc bpc" id="L2517" title="1 of 2 branches missed.">		for (int i = 0; i &lt; 3; i++) {</span>
<span class="fc" id="L2518">			rearrangeColonies(lb);</span>
<span class="fc" id="L2519">			giveNormalMissions(lb);</span>
<span class="fc" id="L2520">			bringGifts(lb);</span>
<span class="fc" id="L2521">			demandTribute(lb);</span>
<span class="fc bfc" id="L2522" title="All 2 branches covered.">			if (aiUnits.isEmpty())</span>
<span class="fc" id="L2523">				break;</span>
<span class="fc" id="L2524">			aiUnits = doMissions(aiUnits, lb);</span>
		}
<span class="fc" id="L2526">		lb.log(logger, Level.FINE);</span>

<span class="fc" id="L2528">		clearAIUnits();</span>
<span class="fc" id="L2529">		tipMap.clear();</span>
<span class="fc" id="L2530">		transportDemand.clear();</span>
<span class="fc" id="L2531">		transportSupply.clear();</span>
<span class="fc" id="L2532">		wagonsNeeded.clear();</span>
<span class="fc" id="L2533">		goodsWishes.clear();</span>
<span class="fc" id="L2534">		workerWishes.clear();</span>
<span class="fc" id="L2535">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	protected List&lt;AIUnit&gt; doMissions(List&lt;AIUnit&gt; aiUnits, LogBuilder lb) {
<span class="fc" id="L2542">		lb.add(&quot;\n  Do missions:&quot;);</span>
<span class="fc" id="L2543">		List&lt;AIUnit&gt; result = new ArrayList&lt;&gt;();</span>

		// For all units, do their mission and collect the ones that need
		// to be revisited.
<span class="fc bfc" id="L2547" title="All 2 branches covered.">		for (AIUnit aiu : aiUnits) {</span>
<span class="fc" id="L2548">			final Unit unit = aiu.getUnit();</span>
<span class="pc bpc" id="L2549" title="2 of 4 branches missed.">			if (unit == null || unit.isDisposed())</span>
<span class="nc" id="L2550">				continue;</span>

			// giveNormalMissions should have given all units a
			// mission, but TransportMissions may have delivered a
			// unit and completed its WishRealizationMission, so it is
			// possible for a null mission to happen here. Refer such
			// units back to giveNormalMissions.
<span class="fc" id="L2557">			final Mission oldMission = aiu.getMission();</span>
<span class="pc bpc" id="L2558" title="1 of 2 branches missed.">			if (oldMission == null) {</span>
<span class="nc" id="L2559">				result.add(aiu);</span>
<span class="nc" id="L2560">				continue;</span>
			}
<span class="fc" id="L2562">			final Location oldTarget = oldMission.getTarget();</span>
<span class="fc" id="L2563">			final Location oldLocation = unit.getLocation();</span>
<span class="fc" id="L2564">			final Colony oldColony = oldLocation.getColony();</span>

			// Do the mission. Clean up dead units.
<span class="fc" id="L2567">			lb.add(&quot;\n  &quot;, unit, &quot; &quot;);</span>
			try {
<span class="fc" id="L2569">				aiu.doMission(lb);</span>
<span class="nc" id="L2570">			} catch (Exception e) {</span>
<span class="nc" id="L2571">				lb.add(&quot;, EXCEPTION: &quot;, e.getMessage());</span>
<span class="nc" id="L2572">				logger.log(Level.WARNING, &quot;doMissions failed for: &quot; + aiu, e);</span>
<span class="fc" id="L2573">			}</span>
<span class="pc bpc" id="L2574" title="2 of 4 branches missed.">			if (unit.isDisposed() || unit.getLocation() == null) {</span>
<span class="nc" id="L2575">				aiu.dropTransport();</span>
<span class="nc" id="L2576">				lb.add(&quot;, DIED.&quot;);</span>
<span class="nc" id="L2577">				continue;</span>
			}

<span class="fc" id="L2580">			updateTransport(aiu, oldTarget, lb);</span>

			// Units with moves left should be requeued. If they are on a
			// carrier the carrier needs to have moves left.
<span class="pc bpc" id="L2584" title="5 of 6 branches missed.">			if (unit.getMovesLeft() &gt; 0 &amp;&amp; (!unit.isOnCarrier() || unit.getCarrier().getMovesLeft() &gt; 0)) {</span>
<span class="nc" id="L2585">				lb.add(&quot;+&quot;);</span>
<span class="nc" id="L2586">				result.add(aiu);</span>
			} else {
<span class="fc" id="L2588">				lb.add(&quot;.&quot;);</span>
			}

			// Immediately update a newly built colony so that other
			// units that are about to wake up can see its tile
			// improvement plans.
<span class="fc" id="L2594">			Colony newColony = unit.getLocation().getColony();</span>
<span class="pc bpc" id="L2595" title="4 of 6 branches missed.">			if (oldColony == null &amp;&amp; newColony != null &amp;&amp; Map.isSameLocation(oldLocation, newColony)) {</span>
<span class="nc" id="L2596">				AIColony aiColony = getAIColony(newColony);</span>
<span class="nc" id="L2597">				aiColony.update(lb);</span>
<span class="nc" id="L2598">				updateTipMap(aiColony);</span>
			}
<span class="fc" id="L2600">		}</span>
<span class="fc" id="L2601">		return result;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int adjustMission(AIUnit aiUnit, PathNode path, Class type, int value) {
<span class="nc bnc" id="L2609" title="All 2 branches missed.">		if (value &gt; 0) {</span>
<span class="nc bnc" id="L2610" title="All 2 branches missed.">			if (type == DefendSettlementMission.class) {</span>
				// Reduce value in proportion to the number of defenders.
<span class="nc" id="L2612">				Location loc = DefendSettlementMission.extractTarget(aiUnit, path);</span>
<span class="nc bnc" id="L2613" title="All 2 branches missed.">				if (!(loc instanceof Colony)) {</span>
<span class="nc" id="L2614">					throw new IllegalStateException(&quot;European players defend colonies: &quot; + loc);</span>
				}
<span class="nc" id="L2616">				Colony colony = (Colony) loc;</span>
<span class="nc" id="L2617">				int defenders = getSettlementDefenders(colony);</span>
<span class="nc" id="L2618">				value -= 25 * defenders;</span>
				// Reduce value according to the stockade level.
<span class="nc bnc" id="L2620" title="All 2 branches missed.">				if (colony.hasStockade()) {</span>
<span class="nc bnc" id="L2621" title="All 2 branches missed.">					if (defenders &gt; colony.getStockade().getLevel() + 1) {</span>
<span class="nc" id="L2622">						value -= 100 * colony.getStockade().getLevel();</span>
					} else {
<span class="nc" id="L2624">						value -= 20 * colony.getStockade().getLevel();</span>
					}
				}
			}
		}
<span class="nc" id="L2629">		return value;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean indianDemand(Unit unit, Colony colony, GoodsType goods, int gold) {
		// FIXME: make a better choice, check whether the colony is
		// well defended
<span class="nc bnc" id="L2639" title="All 2 branches missed.">		return !&quot;conquest&quot;.equals(getAIAdvantage());</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public TradeStatus acceptDiplomaticTrade(DiplomaticTrade agreement) {
<span class="nc" id="L2647">		final Player player = getPlayer();</span>
<span class="nc" id="L2648">		final Player other = agreement.getOtherPlayer(player);</span>
<span class="nc" id="L2649">		final Market market = player.getMarket();</span>
<span class="nc" id="L2650">		final boolean franklin = other.hasAbility(Ability.ALWAYS_OFFERED_PEACE);</span>
<span class="nc" id="L2651">		final java.util.Map&lt;TradeItem, Integer&gt; scores = new HashMap&lt;&gt;();</span>
<span class="nc" id="L2652">		TradeItem peace = null;</span>
<span class="nc" id="L2653">		TradeItem cash = null;</span>
<span class="nc" id="L2654">		LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L2655">		lb.add(&quot;Evaluate trade offer from &quot;, other.getName());</span>
<span class="nc" id="L2656">		TradeStatus result = null;</span>

<span class="nc" id="L2658">		int unacceptable = 0;</span>
<span class="nc bnc" id="L2659" title="All 2 branches missed.">		for (TradeItem item : agreement.getTradeItems()) {</span>
<span class="nc bnc" id="L2660" title="All 2 branches missed.">			if (item instanceof StanceTradeItem) {</span>
<span class="nc" id="L2661">				getNationSummary(other); // Freshen the name summary cache</span>
			}
<span class="nc" id="L2663">			int value = item.evaluateFor(player);</span>
<span class="nc bnc" id="L2664" title="All 2 branches missed.">			if (item instanceof GoldTradeItem) {</span>
<span class="nc" id="L2665">				cash = item;</span>
<span class="nc bnc" id="L2666" title="All 2 branches missed.">			} else if (item instanceof StanceTradeItem) {</span>
				// Handle some special cases
<span class="nc bnc" id="L2668" title="All 3 branches missed.">				switch (item.getStance()) {</span>
				case ALLIANCE:
				case CEASE_FIRE:
<span class="nc bnc" id="L2671" title="All 2 branches missed.">					if (franklin) {</span>
<span class="nc" id="L2672">						peace = item;</span>
<span class="nc" id="L2673">						value = 0;</span>
					}
					break;
				case PEACE:
<span class="nc bnc" id="L2677" title="All 2 branches missed.">					if (agreement.getContext() == DiplomaticTrade.TradeContext.CONTACT) {</span>
<span class="nc" id="L2678">						peace = item;</span>
<span class="nc" id="L2679">						value = 0;</span>
					}
					break;
				}
			}
<span class="nc" id="L2684">			lb.add(&quot;, &quot;, Messages.message(item.getLabel()), &quot; = &quot;, value);</span>
<span class="nc bnc" id="L2685" title="All 2 branches missed.">			if (value == Integer.MIN_VALUE)</span>
<span class="nc" id="L2686">				unacceptable++;</span>
<span class="nc" id="L2687">			scores.put(item, value);</span>
<span class="nc" id="L2688">		}</span>
<span class="nc" id="L2689">		lb.add(&quot;.&quot;);</span>

		// If too many items are unacceptable, reject
<span class="nc" id="L2692">		double ratio = (double) unacceptable / (unacceptable + agreement.getTradeItems().size());</span>
<span class="nc bnc" id="L2693" title="All 2 branches missed.">		if (ratio &gt; 0.5 - 0.5 * agreement.getVersion()) {</span>
<span class="nc" id="L2694">			result = rejectAgreement(peace, agreement);</span>
<span class="nc" id="L2695">			lb.add(&quot;  Too many (&quot;, unacceptable, &quot;) unacceptable.&quot;);</span>
		}

<span class="nc" id="L2698">		int value = 0;</span>
<span class="nc bnc" id="L2699" title="All 2 branches missed.">		if (result == null) {</span>
			// Dump the unacceptable offers, sum the rest
<span class="nc bnc" id="L2701" title="All 2 branches missed.">			for (Entry&lt;TradeItem, Integer&gt; entry : scores.entrySet()) {</span>
<span class="nc bnc" id="L2702" title="All 2 branches missed.">				if (entry.getValue() == Integer.MIN_VALUE) {</span>
<span class="nc" id="L2703">					agreement.remove(entry.getKey());</span>
<span class="nc" id="L2704">					lb.add(&quot;  Dropped invalid &quot;, entry.getKey(), &quot;.&quot;);</span>
				} else {
<span class="nc" id="L2706">					value += entry.getValue();</span>
<span class="nc" id="L2707">					lb.add(&quot;  Added valid &quot;, entry.getKey(), &quot;, total = &quot;, value, &quot;.&quot;);</span>
				}
<span class="nc" id="L2709">			}</span>
			// If the result is non-negative,
			// accept/propose-without-unacceptable
<span class="nc bnc" id="L2712" title="All 2 branches missed.">			if (value &gt;= 0) {</span>
<span class="nc bnc" id="L2713" title="All 6 branches missed.">				result = (agreement.getContext() == DiplomaticTrade.TradeContext.CONTACT &amp;&amp; agreement.getVersion() == 0)</span>
						? TradeStatus.PROPOSE_TRADE
						: (unacceptable == 0) ? TradeStatus.ACCEPT_TRADE
<span class="nc bnc" id="L2716" title="All 2 branches missed.">								: (agreement.isEmpty()) ? TradeStatus.REJECT_TRADE : TradeStatus.PROPOSE_TRADE;</span>
			}
<span class="nc" id="L2718">			lb.add(&quot;  Total = &quot;, value, &quot;.&quot;);</span>
		}

<span class="nc bnc" id="L2721" title="All 2 branches missed.">		if (result == null) { // Give up?</span>
<span class="nc bnc" id="L2722" title="All 2 branches missed.">			if (randomInt(logger, &quot;Enough diplomacy?&quot;, getAIRandom(), 1 + agreement.getVersion()) &gt; 5) {</span>
<span class="nc" id="L2723">				result = rejectAgreement(peace, agreement);</span>
<span class="nc" id="L2724">				lb.add(&quot;  Ran out of patience at &quot;, agreement.getVersion(), &quot;.&quot;);</span>
			}
		}

<span class="nc bnc" id="L2728" title="All 2 branches missed.">		if (result == null) {</span>
			// Dump the negative offers until the sum is positive.
			// Return a proposal with items we like/can accept, or reject
			// if none are left.
<span class="nc bnc" id="L2732" title="All 2 branches missed.">			for (Entry&lt;TradeItem, Integer&gt; e : mapEntriesByValue(scores, ascendingIntegerComparator)) {</span>
<span class="nc bnc" id="L2733" title="All 2 branches missed.">				if (value &gt; 0)</span>
<span class="nc" id="L2734">					break;</span>
<span class="nc" id="L2735">				TradeItem item = e.getKey();</span>
<span class="nc" id="L2736">				value -= e.getValue();</span>
<span class="nc bnc" id="L2737" title="All 4 branches missed.">				if (value &gt;= 50 &amp;&amp; item instanceof GoldTradeItem) {</span>
					// Counter offer smaller amount of gold, FIXME: magic#
<span class="nc" id="L2739">					GoldTradeItem gti = (GoldTradeItem) item;</span>
<span class="nc" id="L2740">					gti.setGold(gti.getGold() - value / 2);</span>
<span class="nc" id="L2741">					value /= 2;</span>
<span class="nc" id="L2742">					lb.add(&quot;  Reducing gold item to &quot;, gti.getGold(), &quot;.&quot;);</span>
<span class="nc" id="L2743">					break;</span>
				}
<span class="nc" id="L2745">				agreement.remove(item);</span>
<span class="nc" id="L2746">				lb.add(&quot;  Dropped &quot;, item, &quot;, value now = &quot;, value, &quot;.&quot;);</span>
<span class="nc" id="L2747">			}</span>
<span class="nc bnc" id="L2748" title="All 4 branches missed.">			if (value &gt; 0 &amp;&amp; !agreement.isEmpty()) {</span>
<span class="nc" id="L2749">				result = TradeStatus.PROPOSE_TRADE;</span>
<span class="nc" id="L2750">				lb.add(&quot;  Pruned until acceptable at &quot;, value, &quot;.&quot;);</span>
			} else {
<span class="nc" id="L2752">				result = rejectAgreement(peace, agreement);</span>
<span class="nc" id="L2753">				lb.add(&quot;  Agreement unsalvageable at &quot;, value, &quot;.&quot;);</span>
			}
		}

<span class="nc" id="L2757">		lb.add(&quot; =&gt; &quot;, result);</span>
<span class="nc" id="L2758">		lb.log(logger, Level.INFO);</span>
<span class="nc" id="L2759">		return result;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void registerSellGoods(Goods goods) {
<span class="nc" id="L2767">		String goldKey = &quot;tradeGold#&quot; + goods.getType().getId() + &quot;#&quot; + goods.getAmount() + &quot;#&quot;</span>
<span class="nc" id="L2768">				+ goods.getLocation().getId();</span>
<span class="nc" id="L2769">		sessionRegister.put(goldKey, null);</span>
<span class="nc" id="L2770">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int buyProposition(Unit unit, Settlement settlement, Goods goods, int gold) {
<span class="nc" id="L2777">		logger.finest(&quot;Entering method buyProposition&quot;);</span>
<span class="nc" id="L2778">		final Specification spec = getSpecification();</span>
<span class="nc" id="L2779">		Player buyer = unit.getOwner();</span>
<span class="nc" id="L2780">		IndianSettlement is = (IndianSettlement) settlement;</span>
<span class="nc" id="L2781">		String goldKey = &quot;tradeGold#&quot; + goods.getType().getId() + &quot;#&quot; + goods.getAmount() + &quot;#&quot; + settlement.getId();</span>
<span class="nc" id="L2782">		String hagglingKey = &quot;tradeHaggling#&quot; + unit.getId();</span>
<span class="nc" id="L2783">		Integer registered = sessionRegister.get(goldKey);</span>
<span class="nc bnc" id="L2784" title="All 2 branches missed.">		if (registered == null) {</span>
<span class="nc" id="L2785">			int price = is.getPriceToSell(goods) + getPlayer().getTension(buyer).getValue();</span>
<span class="nc bnc" id="L2786" title="All 4 branches missed.">			if (is.hasMissionary(buyer) &amp;&amp; spec.getBoolean(GameOptions.ENHANCED_MISSIONARIES)) {</span>
<span class="nc" id="L2787">				Unit u = is.getMissionary();</span>
<span class="nc" id="L2788">				price = (int) FeatureContainer.applyModifiers(price, getGame().getTurn(),</span>
<span class="nc" id="L2789">						u.getMissionaryTradeModifiers(false));</span>
			}
<span class="nc" id="L2791">			sessionRegister.put(goldKey, price);</span>
<span class="nc" id="L2792">			return price;</span>
		} else {
<span class="nc" id="L2794">			int price = registered;</span>
<span class="nc bnc" id="L2795" title="All 4 branches missed.">			if (price &lt; 0 || price == gold) {</span>
<span class="nc" id="L2796">				return price;</span>
<span class="nc bnc" id="L2797" title="All 2 branches missed.">			} else if (gold &lt; (price * 9) / 10) {</span>
<span class="nc" id="L2798">				logger.warning(&quot;Cheating attempt: sending a offer too low&quot;);</span>
<span class="nc" id="L2799">				sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L2800">				return NetworkConstants.NO_TRADE;</span>
			} else {
<span class="nc" id="L2802">				int haggling = 1;</span>
<span class="nc bnc" id="L2803" title="All 2 branches missed.">				if (sessionRegister.containsKey(hagglingKey)) {</span>
<span class="nc" id="L2804">					haggling = sessionRegister.get(hagglingKey);</span>
				}
<span class="nc bnc" id="L2806" title="All 2 branches missed.">				if (randomInt(logger, &quot;Buy gold&quot;, getAIRandom(), 3 + haggling) &lt;= 3) {</span>
<span class="nc" id="L2807">					sessionRegister.put(goldKey, gold);</span>
<span class="nc" id="L2808">					sessionRegister.put(hagglingKey, haggling + 1);</span>
<span class="nc" id="L2809">					return gold;</span>
				} else {
<span class="nc" id="L2811">					sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L2812">					return NetworkConstants.NO_TRADE_HAGGLE;</span>
				}
			}
		}
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int sellProposition(Unit unit, Settlement settlement, Goods goods, int gold) {
<span class="nc" id="L2823">		logger.finest(&quot;Entering method sellProposition&quot;);</span>
<span class="nc" id="L2824">		Colony colony = (Colony) settlement;</span>
<span class="nc" id="L2825">		Player otherPlayer = unit.getOwner();</span>
		// don't pay for more than fits in the warehouse
<span class="nc" id="L2827">		int amount = colony.getWarehouseCapacity() - colony.getGoodsCount(goods.getType());</span>
<span class="nc" id="L2828">		amount = Math.min(amount, goods.getAmount());</span>
		// get a good price
<span class="nc" id="L2830">		Tension.Level tensionLevel = getPlayer().getTension(otherPlayer).getLevel();</span>
<span class="nc" id="L2831">		int percentage = (9 - tensionLevel.ordinal()) * 10;</span>
		// what we could get for the goods in Europe (minus taxes)
<span class="nc" id="L2833">		int netProfits = ((100 - getPlayer().getTax()) * getPlayer().getMarket().getSalePrice(goods.getType(), amount))</span>
				/ 100;
<span class="nc" id="L2835">		return (netProfits * percentage) / 100;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean acceptTax(int tax) {
<span class="nc" id="L2843">		boolean ret = true;</span>
<span class="nc" id="L2844">		LogBuilder lb = new LogBuilder(64);</span>
<span class="nc" id="L2845">		Goods toBeDestroyed = getPlayer().getMostValuableGoods();</span>
<span class="nc" id="L2846">		lb.add(&quot;Tax demand to &quot;, getPlayer().getName(), &quot; of &quot;, tax, &quot;% with &quot;, getPlayer().getMostValuableGoods(),</span>
				&quot; &quot;);
<span class="nc bnc" id="L2848" title="All 2 branches missed.">		GoodsType goodsType = (toBeDestroyed == null) ? null : toBeDestroyed.getType();</span>

<span class="nc bnc" id="L2850" title="All 2 branches missed.">		if (tax &lt;= 2) {</span>
			// Accept small increase.
<span class="nc" id="L2852">			ret = true;</span>
<span class="nc" id="L2853">			lb.add(&quot;accepted: small rise.&quot;);</span>
<span class="nc bnc" id="L2854" title="All 2 branches missed.">		} else if (toBeDestroyed == null) {</span>
			// Is this cheating to look at what the crown will destroy?
<span class="nc" id="L2856">			ret = false;</span>
<span class="nc" id="L2857">			lb.add(&quot;rejected: no-goods-under-threat.&quot;);</span>
<span class="nc bnc" id="L2858" title="All 2 branches missed.">		} else if (goodsType.isFoodType()) {</span>
<span class="nc" id="L2859">			ret = false;</span>
<span class="nc" id="L2860">			lb.add(&quot;rejected: food-type.&quot;);</span>
<span class="nc bnc" id="L2861" title="All 2 branches missed.">		} else if (goodsType.isBreedable()) {</span>
			// Refuse if we already have this type under production in
			// multiple places.
<span class="nc" id="L2864">			int n = 0;</span>
<span class="nc bnc" id="L2865" title="All 2 branches missed.">			for (Settlement s : getPlayer().getSettlements()) {</span>
<span class="nc bnc" id="L2866" title="All 2 branches missed.">				if (s.getGoodsCount(goodsType) &gt; 0)</span>
<span class="nc" id="L2867">					n++;</span>
<span class="nc" id="L2868">			}</span>
<span class="nc bnc" id="L2869" title="All 2 branches missed.">			ret = n &lt; 2;</span>
<span class="nc bnc" id="L2870" title="All 2 branches missed.">			if (ret) {</span>
<span class="nc" id="L2871">				lb.add(&quot;accepted: breedable-type-&quot;, goodsType.getSuffix(), &quot;-missing.&quot;);</span>
			} else {
<span class="nc" id="L2873">				lb.add(&quot;rejected: breedable-type-&quot;, goodsType.getSuffix(), &quot;-present-in-&quot;, n, &quot;-settlements.&quot;);</span>
			}
<span class="nc bnc" id="L2875" title="All 6 branches missed.">		} else if (goodsType.isMilitaryGoods() || goodsType.isTradeGoods() || goodsType.isBuildingMaterial()) {</span>
			// By age 3 we should be able to produce enough ourselves.
			// FIXME: check whether we have an armory, at least
<span class="nc" id="L2878">			int turn = getGame().getTurn().getNumber();</span>
<span class="nc bnc" id="L2879" title="All 2 branches missed.">			ret = turn &lt; 300;</span>
<span class="nc bnc" id="L2880" title="All 2 branches missed.">			lb.add(((ret) ? &quot;accepted&quot; : &quot;rejected&quot;), &quot;: special-goods-in-turn-&quot;, turn, &quot;.&quot;);</span>
<span class="nc" id="L2881">		} else {</span>
			// FIXME: consider the amount of goods produced. If we
			// depend on shipping huge amounts of cheap goods, we
			// don't want these goods to be boycotted.
<span class="nc" id="L2885">			final List&lt;GoodsType&gt; goodsTypes = getSpecification().getStorableGoodsTypeList();</span>
<span class="nc" id="L2886">			int averageIncome = goodsTypes.stream().mapToInt(gt -&gt; getPlayer().getIncomeAfterTaxes(gt)).sum()</span>
<span class="nc" id="L2887">					/ goodsTypes.size();</span>
<span class="nc" id="L2888">			int income = getPlayer().getIncomeAfterTaxes(toBeDestroyed.getType());</span>
<span class="nc bnc" id="L2889" title="All 4 branches missed.">			ret = income &lt;= 0 || income &gt; averageIncome;</span>
<span class="nc bnc" id="L2890" title="All 4 branches missed.">			lb.add(((ret) ? &quot;accepted&quot; : &quot;rejected&quot;), &quot;: goods(&quot;, goodsType.getSuffix(), &quot;)-with-income(&quot;, income,</span>
<span class="nc" id="L2891">					((ret) ? &quot;)non-positive-or-more-than(&quot; : &quot;)less-than-average(&quot;), averageIncome, &quot;).&quot;);</span>
		}
<span class="nc bnc" id="L2893" title="All 2 branches missed.">		if (!ret)</span>
<span class="nc" id="L2894">			suppressEuropeanTrade(goodsType, lb);</span>
<span class="nc" id="L2895">		lb.log(logger, Level.INFO);</span>
<span class="nc" id="L2896">		return ret;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public boolean acceptMercenaries() {
<span class="nc bnc" id="L2904" title="All 4 branches missed.">		return getPlayer().isAtWar() || &quot;conquest&quot;.equals(getAIAdvantage());</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public FoundingFather selectFoundingFather(List&lt;FoundingFather&gt; ffs) {
<span class="nc" id="L2912">		final int age = getGame().getAge();</span>
<span class="nc" id="L2913">		FoundingFather bestFather = null;</span>
<span class="nc" id="L2914">		int bestWeight = Integer.MIN_VALUE;</span>
<span class="nc bnc" id="L2915" title="All 2 branches missed.">		for (FoundingFather father : ffs) {</span>
<span class="nc bnc" id="L2916" title="All 2 branches missed.">			if (father == null)</span>
<span class="nc" id="L2917">				continue;</span>

			// For the moment, arbitrarily: always choose the one
			// offering custom houses. Allowing the AI to build CH
			// early alleviates the complexity problem of handling all
			// TransportMissions correctly somewhat.
<span class="nc bnc" id="L2923" title="All 2 branches missed.">			if (father.hasAbility(Ability.BUILD_CUSTOM_HOUSE)) {</span>
<span class="nc" id="L2924">				bestFather = father;</span>
<span class="nc" id="L2925">				break;</span>
			}

<span class="nc" id="L2928">			int weight = father.getWeight(age);</span>
<span class="nc bnc" id="L2929" title="All 2 branches missed.">			if (weight &gt; bestWeight) {</span>
<span class="nc" id="L2930">				bestWeight = weight;</span>
<span class="nc" id="L2931">				bestFather = father;</span>
			}
<span class="nc" id="L2933">		}</span>
<span class="nc" id="L2934">		return bestFather;</span>
	}

	// Serialization

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String getXMLTagName() {
<span class="fc" id="L2944">		return getXMLElementTagName();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>