<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NativeAIPlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.ai</a> &gt; <span class="el_source">NativeAIPlayer.java</span></div><h1>NativeAIPlayer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.ai;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Random;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.xml.stream.XMLStreamException;

import net.sf.freecol.common.io.FreeColXMLReader;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.CombatModel;
import net.sf.freecol.common.model.FeatureContainer;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Modifier;
import net.sf.freecol.common.model.Ownable;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.pathfinding.CostDecider;
import net.sf.freecol.common.model.pathfinding.CostDeciders;
import net.sf.freecol.common.networking.NetworkConstants;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import static net.sf.freecol.common.util.RandomUtils.*;
import net.sf.freecol.server.ai.mission.DefendSettlementMission;
import net.sf.freecol.server.ai.mission.IndianBringGiftMission;
import net.sf.freecol.server.ai.mission.IndianDemandMission;
import net.sf.freecol.server.ai.mission.Mission;
import net.sf.freecol.server.ai.mission.UnitSeekAndDestroyMission;
import net.sf.freecol.server.ai.mission.UnitWanderHostileMission;
import net.sf.freecol.server.model.ServerPlayer;

/**
 * Objects of this class contains AI-information for a single {@link Player} and
 * is used for controlling this player.
 *
 * The method {@link #startWorking} gets called by the
 * {@link AIInGameInputHandler} when it is this player's turn.
 */
public class NativeAIPlayer extends AIPlayer {

	/** The Constant logger. */
<span class="fc" id="L79">	private static final Logger logger = Logger.getLogger(NativeAIPlayer.class.getName());</span>

	/** The Constant MAX_DISTANCE_TO_BRING_GIFTS. */
	public static final int MAX_DISTANCE_TO_BRING_GIFTS = 5;

	/** The Constant MAX_NUMBER_OF_GIFTS_BEING_DELIVERED. */
	public static final int MAX_NUMBER_OF_GIFTS_BEING_DELIVERED = 1;

	/** The Constant MAX_DISTANCE_TO_MAKE_DEMANDS. */
	public static final int MAX_DISTANCE_TO_MAKE_DEMANDS = 5;

	/** The Constant MAX_NUMBER_OF_DEMANDS. */
	public static final int MAX_NUMBER_OF_DEMANDS = 1;

	/**
	 * Stores temporary information for sessions (trading with another player
	 * etc).
	 */
<span class="fc" id="L97">	private final HashMap&lt;String, Integer&gt; sessionRegister = new HashMap&lt;&gt;();</span>

	/**
	 * Debug helper to keep track of why/what the units are doing. Do not
	 * serialize.
	 */
<span class="fc" id="L103">	private final java.util.Map&lt;Unit, String&gt; reasons = new HashMap&lt;&gt;();</span>

	/**
	 * Creates a new &lt;code&gt;AIPlayer&lt;/code&gt;.
	 *
	 * @param aiMain
	 *            The main AI-class.
	 * @param player
	 *            The player that should be associated with this
	 *            &lt;code&gt;AIPlayer&lt;/code&gt;.
	 */
	public NativeAIPlayer(AIMain aiMain, ServerPlayer player) {
<span class="fc" id="L115">		super(aiMain, player);</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">		uninitialized = getPlayer() == null;</span>
<span class="fc" id="L118">	}</span>

	/**
	 * Creates a new &lt;code&gt;AIPlayer&lt;/code&gt;.
	 *
	 * @param aiMain
	 *            The main AI-object.
	 * @param xr
	 *            The input stream containing the XML.
	 * @throws XMLStreamException
	 *             if a problem was encountered during parsing.
	 */
	public NativeAIPlayer(AIMain aiMain, FreeColXMLReader xr) throws XMLStreamException {
<span class="fc" id="L131">		super(aiMain, xr);</span>

<span class="pc bpc" id="L133" title="1 of 2 branches missed.">		uninitialized = getPlayer() == null;</span>
<span class="fc" id="L134">	}</span>

	/**
	 * Simple initialization of AI missions given that we know the starting
	 * conditions.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void initializeMissions(LogBuilder lb) {
<span class="nc" id="L144">		final AIMain aiMain = getAIMain();</span>
<span class="nc" id="L145">		final Player player = getPlayer();</span>
<span class="nc" id="L146">		lb.add(&quot;\n  Initialize&quot;);</span>

		// Give defensive missions up to the minimum expected defence,
		// leave the rest with the default wander-hostile mission.
<span class="nc" id="L150">		List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">		for (IndianSettlement is : player.getIndianSettlements()) {</span>
<span class="nc" id="L152">			units.clear();</span>
<span class="nc" id="L153">			units.addAll(is.getTile().getUnitList());</span>
<span class="nc" id="L154">			units.addAll(is.getUnitList());</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">			while (units.size() &gt; is.getRequiredDefenders()) {</span>
<span class="nc" id="L156">				Unit u = units.remove(0);</span>
<span class="nc" id="L157">				AIUnit aiu = getAIUnit(u);</span>
<span class="nc" id="L158">				Mission m = getWanderHostileMission(aiu);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">				if (m != null)</span>
<span class="nc" id="L160">					lb.add(&quot; &quot;, m);</span>
<span class="nc" id="L161">			}</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">			for (Unit u : units) {</span>
<span class="nc" id="L163">				AIUnit aiu = getAIUnit(u);</span>
<span class="nc" id="L164">				Mission m = getDefendSettlementMission(aiu, is);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">				if (m != null)</span>
<span class="nc" id="L166">					lb.add(&quot; &quot;, m);</span>
<span class="nc" id="L167">			}</span>
<span class="nc" id="L168">		}</span>
<span class="nc" id="L169">	}</span>

	/**
	 * Determines the stances towards each player. That is: should we declare
	 * war?
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void determineStances(LogBuilder lb) {
<span class="nc" id="L179">		final ServerPlayer serverPlayer = (ServerPlayer) getPlayer();</span>
<span class="nc" id="L180">		lb.mark();</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">		for (Player p : getGame().getLivePlayers(serverPlayer)) {</span>
<span class="nc" id="L183">			Stance newStance = determineStance(p);</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">			if (newStance != serverPlayer.getStance(p)) {</span>
<span class="nc" id="L185">				getAIMain().getFreeColServer().getInGameController().changeStance(serverPlayer, newStance,</span>
						(ServerPlayer) p, true);
<span class="nc" id="L187">				lb.add(&quot; &quot;, p.getDebugName(), &quot;-&gt;&quot;, newStance, &quot;, &quot;);</span>
			}
<span class="nc" id="L189">		}</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">		if (lb.grew(&quot;\n  Stance changes:&quot;))</span>
<span class="nc" id="L191">			lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L192">	}</span>

	/**
	 * Takes the necessary actions to secure the settlements. This is done by
	 * making new military units or to give existing units new missions.
	 *
	 * @param randoms
	 *            An array of random settlement indexes.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void secureSettlements(int[] randoms, LogBuilder lb) {
<span class="nc" id="L204">		int randomIdx = 0;</span>
<span class="nc" id="L205">		List&lt;IndianSettlement&gt; settlements = getPlayer().getIndianSettlements();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">		for (IndianSettlement is : settlements) {</span>
			// Spread arms and horses between camps
			// FIXME: maybe make this dependent on difficulty level?
<span class="nc" id="L209">			int n = randoms[randomIdx++];</span>
<span class="nc" id="L210">			IndianSettlement settlement = settlements.get(n);</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">			if (settlement != is) {</span>
<span class="nc" id="L212">				is.tradeGoodsWithSettlement(settlement);</span>
			}
<span class="nc" id="L214">		}</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">		for (IndianSettlement is : settlements) {</span>
<span class="nc" id="L216">			lb.mark();</span>
<span class="nc" id="L217">			equipBraves(is, lb);</span>
<span class="nc" id="L218">			secureIndianSettlement(is, lb);</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">			if (lb.grew(&quot;\n  At &quot;, is.getName()))</span>
<span class="nc" id="L220">				lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L221">		}</span>
<span class="nc" id="L222">	}</span>

	/**
	 * Greedily equips braves with horses and muskets. Public for the test
	 * suite.
	 *
	 * @param is
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; where the equipping occurs.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	public void equipBraves(IndianSettlement is, LogBuilder lb) {
<span class="fc" id="L234">		final Specification spec = getSpecification();</span>

		// Find all the units
<span class="fc" id="L237">		List&lt;Unit&gt; units = is.getUnitList();</span>
<span class="fc" id="L238">		units.addAll(is.getTile().getUnitList());</span>

		// Prioritize promoting partially equipped units to full dragoon
<span class="fc" id="L241">		Collections.sort(units, getGame().getCombatModel().getMilitaryStrengthComparator());</span>

<span class="fc" id="L243">		boolean moreHorses = true, moreMuskets = true;</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">		for (Unit u : units) {</span>
<span class="fc" id="L245">			Role r = is.canImproveUnitMilitaryRole(u);</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">			if (r != null) {</span>
<span class="fc" id="L247">				Role old = u.getRole();</span>
<span class="pc bpc" id="L248" title="2 of 4 branches missed.">				if (getAIUnit(u).equipForRole(r) &amp;&amp; u.getRole() != old) {</span>
<span class="fc" id="L249">					lb.add(u, &quot; upgraded from &quot;, old.getSuffix(), &quot;, &quot;);</span>
				}
			}
<span class="fc" id="L252">		}</span>
<span class="fc" id="L253">	}</span>

	/**
	 * Takes the necessary actions to secure an indian settlement Public for the
	 * test suite.
	 *
	 * @param is
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; to secure.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	public void secureIndianSettlement(final IndianSettlement is, LogBuilder lb) {
<span class="fc" id="L265">		final AIMain aiMain = getAIMain();</span>
<span class="fc" id="L266">		final Player player = getPlayer();</span>
<span class="fc" id="L267">		final CombatModel cm = getGame().getCombatModel();</span>
<span class="fc" id="L268">		final int minimumDefence = is.getType().getMinimumSize() - 1;</span>
		DefendSettlementMission dm;

		// Collect native units and defenders
<span class="fc" id="L272">		List&lt;Unit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L273">		List&lt;Unit&gt; defenders = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L274">		units.addAll(is.getUnitList());</span>
<span class="fc" id="L275">		units.addAll(is.getTile().getUnitList());</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">		for (Unit u : is.getOwnedUnits()) {</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">			if (!units.contains(u))</span>
<span class="nc" id="L278">				units.add(u);</span>
<span class="fc" id="L279">		}</span>

		// Collect the current defenders
<span class="fc bfc" id="L282" title="All 2 branches covered.">		for (Unit u : new ArrayList&lt;&gt;(units)) {</span>
<span class="fc" id="L283">			AIUnit aiu = aiMain.getAIUnit(u);</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">			if (aiu == null) {</span>
<span class="nc" id="L285">				units.remove(u);</span>
<span class="pc bpc" id="L286" title="3 of 4 branches missed.">			} else if ((dm = aiu.getMission(DefendSettlementMission.class)) != null &amp;&amp; dm.getTarget() == is) {</span>
<span class="nc" id="L287">				defenders.add(u);</span>
<span class="nc" id="L288">				units.remove(u);</span>
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">			} else if (Mission.invalidNewMissionReason(aiu) != null) {</span>
<span class="nc" id="L290">				units.remove(u);</span>
			}
<span class="fc" id="L292">		}</span>

		// Collect threats and other potential defenders
<span class="fc" id="L295">		final HashMap&lt;Tile, Double&gt; threats = new HashMap&lt;&gt;();</span>
		Player enemy;
		Tension tension;
<span class="fc bfc" id="L298" title="All 2 branches covered.">		for (Tile t : is.getTile().getSurroundingTiles(is.getRadius() + 1)) {</span>
<span class="fc bfc" id="L299" title="All 4 branches covered.">			if (!t.isLand() || t.getUnitCount() == 0) {</span>
				; // Do nothing
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">			} else if ((enemy = t.getFirstUnit().getOwner()) == player) {</span>
				// Its one of ours!
<span class="nc bnc" id="L303" title="All 2 branches missed.">				for (Unit u : t.getUnitList()) {</span>
					AIUnit aiu;
<span class="nc bnc" id="L305" title="All 6 branches missed.">					if (defenders.contains(u) || units.contains(u) || (aiu = aiMain.getAIUnit(u)) == null) {</span>
						; // Do nothing
<span class="nc bnc" id="L307" title="All 4 branches missed.">					} else if ((dm = aiu.getMission(DefendSettlementMission.class)) != null &amp;&amp; dm.getTarget() == is) {</span>
<span class="nc" id="L308">						defenders.add(u);</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">					} else if (Mission.invalidNewMissionReason(aiu) == null) {</span>
<span class="nc" id="L310">						units.add(u);</span>
					}
<span class="nc" id="L312">				}</span>
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">			} else if ((tension = is.getAlarm(enemy)) == null</span>
<span class="fc bfc" id="L314" title="All 2 branches covered.">					|| tension.getLevel().compareTo(Tension.Level.CONTENT) &lt;= 0) {</span>
				; // Not regarded as a threat
			} else {
				// Evaluate the threat
<span class="fc" id="L318">				double threshold, bonus, value = 0.0;</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">				if (tension.getLevel().compareTo(Tension.Level.DISPLEASED) &lt;= 0) {</span>
<span class="nc" id="L320">					threshold = 1.0;</span>
<span class="nc" id="L321">					bonus = 0.0f;</span>
				} else {
<span class="fc" id="L323">					threshold = 0.0;</span>
<span class="fc" id="L324">					bonus = (float) tension.getLevel().ordinal() - Tension.Level.CONTENT.ordinal();</span>
				}
<span class="pc bpc" id="L326" title="1 of 2 branches missed.">				value += t.getUnitList().stream().filter(u -&gt; cm.getOffencePower(u, is) &gt; threshold)</span>
<span class="fc" id="L327">						.mapToDouble(u -&gt; cm.getOffencePower(u, is) + bonus).sum();</span>
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">				if (value &gt; 0.0)</span>
<span class="fc" id="L329">					threats.put(t, value);</span>
			}
<span class="fc" id="L331">		}</span>

		// Sort the available units by proximity to the settlement.
		// Simulates favouring the first warriors found by outgoing messengers.
		// Also favour units native to the settlement.
<span class="fc" id="L336">		final int homeBonus = 3;</span>
<span class="fc" id="L337">		final Tile isTile = is.getTile();</span>
<span class="fc" id="L338">		final Comparator&lt;Unit&gt; isComparator = new Comparator&lt;Unit&gt;() {</span>
			@Override
			public int compare(Unit u1, Unit u2) {
<span class="fc" id="L341">				Tile t1 = u1.getTile();</span>
<span class="fc" id="L342">				int s1 = t1.getDistanceTo(isTile);</span>
<span class="fc" id="L343">				Tile t2 = u2.getTile();</span>
<span class="fc" id="L344">				int s2 = t2.getDistanceTo(isTile);</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">				if (u1.getHomeIndianSettlement() == is)</span>
<span class="fc" id="L346">					s1 -= homeBonus;</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">				if (u2.getHomeIndianSettlement() == is)</span>
<span class="fc" id="L348">					s2 -= homeBonus;</span>
<span class="fc" id="L349">				return s1 - s2;</span>
			}
		};

		// Do we need more or less defenders?
<span class="fc" id="L354">		int needed = minimumDefence + threats.size();</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">		if (defenders.size() &lt; needed) { // More needed, call some in.</span>
<span class="fc" id="L356">			Collections.sort(units, isComparator);</span>
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">			while (!units.isEmpty()) {</span>
<span class="fc" id="L358">				Unit u = units.remove(0);</span>
<span class="fc" id="L359">				AIUnit aiu = aiMain.getAIUnit(u);</span>
<span class="fc" id="L360">				Mission m = getDefendSettlementMission(aiu, is);</span>
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">				if (m != null) {</span>
<span class="fc" id="L362">					lb.add(m, &quot;, &quot;);</span>
<span class="fc" id="L363">					defenders.add(u);</span>
<span class="fc bfc" id="L364" title="All 2 branches covered.">					if (defenders.size() &gt;= needed)</span>
<span class="fc" id="L365">						break;</span>
				}
<span class="fc" id="L367">			}</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">		} else if (defenders.size() &gt; needed) { // Less needed, release them</span>
<span class="nc" id="L369">			Collections.sort(defenders, isComparator);</span>
<span class="nc" id="L370">			Collections.reverse(defenders);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">			while (defenders.size() &gt; needed) {</span>
<span class="nc" id="L372">				units.add(defenders.remove(0));</span>
			}
		}

		// Sort threat tiles by threat value.
<span class="fc" id="L377">		List&lt;Tile&gt; threatTiles = new ArrayList&lt;&gt;(threats.keySet());</span>
<span class="fc" id="L378">		Collections.sort(threatTiles, new Comparator&lt;Tile&gt;() {</span>
			@Override
			public int compare(Tile t1, Tile t2) {
<span class="nc" id="L381">				return Double.compare(threats.get(t2), threats.get(t1));</span>
			}
		});

<span class="pc bpc" id="L385" title="1 of 2 branches missed.">		if (!defenders.isEmpty()) {</span>
<span class="fc" id="L386">			lb.add(&quot; defend with:&quot;);</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">			for (Unit u : defenders)</span>
<span class="fc" id="L388">				lb.add(&quot; &quot;, u);</span>
<span class="fc" id="L389">			lb.add(&quot; minimum=&quot;, minimumDefence, &quot; threats=&quot;, threats.size(), &quot;, &quot;);</span>
		}

		// Assign units to attack the threats, greedily chosing closest unit.
<span class="pc bpc" id="L393" title="1 of 4 branches missed.">		while (!threatTiles.isEmpty() &amp;&amp; !units.isEmpty()) {</span>
<span class="fc" id="L394">			Tile tile = threatTiles.remove(0);</span>
<span class="fc" id="L395">			int bestDistance = Integer.MAX_VALUE;</span>
<span class="fc" id="L396">			Unit unit = null;</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">			for (Unit u : units) {</span>
<span class="fc" id="L398">				AIUnit aiu = aiMain.getAIUnit(u);</span>
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">				if (UnitSeekAndDestroyMission.invalidReason(aiu, tile.getDefendingUnit(u)) != null)</span>
<span class="nc" id="L400">					continue;</span>
<span class="fc" id="L401">				int distance = u.getTile().getDistanceTo(tile);</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">				if (bestDistance &gt; distance) {</span>
<span class="fc" id="L403">					bestDistance = distance;</span>
<span class="fc" id="L404">					unit = u;</span>
				}
<span class="fc" id="L406">			}</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">			if (unit == null)</span>
<span class="nc" id="L408">				continue; // Declined to attack.</span>
<span class="fc" id="L409">			units.remove(unit);</span>
<span class="fc" id="L410">			AIUnit aiUnit = aiMain.getAIUnit(unit);</span>
<span class="fc" id="L411">			Unit target = tile.getDefendingUnit(unit);</span>
<span class="fc" id="L412">			Mission m = getSeekAndDestroyMission(aiUnit, target);</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">			if (m != null)</span>
<span class="fc" id="L414">				lb.add(m, &quot;, &quot;);</span>
<span class="fc" id="L415">		}</span>
<span class="fc" id="L416">	}</span>

	/**
	 * Gives a mission to all units.
	 *
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void giveNormalMissions(LogBuilder lb) {
<span class="nc" id="L425">		final AIMain aiMain = getAIMain();</span>
<span class="nc" id="L426">		final Player player = getPlayer();</span>
<span class="nc" id="L427">		final Specification spec = getSpecification();</span>
<span class="nc" id="L428">		final int turnNumber = getGame().getTurn().getNumber();</span>
<span class="nc" id="L429">		List&lt;AIUnit&gt; aiUnits = getAIUnits();</span>

<span class="nc" id="L431">		lb.mark();</span>
<span class="nc" id="L432">		List&lt;AIUnit&gt; done = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L433">		reasons.clear();</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">		for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L435">			final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L436">			Mission m = aiUnit.getMission();</span>
<span class="nc" id="L437">			String reason = null;</span>

<span class="nc bnc" id="L439" title="All 4 branches missed.">			if (unit.isUninitialized() || unit.isDisposed()) {</span>
<span class="nc" id="L440">				reasons.put(unit, &quot;Invalid&quot;);</span>

<span class="nc bnc" id="L442" title="All 6 branches missed.">			} else if (m != null &amp;&amp; m.isValid() &amp;&amp; !m.isOneTime()) {</span>
<span class="nc" id="L443">				reasons.put(unit, &quot;Valid&quot;);</span>

			} else { // Unit needs a mission
				continue;
			}
<span class="nc" id="L448">			done.add(aiUnit);</span>
<span class="nc" id="L449">		}</span>
<span class="nc" id="L450">		aiUnits.removeAll(done);</span>
<span class="nc" id="L451">		done.clear();</span>

<span class="nc bnc" id="L453" title="All 2 branches missed.">		for (AIUnit aiUnit : aiUnits) {</span>
<span class="nc" id="L454">			final Unit unit = aiUnit.getUnit();</span>
<span class="nc" id="L455">			final Settlement settlement = unit.getSettlement();</span>
<span class="nc" id="L456">			final IndianSettlement is = unit.getHomeIndianSettlement();</span>
<span class="nc" id="L457">			Mission m = aiUnit.getMission();</span>

<span class="nc bnc" id="L459" title="All 4 branches missed.">			if (settlement != null &amp;&amp; settlement.getUnitCount() + settlement.getTile().getUnitCount() &lt;= 1) {</span>
				// First see to local settlement defence
<span class="nc bnc" id="L461" title="All 4 branches missed.">				if (!(m instanceof DefendSettlementMission) || m.getTarget() != settlement) {</span>
<span class="nc" id="L462">					m = getDefendSettlementMission(aiUnit, settlement);</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">					if (m == null)</span>
<span class="nc" id="L464">						continue;</span>
<span class="nc" id="L465">					lb.add(m, &quot;, &quot;);</span>
				}
<span class="nc" id="L467">				reasons.put(unit, &quot;Defend-&quot; + settlement.getName());</span>

<span class="nc bnc" id="L469" title="All 4 branches missed.">			} else if (is != null &amp;&amp; is.canImproveUnitMilitaryRole(unit) != null) {</span>
				// Go home for new equipment if the home settlement has it
<span class="nc bnc" id="L471" title="All 4 branches missed.">				if (!(m instanceof DefendSettlementMission) || m.getTarget() != is) {</span>
<span class="nc" id="L472">					m = getDefendSettlementMission(aiUnit, is);</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">					if (m == null)</span>
<span class="nc" id="L474">						continue;</span>
<span class="nc" id="L475">					lb.add(m, &quot;, &quot;);</span>
				}
<span class="nc" id="L477">				reasons.put(unit, &quot;Equip-&quot; + is.getName());</span>

			} else {
				// Go out looking for trouble
<span class="nc bnc" id="L481" title="All 2 branches missed.">				if (!(m instanceof UnitWanderHostileMission)) {</span>
<span class="nc" id="L482">					m = getWanderHostileMission(aiUnit);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">					if (m == null)</span>
<span class="nc" id="L484">						continue;</span>
<span class="nc" id="L485">					lb.add(m, &quot;, &quot;);</span>
				}
<span class="nc" id="L487">				reasons.put(unit, &quot;Patrol&quot;);</span>
			}
<span class="nc" id="L489">			done.add(aiUnit);</span>
<span class="nc" id="L490">		}</span>
<span class="nc" id="L491">		aiUnits.removeAll(done);</span>
<span class="nc" id="L492">		done.clear();</span>

		// Log
<span class="nc bnc" id="L495" title="All 2 branches missed.">		if (lb.grew(&quot;\n  Mission changes: &quot;))</span>
<span class="nc" id="L496">			lb.shrink(&quot;, &quot;);</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">		if (!aiUnits.isEmpty()) {</span>
<span class="nc" id="L498">			lb.add(&quot;\n  Free Land Units:&quot;);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">			for (AIUnit aiu : aiUnits)</span>
<span class="nc" id="L500">				lb.add(&quot; &quot;, aiu.getUnit());</span>
		}
<span class="nc" id="L502">		lb.add(&quot;\n  Missions(settlements=&quot;, player.getNumberOfSettlements(), &quot;)&quot;);</span>
<span class="nc" id="L503">		logMissions(reasons, lb);</span>
<span class="nc" id="L504">	}</span>

	/**
	 * Brings gifts to nice players with nearby colonies.
	 *
	 * @param randoms
	 *            An array of random percentages.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void bringGifts(int[] randoms, LogBuilder lb) {
<span class="nc" id="L515">		final Player player = getPlayer();</span>
<span class="nc" id="L516">		final CostDecider cd = CostDeciders.numberOfLegalTiles();</span>
<span class="nc" id="L517">		final int giftProbability = getSpecification().getInteger(GameOptions.GIFT_PROBABILITY);</span>
<span class="nc" id="L518">		int randomIdx = 0;</span>
<span class="nc" id="L519">		lb.mark();</span>

<span class="nc bnc" id="L521" title="All 2 branches missed.">		for (IndianSettlement is : player.getIndianSettlements()) {</span>
			// Do not bring gifts all the time.
<span class="nc bnc" id="L523" title="All 2 branches missed.">			if (randoms[randomIdx++] &gt;= giftProbability)</span>
<span class="nc" id="L524">				continue;</span>

			// Check if the settlement has anything to give.
<span class="nc" id="L527">			Goods gift = is.getRandomGift(getAIRandom());</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">			if (gift == null)</span>
<span class="nc" id="L529">				continue;</span>

			// Check if there are available units, and if there are already
			// enough missions in operation.
<span class="nc" id="L533">			List&lt;Unit&gt; availableUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L534">			int alreadyAssignedUnits = 0;</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">			for (Unit ou : is.getOwnedUnits()) {</span>
<span class="nc" id="L536">				AIUnit aiu = getAIUnit(ou);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">				if (aiu == null) {</span>
<span class="nc" id="L538">					continue;</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">				} else if (aiu.hasMission(IndianBringGiftMission.class)) {</span>
<span class="nc" id="L540">					alreadyAssignedUnits++;</span>
<span class="nc bnc" id="L541" title="All 2 branches missed.">				} else if (Mission.invalidNewMissionReason(aiu) == null) {</span>
<span class="nc" id="L542">					availableUnits.add(ou);</span>
				}
<span class="nc" id="L544">			}</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">			if (alreadyAssignedUnits &gt; MAX_NUMBER_OF_GIFTS_BEING_DELIVERED) {</span>
<span class="nc" id="L546">				lb.add(is.getName(), &quot; has &quot;, alreadyAssignedUnits, &quot; already, &quot;);</span>
<span class="nc" id="L547">				continue;</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">			} else if (availableUnits.isEmpty()) {</span>
<span class="nc" id="L549">				lb.add(is.getName(), &quot; has no gift units, &quot;);</span>
<span class="nc" id="L550">				continue;</span>
			}
			// Pick a random available capable unit.
<span class="nc" id="L553">			Unit unit = null;</span>
<span class="nc" id="L554">			AIUnit aiUnit = null;</span>
<span class="nc" id="L555">			Tile home = is.getTile();</span>
<span class="nc bnc" id="L556" title="All 4 branches missed.">			while (unit == null &amp;&amp; !availableUnits.isEmpty()) {</span>
<span class="nc" id="L557">				Unit u = availableUnits.get(randomInt(logger, &quot;Gift unit&quot;, getAIRandom(), availableUnits.size()));</span>
<span class="nc" id="L558">				availableUnits.remove(u);</span>
<span class="nc" id="L559">				aiUnit = getAIUnit(u);</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">				if (IndianBringGiftMission.invalidReason(aiUnit) == null</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">						&amp;&amp; u.findPath(u.getTile(), home, null, cd) != null) {</span>
<span class="nc" id="L562">					unit = u;</span>
				}
<span class="nc" id="L564">			}</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">			if (unit == null) {</span>
<span class="nc" id="L566">				lb.add(is.getName(), &quot; found no gift unit, &quot;);</span>
<span class="nc" id="L567">				continue;</span>
			}

			// Collect nearby colonies. Filter out ones which are uncontacted,
			// unreachable or otherwise unsuitable. Score the rest on alarm
			// and distance.
<span class="nc" id="L573">			List&lt;RandomChoice&lt;Colony&gt;&gt; nearbyColonies = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L574" title="All 2 branches missed.">			for (Tile t : home.getSurroundingTiles(MAX_DISTANCE_TO_BRING_GIFTS)) {</span>
<span class="nc" id="L575">				Colony c = t.getColony();</span>
				PathNode path;
<span class="nc bnc" id="L577" title="All 4 branches missed.">				if (c == null || !is.hasContacted(c.getOwner())</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">						|| IndianBringGiftMission.invalidReason(aiUnit, c) != null</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">						|| (path = unit.findPath(home, c.getTile(), null, cd)) == null)</span>
<span class="nc" id="L580">					continue;</span>
<span class="nc" id="L581">				int alarm = Math.max(1, is.getAlarm(c.getOwner()).getValue());</span>
<span class="nc" id="L582">				nearbyColonies.add(new RandomChoice&lt;&gt;(c, 1000000 / alarm / path.getTotalTurns()));</span>
<span class="nc" id="L583">			}</span>

			// If there are any suitable colonies, pick a random one
			// to send a gift to.
<span class="nc bnc" id="L587" title="All 2 branches missed.">			if (nearbyColonies.isEmpty()) {</span>
<span class="nc" id="L588">				lb.add(is.getName(), &quot; found no gift colonies, &quot;);</span>
<span class="nc" id="L589">				continue;</span>
			}
<span class="nc" id="L591">			Colony target = RandomChoice.getWeightedRandom(logger, &quot;Choose gift colony&quot;, nearbyColonies, getAIRandom());</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">			if (target == null) {</span>
<span class="nc" id="L593">				throw new IllegalStateException(&quot;No gift target!?!&quot;);</span>
			}

			// Send the unit.
<span class="nc" id="L597">			Mission m = new IndianBringGiftMission(getAIMain(), aiUnit, target);</span>
<span class="nc" id="L598">			lb.add(m, &quot; gift from &quot;, is.getName(), &quot; to &quot;, target.getName(), &quot;, &quot;);</span>
<span class="nc" id="L599">		}</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">		if (lb.grew(&quot;\n  Gifts: &quot;))</span>
<span class="nc" id="L601">			lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L602">	}</span>

	/**
	 * Demands tribute from nasty players with nearby colonies.
	 *
	 * @param randoms
	 *            An array of random percentages.
	 * @param lb
	 *            A &lt;code&gt;LogBuilder&lt;/code&gt; to log to.
	 */
	private void demandTribute(int[] randoms, LogBuilder lb) {
<span class="nc" id="L613">		final Player player = getPlayer();</span>
<span class="nc" id="L614">		final CostDecider cd = CostDeciders.numberOfLegalTiles();</span>
<span class="nc" id="L615">		final int demandProbability = getSpecification().getInteger(GameOptions.DEMAND_PROBABILITY);</span>
<span class="nc" id="L616">		int randomIdx = 0;</span>
<span class="nc" id="L617">		lb.mark();</span>

<span class="nc bnc" id="L619" title="All 2 branches missed.">		for (IndianSettlement is : player.getIndianSettlements()) {</span>
			// Do not demand tribute all of the time.
<span class="nc bnc" id="L621" title="All 2 branches missed.">			if (randoms[randomIdx++] &gt;= demandProbability)</span>
<span class="nc" id="L622">				continue;</span>

			// Check if there are available units, and if there are already
			// enough missions in operation.
<span class="nc" id="L626">			List&lt;Unit&gt; availableUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L627">			int alreadyAssignedUnits = 0;</span>
<span class="nc bnc" id="L628" title="All 2 branches missed.">			for (Unit ou : is.getOwnedUnits()) {</span>
<span class="nc" id="L629">				AIUnit aiu = getAIUnit(ou);</span>
<span class="nc bnc" id="L630" title="All 2 branches missed.">				if (Mission.invalidNewMissionReason(aiu) == null) {</span>
<span class="nc bnc" id="L631" title="All 2 branches missed.">					if (aiu.hasMission(IndianDemandMission.class)) {</span>
<span class="nc" id="L632">						alreadyAssignedUnits++;</span>
					} else {
<span class="nc" id="L634">						availableUnits.add(ou);</span>
					}
				}
<span class="nc" id="L637">			}</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">			if (alreadyAssignedUnits &gt; MAX_NUMBER_OF_DEMANDS) {</span>
<span class="nc" id="L639">				lb.add(is.getName(), &quot; has &quot;, alreadyAssignedUnits, &quot; already, &quot;);</span>
<span class="nc" id="L640">				continue;</span>
<span class="nc bnc" id="L641" title="All 2 branches missed.">			} else if (availableUnits.isEmpty()) {</span>
<span class="nc" id="L642">				lb.add(is.getName(), &quot; has no demand units, &quot;);</span>
<span class="nc" id="L643">				continue;</span>
			}
			// Pick a random available capable unit.
<span class="nc" id="L646">			Tile home = is.getTile();</span>
<span class="nc" id="L647">			Unit unit = null;</span>
<span class="nc" id="L648">			AIUnit aiUnit = null;</span>
<span class="nc bnc" id="L649" title="All 4 branches missed.">			while (unit == null &amp;&amp; !availableUnits.isEmpty()) {</span>
<span class="nc" id="L650">				Unit u = availableUnits.get(randomInt(logger, &quot;Demand unit&quot;, getAIRandom(), availableUnits.size()));</span>
<span class="nc" id="L651">				availableUnits.remove(u);</span>
<span class="nc" id="L652">				aiUnit = getAIUnit(u);</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">				if (IndianDemandMission.invalidReason(aiUnit) == null</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">						&amp;&amp; u.findPath(u.getTile(), home, null, cd) != null) {</span>
<span class="nc" id="L655">					unit = u;</span>
				}
<span class="nc" id="L657">			}</span>
<span class="nc bnc" id="L658" title="All 2 branches missed.">			if (unit == null) {</span>
<span class="nc" id="L659">				lb.add(is.getName(), &quot; found no demand unit, &quot;);</span>
<span class="nc" id="L660">				continue;</span>
			}

			// Collect nearby colonies. Filter out ones which are unreachable
			// or with which the settlement is on adequate terms.
<span class="nc" id="L665">			List&lt;RandomChoice&lt;Colony&gt;&gt; nearbyColonies = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">			for (Tile t : home.getSurroundingTiles(MAX_DISTANCE_TO_MAKE_DEMANDS)) {</span>
<span class="nc" id="L667">				Colony c = t.getColony();</span>
				PathNode path;
<span class="nc bnc" id="L669" title="All 6 branches missed.">				if (c == null || !is.hasContacted(c.getOwner()) || IndianDemandMission.invalidReason(aiUnit, c) != null</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">						|| (path = unit.findPath(home, c.getTile(), null, cd)) == null)</span>
<span class="nc" id="L671">					continue;</span>
<span class="nc" id="L672">				int alarm = is.getAlarm(c.getOwner()).getValue();</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">				int defence = c.getUnitCount() + ((c.getStockade() == null) ? 1 : (c.getStockade().getLevel() * 10));</span>
<span class="nc" id="L674">				int weight = 1 + alarm * (1000000 / defence / path.getTotalTurns());</span>
<span class="nc" id="L675">				nearbyColonies.add(new RandomChoice&lt;&gt;(c, weight));</span>
<span class="nc" id="L676">			}</span>
			// If there are any suitable colonies, pick one to demand from.
			// Sometimes a random one, sometimes the weakest, sometimes the
			// most annoying.
<span class="nc bnc" id="L680" title="All 2 branches missed.">			if (nearbyColonies.isEmpty()) {</span>
<span class="nc" id="L681">				lb.add(is.getName(), &quot; found no demand colonies, &quot;);</span>
<span class="nc" id="L682">				continue;</span>
			}
<span class="nc" id="L684">			Colony target = RandomChoice.getWeightedRandom(logger, &quot;Choose demand colony&quot;, nearbyColonies,</span>
<span class="nc" id="L685">					getAIRandom());</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">			if (target == null) {</span>
<span class="nc" id="L687">				lb.add(is.getName(), &quot; found no demand target, &quot;);</span>
<span class="nc" id="L688">				continue;</span>
			}

			// Send the unit.
<span class="nc" id="L692">			Mission m = new IndianDemandMission(getAIMain(), aiUnit, target);</span>
<span class="nc" id="L693">			lb.add(&quot;At &quot;, is.getName(), &quot; &quot;, m, &quot; will demand of &quot;, target, &quot;, &quot;);</span>
<span class="nc" id="L694">		}</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">		if (lb.grew(&quot;\n  Tribute: &quot;))</span>
<span class="nc" id="L696">			lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L697">	}</span>

	/**
	 * Gets the appropriate ship trade penalties.
	 *
	 * @param sense
	 *            The sense to apply the modifiers.
	 * @return The ship trade penalties.
	 */
	private Set&lt;Modifier&gt; getShipTradePenalties(boolean sense) {
<span class="nc" id="L707">		final Specification spec = getSpecification();</span>
<span class="nc" id="L708">		int penalty = spec.getInteger(GameOptions.SHIP_TRADE_PENALTY);</span>
<span class="nc" id="L709">		Set&lt;Modifier&gt; result = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">		for (Modifier m : spec.getModifiers(Modifier.SHIP_TRADE_PENALTY)) {</span>
<span class="nc" id="L711">			Modifier n = new Modifier(m);</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">			n.setValue((sense) ? penalty : -penalty);</span>
<span class="nc" id="L713">			result.add(n);</span>
<span class="nc" id="L714">		}</span>
<span class="nc" id="L715">		return result;</span>
	}

	/**
	 * Aborts all the missions which are no longer valid.
	 *
	 * Public for the test suite.
	 */
	public void abortInvalidMissions() {
<span class="fc bfc" id="L724" title="All 2 branches covered.">		for (AIUnit au : getAIUnits()) {</span>
<span class="fc" id="L725">			Mission mission = au.getMission();</span>
<span class="pc bpc" id="L726" title="1 of 2 branches missed.">			String reason = (mission == null) ? null : mission.invalidReason();</span>
<span class="pc bpc" id="L727" title="1 of 2 branches missed.">			if (reason != null)</span>
<span class="nc" id="L728">				au.setMission(null);</span>
<span class="fc" id="L729">		}</span>
<span class="fc" id="L730">	}</span>

	// AIPlayer interface
	// Inherit:
	// indianDemand
	// acceptDiplomaticTrade
	// acceptTax
	// acceptMercenaries
	// selectFoundingFather

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void startWorking() {
<span class="nc" id="L745">		final Player player = getPlayer();</span>
<span class="nc" id="L746">		final Turn turn = getGame().getTurn();</span>
<span class="nc" id="L747">		final int nSettlements = player.getNumberOfSettlements();</span>
<span class="nc" id="L748">		final Random air = getAIRandom();</span>

<span class="nc" id="L750">		LogBuilder lb = new LogBuilder(1024);</span>
<span class="nc" id="L751">		lb.add(player.getDebugName(), &quot; in &quot;, turn, &quot;/&quot;, turn.getNumber());</span>

<span class="nc" id="L753">		sessionRegister.clear();</span>
<span class="nc" id="L754">		clearAIUnits();</span>

<span class="nc" id="L756">		determineStances(lb);</span>
		List&lt;AIUnit&gt; more;
<span class="nc bnc" id="L758" title="All 2 branches missed.">		if (turn.isFirstTurn()) {</span>
<span class="nc" id="L759">			initializeMissions(lb);</span>
<span class="nc" id="L760">			more = getAIUnits();</span>
		} else {
			int[] randoms;
<span class="nc" id="L763">			abortInvalidMissions();</span>
<span class="nc" id="L764">			randoms = randomInts(logger, &quot;Trades&quot;, air, nSettlements, nSettlements);</span>
<span class="nc" id="L765">			secureSettlements(randoms, lb);</span>
<span class="nc" id="L766">			randoms = randomInts(logger, &quot;Gifts&quot;, air, 100, nSettlements);</span>
<span class="nc" id="L767">			bringGifts(randoms, lb);</span>
<span class="nc" id="L768">			randoms = randomInts(logger, &quot;Tribute&quot;, air, 100, nSettlements);</span>
<span class="nc" id="L769">			demandTribute(randoms, lb);</span>
<span class="nc" id="L770">			giveNormalMissions(lb);</span>
<span class="nc" id="L771">			more = doMissions(getAIUnits(), lb);</span>
		}

<span class="nc bnc" id="L774" title="All 2 branches missed.">		if (!more.isEmpty()) {</span>
<span class="nc" id="L775">			abortInvalidMissions();</span>
<span class="nc" id="L776">			giveNormalMissions(lb);</span>
<span class="nc" id="L777">			doMissions(more, lb);</span>
		}
<span class="nc" id="L779">		clearAIUnits();</span>
<span class="nc" id="L780">		lb.log(logger, Level.FINEST);</span>
<span class="nc" id="L781">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int adjustMission(AIUnit aiUnit, PathNode path, Class type, int value) {
<span class="nc bnc" id="L788" title="All 2 branches missed.">		if (type == DefendSettlementMission.class) {</span>
			// Reduce value in proportion to the number of active defenders.
<span class="nc" id="L790">			Settlement settlement = (Settlement) DefendSettlementMission.extractTarget(aiUnit, path);</span>
<span class="nc" id="L791">			value -= 75 * getSettlementDefenders(settlement);</span>

<span class="nc bnc" id="L793" title="All 2 branches missed.">		} else if (type == UnitSeekAndDestroyMission.class) {</span>
			// Natives prefer to attack when DISPLEASED.
<span class="nc" id="L795">			Location target = UnitSeekAndDestroyMission.extractTarget(aiUnit, path);</span>
<span class="nc bnc" id="L796" title="All 2 branches missed.">			Player targetPlayer = (target instanceof Ownable) ? ((Ownable) target).getOwner() : null;</span>
<span class="nc" id="L797">			IndianSettlement is = aiUnit.getUnit().getHomeIndianSettlement();</span>
<span class="nc bnc" id="L798" title="All 6 branches missed.">			if (targetPlayer != null &amp;&amp; is != null &amp;&amp; is.getAlarm(targetPlayer) != null) {</span>
<span class="nc" id="L799">				value += is.getAlarm(targetPlayer).getValue() - Tension.Level.DISPLEASED.getLimit();</span>
			}
		}

<span class="nc" id="L803">		return value;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void registerSellGoods(Goods goods) {
<span class="nc" id="L811">		String goldKey = &quot;tradeGold#&quot; + goods.getType().getId() + &quot;#&quot; + goods.getAmount() + &quot;#&quot;</span>
<span class="nc" id="L812">				+ goods.getLocation().getId();</span>
<span class="nc" id="L813">		sessionRegister.put(goldKey, null);</span>
<span class="nc" id="L814">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int buyProposition(Unit unit, Settlement settlement, Goods goods, int gold) {
<span class="nc" id="L821">		logger.finest(&quot;Entering method buyProposition&quot;);</span>
<span class="nc" id="L822">		Specification spec = getSpecification();</span>
<span class="nc" id="L823">		IndianSettlement is = (IndianSettlement) settlement;</span>
<span class="nc" id="L824">		Player buyer = unit.getOwner();</span>
<span class="nc" id="L825">		String goldKey = &quot;tradeGold#&quot; + goods.getType().getId() + &quot;#&quot; + goods.getAmount() + &quot;#&quot; + settlement.getId();</span>
<span class="nc" id="L826">		String hagglingKey = &quot;tradeHaggling#&quot; + unit.getId();</span>
		int price;
<span class="nc" id="L828">		Integer registered = sessionRegister.get(goldKey);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">		if (registered == null) {</span>
<span class="nc" id="L830">			price = is.getPriceToSell(goods);</span>
<span class="nc bnc" id="L831" title="All 3 branches missed.">			switch (is.getAlarm(buyer).getLevel()) {</span>
			case HAPPY:
			case CONTENT:
<span class="nc" id="L834">				break;</span>
			case DISPLEASED:
<span class="nc" id="L836">				price *= 2;</span>
<span class="nc" id="L837">				break;</span>
			default:
<span class="nc" id="L839">				return NetworkConstants.NO_TRADE_HOSTILE;</span>
			}
<span class="nc" id="L841">			Set&lt;Modifier&gt; modifiers = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L842" title="All 4 branches missed.">			if (is.hasMissionary(buyer) &amp;&amp; spec.getBoolean(GameOptions.ENHANCED_MISSIONARIES)) {</span>
<span class="nc" id="L843">				Unit u = is.getMissionary();</span>
<span class="nc" id="L844">				modifiers.addAll(u.getMissionaryTradeModifiers(false));</span>
			}
<span class="nc bnc" id="L846" title="All 2 branches missed.">			if (unit.isNaval()) {</span>
<span class="nc" id="L847">				modifiers.addAll(getShipTradePenalties(false));</span>
			}
<span class="nc" id="L849">			price = (int) FeatureContainer.applyModifiers((float) price, getGame().getTurn(), modifiers);</span>
<span class="nc" id="L850">			sessionRegister.put(goldKey, price);</span>
<span class="nc" id="L851">			return price;</span>
		}
<span class="nc" id="L853">		price = registered;</span>
<span class="nc bnc" id="L854" title="All 4 branches missed.">		if (price &lt; 0 || price == gold)</span>
<span class="nc" id="L855">			return price;</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">		if (gold &lt; (price * 9) / 10) {</span>
<span class="nc" id="L857">			logger.warning(&quot;Cheating attempt: sending offer too low&quot;);</span>
<span class="nc" id="L858">			sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L859">			return NetworkConstants.NO_TRADE;</span>
		}

<span class="nc" id="L862">		int haggling = 1;</span>
<span class="nc bnc" id="L863" title="All 2 branches missed.">		if (sessionRegister.containsKey(hagglingKey)) {</span>
<span class="nc" id="L864">			haggling = sessionRegister.get(hagglingKey);</span>
		}
<span class="nc bnc" id="L866" title="All 2 branches missed.">		if (randomInt(logger, &quot;Haggle-buy&quot;, getAIRandom(), 3 + haggling) &gt;= 3) {</span>
<span class="nc" id="L867">			sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L868">			return NetworkConstants.NO_TRADE_HAGGLE;</span>
		}
<span class="nc" id="L870">		sessionRegister.put(goldKey, gold);</span>
<span class="nc" id="L871">		sessionRegister.put(hagglingKey, haggling + 1);</span>
<span class="nc" id="L872">		return gold;</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int sellProposition(Unit unit, Settlement settlement, Goods goods, int gold) {
<span class="nc" id="L880">		logger.finest(&quot;Entering method sellProposition&quot;);</span>
<span class="nc" id="L881">		Specification spec = getSpecification();</span>
<span class="nc" id="L882">		IndianSettlement is = (IndianSettlement) settlement;</span>
<span class="nc" id="L883">		Player seller = unit.getOwner();</span>
<span class="nc" id="L884">		String goldKey = &quot;tradeGold#&quot; + goods.getType().getId() + &quot;#&quot; + goods.getAmount() + &quot;#&quot; + unit.getId() + &quot;#&quot;</span>
<span class="nc" id="L885">				+ settlement.getId();</span>
<span class="nc" id="L886">		String hagglingKey = &quot;tradeHaggling#&quot; + unit.getId();</span>
		int price;
<span class="nc bnc" id="L888" title="All 2 branches missed.">		if (sessionRegister.containsKey(goldKey)) {</span>
<span class="nc" id="L889">			price = sessionRegister.get(goldKey);</span>
		} else {
<span class="nc" id="L891">			price = is.getPriceToBuy(goods);</span>
<span class="nc bnc" id="L892" title="All 4 branches missed.">			switch (is.getAlarm(seller).getLevel()) {</span>
			case HAPPY:
			case CONTENT:
<span class="nc" id="L895">				break;</span>
			case DISPLEASED:
<span class="nc" id="L897">				price /= 2;</span>
<span class="nc" id="L898">				break;</span>
			case ANGRY:
<span class="nc bnc" id="L900" title="All 2 branches missed.">				if (!goods.getType().isMilitaryGoods())</span>
<span class="nc" id="L901">					return NetworkConstants.NO_TRADE_HOSTILE;</span>
<span class="nc" id="L902">				price /= 2;</span>
<span class="nc" id="L903">				break;</span>
			default:
<span class="nc" id="L905">				return NetworkConstants.NO_TRADE_HOSTILE;</span>
			}
<span class="nc" id="L907">			Set&lt;Modifier&gt; modifiers = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L908" title="All 4 branches missed.">			if (is.hasMissionary(seller) &amp;&amp; spec.getBoolean(GameOptions.ENHANCED_MISSIONARIES)) {</span>
<span class="nc" id="L909">				Unit u = is.getMissionary();</span>
<span class="nc" id="L910">				modifiers.addAll(u.getMissionaryTradeModifiers(true));</span>
			}
<span class="nc bnc" id="L912" title="All 2 branches missed.">			if (unit.isNaval()) {</span>
<span class="nc" id="L913">				modifiers.addAll(getShipTradePenalties(true));</span>
			}
<span class="nc" id="L915">			price = (int) FeatureContainer.applyModifiers((float) price, getGame().getTurn(), modifiers);</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">			if (price &lt;= 0)</span>
<span class="nc" id="L917">				return 0;</span>
<span class="nc" id="L918">			sessionRegister.put(goldKey, price);</span>
		}
<span class="nc bnc" id="L920" title="All 4 branches missed.">		if (gold &lt; 0 || price == gold)</span>
<span class="nc" id="L921">			return price;</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">		if (gold &gt; (price * 11) / 10) {</span>
<span class="nc" id="L923">			logger.warning(&quot;Cheating attempt: haggling request too high&quot;);</span>
<span class="nc" id="L924">			sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L925">			return NetworkConstants.NO_TRADE;</span>
		}
<span class="nc" id="L927">		int haggling = 1;</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">		if (sessionRegister.containsKey(hagglingKey)) {</span>
<span class="nc" id="L929">			haggling = sessionRegister.get(hagglingKey);</span>
		}
<span class="nc bnc" id="L931" title="All 2 branches missed.">		if (randomInt(logger, &quot;Haggle-sell&quot;, getAIRandom(), 3 + haggling) &gt;= 3) {</span>
<span class="nc" id="L932">			sessionRegister.put(goldKey, -1);</span>
<span class="nc" id="L933">			return NetworkConstants.NO_TRADE_HAGGLE;</span>
		}
<span class="nc" id="L935">		sessionRegister.put(goldKey, gold);</span>
<span class="nc" id="L936">		sessionRegister.put(hagglingKey, haggling + 1);</span>
<span class="nc" id="L937">		return gold;</span>
	}

	// Serialization

	/**
	 * {@inheritDoc}
	 */
	@Override
	public String getXMLTagName() {
<span class="fc" id="L947">		return getXMLElementTagName();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>