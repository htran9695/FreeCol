<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FreeCol.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol</a> &gt; <span class="el_source">FreeCol.java</span></div><h1>FreeCol.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol;

import java.awt.Dimension;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;
import java.io.IOException;
import java.net.InetAddress;
import java.net.URL;
import java.net.JarURLConnection;
import java.util.Arrays;
import java.util.Locale;
import java.util.jar.JarFile;
import java.util.jar.Manifest;
import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import java.util.zip.ZipEntry;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.common.FreeColException;
import net.sf.freecol.common.FreeColSeed;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.io.FreeColDirectories;
import net.sf.freecol.common.io.FreeColSavegameFile;
import net.sf.freecol.common.io.FreeColTcFile;
import net.sf.freecol.common.io.Mods;
import net.sf.freecol.common.logging.DefaultHandler;
import net.sf.freecol.common.model.NationOptions.Advantages;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.option.OptionGroup;
import static net.sf.freecol.common.util.CollectionUtils.*;
import net.sf.freecol.server.FreeColServer;

import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.OptionBuilder;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.cli.PosixParser;

/**
 * This class is responsible for handling the command-line arguments and
 * starting either the stand-alone server or the client-GUI.
 *
 * @see net.sf.freecol.client.FreeColClient FreeColClient
 * @see net.sf.freecol.server.FreeColServer FreeColServer
 */
public final class FreeCol {

	/** The Constant logger. */
<span class="fc" id="L77">	private static final Logger logger = Logger.getLogger(FreeCol.class.getName());</span>

	/** The FreeCol release version number. */
	private static final String FREECOL_VERSION = &quot;0.11.6&quot;;

	/** The difficulty levels. */
<span class="fc" id="L83">	public static final String[] DIFFICULTIES = { &quot;veryEasy&quot;, &quot;easy&quot;, &quot;medium&quot;, &quot;hard&quot;, &quot;veryHard&quot; };</span>

	/** The extension for FreeCol saved games. */
	public static final String FREECOL_SAVE_EXTENSION = &quot;fsg&quot;;

	/** The Java version. */
<span class="fc" id="L89">	private static final String JAVA_VERSION = System.getProperty(&quot;java.version&quot;);</span>

	/** The maximum available memory. */
<span class="fc" id="L92">	private static final long MEMORY_MAX = Runtime.getRuntime().maxMemory();</span>

	/** The Constant CLIENT_THREAD. */
	public static final String CLIENT_THREAD = &quot;FreeColClient:&quot;;

	/** The Constant SERVER_THREAD. */
	public static final String SERVER_THREAD = &quot;FreeColServer:&quot;;

	/** The Constant METASERVER_THREAD. */
	public static final String METASERVER_THREAD = &quot;FreeColMetaServer:&quot;;

	/** The Constant META_SERVER_ADDRESS. */
	public static final String META_SERVER_ADDRESS = &quot;meta.freecol.org&quot;;

	/** The Constant META_SERVER_PORT. */
	public static final int META_SERVER_PORT = 3540;

	/** Specific revision number (currently the git tag of trunk at release). */
<span class="fc" id="L110">	private static String freeColRevision = null;</span>

	/** The locale, either default or command-line specified. */
<span class="fc" id="L113">	private static Locale locale = null;</span>

	/** The Constant ADVANTAGES_DEFAULT. */
	// Cli defaults.
<span class="fc" id="L117">	private static final Advantages ADVANTAGES_DEFAULT = Advantages.SELECTABLE;</span>

	/** The Constant DIFFICULTY_DEFAULT. */
	private static final String DIFFICULTY_DEFAULT = &quot;model.difficulty.medium&quot;;

	/** The Constant EUROPEANS_DEFAULT. */
	private static final int EUROPEANS_DEFAULT = 4;

	/** The Constant EUROPEANS_MIN. */
	private static final int EUROPEANS_MIN = 1;

	/** The Constant LOGLEVEL_DEFAULT. */
<span class="fc" id="L129">	private static final Level LOGLEVEL_DEFAULT = Level.INFO;</span>

	/** The Constant JAVA_VERSION_MIN. */
	private static final String JAVA_VERSION_MIN = &quot;1.8&quot;;

	/** The Constant MEMORY_MIN. */
	private static final int MEMORY_MIN = 128; // Mbytes

	/** The Constant PORT_DEFAULT. */
	private static final int PORT_DEFAULT = 3541;

	/** The Constant SPLASH_DEFAULT. */
	private static final String SPLASH_DEFAULT = &quot;splash.jpg&quot;;

	/** The Constant TC_DEFAULT. */
	private static final String TC_DEFAULT = &quot;freecol&quot;;

	/** The Constant TIMEOUT_DEFAULT. */
	public static final int TIMEOUT_DEFAULT = 60; // 1 minute

	/** The Constant TIMEOUT_MIN. */
	public static final int TIMEOUT_MIN = 10; // 10s

	/** The Constant GUI_SCALE_MIN_PCT. */
	private static final int GUI_SCALE_MIN_PCT = 100;

	/** The Constant GUI_SCALE_MAX_PCT. */
	private static final int GUI_SCALE_MAX_PCT = 200;

	/** The Constant GUI_SCALE_STEP_PCT. */
	private static final int GUI_SCALE_STEP_PCT = 25;

	/** The Constant GUI_SCALE_MIN. */
	public static final float GUI_SCALE_MIN = GUI_SCALE_MIN_PCT / 100.0f;

	/** The Constant GUI_SCALE_MAX. */
	public static final float GUI_SCALE_MAX = GUI_SCALE_MAX_PCT / 100.0f;

	/** The Constant GUI_SCALE_STEP. */
	public static final float GUI_SCALE_STEP = GUI_SCALE_STEP_PCT / 100.0f;

	/** The Constant GUI_SCALE_DEFAULT. */
	public static final float GUI_SCALE_DEFAULT = 1.0f;

	// Cli values. Often set to null so the default can be applied in
	/** The stand alone server. */
	// the accessor function.
<span class="fc" id="L176">	private static boolean checkIntegrity = false, consoleLogging = false, debugStart = false, fastStart = false,</span>
<span class="fc" id="L177">			headless = false, introVideo = true, javaCheck = true, memoryCheck = true, publicServer = true,</span>
<span class="fc" id="L178">			sound = true, standAloneServer = false;</span>

	/** The type of advantages. */
<span class="fc" id="L181">	private static Advantages advantages = null;</span>

	/** The difficulty level id. */
<span class="fc" id="L184">	private static String difficulty = null;</span>

	/** The number of European nations to enable by default. */
<span class="fc" id="L187">	private static int europeanCount = EUROPEANS_DEFAULT;</span>

	/** A font override. */
<span class="fc" id="L190">	private static String fontName = null;</span>

	/** The level of logging in this game. */
<span class="fc" id="L193">	private static Level logLevel = LOGLEVEL_DEFAULT;</span>

	/** The client player name. */
<span class="fc" id="L196">	private static String name = null;</span>

	/** How to name and configure the server. */
<span class="fc" id="L199">	private static int serverPort = -1;</span>

	/** The server name. */
<span class="fc" id="L202">	private static String serverName = null;</span>

	/** A stream to get the splash image from. */
	private static InputStream splashStream;

	/** The TotalConversion / ruleset in play, defaults to &quot;freecol&quot;. */
<span class="fc" id="L208">	private static String tc = null;</span>

	/** The time out (seconds) for otherwise blocking commands. */
<span class="fc" id="L211">	private static int timeout = -1;</span>

	/**
	 * The size of window to create, defaults to impossible dimensions to
	 * require windowed mode with best determined screen size.
	 */
<span class="fc" id="L217">	private static Dimension windowSize = new Dimension(-1, -1);</span>

	/** How much gui elements get scaled. */
<span class="fc" id="L220">	private static float guiScale = GUI_SCALE_DEFAULT;</span>

	/**
	 * Instantiates a new free col.
	 */
<span class="nc" id="L225">	private FreeCol() {</span>
<span class="nc" id="L226">	} // Hide constructor</span>

	/**
	 * The entrypoint.
	 *
	 * @param args
	 *            The command-line arguments.
	 */
	public static void main(String[] args) {
<span class="nc" id="L235">		freeColRevision = FREECOL_VERSION;</span>
		JarURLConnection juc;
		try {
<span class="nc" id="L238">			juc = getJarURLConnection(FreeCol.class);</span>
<span class="nc" id="L239">		} catch (IOException ioe) {</span>
<span class="nc" id="L240">			juc = null;</span>
<span class="nc" id="L241">			System.err.println(&quot;Unable to open class jar: &quot; + ioe.getMessage());</span>
<span class="nc" id="L242">		}</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">		if (juc != null) {</span>
			try {
<span class="nc" id="L245">				String revision = readVersion(juc);</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">				if (revision != null) {</span>
<span class="nc" id="L247">					freeColRevision += &quot; (Revision: &quot; + revision + &quot;)&quot;;</span>
				}
<span class="nc" id="L249">			} catch (Exception e) {</span>
<span class="nc" id="L250">				System.err.println(&quot;Unable to load Manifest: &quot; + e.getMessage());</span>
<span class="nc" id="L251">			}</span>
			try {
<span class="nc" id="L253">				splashStream = getDefaultSplashStream(juc);</span>
<span class="nc" id="L254">			} catch (Exception e) {</span>
<span class="nc" id="L255">				System.err.println(&quot;Unable to open default splash: &quot; + e.getMessage());</span>
<span class="nc" id="L256">			}</span>
		}

		// Java bug #7075600 causes BR#2554. The workaround is to set
		// the following property. Remove if/when they fix Java.
<span class="nc" id="L261">		System.setProperty(&quot;java.util.Arrays.useLegacyMergeSort&quot;, &quot;true&quot;);</span>

		// We can not even emit localized error messages until we find
		// the data directory, which might have been specified on the
		// command line.
<span class="nc" id="L266">		String dataDirectoryArg = findArg(&quot;--freecol-data&quot;, args);</span>
<span class="nc" id="L267">		String err = FreeColDirectories.setDataDirectory(dataDirectoryArg);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">		if (err != null)</span>
<span class="nc" id="L269">			fatal(err); // This must not fail.</span>

		// Now we have the data directory, establish the base locale.
		// Beware, the locale may change!
<span class="nc" id="L273">		String localeArg = findArg(&quot;--default-locale&quot;, args);</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">		if (localeArg == null) {</span>
<span class="nc" id="L275">			locale = Locale.getDefault();</span>
		} else {
<span class="nc" id="L277">			int index = localeArg.indexOf('.'); // Strip encoding if present</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (index &gt; 0)</span>
<span class="nc" id="L279">				localeArg = localeArg.substring(0, index);</span>
<span class="nc" id="L280">			locale = Messages.getLocale(localeArg);</span>
		}
<span class="nc" id="L282">		Messages.loadMessageBundle(locale);</span>

		// Now that we can emit error messages, parse the other
		// command line arguments.
<span class="nc" id="L286">		handleArgs(args);</span>

		// Do the potentially fatal system checks as early as possible.
<span class="nc bnc" id="L289" title="All 4 branches missed.">		if (javaCheck &amp;&amp; JAVA_VERSION_MIN.compareTo(JAVA_VERSION) &gt; 0) {</span>
<span class="nc" id="L290">			fatal(StringTemplate.template(&quot;main.javaVersion&quot;).addName(&quot;%version%&quot;, JAVA_VERSION).addName(&quot;%minVersion%&quot;,</span>
					JAVA_VERSION_MIN));
		}
<span class="nc bnc" id="L293" title="All 4 branches missed.">		if (memoryCheck &amp;&amp; MEMORY_MAX &lt; MEMORY_MIN * 1000000) {</span>
<span class="nc" id="L294">			fatal(StringTemplate.template(&quot;main.memory&quot;).addAmount(&quot;%memory%&quot;, MEMORY_MAX).addAmount(&quot;%minMemory%&quot;,</span>
<span class="nc" id="L295">					MEMORY_MIN));</span>
		}

		// Having parsed the command line args, we know where the user
		// directories should be, so we can set up the rest of the
		// file/directory structure.
<span class="nc" id="L301">		String userMsg = FreeColDirectories.setUserDirectories();</span>

		// Now we have the log file path, start logging.
<span class="nc" id="L304">		final Logger baseLogger = Logger.getLogger(&quot;&quot;);</span>
<span class="nc" id="L305">		final Handler[] handlers = baseLogger.getHandlers();</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">		for (Handler handler : handlers) {</span>
<span class="nc" id="L307">			baseLogger.removeHandler(handler);</span>
		}
<span class="nc" id="L309">		String logFile = FreeColDirectories.getLogFilePath();</span>
		try {
<span class="nc" id="L311">			baseLogger.addHandler(new DefaultHandler(consoleLogging, logFile));</span>
<span class="nc" id="L312">			Logger freecolLogger = Logger.getLogger(&quot;net.sf.freecol&quot;);</span>
<span class="nc" id="L313">			freecolLogger.setLevel(logLevel);</span>
<span class="nc" id="L314">		} catch (FreeColException e) {</span>
<span class="nc" id="L315">			System.err.println(&quot;Logging initialization failure: &quot; + e.getMessage());</span>
<span class="nc" id="L316">			e.printStackTrace();</span>
<span class="nc" id="L317">		}</span>
<span class="nc" id="L318">		Thread.setDefaultUncaughtExceptionHandler((Thread thread, Throwable e) -&gt; {</span>
<span class="nc" id="L319">			baseLogger.log(Level.WARNING, &quot;Uncaught exception from thread: &quot; + thread, e);</span>
<span class="nc" id="L320">		});</span>

		// Now we can find the client options, allow the options
		// setting to override the locale, if no command line option
		// had been specified.
		// We have users whose machines default to Finnish but play
		// FreeCol in English.
		// If the user has selected automatic language selection, do
		// nothing, since we have already set up the default locale.
<span class="nc bnc" id="L329" title="All 2 branches missed.">		if (localeArg == null) {</span>
<span class="nc" id="L330">			String clientLanguage = ClientOptions.getLanguageOption();</span>
			Locale clientLocale;
<span class="nc bnc" id="L332" title="All 4 branches missed.">			if (clientLanguage != null &amp;&amp; !Messages.AUTOMATIC.equalsIgnoreCase(clientLanguage)</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">					&amp;&amp; (clientLocale = Messages.getLocale(clientLanguage)) != locale) {</span>
<span class="nc" id="L334">				locale = clientLocale;</span>
<span class="nc" id="L335">				Messages.loadMessageBundle(locale);</span>
<span class="nc" id="L336">				logger.info(&quot;Loaded messages for &quot; + locale);</span>
			}
		}

		// Now we have the user mods directory and the locale is now
		// stable, load the mods and their messages.
<span class="nc" id="L342">		Mods.loadMods();</span>
<span class="nc" id="L343">		Messages.loadModMessageBundle(locale);</span>

		// Report on where we are.
<span class="nc bnc" id="L346" title="All 2 branches missed.">		if (userMsg != null)</span>
<span class="nc" id="L347">			logger.info(Messages.message(userMsg));</span>
<span class="nc" id="L348">		logger.info(getConfiguration().toString());</span>

		// Ready to specialize into client or server.
<span class="nc bnc" id="L351" title="All 2 branches missed.">		if (standAloneServer) {</span>
<span class="nc" id="L352">			startServer();</span>
		} else {
<span class="nc" id="L354">			startClient(userMsg);</span>
		}
<span class="nc" id="L356">	}</span>

	/**
	 * Get the JarURLConnection from a class.
	 *
	 * @param c
	 *            the c
	 * @return The &lt;code&gt;JarURLConnection&lt;/code&gt;.
	 * @throws IOException
	 *             Signals that an I/O exception has occurred.
	 */
	private static JarURLConnection getJarURLConnection(Class c) throws IOException {
<span class="nc" id="L368">		String resourceName = &quot;/&quot; + c.getName().replace('.', '/') + &quot;.class&quot;;</span>
<span class="nc" id="L369">		URL url = c.getResource(resourceName);</span>
<span class="nc" id="L370">		return (JarURLConnection) url.openConnection();</span>
	}

	/**
	 * Extract the package version from the class.
	 *
	 * @param juc
	 *            The &lt;code&gt;JarURLConnection&lt;/code&gt; to extract from.
	 * @return A value of the package version attribute.
	 * @throws IOException
	 *             Signals that an I/O exception has occurred.
	 */
	private static String readVersion(JarURLConnection juc) throws IOException {
<span class="nc" id="L383">		Manifest mf = juc.getManifest();</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">		return (mf == null) ? null : mf.getMainAttributes().getValue(&quot;Package-Version&quot;);</span>
	}

	/**
	 * Get a stream for the default splash file.
	 * 
	 * Note: Not bothering to check for nulls as this is called in try block
	 * that ignores all exceptions.
	 *
	 * @param juc
	 *            The &lt;code&gt;JarURLConnection&lt;/code&gt; to extract from.
	 * @return A suitable &lt;code&gt;InputStream&lt;/code&gt;, or null on error.
	 * @throws IOException
	 *             Signals that an I/O exception has occurred.
	 */
	private static InputStream getDefaultSplashStream(JarURLConnection juc) throws IOException {
<span class="nc" id="L400">		JarFile jf = juc.getJarFile();</span>
<span class="nc" id="L401">		ZipEntry ze = jf.getEntry(SPLASH_DEFAULT);</span>
<span class="nc" id="L402">		return jf.getInputStream(ze);</span>
	}

	/**
	 * Exit printing fatal error message.
	 *
	 * @param template
	 *            A &lt;code&gt;StringTemplate&lt;/code&gt; to print.
	 */
	public static void fatal(StringTemplate template) {
<span class="nc" id="L412">		fatal(Messages.message(template));</span>
<span class="nc" id="L413">	}</span>

	/**
	 * Exit printing fatal error message.
	 *
	 * @param err
	 *            The error message to print.
	 */
	public static void fatal(String err) {
<span class="nc bnc" id="L422" title="All 4 branches missed.">		if (err == null || err.isEmpty()) {</span>
<span class="nc" id="L423">			err = &quot;Bogus null fatal error message&quot;;</span>
<span class="nc" id="L424">			Thread.dumpStack();</span>
		}
<span class="nc" id="L426">		System.err.println(err);</span>
<span class="nc" id="L427">		System.exit(1);</span>
<span class="nc" id="L428">	}</span>

	/**
	 * Just gripe to System.err.
	 *
	 * @param template
	 *            A &lt;code&gt;StringTemplate&lt;/code&gt; to print.
	 */
	public static void gripe(StringTemplate template) {
<span class="nc" id="L437">		System.err.println(Messages.message(template));</span>
<span class="nc" id="L438">	}</span>

	/**
	 * Just gripe to System.err.
	 *
	 * @param key
	 *            A message key.
	 */
	public static void gripe(String key) {
<span class="nc" id="L447">		System.err.println(Messages.message(key));</span>
<span class="nc" id="L448">	}</span>

	/**
	 * Find an option before the real option handling can get started. Takes
	 * care to use the *last* instance.
	 *
	 * @param option
	 *            The option to find.
	 * @param args
	 *            The command-line arguments.
	 * @return The option's parameter.
	 */
	private static String findArg(String option, String[] args) {
<span class="nc bnc" id="L461" title="All 2 branches missed.">		for (int i = args.length - 2; i &gt;= 0; i--) {</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">			if (option.equals(args[i])) {</span>
<span class="nc" id="L463">				return args[i + 1];</span>
			}
		}
<span class="nc" id="L466">		return null;</span>
	}

	/**
	 * Processes the command-line arguments and takes appropriate actions for
	 * each of them.
	 *
	 * @param args
	 *            The command-line arguments.
	 */
	private static void handleArgs(String[] args) {
<span class="nc" id="L477">		Options options = new Options();</span>
<span class="nc" id="L478">		final String help = Messages.message(&quot;cli.help&quot;);</span>
<span class="nc" id="L479">		final File dummy = new File(&quot;dummy&quot;);</span>
<span class="nc" id="L480">		final String argDirectory = Messages.message(&quot;cli.arg.directory&quot;);</span>

		// Help options.
<span class="nc" id="L483">		options.addOption(OptionBuilder.withLongOpt(&quot;usage&quot;).withDescription(help).create());</span>
<span class="nc" id="L484">		options.addOption(OptionBuilder.withLongOpt(&quot;help&quot;).withDescription(help).create());</span>

		// Special options handled early.
<span class="nc" id="L487">		options.addOption(OptionBuilder.withLongOpt(&quot;freecol-data&quot;)</span>
<span class="nc" id="L488">				.withDescription(Messages.message(&quot;cli.freecol-data&quot;)).withArgName(argDirectory).hasArg().create());</span>
<span class="nc" id="L489">		options.addOption(</span>
<span class="nc" id="L490">				OptionBuilder.withLongOpt(&quot;default-locale&quot;).withDescription(Messages.message(&quot;cli.default-locale&quot;))</span>
<span class="nc" id="L491">						.withArgName(Messages.message(&quot;cli.arg.locale&quot;)).hasArg().create());</span>

		// Ordinary options, handled here.
<span class="nc" id="L494">		options.addOption(OptionBuilder.withLongOpt(&quot;advantages&quot;)</span>
<span class="nc" id="L495">				.withDescription(Messages.message(</span>
<span class="nc" id="L496">						StringTemplate.template(&quot;cli.advantages&quot;).addName(&quot;%advantages%&quot;, getValidAdvantages())))</span>
<span class="nc" id="L497">				.withArgName(Messages.message(&quot;cli.arg.advantages&quot;)).hasArg().create());</span>
<span class="nc" id="L498">		options.addOption(</span>
<span class="nc" id="L499">				OptionBuilder.withLongOpt(&quot;check-savegame&quot;).withDescription(Messages.message(&quot;cli.check-savegame&quot;))</span>
<span class="nc" id="L500">						.withArgName(Messages.message(&quot;cli.arg.file&quot;)).hasArg().create());</span>
<span class="nc" id="L501">		options.addOption(</span>
<span class="nc" id="L502">				OptionBuilder.withLongOpt(&quot;clientOptions&quot;).withDescription(Messages.message(&quot;cli.clientOptions&quot;))</span>
<span class="nc" id="L503">						.withArgName(Messages.message(&quot;cli.arg.clientOptions&quot;)).hasArg().create());</span>
<span class="nc" id="L504">		options.addOption(OptionBuilder.withLongOpt(&quot;debug&quot;)</span>
<span class="nc" id="L505">				.withDescription(Messages.message(</span>
<span class="nc" id="L506">						StringTemplate.template(&quot;cli.debug&quot;).addName(&quot;%modes%&quot;, FreeColDebugger.getDebugModes())))</span>
<span class="nc" id="L507">				.withArgName(Messages.message(&quot;cli.arg.debug&quot;)).hasOptionalArg().create());</span>
<span class="nc" id="L508">		options.addOption(OptionBuilder.withLongOpt(&quot;debug-run&quot;).withDescription(Messages.message(&quot;cli.debug-run&quot;))</span>
<span class="nc" id="L509">				.withArgName(Messages.message(&quot;cli.arg.debugRun&quot;)).hasOptionalArg().create());</span>
<span class="nc" id="L510">		options.addOption(</span>
<span class="nc" id="L511">				OptionBuilder.withLongOpt(&quot;debug-start&quot;).withDescription(Messages.message(&quot;cli.debug-start&quot;)).create());</span>
<span class="nc" id="L512">		options.addOption(OptionBuilder.withLongOpt(&quot;difficulty&quot;).withDescription(Messages.message(&quot;cli.difficulty&quot;))</span>
<span class="nc" id="L513">				.withArgName(Messages.message(&quot;cli.arg.difficulty&quot;)).hasArg().create());</span>
<span class="nc" id="L514">		options.addOption(OptionBuilder.withLongOpt(&quot;europeans&quot;).withDescription(Messages.message(&quot;cli.european-count&quot;))</span>
<span class="nc" id="L515">				.withArgName(Messages.message(&quot;cli.arg.europeans&quot;)).hasArg().create());</span>
<span class="nc" id="L516">		options.addOption(OptionBuilder.withLongOpt(&quot;fast&quot;).withDescription(Messages.message(&quot;cli.fast&quot;)).create());</span>
<span class="nc" id="L517">		options.addOption(OptionBuilder.withLongOpt(&quot;font&quot;).withDescription(Messages.message(&quot;cli.font&quot;))</span>
<span class="nc" id="L518">				.withArgName(Messages.message(&quot;cli.arg.font&quot;)).hasArg().create());</span>
<span class="nc" id="L519">		options.addOption(</span>
<span class="nc" id="L520">				OptionBuilder.withLongOpt(&quot;full-screen&quot;).withDescription(Messages.message(&quot;cli.full-screen&quot;)).create());</span>
<span class="nc" id="L521">		options.addOption(OptionBuilder.withLongOpt(&quot;gui-scale&quot;)</span>
<span class="nc" id="L522">				.withDescription(Messages</span>
<span class="nc" id="L523">						.message(StringTemplate.template(&quot;cli.gui-scale&quot;).addName(&quot;%scales%&quot;, getValidGUIScales())))</span>
<span class="nc" id="L524">				.withArgName(Messages.message(&quot;cli.arg.gui-scale&quot;)).hasOptionalArg().create());</span>
<span class="nc" id="L525">		options.addOption(</span>
<span class="nc" id="L526">				OptionBuilder.withLongOpt(&quot;headless&quot;).withDescription(Messages.message(&quot;cli.headless&quot;)).create());</span>
<span class="nc" id="L527">		options.addOption(</span>
<span class="nc" id="L528">				OptionBuilder.withLongOpt(&quot;load-savegame&quot;).withDescription(Messages.message(&quot;cli.load-savegame&quot;))</span>
<span class="nc" id="L529">						.withArgName(Messages.message(&quot;cli.arg.file&quot;)).hasArg().create());</span>
<span class="nc" id="L530">		options.addOption(</span>
<span class="nc" id="L531">				OptionBuilder.withLongOpt(&quot;log-console&quot;).withDescription(Messages.message(&quot;cli.log-console&quot;)).create());</span>
<span class="nc" id="L532">		options.addOption(OptionBuilder.withLongOpt(&quot;log-file&quot;).withDescription(Messages.message(&quot;cli.log-file&quot;))</span>
<span class="nc" id="L533">				.withArgName(Messages.message(&quot;cli.arg.name&quot;)).hasArg().create());</span>
<span class="nc" id="L534">		options.addOption(OptionBuilder.withLongOpt(&quot;log-level&quot;).withDescription(Messages.message(&quot;cli.log-level&quot;))</span>
<span class="nc" id="L535">				.withArgName(Messages.message(&quot;cli.arg.loglevel&quot;)).hasArg().create());</span>
<span class="nc" id="L536">		options.addOption(OptionBuilder.withLongOpt(&quot;name&quot;).withDescription(Messages.message(&quot;cli.name&quot;))</span>
<span class="nc" id="L537">				.withArgName(Messages.message(&quot;cli.arg.name&quot;)).hasArg().create());</span>
<span class="nc" id="L538">		options.addOption(</span>
<span class="nc" id="L539">				OptionBuilder.withLongOpt(&quot;no-intro&quot;).withDescription(Messages.message(&quot;cli.no-intro&quot;)).create());</span>
<span class="nc" id="L540">		options.addOption(OptionBuilder.withLongOpt(&quot;no-java-check&quot;)</span>
<span class="nc" id="L541">				.withDescription(Messages.message(&quot;cli.no-java-check&quot;)).create());</span>
<span class="nc" id="L542">		options.addOption(OptionBuilder.withLongOpt(&quot;no-memory-check&quot;)</span>
<span class="nc" id="L543">				.withDescription(Messages.message(&quot;cli.no-memory-check&quot;)).create());</span>
<span class="nc" id="L544">		options.addOption(</span>
<span class="nc" id="L545">				OptionBuilder.withLongOpt(&quot;no-sound&quot;).withDescription(Messages.message(&quot;cli.no-sound&quot;)).create());</span>
<span class="nc" id="L546">		options.addOption(</span>
<span class="nc" id="L547">				OptionBuilder.withLongOpt(&quot;no-splash&quot;).withDescription(Messages.message(&quot;cli.no-splash&quot;)).create());</span>
<span class="nc" id="L548">		options.addOption(</span>
<span class="nc" id="L549">				OptionBuilder.withLongOpt(&quot;private&quot;).withDescription(Messages.message(&quot;cli.private&quot;)).create());</span>
<span class="nc" id="L550">		options.addOption(OptionBuilder.withLongOpt(&quot;seed&quot;).withDescription(Messages.message(&quot;cli.seed&quot;))</span>
<span class="nc" id="L551">				.withArgName(Messages.message(&quot;cli.arg.seed&quot;)).hasArg().create());</span>
<span class="nc" id="L552">		options.addOption(OptionBuilder.withLongOpt(&quot;server&quot;).withDescription(Messages.message(&quot;cli.server&quot;)).create());</span>
<span class="nc" id="L553">		options.addOption(OptionBuilder.withLongOpt(&quot;server-name&quot;).withDescription(Messages.message(&quot;cli.server-name&quot;))</span>
<span class="nc" id="L554">				.withArgName(Messages.message(&quot;cli.arg.name&quot;)).hasArg().create());</span>
<span class="nc" id="L555">		options.addOption(OptionBuilder.withLongOpt(&quot;server-port&quot;).withDescription(Messages.message(&quot;cli.server-port&quot;))</span>
<span class="nc" id="L556">				.withArgName(Messages.message(&quot;cli.arg.port&quot;)).hasArg().create());</span>
<span class="nc" id="L557">		options.addOption(OptionBuilder.withLongOpt(&quot;splash&quot;).withDescription(Messages.message(&quot;cli.splash&quot;))</span>
<span class="nc" id="L558">				.withArgName(Messages.message(&quot;cli.arg.file&quot;)).hasOptionalArg().create());</span>
<span class="nc" id="L559">		options.addOption(OptionBuilder.withLongOpt(&quot;tc&quot;).withDescription(Messages.message(&quot;cli.tc&quot;))</span>
<span class="nc" id="L560">				.withArgName(Messages.message(&quot;cli.arg.name&quot;)).hasArg().create());</span>
<span class="nc" id="L561">		options.addOption(OptionBuilder.withLongOpt(&quot;timeout&quot;).withDescription(Messages.message(&quot;cli.timeout&quot;))</span>
<span class="nc" id="L562">				.withArgName(Messages.message(&quot;cli.arg.timeout&quot;)).hasArg().create());</span>
<span class="nc" id="L563">		options.addOption(OptionBuilder.withLongOpt(&quot;user-cache-directory&quot;)</span>
<span class="nc" id="L564">				.withDescription(Messages.message(&quot;cli.user-cache-directory&quot;)).withArgName(argDirectory).withType(dummy)</span>
<span class="nc" id="L565">				.hasArg().create());</span>
<span class="nc" id="L566">		options.addOption(OptionBuilder.withLongOpt(&quot;user-config-directory&quot;)</span>
<span class="nc" id="L567">				.withDescription(Messages.message(&quot;cli.user-config-directory&quot;)).withArgName(argDirectory)</span>
<span class="nc" id="L568">				.withType(dummy).hasArg().create());</span>
<span class="nc" id="L569">		options.addOption(OptionBuilder.withLongOpt(&quot;user-data-directory&quot;)</span>
<span class="nc" id="L570">				.withDescription(Messages.message(&quot;cli.user-data-directory&quot;)).withArgName(argDirectory).withType(dummy)</span>
<span class="nc" id="L571">				.hasArg().create());</span>
<span class="nc" id="L572">		options.addOption(</span>
<span class="nc" id="L573">				OptionBuilder.withLongOpt(&quot;version&quot;).withDescription(Messages.message(&quot;cli.version&quot;)).create());</span>
<span class="nc" id="L574">		options.addOption(OptionBuilder.withLongOpt(&quot;windowed&quot;).withDescription(Messages.message(&quot;cli.windowed&quot;))</span>
<span class="nc" id="L575">				.withArgName(Messages.message(&quot;cli.arg.dimensions&quot;)).hasOptionalArg().create());</span>

<span class="nc" id="L577">		CommandLineParser parser = new PosixParser();</span>
<span class="nc" id="L578">		boolean usageError = false;</span>
		try {
<span class="nc" id="L580">			CommandLine line = parser.parse(options, args);</span>
<span class="nc bnc" id="L581" title="All 4 branches missed.">			if (line.hasOption(&quot;help&quot;) || line.hasOption(&quot;usage&quot;)) {</span>
<span class="nc" id="L582">				printUsage(options, 0);</span>
			}

<span class="nc bnc" id="L585" title="All 2 branches missed.">			if (line.hasOption(&quot;default-locale&quot;)) {</span>
				; // Do nothing, already handled in main().
			}
<span class="nc bnc" id="L588" title="All 2 branches missed.">			if (line.hasOption(&quot;freecol-data&quot;)) {</span>
				; // Do nothing, already handled in main().
			}

<span class="nc bnc" id="L592" title="All 2 branches missed.">			if (line.hasOption(&quot;advantages&quot;)) {</span>
<span class="nc" id="L593">				String arg = line.getOptionValue(&quot;advantages&quot;);</span>
<span class="nc" id="L594">				Advantages a = selectAdvantages(arg);</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">				if (a == null) {</span>
<span class="nc" id="L596">					fatal(StringTemplate.template(&quot;cli.error.advantages&quot;).addName(&quot;%advantages%&quot;, getValidAdvantages())</span>
<span class="nc" id="L597">							.addName(&quot;%arg%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L601" title="All 2 branches missed.">			if (line.hasOption(&quot;check-savegame&quot;)) {</span>
<span class="nc" id="L602">				String arg = line.getOptionValue(&quot;check-savegame&quot;);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">				if (!FreeColDirectories.setSavegameFile(arg)) {</span>
<span class="nc" id="L604">					fatal(StringTemplate.template(&quot;cli.err.save&quot;).addName(&quot;%string%&quot;, arg));</span>
				}
<span class="nc" id="L606">				checkIntegrity = true;</span>
<span class="nc" id="L607">				standAloneServer = true;</span>
			}

<span class="nc bnc" id="L610" title="All 2 branches missed.">			if (line.hasOption(&quot;clientOptions&quot;)) {</span>
<span class="nc" id="L611">				String fileName = line.getOptionValue(&quot;clientOptions&quot;);</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">				if (!FreeColDirectories.setClientOptionsFile(fileName)) {</span>
					// Not fatal.
<span class="nc" id="L614">					gripe(StringTemplate.template(&quot;cli.error.clientOptions&quot;).addName(&quot;%string%&quot;, fileName));</span>
				}
			}

<span class="nc bnc" id="L618" title="All 2 branches missed.">			if (line.hasOption(&quot;debug&quot;)) {</span>
				// If the optional argument is supplied use limited mode.
<span class="nc" id="L620">				String arg = line.getOptionValue(&quot;debug&quot;);</span>
<span class="nc bnc" id="L621" title="All 4 branches missed.">				if (arg == null || arg.isEmpty()) {</span>
					// Let empty argument default to menus functionality.
<span class="nc" id="L623">					arg = FreeColDebugger.DebugMode.MENUS.toString();</span>
				}
<span class="nc bnc" id="L625" title="All 2 branches missed.">				if (!FreeColDebugger.setDebugModes(arg)) { // Not fatal.</span>
<span class="nc" id="L626">					gripe(StringTemplate.template(&quot;cli.error.debug&quot;).addName(&quot;%modes%&quot;,</span>
<span class="nc" id="L627">							FreeColDebugger.getDebugModes()));</span>
				}
				// user set log level has precedence
<span class="nc bnc" id="L630" title="All 2 branches missed.">				if (!line.hasOption(&quot;log-level&quot;))</span>
<span class="nc" id="L631">					logLevel = Level.FINEST;</span>
			}
<span class="nc bnc" id="L633" title="All 2 branches missed.">			if (line.hasOption(&quot;debug-run&quot;)) {</span>
<span class="nc" id="L634">				FreeColDebugger.enableDebugMode(FreeColDebugger.DebugMode.MENUS);</span>
<span class="nc" id="L635">				FreeColDebugger.configureDebugRun(line.getOptionValue(&quot;debug-run&quot;));</span>
			}
<span class="nc bnc" id="L637" title="All 2 branches missed.">			if (line.hasOption(&quot;debug-start&quot;)) {</span>
<span class="nc" id="L638">				debugStart = true;</span>
<span class="nc" id="L639">				FreeColDebugger.enableDebugMode(FreeColDebugger.DebugMode.MENUS);</span>
			}

<span class="nc bnc" id="L642" title="All 2 branches missed.">			if (line.hasOption(&quot;difficulty&quot;)) {</span>
<span class="nc" id="L643">				String arg = line.getOptionValue(&quot;difficulty&quot;);</span>
<span class="nc" id="L644">				String difficulty = selectDifficulty(arg);</span>
<span class="nc bnc" id="L645" title="All 2 branches missed.">				if (difficulty == null) {</span>
<span class="nc" id="L646">					fatal(StringTemplate.template(&quot;cli.error.difficulties&quot;)</span>
<span class="nc" id="L647">							.addName(&quot;%difficulties%&quot;, getValidDifficulties()).addName(&quot;%arg%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L651" title="All 2 branches missed.">			if (line.hasOption(&quot;europeans&quot;)) {</span>
<span class="nc" id="L652">				int e = selectEuropeanCount(line.getOptionValue(&quot;europeans&quot;));</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">				if (e &lt; 0) {</span>
<span class="nc" id="L654">					gripe(StringTemplate.template(&quot;cli.error.europeans&quot;).addAmount(&quot;%min%&quot;, EUROPEANS_MIN));</span>
				}
			}

<span class="nc bnc" id="L658" title="All 2 branches missed.">			if (line.hasOption(&quot;fast&quot;)) {</span>
<span class="nc" id="L659">				fastStart = true;</span>
<span class="nc" id="L660">				introVideo = false;</span>
			}

<span class="nc bnc" id="L663" title="All 2 branches missed.">			if (line.hasOption(&quot;font&quot;)) {</span>
<span class="nc" id="L664">				fontName = line.getOptionValue(&quot;font&quot;);</span>
			}

<span class="nc bnc" id="L667" title="All 2 branches missed.">			if (line.hasOption(&quot;full-screen&quot;)) {</span>
<span class="nc" id="L668">				windowSize = null;</span>
			}

<span class="nc bnc" id="L671" title="All 2 branches missed.">			if (line.hasOption(&quot;gui-scale&quot;)) {</span>
<span class="nc" id="L672">				String arg = line.getOptionValue(&quot;gui-scale&quot;);</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">				if (!setGUIScale(arg)) {</span>
<span class="nc" id="L674">					gripe(StringTemplate.template(&quot;cli.error.gui-scale&quot;).addName(&quot;%scales%&quot;, getValidGUIScales())</span>
<span class="nc" id="L675">							.addName(&quot;%arg%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L679" title="All 2 branches missed.">			if (line.hasOption(&quot;headless&quot;)) {</span>
<span class="nc" id="L680">				headless = true;</span>
			}

<span class="nc bnc" id="L683" title="All 2 branches missed.">			if (line.hasOption(&quot;load-savegame&quot;)) {</span>
<span class="nc" id="L684">				String arg = line.getOptionValue(&quot;load-savegame&quot;);</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">				if (!FreeColDirectories.setSavegameFile(arg)) {</span>
<span class="nc" id="L686">					fatal(StringTemplate.template(&quot;cli.error.save&quot;).addName(&quot;%string%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L690" title="All 2 branches missed.">			if (line.hasOption(&quot;log-console&quot;)) {</span>
<span class="nc" id="L691">				consoleLogging = true;</span>
			}
<span class="nc bnc" id="L693" title="All 2 branches missed.">			if (line.hasOption(&quot;log-file&quot;)) {</span>
<span class="nc" id="L694">				FreeColDirectories.setLogFilePath(line.getOptionValue(&quot;log-file&quot;));</span>
			}
<span class="nc bnc" id="L696" title="All 2 branches missed.">			if (line.hasOption(&quot;log-level&quot;)) {</span>
<span class="nc" id="L697">				setLogLevel(line.getOptionValue(&quot;log-level&quot;));</span>
			}

<span class="nc bnc" id="L700" title="All 2 branches missed.">			if (line.hasOption(&quot;name&quot;)) {</span>
<span class="nc" id="L701">				setName(line.getOptionValue(&quot;name&quot;));</span>
			}

<span class="nc bnc" id="L704" title="All 2 branches missed.">			if (line.hasOption(&quot;no-intro&quot;)) {</span>
<span class="nc" id="L705">				introVideo = false;</span>
			}
<span class="nc bnc" id="L707" title="All 2 branches missed.">			if (line.hasOption(&quot;no-java-check&quot;)) {</span>
<span class="nc" id="L708">				javaCheck = false;</span>
			}
<span class="nc bnc" id="L710" title="All 2 branches missed.">			if (line.hasOption(&quot;no-memory-check&quot;)) {</span>
<span class="nc" id="L711">				memoryCheck = false;</span>
			}
<span class="nc bnc" id="L713" title="All 2 branches missed.">			if (line.hasOption(&quot;no-sound&quot;)) {</span>
<span class="nc" id="L714">				sound = false;</span>
			}
<span class="nc bnc" id="L716" title="All 2 branches missed.">			if (line.hasOption(&quot;no-splash&quot;)) {</span>
<span class="nc" id="L717">				splashStream = null;</span>
			}

<span class="nc bnc" id="L720" title="All 2 branches missed.">			if (line.hasOption(&quot;private&quot;)) {</span>
<span class="nc" id="L721">				publicServer = false;</span>
			}

<span class="nc bnc" id="L724" title="All 2 branches missed.">			if (line.hasOption(&quot;server&quot;)) {</span>
<span class="nc" id="L725">				standAloneServer = true;</span>
			}
<span class="nc bnc" id="L727" title="All 2 branches missed.">			if (line.hasOption(&quot;server-name&quot;)) {</span>
<span class="nc" id="L728">				serverName = line.getOptionValue(&quot;server-name&quot;);</span>
			}
<span class="nc bnc" id="L730" title="All 2 branches missed.">			if (line.hasOption(&quot;server-port&quot;)) {</span>
<span class="nc" id="L731">				String arg = line.getOptionValue(&quot;server-port&quot;);</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">				if (!setServerPort(arg)) {</span>
<span class="nc" id="L733">					fatal(StringTemplate.template(&quot;cli.error.serverPort&quot;).addName(&quot;%string%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L737" title="All 2 branches missed.">			if (line.hasOption(&quot;seed&quot;)) {</span>
<span class="nc" id="L738">				FreeColSeed.setFreeColSeed(line.getOptionValue(&quot;seed&quot;));</span>
			}

<span class="nc bnc" id="L741" title="All 2 branches missed.">			if (line.hasOption(&quot;splash&quot;)) {</span>
<span class="nc" id="L742">				String splash = line.getOptionValue(&quot;splash&quot;);</span>
				try {
<span class="nc" id="L744">					FileInputStream fis = new FileInputStream(splash);</span>
<span class="nc" id="L745">					splashStream = fis;</span>
<span class="nc" id="L746">				} catch (FileNotFoundException fnfe) {</span>
<span class="nc" id="L747">					gripe(StringTemplate.template(&quot;cli.error.splash&quot;).addName(&quot;%name%&quot;, splash));</span>
<span class="nc" id="L748">				}</span>
			}

<span class="nc bnc" id="L751" title="All 2 branches missed.">			if (line.hasOption(&quot;tc&quot;)) {</span>
<span class="nc" id="L752">				setTC(line.getOptionValue(&quot;tc&quot;)); // Failure is deferred.</span>
			}

<span class="nc bnc" id="L755" title="All 2 branches missed.">			if (line.hasOption(&quot;timeout&quot;)) {</span>
<span class="nc" id="L756">				String arg = line.getOptionValue(&quot;timeout&quot;);</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">				if (!setTimeout(arg)) { // Not fatal</span>
<span class="nc" id="L758">					gripe(StringTemplate.template(&quot;cli.error.timeout&quot;).addName(&quot;%string%&quot;, arg).addName(&quot;%minimum%&quot;,</span>
<span class="nc" id="L759">							Integer.toString(TIMEOUT_MIN)));</span>
				}
			}

<span class="nc bnc" id="L763" title="All 2 branches missed.">			if (line.hasOption(&quot;user-cache-directory&quot;)) {</span>
<span class="nc" id="L764">				String arg = line.getOptionValue(&quot;user-cache-directory&quot;);</span>
<span class="nc" id="L765">				String errMsg = FreeColDirectories.setUserCacheDirectory(arg);</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">				if (errMsg != null) { // Not fatal.</span>
<span class="nc" id="L767">					gripe(StringTemplate.template(errMsg).addName(&quot;%string%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L771" title="All 2 branches missed.">			if (line.hasOption(&quot;user-config-directory&quot;)) {</span>
<span class="nc" id="L772">				String arg = line.getOptionValue(&quot;user-config-directory&quot;);</span>
<span class="nc" id="L773">				String errMsg = FreeColDirectories.setUserConfigDirectory(arg);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">				if (errMsg != null) { // Not fatal.</span>
<span class="nc" id="L775">					gripe(StringTemplate.template(errMsg).addName(&quot;%string%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L779" title="All 2 branches missed.">			if (line.hasOption(&quot;user-data-directory&quot;)) {</span>
<span class="nc" id="L780">				String arg = line.getOptionValue(&quot;user-data-directory&quot;);</span>
<span class="nc" id="L781">				String errMsg = FreeColDirectories.setUserDataDirectory(arg);</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">				if (errMsg != null) { // Fatal, unable to save.</span>
<span class="nc" id="L783">					fatal(StringTemplate.template(errMsg).addName(&quot;%string%&quot;, arg));</span>
				}
			}

<span class="nc bnc" id="L787" title="All 2 branches missed.">			if (line.hasOption(&quot;version&quot;)) {</span>
<span class="nc" id="L788">				System.out.println(&quot;FreeCol &quot; + getVersion());</span>
<span class="nc" id="L789">				System.exit(0);</span>
			}

<span class="nc bnc" id="L792" title="All 2 branches missed.">			if (line.hasOption(&quot;windowed&quot;)) {</span>
<span class="nc" id="L793">				String arg = line.getOptionValue(&quot;windowed&quot;);</span>
<span class="nc" id="L794">				setWindowSize(arg); // Does not fail</span>
			}

<span class="nc" id="L797">		} catch (ParseException e) {</span>
<span class="nc" id="L798">			System.err.println(&quot;\n&quot; + e.getMessage() + &quot;\n&quot;);</span>
<span class="nc" id="L799">			usageError = true;</span>
<span class="nc" id="L800">		}</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">		if (usageError)</span>
<span class="nc" id="L802">			printUsage(options, 1);</span>
<span class="nc" id="L803">	}</span>

	/**
	 * Prints the usage message and exits.
	 *
	 * @param options
	 *            The command line &lt;code&gt;Options&lt;/code&gt;.
	 * @param status
	 *            The status to exit with.
	 */
	private static void printUsage(Options options, int status) {
<span class="nc" id="L814">		HelpFormatter formatter = new HelpFormatter();</span>
<span class="nc" id="L815">		formatter.printHelp(&quot;java -Xmx 256M -jar freecol.jar [OPTIONS]&quot;, options);</span>
<span class="nc" id="L816">		System.exit(status);</span>
<span class="nc" id="L817">	}</span>

	/**
	 * Get the specification from a given TC file.
	 *
	 * @param tcf
	 *            The &lt;code&gt;FreeColTcFile&lt;/code&gt; to load.
	 * @param advantages
	 *            An optional &lt;code&gt;Advantages&lt;/code&gt; setting.
	 * @param difficulty
	 *            An optional difficulty level.
	 * @return A &lt;code&gt;Specification&lt;/code&gt;.
	 */
	public static Specification loadSpecification(FreeColTcFile tcf, Advantages advantages, String difficulty) {
<span class="fc" id="L831">		Specification spec = null;</span>
		try {
<span class="pc bpc" id="L833" title="1 of 2 branches missed.">			if (tcf != null)</span>
<span class="fc" id="L834">				spec = tcf.getSpecification();</span>
<span class="nc" id="L835">		} catch (IOException ioe) {</span>
<span class="nc" id="L836">			System.err.println(&quot;Spec read failed in &quot; + tcf.getId() + &quot;: &quot; + ioe.getMessage() + &quot;\n&quot;);</span>
<span class="fc" id="L837">		}</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">		if (spec != null)</span>
<span class="fc" id="L839">			spec.prepare(advantages, difficulty);</span>
<span class="fc" id="L840">		return spec;</span>
	}

	/**
	 * Get the specification from the specified TC.
	 *
	 * @return A &lt;code&gt;Specification&lt;/code&gt;, quits on error.
	 */
	private static Specification getTCSpecification() {
<span class="nc" id="L849">		Specification spec = loadSpecification(getTCFile(), getAdvantages(), getDifficulty());</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">		if (spec == null) {</span>
<span class="nc" id="L851">			fatal(StringTemplate.template(&quot;cli.error.badTC&quot;).addName(&quot;%tc%&quot;, getTC()));</span>
		}
<span class="nc" id="L853">		return spec;</span>
	}

	// Accessors, mutators and support for the cli variables.

	/**
	 * Gets the default advantages type.
	 *
	 * @return Usually Advantages.SELECTABLE, but can be overridden at the
	 *         command line.
	 */
	public static Advantages getAdvantages() {
<span class="pc bpc" id="L865" title="1 of 2 branches missed.">		return (advantages == null) ? ADVANTAGES_DEFAULT : advantages;</span>
	}

	/**
	 * Sets the advantages type.
	 *
	 * Called from NewPanel when a selection is made.
	 *
	 * @param advantages
	 *            The name of the new advantages type.
	 * @return The type of advantages set, or null if none.
	 */
	private static Advantages selectAdvantages(String advantages) {
<span class="nc" id="L878">		Advantages adv = find(Advantages.values(), a -&gt; Messages.getName(a).equals(advantages), null);</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">		if (adv != null)</span>
<span class="nc" id="L880">			setAdvantages(adv);</span>
<span class="nc" id="L881">		return adv;</span>
	}

	/**
	 * Sets the advantages type.
	 *
	 * @param advantages
	 *            The new &lt;code&gt;Advantages&lt;/code&gt; type.
	 */
	public static void setAdvantages(Advantages advantages) {
<span class="nc" id="L891">		FreeCol.advantages = advantages;</span>
<span class="nc" id="L892">	}</span>

	/**
	 * Gets a comma separated list of localized advantage type names.
	 *
	 * @return A list of advantage types.
	 */
	private static String getValidAdvantages() {
<span class="nc" id="L900">		return Arrays.stream(Advantages.values()).map(a -&gt; Messages.getName(a)).collect(Collectors.joining(&quot;,&quot;));</span>
	}

	/**
	 * Gets the difficulty level.
	 *
	 * @return The name of a difficulty level.
	 */
	public static String getDifficulty() {
<span class="nc bnc" id="L909" title="All 2 branches missed.">		return (difficulty == null) ? DIFFICULTY_DEFAULT : difficulty;</span>
	}

	/**
	 * Selects a difficulty level.
	 *
	 * @param arg
	 *            The supplied difficulty argument.
	 * @return The name of the selected difficulty, or null if none.
	 */
	public static String selectDifficulty(String arg) {
<span class="nc" id="L920">		String difficulty = find(map(DIFFICULTIES, d -&gt; &quot;model.difficulty.&quot; + d), k -&gt; Messages.getName(k).equals(arg),</span>
				null);
<span class="nc bnc" id="L922" title="All 2 branches missed.">		if (difficulty != null)</span>
<span class="nc" id="L923">			setDifficulty(difficulty);</span>
<span class="nc" id="L924">		return difficulty;</span>
	}

	/**
	 * Sets the difficulty level.
	 *
	 * @param difficulty
	 *            The actual &lt;code&gt;OptionGroup&lt;/code&gt; containing the difficulty
	 *            level.
	 */
	public static void setDifficulty(OptionGroup difficulty) {
<span class="nc" id="L935">		setDifficulty(difficulty.getId());</span>
<span class="nc" id="L936">	}</span>

	/**
	 * Sets the difficulty level.
	 *
	 * @param difficulty
	 *            The new difficulty.
	 */
	public static void setDifficulty(String difficulty) {
<span class="nc" id="L945">		FreeCol.difficulty = difficulty;</span>
<span class="nc" id="L946">	}</span>

	/**
	 * Gets the names of the valid difficulty levels.
	 *
	 * @return The valid difficulty levels, comma separated.
	 */
	public static String getValidDifficulties() {
<span class="nc" id="L954">		return Arrays.stream(DIFFICULTIES).map(d -&gt; Messages.getName(&quot;model.difficulty.&quot; + d))</span>
<span class="nc" id="L955">				.collect(Collectors.joining(&quot;,&quot;));</span>
	}

	/**
	 * Get the number of European nations to enable by default.
	 *
	 * @return the european count
	 */
	public static int getEuropeanCount() {
<span class="fc" id="L964">		return europeanCount;</span>
	}

	/**
	 * Sets the number of enabled European nations.
	 *
	 * @param n
	 *            The number of nations to enable.
	 */
	public static void setEuropeanCount(int n) {
<span class="nc" id="L974">		europeanCount = n;</span>
<span class="nc" id="L975">	}</span>

	/**
	 * Sets the scale for GUI elements.
	 * 
	 * @param arg
	 *            The optional command line argument to be parsed.
	 * @return If the argument was correctly formatted.
	 */
	public static boolean setGUIScale(String arg) {
<span class="nc" id="L985">		boolean valid = true;</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">		if (arg == null) {</span>
<span class="nc" id="L987">			guiScale = GUI_SCALE_MAX;</span>
		} else {
			try {
<span class="nc" id="L990">				int n = Integer.parseInt(arg);</span>
<span class="nc bnc" id="L991" title="All 2 branches missed.">				if (n &lt; GUI_SCALE_MIN_PCT) {</span>
<span class="nc" id="L992">					valid = false;</span>
<span class="nc" id="L993">					n = GUI_SCALE_MIN_PCT;</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">				} else if (n &gt; GUI_SCALE_MAX_PCT) {</span>
<span class="nc" id="L995">					valid = false;</span>
<span class="nc" id="L996">					n = GUI_SCALE_MAX_PCT;</span>
<span class="nc bnc" id="L997" title="All 2 branches missed.">				} else if (n % GUI_SCALE_STEP_PCT != 0) {</span>
<span class="nc" id="L998">					valid = false;</span>
				}
<span class="nc" id="L1000">				guiScale = ((float) (n / GUI_SCALE_STEP_PCT)) * GUI_SCALE_STEP;</span>
<span class="nc" id="L1001">			} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1002">				valid = false;</span>
<span class="nc" id="L1003">				guiScale = GUI_SCALE_MAX;</span>
<span class="nc" id="L1004">			}</span>
		}
<span class="nc" id="L1006">		return valid;</span>
	}

	/**
	 * Gets the valid scale factors for the GUI.
	 * 
	 * @return A string containing these.
	 */
	public static String getValidGUIScales() {
<span class="nc" id="L1015">		String result = &quot;&quot;;</span>
<span class="nc bnc" id="L1016" title="All 2 branches missed.">		for (int i = GUI_SCALE_MIN_PCT; i &lt; GUI_SCALE_MAX_PCT; i += GUI_SCALE_STEP_PCT)</span>
<span class="nc" id="L1017">			result += i + &quot;,&quot;;</span>
<span class="nc" id="L1018">		result += GUI_SCALE_MAX_PCT;</span>
<span class="nc" id="L1019">		return result;</span>
	}

	/**
	 * Selects a European nation count.
	 *
	 * @param arg
	 *            The supplied count argument.
	 * @return A valid nation number, or negative on error.
	 */
	public static int selectEuropeanCount(String arg) {
		try {
<span class="nc" id="L1031">			int n = Integer.parseInt(arg);</span>
<span class="nc bnc" id="L1032" title="All 2 branches missed.">			if (n &gt;= EUROPEANS_MIN) {</span>
<span class="nc" id="L1033">				setEuropeanCount(n);</span>
<span class="nc" id="L1034">				return n;</span>
			}
<span class="nc" id="L1036">		} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1037">		}</span>
<span class="nc" id="L1038">		return -1;</span>
	}

	/**
	 * Sets the log level.
	 *
	 * @param arg
	 *            The log level to set.
	 */
	private static void setLogLevel(String arg) {
<span class="nc" id="L1048">		logLevel = Level.parse(arg.toUpperCase());</span>
<span class="nc" id="L1049">	}</span>

	/**
	 * Gets the user name.
	 *
	 * @return The user name, defaults to the user.name property, then to the
	 *         &quot;main.defaultPlayerName&quot; message value.
	 */
	public static String getName() {
<span class="pc bpc" id="L1058" title="1 of 2 branches missed.">		return (name != null) ? name : System.getProperty(&quot;user.name&quot;, Messages.message(&quot;main.defaultPlayerName&quot;));</span>
	}

	/**
	 * Sets the user name.
	 *
	 * @param name
	 *            The new user name.
	 */
	public static void setName(String name) {
<span class="nc" id="L1068">		FreeCol.name = name;</span>
<span class="nc" id="L1069">		logger.info(&quot;Set FreeCol.name = &quot; + name);</span>
<span class="nc" id="L1070">	}</span>

	/**
	 * Get the selected locale.
	 *
	 * @return The &lt;code&gt;Locale&lt;/code&gt; currently in use.
	 */
	public static Locale getLocale() {
<span class="nc" id="L1078">		return FreeCol.locale;</span>
	}

	/**
	 * Gets the current revision of game.
	 *
	 * @return The current version and SVN Revision of the game.
	 */
	public static String getRevision() {
<span class="fc" id="L1087">		return freeColRevision;</span>
	}

	/**
	 * Get the default server host name.
	 *
	 * @return The host name.
	 */
	public static String getServerHost() {
<span class="nc" id="L1096">		return InetAddress.getLoopbackAddress().getHostAddress();</span>
	}

	/**
	 * Gets the server network port.
	 *
	 * @return The port number.
	 */
	public static int getServerPort() {
<span class="pc bpc" id="L1105" title="1 of 2 branches missed.">		return (serverPort &lt; 0) ? PORT_DEFAULT : serverPort;</span>
	}

	/**
	 * Sets the server port.
	 *
	 * @param arg
	 *            The server port number.
	 * @return True if the port was set.
	 */
	public static boolean setServerPort(String arg) {
<span class="nc bnc" id="L1116" title="All 2 branches missed.">		if (arg == null)</span>
<span class="nc" id="L1117">			return false;</span>
		try {
<span class="nc" id="L1119">			serverPort = Integer.parseInt(arg);</span>
<span class="nc" id="L1120">		} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1121">			return false;</span>
<span class="nc" id="L1122">		}</span>
<span class="nc" id="L1123">		return true;</span>
	}

	/**
	 * Gets the current Total-Conversion.
	 *
	 * @return Usually TC_DEFAULT, but can be overridden at the command line.
	 */
	public static String getTC() {
<span class="pc bpc" id="L1132" title="1 of 2 branches missed.">		return (tc == null) ? TC_DEFAULT : tc;</span>
	}

	/**
	 * Sets the Total-Conversion.
	 *
	 * Called from NewPanel when a selection is made.
	 *
	 * @param tc
	 *            The name of the new total conversion.
	 */
	public static void setTC(String tc) {
<span class="nc" id="L1144">		FreeCol.tc = tc;</span>
<span class="nc" id="L1145">	}</span>

	/**
	 * Gets the FreeColTcFile for the current TC.
	 *
	 * @return The &lt;code&gt;FreeColTcFile&lt;/code&gt;.
	 */
	public static FreeColTcFile getTCFile() {
		try {
<span class="nc" id="L1154">			return new FreeColTcFile(getTC());</span>
<span class="nc" id="L1155">		} catch (IOException ioe) {</span>
		}
<span class="nc" id="L1157">		return null;</span>
	}

	/**
	 * Gets the timeout. Use the command line specified one if any, otherwise
	 * default to `infinite' in single player and the TIMEOUT_DEFAULT for
	 * multiplayer.
	 *
	 * @param singlePlayer
	 *            True if this is a single player game.
	 * @return A suitable timeout value.
	 */
	public static int getTimeout(boolean singlePlayer) {
<span class="nc bnc" id="L1170" title="All 4 branches missed.">		return (timeout &gt;= TIMEOUT_MIN) ? timeout : (singlePlayer) ? Integer.MAX_VALUE : TIMEOUT_DEFAULT;</span>
	}

	/**
	 * Sets the timeout.
	 *
	 * @param timeout
	 *            A string containing the new timeout.
	 * @return True if the timeout was set.
	 */
	public static boolean setTimeout(String timeout) {
		try {
<span class="nc" id="L1182">			int result = Integer.parseInt(timeout);</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">			if (result &gt;= TIMEOUT_MIN) {</span>
<span class="nc" id="L1184">				FreeCol.timeout = result;</span>
<span class="nc" id="L1185">				return true;</span>
			}
<span class="nc" id="L1187">		} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1188">		}</span>
<span class="nc" id="L1189">		return false;</span>
	}

	/**
	 * Gets the current version of game.
	 *
	 * @return The current version of the game using the format &quot;x.y.z&quot;, where
	 *         &quot;x&quot; is major, &quot;y&quot; is minor and &quot;z&quot; is revision.
	 */
	public static String getVersion() {
<span class="nc" id="L1199">		return FREECOL_VERSION;</span>
	}

	/**
	 * Sets the window size.
	 *
	 * Does not fail because any empty or invalid value is interpreted as
	 * `windowed but use as much screen as possible'.
	 *
	 * @param arg
	 *            The window size specification.
	 */
	private static void setWindowSize(String arg) {
		String[] xy;
<span class="nc bnc" id="L1213" title="All 6 branches missed.">		if (arg != null &amp;&amp; (xy = arg.split(&quot;[^0-9]&quot;)) != null &amp;&amp; xy.length == 2) {</span>
			try {
<span class="nc" id="L1215">				windowSize = new Dimension(Integer.parseInt(xy[0]), Integer.parseInt(xy[1]));</span>
<span class="nc" id="L1216">			} catch (NumberFormatException nfe) {</span>
<span class="nc" id="L1217">			}</span>
		}
<span class="nc bnc" id="L1219" title="All 2 branches missed.">		if (windowSize == null)</span>
<span class="nc" id="L1220">			windowSize = new Dimension(-1, -1);</span>
<span class="nc" id="L1221">	}</span>

	/**
	 * Utility to make a load failure message.
	 *
	 * @param file
	 *            The &lt;code&gt;File&lt;/code&gt; that failed to load.
	 * @return A &lt;code&gt;StringTemplate&lt;/code&gt; with the error message.
	 */
	public static StringTemplate badLoad(File file) {
<span class="nc" id="L1231">		return StringTemplate.template(&quot;error.couldNotLoad&quot;).addName(&quot;%name%&quot;, file.getPath());</span>
	}

	/**
	 * Utility to make a save failure message.
	 *
	 * @param file
	 *            The &lt;code&gt;File&lt;/code&gt; that failed to save.
	 * @return A &lt;code&gt;StringTemplate&lt;/code&gt; with the error message.
	 */
	public static StringTemplate badSave(File file) {
<span class="nc" id="L1242">		return StringTemplate.template(&quot;error.couldNotSave&quot;).addName(&quot;%name%&quot;, file.getPath());</span>
	}

	/**
	 * We get a lot of lame bug reports with insufficient configuration
	 * information. Get a buffer containing as much information as we can to
	 * embed in the log file and saved games.
	 *
	 * @return A &lt;code&gt;StringBuilder&lt;/code&gt; full of configuration information.
	 */
	public static StringBuilder getConfiguration() {
<span class="fc" id="L1253">		File autosave = FreeColDirectories.getAutosaveDirectory();</span>
<span class="fc" id="L1254">		File clientOptionsFile = FreeColDirectories.getClientOptionsFile();</span>
<span class="fc" id="L1255">		File save = FreeColDirectories.getSaveDirectory();</span>
<span class="fc" id="L1256">		File userConfig = FreeColDirectories.getUserConfigDirectory();</span>
<span class="fc" id="L1257">		File userData = FreeColDirectories.getUserDataDirectory();</span>
<span class="fc" id="L1258">		File userMods = FreeColDirectories.getUserModsDirectory();</span>
<span class="fc" id="L1259">		StringBuilder sb = new StringBuilder(256);</span>
<span class="fc" id="L1260">		sb.append(&quot;Configuration:&quot;).append(&quot;\n  version     &quot;).append(getRevision()).append(&quot;\n  java:       &quot;)</span>
<span class="fc" id="L1261">				.append(JAVA_VERSION).append(&quot;\n  memory:     &quot;).append(MEMORY_MAX).append(&quot;\n  locale:     &quot;)</span>
<span class="fc" id="L1262">				.append(locale).append(&quot;\n  data:       &quot;).append(FreeColDirectories.getDataDirectory().getPath())</span>
<span class="pc bpc" id="L1263" title="1 of 2 branches missed.">				.append(&quot;\n  userConfig: &quot;).append((userConfig == null) ? &quot;NONE&quot; : userConfig.getPath())</span>
<span class="pc bpc" id="L1264" title="1 of 2 branches missed.">				.append(&quot;\n  userData:   &quot;).append((userData == null) ? &quot;NONE&quot; : userData.getPath())</span>
<span class="pc bpc" id="L1265" title="1 of 2 branches missed.">				.append(&quot;\n  autosave:   &quot;).append((autosave == null) ? &quot;NONE&quot; : autosave.getPath())</span>
<span class="pc bpc" id="L1266" title="1 of 2 branches missed.">				.append(&quot;\n  logFile:    &quot;).append(FreeColDirectories.getLogFilePath()).append(&quot;\n  options:    &quot;)</span>
<span class="pc bpc" id="L1267" title="1 of 2 branches missed.">				.append((clientOptionsFile == null) ? &quot;NONE&quot; : clientOptionsFile.getPath()).append(&quot;\n  save:       &quot;)</span>
<span class="pc bpc" id="L1268" title="1 of 2 branches missed.">				.append((save == null) ? &quot;NONE&quot; : save.getPath()).append(&quot;\n  userMods:   &quot;)</span>
<span class="pc" id="L1269">				.append((userMods == null) ? &quot;NONE&quot; : userMods.getPath());</span>
<span class="fc" id="L1270">		return sb;</span>
	}

	// The major final actions.

	/**
	 * Start a client.
	 *
	 * @param userMsg
	 *            An optional user message key.
	 */
	private static void startClient(String userMsg) {
<span class="nc" id="L1282">		Specification spec = null;</span>
<span class="nc" id="L1283">		File savegame = FreeColDirectories.getSavegameFile();</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">		if (debugStart) {</span>
<span class="nc" id="L1285">			spec = FreeCol.getTCSpecification();</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">		} else if (fastStart) {</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">			if (savegame == null) {</span>
				// continue last saved game if possible,
				// otherwise start a new one
<span class="nc" id="L1290">				savegame = FreeColDirectories.getLastSaveGameFile();</span>
<span class="nc bnc" id="L1291" title="All 2 branches missed.">				if (savegame == null) {</span>
<span class="nc" id="L1292">					spec = FreeCol.getTCSpecification();</span>
				}
			}
			// savegame was specified on command line
		}
<span class="nc" id="L1297">		final FreeColClient freeColClient = new FreeColClient(splashStream, fontName, guiScale, headless);</span>
<span class="nc" id="L1298">		freeColClient.startClient(windowSize, userMsg, sound, introVideo, savegame, spec);</span>
<span class="nc" id="L1299">	}</span>

	/**
	 * Start the server.
	 */
	private static void startServer() {
<span class="nc" id="L1305">		logger.info(&quot;Starting stand-alone server.&quot;);</span>
		final FreeColServer freeColServer;
<span class="nc" id="L1307">		File saveGame = FreeColDirectories.getSavegameFile();</span>
<span class="nc bnc" id="L1308" title="All 2 branches missed.">		if (saveGame != null) {</span>
			try {
<span class="nc" id="L1310">				final FreeColSavegameFile fis = new FreeColSavegameFile(saveGame);</span>
<span class="nc" id="L1311">				freeColServer = new FreeColServer(fis, (Specification) null, serverPort, serverName);</span>
<span class="nc bnc" id="L1312" title="All 2 branches missed.">				if (checkIntegrity) {</span>
<span class="nc bnc" id="L1313" title="All 2 branches missed.">					boolean integrityOK = freeColServer.getIntegrity() &gt; 0;</span>
<span class="nc bnc" id="L1314" title="All 2 branches missed.">					gripe((integrityOK) ? &quot;cli.check-savegame.success&quot; : &quot;cli.check-savegame.failure&quot;);</span>
<span class="nc bnc" id="L1315" title="All 2 branches missed.">					System.exit((integrityOK) ? 0 : 2);</span>
				}
<span class="nc" id="L1317">			} catch (Exception e) {</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">				if (checkIntegrity)</span>
<span class="nc" id="L1319">					gripe(&quot;cli.check-savegame.failure&quot;);</span>
<span class="nc" id="L1320">				fatal(Messages.message(badLoad(saveGame)) + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L1321">				return;</span>
<span class="nc" id="L1322">			}</span>
		} else {
<span class="nc" id="L1324">			Specification spec = FreeCol.getTCSpecification();</span>
			try {
<span class="nc" id="L1326">				freeColServer = new FreeColServer(publicServer, false, spec, serverPort, serverName);</span>
<span class="nc" id="L1327">			} catch (Exception e) {</span>
<span class="nc" id="L1328">				fatal(Messages.message(&quot;server.initialize&quot;) + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L1329">				return;</span>
<span class="nc" id="L1330">			}</span>
<span class="nc bnc" id="L1331" title="All 6 branches missed.">			if (publicServer &amp;&amp; freeColServer != null &amp;&amp; !freeColServer.getPublicServer()) {</span>
<span class="nc" id="L1332">				gripe(Messages.message(&quot;server.noRouteToServer&quot;));</span>
			}
		}

<span class="nc" id="L1336">		String quit = FreeCol.SERVER_THREAD + &quot;Quit Game&quot;;</span>
<span class="nc" id="L1337">		Runtime.getRuntime().addShutdownHook(new Thread(quit) {</span>
			@Override
			public void run() {
<span class="nc" id="L1340">				freeColServer.getController().shutdown();</span>
<span class="nc" id="L1341">			}</span>
		});
<span class="nc" id="L1343">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>