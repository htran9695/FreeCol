<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Canvas.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui</a> &gt; <span class="el_source">Canvas.java</span></div><h1>Canvas.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui;

import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GraphicsDevice;
import java.awt.Image;
import java.awt.Point;
import java.awt.Rectangle;
import java.awt.RenderingHints;
import java.awt.event.ActionListener;
import java.awt.event.KeyListener;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import java.awt.font.TextLayout;
import java.awt.geom.Rectangle2D;
import java.io.File;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import javax.swing.ImageIcon;
import javax.swing.JComponent;
import javax.swing.JDesktopPane;
import javax.swing.JInternalFrame;
import javax.swing.JLayeredPane;
import javax.swing.JMenuBar;
import javax.swing.JMenuItem;
import javax.swing.SwingUtilities;
import javax.swing.UIManager;
import javax.swing.border.EmptyBorder;
import javax.swing.filechooser.FileFilter;
import javax.swing.filechooser.FileNameExtensionFilter;
import javax.swing.plaf.basic.BasicInternalFrameUI;

import net.sf.freecol.FreeCol;
import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.client.gui.action.FreeColAction;
import net.sf.freecol.client.gui.panel.*;
import net.sf.freecol.client.gui.panel.LabourData.UnitData;
import net.sf.freecol.common.ServerInfo;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.FreeColObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.PathNode;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TypeCountMap;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.option.IntegerOption;
import net.sf.freecol.common.option.Option;
import net.sf.freecol.common.option.OptionGroup;
import net.sf.freecol.common.resources.ResourceManager;

/**
 * The main container for the other GUI components in FreeCol. This container is
 * where the panels, dialogs and menus are added. In addition, this is the
 * component in which the map graphics are displayed.
 *
 * &lt;b&gt;Displaying panels and a dialogs&lt;/b&gt; &lt;br&gt;
 * &lt;br&gt;
 * &lt;code&gt;Canvas&lt;/code&gt; contains methods to display various panels and dialogs.
 * Most of these methods use {@link net.sf.freecol.common.i18n i18n} to get
 * localized text. Dialogs return results, and may be modal or non-modal.
 */
public final class Canvas extends JDesktopPane {

	/** The Constant logger. */
<span class="nc" id="L113">	private static final Logger logger = Logger.getLogger(Canvas.class.getName());</span>

	/**
	 * A wrapper class for non-modal dialogs.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 */
	private class DialogCallback&lt;T&gt; implements Runnable {

		/** The dialog to show. */
		private final FreeColDialog&lt;T&gt; fcd;

		/** An optional tile to guide the dialog placement. */
		private final Tile tile;

		/** The handler for the dialog response. */
		private final DialogHandler&lt;T&gt; handler;

		/**
		 * Constructor.
		 *
		 * @param fcd
		 *            the fcd
		 * @param tile
		 *            the tile
		 * @param handler
		 *            the handler
		 */
<span class="nc" id="L142">		public DialogCallback(FreeColDialog&lt;T&gt; fcd, Tile tile, DialogHandler&lt;T&gt; handler) {</span>
<span class="nc" id="L143">			this.fcd = fcd;</span>
<span class="nc" id="L144">			this.tile = tile;</span>
<span class="nc" id="L145">			this.handler = handler;</span>
<span class="nc" id="L146">		}</span>

		// Implement Runnable

		/*
		 * (non-Javadoc)
		 * 
		 * @see java.lang.Runnable#run()
		 */
		@Override
		public void run() {
			// Display the dialog...
<span class="nc" id="L158">			viewFreeColDialog(fcd, tile);</span>
			// ...and use another thread to wait for a dialog response...
<span class="nc" id="L160">			new Thread(fcd.toString()) {</span>
				@Override
				public void run() {
<span class="nc bnc" id="L163" title="All 2 branches missed.">					while (!fcd.responded()) {</span>
						try {
<span class="nc" id="L165">							Thread.sleep(500);</span>
<span class="nc" id="L166">						} catch (InterruptedException e) {</span>
<span class="nc" id="L167">						}</span>
					}
					// ...before handling the result.
<span class="nc" id="L170">					handler.handle(fcd.getResponse());</span>
<span class="nc" id="L171">				}</span>
<span class="nc" id="L172">			}.start();</span>
<span class="nc" id="L173">		}</span>
	};

	/**
	 * The Enum PopupPosition.
	 */
<span class="nc" id="L179">	private static enum PopupPosition {</span>

		/** The origin. */
<span class="nc" id="L182">		ORIGIN,</span>

		/** The centered. */
<span class="nc" id="L185">		CENTERED,</span>

		/** The centered left. */
<span class="nc" id="L188">		CENTERED_LEFT,</span>

		/** The centered right. */
<span class="nc" id="L191">		CENTERED_RIGHT,</span>
	}

	/** Number of tries to find a clear spot on the canvas. */
	private static final int MAXTRY = 3;

	/** A class for frames being used as tool boxes. */
<span class="nc" id="L198">	private static class ToolBoxFrame extends JInternalFrame {</span>
	}

	/** The game client. */
	private final FreeColClient freeColClient;

	/** The parent GUI. */
	private final SwingGUI gui;

	/** The graphics device. */
	private final GraphicsDevice graphicsDevice;

	/** The parent frame, either a window or the full screen. */
	private FreeColFrame frame;

	/** The windowed. */
	private boolean windowed;

	/** The main panel. */
	private MainPanel mainPanel;

	/** The start game panel. */
	private final StartGamePanel startGamePanel;

	/** The status panel. */
	private final StatusPanel statusPanel;

	/** The chat panel. */
	private final ChatPanel chatPanel;

	/** The chat display. */
	private final ChatDisplay chatDisplay;

	/** The map viewer. */
	private final MapViewer mapViewer;

	/** The goto drag point. */
	private Point gotoDragPoint;

	/** The grey layer. */
	private GrayLayer greyLayer;

	/** The server list panel. */
	private final ServerListPanel serverListPanel;

	/** Used to detect resizing. */
<span class="nc" id="L244">	private Dimension oldSize = null;</span>

	/** The client options dialog showing. */
<span class="nc" id="L247">	private boolean clientOptionsDialogShowing = false;</span>

	/** The loading savegame dialog. */
	private LoadingSavegameDialog loadingSavegameDialog;

	/** Filters for loadable game files. */
<span class="nc" id="L253">	private FileFilter[] fileFilters = null;</span>

	/** The dialogs in view. */
<span class="nc" id="L256">	private final List&lt;FreeColDialog&lt;?&gt;&gt; dialogs = new ArrayList&lt;&gt;();</span>

	/**
	 * The constructor to use.
	 *
	 * @param freeColClient
	 *            The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
	 * @param graphicsDevice
	 *            The used graphics device.
	 * @param gui
	 *            The gui.
	 * @param desiredSize
	 *            The desired size of the frame.
	 * @param mapViewer
	 *            The object responsible of drawing the map onto this component.
	 */
	Canvas(final FreeColClient freeColClient, final GraphicsDevice graphicsDevice, final SwingGUI gui,
<span class="nc" id="L273">			final Dimension desiredSize, MapViewer mapViewer) {</span>
<span class="nc" id="L274">		this.freeColClient = freeColClient;</span>
<span class="nc" id="L275">		this.gui = gui;</span>
<span class="nc" id="L276">		this.graphicsDevice = graphicsDevice;</span>
<span class="nc" id="L277">		chatDisplay = new ChatDisplay();</span>
<span class="nc" id="L278">		this.mapViewer = mapViewer;</span>

		// Determine if windowed mode should be used and set the window size.
<span class="nc" id="L281">		Rectangle windowBounds = null;</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">		if (desiredSize == null) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">			if (graphicsDevice.isFullScreenSupported()) {</span>
<span class="nc" id="L284">				windowed = false;</span>
<span class="nc" id="L285">				logger.info(&quot;Full screen mode used.&quot;);</span>
			} else {
<span class="nc" id="L287">				windowed = true;</span>
<span class="nc" id="L288">				logger.warning(&quot;Full screen mode not supported.&quot;);</span>
<span class="nc" id="L289">				System.err.println(Messages.message(&quot;client.fullScreen&quot;));</span>
			}
		} else {
<span class="nc" id="L292">			windowed = true;</span>
<span class="nc bnc" id="L293" title="All 4 branches missed.">			if (desiredSize.width &gt; 0 &amp;&amp; desiredSize.height &gt; 0) {</span>
<span class="nc" id="L294">				windowBounds = new Rectangle(desiredSize);</span>
<span class="nc" id="L295">				logger.info(&quot;Windowed mode using desired window size of &quot; + desiredSize);</span>
			} else {
<span class="nc" id="L297">				logger.info(&quot;Windowed mode used.&quot;);</span>
			}
		}

<span class="nc" id="L301">		setDoubleBuffered(true);</span>
<span class="nc" id="L302">		setOpaque(false);</span>
<span class="nc" id="L303">		setLayout(null);</span>

<span class="nc" id="L305">		startGamePanel = new StartGamePanel(freeColClient);</span>
<span class="nc" id="L306">		serverListPanel = new ServerListPanel(freeColClient, freeColClient.getConnectController());</span>
<span class="nc" id="L307">		statusPanel = new StatusPanel(freeColClient);</span>
<span class="nc" id="L308">		chatPanel = new ChatPanel(freeColClient);</span>

<span class="nc" id="L310">		setFocusable(true);</span>
<span class="nc" id="L311">		setFocusTraversalKeysEnabled(false);</span>

<span class="nc" id="L313">		createKeyBindings();</span>
<span class="nc" id="L314">		createFrame(null, windowBounds);</span>
<span class="nc" id="L315">		mapViewer.startCursorBlinking();</span>
<span class="nc" id="L316">		logger.info(&quot;Canvas created.&quot;);</span>
<span class="nc" id="L317">	}</span>

	/**
	 * Checks if is windowed.
	 *
	 * @return true, if is windowed
	 */
	boolean isWindowed() {
<span class="nc" id="L325">		return windowed;</span>
	}

	/**
	 * Change the windowed mode.
	 */
	void changeWindowedMode() {
		// Clean up the old frame
<span class="nc" id="L333">		JMenuBar menuBar = null;</span>
<span class="nc" id="L334">		Rectangle windowBounds = null;</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">		if (frame != null) {</span>
<span class="nc" id="L336">			menuBar = frame.getJMenuBar();</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">			if (windowed) {</span>
<span class="nc" id="L338">				windowBounds = frame.getBounds();</span>
			}
<span class="nc" id="L340">			frame.setVisible(false);</span>
<span class="nc" id="L341">			frame.dispose();</span>
		}
<span class="nc bnc" id="L343" title="All 2 branches missed.">		windowed = !windowed;</span>

<span class="nc" id="L345">		createFrame(menuBar, windowBounds);</span>
<span class="nc" id="L346">	}</span>

	/**
	 * Creates the frame.
	 *
	 * @param menuBar
	 *            the menu bar
	 * @param windowBounds
	 *            the window bounds
	 */
	private void createFrame(JMenuBar menuBar, Rectangle windowBounds) {
		// FIXME: Check this:
		// User might have moved window to new screen in a
		// multi-screen setup, so make this.gd point to the current screen.
<span class="nc" id="L360">		frame = new FreeColFrame(freeColClient, graphicsDevice, menuBar, this, windowed, windowBounds);</span>
<span class="nc" id="L361">		updateSizes();</span>
<span class="nc" id="L362">		frame.setVisible(true);</span>
<span class="nc" id="L363">	}</span>

	/**
	 * Start the GUI for the map editor.
	 */
	void startMapEditorGUI() {
<span class="nc bnc" id="L369" title="All 2 branches missed.">		if (frame == null)</span>
<span class="nc" id="L370">			return;</span>

		// We may need to reset the zoom value to the default value
<span class="nc" id="L373">		gui.resetMapZoom();</span>

<span class="nc" id="L375">		frame.setMapEditorMenuBar();</span>
<span class="nc" id="L376">		showMapEditorTransformPanel();</span>

<span class="nc" id="L378">		CanvasMapEditorMouseListener listener = new CanvasMapEditorMouseListener(freeColClient, this);</span>
<span class="nc" id="L379">		addMouseListener(listener);</span>
<span class="nc" id="L380">		addMouseMotionListener(listener);</span>
<span class="nc" id="L381">	}</span>

	/**
	 * Quit the GUI. All that is required is to exit the full screen.
	 *
	 * @throws Exception
	 *             the exception
	 */
	void quit() throws Exception {
<span class="nc bnc" id="L390" title="All 4 branches missed.">		if (frame != null &amp;&amp; !windowed) {</span>
<span class="nc" id="L391">			frame.exitFullScreen();</span>
		}
<span class="nc" id="L393">	}</span>

	/**
	 * In game initializations.
	 */
	void initializeInGame() {
<span class="nc bnc" id="L399" title="All 2 branches missed.">		if (frame == null)</span>
<span class="nc" id="L400">			return;</span>
<span class="nc" id="L401">		frame.setInGameMenuBar();</span>
<span class="nc" id="L402">	}</span>

	/**
	 * Reset the menu bar.
	 */
	void resetMenuBar() {
<span class="nc bnc" id="L408" title="All 2 branches missed.">		if (frame == null)</span>
<span class="nc" id="L409">			return;</span>
<span class="nc" id="L410">		frame.resetMenuBar();</span>
<span class="nc" id="L411">	}</span>

	/**
	 * Update the menu bar.
	 */
	void updateMenuBar() {
<span class="nc bnc" id="L417" title="All 2 branches missed.">		if (frame == null)</span>
<span class="nc" id="L418">			return;</span>
<span class="nc" id="L419">		frame.updateMenuBar();</span>
<span class="nc" id="L420">	}</span>

	/**
	 * Scroll the map in the given direction.
	 *
	 * @param direction
	 *            The &lt;code&gt;Direction&lt;/code&gt; to scroll in.
	 * @return True if scrolling occurred.
	 */
	boolean scrollMap(Direction direction) {
<span class="nc" id="L430">		return mapViewer.scrollMap(direction);</span>
	}

	/**
	 * Converts the given screen coordinates to Map coordinates. It checks to
	 * see to which Tile the given pixel 'belongs'.
	 *
	 * @param x
	 *            The x-coordinate in pixels.
	 * @param y
	 *            The y-coordinate in pixels.
	 * @return The Tile that is located at the given position on the screen.
	 */
	Tile convertToMapTile(int x, int y) {
<span class="nc" id="L444">		return mapViewer.convertToMapTile(x, y);</span>
	}

	/**
	 * Get the view mode.
	 *
	 * @return The view mode.
	 */
	public int getViewMode() {
<span class="nc" id="L453">		return mapViewer.getViewMode();</span>
	}

	/**
	 * Gets the active unit.
	 *
	 * @return The &lt;code&gt;Unit&lt;/code&gt;.
	 */
	Unit getActiveUnit() {
<span class="nc" id="L462">		return mapViewer.getActiveUnit();</span>
	}

	/**
	 * Set the current active unit path.
	 *
	 * @param path
	 *            The current &lt;code&gt;PathNode&lt;/code&gt;.
	 */
	void setCurrentPath(PathNode path) {
<span class="nc" id="L472">		mapViewer.setCurrentPath(path);</span>
<span class="nc" id="L473">	}</span>

	/**
	 * Sets the path of the active unit to display it.
	 */
	void updateCurrentPathForActiveUnit() {
<span class="nc" id="L479">		mapViewer.updateCurrentPathForActiveUnit();</span>
<span class="nc" id="L480">	}</span>

	/**
	 * Gets the point at which the map was clicked for a drag.
	 *
	 * @return The Point where the mouse was initially clicked.
	 */
	Point getDragPoint() {
<span class="nc" id="L488">		return gotoDragPoint;</span>
	}

	/**
	 * Sets the point at which the map was clicked for a drag.
	 *
	 * @param x
	 *            The mouse's x position.
	 * @param y
	 *            The mouse's y position.
	 */
	void setDragPoint(int x, int y) {
<span class="nc" id="L500">		gotoDragPoint = new Point(x, y);</span>
<span class="nc" id="L501">	}</span>

	/**
	 * Checks if there is currently a goto operation on the mapboard.
	 *
	 * @return True if a goto operation is in progress.
	 */
	boolean isGotoStarted() {
<span class="nc" id="L509">		return mapViewer.isGotoStarted();</span>
	}

	/**
	 * Gets the path to be drawn on the map.
	 *
	 * @return The path that should be drawn on the map or &lt;code&gt;null&lt;/code&gt; if
	 *         no path should be drawn.
	 */
	PathNode getGotoPath() {
<span class="nc" id="L519">		return mapViewer.getGotoPath();</span>
	}

	/**
	 * Sets the path to be drawn on the map.
	 *
	 * @param gotoPath
	 *            The path that should be drawn on the map or &lt;code&gt;null&lt;/code&gt;
	 *            if no path should be drawn.
	 */
	void setGotoPath(PathNode gotoPath) {
<span class="nc" id="L530">		mapViewer.setGotoPath(gotoPath);</span>
<span class="nc" id="L531">		refresh();</span>
<span class="nc" id="L532">	}</span>

	/**
	 * Starts a goto operation.
	 */
	void startGoto() {
<span class="nc" id="L538">		setCursor((java.awt.Cursor) UIManager.get(&quot;cursor.go&quot;));</span>
<span class="nc" id="L539">		mapViewer.startGoto();</span>
<span class="nc" id="L540">		refresh();</span>
<span class="nc" id="L541">	}</span>

	/**
	 * Stops any ongoing goto operation.
	 */
	void stopGoto() {
<span class="nc" id="L547">		setCursor(null);</span>
<span class="nc" id="L548">		mapViewer.stopGoto();</span>
<span class="nc" id="L549">		refresh();</span>
<span class="nc" id="L550">	}</span>

	// Internals

	/**
	 * Adds a component on this Canvas inside a frame.
	 *
	 * @param comp
	 *            The component to add to the canvas.
	 * @param toolBox
	 *            Should be set to true if the resulting frame is used as a
	 *            toolbox (that is: it should not be counted as a frame).
	 * @param popupPosition
	 *            A preferred &lt;code&gt;PopupPosition&lt;/code&gt;.
	 * @param resizable
	 *            Whether this component can be resized.
	 * @return The &lt;code&gt;JInternalFrame&lt;/code&gt; that was created and added.
	 */
	private JInternalFrame addAsFrame(JComponent comp, boolean toolBox, PopupPosition popupPosition,
			boolean resizable) {
<span class="nc" id="L570">		final int FRAME_EMPTY_SPACE = 60;</span>

<span class="nc bnc" id="L572" title="All 2 branches missed.">		final JInternalFrame f = (toolBox) ? new ToolBoxFrame() : new JInternalFrame();</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">		if (f.getContentPane() instanceof JComponent) {</span>
<span class="nc" id="L574">			JComponent c = (JComponent) f.getContentPane();</span>
<span class="nc" id="L575">			c.setOpaque(false);</span>
<span class="nc" id="L576">			c.setBorder(null);</span>
		}

<span class="nc bnc" id="L579" title="All 2 branches missed.">		if (comp.getBorder() != null) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">			if (comp.getBorder() instanceof EmptyBorder) {</span>
<span class="nc" id="L581">				f.setBorder(Utility.blankBorder(10, 10, 10, 10));</span>
			} else {
<span class="nc" id="L583">				f.setBorder(comp.getBorder());</span>
<span class="nc" id="L584">				comp.setBorder(Utility.blankBorder(5, 5, 5, 5));</span>
			}
		} else {
<span class="nc" id="L587">			f.setBorder(null);</span>
		}

<span class="nc" id="L590">		final FrameMotionListener fml = new FrameMotionListener(f);</span>
<span class="nc" id="L591">		comp.addMouseMotionListener(fml);</span>
<span class="nc" id="L592">		comp.addMouseListener(fml);</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">		if (f.getUI() instanceof BasicInternalFrameUI) {</span>
<span class="nc" id="L594">			BasicInternalFrameUI biu = (BasicInternalFrameUI) f.getUI();</span>
<span class="nc" id="L595">			biu.setNorthPane(null);</span>
<span class="nc" id="L596">			biu.setSouthPane(null);</span>
<span class="nc" id="L597">			biu.setWestPane(null);</span>
<span class="nc" id="L598">			biu.setEastPane(null);</span>
		}

<span class="nc" id="L601">		f.getContentPane().add(comp);</span>
<span class="nc" id="L602">		f.setOpaque(false);</span>
<span class="nc" id="L603">		f.pack();</span>
<span class="nc" id="L604">		int width = f.getWidth();</span>
<span class="nc" id="L605">		int height = f.getHeight();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">		if (width &gt; getWidth() - FRAME_EMPTY_SPACE) {</span>
<span class="nc" id="L607">			width = Math.min(width, getWidth());</span>
		}
<span class="nc bnc" id="L609" title="All 2 branches missed.">		if (height &gt; getHeight() - FRAME_EMPTY_SPACE) {</span>
<span class="nc" id="L610">			height = Math.min(height, getHeight());</span>
		}
<span class="nc" id="L612">		f.setSize(width, height);</span>
<span class="nc" id="L613">		Point p = chooseLocation(comp, width, height, popupPosition);</span>
<span class="nc" id="L614">		f.setLocation(p);</span>
<span class="nc" id="L615">		this.add(f, MODAL_LAYER);</span>
<span class="nc" id="L616">		f.setName(comp.getClass().getSimpleName());</span>

<span class="nc" id="L618">		f.setFrameIcon(null);</span>
<span class="nc" id="L619">		f.setVisible(true);</span>
<span class="nc" id="L620">		f.setResizable(resizable);</span>
		try {
<span class="nc" id="L622">			f.setSelected(true);</span>
<span class="nc" id="L623">		} catch (java.beans.PropertyVetoException e) {</span>
<span class="nc" id="L624">		}</span>

<span class="nc" id="L626">		return f;</span>
	}

	/**
	 * Adds a component centered on this Canvas.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to add to this canvas.
	 * @param i
	 *            The layer to add the component to (see JLayeredPane).
	 */
	private void addCentered(Component comp, Integer i) {
<span class="nc" id="L638">		comp.setLocation((getWidth() - comp.getWidth()) / 2, (getHeight() - comp.getHeight()) / 2);</span>

<span class="nc" id="L640">		this.add(comp, i);</span>
<span class="nc" id="L641">	}</span>

	/**
	 * Adds a component to this Canvas. Removes the statusPanel if visible (and
	 * &lt;code&gt;comp != statusPanel&lt;/code&gt;).
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to add to this canvas.
	 * @param i
	 *            The layer to add the component to (see JLayeredPane).
	 */
	private void addToCanvas(Component comp, Integer i) {
<span class="nc bnc" id="L653" title="All 6 branches missed.">		if (comp != statusPanel &amp;&amp; !(comp instanceof JMenuItem) &amp;&amp; statusPanel.isVisible()) {</span>
<span class="nc" id="L654">			removeFromCanvas(statusPanel);</span>
		}

		try {
<span class="nc bnc" id="L658" title="All 2 branches missed.">			super.add(comp, (i == null) ? JLayeredPane.DEFAULT_LAYER : i);</span>
<span class="nc" id="L659">		} catch (Exception e) {</span>
<span class="nc" id="L660">			logger.log(Level.WARNING, &quot;addToCanvas(&quot; + comp + &quot;, &quot; + i + &quot;) failed.&quot;, e);</span>
<span class="nc" id="L661">		}</span>
<span class="nc" id="L662">	}</span>

	/**
	 * Choose a location for a component.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to place.
	 * @param width
	 *            The component width to use.
	 * @param height
	 *            The component height to use.
	 * @param popupPosition
	 *            An optional &lt;code&gt;PopupPosition&lt;/code&gt; hint.
	 * @return A suitable &lt;code&gt;Point&lt;/code&gt; to place the component.
	 */
	private Point chooseLocation(Component comp, int width, int height, PopupPosition popupPosition) {
<span class="nc" id="L678">		Point p = null;</span>
<span class="nc bnc" id="L679" title="All 4 branches missed.">		if ((comp instanceof FreeColPanel) &amp;&amp; (p = getSavedPosition(comp)) != null) {</span>
			// Sanity check stuff coming out of client options.
<span class="nc bnc" id="L681" title="All 8 branches missed.">			if (p.getX() &lt; 0 || p.getX() &gt;= getWidth() - width || p.getY() &lt; 0 || p.getY() &gt;= getHeight() - height) {</span>
<span class="nc" id="L682">				p = null;</span>
			}
		}
<span class="nc" id="L685">		int x = 0, y = 0;</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">		if (p != null) {</span>
<span class="nc" id="L687">			x = (int) p.getX();</span>
<span class="nc" id="L688">			y = (int) p.getY();</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">		} else if (popupPosition != null) {</span>
<span class="nc bnc" id="L690" title="All 5 branches missed.">			switch (popupPosition) {</span>
			case CENTERED:
<span class="nc" id="L692">				x = (getWidth() - width) / 2;</span>
<span class="nc" id="L693">				y = (getHeight() - height) / 2;</span>
<span class="nc" id="L694">				break;</span>
			case CENTERED_LEFT:
<span class="nc" id="L696">				x = (getWidth() - width) / 4;</span>
<span class="nc" id="L697">				y = (getHeight() - height) / 2;</span>
<span class="nc" id="L698">				break;</span>
			case CENTERED_RIGHT:
<span class="nc" id="L700">				x = ((getWidth() - width) * 3) / 4;</span>
<span class="nc" id="L701">				y = (getHeight() - height) / 2;</span>
<span class="nc" id="L702">				break;</span>
			case ORIGIN:
<span class="nc" id="L704">				x = y = 0;</span>
				break;
			}
		}
<span class="nc bnc" id="L708" title="All 8 branches missed.">		if ((p = getClearSpace(x, y, width, height, MAXTRY)) != null &amp;&amp; p.x &gt;= 0 &amp;&amp; p.x &lt; getWidth() &amp;&amp; p.y &gt;= 0</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">				&amp;&amp; p.y &lt; getHeight()) {</span>
<span class="nc" id="L710">			x = p.x;</span>
<span class="nc" id="L711">			y = p.y;</span>
		}
<span class="nc" id="L713">		return new Point(x, y);</span>
	}

	/**
	 * Create key bindings for all actions.
	 */
	private void createKeyBindings() {
<span class="nc bnc" id="L720" title="All 2 branches missed.">		for (Option option : freeColClient.getActionManager().getOptions()) {</span>
<span class="nc" id="L721">			FreeColAction action = (FreeColAction) option;</span>
<span class="nc" id="L722">			getInputMap().put(action.getAccelerator(), action.getId());</span>
<span class="nc" id="L723">			getActionMap().put(action.getId(), action);</span>
<span class="nc" id="L724">		}</span>
<span class="nc" id="L725">	}</span>

	/**
	 * Try to find some free space on the canvas for a component, starting at
	 * x,y.
	 *
	 * @param x
	 *            A starting x coordinate.
	 * @param y
	 *            A starting y coordinate.
	 * @param w
	 *            The component width to use.
	 * @param h
	 *            The component height to use.
	 * @param tries
	 *            the tries
	 * @return A &lt;code&gt;Point&lt;/code&gt; to place the component at or null on
	 *         failure.
	 */
	private Point getClearSpace(final int x, final int y, final int w, final int h, int tries) {
<span class="nc" id="L745">		final Rectangle bounds = this.getBounds();</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">		if (!bounds.contains(x, y))</span>
<span class="nc" id="L747">			return null;</span>

<span class="nc" id="L749">		tries = 3 * tries + 1; // 3 new candidates per level</span>
<span class="nc" id="L750">		List&lt;Point&gt; todo = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L751">		Point p = new Point(x, y);</span>
<span class="nc" id="L752">		todo.add(p);</span>

<span class="nc" id="L754">		List&lt;Component&gt; allComponents = Arrays.stream(this.getComponents())</span>
<span class="nc bnc" id="L755" title="All 4 branches missed.">				.filter(c -&gt; !(c instanceof GrayLayer) &amp;&amp; c.isValid()).collect(Collectors.toList());</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">		for (FreeColDialog&lt;?&gt; fcd : dialogs)</span>
<span class="nc" id="L757">			allComponents.add(fcd);</span>

		// Find the position with the least overlap
<span class="nc" id="L760">		int bestScore = Integer.MAX_VALUE;</span>
<span class="nc" id="L761">		Point best = p;</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">		while (!todo.isEmpty()) {</span>
<span class="nc" id="L763">			p = todo.remove(0);</span>
<span class="nc" id="L764">			Rectangle r = new Rectangle(p.x, p.y, w, h);</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">			if (!bounds.contains(r)) {</span>
<span class="nc" id="L766">				continue;</span>
			}

			// Find the most overlapping component at this position,
			// as well as the globally least.
<span class="nc" id="L771">			int foundScore = 0;</span>
<span class="nc" id="L772">			Component found = null;</span>
<span class="nc bnc" id="L773" title="All 2 branches missed.">			for (Component c : allComponents) {</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">				if (c.getBounds().intersects(r)) {</span>
<span class="nc" id="L775">					Rectangle rr = c.getBounds().intersection(r);</span>
<span class="nc" id="L776">					int score = (int) Math.round(rr.getWidth() * rr.getHeight());</span>
<span class="nc bnc" id="L777" title="All 2 branches missed.">					if (foundScore &lt; score) {</span>
<span class="nc" id="L778">						foundScore = score;</span>
<span class="nc" id="L779">						found = c;</span>
					}
				}
<span class="nc" id="L782">			}</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">			if (found == null) { // Can not improve on no overlap, return now</span>
<span class="nc" id="L784">				return p;</span>
			}
<span class="nc bnc" id="L786" title="All 2 branches missed.">			if (bestScore &gt; foundScore) {</span>
<span class="nc" id="L787">				bestScore = foundScore;</span>
<span class="nc" id="L788">				best = p;</span>
			}
			// Guarantee eventual completion
<span class="nc bnc" id="L791" title="All 2 branches missed.">			if (--tries &lt;= 0)</span>
<span class="nc" id="L792">				break;</span>

<span class="nc" id="L794">			int n = todo.size(),</span>
					// Some alternative new positions
					// 0: move right/down to avoid the collision
					// 1: move as far as possible right/down
					// 2: wrap back to the far left
<span class="nc" id="L799">					x0 = found.getX() + found.getWidth() + 1, y0 = found.getY() + found.getHeight() + 1,</span>
<span class="nc" id="L800">					x1 = bounds.x + bounds.width - w - 1, y1 = bounds.y + bounds.height - h - 1, x2 = bounds.x,</span>
<span class="nc" id="L801">					y2 = bounds.y;</span>
<span class="nc" id="L802">			boolean x0ok = bounds.contains(x0 + w, y), y0ok = bounds.contains(x, y0 + h), x1ok = bounds.contains(x1, y),</span>
<span class="nc" id="L803">					y1ok = bounds.contains(x, y1);</span>
<span class="nc bnc" id="L804" title="All 8 branches missed.">			todo.add(n, new Point((x0ok) ? x0 : (x1ok) ? x1 : x2, (y0ok) ? y0 : (y1ok) ? y1 : y2));</span>
<span class="nc bnc" id="L805" title="All 4 branches missed.">			todo.add(n, new Point(x, (y0ok) ? y0 : (y1ok) ? y1 : y2));</span>
<span class="nc bnc" id="L806" title="All 4 branches missed.">			todo.add(n, new Point((x0ok) ? x0 : (x1ok) ? x1 : x2, y));</span>
<span class="nc" id="L807">		}</span>
<span class="nc" id="L808">		return best;</span>
	}

	/**
	 * Gets any currently displayed colony panel for the specified colony.
	 *
	 * This is distinct from {@link #getExistingFreeColPanel} because there can
	 * be multiple ColonyPanels.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to check.
	 * @return A currently displayed colony panel, or null if not found.
	 */
	private ColonyPanel getColonyPanel(Colony colony) {
<span class="nc bnc" id="L822" title="All 2 branches missed.">		for (Component c1 : getComponents()) {</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">			if (c1 instanceof JInternalFrame) {</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">				for (Component c2 : ((JInternalFrame) c1).getContentPane().getComponents()) {</span>
<span class="nc bnc" id="L825" title="All 4 branches missed.">					if (c2 instanceof ColonyPanel &amp;&amp; ((ColonyPanel) c2).getColony() == colony) {</span>
<span class="nc" id="L826">						return (ColonyPanel) c2;</span>
					}
				}
			}
		}
<span class="nc" id="L831">		return null;</span>
	}

	/**
	 * Gets the internal frame for the given component.
	 *
	 * @param c
	 *            The &lt;code&gt;Component&lt;/code&gt;.
	 * @return The given component if this is an internal frame or the first
	 *         parent that is an internal frame. Returns &lt;code&gt;null&lt;/code&gt; if no
	 *         internal frame is found.
	 */
	private JInternalFrame getInternalFrame(final Component c) {
<span class="nc" id="L844">		Component temp = c;</span>

<span class="nc bnc" id="L846" title="All 4 branches missed.">		while (temp != null &amp;&amp; !(temp instanceof JInternalFrame)) {</span>
<span class="nc" id="L847">			temp = temp.getParent();</span>
		}
<span class="nc" id="L849">		return (JInternalFrame) temp;</span>
	}

	/**
	 * Make a tile visible, then determine corresponding position to popup a
	 * panel.
	 *
	 * @param tile
	 *            A &lt;code&gt;Tile&lt;/code&gt; to be made visible.
	 * @return A &lt;code&gt;PopupPosition&lt;/code&gt; for a panel to be displayed.
	 */
	private PopupPosition setOffsetFocus(Tile tile) {
<span class="nc bnc" id="L861" title="All 2 branches missed.">		if (tile == null)</span>
<span class="nc" id="L862">			return PopupPosition.CENTERED;</span>
<span class="nc" id="L863">		int where = mapViewer.setOffsetFocus(tile);</span>
<span class="nc bnc" id="L864" title="All 4 branches missed.">		return (where &gt; 0) ? PopupPosition.CENTERED_LEFT</span>
				: (where &lt; 0) ? PopupPosition.CENTERED_RIGHT : PopupPosition.CENTERED;
	}

	/**
	 * Gets the saved position of a component.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to use.
	 * @return The saved position as a &lt;code&gt;Point&lt;/code&gt;, or null if no saved
	 *         position is found.
	 */
	private Point getSavedPosition(Component comp) {
<span class="nc" id="L877">		final ClientOptions co = freeColClient.getClientOptions();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">		if (co == null)</span>
<span class="nc" id="L879">			return null;</span>
		try {
<span class="nc bnc" id="L881" title="All 2 branches missed.">			if (!co.getBoolean(ClientOptions.REMEMBER_PANEL_POSITIONS)) {</span>
<span class="nc" id="L882">				return null;</span>
			}
<span class="nc" id="L884">		} catch (Exception e) {</span>
<span class="nc" id="L885">		}</span>

<span class="nc" id="L887">		String className = comp.getClass().getName();</span>
		try {
<span class="nc" id="L889">			return new Point(co.getInteger(className + &quot;.x&quot;), co.getInteger(className + &quot;.y&quot;));</span>
<span class="nc" id="L890">		} catch (Exception e) {</span>
<span class="nc" id="L891">			return null;</span>
		}
	}

	/**
	 * Get the saved size of a component.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to use.
	 * @return A &lt;code&gt;Dimension&lt;/code&gt; for the component or null if no saved
	 *         size is found.
	 */
	private Dimension getSavedSize(Component comp) {
<span class="nc" id="L904">		final ClientOptions co = freeColClient.getClientOptions();</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">		if (co == null)</span>
<span class="nc" id="L906">			return null;</span>
		try {
<span class="nc bnc" id="L908" title="All 2 branches missed.">			if (!co.getBoolean(ClientOptions.REMEMBER_PANEL_SIZES)) {</span>
<span class="nc" id="L909">				return null;</span>
			}
<span class="nc" id="L911">		} catch (Exception e) {</span>
<span class="nc" id="L912">		}</span>

<span class="nc" id="L914">		String className = comp.getClass().getName();</span>
		try {
<span class="nc" id="L916">			return new Dimension(co.getInteger(className + &quot;.w&quot;), co.getInteger(className + &quot;.h&quot;));</span>
<span class="nc" id="L917">		} catch (Exception e) {</span>
<span class="nc" id="L918">			return null;</span>
		}
	}

	/**
	 * Initialize the file filters to filter for saved games.
	 *
	 * @return File filters for the FreeCol save game extension.
	 */
	private FileFilter[] getFileFilters() {
<span class="nc bnc" id="L928" title="All 2 branches missed.">		if (fileFilters == null) {</span>
<span class="nc" id="L929">			String s = Messages.message(&quot;filter.savedGames&quot;);</span>
<span class="nc" id="L930">			fileFilters = new FileFilter[] { new FileNameExtensionFilter(s, FreeCol.FREECOL_SAVE_EXTENSION) };</span>
		}
<span class="nc" id="L932">		return fileFilters;</span>
	}

	/**
	 * A component is closing. Some components need position and size to be
	 * saved.
	 *
	 * @param c
	 *            The closing &lt;code&gt;Component&lt;/code&gt;.
	 * @param frame
	 *            The enclosing &lt;code&gt;JInternalFrame&lt;/code&gt;.
	 */
	private void notifyClose(Component c, JInternalFrame frame) {
<span class="nc bnc" id="L945" title="All 2 branches missed.">		if (frame == null)</span>
<span class="nc" id="L946">			return;</span>

<span class="nc bnc" id="L948" title="All 2 branches missed.">		if (c instanceof FreeColPanel) {</span>
<span class="nc" id="L949">			FreeColPanel fcp = (FreeColPanel) c;</span>
<span class="nc" id="L950">			fcp.firePropertyChange(&quot;closing&quot;, false, true);</span>

<span class="nc" id="L952">			savePosition(fcp, frame.getLocation());</span>
<span class="nc" id="L953">			saveSize(fcp, fcp.getSize());</span>
		}
<span class="nc" id="L955">	}</span>

	/**
	 * Remove the panels derived from the EuropePanel.
	 */
	private void removeEuropeanSubpanels() {
		FreeColPanel panel;
<span class="nc bnc" id="L962" title="All 2 branches missed.">		if ((panel = getExistingFreeColPanel(RecruitPanel.class)) != null)</span>
<span class="nc" id="L963">			removeFromCanvas(panel);</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">		if ((panel = getExistingFreeColPanel(PurchasePanel.class)) != null)</span>
<span class="nc" id="L965">			removeFromCanvas(panel);</span>
<span class="nc bnc" id="L966" title="All 2 branches missed.">		if ((panel = getExistingFreeColPanel(TrainPanel.class)) != null)</span>
<span class="nc" id="L967">			removeFromCanvas(panel);</span>
<span class="nc" id="L968">	}</span>

	/**
	 * Save an &lt;code&gt;int&lt;/code&gt; value to the saved ClientOptions, using the name
	 * of the components class plus the given key as and identifier.
	 *
	 * @param className
	 *            The class name for the component.
	 * @param key
	 *            The key to save.
	 * @param value
	 *            The value to save.
	 */
	private void saveInteger(String className, String key, int value) {
<span class="nc bnc" id="L982" title="All 4 branches missed.">		if (freeColClient != null &amp;&amp; freeColClient.getClientOptions() != null) {</span>
<span class="nc" id="L983">			Option o = freeColClient.getClientOptions().getOption(className + key);</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">			if (o == null) {</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">				Specification specification = (freeColClient.getGame() == null) ? null</span>
<span class="nc" id="L986">						: freeColClient.getGame().getSpecification();</span>
<span class="nc" id="L987">				IntegerOption io = new IntegerOption(className + key, specification);</span>
<span class="nc" id="L988">				io.setValue(value);</span>
<span class="nc" id="L989">				freeColClient.getClientOptions().add(io);</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">			} else if (o instanceof IntegerOption) {</span>
<span class="nc" id="L991">				((IntegerOption) o).setValue(value);</span>
			}
		}
<span class="nc" id="L994">	}</span>

	/**
	 * Save the position of a component.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to use.
	 * @param position
	 *            The position to save.
	 */
	private void savePosition(Component comp, Point position) {
		try {
<span class="nc bnc" id="L1006" title="All 2 branches missed.">			if (!freeColClient.getClientOptions().getBoolean(ClientOptions.REMEMBER_PANEL_POSITIONS))</span>
<span class="nc" id="L1007">				return;</span>
<span class="nc" id="L1008">		} catch (Exception e) {</span>
<span class="nc" id="L1009">		}</span>

<span class="nc" id="L1011">		String className = comp.getClass().getName();</span>
<span class="nc" id="L1012">		saveInteger(className, &quot;.x&quot;, position.x);</span>
<span class="nc" id="L1013">		saveInteger(className, &quot;.y&quot;, position.y);</span>
<span class="nc" id="L1014">	}</span>

	/**
	 * Save the size of a component.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to use.
	 * @param size
	 *            The &lt;code&gt;Dimension&lt;/code&gt; to save.
	 */
	private void saveSize(Component comp, Dimension size) {
		try {
<span class="nc bnc" id="L1026" title="All 2 branches missed.">			if (!freeColClient.getClientOptions().getBoolean(ClientOptions.REMEMBER_PANEL_SIZES))</span>
<span class="nc" id="L1027">				return;</span>
<span class="nc" id="L1028">		} catch (Exception e) {</span>
<span class="nc" id="L1029">		}</span>

<span class="nc" id="L1031">		String className = comp.getClass().getName();</span>
<span class="nc" id="L1032">		saveInteger(className, &quot;.w&quot;, size.width);</span>
<span class="nc" id="L1033">		saveInteger(className, &quot;.h&quot;, size.height);</span>
<span class="nc" id="L1034">	}</span>

	/**
	 * Restart blinking on the map. Switching it on again needs to check for the
	 * presence of other dialogs.
	 */
	private void restartBlinking() {
<span class="nc bnc" id="L1041" title="All 2 branches missed.">		if (mapViewer.getViewMode() != GUI.MOVE_UNITS_MODE)</span>
<span class="nc" id="L1042">			return;</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">		for (FreeColDialog&lt;?&gt; f : dialogs) {</span>
<span class="nc bnc" id="L1044" title="All 2 branches missed.">			if (f.isModal())</span>
<span class="nc" id="L1045">				return;</span>
<span class="nc" id="L1046">		}</span>
<span class="nc" id="L1047">		mapViewer.restartBlinking();</span>
<span class="nc" id="L1048">	}</span>

	/**
	 * Stop blinking on the map.
	 */
	private void stopBlinking() {
<span class="nc" id="L1054">		mapViewer.stopBlinking();</span>
<span class="nc" id="L1055">	}</span>

	/**
	 * Displays the given dialog, optionally making sure a tile is visible.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param freeColDialog
	 *            The dialog to be displayed
	 * @param tile
	 *            An optional &lt;code&gt;Tile&lt;/code&gt; to make visible (not under the
	 *            dialog!)
	 * @return The {@link FreeColDialog#getResponse reponse} returned by the
	 *         dialog.
	 */
	private &lt;T&gt; T showFreeColDialog(FreeColDialog&lt;T&gt; freeColDialog, Tile tile) {
<span class="nc" id="L1071">		viewFreeColDialog(freeColDialog, tile);</span>
<span class="nc" id="L1072">		T response = freeColDialog.getResponse();</span>
<span class="nc" id="L1073">		remove(freeColDialog);</span>
<span class="nc" id="L1074">		dialogRemove(freeColDialog);</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">		if (freeColDialog.isModal())</span>
<span class="nc" id="L1076">			restartBlinking();</span>
<span class="nc" id="L1077">		return response;</span>
	}

	/**
	 * Displays the given panel, making sure a tile is visible.
	 *
	 * @param panel
	 *            The panel to be displayed
	 * @param tile
	 *            A &lt;code&gt;Tile&lt;/code&gt; to make visible (not under the panel!)
	 * @param resizable
	 *            Should the panel be resizable?
	 */
	private void showFreeColPanel(FreeColPanel panel, Tile tile, boolean resizable) {
<span class="nc" id="L1091">		showSubPanel(panel, setOffsetFocus(tile), resizable);</span>
<span class="nc" id="L1092">	}</span>

	/**
	 * Displays a &lt;code&gt;FreeColPanel&lt;/code&gt;.
	 *
	 * @param panel
	 *            &lt;code&gt;FreeColPanel&lt;/code&gt;, panel to show
	 * @param resizable
	 *            Should the panel be resizable?
	 */
	private void showSubPanel(FreeColPanel panel, boolean resizable) {
<span class="nc" id="L1103">		showSubPanel(panel, PopupPosition.CENTERED, resizable);</span>
<span class="nc" id="L1104">	}</span>

	/**
	 * Displays a &lt;code&gt;FreeColPanel&lt;/code&gt; at a generalized position.
	 *
	 * @param panel
	 *            &lt;code&gt;FreeColPanel&lt;/code&gt;, panel to show
	 * @param popupPosition
	 *            &lt;code&gt;PopupPosition&lt;/code&gt; The generalized position to place
	 *            the panel.
	 * @param resizable
	 *            Should the panel be resizable?
	 */
	private void showSubPanel(FreeColPanel panel, PopupPosition popupPosition, boolean resizable) {
<span class="nc" id="L1118">		repaint();</span>
<span class="nc" id="L1119">		addAsFrame(panel, false, popupPosition, resizable);</span>
<span class="nc" id="L1120">		panel.requestFocus();</span>
<span class="nc" id="L1121">	}</span>

	// Public API

	/**
	 * Adds a component to this Canvas.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to add.
	 * @return The component argument.
	 */
	@Override
	public Component add(Component comp) {
<span class="nc" id="L1134">		this.add(comp, JLayeredPane.DEFAULT_LAYER);</span>
<span class="nc" id="L1135">		return comp;</span>
	}

	/**
	 * Adds a component to this Canvas.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to add to this canvas.
	 * @param i
	 *            The layer to add the component to (see JLayeredPane).
	 */
	public void add(Component comp, Integer i) {
<span class="nc" id="L1147">		addToCanvas(comp, i);</span>
<span class="nc" id="L1148">		gui.updateMenuBar();</span>
<span class="nc" id="L1149">	}</span>

	/**
	 * Closes all the menus that are currently open.
	 */
	void closeMenus() {
<span class="nc bnc" id="L1155" title="All 2 branches missed.">		for (JInternalFrame frame : getAllFrames()) {</span>
<span class="nc bnc" id="L1156" title="All 2 branches missed.">			for (Component c : frame.getContentPane().getComponents()) {</span>
<span class="nc" id="L1157">				notifyClose(c, frame);</span>
			}
<span class="nc" id="L1159">			frame.dispose();</span>
		}
<span class="nc bnc" id="L1161" title="All 2 branches missed.">		while (!dialogs.isEmpty()) {</span>
<span class="nc" id="L1162">			FreeColDialog&lt;?&gt; dialog = dialogs.remove(0);</span>
<span class="nc" id="L1163">			dialog.dispose();</span>
<span class="nc" id="L1164">		}</span>
<span class="nc" id="L1165">	}</span>

	/**
	 * Closes the {@link MainPanel}.
	 */
	void closeMainPanel() {
<span class="nc bnc" id="L1171" title="All 2 branches missed.">		if (mainPanel != null) {</span>
<span class="nc" id="L1172">			remove(mainPanel);</span>
<span class="nc" id="L1173">			mainPanel = null;</span>
		}
<span class="nc" id="L1175">	}</span>

	/**
	 * Closes the &lt;code&gt;StatusPanel&lt;/code&gt;.
	 *
	 * @see #showStatusPanel
	 */
	void closeStatusPanel() {
<span class="nc bnc" id="L1183" title="All 2 branches missed.">		if (statusPanel.isVisible()) {</span>
<span class="nc" id="L1184">			remove(statusPanel);</span>
		}
<span class="nc" id="L1186">	}</span>

	/**
	 * Checks if this &lt;code&gt;Canvas&lt;/code&gt; contains any in game components.
	 *
	 * @return &lt;code&gt;true&lt;/code&gt; if there is any in game components.
	 */
	boolean containsInGameComponents() {
<span class="nc" id="L1194">		KeyListener[] keyListeners = getKeyListeners();</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">		if (keyListeners.length &gt; 0) {</span>
<span class="nc" id="L1196">			return true;</span>
		}

<span class="nc" id="L1199">		MouseListener[] mouseListeners = getMouseListeners();</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">		if (mouseListeners.length &gt; 0) {</span>
<span class="nc" id="L1201">			return true;</span>
		}

<span class="nc" id="L1204">		MouseMotionListener[] mouseMotionListeners = getMouseMotionListeners();</span>
<span class="nc bnc" id="L1205" title="All 2 branches missed.">		if (mouseMotionListeners.length &gt; 0) {</span>
<span class="nc" id="L1206">			return true;</span>
		}

<span class="nc" id="L1209">		return false;</span>
	}

	/**
	 * Tells that a chat message was received.
	 *
	 * @param message
	 *            The chat message.
	 */
	void displayChatMessage(GUIMessage message) {
<span class="nc" id="L1219">		chatDisplay.addMessage(message);</span>
<span class="nc" id="L1220">		repaint(0, 0, getWidth(), getHeight());</span>
<span class="nc" id="L1221">	}</span>

	/**
	 * Add a dialog to the current dialog list.
	 *
	 * @param fcd
	 *            The dialog to add.
	 */
	private void dialogAdd(FreeColDialog&lt;?&gt; fcd) {
<span class="nc" id="L1230">		dialogs.add(fcd);</span>
<span class="nc" id="L1231">	}</span>

	/**
	 * Remove a dialog from the current dialog list.
	 *
	 * @param fcd
	 *            The dialog to remove.
	 */
	void dialogRemove(FreeColDialog&lt;?&gt; fcd) {
<span class="nc" id="L1240">		dialogs.remove(fcd);</span>
<span class="nc" id="L1241">	}</span>

	/**
	 * Gets a currently displayed FreeColPanel of a given type.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param type
	 *            The type of &lt;code&gt;FreeColPanel&lt;/code&gt; to look for.
	 * @return A currently displayed &lt;code&gt;FreeColPanel&lt;/code&gt; of the requested
	 *         type, or null if none found.
	 */
	private &lt;T extends FreeColPanel&gt; T getExistingFreeColPanel(Class&lt;T&gt; type) {
<span class="nc bnc" id="L1254" title="All 2 branches missed.">		for (Component c1 : getComponents()) {</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">			if (c1 instanceof JInternalFrame) {</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">				for (Component c2 : ((JInternalFrame) c1).getContentPane().getComponents()) {</span>
					try {
<span class="nc" id="L1258">						T ret = type.cast(c2);</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">						if (ret != null) {</span>
<span class="nc" id="L1260">							final JInternalFrame jif = (JInternalFrame) c1;</span>
<span class="nc" id="L1261">							SwingUtilities.invokeLater(() -&gt; {</span>
<span class="nc" id="L1262">								jif.toFront();</span>
<span class="nc" id="L1263">								jif.repaint();</span>
<span class="nc" id="L1264">							});</span>
<span class="nc" id="L1265">							return ret;</span>
						}
<span class="nc" id="L1267">					} catch (ClassCastException cce) {</span>
<span class="nc" id="L1268">					}</span>
				}
			}
		}
<span class="nc" id="L1272">		return null;</span>
	}

	/**
	 * Gets the last &lt;code&gt;LoadingSavegameDialog&lt;/code&gt;.
	 *
	 * FIXME: clean this up
	 *
	 * @return The &lt;code&gt;LoadingSavegameDialog&lt;/code&gt;.
	 */
	LoadingSavegameDialog getLoadingSavegameDialog() {
<span class="nc" id="L1283">		return loadingSavegameDialog;</span>
	}

	/**
	 * Get any panel this &lt;code&gt;Canvas&lt;/code&gt; is displaying.
	 *
	 * @return A &lt;code&gt;Component&lt;/code&gt; the &lt;code&gt;Canvas&lt;/code&gt; is displaying,
	 *         or null if none found.
	 */
	Component getShowingSubPanel() {
<span class="nc bnc" id="L1293" title="All 2 branches missed.">		for (Component c : getComponents()) {</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">			if (c instanceof ToolBoxFrame) {</span>
<span class="nc" id="L1295">				continue;</span>
			}
<span class="nc bnc" id="L1297" title="All 2 branches missed.">			if (c instanceof JInternalFrame) {</span>
<span class="nc" id="L1298">				return c;</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">			} else if (c instanceof JInternalFrame.JDesktopIcon) {</span>
<span class="nc" id="L1300">				return c;</span>
			}
		}
<span class="nc" id="L1303">		return null;</span>
	}

	/**
	 * Checks if a client options dialog is present.
	 *
	 * @return True if the client options are showing.
	 */
	boolean isClientOptionsDialogShowing() {
<span class="nc" id="L1312">		return clientOptionsDialogShowing;</span>
	}

	/**
	 * Checks if mapboard actions should be enabled.
	 *
	 * @return &lt;code&gt;true&lt;/code&gt; if no internal frames are open.
	 */
	boolean isMapboardActionsEnabled() {
<span class="nc bnc" id="L1321" title="All 2 branches missed.">		return !isShowingSubPanel();</span>
	}

	/**
	 * Checks if this &lt;code&gt;Canvas&lt;/code&gt; displaying another panel.
	 * &lt;p&gt;
	 * Note that the previous implementation could throw exceptions in some
	 * cases, thus the change.
	 *
	 * @return &lt;code&gt;true&lt;/code&gt; if the &lt;code&gt;Canvas&lt;/code&gt; is displaying an
	 *         internal frame.
	 */
	boolean isShowingSubPanel() {
<span class="nc bnc" id="L1334" title="All 2 branches missed.">		return getShowingSubPanel() != null;</span>
	}

	/**
	 * Refresh this canvas.
	 */
	void refresh() {
<span class="nc" id="L1341">		repaint(0, 0, getWidth(), getHeight());</span>
<span class="nc" id="L1342">	}</span>

	/**
	 * Removes the given component from this canvas.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to remove.
	 */
	public void removeFromCanvas(Component comp) {
<span class="nc bnc" id="L1351" title="All 2 branches missed.">		if (comp == null)</span>
<span class="nc" id="L1352">			return;</span>

<span class="nc" id="L1354">		final Rectangle updateBounds = comp.getBounds();</span>
<span class="nc" id="L1355">		final JInternalFrame frame = getInternalFrame(comp);</span>
<span class="nc" id="L1356">		notifyClose(comp, frame);</span>
<span class="nc bnc" id="L1357" title="All 4 branches missed.">		if (frame != null &amp;&amp; frame != comp) {</span>
<span class="nc" id="L1358">			frame.dispose();</span>
		} else {
			// Java 1.7.0 as seen on Fedora with:
			// Java version: 1.7.0_40
			// Java WM version: 24.0-b56
			// crashes here deep in the java libraries.
			try {
<span class="nc" id="L1365">				super.remove(comp);</span>
<span class="nc" id="L1366">			} catch (Exception e) {</span>
<span class="nc" id="L1367">				logger.log(Level.WARNING, &quot;Java crash&quot;, e);</span>
<span class="nc" id="L1368">			}</span>
		}
<span class="nc" id="L1370">		repaint(updateBounds.x, updateBounds.y, updateBounds.width, updateBounds.height);</span>
<span class="nc" id="L1371">	}</span>

	/**
	 * Removes components that is only used when in game.
	 */
	void removeInGameComponents() {
		// remove listeners, they will be added when launching the new game...
<span class="nc" id="L1378">		KeyListener[] keyListeners = getKeyListeners();</span>
<span class="nc bnc" id="L1379" title="All 2 branches missed.">		for (KeyListener keyListener : keyListeners) {</span>
<span class="nc" id="L1380">			removeKeyListener(keyListener);</span>
		}

<span class="nc" id="L1383">		MouseListener[] mouseListeners = getMouseListeners();</span>
<span class="nc bnc" id="L1384" title="All 2 branches missed.">		for (MouseListener mouseListener : mouseListeners) {</span>
<span class="nc" id="L1385">			removeMouseListener(mouseListener);</span>
		}

<span class="nc" id="L1388">		MouseMotionListener[] mouseMotionListeners = getMouseMotionListeners();</span>
<span class="nc bnc" id="L1389" title="All 2 branches missed.">		for (MouseMotionListener mouseMotionListener : mouseMotionListeners) {</span>
<span class="nc" id="L1390">			removeMouseMotionListener(mouseMotionListener);</span>
		}

<span class="nc bnc" id="L1393" title="All 2 branches missed.">		for (Component c : getComponents()) {</span>
<span class="nc" id="L1394">			removeFromCanvas(c);</span>
		}
<span class="nc" id="L1396">	}</span>

	/**
	 * Set preferred size to saved size, or to the given &lt;code&gt;Dimension&lt;/code&gt;
	 * if no saved size was found. Call this method in the constructor of a
	 * FreeColPanel in order to remember its size and position.
	 *
	 * @param comp
	 *            The &lt;code&gt;Component&lt;/code&gt; to use.
	 * @param d
	 *            The &lt;code&gt;Dimension&lt;/code&gt; to use as default.
	 */
	void restoreSavedSize(Component comp, Dimension d) {
<span class="nc" id="L1409">		final Dimension pref = comp.getPreferredSize();</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">		final Dimension sugg = (d == null) ? pref : d;</span>
<span class="nc" id="L1411">		boolean save = false;</span>

<span class="nc" id="L1413">		Dimension size = getSavedSize(comp);</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">		if (size == null) {</span>
<span class="nc" id="L1415">			size = new Dimension(pref);</span>
<span class="nc" id="L1416">			save = true;</span>
		}

		// Fix up broken/outdated saved sizes
<span class="nc bnc" id="L1420" title="All 2 branches missed.">		if (size.width &lt; sugg.width) {</span>
<span class="nc" id="L1421">			size.width = sugg.width;</span>
<span class="nc" id="L1422">			save = true;</span>
		}
<span class="nc bnc" id="L1424" title="All 2 branches missed.">		if (size.height &lt; sugg.height) {</span>
<span class="nc" id="L1425">			size.height = sugg.height;</span>
<span class="nc" id="L1426">			save = true;</span>
		}
<span class="nc bnc" id="L1428" title="All 2 branches missed.">		if (size.width &lt; pref.width) {</span>
<span class="nc" id="L1429">			size.width = pref.width;</span>
<span class="nc" id="L1430">			save = true;</span>
		}
<span class="nc bnc" id="L1432" title="All 2 branches missed.">		if (size.height &lt; pref.height) {</span>
<span class="nc" id="L1433">			size.height = pref.height;</span>
<span class="nc" id="L1434">			save = true;</span>
		}

<span class="nc bnc" id="L1437" title="All 2 branches missed.">		if (save) {</span>
<span class="nc" id="L1438">			saveSize(comp, size);</span>
		}

<span class="nc bnc" id="L1441" title="All 2 branches missed.">		if (!pref.equals(size)) {</span>
<span class="nc" id="L1442">			comp.setPreferredSize(size);</span>
		}
<span class="nc" id="L1444">	}</span>

	/**
	 * Closes all panels, changes the background and shows the main menu.
	 */
	void returnToTitle() {
		// FIXME: check if the GUI object knows that we're not
		// inGame. (Retrieve value of GUI::inGame.) If GUI thinks
		// we're still in the game then log an error because at this
		// point the GUI should have been informed.
<span class="nc" id="L1454">		removeInGameComponents();</span>
<span class="nc" id="L1455">		showMainPanel(null);</span>
<span class="nc" id="L1456">		repaint();</span>
<span class="nc" id="L1457">	}</span>

	/**
	 * Setup mouse listeners.
	 */
	void setupMouseListeners() {
<span class="nc" id="L1463">		addMouseListener(new CanvasMouseListener(freeColClient, this));</span>
<span class="nc" id="L1464">		addMouseMotionListener(new CanvasMouseMotionListener(freeColClient, this));</span>
<span class="nc" id="L1465">	}</span>

	/**
	 * Updates the sizes of the components on this Canvas.
	 */
	private void updateSizes() {
<span class="nc bnc" id="L1471" title="All 6 branches missed.">		if (oldSize == null || oldSize.width != getWidth() || oldSize.height != getHeight()) {</span>
<span class="nc" id="L1472">			gui.updateMapControlsInCanvas();</span>
<span class="nc" id="L1473">			mapViewer.setSize(getSize());</span>
<span class="nc" id="L1474">			mapViewer.forceReposition();</span>
<span class="nc" id="L1475">			oldSize = getSize();</span>
		}
<span class="nc" id="L1477">	}</span>

	// Override JComponent

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void paintComponent(Graphics g) {
<span class="nc" id="L1486">		updateSizes();</span>
<span class="nc" id="L1487">		Graphics2D g2d = (Graphics2D) g;</span>
<span class="nc" id="L1488">		chatDisplay.removeOldMessages();</span>

<span class="nc" id="L1490">		Dimension size = getSize();</span>
<span class="nc bnc" id="L1491" title="All 4 branches missed.">		if ((freeColClient.getGame() != null) &amp;&amp; (freeColClient.getGame().getMap() != null)</span>
<span class="nc bnc" id="L1492" title="All 4 branches missed.">				&amp;&amp; (mapViewer.getFocus() != null) &amp;&amp; freeColClient.isInGame()) {</span>
			/* ingame view */

			// paint map
<span class="nc" id="L1496">			mapViewer.displayMap(g2d);</span>

			// Grey out the map if it is not my turn (and a multiplayer game).
<span class="nc bnc" id="L1499" title="All 4 branches missed.">			if (!freeColClient.isMapEditor() &amp;&amp; freeColClient.getGame() != null</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">					&amp;&amp; !freeColClient.currentPlayerIsMyPlayer()) {</span>
<span class="nc bnc" id="L1501" title="All 2 branches missed.">				if (greyLayer == null) {</span>
<span class="nc" id="L1502">					greyLayer = new GrayLayer(freeColClient);</span>
				}
<span class="nc bnc" id="L1504" title="All 2 branches missed.">				if (greyLayer.getParent() == null) {</span>
<span class="nc" id="L1505">					add(greyLayer, JLayeredPane.DRAG_LAYER);</span>
				}
<span class="nc" id="L1507">				greyLayer.setBounds(0, 0, size.width, size.height);</span>
<span class="nc" id="L1508">				greyLayer.setPlayer(freeColClient.getGame().getCurrentPlayer());</span>
			} else {
<span class="nc bnc" id="L1510" title="All 4 branches missed.">				if (greyLayer != null &amp;&amp; greyLayer.getParent() != null) {</span>
<span class="nc" id="L1511">					removeFromCanvas(greyLayer);</span>
				}
			}

			// paint chat display
<span class="nc" id="L1516">			chatDisplay.display(g2d, mapViewer.getImageLibrary(), size);</span>

		} else {
<span class="nc bnc" id="L1519" title="All 2 branches missed.">			if (!freeColClient.isMapEditor()) {</span>
				/* main menu */
				// TODO: Check if its right to sometimes have an unfocused map
				// ingame and end up here after clicking outside map.

<span class="nc" id="L1524">				final String bgImageKey = &quot;image.flavor.Canvas.map&quot;;</span>
<span class="nc bnc" id="L1525" title="All 2 branches missed.">				if (ResourceManager.hasImageResource(bgImageKey)) {</span>
					// Get the background without scaling, to avoid wasting
					// memory needlessly keeping an unbounded number of rescaled
					// versions of the largest image in FreeCol, forever.
<span class="nc" id="L1529">					final Image bgImage = ResourceManager.getImage(bgImageKey);</span>
					// Draw background image with scaling.
<span class="nc" id="L1531">					g2d.setRenderingHint(RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR);</span>
<span class="nc" id="L1532">					g2d.drawImage(bgImage, 0, 0, size.width, size.height, this);</span>
<span class="nc" id="L1533">					String versionStr = &quot;v. &quot; + FreeCol.getVersion();</span>
<span class="nc" id="L1534">					Font oldFont = g2d.getFont();</span>
<span class="nc" id="L1535">					Color oldColor = g2d.getColor();</span>
<span class="nc" id="L1536">					Font newFont = oldFont.deriveFont(Font.BOLD);</span>
<span class="nc" id="L1537">					TextLayout layout = new TextLayout(versionStr, newFont, g2d.getFontRenderContext());</span>
<span class="nc" id="L1538">					Rectangle2D bounds = layout.getBounds();</span>
<span class="nc" id="L1539">					float x = size.width - (float) bounds.getWidth() - 5;</span>
<span class="nc" id="L1540">					float y = size.height - (float) bounds.getHeight();</span>
<span class="nc" id="L1541">					g2d.setColor(Color.white);</span>
<span class="nc" id="L1542">					layout.draw(g2d, x, y);</span>
<span class="nc" id="L1543">					g2d.setFont(oldFont);</span>
<span class="nc" id="L1544">					g2d.setColor(oldColor);</span>
<span class="nc" id="L1545">				} else {</span>
<span class="nc" id="L1546">					g2d.setColor(Color.BLACK);</span>
<span class="nc" id="L1547">					g2d.fillRect(0, 0, size.width, size.height);</span>
				}

<span class="nc" id="L1550">			} else {</span>
				/* map editor??? */
<span class="nc" id="L1552">				g2d.setColor(Color.BLACK);</span>
<span class="nc" id="L1553">				g2d.fillRect(0, 0, size.width, size.height);</span>
			}
		}
<span class="nc" id="L1556">	}</span>

	// Override Container

	/**
	 * {@inheritDoc}
	 */
	@Override
	public void remove(Component comp) {
<span class="nc" id="L1565">		removeFromCanvas(comp);</span>
<span class="nc" id="L1566">		gui.updateMenuBar();</span>
<span class="nc bnc" id="L1567" title="All 4 branches missed.">		if (comp != statusPanel &amp;&amp; !isShowingSubPanel()) {</span>
<span class="nc" id="L1568">			requestFocus();</span>
		}
<span class="nc" id="L1570">	}</span>

	// Special handling for the startGamePanel.

	/**
	 * Refresh the player's table (called when a new player is added from
	 * PreGameInputHandler.addPlayer).
	 */
	void refreshPlayersTable() {
<span class="nc" id="L1579">		startGamePanel.refreshPlayersTable();</span>
<span class="nc" id="L1580">	}</span>

	/**
	 * Update the game options in the start panel.
	 */
	void updateGameOptions() {
<span class="nc" id="L1586">		startGamePanel.updateGameOptions();</span>
<span class="nc" id="L1587">	}</span>

	/**
	 * Update the map generator options in the start panel.
	 */
	void updateMapGeneratorOptions() {
<span class="nc" id="L1593">		startGamePanel.updateMapGeneratorOptions();</span>
<span class="nc" id="L1594">	}</span>

	// Dialog display

	/**
	 * Displays a modal dialog with text and a choice of options.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param tile
	 *            An optional &lt;code&gt;Tile&lt;/code&gt; to make visible (not under the
	 *            dialog!)
	 * @param obj
	 *            An object that explains the choice for the user.
	 * @param icon
	 *            An optional icon to display.
	 * @param cancelKey
	 *            Key for the text of the optional cancel button.
	 * @param choices
	 *            The &lt;code&gt;List&lt;/code&gt; containing the ChoiceItems to create
	 *            buttons for.
	 * @return The corresponding member of the values array to the selected
	 *         option.
	 */
	&lt;T&gt; T showChoiceDialog(Tile tile, Object obj, ImageIcon icon, String cancelKey, List&lt;ChoiceItem&lt;T&gt;&gt; choices) {
<span class="nc" id="L1619">		FreeColChoiceDialog&lt;T&gt; fcd = new FreeColChoiceDialog&lt;&gt;(freeColClient, frame, true, obj, icon, cancelKey,</span>
				choices);
<span class="nc" id="L1621">		return showFreeColDialog(fcd, tile);</span>
	}

	/**
	 * Displays a modal dialog with a text and a ok/cancel option.
	 *
	 * @param tile
	 *            An optional &lt;code&gt;Tile&lt;/code&gt; to make visible (not under the
	 *            dialog!)
	 * @param obj
	 *            An object that explains the choice for the user.
	 * @param icon
	 *            An optional icon to display.
	 * @param okKey
	 *            The text displayed on the &quot;ok&quot;-button.
	 * @param cancelKey
	 *            The text displayed on the &quot;cancel&quot;-button.
	 * @return True if the user clicked the &quot;ok&quot;-button.
	 */
	boolean showConfirmDialog(Tile tile, Object obj, ImageIcon icon, String okKey, String cancelKey) {
<span class="nc" id="L1641">		FreeColConfirmDialog fcd = new FreeColConfirmDialog(freeColClient, frame, true, obj, icon, okKey, cancelKey);</span>
<span class="nc" id="L1642">		return showFreeColDialog(fcd, tile);</span>
	}

	/**
	 * Displays a modal dialog with a text field and a ok/cancel option.
	 *
	 * @param tile
	 *            An optional tile to make visible (not under the dialog).
	 * @param template
	 *            A &lt;code&gt;StringTemplate&lt;/code&gt; that explains the action to the
	 *            user.
	 * @param defaultValue
	 *            The default value appearing in the text field.
	 * @param okKey
	 *            A key displayed on the &quot;ok&quot;-button.
	 * @param cancelKey
	 *            A key displayed on the optional &quot;cancel&quot;-button.
	 * @return The text the user entered, or null if cancelled.
	 */
	String showInputDialog(Tile tile, StringTemplate template, String defaultValue, String okKey, String cancelKey) {
<span class="nc" id="L1662">		FreeColStringInputDialog fcd = new FreeColStringInputDialog(freeColClient, frame, true,</span>
<span class="nc" id="L1663">				Messages.message(template), defaultValue, okKey, cancelKey);</span>
<span class="nc" id="L1664">		return showFreeColDialog(fcd, tile);</span>
	}

	/**
	 * Displays the given dialog, optionally making sure a tile is visible.
	 *
	 * @param &lt;T&gt;
	 *            the generic type
	 * @param freeColDialog
	 *            The dialog to be displayed
	 * @param tile
	 *            An optional &lt;code&gt;Tile&lt;/code&gt; to make visible (not under the
	 *            dialog!)
	 */
	private &lt;T&gt; void viewFreeColDialog(final FreeColDialog&lt;T&gt; freeColDialog, Tile tile) {
<span class="nc" id="L1679">		PopupPosition pp = setOffsetFocus(tile);</span>

		// TODO: Remove compatibility code when all non-modal dialogs
		// have been converted into panels.
<span class="nc bnc" id="L1683" title="All 2 branches missed.">		if (!freeColDialog.isModal()) {</span>
<span class="nc" id="L1684">			int canvasWidth = getWidth();</span>
<span class="nc" id="L1685">			int dialogWidth = freeColDialog.getWidth();</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">			if (dialogWidth * 2 &lt;= canvasWidth) {</span>
<span class="nc" id="L1687">				Point location = freeColDialog.getLocation();</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">				if (pp == PopupPosition.CENTERED_LEFT) {</span>
<span class="nc" id="L1689">					freeColDialog.setLocation(location.x - canvasWidth / 4, location.y);</span>
<span class="nc bnc" id="L1690" title="All 2 branches missed.">				} else if (pp == PopupPosition.CENTERED_RIGHT) {</span>
<span class="nc" id="L1691">					freeColDialog.setLocation(location.x + canvasWidth / 4, location.y);</span>
				}
			}
		}

<span class="nc" id="L1696">		dialogAdd(freeColDialog);</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">		if (freeColDialog.isModal())</span>
<span class="nc" id="L1698">			stopBlinking();</span>
<span class="nc" id="L1699">		freeColDialog.requestFocus();</span>
<span class="nc" id="L1700">		freeColDialog.setVisible(true);</span>
<span class="nc" id="L1701">	}</span>

	// Simple front ends to display each panel or dialog.

	/**
	 * Removes the trade route panel.
	 *
	 * @param panel
	 *            the panel
	 */
	void removeTradeRoutePanel(TradeRoutePanel panel) {
<span class="nc" id="L1712">		remove(panel);</span>
<span class="nc" id="L1713">		TradeRouteInputPanel trip = getExistingFreeColPanel(TradeRouteInputPanel.class);</span>
<span class="nc bnc" id="L1714" title="All 2 branches missed.">		if (trip != null)</span>
<span class="nc" id="L1715">			trip.cancelTradeRoute();</span>
<span class="nc" id="L1716">	}</span>

	/**
	 * Display the AboutPanel.
	 */
	void showAboutPanel() {
<span class="nc" id="L1722">		showSubPanel(new AboutPanel(freeColClient), false);</span>
<span class="nc" id="L1723">	}</span>

	/**
	 * Show the BuildQueuePanel for a given colony.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to show the build queue of.
	 */
	void showBuildQueuePanel(Colony colony) {
<span class="nc" id="L1732">		BuildQueuePanel panel = getExistingFreeColPanel(BuildQueuePanel.class);</span>
<span class="nc bnc" id="L1733" title="All 4 branches missed.">		if (panel == null || panel.getColony() != colony) {</span>
<span class="nc" id="L1734">			showSubPanel(new BuildQueuePanel(freeColClient, colony), true);</span>
		}
<span class="nc" id="L1736">	}</span>

	/**
	 * Show a build queue panel, with a special callback when it is closed.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to show the build queue of.
	 * @param callBack
	 *            The &lt;code&gt;Runnable&lt;/code&gt; that is run when the panel closes.
	 */
	void showBuildQueuePanel(Colony colony, Runnable callBack) {
<span class="nc" id="L1747">		FreeColPanel panel = new BuildQueuePanel(freeColClient, colony);</span>
<span class="nc" id="L1748">		panel.addClosingCallback(callBack);</span>
<span class="nc" id="L1749">		showSubPanel(panel, true);</span>
<span class="nc" id="L1750">	}</span>

	/**
	 * Display the &lt;code&gt;CaptureGoodsDialog&lt;/code&gt;.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; capturing goods.
	 * @param gl
	 *            The list of &lt;code&gt;Goods&lt;/code&gt; to choose from.
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showCaptureGoodsDialog(Unit unit, List&lt;Goods&gt; gl, DialogHandler&lt;List&lt;Goods&gt;&gt; handler) {
<span class="nc" id="L1763">		SwingUtilities.invokeLater(</span>
				new DialogCallback&lt;&gt;(new CaptureGoodsDialog(freeColClient, frame, unit, gl), null, handler));
<span class="nc" id="L1765">	}</span>

	/**
	 * Displays the &lt;code&gt;ChatPanel&lt;/code&gt;.
	 *
	 * @see ChatPanel
	 */
	void showChatPanel() {
		// FIXME: does it have state, or can we create a new one?
<span class="nc bnc" id="L1774" title="All 2 branches missed.">		if (freeColClient.isSinglePlayer())</span>
<span class="nc" id="L1775">			return; // chat with who?</span>
<span class="nc" id="L1776">		showSubPanel(chatPanel, true);</span>
<span class="nc" id="L1777">	}</span>

	/**
	 * Displays the &lt;code&gt;ChooseFoundingFatherDialog&lt;/code&gt;.
	 *
	 * @param ffs
	 *            The &lt;code&gt;FoundingFather&lt;/code&gt;s to choose from.
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showChooseFoundingFatherDialog(List&lt;FoundingFather&gt; ffs, DialogHandler&lt;FoundingFather&gt; handler) {
<span class="nc" id="L1788">		SwingUtilities.invokeLater(</span>
				new DialogCallback&lt;&gt;(new ChooseFoundingFatherDialog(freeColClient, frame, ffs), null, handler));
<span class="nc" id="L1790">	}</span>

	/**
	 * Displays a dialog for setting client options.
	 *
	 * @return The modified &lt;code&gt;OptionGroup&lt;/code&gt;, or null if not modified.
	 */
	OptionGroup showClientOptionsDialog() {
<span class="nc" id="L1798">		ClientOptionsDialog dialog = new ClientOptionsDialog(freeColClient, frame);</span>
<span class="nc" id="L1799">		OptionGroup group = null;</span>
<span class="nc" id="L1800">		clientOptionsDialogShowing = true;</span>
		try {
<span class="nc" id="L1802">			group = showFreeColDialog(dialog, null);</span>
		} finally {
<span class="nc" id="L1804">			clientOptionsDialogShowing = false;</span>
<span class="nc" id="L1805">		}</span>
<span class="nc" id="L1806">		return group;</span>
	}

	/**
	 * Displays the colony panel of the given &lt;code&gt;Colony&lt;/code&gt;. Defends
	 * against duplicates as this can duplicate messages generated by multiple
	 * property change listeners registered against the same colony.
	 *
	 * @param colony
	 *            The colony whose panel needs to be displayed.
	 * @param unit
	 *            An optional &lt;code&gt;Unit&lt;/code&gt; to select within the panel.
	 * @return The colony panel.
	 * @see ColonyPanel
	 */
	public ColonyPanel showColonyPanel(Colony colony, Unit unit) {
<span class="nc" id="L1822">		ColonyPanel panel = getColonyPanel(colony);</span>
<span class="nc bnc" id="L1823" title="All 2 branches missed.">		if (panel == null) {</span>
<span class="nc" id="L1824">			panel = new ColonyPanel(freeColClient, colony);</span>
<span class="nc" id="L1825">			showFreeColPanel(panel, colony.getTile(), true);</span>
		} else {
<span class="nc" id="L1827">			panel.requestFocus();</span>
		}
<span class="nc bnc" id="L1829" title="All 2 branches missed.">		if (unit != null)</span>
<span class="nc" id="L1830">			panel.setSelectedUnit(unit);</span>
<span class="nc" id="L1831">		return panel;</span>
	}

	/**
	 * Show the colopedia entry for a given node.
	 *
	 * @param nodeId
	 *            The node identifier to display.
	 */
	void showColopediaPanel(String nodeId) {
<span class="nc" id="L1841">		showSubPanel(new ColopediaPanel(freeColClient, nodeId), true);</span>
<span class="nc" id="L1842">	}</span>

	/**
	 * Show a &lt;code&gt;ColorChooserPanel&lt;/code&gt;.
	 *
	 * @param al
	 *            An &lt;code&gt;ActionListener&lt;/code&gt; to handle panel button presses.
	 * @return The &lt;code&gt;ColorChooserPanel&lt;/code&gt; created.
	 */
	ColorChooserPanel showColorChooserPanel(ActionListener al) {
<span class="nc" id="L1852">		ColorChooserPanel ccp = new ColorChooserPanel(freeColClient, al);</span>
<span class="nc" id="L1853">		showFreeColPanel(ccp, null, false);</span>
<span class="nc" id="L1854">		return ccp;</span>
	}

	/**
	 * Show the compact labour report.
	 */
	void showCompactLabourReport() {
<span class="nc" id="L1861">		CompactLabourReport details = new CompactLabourReport(freeColClient);</span>
<span class="nc" id="L1862">		details.initialize();</span>
<span class="nc" id="L1863">		showSubPanel(details, false);</span>

<span class="nc" id="L1865">	}</span>

	/**
	 * Show the compat labour report for the specified unit data.
	 *
	 * @param unitData
	 *            The &lt;code&gt;UnitData&lt;/code&gt; to display.
	 */
	void showCompactLabourReport(UnitData unitData) {
<span class="nc" id="L1874">		CompactLabourReport details = new CompactLabourReport(freeColClient, unitData);</span>
<span class="nc" id="L1875">		details.initialize();</span>
<span class="nc" id="L1876">		showSubPanel(details, false);</span>
<span class="nc" id="L1877">	}</span>

	/**
	 * Display a dialog to confirm a declaration of independence.
	 *
	 * @return A list of names for a new nation.
	 */
	List&lt;String&gt; showConfirmDeclarationDialog() {
<span class="nc" id="L1885">		return showFreeColDialog(new ConfirmDeclarationDialog(freeColClient, frame), null);</span>
	}

	/**
	 * Display a panel showing the declaration of independence with animated
	 * signature.
	 */
	void showDeclarationPanel() {
<span class="nc" id="L1893">		showSubPanel(new DeclarationPanel(freeColClient), PopupPosition.CENTERED, false);</span>
<span class="nc" id="L1894">	}</span>

	/**
	 * Display the difficulty dialog for a given group.
	 *
	 * @param spec
	 *            The enclosing &lt;code&gt;Specification&lt;/code&gt;.
	 * @param group
	 *            The &lt;code&gt;OptionGroup&lt;/code&gt; containing the difficulty.
	 * @param editable
	 *            If the options should be editable.
	 * @return The resulting &lt;code&gt;OptionGroup&lt;/code&gt;.
	 */
	OptionGroup showDifficultyDialog(Specification spec, OptionGroup group, boolean editable) {
<span class="nc" id="L1908">		return showFreeColDialog(new DifficultyDialog(freeColClient, frame, spec, group, editable), null);</span>
	}

	/**
	 * Displays the &lt;code&gt;DumpCargoDialog&lt;/code&gt;.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is dumping.
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showDumpCargoDialog(Unit unit, DialogHandler&lt;List&lt;Goods&gt;&gt; handler) {
<span class="nc" id="L1920">		SwingUtilities.invokeLater(</span>
<span class="nc" id="L1921">				new DialogCallback&lt;&gt;(new DumpCargoDialog(freeColClient, frame, unit), unit.getTile(), handler));</span>
<span class="nc" id="L1922">	}</span>

	/**
	 * Display the EditOptionDialog.
	 *
	 * @param option
	 *            The &lt;code&gt;Option&lt;/code&gt; to edit.
	 * @return The response returned by the dialog.
	 */
	boolean showEditOptionDialog(Option option) {
<span class="nc" id="L1932">		return showFreeColDialog(new EditOptionDialog(freeColClient, frame, option), null);</span>
	}

	/**
	 * Display the EditSettlementDialog.
	 *
	 * @param settlement
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; to edit.
	 */
	void showEditSettlementDialog(IndianSettlement settlement) {
<span class="nc" id="L1942">		showFreeColDialog(new EditSettlementDialog(freeColClient, frame, settlement), null);</span>
<span class="nc" id="L1943">	}</span>

	/**
	 * Shows the panel that allows the user to choose which unit will emigrate
	 * from Europe.
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; whose unit is emigrating.
	 * @param fountainOfYouth
	 *            Is this dialog displayed as a result of a fountain of youth.
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showEmigrationDialog(Player player, boolean fountainOfYouth, DialogHandler&lt;Integer&gt; handler) {
<span class="nc" id="L1957">		SwingUtilities.invokeLater(new DialogCallback&lt;&gt;(</span>
<span class="nc" id="L1958">				new EmigrationDialog(freeColClient, frame, player.getEurope(), fountainOfYouth), null, handler));</span>
<span class="nc" id="L1959">	}</span>

	/**
	 * Display the EndTurnDialog with given units that could still move.
	 *
	 * @param units
	 *            A list of &lt;code&gt;Unit&lt;/code&gt;s that could still move.
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showEndTurnDialog(List&lt;Unit&gt; units, DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L1970">		SwingUtilities.invokeLater(new DialogCallback&lt;&gt;(new EndTurnDialog(freeColClient, frame, units), null, handler));</span>
<span class="nc" id="L1971">	}</span>

	/**
	 * Displays an error message.
	 *
	 * @param messageId
	 *            The i18n-keyname of the error message to display.
	 */
	void showErrorMessage(String messageId) {
<span class="nc" id="L1980">		showErrorMessage(messageId, &quot;Unspecified error: &quot; + messageId);</span>
<span class="nc" id="L1981">	}</span>

	/**
	 * Displays an error message.
	 *
	 * @param messageId
	 *            The i18n-keyname of the error message to display.
	 * @param message
	 *            An alternative (possibly non-i18n) message to display if the
	 *            resource specified by &lt;code&gt;messageId&lt;/code&gt; is unavailable.
	 */
	void showErrorMessage(String messageId, String message) {
<span class="nc" id="L1993">		String display = null;</span>
<span class="nc bnc" id="L1994" title="All 2 branches missed.">		if (messageId != null) {</span>
<span class="nc" id="L1995">			display = Messages.message(messageId);</span>
		}
<span class="nc bnc" id="L1997" title="All 4 branches missed.">		if (display == null || display.isEmpty())</span>
<span class="nc" id="L1998">			display = message;</span>
<span class="nc" id="L1999">		ErrorPanel errorPanel = new ErrorPanel(freeColClient, display);</span>
<span class="nc" id="L2000">		showSubPanel(errorPanel, true);</span>
<span class="nc" id="L2001">	}</span>

	/**
	 * Displays the &lt;code&gt;EuropePanel&lt;/code&gt;.
	 *
	 * @see EuropePanel
	 */
	void showEuropePanel() {
<span class="nc bnc" id="L2009" title="All 2 branches missed.">		if (freeColClient.getGame() == null)</span>
<span class="nc" id="L2010">			return;</span>
<span class="nc" id="L2011">		EuropePanel panel = getExistingFreeColPanel(EuropePanel.class);</span>
<span class="nc bnc" id="L2012" title="All 2 branches missed.">		if (panel == null) {</span>
<span class="nc bnc" id="L2013" title="All 2 branches missed.">			panel = new EuropePanel(freeColClient, (getHeight() &gt; 780));</span>
<span class="nc" id="L2014">			panel.addClosingCallback(() -&gt; {</span>
<span class="nc" id="L2015">				removeEuropeanSubpanels();</span>
<span class="nc" id="L2016">			});</span>
<span class="nc" id="L2017">			showSubPanel(panel, true);</span>
		}
<span class="nc" id="L2019">	}</span>

	/**
	 * Display an event panel.
	 *
	 * @param header
	 *            The title.
	 * @param image
	 *            A resource key for the image to display.
	 * @param footer
	 *            Optional footer text.
	 */
	void showEventPanel(String header, String image, String footer) {
<span class="nc" id="L2032">		showSubPanel(new EventPanel(freeColClient, header, image, footer), PopupPosition.CENTERED, false);</span>
<span class="nc" id="L2033">	}</span>

	/**
	 * Display the FindSettlementPanel.
	 */
	void showFindSettlementPanel() {
<span class="nc" id="L2039">		showSubPanel(new FindSettlementPanel(freeColClient), PopupPosition.ORIGIN, true);</span>
<span class="nc" id="L2040">	}</span>

	/**
	 * Display the first contact dialog (which is really just a non-modal
	 * confirm dialog).
	 *
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; making contact.
	 * @param other
	 *            The &lt;code&gt;Player&lt;/code&gt; to contact.
	 * @param tile
	 *            An optional &lt;code&gt;Tile&lt;/code&gt; on offer.
	 * @param settlementCount
	 *            The number of settlements the other player has (from the
	 *            server, other.getNumberOfSettlements() is wrong here!).
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showFirstContactDialog(Player player, Player other, Tile tile, int settlementCount,
			DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L2060">		SwingUtilities.invokeLater(new DialogCallback&lt;&gt;(</span>
				new FirstContactDialog(freeColClient, frame, player, other, tile, settlementCount), tile, handler));
<span class="nc" id="L2062">	}</span>

	/**
	 * Detailed view of a foreign colony when in debug mode.
	 *
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; with the colony
	 */
	void showForeignColony(Settlement settlement) {
<span class="nc bnc" id="L2071" title="All 2 branches missed.">		if (settlement instanceof Colony) {</span>
<span class="nc" id="L2072">			Colony colony = freeColClient.getFreeColServer().getGame().getFreeColGameObject(settlement.getId(),</span>
					Colony.class);
<span class="nc" id="L2074">			showColonyPanel(colony, null);</span>
		}
<span class="nc" id="L2076">	}</span>

	/**
	 * Display the GameOptionsDialog.
	 *
	 * @param editable
	 *            Should the game options be editable?
	 * @param custom
	 *            Whether to load custom options.
	 * @return The &lt;code&gt;OptionGroup&lt;/code&gt; selected.
	 */
	OptionGroup showGameOptionsDialog(boolean editable, boolean custom) {
<span class="nc" id="L2088">		GameOptionsDialog god = new GameOptionsDialog(freeColClient, frame, editable, custom);</span>
<span class="nc" id="L2089">		return showFreeColDialog(god, null);</span>
	}

	/**
	 * Displays the high scores panel.
	 *
	 * @param messageId
	 *            An optional message to add to the high scores panel.
	 * @param scores
	 *            The list of &lt;code&gt;HighScore&lt;/code&gt;s to display.
	 */
	void showHighScoresPanel(String messageId, List&lt;HighScore&gt; scores) {
<span class="nc" id="L2101">		showSubPanel(new ReportHighScoresPanel(freeColClient, messageId, scores), PopupPosition.CENTERED, true);</span>
<span class="nc" id="L2102">	}</span>

	/**
	 * Displays the panel of the given native settlement.
	 *
	 * @param indianSettlement
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; to display.
	 */
	void showIndianSettlementPanel(IndianSettlement indianSettlement) {
<span class="nc" id="L2111">		IndianSettlementPanel panel = new IndianSettlementPanel(freeColClient, indianSettlement);</span>
<span class="nc" id="L2112">		showFreeColPanel(panel, indianSettlement.getTile(), true);</span>
<span class="nc" id="L2113">	}</span>

	/**
	 * Make image icon from an image. Use only if you know having null is
	 * possible!
	 *
	 * @param image
	 *            The &lt;code&gt;Image&lt;/code&gt; to create an icon for.
	 * @return The &lt;code&gt;ImageIcon&lt;/code&gt;.
	 */
	private static ImageIcon createImageIcon(Image image) {
<span class="nc bnc" id="L2124" title="All 2 branches missed.">		return (image == null) ? null : new ImageIcon(image);</span>
	}

	/**
	 * Make image icon from an object.
	 *
	 * @param display
	 *            The FreeColObject to find an icon for.
	 * @return The &lt;code&gt;ImageIcon&lt;/code&gt; found.
	 */
	private ImageIcon createObjectImageIcon(FreeColObject display) {
<span class="nc bnc" id="L2135" title="All 2 branches missed.">		return (display == null) ? null : createImageIcon(gui.getImageLibrary().getObjectImage(display, 2f));</span>
	}

	/**
	 * Shows a message with some information and an &quot;OK&quot;-button.
	 *
	 * @param displayObject
	 *            Optional object for displaying an icon.
	 * @param template
	 *            The &lt;code&gt;StringTemplate&lt;/code&gt; to display.
	 */
	void showInformationMessage(FreeColObject displayObject, StringTemplate template) {
<span class="nc" id="L2147">		ImageIcon icon = null;</span>
<span class="nc" id="L2148">		Tile tile = null;</span>
<span class="nc bnc" id="L2149" title="All 2 branches missed.">		if (displayObject != null) {</span>
<span class="nc" id="L2150">			icon = createObjectImageIcon(displayObject);</span>
<span class="nc bnc" id="L2151" title="All 2 branches missed.">			tile = (displayObject instanceof Location) ? ((Location) displayObject).getTile() : null;</span>
		}
<span class="nc" id="L2153">		showInformationMessage(displayObject, tile, icon, template);</span>
<span class="nc" id="L2154">	}</span>

	/**
	 * Shows a message with some information and an &quot;OK&quot;-button.
	 *
	 * @param displayObject
	 *            Optional object for displaying.
	 * @param tile
	 *            The Tile the object is at.
	 * @param icon
	 *            The icon to display for the object.
	 * @param template
	 *            The &lt;code&gt;StringTemplate&lt;/code&gt; to display.
	 */
	void showInformationMessage(FreeColObject displayObject, Tile tile, ImageIcon icon, StringTemplate template) {
<span class="nc" id="L2169">		String text = Messages.message(template);</span>
<span class="nc" id="L2170">		showFreeColPanel(new InformationPanel(freeColClient, text, displayObject, icon), tile, true);</span>
<span class="nc" id="L2171">	}</span>

	/**
	 * Displays a dialog where the user may choose a file.
	 *
	 * @param directory
	 *            The directory containing the files.
	 * @param filters
	 *            The file filters which the user can select in the dialog.
	 * @return The selected &lt;code&gt;File&lt;/code&gt;.
	 */
	File showLoadDialog(File directory, FileFilter[] filters) {
<span class="nc bnc" id="L2183" title="All 2 branches missed.">		if (filters == null)</span>
<span class="nc" id="L2184">			filters = getFileFilters();</span>
<span class="nc" id="L2185">		File response = null;</span>
		for (;;) {
<span class="nc" id="L2187">			response = showFreeColDialog(new LoadDialog(freeColClient, frame, directory, filters), null);</span>
<span class="nc bnc" id="L2188" title="All 4 branches missed.">			if (response == null || response.isFile())</span>
<span class="nc" id="L2189">				break;</span>
<span class="nc" id="L2190">			showErrorMessage(&quot;error.noSuchFile&quot;);</span>
		}
<span class="nc" id="L2192">		return response;</span>
	}

	/**
	 * Displays a dialog for setting options when loading a savegame. The
	 * settings can be retrieved directly from {@link LoadingSavegameDialog}
	 * after calling this method.
	 *
	 * @param publicServer
	 *            Default value.
	 * @param singlePlayer
	 *            Default value.
	 * @return &lt;code&gt;true&lt;/code&gt; if the &quot;ok&quot;-button was pressed and
	 *         &lt;code&gt;false&lt;/code&gt; otherwise.
	 */
	boolean showLoadingSavegameDialog(boolean publicServer, boolean singlePlayer) {
<span class="nc" id="L2208">		loadingSavegameDialog = new LoadingSavegameDialog(freeColClient, frame);</span>
<span class="nc" id="L2209">		return showFreeColDialog(loadingSavegameDialog, null);</span>
	}

	/**
	 * Show a panel containing the log file.
	 */
	void showLogFilePanel() {
<span class="nc" id="L2216">		showSubPanel(new ErrorPanel(freeColClient), true);</span>

<span class="nc" id="L2218">	}</span>

	/**
	 * Shows the &lt;code&gt;MainPanel&lt;/code&gt;.
	 *
	 * @param userMsg
	 *            An option message key to show.
	 * @see MainPanel
	 */
	void showMainPanel(String userMsg) {
<span class="nc" id="L2228">		closeMenus();</span>
<span class="nc" id="L2229">		frame.removeMenuBar();</span>
<span class="nc" id="L2230">		mainPanel = new MainPanel(freeColClient);</span>
<span class="nc" id="L2231">		addCentered(mainPanel, JLayeredPane.DEFAULT_LAYER);</span>
<span class="nc bnc" id="L2232" title="All 2 branches missed.">		if (userMsg != null)</span>
<span class="nc" id="L2233">			gui.showInformationMessage(userMsg);</span>
<span class="nc" id="L2234">		mainPanel.requestFocus();</span>
<span class="nc" id="L2235">	}</span>

	/**
	 * Display the map editor transform panel.
	 */
	void showMapEditorTransformPanel() {
<span class="nc" id="L2241">		JInternalFrame f = addAsFrame(new MapEditorTransformPanel(freeColClient), true, PopupPosition.CENTERED, false);</span>
<span class="nc" id="L2242">		f.setLocation(f.getX(), 50);</span>
<span class="nc" id="L2243">		repaint();</span>
<span class="nc" id="L2244">	}</span>

	/**
	 * Display the map generator options dialog.
	 *
	 * @param editable
	 *            Should these options be editable.
	 * @return The &lt;code&gt;OptionGroup&lt;/code&gt; as edited.
	 */
	OptionGroup showMapGeneratorOptionsDialog(boolean editable) {
<span class="nc" id="L2254">		MapGeneratorOptionsDialog mgod = new MapGeneratorOptionsDialog(freeColClient, frame, editable);</span>
<span class="nc" id="L2255">		return showFreeColDialog(mgod, null);</span>
	}

	/**
	 * Display the map size dialog.
	 * 
	 * @return The response returned by the dialog.
	 */
	Dimension showMapSizeDialog() {
<span class="nc" id="L2264">		return showFreeColDialog(new MapSizeDialog(freeColClient, frame), null);</span>
	}

	/**
	 * Displays a number of ModelMessages.
	 *
	 * @param messages
	 *            The &lt;code&gt;ModelMessage&lt;/code&gt;s to display.
	 */
	void showModelMessages(List&lt;ModelMessage&gt; messages) {
<span class="nc bnc" id="L2274" title="All 2 branches missed.">		if (messages.isEmpty())</span>
<span class="nc" id="L2275">			return;</span>
<span class="nc" id="L2276">		final Game game = freeColClient.getGame();</span>
<span class="nc" id="L2277">		int n = messages.size();</span>
<span class="nc" id="L2278">		String[] texts = new String[n];</span>
<span class="nc" id="L2279">		FreeColObject[] fcos = new FreeColObject[n];</span>
<span class="nc" id="L2280">		ImageIcon[] icons = new ImageIcon[n];</span>
<span class="nc" id="L2281">		Tile tile = null;</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">		for (int i = 0; i &lt; n; i++) {</span>
<span class="nc" id="L2283">			ModelMessage m = messages.get(i);</span>
<span class="nc" id="L2284">			texts[i] = Messages.message(m);</span>
<span class="nc" id="L2285">			fcos[i] = game.getMessageSource(m);</span>
<span class="nc" id="L2286">			icons[i] = createObjectImageIcon(game.getMessageDisplay(m));</span>
<span class="nc bnc" id="L2287" title="All 4 branches missed.">			if (tile == null &amp;&amp; fcos[i] instanceof Location) {</span>
<span class="nc" id="L2288">				tile = ((Location) fcos[i]).getTile();</span>
			}
		}

<span class="nc" id="L2292">		showFreeColPanel(new InformationPanel(freeColClient, texts, fcos, icons), tile, true);</span>
<span class="nc" id="L2293">	}</span>

	/**
	 * Display the monarch dialog.
	 *
	 * @param action
	 *            The &lt;code&gt;MonarchAction&lt;/code&gt; underway.
	 * @param template
	 *            The &lt;code&gt;StringTemplate&lt;/code&gt; describing the situation.
	 * @param monarchKey
	 *            The resource key for the monarch image.
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showMonarchDialog(MonarchAction action, StringTemplate template, String monarchKey,
			DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L2309">		SwingUtilities.invokeLater(new DialogCallback&lt;&gt;(</span>
				new MonarchDialog(freeColClient, frame, action, template, monarchKey), null, handler));
<span class="nc" id="L2311">	}</span>

	/**
	 * Display a dialog to set a new name for something.
	 *
	 * @param template
	 *            A &lt;code&gt;StringTemplate&lt;/code&gt; for the message to explain the
	 *            dialog.
	 * @param defaultName
	 *            The default name.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; discovering it.
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showNamingDialog(StringTemplate template, String defaultName, Unit unit, DialogHandler&lt;String&gt; handler) {
<span class="nc" id="L2327">		SwingUtilities.invokeLater(new DialogCallback&lt;&gt;(new FreeColStringInputDialog(freeColClient, frame, false,</span>
<span class="nc" id="L2328">				Messages.message(template), defaultName, &quot;ok&quot;, null), unit.getTile(), handler));</span>
<span class="nc" id="L2329">	}</span>

	/**
	 * Displays the &lt;code&gt;NegotiationDialog&lt;/code&gt;.
	 *
	 * @param our
	 *            Our &lt;code&gt;FreeColGameObject&lt;/code&gt; that is negotiating.
	 * @param other
	 *            The other &lt;code&gt;FreeColGameObject&lt;/code&gt;.
	 * @param agreement
	 *            The current &lt;code&gt;DiplomaticTrade&lt;/code&gt; agreement.
	 * @param comment
	 *            An optional &lt;code&gt;StringTemplate&lt;/code&gt; containing a
	 *            commentary message.
	 * @return An updated agreement.
	 */
	DiplomaticTrade showNegotiationDialog(FreeColGameObject our, FreeColGameObject other, DiplomaticTrade agreement,
			StringTemplate comment) {
<span class="nc bnc" id="L2347" title="All 12 branches missed.">		if ((!(our instanceof Unit) &amp;&amp; !(our instanceof Colony))</span>
				|| (!(other instanceof Unit) &amp;&amp; !(other instanceof Colony))
				|| (our instanceof Colony &amp;&amp; other instanceof Colony)) {
<span class="nc" id="L2350">			throw new RuntimeException(&quot;Bad DTD args: &quot; + our + &quot;, &quot; + other);</span>
		}
<span class="nc" id="L2352">		NegotiationDialog dtd = new NegotiationDialog(freeColClient, frame, our, other, agreement, comment);</span>
<span class="nc" id="L2353">		return showFreeColDialog(dtd, ((Location) our).getTile());</span>
	}

	/**
	 * Display the NewPanel for a given optional specification.
	 *
	 * @param specification
	 *            The &lt;code&gt;Specification&lt;/code&gt; to use.
	 */
	void showNewPanel(Specification specification) {
<span class="nc" id="L2363">		showSubPanel(new NewPanel(freeColClient, specification), false);</span>
<span class="nc" id="L2364">	}</span>

	/**
	 * Shows the given video Component.
	 *
	 * @param vp
	 *            The video Component.
	 * @param ml
	 *            A MouseListener for stopping the video.
	 * @param kl
	 *            A KeyListener for stopping the video.
	 */
	void showVideoComponent(final Component vp, final MouseListener ml, final KeyListener kl) {
<span class="nc" id="L2377">		addMouseListener(ml);</span>
<span class="nc" id="L2378">		addKeyListener(kl);</span>
<span class="nc" id="L2379">		addCentered(vp, JLayeredPane.PALETTE_LAYER);</span>
<span class="nc" id="L2380">	}</span>

	/**
	 * Display the parameters dialog.
	 * 
	 * @return The response returned by the dialog.
	 */
	Parameters showParametersDialog() {
<span class="nc" id="L2388">		return showFreeColDialog(new ParametersDialog(freeColClient, frame), null);</span>
	}

	/**
	 * Display a dialog to confirm a combat.
	 *
	 * @param attacker
	 *            The attacker &lt;code&gt;Unit&lt;/code&gt;.
	 * @param defender
	 *            The defender.
	 * @param tile
	 *            A &lt;code&gt;Tile&lt;/code&gt; to make visible.
	 * @return True if the combat is to proceed.
	 */
	boolean showPreCombatDialog(Unit attacker, FreeColGameObject defender, Tile tile) {
<span class="nc" id="L2403">		return showFreeColDialog(new PreCombatDialog(freeColClient, frame, attacker, defender), tile);</span>
	}

	/**
	 * Displays the purchase panel.
	 */
	void showPurchasePanel() {
<span class="nc" id="L2410">		PurchasePanel panel = getExistingFreeColPanel(PurchasePanel.class);</span>
<span class="nc bnc" id="L2411" title="All 2 branches missed.">		if (panel == null) {</span>
<span class="nc" id="L2412">			showFreeColPanel(new PurchasePanel(freeColClient), null, false);</span>
		}
<span class="nc" id="L2414">	}</span>

	/**
	 * Displays the recruit panel.
	 */
	void showRecruitPanel() {
<span class="nc" id="L2420">		RecruitPanel panel = getExistingFreeColPanel(RecruitPanel.class);</span>
<span class="nc bnc" id="L2421" title="All 2 branches missed.">		if (panel == null) {</span>
<span class="nc" id="L2422">			showFreeColPanel(new RecruitPanel(freeColClient), null, false);</span>
		}
<span class="nc" id="L2424">	}</span>

	/**
	 * Display the labour detail panel.
	 *
	 * @param unitType
	 *            The &lt;code&gt;UnitType&lt;/code&gt; to display.
	 * @param data
	 *            The labour data.
	 * @param unitCount
	 *            A map of unit distribution.
	 * @param colonies
	 *            The list of player &lt;code&gt;Colony&lt;/code&gt;s.
	 */
	void showReportLabourDetailPanel(UnitType unitType, Map&lt;UnitType, Map&lt;Location, Integer&gt;&gt; data,
			TypeCountMap&lt;UnitType&gt; unitCount, List&lt;Colony&gt; colonies) {
<span class="nc" id="L2440">		ReportLabourDetailPanel details = new ReportLabourDetailPanel(freeColClient, unitType, data, unitCount,</span>
				colonies);
<span class="nc" id="L2442">		details.initialize();</span>
<span class="nc" id="L2443">		showSubPanel(details, true);</span>
<span class="nc" id="L2444">	}</span>

	/**
	 * Display the river style dialog.
	 *
	 * @param tile
	 *            An optional tile to make visible (not under the dialog).
	 * @return The response returned by the dialog.
	 */
	String showRiverStyleDialog(Tile tile) {
<span class="nc" id="L2454">		return showFreeColDialog(new RiverStyleDialog(freeColClient, frame), tile);</span>
	}

	/**
	 * Displays a dialog where the user may choose a filename.
	 *
	 * @param directory
	 *            The directory containing the files in which the user may
	 *            overwrite.
	 * @param filters
	 *            The available file filters in the dialog.
	 * @param defaultName
	 *            Default filename for the savegame.
	 * @return The selected &lt;code&gt;File&lt;/code&gt;.
	 */
	public File showSaveDialog(File directory, FileFilter[] filters, String defaultName) {
<span class="nc bnc" id="L2470" title="All 2 branches missed.">		if (filters == null)</span>
<span class="nc" id="L2471">			filters = getFileFilters();</span>
<span class="nc" id="L2472">		return showFreeColDialog(new SaveDialog(freeColClient, frame, directory, filters, defaultName), null);</span>
	}

	/**
	 * Display the scale map size dialog.
	 * 
	 * @return The response returned by the dialog.
	 */
	Dimension showScaleMapSizeDialog() {
<span class="nc" id="L2481">		return showFreeColDialog(new ScaleMapSizeDialog(freeColClient, frame), null);</span>
	}

	/**
	 * Display the select-amount dialog.
	 *
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to select an amount of.
	 * @param available
	 *            The amount of goods available.
	 * @param defaultAmount
	 *            The amount to select to start with.
	 * @param needToPay
	 *            If true, check the player has sufficient funds.
	 * @return The amount selected.
	 */
	int showSelectAmountDialog(GoodsType goodsType, int available, int defaultAmount, boolean needToPay) {
<span class="nc" id="L2498">		FreeColDialog&lt;Integer&gt; fcd = new SelectAmountDialog(freeColClient, frame, goodsType, available, defaultAmount,</span>
				needToPay);
<span class="nc" id="L2500">		Integer result = showFreeColDialog(fcd, null);</span>
<span class="nc bnc" id="L2501" title="All 2 branches missed.">		return (result == null) ? -1 : result;</span>
	}

	/**
	 * display the select-tribute-amount dialog.
	 *
	 * @param question
	 *            a &lt;code&gt;stringtemplate&lt;/code&gt; describing the amount of tribute
	 *            to demand.
	 * @param maximum
	 *            The maximum amount available.
	 * @return The amount selected.
	 */
	int showSelectTributeAmountDialog(StringTemplate question, int maximum) {
<span class="nc" id="L2515">		FreeColDialog&lt;Integer&gt; fcd = new SelectTributeAmountDialog(freeColClient, frame, question, maximum);</span>
<span class="nc" id="L2516">		Integer result = showFreeColDialog(fcd, null);</span>
<span class="nc bnc" id="L2517" title="All 2 branches missed.">		return (result == null) ? -1 : result;</span>
	}

	/**
	 * Display a dialog allowing the user to select a destination for a given
	 * unit.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to select a destination for.
	 * @return A destination for the unit, or null.
	 */
	Location showSelectDestinationDialog(Unit unit) {
<span class="nc" id="L2529">		return showFreeColDialog(new SelectDestinationDialog(freeColClient, frame, unit), unit.getTile());</span>
	}

	/**
	 * Displays the &lt;code&gt;ServerListPanel&lt;/code&gt;.
	 *
	 * @param serverList
	 *            The list containing the servers retrieved from the metaserver.
	 * @see ServerListPanel
	 */
	void showServerListPanel(List&lt;ServerInfo&gt; serverList) {
<span class="nc" id="L2540">		closeMenus();</span>

<span class="nc" id="L2542">		serverListPanel.initialize(serverList);</span>
<span class="nc" id="L2543">		showSubPanel(serverListPanel, true);</span>
<span class="nc" id="L2544">	}</span>

	/**
	 * Displays the colony panel of the given &lt;code&gt;Colony&lt;/code&gt; following a
	 * spying action.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; containing the colony to display.
	 * @return The colony panel.
	 * @see ColonyPanel
	 */
	ColonyPanel showSpyColonyPanel(Tile tile) {
<span class="nc" id="L2556">		Colony colony = tile.getColony();</span>
<span class="nc bnc" id="L2557" title="All 2 branches missed.">		if (colony == null)</span>
<span class="nc" id="L2558">			return null;</span>
<span class="nc" id="L2559">		ColonyPanel panel = new ColonyPanel(freeColClient, colony);</span>
<span class="nc" id="L2560">		showFreeColPanel(panel, tile, true);</span>
<span class="nc" id="L2561">		return panel;</span>
	}

	/**
	 * Displays the &lt;code&gt;StartGamePanel&lt;/code&gt;.
	 *
	 * @param game
	 *            The &lt;code&gt;Game&lt;/code&gt; that is about to start.
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; using this client.
	 * @param singlePlayerMode
	 *            True to start a single player game.
	 * @see StartGamePanel
	 */
	void showStartGamePanel(Game game, Player player, boolean singlePlayerMode) {
<span class="nc bnc" id="L2576" title="All 2 branches missed.">		if (game == null) {</span>
<span class="nc" id="L2577">			logger.warning(&quot;StartGamePanel requires game != null.&quot;);</span>
<span class="nc bnc" id="L2578" title="All 2 branches missed.">		} else if (player == null) {</span>
<span class="nc" id="L2579">			logger.warning(&quot;StartGamePanel requires player != null.&quot;);</span>
		} else {
<span class="nc" id="L2581">			closeMenus();</span>
<span class="nc" id="L2582">			startGamePanel.initialize(singlePlayerMode);</span>
<span class="nc" id="L2583">			showSubPanel(startGamePanel, false);</span>
		}
<span class="nc" id="L2585">	}</span>

	/**
	 * Display the statistics panel.
	 */
	void showStatisticsPanel() {
<span class="nc" id="L2591">		showSubPanel(new StatisticsPanel(freeColClient), true);</span>
<span class="nc" id="L2592">	}</span>

	/**
	 * Shows a status message that cannot be dismissed. The panel will be
	 * removed when another component is added to this &lt;code&gt;Canvas&lt;/code&gt;. This
	 * includes all the &lt;code&gt;showXXX&lt;/code&gt;-methods. In addition,
	 * {@link #closeStatusPanel()} also removes this panel.
	 *
	 * @param message
	 *            The text message to display on the status panel.
	 * @see StatusPanel
	 */
	void showStatusPanel(String message) {
<span class="nc" id="L2605">		statusPanel.setStatusMessage(message);</span>
<span class="nc" id="L2606">		addCentered(statusPanel, JLayeredPane.POPUP_LAYER);</span>
<span class="nc" id="L2607">	}</span>

	/**
	 * Display the tile panel for a given tile.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to display.
	 */
	void showTilePanel(Tile tile) {
<span class="nc bnc" id="L2616" title="All 4 branches missed.">		if (tile == null || !tile.isExplored())</span>
<span class="nc" id="L2617">			return;</span>
<span class="nc" id="L2618">		showSubPanel(new TilePanel(freeColClient, tile), false);</span>
<span class="nc" id="L2619">	}</span>

	/**
	 * Shows a tile popup.
	 *
	 * @param tile
	 *            The Tile where the popup occurred.
	 * @param x
	 *            The x-coordinate on the screen where the popup needs to be
	 *            placed.
	 * @param y
	 *            The y-coordinate on the screen where the popup needs to be
	 *            placed.
	 * @see TilePopup
	 */
	void showTilePopup(Tile tile, int x, int y) {
<span class="nc bnc" id="L2635" title="All 2 branches missed.">		if (tile == null)</span>
<span class="nc" id="L2636">			return;</span>
<span class="nc" id="L2637">		TilePopup tp = new TilePopup(freeColClient, this, tile);</span>
<span class="nc bnc" id="L2638" title="All 2 branches missed.">		if (tp.hasItem()) {</span>
<span class="nc" id="L2639">			tp.show(this, x, y);</span>
<span class="nc" id="L2640">			tp.repaint();</span>
<span class="nc bnc" id="L2641" title="All 2 branches missed.">		} else if (tile.isExplored()) {</span>
<span class="nc" id="L2642">			showTilePanel(tile);</span>
		}
<span class="nc" id="L2644">	}</span>

	/**
	 * Display a panel to select a trade route for a unit.
	 *
	 * @param unit
	 *            An optional &lt;code&gt;Unit&lt;/code&gt; to select a trade route for.
	 */
	void showTradeRoutePanel(Unit unit) {
<span class="nc bnc" id="L2653" title="All 2 branches missed.">		showFreeColPanel(new TradeRoutePanel(freeColClient, unit), (unit == null) ? null : unit.getTile(), true);</span>
<span class="nc" id="L2654">	}</span>

	/**
	 * Display the trade route input panel for a given trade route.
	 *
	 * @param newRoute
	 *            The &lt;code&gt;TradeRoute&lt;/code&gt; to display.
	 * @param callBack
	 *            The &lt;code&gt;Runnable&lt;/code&gt; that is run when the panel closes.
	 */
	void showTradeRouteInputPanel(TradeRoute newRoute, Runnable callBack) {
<span class="nc" id="L2665">		FreeColPanel panel = new TradeRouteInputPanel(freeColClient, newRoute);</span>
<span class="nc" id="L2666">		panel.addClosingCallback(callBack);</span>
<span class="nc" id="L2667">		showSubPanel(panel, null, true);</span>
<span class="nc" id="L2668">	}</span>

	/**
	 * Displays the training panel.
	 */
	void showTrainPanel() {
<span class="nc" id="L2674">		TrainPanel panel = getExistingFreeColPanel(TrainPanel.class);</span>
<span class="nc bnc" id="L2675" title="All 2 branches missed.">		if (panel == null) {</span>
<span class="nc" id="L2676">			showFreeColPanel(new TrainPanel(freeColClient), null, false);</span>
		}
<span class="nc" id="L2678">	}</span>

	/**
	 * Display the victory dialog.
	 *
	 * @param handler
	 *            A &lt;code&gt;DialogHandler&lt;/code&gt; for the dialog response.
	 */
	void showVictoryDialog(DialogHandler&lt;Boolean&gt; handler) {
<span class="nc" id="L2687">		SwingUtilities.invokeLater(new DialogCallback&lt;&gt;(new VictoryDialog(freeColClient, frame), null, handler));</span>
<span class="nc" id="L2688">	}</span>

	/**
	 * Display the warehouse dialog for a colony.
	 *
	 * Run out of ColonyPanel, so the tile is already displayed.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to display.
	 * @return The response returned by the dialog.
	 */
	boolean showWarehouseDialog(Colony colony) {
<span class="nc" id="L2700">		return showFreeColDialog(new WarehouseDialog(freeColClient, frame, colony), null);</span>
	}

	/**
	 * Display the production of a unit.
	 *
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to display.
	 */
	void showWorkProductionPanel(Unit unit) {
<span class="nc" id="L2710">		showSubPanel(new WorkProductionPanel(freeColClient, unit), true);</span>
<span class="nc" id="L2711">	}</span>

	/**
	 * Update all panels derived from the EuropePanel.
	 */
	void updateEuropeanSubpanels() {
<span class="nc" id="L2717">		RecruitPanel rp = getExistingFreeColPanel(RecruitPanel.class);</span>
<span class="nc bnc" id="L2718" title="All 2 branches missed.">		if (rp != null)</span>
<span class="nc" id="L2719">			rp.update();</span>
<span class="nc" id="L2720">		PurchasePanel pp = getExistingFreeColPanel(PurchasePanel.class);</span>
<span class="nc bnc" id="L2721" title="All 2 branches missed.">		if (pp != null)</span>
<span class="nc" id="L2722">			pp.update();</span>
<span class="nc" id="L2723">		TrainPanel tp = getExistingFreeColPanel(TrainPanel.class);</span>
<span class="nc bnc" id="L2724" title="All 2 branches missed.">		if (tp != null)</span>
<span class="nc" id="L2725">			tp.update();</span>
<span class="nc" id="L2726">	}</span>

	// Singleton specialist reports

	/**
	 * Show report cargo panel.
	 */
	void showReportCargoPanel() {
<span class="nc" id="L2734">		ReportCargoPanel r = getExistingFreeColPanel(ReportCargoPanel.class);</span>
<span class="nc bnc" id="L2735" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2736">			showSubPanel(new ReportCargoPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2738">	}</span>

	/**
	 * Show report colony panel.
	 */
	void showReportColonyPanel() {
		boolean compact;
		try {
<span class="nc" id="L2746">			compact = freeColClient.getClientOptions()</span>
<span class="nc bnc" id="L2747" title="All 2 branches missed.">					.getInteger(ClientOptions.COLONY_REPORT) == ClientOptions.COLONY_REPORT_COMPACT;</span>
<span class="nc" id="L2748">		} catch (Exception e) {</span>
<span class="nc" id="L2749">			compact = false;</span>
<span class="nc" id="L2750">		}</span>
<span class="nc bnc" id="L2751" title="All 2 branches missed.">		ReportPanel r = (compact) ? getExistingFreeColPanel(ReportCompactColonyPanel.class)</span>
<span class="nc" id="L2752">				: getExistingFreeColPanel(ReportClassicColonyPanel.class);</span>
<span class="nc bnc" id="L2753" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc bnc" id="L2754" title="All 2 branches missed.">			showSubPanel((compact) ? new ReportCompactColonyPanel(freeColClient)</span>
					: new ReportClassicColonyPanel(freeColClient), true);
		}
<span class="nc" id="L2757">	}</span>

	/**
	 * Show report continental congress panel.
	 */
	void showReportContinentalCongressPanel() {
<span class="nc" id="L2763">		ReportContinentalCongressPanel r = getExistingFreeColPanel(ReportContinentalCongressPanel.class);</span>
<span class="nc bnc" id="L2764" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2765">			showSubPanel(new ReportContinentalCongressPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2767">	}</span>

	/**
	 * Show report education panel.
	 */
	void showReportEducationPanel() {
<span class="nc" id="L2773">		ReportEducationPanel r = getExistingFreeColPanel(ReportEducationPanel.class);</span>
<span class="nc bnc" id="L2774" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2775">			showSubPanel(new ReportEducationPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2777">	}</span>

	/**
	 * Show report exploration panel.
	 */
	void showReportExplorationPanel() {
<span class="nc" id="L2783">		ReportExplorationPanel r = getExistingFreeColPanel(ReportExplorationPanel.class);</span>
<span class="nc bnc" id="L2784" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2785">			showSubPanel(new ReportExplorationPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2787">	}</span>

	/**
	 * Show report foreign affair panel.
	 */
	void showReportForeignAffairPanel() {
<span class="nc" id="L2793">		ReportForeignAffairPanel r = getExistingFreeColPanel(ReportForeignAffairPanel.class);</span>
<span class="nc bnc" id="L2794" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2795">			showSubPanel(new ReportForeignAffairPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2797">	}</span>

	/**
	 * Show report history panel.
	 */
	void showReportHistoryPanel() {
<span class="nc" id="L2803">		ReportHistoryPanel r = getExistingFreeColPanel(ReportHistoryPanel.class);</span>
<span class="nc bnc" id="L2804" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2805">			showSubPanel(new ReportHistoryPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2807">	}</span>

	/**
	 * Show report indian panel.
	 */
	void showReportIndianPanel() {
<span class="nc" id="L2813">		ReportIndianPanel r = getExistingFreeColPanel(ReportIndianPanel.class);</span>
<span class="nc bnc" id="L2814" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2815">			showSubPanel(new ReportIndianPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2817">	}</span>

	/**
	 * Show report labour panel.
	 */
	void showReportLabourPanel() {
<span class="nc" id="L2823">		ReportLabourPanel r = getExistingFreeColPanel(ReportLabourPanel.class);</span>
<span class="nc bnc" id="L2824" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2825">			showSubPanel(new ReportLabourPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2827">	}</span>

	/**
	 * Show report military panel.
	 */
	void showReportMilitaryPanel() {
<span class="nc" id="L2833">		ReportMilitaryPanel r = getExistingFreeColPanel(ReportMilitaryPanel.class);</span>
<span class="nc bnc" id="L2834" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2835">			showSubPanel(new ReportMilitaryPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2837">	}</span>

	/**
	 * Show report naval panel.
	 */
	void showReportNavalPanel() {
<span class="nc" id="L2843">		ReportNavalPanel r = getExistingFreeColPanel(ReportNavalPanel.class);</span>
<span class="nc bnc" id="L2844" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2845">			showSubPanel(new ReportNavalPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2847">	}</span>

	/**
	 * Show report production panel.
	 */
	void showReportProductionPanel() {
<span class="nc" id="L2853">		ReportProductionPanel r = getExistingFreeColPanel(ReportProductionPanel.class);</span>
<span class="nc bnc" id="L2854" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2855">			showSubPanel(new ReportProductionPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2857">	}</span>

	/**
	 * Show report religious panel.
	 */
	void showReportReligiousPanel() {
<span class="nc" id="L2863">		ReportReligiousPanel r = getExistingFreeColPanel(ReportReligiousPanel.class);</span>
<span class="nc bnc" id="L2864" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2865">			showSubPanel(new ReportReligiousPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2867">	}</span>

	/**
	 * Show report requirements panel.
	 */
	void showReportRequirementsPanel() {
<span class="nc" id="L2873">		ReportRequirementsPanel r = getExistingFreeColPanel(ReportRequirementsPanel.class);</span>
<span class="nc bnc" id="L2874" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2875">			showSubPanel(new ReportRequirementsPanel(freeColClient), true);</span>
		}
<span class="nc" id="L2877">	}</span>

	/**
	 * Show report trade panel.
	 */
	void showReportTradePanel() {
<span class="nc" id="L2883">		ReportTradePanel r = getExistingFreeColPanel(ReportTradePanel.class);</span>
<span class="nc bnc" id="L2884" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2885">			showSubPanel(new ReportTradePanel(freeColClient), true);</span>
		}
<span class="nc" id="L2887">	}</span>

	/**
	 * Show the turn report.
	 *
	 * @param messages
	 *            The &lt;code&gt;ModelMessage&lt;/code&gt;s to show.
	 */
	void showReportTurnPanel(List&lt;ModelMessage&gt; messages) {
<span class="nc" id="L2896">		ReportTurnPanel r = getExistingFreeColPanel(ReportTurnPanel.class);</span>
<span class="nc bnc" id="L2897" title="All 2 branches missed.">		if (r == null) {</span>
<span class="nc" id="L2898">			showSubPanel(new ReportTurnPanel(freeColClient, messages), true);</span>
		} else {
<span class="nc" id="L2900">			r.setMessages(messages);</span>
		}
<span class="nc" id="L2902">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>