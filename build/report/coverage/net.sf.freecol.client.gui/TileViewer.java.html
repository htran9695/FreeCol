<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TileViewer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.client.gui</a> &gt; <span class="el_source">TileViewer.java</span></div><h1>TileViewer.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.client.gui;

import java.awt.AlphaComposite;
import java.awt.Color;
import java.awt.Composite;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Graphics2D;
import java.awt.geom.GeneralPath;
import java.awt.image.BufferedImage;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Set;
import java.util.logging.Logger;

import net.sf.freecol.client.ClientOptions;
import net.sf.freecol.client.FreeColClient;
import net.sf.freecol.common.debug.DebugUtils;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.Direction;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.LostCityRumour;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Resource;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovement;
import net.sf.freecol.common.model.TileItem;
import net.sf.freecol.common.model.TileType;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.resources.ResourceManager;
import net.sf.freecol.common.util.Utils;

import static net.sf.freecol.common.util.StringUtils.*;

/**
 * TileViewer is a private helper class of MapViewer and SwingGUI.
 * 
 * This class is responsible for drawing map tiles for MapViewer and some
 * GUI-panels.
 */
public final class TileViewer {

	/** The Constant logger. */
<span class="nc" id="L70">	private static final Logger logger = Logger.getLogger(TileViewer.class.getName());</span>

	/**
	 * The Class SortableImage.
	 */
	private static class SortableImage implements Comparable&lt;SortableImage&gt; {

		/** The image. */
		public final BufferedImage image;

		/** The index. */
		public final int index;

		/**
		 * Instantiates a new sortable image.
		 *
		 * @param image
		 *            the image
		 * @param index
		 *            the index
		 */
<span class="nc" id="L91">		public SortableImage(BufferedImage image, int index) {</span>
<span class="nc" id="L92">			this.image = image;</span>
<span class="nc" id="L93">			this.index = index;</span>
<span class="nc" id="L94">		}</span>

		// Implement Comparable&lt;SortableImage&gt;

		/*
		 * (non-Javadoc)
		 * 
		 * @see java.lang.Comparable#compareTo(java.lang.Object)
		 */
		@Override
		public int compareTo(SortableImage other) {
<span class="nc" id="L105">			return other.index - this.index;</span>
		}

		// Override Object

		/**
		 * {@inheritDoc}
		 */
		@Override
		public boolean equals(Object other) {
<span class="nc bnc" id="L115" title="All 2 branches missed.">			if (other instanceof SortableImage) {</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">				return this.compareTo((SortableImage) other) == 0;</span>
			}
<span class="nc" id="L118">			return super.equals(other);</span>
		}

		/**
		 * {@inheritDoc}
		 */
		@Override
		public int hashCode() {
<span class="nc" id="L126">			int hash = super.hashCode();</span>
<span class="nc" id="L127">			hash = 37 * hash + Utils.hashCode(image);</span>
<span class="nc" id="L128">			return 37 * hash + index;</span>
		}
	}

	/** The free col client. */
	private final FreeColClient freeColClient;

	/** The lib. */
	private ImageLibrary lib;

	/** The rp. */
	private RoadPainter rp;

	/** The half width. */
	// Helper variables for displaying.
	private int tileHeight, tileWidth, halfHeight, halfWidth;

	/** The Constant STATE_OFFSET_Y. */
	// The height offset to paint at (in pixels).
	static final int STATE_OFFSET_X = 25, STATE_OFFSET_Y = 10;

	/** The fog. */
<span class="nc" id="L150">	private final GeneralPath fog = new GeneralPath();</span>

	/**
	 * The constructor to use.
	 *
	 * @param freeColClient
	 *            The &lt;code&gt;FreeColClient&lt;/code&gt; for the game.
	 */
<span class="nc" id="L158">	TileViewer(FreeColClient freeColClient) {</span>
<span class="nc" id="L159">		this.freeColClient = freeColClient;</span>

<span class="nc" id="L161">		setImageLibraryAndUpdateData(new ImageLibrary());</span>
<span class="nc" id="L162">	}</span>

	/**
	 * Gets the contained &lt;code&gt;ImageLibrary&lt;/code&gt;.
	 * 
	 * @return The image library;
	 */
	ImageLibrary getImageLibrary() {
<span class="nc" id="L170">		return lib;</span>
	}

	/**
	 * Returns the scaled terrain-image for a terrain type (and position 0, 0).
	 *
	 * @param type
	 *            The type of the terrain-image to return.
	 * @param size
	 *            The maximum size of the terrain image to return.
	 * @return The terrain-image
	 */
	static BufferedImage createTileImageWithOverlayAndForest(TileType type, Dimension size) {
<span class="nc bnc" id="L183" title="All 2 branches missed.">		Dimension size2 = new Dimension((size.width &gt; 0) ? size.width</span>
				: (2 * ImageLibrary.TILE_SIZE.width * size.height + (ImageLibrary.TILE_OVERLAY_SIZE.height + 1))
						/ (2 * ImageLibrary.TILE_OVERLAY_SIZE.height),
				-1);
<span class="nc" id="L187">		BufferedImage terrainImage = ImageLibrary.getTerrainImage(type, 0, 0, size2);</span>
<span class="nc" id="L188">		BufferedImage overlayImage = ImageLibrary.getOverlayImage(type, type.getId(), size2);</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">		BufferedImage forestImage = type.isForested() ? ImageLibrary.getForestImage(type, size2) : null;</span>
<span class="nc bnc" id="L190" title="All 4 branches missed.">		if (overlayImage == null &amp;&amp; forestImage == null) {</span>
<span class="nc" id="L191">			return terrainImage;</span>
		} else {
<span class="nc" id="L193">			int width = terrainImage.getWidth();</span>
<span class="nc" id="L194">			int height = terrainImage.getHeight();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (overlayImage != null) {</span>
<span class="nc" id="L196">				height = Math.max(height, overlayImage.getHeight());</span>
			}
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (forestImage != null) {</span>
<span class="nc" id="L199">				height = Math.max(height, forestImage.getHeight());</span>
			}
<span class="nc" id="L201">			BufferedImage compositeImage = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);</span>
<span class="nc" id="L202">			Graphics2D g = compositeImage.createGraphics();</span>
<span class="nc" id="L203">			g.drawImage(terrainImage, 0, height - terrainImage.getHeight(), null);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (overlayImage != null) {</span>
<span class="nc" id="L205">				g.drawImage(overlayImage, 0, height - overlayImage.getHeight(), null);</span>
			}
<span class="nc bnc" id="L207" title="All 2 branches missed.">			if (forestImage != null) {</span>
<span class="nc" id="L208">				g.drawImage(forestImage, 0, height - forestImage.getHeight(), null);</span>
			}
<span class="nc" id="L210">			g.dispose();</span>
<span class="nc" id="L211">			return compositeImage;</span>
		}
	}

	/**
	 * Create a &lt;code&gt;BufferedImage&lt;/code&gt; and draw a &lt;code&gt;Tile&lt;/code&gt; on it.
	 * Draws the terrain and improvements.
	 *
	 * @param tile
	 *            The Tile to draw.
	 * @return The image.
	 */
	BufferedImage createTileImageWithBeachBorderAndItems(Tile tile) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">		if (!tile.isExplored())</span>
<span class="nc" id="L225">			return lib.getTerrainImage(null, tile.getX(), tile.getY());</span>
<span class="nc" id="L226">		final TileType tileType = tile.getType();</span>
<span class="nc" id="L227">		Dimension terrainTileSize = lib.tileSize;</span>
<span class="nc" id="L228">		BufferedImage overlayImage = lib.getOverlayImage(tile);</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">		final int compoundHeight = (overlayImage != null) ? overlayImage.getHeight()</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">				: tileType.isForested() ? lib.tileForestSize.height : terrainTileSize.height;</span>
<span class="nc" id="L231">		BufferedImage image = new BufferedImage(terrainTileSize.width, compoundHeight, BufferedImage.TYPE_INT_ARGB);</span>
<span class="nc" id="L232">		Graphics2D g = image.createGraphics();</span>
<span class="nc" id="L233">		g.translate(0, compoundHeight - terrainTileSize.height);</span>
<span class="nc" id="L234">		displayTileWithBeachAndBorder(g, tile);</span>
<span class="nc" id="L235">		displayTileItems(g, tile, overlayImage);</span>
<span class="nc" id="L236">		g.dispose();</span>
<span class="nc" id="L237">		return image;</span>
	}

	/**
	 * Create a &lt;code&gt;BufferedImage&lt;/code&gt; and draw a &lt;code&gt;Tile&lt;/code&gt; on it.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to draw.
	 * @return The image.
	 */
	BufferedImage createTileImage(Tile tile) {
<span class="nc" id="L248">		final TileType tileType = tile.getType();</span>
<span class="nc" id="L249">		Dimension terrainTileSize = lib.tileSize;</span>
<span class="nc" id="L250">		BufferedImage overlayImage = lib.getOverlayImage(tile);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">		final int compoundHeight = (overlayImage != null) ? overlayImage.getHeight()</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">				: tileType.isForested() ? lib.tileForestSize.height : terrainTileSize.height;</span>
<span class="nc" id="L253">		BufferedImage image = new BufferedImage(terrainTileSize.width, compoundHeight, BufferedImage.TYPE_INT_ARGB);</span>
<span class="nc" id="L254">		Graphics2D g = image.createGraphics();</span>
<span class="nc" id="L255">		g.translate(0, compoundHeight - terrainTileSize.height);</span>
<span class="nc" id="L256">		displayTile(g, tile, overlayImage);</span>
<span class="nc" id="L257">		g.dispose();</span>
<span class="nc" id="L258">		return image;</span>
	}

	/**
	 * Create a &lt;code&gt;BufferedImage&lt;/code&gt; and draw a &lt;code&gt;Tile&lt;/code&gt; on it.
	 * The visualization of the &lt;code&gt;Tile&lt;/code&gt; also includes information from
	 * the corresponding &lt;code&gt;ColonyTile&lt;/code&gt; of the given
	 * &lt;code&gt;Colony&lt;/code&gt;.
	 *
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to draw.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to create the visualization of the
	 *            &lt;code&gt;Tile&lt;/code&gt; for. This object is also used to get the
	 *            &lt;code&gt;ColonyTile&lt;/code&gt; for the given &lt;code&gt;Tile&lt;/code&gt;.
	 * @return The image.
	 */
	BufferedImage createColonyTileImage(Tile tile, Colony colony) {
<span class="nc" id="L276">		final TileType tileType = tile.getType();</span>
<span class="nc" id="L277">		Dimension terrainTileSize = lib.tileSize;</span>
<span class="nc" id="L278">		BufferedImage overlayImage = lib.getOverlayImage(tile);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">		final int compoundHeight = (overlayImage != null) ? overlayImage.getHeight()</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">				: tileType.isForested() ? lib.tileForestSize.height : terrainTileSize.height;</span>
<span class="nc" id="L281">		BufferedImage image = new BufferedImage(terrainTileSize.width, compoundHeight, BufferedImage.TYPE_INT_ARGB);</span>
<span class="nc" id="L282">		Graphics2D g = image.createGraphics();</span>
<span class="nc" id="L283">		g.translate(0, compoundHeight - terrainTileSize.height);</span>
<span class="nc" id="L284">		displayColonyTile(g, tile, colony, overlayImage);</span>
<span class="nc" id="L285">		g.dispose();</span>
<span class="nc" id="L286">		return image;</span>
	}

	/**
	 * Displays the 3x3 tiles for the TilesPanel in ColonyPanel.
	 * 
	 * @param g
	 *            The &lt;code&gt;Graphics2D&lt;/code&gt; object on which to draw the
	 *            &lt;code&gt;Tile&lt;/code&gt;.
	 * @param tiles
	 *            The array containing the &lt;code&gt;Tile&lt;/code&gt; objects to draw.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to create the visualization of the
	 *            &lt;code&gt;Tile&lt;/code&gt; objects for.
	 */
	void displayColonyTiles(Graphics2D g, Tile[][] tiles, Colony colony) {
<span class="nc" id="L302">		Set&lt;String&gt; overlayCache = ImageLibrary.createOverlayCache();</span>
<span class="nc" id="L303">		Dimension tileSize = lib.tileSize;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">		for (int x = 0; x &lt; 3; x++) {</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">			for (int y = 0; y &lt; 3; y++) {</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">				if (tiles[x][y] != null) {</span>
<span class="nc" id="L307">					int xx = (((2 - x) + y) * tileSize.width) / 2;</span>
<span class="nc" id="L308">					int yy = ((x + y) * tileSize.height) / 2;</span>
<span class="nc" id="L309">					g.translate(xx, yy);</span>
<span class="nc" id="L310">					BufferedImage overlayImage = lib.getOverlayImage(tiles[x][y], overlayCache);</span>
<span class="nc" id="L311">					displayColonyTile(g, tiles[x][y], colony, overlayImage);</span>
<span class="nc" id="L312">					g.translate(-xx, -yy);</span>
				}
			}
		}
<span class="nc" id="L316">	}</span>

	/**
	 * Displays the given colony tile. The visualization of the
	 * &lt;code&gt;Tile&lt;/code&gt; also includes information from the corresponding
	 * &lt;code&gt;ColonyTile&lt;/code&gt; from the given &lt;code&gt;Colony&lt;/code&gt;.
	 *
	 * @param g
	 *            The &lt;code&gt;Graphics2D&lt;/code&gt; on which to draw.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to draw.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to create the visualization of the
	 *            &lt;code&gt;Tile&lt;/code&gt; for. This object is also used to get the
	 *            &lt;code&gt;ColonyTile&lt;/code&gt; for the given &lt;code&gt;Tile&lt;/code&gt;.
	 * @param overlayImage
	 *            The BufferedImage of the tile overlay.
	 */
	private void displayColonyTile(Graphics2D g, Tile tile, Colony colony, BufferedImage overlayImage) {
<span class="nc" id="L335">		displayTile(g, tile, overlayImage);</span>

<span class="nc" id="L337">		ColonyTile colonyTile = colony.getColonyTile(tile);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">		switch (colonyTile.getNoWorkReason()) {</span>
		case NONE:
		case COLONY_CENTER:
		case CLAIM_REQUIRED:
<span class="nc" id="L342">			break;</span>
		default:
<span class="nc" id="L344">			g.drawImage(lib.getMiscImage(ImageLibrary.TILE_TAKEN), 0, 0, null);</span>
		}
<span class="nc" id="L346">		int price = colony.getOwner().getLandPrice(tile);</span>
<span class="nc bnc" id="L347" title="All 4 branches missed.">		if (price &gt; 0 &amp;&amp; !tile.hasSettlement()) {</span>
<span class="nc" id="L348">			BufferedImage image = lib.getMiscImage(ImageLibrary.TILE_OWNED_BY_INDIANS);</span>
<span class="nc" id="L349">			displayCenteredImage(g, image);</span>
		}

<span class="nc" id="L352">		Unit unit = colonyTile.getOccupyingUnit();</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">		if (unit != null) {</span>
<span class="nc" id="L354">			BufferedImage image = lib.getSmallerUnitImage(unit);</span>
<span class="nc" id="L355">			g.drawImage(image, tileWidth / 4 - image.getWidth() / 2, halfHeight - image.getHeight() / 2, null);</span>
			// Draw an occupation and nation indicator.
<span class="nc" id="L357">			Player owner = freeColClient.getMyPlayer();</span>
<span class="nc" id="L358">			String text = Messages.message(unit.getOccupationLabel(owner, false));</span>
<span class="nc" id="L359">			g.drawImage(lib.getOccupationIndicatorChip(g, unit, text), (int) (STATE_OFFSET_X * lib.getScaleFactor()), 0,</span>
					null);
		}
<span class="nc" id="L362">	}</span>

	/**
	 * Displays the given &lt;code&gt;Tile&lt;/code&gt;.
	 *
	 * @param g
	 *            The Graphics2D on which to draw the &lt;code&gt;Tile&lt;/code&gt;.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to draw.
	 * @param overlayImage
	 *            The BufferedImage for the tile overlay.
	 */
	private void displayTile(Graphics2D g, Tile tile, BufferedImage overlayImage) {
<span class="nc" id="L375">		displayTileWithBeachAndBorder(g, tile);</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">		if (tile.isExplored()) {</span>
<span class="nc" id="L377">			displayTileItems(g, tile, overlayImage);</span>
<span class="nc" id="L378">			displaySettlementWithChipsOrPopulationNumber(g, tile, false);</span>
<span class="nc" id="L379">			displayFogOfWar(g, tile);</span>
<span class="nc" id="L380">			displayOptionalTileText(g, tile);</span>
		}
<span class="nc" id="L382">	}</span>

	/**
	 * Sets the ImageLibrary and calculates various items that depend on tile
	 * size.
	 *
	 * @param lib
	 *            an &lt;code&gt;ImageLibrary&lt;/code&gt; value
	 */
	void setImageLibraryAndUpdateData(ImageLibrary lib) {
<span class="nc" id="L392">		this.lib = lib;</span>
		// ATTENTION: we assume that all base tiles have the same size
<span class="nc" id="L394">		Dimension tileSize = lib.tileSize;</span>
<span class="nc" id="L395">		rp = new RoadPainter(tileSize);</span>
<span class="nc" id="L396">		tileHeight = tileSize.height;</span>
<span class="nc" id="L397">		tileWidth = tileSize.width;</span>
<span class="nc" id="L398">		halfHeight = tileHeight / 2;</span>
<span class="nc" id="L399">		halfWidth = tileWidth / 2;</span>

<span class="nc" id="L401">		fog.reset();</span>
<span class="nc" id="L402">		fog.moveTo(halfWidth, 0);</span>
<span class="nc" id="L403">		fog.lineTo(tileWidth, halfHeight);</span>
<span class="nc" id="L404">		fog.lineTo(halfWidth, tileHeight);</span>
<span class="nc" id="L405">		fog.lineTo(0, halfHeight);</span>
<span class="nc" id="L406">		fog.closePath();</span>
<span class="nc" id="L407">	}</span>

	/**
	 * Centers the given Image on the tile.
	 *
	 * @param g
	 *            a &lt;code&gt;Graphics2D&lt;/code&gt;
	 * @param image
	 *            the BufferedImage
	 */
	void displayCenteredImage(Graphics2D g, BufferedImage image) {
<span class="nc" id="L418">		g.drawImage(image, (tileWidth - image.getWidth()) / 2, (tileHeight - image.getHeight()) / 2, null);</span>
<span class="nc" id="L419">	}</span>

	/**
	 * Centers the given Image on the tile, ensuring it is not drawing over
	 * tiles south of it.
	 *
	 * @param g
	 *            a &lt;code&gt;Graphics2D&lt;/code&gt;
	 * @param image
	 *            the BufferedImage
	 */
	void displayLargeCenteredImage(Graphics2D g, BufferedImage image) {
<span class="nc" id="L431">		int y = tileHeight - image.getHeight();</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">		if (y &gt; 0)</span>
<span class="nc" id="L433">			y /= 2;</span>
<span class="nc" id="L434">		g.drawImage(image, (tileWidth - image.getWidth()) / 2, y, null);</span>
<span class="nc" id="L435">	}</span>

	/**
	 * Displays the given Tile onto the given Graphics2D object at the location
	 * specified by the coordinates. Only base terrain will be drawn.
	 *
	 * @param g
	 *            The Graphics2D object on which to draw the Tile.
	 * @param tile
	 *            The Tile to draw.
	 */
	void displayTileWithBeachAndBorder(Graphics2D g, Tile tile) {
<span class="nc bnc" id="L447" title="All 2 branches missed.">		if (tile != null) {</span>
<span class="nc" id="L448">			TileType tileType = tile.getType();</span>
<span class="nc" id="L449">			int x = tile.getX();</span>
<span class="nc" id="L450">			int y = tile.getY();</span>
			// ATTENTION: we assume that all base tiles have the same size
<span class="nc" id="L452">			g.drawImage(lib.getTerrainImage(tileType, x, y), 0, 0, null);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">			if (tile.isExplored()) {</span>
<span class="nc bnc" id="L454" title="All 4 branches missed.">				if (!tile.isLand() &amp;&amp; tile.getStyle() &gt; 0) {</span>
<span class="nc" id="L455">					int edgeStyle = tile.getStyle() &gt;&gt; 4;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">					if (edgeStyle &gt; 0) {</span>
<span class="nc" id="L457">						g.drawImage(lib.getBeachEdgeImage(edgeStyle, x, y), 0, 0, null);</span>
					}
<span class="nc" id="L459">					int cornerStyle = tile.getStyle() &amp; 15;</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">					if (cornerStyle &gt; 0) {</span>
<span class="nc" id="L461">						g.drawImage(lib.getBeachCornerImage(cornerStyle, x, y), 0, 0, null);</span>
					}
				}

<span class="nc" id="L465">				List&lt;SortableImage&gt; imageBorders = new ArrayList&lt;&gt;(8);</span>
				SortableImage si;
<span class="nc bnc" id="L467" title="All 2 branches missed.">				for (Direction direction : Direction.values()) {</span>
<span class="nc" id="L468">					Tile borderingTile = tile.getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L469" title="All 4 branches missed.">					if (borderingTile != null &amp;&amp; borderingTile.isExplored()) {</span>
<span class="nc" id="L470">						TileType borderingTileType = borderingTile.getType();</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">						if (borderingTileType != tileType) {</span>
<span class="nc bnc" id="L472" title="All 4 branches missed.">							if (!tile.isLand() &amp;&amp; borderingTile.isLand()) {</span>
								// If there is a Coast image (eg. beach)
								// defined, use it, otherwise skip
								// Draw the grass from the neighboring tile,
								// spilling over on the side of this tile
<span class="nc" id="L477">								si = new SortableImage(lib.getBorderImage(borderingTileType, direction, x, y),</span>
<span class="nc" id="L478">										borderingTileType.getIndex());</span>
<span class="nc" id="L479">								imageBorders.add(si);</span>
<span class="nc" id="L480">								TileImprovement river = borderingTile.getRiver();</span>
<span class="nc bnc" id="L481" title="All 4 branches missed.">								if (river != null &amp;&amp; river.isConnectedTo(direction.getReverseDirection())) {</span>
<span class="nc" id="L482">									si = new SortableImage(lib.getRiverMouthImage(direction,</span>
<span class="nc" id="L483">											borderingTile.getRiver().getMagnitude(), x, y), -1);</span>
<span class="nc" id="L484">									imageBorders.add(si);</span>
								}
<span class="nc bnc" id="L486" title="All 4 branches missed.">							} else if (!tile.isLand() || borderingTile.isLand()) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">								if (borderingTileType.getIndex() &lt; tileType.getIndex()</span>
<span class="nc" id="L488">										&amp;&amp; !lib.getTerrainImage(tileType, 0, 0)</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">												.equals(lib.getTerrainImage(borderingTileType, 0, 0))) {</span>
									// Draw land terrain with bordering land
									// type, or ocean/high seas limit,
									// if the tiles do not share same graphics
									// (ocean &amp; great river)
<span class="nc" id="L494">									si = new SortableImage(lib.getBorderImage(borderingTileType, direction, x, y),</span>
<span class="nc" id="L495">											borderingTileType.getIndex());</span>
<span class="nc" id="L496">									imageBorders.add(si);</span>
								}
							}
						}
					}
				}
<span class="nc" id="L502">				Collections.sort(imageBorders);</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">				for (SortableImage sorted : imageBorders) {</span>
<span class="nc" id="L504">					g.drawImage(sorted.image, 0, 0, null);</span>
<span class="nc" id="L505">				}</span>
			}
		}
<span class="nc" id="L508">	}</span>

	/**
	 * Display unknown tile border.
	 *
	 * @param g
	 *            the g
	 * @param tile
	 *            the tile
	 */
	void displayUnknownTileBorder(Graphics2D g, Tile tile) {
<span class="nc bnc" id="L519" title="All 2 branches missed.">		for (Direction direction : Direction.values()) {</span>
<span class="nc" id="L520">			Tile borderingTile = tile.getNeighbourOrNull(direction);</span>
<span class="nc bnc" id="L521" title="All 4 branches missed.">			if (borderingTile != null &amp;&amp; !borderingTile.isExplored()) {</span>
<span class="nc" id="L522">				g.drawImage(lib.getBorderImage(null, direction, tile.getX(), tile.getY()), 0, 0, null);</span>
			}
		}
<span class="nc" id="L525">	}</span>

	/**
	 * Displays the given Tile onto the given Graphics2D object at the location
	 * specified by the coordinates. Fog of war will be drawn.
	 *
	 * @param g
	 *            The &lt;code&gt;Graphics2D&lt;/code&gt; object on which to draw the
	 *            &lt;code&gt;Tile&lt;/code&gt;.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to draw.
	 */
	void displayFogOfWar(Graphics2D g, Tile tile) {
<span class="nc bnc" id="L538" title="All 2 branches missed.">		if (freeColClient.getGame() != null</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">				&amp;&amp; freeColClient.getGame().getSpecification().getBoolean(GameOptions.FOG_OF_WAR)</span>
<span class="nc bnc" id="L540" title="All 4 branches missed.">				&amp;&amp; freeColClient.getMyPlayer() != null &amp;&amp; !freeColClient.getMyPlayer().canSee(tile)) {</span>
<span class="nc" id="L541">			g.setColor(Color.BLACK);</span>
<span class="nc" id="L542">			Composite oldComposite = g.getComposite();</span>
<span class="nc" id="L543">			g.setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER, 0.2f));</span>
<span class="nc" id="L544">			g.fill(fog);</span>
<span class="nc" id="L545">			g.setComposite(oldComposite);</span>
		}
<span class="nc" id="L547">	}</span>

	/**
	 * Displays the Tile text for a Tile. Shows tile names, coordinates and
	 * colony values.
	 *
	 * @param g
	 *            The Graphics2D object on which the text gets drawn.
	 * @param tile
	 *            The Tile to draw the text on.
	 */
	void displayOptionalTileText(Graphics2D g, Tile tile) {
<span class="nc" id="L559">		String text = null;</span>
<span class="nc" id="L560">		int op = freeColClient.getClientOptions().getInteger(ClientOptions.DISPLAY_TILE_TEXT);</span>
<span class="nc bnc" id="L561" title="All 5 branches missed.">		switch (op) {</span>
		case ClientOptions.DISPLAY_TILE_TEXT_NAMES:
<span class="nc" id="L563">			text = Messages.getName(tile);</span>
<span class="nc" id="L564">			break;</span>
		case ClientOptions.DISPLAY_TILE_TEXT_OWNERS:
<span class="nc bnc" id="L566" title="All 2 branches missed.">			if (tile.getOwner() != null) {</span>
<span class="nc" id="L567">				text = Messages.message(tile.getOwner().getNationLabel());</span>
			}
			break;
		case ClientOptions.DISPLAY_TILE_TEXT_REGIONS:
<span class="nc bnc" id="L571" title="All 2 branches missed.">			if (tile.getRegion() != null) {</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">				if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">						&amp;&amp; tile.getRegion().getName() == null) {</span>
<span class="nc" id="L574">					text = tile.getRegion().getSuffix();</span>
				} else {
<span class="nc" id="L576">					text = Messages.message(tile.getRegion().getLabel());</span>
				}
			}
			break;
		case ClientOptions.DISPLAY_TILE_TEXT_EMPTY:
<span class="nc" id="L581">			break;</span>
		default:
<span class="nc" id="L583">			logger.warning(&quot;displayTileText option &quot; + op + &quot; out of range&quot;);</span>
			break;
		}

<span class="nc" id="L587">		g.setColor(Color.BLACK);</span>
<span class="nc" id="L588">		g.setFont(FontLibrary.createFont(FontLibrary.FontType.NORMAL, FontLibrary.FontSize.TINY, lib.getScaleFactor()));</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">		if (text != null) {</span>
<span class="nc" id="L590">			int b = getBreakingPoint(text);</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">			if (b == -1) {</span>
<span class="nc" id="L592">				g.drawString(text, (tileWidth - g.getFontMetrics().stringWidth(text)) / 2,</span>
<span class="nc" id="L593">						(tileHeight - g.getFontMetrics().getAscent()) / 2);</span>
			} else {
<span class="nc" id="L595">				g.drawString(text.substring(0, b),</span>
<span class="nc" id="L596">						(tileWidth - g.getFontMetrics().stringWidth(text.substring(0, b))) / 2,</span>
<span class="nc" id="L597">						halfHeight - (g.getFontMetrics().getAscent() * 2) / 3);</span>
<span class="nc" id="L598">				g.drawString(text.substring(b + 1),</span>
<span class="nc" id="L599">						(tileWidth - g.getFontMetrics().stringWidth(text.substring(b + 1))) / 2,</span>
<span class="nc" id="L600">						halfHeight + (g.getFontMetrics().getAscent() * 2) / 3);</span>
			}
		}

<span class="nc bnc" id="L604" title="All 2 branches missed.">		if (FreeColDebugger.debugDisplayCoordinates()) {</span>
<span class="nc" id="L605">			String posString = tile.getX() + &quot;, &quot; + tile.getY();</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">			if (tile.getHighSeasCount() &gt;= 0) {</span>
<span class="nc" id="L607">				posString += &quot;/&quot; + Integer.toString(tile.getHighSeasCount());</span>
			}
<span class="nc" id="L609">			g.drawString(posString, (tileWidth - g.getFontMetrics().stringWidth(posString)) / 2,</span>
<span class="nc" id="L610">					(tileHeight - g.getFontMetrics().getAscent()) / 2);</span>
		}
<span class="nc" id="L612">		String value = DebugUtils.getColonyValue(tile);</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">		if (value != null) {</span>
<span class="nc" id="L614">			g.drawString(value, (tileWidth - g.getFontMetrics().stringWidth(value)) / 2,</span>
<span class="nc" id="L615">					(tileHeight - g.getFontMetrics().getAscent()) / 2);</span>
		}
<span class="nc" id="L617">	}</span>

	/**
	 * Displays the given Tile onto the given Graphics2D object at the location
	 * specified by the coordinates. Settlements and Lost City Rumours will be
	 * shown.
	 *
	 * @param g
	 *            The Graphics2D object on which to draw the Tile.
	 * @param tile
	 *            The Tile to draw.
	 * @param withNumber
	 *            Whether to display the number of units present.
	 */
	void displaySettlementWithChipsOrPopulationNumber(Graphics2D g, Tile tile, boolean withNumber) {
<span class="nc" id="L632">		final Player player = freeColClient.getMyPlayer();</span>
<span class="nc" id="L633">		final Settlement settlement = tile.getSettlement();</span>

<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (settlement != null) {</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">			if (settlement instanceof Colony) {</span>
<span class="nc" id="L637">				Colony colony = (Colony) settlement;</span>

				// Draw image of colony in center of the tile.
<span class="nc" id="L640">				BufferedImage colonyImage = lib.getSettlementImage(settlement);</span>
<span class="nc" id="L641">				displayLargeCenteredImage(g, colonyImage);</span>

<span class="nc bnc" id="L643" title="All 2 branches missed.">				if (withNumber) {</span>
<span class="nc" id="L644">					String populationString = Integer.toString(colony.getDisplayUnitCount());</span>
<span class="nc" id="L645">					int bonus = colony.getProductionBonus();</span>
<span class="nc" id="L646">					Color theColor = ResourceManager.getColor(&quot;color.map.productionBonus.&quot; + bonus);</span>
					// if government admits even more units, use
					// italic and bigger number icon
<span class="nc bnc" id="L649" title="All 2 branches missed.">					Font font = (colony.getPreferredSizeChange() &gt; 0)</span>
<span class="nc" id="L650">							? FontLibrary.createFont(FontLibrary.FontType.SIMPLE, FontLibrary.FontSize.SMALLER,</span>
<span class="nc" id="L651">									Font.BOLD | Font.ITALIC, lib.getScaleFactor())</span>
<span class="nc" id="L652">							: FontLibrary.createFont(FontLibrary.FontType.SIMPLE, FontLibrary.FontSize.TINY, Font.BOLD,</span>
<span class="nc" id="L653">									lib.getScaleFactor());</span>
<span class="nc" id="L654">					BufferedImage stringImage = lib.getStringImage(g, populationString, theColor, font);</span>
<span class="nc" id="L655">					displayCenteredImage(g, stringImage);</span>
				}

<span class="nc bnc" id="L658" title="All 2 branches missed.">			} else if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L659">				IndianSettlement is = (IndianSettlement) settlement;</span>
<span class="nc" id="L660">				BufferedImage settlementImage = lib.getSettlementImage(settlement);</span>

				// Draw image of indian settlement in center of the tile.
<span class="nc" id="L663">				displayCenteredImage(g, settlementImage);</span>

				BufferedImage chip;
<span class="nc" id="L666">				float xOffset = STATE_OFFSET_X * lib.getScaleFactor();</span>
<span class="nc" id="L667">				float yOffset = STATE_OFFSET_Y * lib.getScaleFactor();</span>
<span class="nc" id="L668">				final int colonyLabels = freeColClient.getClientOptions().getInteger(ClientOptions.COLONY_LABELS);</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">				if (colonyLabels != ClientOptions.COLONY_LABELS_MODERN) {</span>
					// Draw the settlement chip
<span class="nc" id="L671">					chip = lib.getIndianSettlementChip(g, is);</span>
<span class="nc" id="L672">					g.drawImage(chip, (int) xOffset, (int) yOffset, null);</span>
<span class="nc" id="L673">					xOffset += chip.getWidth() + 2;</span>

					// Draw the mission chip if needed.
<span class="nc" id="L676">					Unit missionary = is.getMissionary();</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">					if (missionary != null) {</span>
<span class="nc" id="L678">						boolean expert = missionary.hasAbility(Ability.EXPERT_MISSIONARY);</span>
<span class="nc" id="L679">						g.drawImage(lib.getMissionChip(g, missionary.getOwner(), expert), (int) xOffset, (int) yOffset,</span>
								null);
<span class="nc" id="L681">						xOffset += chip.getWidth() + 2;</span>
					}
				}

				// Draw the alarm chip if needed.
<span class="nc bnc" id="L686" title="All 2 branches missed.">				if ((chip = lib.getAlarmChip(g, is, player)) != null) {</span>
<span class="nc" id="L687">					g.drawImage(chip, (int) xOffset, (int) yOffset, null);</span>
				}
<span class="nc" id="L689">			} else {</span>
<span class="nc" id="L690">				logger.warning(&quot;Bogus settlement: &quot; + settlement);</span>
			}
		}
<span class="nc" id="L693">	}</span>

	/**
	 * Displays the given tile's items onto the given Graphics2D object.
	 * Additions and improvements to Tile will be drawn. Only works for explored
	 * tiles.
	 *
	 * @param g
	 *            The Graphics2D object on which to draw the Tile.
	 * @param tile
	 *            The Tile to draw.
	 * @param overlayImage
	 *            The BufferedImage for the tile overlay.
	 */
	void displayTileItems(Graphics2D g, Tile tile, BufferedImage overlayImage) {
		// ATTENTION: we assume that only overlays and forests
		// might be taller than a tile.

		// layer additions and improvements according to zIndex
<span class="nc bnc" id="L712" title="All 2 branches missed.">		List&lt;TileItem&gt; tileItems = (tile.getTileItemContainer() != null) ? tile.getTileItemContainer().getTileItems()</span>
				: new ArrayList&lt;TileItem&gt;();
<span class="nc" id="L714">		int startIndex = 0;</span>
<span class="nc bnc" id="L715" title="All 2 branches missed.">		for (int index = startIndex; index &lt; tileItems.size(); index++) {</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">			if (tileItems.get(index).getZIndex() &lt; Tile.OVERLAY_ZINDEX) {</span>
<span class="nc" id="L717">				displayTileItem(g, tile, tileItems.get(index));</span>
<span class="nc" id="L718">				startIndex = index + 1;</span>
			} else {
<span class="nc" id="L720">				startIndex = index;</span>
<span class="nc" id="L721">				break;</span>
			}
		}
		// Tile Overlays (eg. hills and mountains)
<span class="nc bnc" id="L725" title="All 2 branches missed.">		if (overlayImage != null) {</span>
<span class="nc" id="L726">			g.drawImage(overlayImage, 0, (tileHeight - overlayImage.getHeight()), null);</span>
		}
<span class="nc bnc" id="L728" title="All 2 branches missed.">		for (int index = startIndex; index &lt; tileItems.size(); index++) {</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">			if (tileItems.get(index).getZIndex() &lt; Tile.FOREST_ZINDEX) {</span>
<span class="nc" id="L730">				displayTileItem(g, tile, tileItems.get(index));</span>
<span class="nc" id="L731">				startIndex = index + 1;</span>
			} else {
<span class="nc" id="L733">				startIndex = index;</span>
<span class="nc" id="L734">				break;</span>
			}
		}
		// Forest
<span class="nc bnc" id="L738" title="All 2 branches missed.">		if (tile.isForested()) {</span>
<span class="nc" id="L739">			BufferedImage forestImage = lib.getForestImage(tile.getType(), tile.getRiverStyle());</span>
<span class="nc" id="L740">			g.drawImage(forestImage, 0, (tileHeight - forestImage.getHeight()), null);</span>
		}

		// draw all remaining items
<span class="nc bnc" id="L744" title="All 2 branches missed.">		for (TileItem ti : tileItems.subList(startIndex, tileItems.size())) {</span>
<span class="nc" id="L745">			displayTileItem(g, tile, ti);</span>
<span class="nc" id="L746">		}</span>
<span class="nc" id="L747">	}</span>

	/**
	 * Draws the given TileItem on the given Tile.
	 *
	 * @param g
	 *            the g
	 * @param tile
	 *            the tile
	 * @param item
	 *            the item
	 */
	private void displayTileItem(Graphics2D g, Tile tile, TileItem item) {
<span class="nc bnc" id="L760" title="All 2 branches missed.">		if (item instanceof TileImprovement) {</span>
<span class="nc" id="L761">			displayTileImprovement(g, tile, (TileImprovement) item);</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">		} else if (item instanceof LostCityRumour) {</span>
<span class="nc" id="L763">			displayLostCityRumour(g);</span>
		} else {
<span class="nc" id="L765">			displayResourceTileItem(g, (Resource) item);</span>
		}
<span class="nc" id="L767">	}</span>

	/**
	 * Display resource tile item.
	 *
	 * @param g
	 *            the g
	 * @param item
	 *            the item
	 */
	private void displayResourceTileItem(Graphics2D g, Resource item) {
<span class="nc" id="L778">		BufferedImage bonusImage = lib.getMiscImage(&quot;image.tileitem.&quot; + item.getType().getId());</span>
<span class="nc" id="L779">		displayCenteredImage(g, bonusImage);</span>
<span class="nc" id="L780">	}</span>

	/**
	 * Display lost city rumour.
	 *
	 * @param g
	 *            the g
	 */
	private void displayLostCityRumour(Graphics2D g) {
<span class="nc" id="L789">		displayCenteredImage(g, lib.getMiscImage(ImageLibrary.LOST_CITY_RUMOUR));</span>
<span class="nc" id="L790">	}</span>

	/**
	 * Display tile improvement.
	 *
	 * @param g
	 *            the g
	 * @param tile
	 *            the tile
	 * @param ti
	 *            the ti
	 */
	private void displayTileImprovement(Graphics2D g, Tile tile, TileImprovement ti) {
<span class="nc bnc" id="L803" title="All 2 branches missed.">		if (ti.isComplete()) {</span>
<span class="nc bnc" id="L804" title="All 2 branches missed.">			if (ti.isRoad()) {</span>
<span class="nc" id="L805">				rp.displayRoad(g, tile);</span>
<span class="nc bnc" id="L806" title="All 4 branches missed.">			} else if (ti.isRiver() &amp;&amp; ti.getMagnitude() &lt; TileImprovement.FJORD_RIVER) {</span>
				// @compat 0.10.5
				// America_large had some bogus rivers in 0.10.5
<span class="nc bnc" id="L809" title="All 2 branches missed.">				if (ti.getStyle() != null)</span>
					// end @compat 0.10.5
<span class="nc" id="L811">					g.drawImage(lib.getRiverImage(ti.getStyle()), 0, 0, null);</span>
			} else {
<span class="nc" id="L813">				String key = &quot;image.tile.&quot; + ti.getType().getId();</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">				if (ResourceManager.hasImageResource(key)) {</span>
					// Has its own Overlay Image in Misc, use it
<span class="nc" id="L816">					BufferedImage overlay = ResourceManager.getImage(key, lib.tileSize);</span>
<span class="nc" id="L817">					g.drawImage(overlay, 0, 0, null);</span>
				}
			}
		}
<span class="nc" id="L821">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>