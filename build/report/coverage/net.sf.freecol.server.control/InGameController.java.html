<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InGameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.control</a> &gt; <span class="el_source">InGameController.java</span></div><h1>InGameController.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.control;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import net.sf.freecol.FreeCol;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.i18n.NameCache;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.BuildableType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.CombatModel.CombatResult;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.DiplomaticTrade.TradeStatus;
import net.sf.freecol.common.model.Disaster;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.ExportData;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsLocation;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.HighSeas;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianNationType;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.Market.Access;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Monarch;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.Nameable;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.Ownable;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.PlayerType;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.RandomRange;
import net.sf.freecol.common.model.Region;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovement;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TradeItem;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitLocation;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.networking.ChatMessage;
import net.sf.freecol.common.networking.Connection;
import net.sf.freecol.common.networking.DOMMessage;
import net.sf.freecol.common.networking.DiplomacyMessage;
import net.sf.freecol.common.networking.GoodsForSaleMessage;
import net.sf.freecol.common.networking.IndianDemandMessage;
import net.sf.freecol.common.networking.LootCargoMessage;
import net.sf.freecol.common.networking.MonarchActionMessage;
import net.sf.freecol.common.networking.RearrangeColonyMessage;
import net.sf.freecol.common.networking.RearrangeColonyMessage.UnitChange;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import net.sf.freecol.common.util.Utils;

import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;

import net.sf.freecol.server.FreeColServer;
import net.sf.freecol.server.ai.AIPlayer;
import net.sf.freecol.server.ai.REFAIPlayer;
import net.sf.freecol.server.control.ChangeSet.ChangePriority;
import net.sf.freecol.server.control.ChangeSet.See;
import net.sf.freecol.server.model.DiplomacySession;
import net.sf.freecol.server.model.LootSession;
import net.sf.freecol.server.model.MonarchSession;
import net.sf.freecol.server.model.ServerColony;
import net.sf.freecol.server.model.ServerEurope;
import net.sf.freecol.server.model.ServerGame;
import net.sf.freecol.server.model.ServerIndianSettlement;
import net.sf.freecol.server.model.ServerPlayer;
import net.sf.freecol.server.model.ServerRegion;
import net.sf.freecol.server.model.ServerUnit;
import net.sf.freecol.server.model.TradeSession;
import net.sf.freecol.server.model.TransactionSession;

import org.w3c.dom.Element;

/**
 * The main server controller.
 */
public final class InGameController extends Controller {

	/** The Constant logger. */
<span class="fc" id="L151">	private static final Logger logger = Logger.getLogger(InGameController.class.getName());</span>

	/** The server random number source. */
	private final Random random;

	/** Debug helpers, do not serialize. */
<span class="fc" id="L157">	private int debugOnlyAITurns = 0;</span>

	/** The debug monarch action. */
<span class="fc" id="L160">	private MonarchAction debugMonarchAction = null;</span>

	/** The debug monarch player. */
<span class="fc" id="L163">	private ServerPlayer debugMonarchPlayer = null;</span>

	/**
	 * The constructor to use.
	 *
	 * @param freeColServer
	 *            The main server object.
	 * @param random
	 *            The pseudo-random number source to use.
	 */
	public InGameController(FreeColServer freeColServer, Random random) {
<span class="fc" id="L174">		super(freeColServer);</span>

<span class="fc" id="L176">		this.random = random;</span>
<span class="fc" id="L177">	}</span>

	/**
	 * Gets the number of AI turns to skip through.
	 *
	 * @return The number of terms to skip.
	 */
	public int getSkippedTurns() {
<span class="nc bnc" id="L185" title="All 2 branches missed.">		return (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) ? debugOnlyAITurns : -1;</span>
	}

	/**
	 * Sets the number of AI turns to skip through as a debug helper.
	 *
	 * @param turns
	 *            The number of turns to skip through.
	 */
	public void setSkippedTurns(int turns) {
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L196">			debugOnlyAITurns = turns;</span>
		}
<span class="nc" id="L198">	}</span>

	/**
	 * Sets a monarch action to debug/test.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; whose monarch should act.
	 * @param action
	 *            The &lt;code&gt;MonarchAction&lt;/code&gt; to be taken.
	 */
	public void setMonarchAction(ServerPlayer serverPlayer, MonarchAction action) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L210">			debugMonarchPlayer = serverPlayer;</span>
<span class="nc" id="L211">			debugMonarchAction = action;</span>
		}
<span class="nc" id="L213">	}</span>

	/**
	 * Debug convenience to step the random number generator.
	 *
	 * @return The next random number in series, in the range 0-99.
	 */
	public int stepRandom() {
<span class="nc" id="L221">		return randomInt(logger, &quot;step random&quot;, random, 100);</span>
	}

	/**
	 * Public version of the yearly goods adjust (public so it can be use in the
	 * Market test code). Sends the market and change messages to the player.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; whose market is to be updated.
	 */
	public void yearlyGoodsAdjust(ServerPlayer serverPlayer) {
<span class="fc" id="L232">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L233">		serverPlayer.csYearlyGoodsAdjust(random, cs);</span>
<span class="fc" id="L234">		serverPlayer.send(cs);</span>
<span class="fc" id="L235">	}</span>

	/**
	 * Public version of csAddFoundingFather so it can be used in the test code
	 * and DebugMenu.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; who gains a father.
	 * @param father
	 *            The &lt;code&gt;FoundingFather&lt;/code&gt; to add.
	 */
	public void addFoundingFather(ServerPlayer serverPlayer, FoundingFather father) {
<span class="fc" id="L247">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L248">		serverPlayer.csAddFoundingFather(father, random, cs);</span>
<span class="fc" id="L249">		cs.addAttribute(See.only(serverPlayer), &quot;flush&quot;, Boolean.TRUE.toString());</span>
<span class="fc" id="L250">		serverPlayer.send(cs);</span>
<span class="fc" id="L251">	}</span>

	/**
	 * Public change stance and inform all routine. Mostly used in the test
	 * suite, but the AIs also call it.
	 *
	 * @param serverPlayer
	 *            The originating &lt;code&gt;ServerPlayer&lt;/code&gt;.
	 * @param stance
	 *            The new &lt;code&gt;Stance&lt;/code&gt;.
	 * @param other
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; wrt which the stance changes.
	 * @param symmetric
	 *            If true, change the otherPlayer stance as well.
	 */
	public void changeStance(ServerPlayer serverPlayer, Stance stance, ServerPlayer other, boolean symmetric) {
<span class="fc" id="L267">		ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">		if (serverPlayer.csChangeStance(stance, other, symmetric, cs)) {</span>
<span class="fc" id="L269">			getGame().sendToAll(cs);</span>
		}
<span class="fc" id="L271">	}</span>

	/**
	 * Change colony owner. Public for DebugUtils.
	 *
	 * @param colony
	 *            The &lt;code&gt;ServerColony&lt;/code&gt; to change.
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to change to.
	 */
	public void debugChangeOwner(ServerColony colony, ServerPlayer serverPlayer) {
<span class="fc" id="L282">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L283">		ServerPlayer owner = (ServerPlayer) colony.getOwner();</span>
<span class="fc" id="L284">		colony.csChangeOwner(serverPlayer, cs);// -vis(serverPlayer,owner)</span>
<span class="fc" id="L285">		cs.add(See.perhaps().always(owner), colony.getOwnedTiles());</span>
<span class="fc" id="L286">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="fc" id="L287">		owner.invalidateCanSeeTiles();// +vis(owner)</span>
<span class="fc" id="L288">		getGame().sendToAll(cs);</span>
<span class="fc" id="L289">	}</span>

	/**
	 * Change unit owner. Public for DebugUtils.
	 *
	 * @param unit
	 *            The &lt;code&gt;ServerUnit&lt;/code&gt; to change.
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to change to.
	 */
	public void debugChangeOwner(ServerUnit unit, ServerPlayer serverPlayer) {
<span class="nc" id="L300">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L301">		ServerPlayer owner = (ServerPlayer) unit.getOwner();</span>
<span class="nc" id="L302">		owner.csChangeOwner(unit, serverPlayer, null, null, cs);// -vis(serverPlayer,owner)</span>
<span class="nc" id="L303">		cs.add(See.perhaps().always(owner), unit.getTile());</span>
<span class="nc" id="L304">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L305">		owner.invalidateCanSeeTiles();// +vis(owner)</span>
<span class="nc" id="L306">		getGame().sendToAll(cs);</span>
<span class="nc" id="L307">	}</span>

	/**
	 * Apply a disaster to a colony. Public for DebugUtils.
	 *
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to apply the disaster to.
	 * @param disaster
	 *            The &lt;code&gt;Disaster&lt;/code&gt; to apply.
	 * @return The number of messages generated.
	 */
	public int debugApplyDisaster(ServerColony colony, Disaster disaster) {
<span class="nc" id="L319">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L320">		ServerPlayer owner = (ServerPlayer) colony.getOwner();</span>
<span class="nc" id="L321">		List&lt;ModelMessage&gt; messages = owner.csApplyDisaster(random, colony, disaster, cs);</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (!messages.isEmpty()) {</span>
<span class="nc" id="L323">			cs.addMessage(See.all(), new ModelMessage(ModelMessage.MessageType.DEFAULT, &quot;model.disaster.strikes&quot;, owner)</span>
<span class="nc" id="L324">					.addName(&quot;%colony%&quot;, colony.getName()).addName(&quot;%disaster%&quot;, disaster));</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">			for (ModelMessage message : messages) {</span>
<span class="nc" id="L326">				cs.addMessage(See.all(), message);</span>
<span class="nc" id="L327">			}</span>
<span class="nc" id="L328">			getGame().sendToAll(cs);</span>
		}
<span class="nc" id="L330">		return messages.size();</span>
	}

	/**
	 * Move goods from one location to another.
	 *
	 * @param src
	 *            The source &lt;code&gt;GoodsLocation&lt;/code&gt;.
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to move.
	 * @param amount
	 *            The amount of goods to move.
	 * @param dst
	 *            The new &lt;code&gt;GoodsLocation&lt;/code&gt;.
	 */
	private void moveGoods(GoodsLocation src, GoodsType goodsType, int amount, GoodsLocation dst) {
<span class="fc" id="L346">		src.getGoodsContainer().saveState();</span>
<span class="fc" id="L347">		src.removeGoods(goodsType, amount);</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">		if (dst != null) {</span>
<span class="fc" id="L349">			dst.getGoodsContainer().saveState();</span>
<span class="fc" id="L350">			dst.addGoods(goodsType, amount);</span>
		}
<span class="fc" id="L352">	}</span>

	/**
	 * Gets a nation summary.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is querying.
	 * @param player
	 *            The &lt;code&gt;Player&lt;/code&gt; to summarize.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public NationSummary getNationSummary(ServerPlayer serverPlayer, Player player) {
<span class="fc" id="L364">		return new NationSummary(player, serverPlayer);</span>
	}

	/**
	 * Create the Royal Expeditionary Force player corresponding to a given
	 * player that is about to rebel.
	 *
	 * Public for the test suite.
	 *
	 * FIXME: this should eventually generate changes for the REF player.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; about to rebel.
	 * @return The REF player.
	 */
	public ServerPlayer createREFPlayer(ServerPlayer serverPlayer) {
<span class="fc" id="L380">		Nation refNation = serverPlayer.getNation().getREFNation();</span>
<span class="fc" id="L381">		Monarch monarch = serverPlayer.getMonarch();</span>
<span class="fc" id="L382">		ServerPlayer refPlayer = getFreeColServer().makeAIPlayer(refNation);</span>
<span class="fc" id="L383">		Europe europe = refPlayer.getEurope();</span>
		// Inherit rebel player knowledge of the seas, coasts, claimed
		// land but not full detailed scouting knowledge.
<span class="fc" id="L386">		Set&lt;Tile&gt; explore = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">		for (Tile t : getGame().getMap().getAllTiles()) {</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">			if (!t.isExploredBy(serverPlayer))</span>
<span class="fc" id="L389">				continue;</span>
<span class="nc bnc" id="L390" title="All 6 branches missed.">			if (!t.isLand() || t.isCoastland() || t.getOwner() == serverPlayer) {</span>
<span class="nc" id="L391">				explore.add(t);</span>
			}
<span class="nc" id="L393">		}</span>
<span class="fc" id="L394">		refPlayer.exploreTiles(explore);</span>

		// Trigger initial placement routine
<span class="fc" id="L397">		refPlayer.setEntryLocation(null);</span>
		// Will change, setup only
<span class="fc" id="L399">		Player.makeContact(serverPlayer, refPlayer);</span>

		// Instantiate the REF in Europe
<span class="fc" id="L402">		Monarch.Force exf = monarch.getExpeditionaryForce();</span>
		// @compat 0.10.5
		// There was a bug that seriously under provisioned the navy back
		// around 0.10.5, the game in BR#2435 has it. For now, just add
		// enough ships to carry all the units.
<span class="fc" id="L407">		UnitType ut = monarch.getNavalREFUnitType();</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">		while (exf.getSpaceRequired() &gt; exf.getCapacity()) {</span>
<span class="fc" id="L409">			AbstractUnit au = new AbstractUnit(ut, Specification.DEFAULT_ROLE_ID, 1);</span>
<span class="fc" id="L410">			exf.add(au);</span>
<span class="fc" id="L411">		}</span>
		// end @compat 0.10.5
<span class="fc" id="L413">		List&lt;Unit&gt; landUnits = refPlayer.createUnits(exf.getLandUnits(), europe);// -vis:</span>
																					// safe!map
<span class="fc" id="L415">		List&lt;Unit&gt; navalUnits = refPlayer.createUnits(exf.getNavalUnits(), europe);// -vis:</span>
																					// safe!map
<span class="fc" id="L417">		refPlayer.loadShips(landUnits, navalUnits, random);// -vis: safe!map</span>
<span class="fc" id="L418">		return refPlayer;</span>
	}

	// Client-server communication utilities

	// A handler interface to pass to askFuture().
	/**
	 * The Interface DOMMessageHandler.
	 */
	// This will change from DOMMessage to Message when DOM goes away.
	private interface DOMMessageHandler {

		/**
		 * Handle.
		 *
		 * @param message
		 *            the message
		 * @return the DOM message
		 */
		public DOMMessage handle(DOMMessage message);
	};

	/**
	 * The Class DOMMessageCallable.
	 */
	private static class DOMMessageCallable implements Callable&lt;DOMMessage&gt; {

		/** The connection. */
		private final Connection connection;

		/** The game. */
		private final Game game;

		/** The message. */
		private final DOMMessage message;

		/** The handler. */
		private final DOMMessageHandler handler;

		/**
		 * Instantiates a new DOM message callable.
		 *
		 * @param connection
		 *            the connection
		 * @param game
		 *            the game
		 * @param message
		 *            the message
		 * @param handler
		 *            the handler
		 */
<span class="nc" id="L469">		public DOMMessageCallable(Connection connection, Game game, DOMMessage message, DOMMessageHandler handler) {</span>
<span class="nc" id="L470">			this.connection = connection;</span>
<span class="nc" id="L471">			this.game = game;</span>
<span class="nc" id="L472">			this.message = message;</span>
<span class="nc" id="L473">			this.handler = handler;</span>
<span class="nc" id="L474">		}</span>

		/*
		 * (non-Javadoc)
		 * 
		 * @see java.util.concurrent.Callable#call()
		 */
		@Override
		public DOMMessage call() {
			Element reply;
			try {
<span class="nc" id="L485">				reply = connection.ask(message.toXMLElement());</span>
<span class="nc" id="L486">			} catch (IOException e) {</span>
<span class="nc" id="L487">				return null;</span>
<span class="nc" id="L488">			}</span>
<span class="nc" id="L489">			DOMMessage replyMessage = DOMMessage.createMessage(game, reply);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">			return (replyMessage == null) ? null : handler.handle(replyMessage);</span>
		}
	};

	/** The executor. */
	// A service to run the futures.
<span class="fc" id="L496">	private final ExecutorService executor = Executors.newCachedThreadPool();</span>

	/**
	 * Asks a question of a player in a Future.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to ask.
	 * @param question
	 *            The &lt;code&gt;DOMMessage&lt;/code&gt; question.
	 * @param handler
	 *            The &lt;code&gt;DOMMessageHandler&lt;/code&gt; handler to process the
	 *            reply with.
	 * @return A future encapsulating the result.
	 */
	private Future&lt;DOMMessage&gt; askFuture(ServerPlayer serverPlayer, DOMMessage question, DOMMessageHandler handler) {
<span class="nc" id="L511">		Callable&lt;DOMMessage&gt; callable = new DOMMessageCallable(serverPlayer.getConnection(), getGame(), question,</span>
				handler);
<span class="nc" id="L513">		return executor.submit(callable);</span>
	}

	/**
	 * Asks a question of a player with a timeout.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to ask.
	 * @param request
	 *            The &lt;code&gt;DOMMessage&lt;/code&gt; question.
	 * @return The response to the question, or null if none.
	 */
	private DOMMessage askTimeout(ServerPlayer serverPlayer, DOMMessage request) {
<span class="nc" id="L526">		Future&lt;DOMMessage&gt; future = askFuture(serverPlayer, request, new DOMMessageHandler() {</span>
			@Override
			public DOMMessage handle(DOMMessage message) {
<span class="nc" id="L529">				return message;</span>
			}
		});
		DOMMessage reply;
		try {
<span class="nc" id="L534">			boolean single = getFreeColServer().getSinglePlayer();</span>
<span class="nc" id="L535">			reply = future.get(FreeCol.getTimeout(single), TimeUnit.SECONDS);</span>
<span class="nc" id="L536">		} catch (TimeoutException te) {</span>
<span class="nc" id="L537">			serverPlayer.send(</span>
<span class="nc" id="L538">					new ChangeSet().addTrivial(See.only(serverPlayer), &quot;closeMenus&quot;, ChangePriority.CHANGE_NORMAL));</span>
<span class="nc" id="L539">			reply = null;</span>
<span class="nc" id="L540">		} catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L541">			reply = null;</span>
<span class="nc" id="L542">			logger.log(Level.WARNING, &quot;Exception completing future&quot;, e);</span>
<span class="nc" id="L543">		}</span>
<span class="nc" id="L544">		return reply;</span>
	}

	/**
	 * Visits a native settlement, possibly scouting it full if it is as a
	 * result of a scout actually asking to speak to the chief, or for other
	 * settlement-contacting events such as missionary actions, demanding
	 * tribute, learning skills and trading if the settlementActionsContactChief
	 * game option is enabled. It is still unclear what Col1 did here.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is contacting the
	 *            settlement.
	 * @param is
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; to contact.
	 * @param scout
	 *            Positive if this contact is due to a scout asking to speak to
	 *            the chief, zero if it is another unit, negative if this is
	 *            from the greeting dialog generation.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csVisit(ServerPlayer serverPlayer, IndianSettlement is, int scout, ChangeSet cs) {
<span class="fc" id="L567">		final ServerPlayer owner = (ServerPlayer) is.getOwner();</span>
<span class="pc bpc" id="L568" title="1 of 2 branches missed.">		if (serverPlayer.csContact(owner, cs)) {</span>
<span class="fc" id="L569">			serverPlayer.csNativeFirstContact(owner, null, cs);</span>
		}
<span class="fc" id="L571">		is.setVisited(serverPlayer);</span>
<span class="pc bpc" id="L572" title="2 of 4 branches missed.">		if (scout &gt; 0 || (scout == 0</span>
<span class="pc bpc" id="L573" title="1 of 2 branches missed.">				&amp;&amp; getGame().getSpecification().getBoolean(GameOptions.SETTLEMENT_ACTIONS_CONTACT_CHIEF))) {</span>
<span class="nc" id="L574">			is.setScouted(serverPlayer);</span>
		}
<span class="fc" id="L576">	}</span>

	// Routines that follow implement the controller response to
	// messages.
	// The convention is to return an element to be passed back to the
	// client by the invoking message handler.

	/**
	 * Ends the turn of the given player.
	 *
	 * Note: sends messages to other players.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to end the turn of.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating the end of turn changes for
	 *         the given player.
	 */
	public Element endTurn(ServerPlayer serverPlayer) {
<span class="nc" id="L594">		final FreeColServer freeColServer = getFreeColServer();</span>
<span class="nc" id="L595">		final ServerGame game = getGame();</span>
<span class="nc" id="L596">		final ServerPlayer winner = (ServerPlayer) game.checkForWinner();</span>

<span class="nc" id="L598">		ServerPlayer player = (ServerPlayer) game.getCurrentPlayer();</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">		if (serverPlayer != player) {</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">			throw new IllegalArgumentException(&quot;It is not &quot; + serverPlayer.getName() + &quot;'s turn, it is &quot;</span>
<span class="nc" id="L601">					+ ((player == null) ? &quot;noone&quot; : player.getName()) + &quot;'s!&quot;);</span>
		}

		for (;;) {
<span class="nc" id="L605">			logger.finest(&quot;Ending turn for &quot; + player.getName());</span>
<span class="nc" id="L606">			player.clearModelMessages();</span>

			// Check for new turn
<span class="nc" id="L609">			ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">			if (game.isNextPlayerInNewTurn()) {</span>
<span class="nc" id="L611">				ChangeSet next = new ChangeSet();</span>
<span class="nc" id="L612">				game.csNextTurn(next);</span>
<span class="nc" id="L613">				game.sendToAll(next);</span>

<span class="nc" id="L615">				LogBuilder lb = new LogBuilder(512);</span>
<span class="nc" id="L616">				lb.add(&quot;New turn &quot;, game.getTurn(), &quot; for &quot;);</span>
<span class="nc" id="L617">				game.csNewTurn(random, lb, cs);</span>
<span class="nc" id="L618">				lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L619">				lb.log(logger, Level.FINEST);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">				if (debugOnlyAITurns &gt; 0) {</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">					if (--debugOnlyAITurns &lt;= 0) {</span>
						// If this was a debug run, complete it. This will
						// signal the client to save and quit at the next
						// suitable opportunity.
<span class="nc" id="L625">						FreeColDebugger.signalEndDebugRun();</span>
					}
				}
			}

<span class="nc bnc" id="L630" title="All 2 branches missed.">			if ((player = (ServerPlayer) game.getNextPlayer()) == null) {</span>
				// &quot;can not happen&quot;
<span class="nc" id="L632">				return DOMMessage.clientError(&quot;Can not get next player&quot;);</span>
			}

			// Remove dead players and retry
<span class="nc bnc" id="L636" title="All 3 branches missed.">			switch (player.checkForDeath()) {</span>
			case ServerPlayer.IS_DEAD:
<span class="nc" id="L638">				player.csWithdraw(cs);</span>
<span class="nc" id="L639">				logger.info(&quot;For &quot; + serverPlayer.getSuffix() + &quot;, &quot; + player.getNation() + &quot; is dead.&quot;);</span>
<span class="nc" id="L640">				game.sendToAll(cs, player);</span>
<span class="nc" id="L641">				continue;</span>
			case ServerPlayer.IS_ALIVE:
<span class="nc bnc" id="L643" title="All 4 branches missed.">				if (player.isREF() &amp;&amp; player.checkForREFDefeat()) {</span>
<span class="nc bnc" id="L644" title="All 2 branches missed.">					for (Player p : player.getRebels()) {</span>
<span class="nc" id="L645">						csGiveIndependence(player, (ServerPlayer) p, cs);</span>
<span class="nc" id="L646">					}</span>
<span class="nc" id="L647">					player.csWithdraw(cs);</span>
<span class="nc" id="L648">					logger.info(player.getNation() + &quot; is defeated.&quot;);</span>
<span class="nc" id="L649">					game.sendToAll(cs, player);</span>
<span class="nc" id="L650">					continue;</span>
				}
				break;
			default: // Need to autorecruit a unit to keep alive.
<span class="nc" id="L654">				player.csEmigrate(0, MigrationType.SURVIVAL, random, cs);</span>
				break;
			}
			// Are there humans left?
			// FIXME: see if this can be relaxed so we can run large
			// AI-only simulations.
<span class="nc" id="L660">			boolean onlyAI = all(game.getConnectedPlayers(), Player::isAI);</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">			if (onlyAI) {</span>
<span class="nc" id="L662">				logger.info(&quot;No human player left.&quot;);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">				if (debugOnlyAITurns &gt; 0) { // Complete debug runs</span>
<span class="nc" id="L664">					FreeColDebugger.signalEndDebugRun();</span>
				}
<span class="nc" id="L666">				game.setCurrentPlayer(null);</span>

<span class="nc" id="L668">				cs.addTrivial(See.all(), &quot;gameEnded&quot;, ChangePriority.CHANGE_NORMAL);</span>
<span class="nc" id="L669">				game.sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L670">				return cs.build(serverPlayer);</span>
			}

			// Has the player won?
			// Do not end single player games where an AI has won,
			// that would stop revenge mode.
<span class="nc bnc" id="L676" title="All 6 branches missed.">			if (winner == player &amp;&amp; !(freeColServer.getSinglePlayer() &amp;&amp; winner.isAI())) {</span>
<span class="nc bnc" id="L677" title="All 4 branches missed.">				boolean highScore = !winner.isAI() &amp;&amp; HighScore.newHighScore(winner);</span>
<span class="nc" id="L678">				cs.addTrivial(See.all(), &quot;gameEnded&quot;, ChangePriority.CHANGE_NORMAL, &quot;highScore&quot;,</span>
<span class="nc" id="L679">						String.valueOf(highScore), &quot;winner&quot;, winner.getId());</span>
			}

			// Do &quot;new turn&quot;-like actions that need to wait until right
			// before the player is about to move.
<span class="nc" id="L684">			game.setCurrentPlayer(player);</span>
<span class="nc bnc" id="L685" title="All 4 branches missed.">			if (player.isREF() &amp;&amp; player.getEntryLocation() == null) {</span>
				// Initialize this newly created REF
				// If the teleportREF option is enabled, teleport it in.
<span class="nc" id="L688">				REFAIPlayer refAIPlayer = (REFAIPlayer) freeColServer.getAIPlayer(player);</span>
<span class="nc" id="L689">				boolean teleport = game.getSpecification().getBoolean(GameOptions.TELEPORT_REF);</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">				if (refAIPlayer.initialize(teleport)) {</span>
<span class="nc" id="L691">					csLaunchREF(player, teleport, cs);</span>
				} else {
<span class="nc" id="L693">					logger.severe(&quot;REF failed to initialize.&quot;);</span>
				}
			}
<span class="nc" id="L696">			player.csStartTurn(random, cs);</span>

<span class="nc" id="L698">			cs.addTrivial(See.all(), &quot;setCurrentPlayer&quot;, ChangePriority.CHANGE_LATE, &quot;player&quot;, player.getId());</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">			if (player.getPlayerType() == PlayerType.COLONIAL) {</span>
<span class="nc" id="L700">				Monarch monarch = player.getMonarch();</span>
<span class="nc" id="L701">				MonarchAction action = null;</span>
<span class="nc bnc" id="L702" title="All 4 branches missed.">				if (debugMonarchAction != null &amp;&amp; player == debugMonarchPlayer) {</span>
<span class="nc" id="L703">					action = debugMonarchAction;</span>
<span class="nc" id="L704">					debugMonarchAction = null;</span>
<span class="nc" id="L705">					debugMonarchPlayer = null;</span>
<span class="nc" id="L706">					logger.finest(&quot;Debug monarch action: &quot; + action);</span>
				} else {
<span class="nc" id="L708">					action = RandomChoice.getWeightedRandom(logger, &quot;Choose monarch action&quot;, monarch.getActionChoices(),</span>
							random);
				}
<span class="nc bnc" id="L711" title="All 2 branches missed.">				if (action != null) {</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">					if (monarch.actionIsValid(action)) {</span>
<span class="nc" id="L713">						logger.finest(&quot;Monarch action: &quot; + action);</span>
<span class="nc" id="L714">						csMonarchAction(player, action, cs);</span>
					} else {
<span class="nc" id="L716">						logger.finest(&quot;Skipping invalid monarch action: &quot; + action);</span>
					}
				}
			}

			// Flush accumulated changes. Send to all players, but
			// take care that the new player is last so that it does
			// not immediately start moving and cause further changes
			// which conflict with these updates. Finally return to the
			// current player which requested the end-of-turn, unless
			// it is doing a debug run.
<span class="nc bnc" id="L727" title="All 6 branches missed.">			boolean debugSkip = !player.isAI() &amp;&amp; freeColServer.getSinglePlayer() &amp;&amp; debugOnlyAITurns &gt; 0;</span>
<span class="nc bnc" id="L728" title="All 2 branches missed.">			if (debugSkip) {</span>
<span class="nc" id="L729">				game.sendToOthers(player, cs);</span>
<span class="nc" id="L730">				player.send(cs);</span>
<span class="nc" id="L731">				continue;</span>
			}
<span class="nc" id="L733">			game.sendToList(game.getConnectedPlayers(player, serverPlayer), cs);</span>
<span class="nc bnc" id="L734" title="All 2 branches missed.">			if (player != serverPlayer)</span>
<span class="nc" id="L735">				player.send(cs);</span>
<span class="nc" id="L736">			return cs.build(serverPlayer);</span>
		}
	}

	/**
	 * Launch the REF.
	 *
	 * @param serverPlayer
	 *            The REF &lt;code&gt;ServerPlayer&lt;/code&gt;.
	 * @param teleport
	 *            If true, teleport the REF in.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csLaunchREF(ServerPlayer serverPlayer, boolean teleport, ChangeSet cs) {
		// Set the REF player entry location from the rebels. Note
		// that the REF units will have their own unit-specific entry
		// locations set by their missions. This just flags that the
		// REF is initialized.
<span class="nc bnc" id="L755" title="All 2 branches missed.">		for (Player p : serverPlayer.getRebels()) {</span>
<span class="nc" id="L756">			serverPlayer.setEntryLocation(p.getEntryLocation().getTile());</span>
<span class="nc" id="L757">			break;</span>
		}

<span class="nc bnc" id="L760" title="All 2 branches missed.">		if (teleport) { // Teleport in the units.</span>
<span class="nc" id="L761">			Set&lt;Tile&gt; seen = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L762" title="All 2 branches missed.">			for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L763" title="All 2 branches missed.">				if (!u.isNaval())</span>
<span class="nc" id="L764">					continue;</span>
<span class="nc" id="L765">				Tile entry = u.getEntryLocation().getTile();</span>
<span class="nc" id="L766">				u.setLocation(entry);// -vis(serverPlayer)</span>
<span class="nc" id="L767">				u.setWorkLeft(-1);</span>
<span class="nc" id="L768">				u.setState(Unit.UnitState.ACTIVE);</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">				if (!seen.contains(entry)) {</span>
<span class="nc" id="L770">					seen.add(entry);</span>
<span class="nc" id="L771">					cs.add(See.only(serverPlayer), serverPlayer.exploreForUnit(u));</span>
<span class="nc" id="L772">					cs.add(See.perhaps().except(serverPlayer), entry);</span>
				}
<span class="nc" id="L774">			}</span>
<span class="nc" id="L775">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L776">		} else {</span>
			// Put navy on the high seas, with 1-turn sail time
<span class="nc bnc" id="L778" title="All 2 branches missed.">			for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">				if (!u.isNaval())</span>
<span class="nc" id="L780">					continue;</span>
<span class="nc" id="L781">				u.setWorkLeft(1);</span>
<span class="nc" id="L782">				u.setDestination(u.getEntryLocation());</span>
<span class="nc" id="L783">				u.setLocation(u.getOwner().getHighSeas());// -vis: safe!map</span>
<span class="nc" id="L784">			}</span>
		}
<span class="nc" id="L786">	}</span>

	/**
	 * Give independence. Note that the REF player is granting, but most of the
	 * changes happen to the newly independent player. hence the special
	 * handling.
	 *
	 * @param serverPlayer
	 *            The REF &lt;code&gt;ServerPlayer&lt;/code&gt; that is granting.
	 * @param independent
	 *            The newly independent &lt;code&gt;ServerPlayer&lt;/code&gt;.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csGiveIndependence(ServerPlayer serverPlayer, ServerPlayer independent, ChangeSet cs) {
<span class="nc" id="L801">		serverPlayer.csChangeStance(Stance.PEACE, independent, true, cs);</span>
<span class="nc" id="L802">		independent.changePlayerType(PlayerType.INDEPENDENT);</span>
<span class="nc" id="L803">		Game game = getGame();</span>
<span class="nc" id="L804">		Turn turn = game.getTurn();</span>
<span class="nc" id="L805">		independent.setTax(0);</span>
<span class="nc" id="L806">		independent.reinitialiseMarket();</span>
<span class="nc" id="L807">		HistoryEvent h = new HistoryEvent(turn, HistoryEvent.HistoryEventType.INDEPENDENCE, independent);</span>

		// The score for actual independence is actually a percentage
		// bonus depending on how many other nations are independent.
		// If we ever go for a more complex scoring algorithm it might
		// be better to replace the score int with a Modifier, but for
		// now we just set the score value to the number of
		// independent players other than the one we are granting
		// here, and generate the bonus with a special case in
		// ServerPlayer.updateScore().
<span class="nc" id="L817">		int n = 0;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">		for (Player p : game.getLiveEuropeanPlayers(independent)) {</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">			if (p.getPlayerType() == PlayerType.INDEPENDENT)</span>
<span class="nc" id="L820">				n++;</span>
<span class="nc" id="L821">		}</span>
<span class="nc" id="L822">		h.setScore(n);</span>
<span class="nc" id="L823">		cs.addGlobalHistory(game, h);</span>
<span class="nc" id="L824">		cs.addMessage(See.only(independent),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;giveIndependence.announce&quot;, independent)
<span class="nc" id="L826">						.addStringTemplate(&quot;%ref%&quot;, serverPlayer.getNationLabel()));</span>

		// Who surrenders?
<span class="nc" id="L829">		List&lt;Unit&gt; surrenderUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">		for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L831" title="All 6 branches missed.">			if (u.hasTile() &amp;&amp; !u.isNaval() &amp;&amp; !u.isOnCarrier()</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">					&amp;&amp; serverPlayer.csChangeOwner(u, independent, ChangeType.CAPTURE, null, cs)) {// -vis(both)</span>
<span class="nc" id="L833">				u.setMovesLeft(0);</span>
<span class="nc" id="L834">				u.setState(Unit.UnitState.ACTIVE);</span>
<span class="nc" id="L835">				cs.add(See.perhaps().always(serverPlayer), u.getTile());</span>
<span class="nc" id="L836">				surrenderUnits.add(u);</span>
			}
<span class="nc" id="L838">		}</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">		if (!surrenderUnits.isEmpty()) {</span>
<span class="nc" id="L840">			cs.addMessage(See.only(independent),</span>
					new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;giveIndependence.unitsAcquired&quot;,
<span class="nc" id="L842">							independent).addStringTemplate(&quot;%units%&quot;, unitTemplate(&quot;, &quot;, surrenderUnits)));</span>
<span class="nc" id="L843">			independent.invalidateCanSeeTiles();// +vis(independent)</span>
<span class="nc" id="L844">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
		}

		// Update player type. Again, a pity to have to do a whole
		// player update, but a partial update works for other players.
<span class="nc" id="L849">		cs.addPartial(See.all().except(independent), independent, &quot;playerType&quot;);</span>
<span class="nc" id="L850">		cs.addMessage(See.all().except(independent),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;giveIndependence.otherAnnounce&quot;,
<span class="nc" id="L852">						independent).addStringTemplate(&quot;%nation%&quot;, independent.getNationLabel())</span>
<span class="nc" id="L853">								.addStringTemplate(&quot;%ref%&quot;, serverPlayer.getNationLabel()));</span>
<span class="nc" id="L854">		cs.add(See.only(independent), independent);</span>

		// Reveal the map on independence.
<span class="nc" id="L857">		cs.add(See.only(independent), independent.exploreMap(true));</span>
<span class="nc" id="L858">	}</span>

	/**
	 * Unit template.
	 *
	 * @param base
	 *            the base
	 * @param units
	 *            the units
	 * @return the string template
	 */
	private StringTemplate unitTemplate(String base, List&lt;Unit&gt; units) {
<span class="nc" id="L870">		StringTemplate template = StringTemplate.label(base);</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">		for (Unit u : units) {</span>
<span class="nc" id="L872">			template.addStringTemplate(u.getLabel(Unit.UnitLabelType.PLAIN));</span>
<span class="nc" id="L873">		}</span>
<span class="nc" id="L874">		return template;</span>
	}

	/**
	 * Resolves a tax raise.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; whose tax is rising.
	 * @param taxRaise
	 *            The amount of tax raise.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; for a goods party.
	 * @param result
	 *            Whether the tax was accepted or not.
	 */
	private void raiseTax(ServerPlayer serverPlayer, int taxRaise, Goods goods, boolean result) {
<span class="nc" id="L890">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L891">		serverPlayer.csRaiseTax(taxRaise, goods, result, cs);</span>
<span class="nc" id="L892">		serverPlayer.send(cs);</span>
<span class="nc" id="L893">	}</span>

	/**
	 * Performs a monarch action.
	 *
	 * Note that CHANGE_LATE is used so that these actions follow setting the
	 * current player, so that it is the players turn when they respond to a
	 * monarch action.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; being acted upon.
	 * @param action
	 *            The monarch action.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 */
	private void csMonarchAction(final ServerPlayer serverPlayer, MonarchAction action, ChangeSet cs) {
<span class="nc" id="L910">		final Monarch monarch = serverPlayer.getMonarch();</span>
<span class="nc" id="L911">		final Game game = getGame();</span>
<span class="nc" id="L912">		final Specification spec = game.getSpecification();</span>
<span class="nc" id="L913">		boolean valid = monarch.actionIsValid(action);</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">		if (!valid)</span>
<span class="nc" id="L915">			return;</span>
<span class="nc" id="L916">		String messageId = action.getTextKey();</span>
		StringTemplate template;
		MonarchActionMessage message;
<span class="nc" id="L919">		String monarchKey = serverPlayer.getMonarchKey();</span>

<span class="pc bnc" id="L921" title="All 11 branches missed.">		switch (action) {</span>
		case NO_ACTION:
<span class="nc" id="L923">			break;</span>
		case RAISE_TAX_WAR:
		case RAISE_TAX_ACT:
<span class="nc" id="L926">			final int taxRaise = monarch.raiseTax(random);</span>
<span class="nc" id="L927">			final Goods goods = serverPlayer.getMostValuableGoods();</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">			if (goods == null) {</span>
<span class="nc" id="L929">				logger.finest(&quot;Ignoring tax raise, no goods to boycott.&quot;);</span>
<span class="nc" id="L930">				break;</span>
			}
<span class="nc" id="L932">			template = StringTemplate.template(messageId).addStringTemplate(&quot;%goods%&quot;, goods.getType().getLabel())</span>
<span class="nc" id="L933">					.addAmount(&quot;%amount%&quot;, taxRaise);</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">			if (action == MonarchAction.RAISE_TAX_WAR) {</span>
<span class="nc" id="L935">				template = template.add(&quot;%nation%&quot;, Nation.getRandomNonPlayerNationNameKey(game, random));</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">			} else if (action == MonarchAction.RAISE_TAX_ACT) {</span>
<span class="nc" id="L937">				template = template.addAmount(&quot;%number%&quot;, randomInt(logger, &quot;Tax act goods&quot;, random, 6))</span>
<span class="nc" id="L938">						.addName(&quot;%newWorld%&quot;, serverPlayer.getNewLandName());</span>
			}
<span class="nc" id="L940">			message = new MonarchActionMessage(action, template, monarchKey).setTax(taxRaise);</span>
<span class="nc" id="L941">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY, message);</span>
<span class="nc" id="L942">			new MonarchSession(serverPlayer, action, taxRaise, goods);</span>
<span class="nc" id="L943">			break;</span>
		case LOWER_TAX_WAR:
		case LOWER_TAX_OTHER:
<span class="nc" id="L946">			int oldTax = serverPlayer.getTax();</span>
<span class="nc" id="L947">			int taxLower = monarch.lowerTax(random);</span>
<span class="nc" id="L948">			serverPlayer.csSetTax(taxLower, cs);</span>
<span class="nc" id="L949">			template = StringTemplate.template(messageId).addAmount(&quot;%difference%&quot;, oldTax - taxLower)</span>
<span class="nc" id="L950">					.addAmount(&quot;%newTax%&quot;, taxLower);</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">			if (action == MonarchAction.LOWER_TAX_WAR) {</span>
<span class="nc" id="L952">				template = template.add(&quot;%nation%&quot;, Nation.getRandomNonPlayerNationNameKey(game, random));</span>
			} else {
<span class="nc" id="L954">				template = template.addAmount(&quot;%number%&quot;, randomInt(logger, &quot;Lower tax reason&quot;, random, 5));</span>
			}
<span class="nc" id="L956">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
					new MonarchActionMessage(action, template, monarchKey));
<span class="nc" id="L958">			break;</span>
		case WAIVE_TAX:
<span class="nc" id="L960">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_NORMAL,</span>
<span class="nc" id="L961">					new MonarchActionMessage(action, StringTemplate.template(messageId), monarchKey));</span>
<span class="nc" id="L962">			break;</span>
		case ADD_TO_REF:
<span class="nc" id="L964">			AbstractUnit refAdditions = monarch.chooseForREF(random);</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">			if (refAdditions == null)</span>
<span class="nc" id="L966">				break;</span>
<span class="nc" id="L967">			monarch.getExpeditionaryForce().add(refAdditions);</span>
<span class="nc" id="L968">			template = StringTemplate.template(messageId).addAmount(&quot;%number%&quot;, refAdditions.getNumber())</span>
<span class="nc" id="L969">					.addNamed(&quot;%unit%&quot;, refAdditions.getType(spec));</span>
<span class="nc" id="L970">			cs.add(See.only(serverPlayer), monarch);</span>
<span class="nc" id="L971">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
					new MonarchActionMessage(action, template, monarchKey));
<span class="nc" id="L973">			break;</span>
		case DECLARE_PEACE:
<span class="nc" id="L975">			List&lt;Player&gt; friends = monarch.collectPotentialFriends();</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">			if (friends.isEmpty())</span>
<span class="nc" id="L977">				break;</span>
<span class="nc" id="L978">			Player friend = getRandomMember(logger, &quot;Choose friend&quot;, friends, random);</span>
<span class="nc" id="L979">			serverPlayer.csChangeStance(Stance.PEACE, (ServerPlayer) friend, true, cs);</span>
<span class="nc" id="L980">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
					new MonarchActionMessage(action,
<span class="nc" id="L982">							StringTemplate.template(messageId).addStringTemplate(&quot;%nation%&quot;, friend.getNationLabel()),</span>
							monarchKey));
<span class="nc" id="L984">			break;</span>
		case DECLARE_WAR:
<span class="nc" id="L986">			List&lt;Player&gt; enemies = monarch.collectPotentialEnemies();</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">			if (enemies.isEmpty())</span>
<span class="nc" id="L988">				break;</span>
<span class="nc" id="L989">			Player enemy = getRandomMember(logger, &quot;Choose enemy&quot;, enemies, random);</span>
<span class="nc" id="L990">			List&lt;AbstractUnit&gt; warSupport = monarch.getWarSupport(enemy, random);</span>
<span class="nc" id="L991">			int warGold = 0;</span>
<span class="nc bnc" id="L992" title="All 2 branches missed.">			if (!warSupport.isEmpty()) {</span>
<span class="nc" id="L993">				serverPlayer.createUnits(warSupport, serverPlayer.getEurope());// -vis:</span>
																				// safe,
																				// Europe
<span class="nc" id="L996">				warGold = spec.getInteger(GameOptions.WAR_SUPPORT_GOLD);</span>
<span class="nc" id="L997">				warGold += (warGold / 10) * (randomInt(logger, &quot;War support gold&quot;, random, 5) - 2);</span>
<span class="nc" id="L998">				serverPlayer.modifyGold(warGold);</span>
<span class="nc" id="L999">				cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L1000">				logger.fine(&quot;War support v &quot; + enemy.getNation().getSuffix() + &quot; &quot; + warGold + &quot; gold + &quot;</span>
<span class="nc" id="L1001">						+ Messages.message(AbstractUnit.getListLabel(&quot;, &quot;, warSupport)));</span>
			}
<span class="nc" id="L1003">			serverPlayer.csChangeStance(Stance.WAR, (ServerPlayer) enemy, true, cs);</span>
<span class="nc" id="L1004">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE, new MonarchActionMessage(action, StringTemplate</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">					.template((warSupport.isEmpty()) ? messageId : &quot;model.monarch.action.declareWarSupported.text&quot;)</span>
<span class="nc" id="L1006">					.addStringTemplate(&quot;%nation%&quot;, enemy.getNationLabel())</span>
<span class="nc" id="L1007">					.addStringTemplate(&quot;%force%&quot;, AbstractUnit.getListLabel(&quot;, &quot;, warSupport))</span>
<span class="nc" id="L1008">					.addAmount(&quot;%gold%&quot;, warGold), monarchKey));</span>
<span class="nc" id="L1009">			break;</span>
		case SUPPORT_LAND:
		case SUPPORT_SEA:
<span class="nc bnc" id="L1012" title="All 2 branches missed.">			boolean sea = action == MonarchAction.SUPPORT_SEA;</span>
<span class="nc" id="L1013">			List&lt;AbstractUnit&gt; support = monarch.getSupport(random, sea);</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">			if (support.isEmpty())</span>
<span class="nc" id="L1015">				break;</span>
<span class="nc" id="L1016">			serverPlayer.createUnits(support, serverPlayer.getEurope());// -vis:</span>
																		// safe,
																		// Europe
<span class="nc" id="L1019">			cs.add(See.only(serverPlayer), serverPlayer.getEurope());</span>
<span class="nc" id="L1020">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L1021">					new MonarchActionMessage(action, StringTemplate.template(messageId).addStringTemplate(&quot;%addition%&quot;,</span>
<span class="nc" id="L1022">							AbstractUnit.getListLabel(&quot;, &quot;, support)), monarchKey));</span>
<span class="nc" id="L1023">			break;</span>
		case MONARCH_MERCENARIES:
<span class="nc" id="L1025">			final List&lt;AbstractUnit&gt; mercenaries = monarch.getMercenaries(random);</span>
<span class="nc bnc" id="L1026" title="All 2 branches missed.">			if (mercenaries.isEmpty())</span>
<span class="nc" id="L1027">				break;</span>
<span class="nc" id="L1028">			final int mercPrice = serverPlayer.priceMercenaries(mercenaries);</span>
<span class="nc" id="L1029">			message = new MonarchActionMessage(action, StringTemplate.template(messageId).addAmount(&quot;%gold%&quot;, mercPrice)</span>
<span class="nc" id="L1030">					.addStringTemplate(&quot;%mercenaries%&quot;, AbstractUnit.getListLabel(&quot;, &quot;, mercenaries)), monarchKey);</span>
<span class="nc" id="L1031">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY, message);</span>
<span class="nc" id="L1032">			new MonarchSession(serverPlayer, action, mercenaries, mercPrice);</span>
<span class="nc" id="L1033">			break;</span>
		case HESSIAN_MERCENARIES:
<span class="nc" id="L1035">			final List&lt;AbstractUnit&gt; hessians = monarch.getMercenaries(random);</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">			if (hessians.isEmpty())</span>
<span class="nc" id="L1037">				break;</span>
<span class="nc" id="L1038">			int n = NameCache.getMercenaryLeaderIndex(random);</span>
<span class="nc" id="L1039">			final int hessPrice = serverPlayer.priceMercenaries(hessians);</span>
<span class="nc" id="L1040">			message = new MonarchActionMessage(action,</span>
<span class="nc" id="L1041">					StringTemplate.template(messageId).addName(&quot;%leader%&quot;, NameCache.getMercenaryLeaderName(n))</span>
<span class="nc" id="L1042">							.addAmount(&quot;%gold%&quot;, hessPrice).addStringTemplate(&quot;%mercenaries%&quot;,</span>
<span class="nc" id="L1043">									AbstractUnit.getListLabel(&quot;, &quot;, hessians)),</span>
					&quot;image.flavor.model.mercenaries.&quot; + n);
<span class="nc" id="L1045">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY, message);</span>
<span class="nc" id="L1046">			new MonarchSession(serverPlayer, action, hessians, hessPrice);</span>
<span class="nc" id="L1047">			break;</span>
		case DISPLEASURE:
		default:
<span class="nc" id="L1050">			logger.warning(&quot;Bogus action: &quot; + action);</span>
			break;
		}
<span class="nc" id="L1053">	}</span>

	/**
	 * Monarch action.
	 *
	 * @param serverPlayer
	 *            the server player
	 * @param action
	 *            the action
	 * @param result
	 *            the result
	 * @return the element
	 */
	public Element monarchAction(ServerPlayer serverPlayer, MonarchAction action, boolean result) {
<span class="nc" id="L1067">		MonarchSession session = TransactionSession.lookup(MonarchSession.class, serverPlayer.getId(), &quot;&quot;);</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L1069">			return DOMMessage.clientError(&quot;Bogus monarch action: &quot; + action);</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">		} else if (action != session.getAction()) {</span>
<span class="nc" id="L1071">			return DOMMessage.clientError(&quot;Session action mismatch, &quot; + session.getAction() + &quot; expected: &quot; + action);</span>
		}

<span class="nc" id="L1074">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1075">		session.complete(result, cs);</span>
<span class="nc" id="L1076">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Handle a player retiring.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is retiring.
	 * @return An element cleaning up the player.
	 */
	public Element retire(ServerPlayer serverPlayer) {
<span class="nc" id="L1087">		boolean highScore = HighScore.newHighScore(serverPlayer);</span>
<span class="nc" id="L1088">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1089">		serverPlayer.csWithdraw(cs); // Clean up the player.</span>
<span class="nc" id="L1090">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1091">		cs.addAttribute(See.only(serverPlayer), &quot;highScore&quot;, Boolean.toString(highScore));</span>
<span class="nc" id="L1092">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Continue playing after winning.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that plays on.
	 * @return Null.
	 */
	public Element continuePlaying(ServerPlayer serverPlayer) {
<span class="nc" id="L1103">		final ServerGame game = getGame();</span>
<span class="nc" id="L1104">		Element reply = null;</span>
<span class="nc bnc" id="L1105" title="All 2 branches missed.">		if (!getFreeColServer().getSinglePlayer()) {</span>
<span class="nc" id="L1106">			logger.warning(&quot;Can not continue playing in multiplayer!&quot;);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">		} else if (serverPlayer != game.checkForWinner()) {</span>
<span class="nc" id="L1108">			logger.warning(&quot;Can not continue playing, as &quot; + serverPlayer.getName() + &quot; has not won the game!&quot;);</span>
		} else {
<span class="nc" id="L1110">			final Specification spec = game.getSpecification();</span>
<span class="nc" id="L1111">			spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_REF).setValue(Boolean.FALSE);</span>
<span class="nc" id="L1112">			spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_EUROPEANS).setValue(Boolean.FALSE);</span>
<span class="nc" id="L1113">			spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_HUMANS).setValue(Boolean.FALSE);</span>
<span class="nc" id="L1114">			logger.info(&quot;Disabled victory conditions, as &quot; + serverPlayer.getName()</span>
					+ &quot; has won, but is continuing to play.&quot;);
		}
<span class="nc" id="L1117">		return null;</span>
	}

	/**
	 * Cash in a treasure train.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is cashing in.
	 * @param unit
	 *            The treasure train &lt;code&gt;Unit&lt;/code&gt; to cash in.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element cashInTreasureTrain(ServerPlayer serverPlayer, Unit unit) {
<span class="fc" id="L1130">		ChangeSet cs = new ChangeSet();</span>

		// Work out the cash in amount and the message to send.
<span class="fc" id="L1133">		int fullAmount = unit.getTreasureAmount();</span>
		int cashInAmount;
		String messageId;
<span class="pc bpc" id="L1136" title="1 of 2 branches missed.">		if (serverPlayer.getPlayerType() == PlayerType.COLONIAL) {</span>
			// Charge transport fee and apply tax
<span class="fc" id="L1138">			cashInAmount = (fullAmount - unit.getTransportFee()) * (100 - serverPlayer.getTax()) / 100;</span>
<span class="fc" id="L1139">			messageId = &quot;cashInTreasureTrain.colonial&quot;;</span>
		} else {
			// No fee possible, no tax applies.
<span class="nc" id="L1142">			cashInAmount = fullAmount;</span>
<span class="nc" id="L1143">			messageId = &quot;cashInTreasureTrain.independent&quot;;</span>
		}

<span class="fc" id="L1146">		serverPlayer.modifyGold(cashInAmount);</span>
<span class="fc" id="L1147">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="fc" id="L1148">		cs.addMessage(See.only(serverPlayer), new ModelMessage(messageId, serverPlayer, unit)</span>
<span class="fc" id="L1149">				.addAmount(&quot;%amount%&quot;, fullAmount).addAmount(&quot;%cashInAmount%&quot;, cashInAmount));</span>
<span class="pc bpc" id="L1150" title="2 of 4 branches missed.">		messageId = (serverPlayer.isRebel() || serverPlayer.getPlayerType() == PlayerType.INDEPENDENT)</span>
				? &quot;cashInTreasureTrain.otherIndependent&quot; : &quot;cashInTreasureTrain.otherColonial&quot;;
<span class="fc" id="L1152">		cs.addMessage(See.all().except(serverPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, messageId, serverPlayer)
<span class="fc" id="L1154">						.addAmount(&quot;%amount%&quot;, fullAmount).addStringTemplate(&quot;%nation%&quot;,</span>
<span class="fc" id="L1155">								serverPlayer.getNationLabel()));</span>

		// Dispose of the unit, only visible to the owner.
<span class="fc" id="L1158">		cs.add(See.only(serverPlayer), (FreeColGameObject) unit.getLocation());</span>
<span class="fc" id="L1159">		cs.addRemove(See.only(serverPlayer), null, unit);// -vis: safe in colony</span>
<span class="fc" id="L1160">		unit.dispose();</span>

		// Others can see the cash in message.
<span class="fc" id="L1163">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1164">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Declare independence.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is declaring.
	 * @param nationName
	 *            The new name for the independent nation.
	 * @param countryName
	 *            The new name for its residents.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element declareIndependence(final ServerPlayer serverPlayer, String nationName, String countryName) {
<span class="nc" id="L1179">		final Game game = getGame();</span>
<span class="nc" id="L1180">		final Specification spec = game.getSpecification();</span>
<span class="nc" id="L1181">		ChangeSet cs = new ChangeSet();</span>

		// Cross the Rubicon
<span class="nc" id="L1184">		StringTemplate oldNation = serverPlayer.getNationLabel();</span>
<span class="nc" id="L1185">		serverPlayer.setIndependentNationName(nationName);</span>
<span class="nc" id="L1186">		serverPlayer.setNewLandName(countryName);</span>
<span class="nc" id="L1187">		serverPlayer.changePlayerType(PlayerType.REBEL);</span>

		// Do not add history event to cs as we are going to update the
		// entire player. Likewise clear model messages.
<span class="nc" id="L1191">		Turn turn = game.getTurn();</span>
<span class="nc" id="L1192">		HistoryEvent h = new HistoryEvent(turn, HistoryEvent.HistoryEventType.DECLARE_INDEPENDENCE, serverPlayer);</span>
<span class="nc" id="L1193">		final int independenceTurn = spec.getInteger(GameOptions.INDEPENDENCE_TURN);</span>
<span class="nc" id="L1194">		h.setScore(Math.max(0, independenceTurn - turn.getNumber()));</span>
<span class="nc" id="L1195">		cs.addGlobalHistory(game, h);</span>
<span class="nc" id="L1196">		serverPlayer.clearModelMessages();</span>
<span class="nc" id="L1197">		cs.addMessage(See.only(serverPlayer), new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
				&quot;declareIndependence.resolution&quot;, serverPlayer));

		// Dispose of units in or heading to Europe.
<span class="nc" id="L1201">		Europe europe = serverPlayer.getEurope();</span>
<span class="nc" id="L1202">		StringTemplate seized = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L1203">		boolean lost = false;</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">		for (Unit u : europe.getUnitList()) {</span>
<span class="nc" id="L1205">			seized.addStringTemplate(u.getLabel());</span>
<span class="nc" id="L1206">			cs.addRemoves(See.only(serverPlayer), null, u.getDisposeList());</span>
<span class="nc" id="L1207">			u.dispose();</span>
<span class="nc" id="L1208">			lost = true;</span>
<span class="nc" id="L1209">		}</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">		for (Unit u : serverPlayer.getHighSeas().getUnitList()) {</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">			if (u.getDestination() == europe) {</span>
<span class="nc" id="L1212">				seized.addStringTemplate(u.getLabel());</span>
<span class="nc" id="L1213">				cs.addRemoves(See.only(serverPlayer), null, u.getDisposeList());</span>
<span class="nc" id="L1214">				u.dispose();</span>
<span class="nc" id="L1215">				lost = true;</span>
			}
<span class="nc" id="L1217">		}</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">		if (lost) {</span>
<span class="nc" id="L1219">			cs.addMessage(See.only(serverPlayer), new ModelMessage(ModelMessage.MessageType.UNIT_LOST,</span>
<span class="nc" id="L1220">					&quot;declareIndependence.unitsSeized&quot;, serverPlayer).addStringTemplate(&quot;%units%&quot;, seized));</span>
		}
<span class="nc" id="L1222">		serverPlayer.csLoseLocation(europe, cs);</span>

		// Create the REF.
<span class="nc" id="L1225">		ServerPlayer refPlayer = createREFPlayer(serverPlayer);</span>
<span class="nc" id="L1226">		cs.addPlayer(refPlayer);</span>
		// Update the intervention force
<span class="nc" id="L1228">		serverPlayer.getMonarch().updateInterventionForce();</span>
<span class="nc" id="L1229">		String otherKey = Nation.getRandomNonPlayerNationNameKey(game, random);</span>
<span class="nc" id="L1230">		cs.addMessage(See.only(serverPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;declareIndependence.interventionForce&quot;,
<span class="nc" id="L1232">						serverPlayer).add(&quot;%nation%&quot;, otherKey).addAmount(&quot;%number%&quot;,</span>
<span class="nc" id="L1233">								spec.getInteger(GameOptions.INTERVENTION_BELLS)));</span>
<span class="nc" id="L1234">		serverPlayer.csChangeStance(Stance.WAR, refPlayer, true, cs);</span>

		// Now the REF is ready, we can dispose of the European connection.
<span class="nc" id="L1237">		cs.addRemove(See.only(serverPlayer), null, europe);// -vis: not on map</span>
<span class="nc" id="L1238">		europe.dispose();</span>
		// Do not clean up the Monarch, it contains the intervention force

		// Generalized continental army muster.
		// Do not use UnitType.getTargetType.
<span class="nc" id="L1243">		java.util.Map&lt;UnitType, UnitType&gt; upgrades = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1244" title="All 2 branches missed.">		for (UnitType unitType : spec.getUnitTypeList()) {</span>
<span class="nc" id="L1245">			UnitType upgrade = unitType.getTargetType(ChangeType.INDEPENDENCE, serverPlayer);</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">			if (upgrade != null)</span>
<span class="nc" id="L1247">				upgrades.put(unitType, upgrade);</span>
<span class="nc" id="L1248">		}</span>
<span class="nc" id="L1249">		java.util.Map&lt;UnitType, List&lt;Unit&gt;&gt; unitMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1250" title="All 2 branches missed.">		for (Colony colony : serverPlayer.getColonies()) {</span>
<span class="nc" id="L1251">			List&lt;Unit&gt; allUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1252">			allUnits.addAll(colony.getTile().getUnitList());</span>
<span class="nc" id="L1253">			allUnits.addAll(colony.getUnitList());</span>
<span class="nc" id="L1254">			int limit = (allUnits.size() + 2) * (colony.getSoL() - 50) / 100;</span>
<span class="nc bnc" id="L1255" title="All 2 branches missed.">			if (limit &lt;= 0)</span>
<span class="nc" id="L1256">				continue;</span>

<span class="nc" id="L1258">			unitMap.clear();</span>
<span class="nc bnc" id="L1259" title="All 2 branches missed.">			for (Unit unit : allUnits) {</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">				if (upgrades.containsKey(unit.getType())) {</span>
<span class="nc" id="L1261">					List&lt;Unit&gt; unitList = unitMap.get(unit.getType());</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">					if (unitList == null) {</span>
<span class="nc" id="L1263">						unitList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1264">						unitMap.put(unit.getType(), unitList);</span>
					}
<span class="nc" id="L1266">					unitList.add(unit);</span>
				}
<span class="nc" id="L1268">			}</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">			for (Entry&lt;UnitType, List&lt;Unit&gt;&gt; entry : unitMap.entrySet()) {</span>
<span class="nc" id="L1270">				int n = 0;</span>
<span class="nc" id="L1271">				UnitType type = entry.getKey();</span>
<span class="nc" id="L1272">				List&lt;Unit&gt; units = entry.getValue();</span>
<span class="nc bnc" id="L1273" title="All 4 branches missed.">				while (!units.isEmpty() &amp;&amp; n &lt; limit) {</span>
<span class="nc" id="L1274">					Unit unit = units.remove(0);</span>
<span class="nc" id="L1275">					unit.changeType(upgrades.get(type));// -vis</span>
<span class="nc" id="L1276">					cs.add(See.only(serverPlayer), unit);</span>
<span class="nc" id="L1277">					n++;</span>
<span class="nc" id="L1278">				}</span>
<span class="nc" id="L1279">				cs.addMessage(See.only(serverPlayer),</span>
						new ModelMessage(ModelMessage.MessageType.UNIT_IMPROVED,
								&quot;declareIndependence.continentalArmyMuster&quot;, serverPlayer, colony)
<span class="nc" id="L1282">										.addName(&quot;%colony%&quot;, colony.getName()).addAmount(&quot;%number%&quot;, n)</span>
<span class="nc" id="L1283">										.addNamed(&quot;%oldUnit%&quot;, type).addNamed(&quot;%unit%&quot;, upgrades.get(type)));</span>
<span class="nc" id="L1284">				limit -= n;</span>
<span class="nc" id="L1285">			}</span>
<span class="nc" id="L1286">		}</span>

		// Most hostile contacted non-warring natives declare war on
		// you and peace with the REF, least hostile contacted natives
		// declare peace on you and war on the REF. If they are the
		// same nation, go to the next most hostile nation that may
		// already be at war.
<span class="nc" id="L1293">		List&lt;Player&gt; natives = game.getLiveNativePlayers(null).stream().filter(p -&gt; p.hasContacted(serverPlayer))</span>
<span class="nc" id="L1294">				.sorted(new Comparator&lt;Player&gt;() {</span>
					public int compare(Player p1, Player p2) {
<span class="nc" id="L1296">						return p1.getTension(serverPlayer).getValue() - p2.getTension(serverPlayer).getValue();</span>
					}
<span class="nc" id="L1298">				}).collect(Collectors.toList());</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">		if (!natives.isEmpty()) {</span>
<span class="nc" id="L1300">			ServerPlayer good = (ServerPlayer) natives.get(0);</span>
<span class="nc" id="L1301">			logger.info(&quot;Native ally following independence: &quot; + good);</span>
<span class="nc" id="L1302">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;declareIndependence.nativeSupport&quot;,
<span class="nc" id="L1304">							good).addStringTemplate(&quot;%nation%&quot;, good.getNationLabel()).add(&quot;%ruler%&quot;,</span>
<span class="nc" id="L1305">									serverPlayer.getRulerNameKey()));</span>
			int delta;
<span class="pc bnc" id="L1307" title="All 3 branches missed.">			switch (good.getStance(serverPlayer)) {</span>
			case ALLIANCE:
			case PEACE:
			default:
<span class="nc" id="L1311">				delta = 0;</span>
<span class="nc" id="L1312">				break;</span>
			case CEASE_FIRE:
<span class="nc" id="L1314">				delta = Tension.Level.HAPPY.getLimit() - good.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L1315">				break;</span>
			case WAR:
<span class="nc" id="L1317">				delta = Tension.Level.CONTENT.getLimit() - good.getTension(serverPlayer).getValue();</span>
				break;
			}
<span class="nc" id="L1320">			good.csModifyTension(serverPlayer, delta, cs);</span>
<span class="nc" id="L1321">			Player.makeContact(good, refPlayer);</span>
<span class="nc" id="L1322">			good.csModifyTension(refPlayer, Tension.Level.HATEFUL.getLimit(), cs);</span>

<span class="nc" id="L1324">			reverse(natives);</span>
<span class="nc" id="L1325">			ServerPlayer bad = null;</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">			for (Player p : natives) {</span>
<span class="nc bnc" id="L1327" title="All 4 branches missed.">				if (p == good || p.getStance(serverPlayer) == Stance.ALLIANCE)</span>
<span class="nc" id="L1328">					break;</span>
<span class="nc" id="L1329">				bad = (ServerPlayer) p;</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">				if (!p.atWarWith(serverPlayer))</span>
<span class="nc" id="L1331">					break;</span>
<span class="nc" id="L1332">			}</span>
<span class="nc" id="L1333">			logger.info(&quot;Native enemy following independence: &quot; + bad);</span>
<span class="nc bnc" id="L1334" title="All 2 branches missed.">			if (bad != null) {</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">				switch (bad.getStance(serverPlayer)) {</span>
				case PEACE:
				case CEASE_FIRE:
<span class="nc" id="L1338">					delta = Tension.Level.HATEFUL.getLimit() - bad.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L1339">					break;</span>
				case WAR:
				default:
<span class="nc" id="L1342">					delta = 0;</span>
					break;
				}
<span class="nc" id="L1345">				cs.addMessage(See.only(serverPlayer),</span>
						new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="nc" id="L1347">								&quot;declareIndependence.nativeHostile&quot;, bad).addStringTemplate(&quot;%nation%&quot;,</span>
<span class="nc" id="L1348">										bad.getNationLabel()));</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">				if (delta != 0)</span>
<span class="nc" id="L1350">					bad.csModifyTension(serverPlayer, delta, cs);</span>
<span class="nc" id="L1351">				Player.makeContact(bad, refPlayer);</span>
<span class="nc" id="L1352">				bad.csModifyTension(refPlayer, -bad.getTension(refPlayer).getValue(), cs);</span>
			}
		}

		//
		// Pity to have to update such a heavy object as the player,
		// but we do this, at most, once per player. Other players
		// only need a partial player update and the stance change.
		// Put the stance change after the name change so that the
		// other players see the new nation name declaring war. The
		// REF is hardwired to declare war on rebels so there is no
		// need to adjust its stance or tension.
<span class="nc" id="L1364">		cs.addPartial(See.all().except(serverPlayer), serverPlayer, &quot;playerType&quot;, &quot;independentNationName&quot;,</span>
				&quot;newLandName&quot;);
<span class="nc" id="L1366">		cs.addMessage(See.all().except(serverPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;declareIndependence.announce&quot;,
<span class="nc" id="L1368">						serverPlayer).addStringTemplate(&quot;%oldNation%&quot;, oldNation)</span>
<span class="nc" id="L1369">								.addStringTemplate(&quot;%newNation%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L1370">								.add(&quot;%ruler%&quot;, serverPlayer.getRulerNameKey()));</span>
<span class="nc" id="L1371">		cs.add(See.only(serverPlayer), serverPlayer);</span>
<span class="nc" id="L1372">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>

<span class="nc" id="L1374">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1375">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Rename an object.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is naming.
	 * @param object
	 *            The &lt;code&gt;Nameable&lt;/code&gt; to rename.
	 * @param newName
	 *            The new name.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element renameObject(ServerPlayer serverPlayer, Nameable object, String newName) {
<span class="nc" id="L1390">		ChangeSet cs = new ChangeSet();</span>

<span class="nc bnc" id="L1392" title="All 2 branches missed.">		if (object instanceof Settlement) {</span>
<span class="nc" id="L1393">			((Settlement) object).getTile().cacheUnseen();// +til</span>
		}
<span class="nc" id="L1395">		object.setName(newName);// -til?</span>
<span class="nc" id="L1396">		FreeColGameObject fcgo = (FreeColGameObject) object;</span>
<span class="nc" id="L1397">		cs.addPartial(See.all(), fcgo, &quot;name&quot;);</span>

		// Others may be able to see the name change.
<span class="nc" id="L1400">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1401">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Gets a settlement transaction session, either existing or newly opened.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element getTransaction(ServerPlayer serverPlayer, Unit unit, Settlement settlement) {
<span class="nc" id="L1416">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1417">		TradeSession session = TransactionSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc bnc" id="L1419" title="All 2 branches missed.">			if (unit.getMovesLeft() &lt;= 0) {</span>
<span class="nc" id="L1420">				return DOMMessage.clientError(&quot;Unit &quot; + unit.getId() + &quot; has no moves left.&quot;);</span>
			}
<span class="nc" id="L1422">			session = new TradeSession(unit, settlement);</span>
			// Sets unit moves to zero to avoid cheating. If no
			// action is taken, the moves will be restored when
			// closing the session
<span class="nc" id="L1426">			unit.setMovesLeft(0);</span>
<span class="nc" id="L1427">			cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
		}

		// Add just the attributes the client needs.
<span class="nc" id="L1431">		cs.addAttribute(See.only(serverPlayer), &quot;canBuy&quot;, Boolean.toString(session.getBuy()));</span>
<span class="nc" id="L1432">		cs.addAttribute(See.only(serverPlayer), &quot;canSell&quot;, Boolean.toString(session.getSell()));</span>
<span class="nc" id="L1433">		cs.addAttribute(See.only(serverPlayer), &quot;canGift&quot;, Boolean.toString(session.getGift()));</span>

		// Others can not see transactions.
<span class="nc" id="L1436">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Close a transaction.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element closeTransaction(ServerPlayer serverPlayer, Unit unit, Settlement settlement) {
<span class="nc" id="L1451">		TradeSession session = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1452" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L1453">			return DOMMessage.clientError(&quot;No such transaction session.&quot;);</span>
		}

<span class="nc" id="L1456">		ChangeSet cs = new ChangeSet();</span>
		// Restore unit movement if no action taken.
<span class="nc bnc" id="L1458" title="All 2 branches missed.">		if (!session.getActionTaken()) {</span>
<span class="nc" id="L1459">			unit.setMovesLeft(session.getMovesLeft());</span>
<span class="nc" id="L1460">			cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
		}
<span class="nc" id="L1462">		session.complete(cs);</span>

		// Others can not see end of transaction.
<span class="nc" id="L1465">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Get the goods for sale in a settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is enquiring.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element getGoodsForSale(ServerPlayer serverPlayer, Unit unit, Settlement settlement) {
<span class="nc" id="L1480">		List&lt;Goods&gt; sellGoods = null;</span>

<span class="nc bnc" id="L1482" title="All 2 branches missed.">		if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1483">			IndianSettlement indianSettlement = (IndianSettlement) settlement;</span>
<span class="nc" id="L1484">			AIPlayer aiPlayer = getFreeColServer().getAIPlayer(indianSettlement.getOwner());</span>
<span class="nc" id="L1485">			sellGoods = indianSettlement.getSellGoods(3, unit);</span>
<span class="nc bnc" id="L1486" title="All 2 branches missed.">			for (Goods goods : sellGoods) {</span>
<span class="nc" id="L1487">				aiPlayer.registerSellGoods(goods);</span>
<span class="nc" id="L1488">			}</span>
<span class="nc" id="L1489">		} else { // Colony might be supported one day?</span>
<span class="nc" id="L1490">			return DOMMessage.clientError(&quot;Bogus settlement&quot;);</span>
		}
<span class="nc" id="L1492">		return new GoodsForSaleMessage(unit, settlement, sellGoods).toXMLElement();</span>
	}

	/**
	 * Price some goods for sale from a settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to buy.
	 * @param price
	 *            The buyers proposed price for the goods.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element buyProposition(ServerPlayer serverPlayer, Unit unit, Settlement settlement, Goods goods, int price) {
<span class="nc" id="L1511">		TradeSession session = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1512" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L1513">			return DOMMessage.clientError(&quot;Proposing to buy without opening a transaction session?!&quot;);</span>
		}
<span class="nc bnc" id="L1515" title="All 2 branches missed.">		if (!session.getBuy()) {</span>
<span class="nc" id="L1516">			return DOMMessage.clientError(&quot;Proposing to buy in a session where buying is not allowed.&quot;);</span>
		}
<span class="nc" id="L1518">		ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">		if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1520">			csVisit(serverPlayer, (IndianSettlement) settlement, 0, cs);</span>
		}

		// AI considers the proposition, return with a gold value
<span class="nc" id="L1524">		AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L1525">		int gold = ai.buyProposition(unit, settlement, goods, price);</span>

		// Others can not see proposals.
<span class="nc" id="L1528">		cs.addAttribute(See.only(serverPlayer), &quot;gold&quot;, Integer.toString(gold));</span>
<span class="nc" id="L1529">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Price some goods for sale to a settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to sell.
	 * @param price
	 *            The sellers proposed price for the goods.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element sellProposition(ServerPlayer serverPlayer, Unit unit, Settlement settlement, Goods goods,
			int price) {
<span class="nc" id="L1549">		TradeSession session = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1550" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L1551">			return DOMMessage.clientError(&quot;Proposing to sell without opening a transaction session&quot;);</span>
		}
<span class="nc bnc" id="L1553" title="All 2 branches missed.">		if (!session.getSell()) {</span>
<span class="nc" id="L1554">			return DOMMessage.clientError(&quot;Proposing to sell in a session where selling is not allowed.&quot;);</span>
		}
<span class="nc" id="L1556">		ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L1557" title="All 2 branches missed.">		if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1558">			csVisit(serverPlayer, (IndianSettlement) settlement, 0, cs);</span>
		}

		// AI considers the proposition, return with a gold value
<span class="nc" id="L1562">		AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L1563">		int gold = ai.sellProposition(unit, settlement, goods, price);</span>

		// Others can not see proposals.
<span class="nc" id="L1566">		cs.addAttribute(See.only(serverPlayer), &quot;gold&quot;, Integer.toString(gold));</span>
<span class="nc" id="L1567">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Buy goods in Europe.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to buy.
	 * @param amount
	 *            The amount of goods to buy.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; to carry the goods.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element buyGoods(ServerPlayer serverPlayer, GoodsType type, int amount, Unit carrier) {
<span class="fc bfc" id="L1584" title="All 2 branches covered.">		if (!serverPlayer.canTrade(type, Access.EUROPE)) {</span>
<span class="fc" id="L1585">			return DOMMessage.clientError(&quot;Can not trade boycotted goods&quot;);</span>
		}

<span class="fc" id="L1588">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1589">		GoodsContainer container = carrier.getGoodsContainer();</span>
<span class="fc" id="L1590">		container.saveState();</span>
<span class="fc" id="L1591">		int gold = serverPlayer.getGold();</span>
<span class="fc" id="L1592">		int buyAmount = serverPlayer.buy(container, type, amount);</span>
<span class="fc bfc" id="L1593" title="All 2 branches covered.">		if (buyAmount &lt; 0) {</span>
<span class="fc" id="L1594">			return DOMMessage.clientError(</span>
<span class="fc" id="L1595">					&quot;Player &quot; + serverPlayer.getName() + &quot; tried to buy &quot; + amount + &quot; &quot; + type.getSuffix());</span>
		}
<span class="fc" id="L1597">		serverPlayer.propagateToEuropeanMarkets(type, -buyAmount, random);</span>
<span class="fc" id="L1598">		serverPlayer.csFlushMarket(type, cs);</span>
<span class="fc" id="L1599">		carrier.setMovesLeft(0);</span>
<span class="fc" id="L1600">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L1601">		cs.add(See.only(serverPlayer), carrier);</span>
<span class="fc" id="L1602">		logger.finest(carrier + &quot; bought &quot; + amount + &quot;(&quot; + buyAmount + &quot;)&quot; + &quot; &quot; + type.getSuffix() + &quot; in Europe for &quot;</span>
<span class="fc" id="L1603">				+ (serverPlayer.getGold() - gold));</span>
		// Action occurs in Europe, nothing is visible to other players.
<span class="fc" id="L1605">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Sell goods in Europe.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is selling.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to sell.
	 * @param amount
	 *            The amount of goods to sell.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element sellGoods(ServerPlayer serverPlayer, GoodsType type, int amount, Unit carrier) {

<span class="fc" id="L1623">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1624">		GoodsContainer container = carrier.getGoodsContainer();</span>
<span class="fc" id="L1625">		container.saveState();</span>
<span class="fc bfc" id="L1626" title="All 2 branches covered.">		if (serverPlayer.canTrade(type, Access.EUROPE)) {</span>
<span class="fc" id="L1627">			int gold = serverPlayer.getGold();</span>
<span class="fc" id="L1628">			int sellAmount = serverPlayer.sell(container, type, amount);</span>
<span class="pc bpc" id="L1629" title="1 of 2 branches missed.">			if (sellAmount &lt; 0) {</span>
<span class="nc" id="L1630">				return DOMMessage.clientError(</span>
<span class="nc" id="L1631">						&quot;Player &quot; + serverPlayer.getName() + &quot; tried to sell &quot; + amount + &quot; &quot; + type.getSuffix());</span>
			}
<span class="fc" id="L1633">			serverPlayer.propagateToEuropeanMarkets(type, sellAmount, random);</span>
<span class="fc" id="L1634">			serverPlayer.csFlushMarket(type, cs);</span>
<span class="fc" id="L1635">			cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L1636">			logger.finest(carrier + &quot; sold &quot; + amount + &quot;(&quot; + sellAmount + &quot;)&quot; + &quot; &quot; + type.getSuffix()</span>
<span class="fc" id="L1637">					+ &quot; in Europe for &quot; + (serverPlayer.getGold() - gold));</span>
<span class="fc" id="L1638">		} else {</span>
			// Dumping goods in Europe
<span class="fc" id="L1640">			moveGoods(carrier, type, amount, null);</span>
<span class="fc" id="L1641">			logger.finest(carrier + &quot; dumped &quot; + amount + &quot; &quot; + type.getSuffix() + &quot; in Europe&quot;);</span>
		}
<span class="fc" id="L1643">		carrier.setMovesLeft(0);</span>
<span class="fc" id="L1644">		cs.add(See.only(serverPlayer), carrier);</span>
		// Action occurs in Europe, nothing is visible to other players.
<span class="fc" id="L1646">		return cs.build(serverPlayer);</span>
	}

	/**
	 * A unit migrates from Europe.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; whose unit it will be.
	 * @param slot
	 *            The slot within &lt;code&gt;Europe&lt;/code&gt; to select the unit from.
	 * @param type
	 *            The type of migration occurring.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element emigrate(ServerPlayer serverPlayer, int slot, MigrationType type) {
<span class="nc" id="L1661">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1662">		serverPlayer.csEmigrate(slot, type, random, cs);</span>

		// Do not update others, emigration is private.
<span class="nc" id="L1665">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Move a unit.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is moving.
	 * @param unit
	 *            The &lt;code&gt;ServerUnit&lt;/code&gt; to move.
	 * @param newTile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to move to.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element move(ServerPlayer serverPlayer, ServerUnit unit, Tile newTile) {
<span class="fc" id="L1680">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1681">		unit.csMove(newTile, random, cs);</span>
<span class="fc" id="L1682">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1683">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Decline to investigate strange mounds.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; where the mounds are.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element declineMounds(ServerPlayer serverPlayer, Tile tile) {
<span class="nc" id="L1696">		tile.cacheUnseen();// +til</span>
<span class="nc" id="L1697">		tile.removeLostCityRumour();// -til</span>

		// Others might see rumour disappear
<span class="nc" id="L1700">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1701">		cs.add(See.perhaps(), tile);</span>
<span class="nc" id="L1702">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1703">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Set land name.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; who landed.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that has come ashore.
	 * @param name
	 *            The new land name.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element setNewLandName(ServerPlayer serverPlayer, Unit unit, String name) {
<span class="nc" id="L1718">		ChangeSet cs = new ChangeSet();</span>

		// Special case of a welcome from an adjacent native unit,
		// offering the land the landing unit is on if a peace treaty
		// is accepted.
<span class="nc" id="L1723">		serverPlayer.setNewLandName(name);</span>

		// Update the name and note the history.
<span class="nc" id="L1726">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;newLandName&quot;);</span>
<span class="nc" id="L1727">		Turn turn = serverPlayer.getGame().getTurn();</span>
<span class="nc" id="L1728">		HistoryEvent h = new HistoryEvent(turn, HistoryEvent.HistoryEventType.DISCOVER_NEW_WORLD, serverPlayer)</span>
<span class="nc" id="L1729">				.addName(&quot;%name%&quot;, name);</span>
<span class="nc" id="L1730">		cs.addHistory(serverPlayer, h);</span>

<span class="nc" id="L1732">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Set region name.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; discovering.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is discovering.
	 * @param region
	 *            The &lt;code&gt;Region&lt;/code&gt; to discover.
	 * @param name
	 *            The new region name.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element setNewRegionName(ServerPlayer serverPlayer, Unit unit, Region region, String name) {
<span class="nc" id="L1749">		final Game game = getGame();</span>
<span class="nc" id="L1750">		ServerRegion serverRegion = (ServerRegion) region;</span>
		// Discoverer is set when unit moves in.
<span class="nc bnc" id="L1752" title="All 2 branches missed.">		if (!Utils.equals(region.getDiscoverer(), unit.getId())) {</span>
<span class="nc" id="L1753">			return DOMMessage.clientError(</span>
<span class="nc" id="L1754">					&quot;Discoverer mismatch, &quot; + region.getDiscoverer() + &quot; expected, &quot; + unit.getId() + &quot; provided.&quot;);</span>
		}
<span class="nc" id="L1756">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1757">		serverRegion.csDiscover(serverPlayer, game.getTurn(), name, cs);</span>

		// Others do find out about region name changes.
<span class="nc" id="L1760">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1761">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Move a unit across the high seas.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to move.
	 * @param destination
	 *            The &lt;code&gt;Location&lt;/code&gt; to move to.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element moveTo(ServerPlayer serverPlayer, Unit unit, Location destination) {
<span class="fc" id="L1776">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1777">		HighSeas highSeas = serverPlayer.getHighSeas();</span>
<span class="fc" id="L1778">		Location current = unit.getDestination();</span>
<span class="fc" id="L1779">		boolean others = false; // Notify others?</span>
<span class="fc" id="L1780">		boolean invalid = false; // Not a highSeas move?</span>

<span class="pc bpc" id="L1782" title="1 of 2 branches missed.">		if (!unit.getType().canMoveToHighSeas()) {</span>
<span class="nc" id="L1783">			invalid = true;</span>
<span class="fc bfc" id="L1784" title="All 2 branches covered.">		} else if (destination instanceof Europe) {</span>
<span class="pc bpc" id="L1785" title="1 of 2 branches missed.">			if (!highSeas.getDestinations().contains(destination)) {</span>
<span class="nc" id="L1786">				return DOMMessage.clientError(&quot;HighSeas does not connect to: &quot; + destination.getId());</span>
<span class="pc bpc" id="L1787" title="1 of 2 branches missed.">			} else if (unit.getLocation() == highSeas) {</span>
<span class="nc bnc" id="L1788" title="All 2 branches missed.">				if (!(current instanceof Europe)) {</span>
					// Changed direction
<span class="nc" id="L1790">					unit.setWorkLeft(unit.getSailTurns() - unit.getWorkLeft() + 1);</span>
				}
<span class="nc" id="L1792">				unit.setDestination(destination);</span>
<span class="nc" id="L1793">				cs.add(See.only(serverPlayer), unit, highSeas);</span>
<span class="pc bpc" id="L1794" title="1 of 2 branches missed.">			} else if (unit.hasTile()) {</span>
<span class="fc" id="L1795">				Tile tile = unit.getTile();</span>
<span class="fc" id="L1796">				unit.setEntryLocation(tile);</span>
<span class="fc" id="L1797">				unit.setWorkLeft(unit.getSailTurns());</span>
<span class="fc" id="L1798">				unit.setDestination(destination);</span>
<span class="fc" id="L1799">				unit.setMovesLeft(0);</span>
<span class="fc" id="L1800">				unit.setLocation(highSeas);// -vis(serverPlayer)</span>
<span class="fc" id="L1801">				serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="fc" id="L1802">				cs.addDisappear(serverPlayer, tile, unit);</span>
<span class="fc" id="L1803">				cs.add(See.only(serverPlayer), tile, highSeas);</span>
<span class="fc" id="L1804">				others = true;</span>
<span class="fc" id="L1805">			} else {</span>
<span class="nc" id="L1806">				invalid = true;</span>
			}
<span class="pc bpc" id="L1808" title="1 of 2 branches missed.">		} else if (destination instanceof Map) {</span>
<span class="pc bpc" id="L1809" title="1 of 2 branches missed.">			if (!highSeas.getDestinations().contains(destination)) {</span>
<span class="nc" id="L1810">				return DOMMessage.clientError(&quot;HighSeas does not connect to: &quot; + destination.getId());</span>
<span class="pc bpc" id="L1811" title="1 of 2 branches missed.">			} else if (unit.getLocation() == highSeas) {</span>
<span class="nc bnc" id="L1812" title="All 6 branches missed.">				if (current != destination &amp;&amp; (current == null || current.getTile() == null</span>
<span class="nc bnc" id="L1813" title="All 2 branches missed.">						|| current.getTile().getMap() != destination)) {</span>
					// Changed direction
<span class="nc" id="L1815">					unit.setWorkLeft(unit.getSailTurns() - unit.getWorkLeft() + 1);</span>
				}
<span class="nc" id="L1817">				unit.setDestination(destination);</span>
<span class="nc" id="L1818">				cs.add(See.only(serverPlayer), highSeas);</span>
<span class="pc bpc" id="L1819" title="1 of 2 branches missed.">			} else if (unit.getLocation() instanceof Europe) {</span>
<span class="fc" id="L1820">				Europe europe = (Europe) unit.getLocation();</span>
<span class="fc" id="L1821">				unit.setWorkLeft(unit.getSailTurns());</span>
<span class="fc" id="L1822">				unit.setDestination(destination);</span>
<span class="fc" id="L1823">				unit.setMovesLeft(0);</span>
<span class="fc" id="L1824">				unit.setLocation(highSeas);// -vis: safe!map</span>
<span class="fc" id="L1825">				cs.add(See.only(serverPlayer), europe, highSeas);</span>
<span class="fc" id="L1826">			} else {</span>
<span class="nc" id="L1827">				invalid = true;</span>
			}
<span class="nc bnc" id="L1829" title="All 2 branches missed.">		} else if (destination instanceof Settlement) {</span>
<span class="nc" id="L1830">			Tile tile = destination.getTile();</span>
<span class="nc bnc" id="L1831" title="All 2 branches missed.">			if (!highSeas.getDestinations().contains(tile.getMap())) {</span>
<span class="nc" id="L1832">				return DOMMessage.clientError(&quot;HighSeas does not connect to: &quot; + destination.getId());</span>
<span class="nc bnc" id="L1833" title="All 2 branches missed.">			} else if (unit.getLocation() == highSeas) {</span>
				// Direction is somewhat moot, so just reset.
<span class="nc" id="L1835">				unit.setWorkLeft(unit.getSailTurns());</span>
<span class="nc" id="L1836">				unit.setDestination(destination);</span>
<span class="nc" id="L1837">				cs.add(See.only(serverPlayer), highSeas);</span>
<span class="nc bnc" id="L1838" title="All 2 branches missed.">			} else if (unit.getLocation() instanceof Europe) {</span>
<span class="nc" id="L1839">				Europe europe = (Europe) unit.getLocation();</span>
<span class="nc" id="L1840">				unit.setWorkLeft(unit.getSailTurns());</span>
<span class="nc" id="L1841">				unit.setDestination(destination);</span>
<span class="nc" id="L1842">				unit.setMovesLeft(0);</span>
<span class="nc" id="L1843">				unit.setLocation(highSeas);// -vis: safe!map</span>
<span class="nc" id="L1844">				cs.add(See.only(serverPlayer), europe, highSeas);</span>
<span class="nc" id="L1845">			} else {</span>
<span class="nc" id="L1846">				invalid = true;</span>
			}
<span class="nc" id="L1848">		} else {</span>
<span class="nc" id="L1849">			return DOMMessage.clientError(&quot;Bogus moveTo destination: &quot; + destination.getId());</span>
		}
<span class="pc bpc" id="L1851" title="1 of 2 branches missed.">		if (invalid) {</span>
<span class="nc" id="L1852">			return DOMMessage.clientError(&quot;Invalid moveTo: unit=&quot; + unit.getId() + &quot; from=&quot; + unit.getLocation().getId()</span>
<span class="nc" id="L1853">					+ &quot; to=&quot; + destination.getId());</span>
		}

<span class="fc bfc" id="L1856" title="All 2 branches covered.">		if (others)</span>
<span class="fc" id="L1857">			getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1858">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Embark a unit onto a carrier. Checking that the locations are appropriate
	 * is not done here.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; embarking.
	 * @param serverUnit
	 *            The &lt;code&gt;ServerUnit&lt;/code&gt; that is embarking.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; to embark onto.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element embarkUnit(ServerPlayer serverPlayer, ServerUnit serverUnit, Unit carrier) {
<span class="fc bfc" id="L1874" title="All 2 branches covered.">		if (serverUnit.isNaval()) {</span>
<span class="fc" id="L1875">			return DOMMessage.clientError(&quot;Naval unit &quot; + serverUnit.getId() + &quot; can not embark.&quot;);</span>
		}
<span class="fc" id="L1877">		UnitLocation.NoAddReason reason = carrier.getNoAddReason(serverUnit);</span>
<span class="fc bfc" id="L1878" title="All 2 branches covered.">		if (reason != UnitLocation.NoAddReason.NONE) {</span>
<span class="fc" id="L1879">			return DOMMessage.clientError(</span>
<span class="fc" id="L1880">					&quot;Carrier: &quot; + carrier.getId() + &quot; can not carry &quot; + serverUnit.getId() + &quot;: &quot; + reason);</span>
		}

<span class="fc" id="L1883">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1884">		serverUnit.csEmbark(carrier, cs);</span>

		// Others might see the unit disappear, or the carrier capacity.
<span class="fc" id="L1887">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1888">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Disembark unit from a carrier.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; whose unit is embarking.
	 * @param serverUnit
	 *            The &lt;code&gt;ServerUnit&lt;/code&gt; that is disembarking.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element disembarkUnit(ServerPlayer serverPlayer, ServerUnit serverUnit) {
<span class="nc bnc" id="L1901" title="All 2 branches missed.">		if (serverUnit.isNaval()) {</span>
<span class="nc" id="L1902">			return DOMMessage.clientError(&quot;Naval unit &quot; + serverUnit.getId() + &quot; can not disembark.&quot;);</span>
		}
<span class="nc" id="L1904">		Unit carrier = serverUnit.getCarrier();</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">		if (carrier == null) {</span>
<span class="nc" id="L1906">			return DOMMessage.clientError(&quot;Unit &quot; + serverUnit.getId() + &quot; is not embarked.&quot;);</span>
		}

<span class="nc" id="L1909">		ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L1911">		Location newLocation = carrier.getLocation();</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">		List&lt;Tile&gt; newTiles = (newLocation.getTile() == null) ? null</span>
<span class="nc" id="L1913">				: serverUnit.collectNewTiles(newLocation.getTile());</span>
<span class="nc" id="L1914">		serverUnit.setLocation(newLocation);// -vis(serverPlayer)</span>
<span class="nc" id="L1915">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L1916">		serverUnit.setMovesLeft(0); // In Col1 disembark consumes whole move.</span>
<span class="nc" id="L1917">		cs.add(See.perhaps(), (FreeColGameObject) newLocation);</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">		if (newTiles != null) {</span>
<span class="nc" id="L1919">			serverPlayer.csSeeNewTiles(newTiles, cs);</span>
		}

		// Others can (potentially) see the location.
<span class="nc" id="L1923">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1924">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Combat. Public for the test suite.
	 *
	 * @param attackerPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; who is attacking.
	 * @param attacker
	 *            The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is attacking.
	 * @param defender
	 *            The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is defending.
	 * @param crs
	 *            A list of &lt;code&gt;CombatResult&lt;/code&gt;s defining the result.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element combat(ServerPlayer attackerPlayer, FreeColGameObject attacker, FreeColGameObject defender,
			List&lt;CombatResult&gt; crs) {
<span class="fc" id="L1942">		ChangeSet cs = new ChangeSet();</span>
		try {
<span class="fc" id="L1944">			attackerPlayer.csCombat(attacker, defender, crs, random, cs);</span>
<span class="nc" id="L1945">		} catch (IllegalStateException e) {</span>
<span class="nc" id="L1946">			logger.log(Level.WARNING, &quot;Combat FAIL&quot;, e);</span>
<span class="nc" id="L1947">			return DOMMessage.clientError(e.getMessage());</span>
<span class="fc" id="L1948">		}</span>
<span class="fc" id="L1949">		getGame().sendToOthers(attackerPlayer, cs);</span>
<span class="fc" id="L1950">		return cs.build(attackerPlayer);</span>
	}

	/**
	 * Ask about learning a skill at an IndianSettlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is learning.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is learning.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; to learn from.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element askLearnSkill(ServerPlayer serverPlayer, Unit unit, IndianSettlement settlement) {
<span class="nc" id="L1965">		ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L1967">		csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="nc" id="L1968">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L1969">		tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L1970">		cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L1971">		unit.setMovesLeft(0);</span>
<span class="nc" id="L1972">		cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>

		// Do not update others, nothing to see yet.
<span class="nc" id="L1975">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Learn a skill at an IndianSettlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is learning.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is learning.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; to learn from.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element learnFromIndianSettlement(ServerPlayer serverPlayer, Unit unit, IndianSettlement settlement) {
		// Sanity checks.
<span class="nc" id="L1991">		UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">		if (skill == null) {</span>
<span class="nc" id="L1993">			return DOMMessage.clientError(&quot;No skill to learn at &quot; + settlement.getName());</span>
		}
<span class="nc bnc" id="L1995" title="All 2 branches missed.">		if (!unit.getType().canBeUpgraded(skill, ChangeType.NATIVES)) {</span>
<span class="nc" id="L1996">			return DOMMessage</span>
<span class="nc" id="L1997">					.clientError(&quot;Unit &quot; + unit + &quot; can not learn skill &quot; + skill + &quot; at &quot; + settlement.getName());</span>
		}

		// Try to learn
<span class="nc" id="L2001">		final Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L2002">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2003">		unit.setMovesLeft(0);</span>
<span class="nc" id="L2004">		csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="pc bnc" id="L2005" title="All 3 branches missed.">		switch (settlement.getAlarm(serverPlayer).getLevel()) {</span>
		case HATEFUL: // Killed, might be visible to other players.
<span class="nc" id="L2007">			cs.add(See.perhaps().always(serverPlayer), (FreeColGameObject) unit.getLocation());</span>
<span class="nc" id="L2008">			cs.addRemove(See.perhaps().always(serverPlayer), unit.getLocation(), unit);// -vis(serverPlayer)</span>
<span class="nc" id="L2009">			unit.dispose();</span>
<span class="nc" id="L2010">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L2011">			break;</span>
		case ANGRY: // Learn nothing, not even a pet update
<span class="nc" id="L2013">			cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc" id="L2014">			break;</span>
		default:
			// Teach the unit, and expend the skill if necessary.
			// Do a full information update as the unit is in the settlement.
<span class="nc" id="L2018">			unit.changeType(skill);// -vis(serverPlayer)</span>
<span class="nc" id="L2019">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L2020">			cs.add(See.perhaps(), unit);</span>
<span class="nc bnc" id="L2021" title="All 4 branches missed.">			if (!settlement.isCapital() &amp;&amp; !(settlement.hasMissionary(serverPlayer)</span>
<span class="nc bnc" id="L2022" title="All 2 branches missed.">					&amp;&amp; spec.getBoolean(GameOptions.ENHANCED_MISSIONARIES))) {</span>
<span class="nc" id="L2023">				settlement.setLearnableSkill(null);</span>
			}
			break;
		}
<span class="nc" id="L2027">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L2028">		tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2029">		cs.add(See.only(serverPlayer), tile);</span>

		// Others always see the unit, it may have died or been taught.
<span class="nc" id="L2032">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2033">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Demand a tribute from a native settlement.
	 *
	 * FIXME: Move TURNS_PER_TRIBUTE magic number to the spec.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; demanding the tribute.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is demanding the tribute.
	 * @param settlement
	 *            The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; demanded of.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element demandTribute(ServerPlayer serverPlayer, Unit unit, ServerIndianSettlement settlement) {
<span class="nc" id="L2050">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2051">		final int TURNS_PER_TRIBUTE = 5;</span>

<span class="nc" id="L2053">		csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L2055">		Player indianPlayer = settlement.getOwner();</span>
<span class="nc" id="L2056">		int gold = 0;</span>
<span class="nc" id="L2057">		int year = getGame().getTurn().getNumber();</span>
<span class="nc" id="L2058">		RandomRange gifts = settlement.getType().getGifts(unit);</span>
<span class="nc bnc" id="L2059" title="All 4 branches missed.">		if (settlement.getLastTribute() + TURNS_PER_TRIBUTE &lt; year &amp;&amp; gifts != null) {</span>
<span class="nc bnc" id="L2060" title="All 3 branches missed.">			switch (indianPlayer.getTension(serverPlayer).getLevel()) {</span>
			case HAPPY:
			case CONTENT:
<span class="nc" id="L2063">				gold = Math.min(gifts.getAmount(&quot;Tribute&quot;, random, true) / 10, 100);</span>
<span class="nc" id="L2064">				break;</span>
			case DISPLEASED:
<span class="nc" id="L2066">				gold = Math.min(gifts.getAmount(&quot;Tribute&quot;, random, true) / 20, 100);</span>
<span class="nc" id="L2067">				break;</span>
			case ANGRY:
			case HATEFUL:
			default:
<span class="nc" id="L2071">				gold = 0; // No tribute for you.</span>
				break;
			}
		}

		// Increase tension whether we paid or not. Apply tension
		// directly to the settlement and let propagation work.
<span class="nc" id="L2078">		settlement.csModifyAlarm(serverPlayer, Tension.TENSION_ADD_NORMAL, true, cs);</span>
<span class="nc" id="L2079">		settlement.setLastTribute(year);</span>
		ModelMessage m;
<span class="nc bnc" id="L2081" title="All 2 branches missed.">		if (gold &gt; 0) {</span>
<span class="nc" id="L2082">			indianPlayer.modifyGold(-gold);</span>
<span class="nc" id="L2083">			serverPlayer.modifyGold(gold);</span>
<span class="nc" id="L2084">			cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L2085">			m = new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;scoutSettlement.tributeAgree&quot;, unit,</span>
<span class="nc" id="L2086">					settlement).addAmount(&quot;%amount%&quot;, gold);</span>
		} else {
<span class="nc" id="L2088">			m = new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;scoutSettlement.tributeDisagree&quot;, unit,</span>
					settlement);
		}
<span class="nc" id="L2091">		cs.addMessage(See.only(serverPlayer), m);</span>
<span class="nc" id="L2092">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L2093">		tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2094">		cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2095">		unit.setMovesLeft(0);</span>
<span class="nc" id="L2096">		cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>

		// Do not update others, this is all private.
<span class="nc" id="L2099">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Scout a native settlement, that is, the contacting action that generates
	 * the greeting dialog.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is scouting.
	 * @param unit
	 *            The scout &lt;code&gt;Unit&lt;/code&gt;.
	 * @param settlement
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; to scout.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element scoutIndianSettlement(ServerPlayer serverPlayer, Unit unit, IndianSettlement settlement) {
<span class="nc" id="L2115">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2116">		Tile tile = settlement.getTile();</span>

<span class="nc" id="L2118">		csVisit(serverPlayer, settlement, -1, cs);</span>
<span class="nc" id="L2119">		tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2120">		cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2121">		cs.addAttribute(See.only(serverPlayer), &quot;settlements&quot;,</span>
<span class="nc" id="L2122">				Integer.toString(settlement.getOwner().getSettlements().size()));</span>

		// This is private.
<span class="nc" id="L2125">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Speak to the chief at a native settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is scouting.
	 * @param unit
	 *            The scout &lt;code&gt;Unit&lt;/code&gt;.
	 * @param settlement
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; to scout.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element scoutSpeakToChief(ServerPlayer serverPlayer, Unit unit, IndianSettlement settlement) {
<span class="nc" id="L2140">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2141">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L2142">		boolean tileDirty = settlement.setVisited(serverPlayer);</span>
		String result;

		// Hateful natives kill the scout right away.
<span class="nc" id="L2146">		Tension tension = settlement.getAlarm(serverPlayer);</span>
<span class="nc bnc" id="L2147" title="All 2 branches missed.">		if (tension.getLevel() == Tension.Level.HATEFUL) {</span>
<span class="nc" id="L2148">			cs.add(See.perhaps().always(serverPlayer), (FreeColGameObject) unit.getLocation());</span>
<span class="nc" id="L2149">			cs.addRemove(See.perhaps().always(serverPlayer), unit.getLocation(), unit);// -vis(serverPlayer)</span>
<span class="nc" id="L2150">			unit.dispose();</span>
<span class="nc" id="L2151">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L2152">			result = &quot;die&quot;;</span>
		} else {
			// Otherwise player gets to visit, and learn about the settlement.
<span class="nc" id="L2155">			List&lt;UnitType&gt; scoutTypes = getGame().getSpecification().getUnitTypesWithAbility(Ability.EXPERT_SCOUT);</span>
<span class="nc bnc" id="L2156" title="All 2 branches missed.">			UnitType scoutSkill = (scoutTypes.isEmpty()) ? null : scoutTypes.get(0);</span>
<span class="nc" id="L2157">			int radius = unit.getLineOfSight();</span>
<span class="nc" id="L2158">			UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc" id="L2159">			int rnd = randomInt(logger, &quot;scouting&quot;, random, 10);</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">			if (settlement.hasAnyScouted()) {</span>
				// Do nothing if already spoken to.
<span class="nc" id="L2162">				result = &quot;nothing&quot;;</span>
<span class="nc bnc" id="L2163" title="All 6 branches missed.">			} else if (scoutSkill != null &amp;&amp; unit.getType() != scoutSkill</span>
<span class="nc bnc" id="L2164" title="All 4 branches missed.">					&amp;&amp; ((skill != null &amp;&amp; skill.hasAbility(Ability.EXPERT_SCOUT)) || rnd == 0)) {</span>
				// If the scout can be taught to be an expert it will be.
<span class="nc" id="L2166">				unit.changeType(scoutSkill);// -vis(serverPlayer)</span>
<span class="nc" id="L2167">				serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="nc" id="L2168">				result = &quot;expert&quot;;</span>
			} else {
				// Choose tales 1/3 of the time, or if there are no beads.
<span class="nc" id="L2171">				RandomRange gifts = settlement.getType().getGifts(unit);</span>
<span class="nc bnc" id="L2172" title="All 2 branches missed.">				int gold = (gifts == null) ? 0 : gifts.getAmount(&quot;Base beads amount&quot;, random, true);</span>
<span class="nc bnc" id="L2173" title="All 4 branches missed.">				if (gold &lt;= 0 || rnd &lt;= 3) {</span>
<span class="nc" id="L2174">					radius = Math.max(radius, IndianSettlement.TALES_RADIUS);</span>
<span class="nc" id="L2175">					result = &quot;tales&quot;;</span>
				} else {
<span class="nc bnc" id="L2177" title="All 2 branches missed.">					if (unit.hasAbility(Ability.EXPERT_SCOUT)) {</span>
<span class="nc" id="L2178">						gold = (gold * 11) / 10; // FIXME: magic number</span>
					}
<span class="nc" id="L2180">					serverPlayer.modifyGold(gold);</span>
<span class="nc" id="L2181">					settlement.getOwner().modifyGold(-gold);</span>
<span class="nc" id="L2182">					result = &quot;beads&quot;;</span>
				}
			}

			// Have now spoken to the chief.
<span class="nc" id="L2187">			csVisit(serverPlayer, settlement, 1, cs);</span>
<span class="nc" id="L2188">			tileDirty = true;</span>

			// Update settlement tile with new information, and any
			// newly visible tiles, possibly with enhanced radius.
<span class="nc" id="L2192">			Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">			for (Tile t : tile.getSurroundingTiles(1, radius)) {</span>
<span class="nc bnc" id="L2194" title="All 6 branches missed.">				if (!serverPlayer.canSee(t) &amp;&amp; (t.isLand() || t.isShore())) {</span>
<span class="nc" id="L2195">					tiles.add(t);</span>
				}
<span class="nc" id="L2197">			}</span>
<span class="nc" id="L2198">			cs.add(See.only(serverPlayer), serverPlayer.exploreTiles(tiles));</span>

			// If the unit was promoted, update it completely, otherwise just
			// update moves and possibly gold+score.
<span class="nc" id="L2202">			unit.setMovesLeft(0);</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">			if (&quot;expert&quot;.equals(result)) {</span>
<span class="nc" id="L2204">				cs.add(See.perhaps(), unit);</span>
			} else {
<span class="nc" id="L2206">				cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc bnc" id="L2207" title="All 2 branches missed.">				if (&quot;beads&quot;.equals(result)) {</span>
<span class="nc" id="L2208">					cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
				}
			}
		}
<span class="nc bnc" id="L2212" title="All 2 branches missed.">		if (tileDirty) {</span>
<span class="nc" id="L2213">			tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2214">			cs.add(See.only(serverPlayer), tile);</span>
		}

		// Always add result.
<span class="nc" id="L2218">		cs.addAttribute(See.only(serverPlayer), &quot;result&quot;, result);</span>

		// Other players may be able to see unit disappearing, or
		// learning.
<span class="nc" id="L2222">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2223">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Denounce an existing mission.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is denouncing.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; denouncing.
	 * @param settlement
	 *            The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; containing the mission
	 *            to denounce.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element denounceMission(ServerPlayer serverPlayer, Unit unit, ServerIndianSettlement settlement) {
<span class="nc" id="L2239">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2240">		csVisit(serverPlayer, settlement, 0, cs);</span>

		// Determine result
<span class="nc" id="L2243">		Unit missionary = settlement.getMissionary();</span>
<span class="nc bnc" id="L2244" title="All 2 branches missed.">		if (missionary == null) {</span>
<span class="nc" id="L2245">			return DOMMessage.clientError(&quot;Denouncing null missionary&quot;);</span>
		}
<span class="nc" id="L2247">		ServerPlayer enemy = (ServerPlayer) missionary.getOwner();</span>
<span class="nc" id="L2248">		double denounce = randomDouble(logger, &quot;Denounce base&quot;, random) * enemy.getImmigration()</span>
<span class="nc" id="L2249">				/ (serverPlayer.getImmigration() + 1);</span>
<span class="nc bnc" id="L2250" title="All 2 branches missed.">		if (missionary.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L2251">			denounce += 0.2;</span>
		}
<span class="nc bnc" id="L2253" title="All 2 branches missed.">		if (unit.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L2254">			denounce -= 0.2;</span>
		}

<span class="nc bnc" id="L2257" title="All 2 branches missed.">		if (denounce &lt; 0.5) { // Success, remove old mission and establish ours</span>
<span class="nc" id="L2258">			return establishMission(serverPlayer, unit, settlement);</span>
		}

		// Denounce failed
<span class="nc" id="L2262">		Player owner = settlement.getOwner();</span>
<span class="nc" id="L2263">		cs.add(See.only(serverPlayer), settlement);</span>
<span class="nc" id="L2264">		cs.addMessage(See.only(serverPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;indianSettlement.mission.noDenounce&quot;,
<span class="nc" id="L2266">						serverPlayer, unit).addStringTemplate(&quot;%nation%&quot;, owner.getNationLabel()));</span>
<span class="nc" id="L2267">		cs.addMessage(See.only(enemy),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;indianSettlement.mission.enemyDenounce&quot;,
<span class="nc" id="L2269">						enemy, settlement).addStringTemplate(&quot;%enemy%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L2270">								.addStringTemplate(&quot;%settlement%&quot;, settlement.getLocationLabelFor(enemy))</span>
<span class="nc" id="L2271">								.addStringTemplate(&quot;%nation%&quot;, owner.getNationLabel()));</span>
<span class="nc" id="L2272">		cs.add(See.perhaps().always(serverPlayer), (FreeColGameObject) unit.getLocation());</span>
<span class="nc" id="L2273">		cs.addRemove(See.perhaps().always(serverPlayer), unit.getLocation(), unit);// -vis(serverPlayer)</span>
<span class="nc" id="L2274">		unit.dispose();</span>
<span class="nc" id="L2275">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>

		// Others can see missionary disappear
<span class="nc" id="L2278">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2279">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Establish a new mission.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is establishing.
	 * @param unit
	 *            The missionary &lt;code&gt;Unit&lt;/code&gt;.
	 * @param settlement
	 *            The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to establish at.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element establishMission(ServerPlayer serverPlayer, Unit unit, ServerIndianSettlement settlement) {
<span class="fc" id="L2294">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2295">		csVisit(serverPlayer, settlement, 0, cs);</span>

		// Result depends on tension wrt this settlement.
		// Establish if at least not angry.
<span class="fc" id="L2299">		final Tension tension = settlement.getAlarm(serverPlayer);</span>
<span class="pc bpc" id="L2300" title="1 of 3 branches missed.">		switch (tension.getLevel()) {</span>
		case HATEFUL:
		case ANGRY:
<span class="fc" id="L2303">			cs.add(See.perhaps().always(serverPlayer), (FreeColGameObject) unit.getLocation());</span>
<span class="fc" id="L2304">			cs.addRemove(See.perhaps().always(serverPlayer), unit.getLocation(), unit);// -vis(serverPlayer)</span>
<span class="fc" id="L2305">			unit.dispose();</span>
<span class="fc" id="L2306">			serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>
<span class="fc" id="L2307">			break;</span>

		case HAPPY:
		case CONTENT:
		case DISPLEASED:
<span class="pc bpc" id="L2312" title="1 of 2 branches missed.">			if (settlement.hasMissionary()) {</span>
<span class="nc" id="L2313">				settlement.csKillMissionary(false, cs);</span>
			}
			// Always show the tile the unit was on
<span class="fc" id="L2316">			cs.add(See.perhaps().always(serverPlayer), unit.getTile());</span>

<span class="fc" id="L2318">			settlement.csChangeMissionary(unit, cs);// +vis(serverPlayer)</span>
			break;
		}

		// Add the descriptive message.
<span class="fc" id="L2323">		final StringTemplate nation = settlement.getOwner().getNationLabel();</span>
<span class="fc" id="L2324">		cs.addMessage(See.only(serverPlayer),</span>
				new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="fc" id="L2326">						&quot;indianSettlement.mission.&quot; + tension.getKey(), serverPlayer, unit)</span>
<span class="fc" id="L2327">								.addStringTemplate(&quot;%nation%&quot;, nation));</span>

		// Others can see missionary disappear and settlement acquire
		// mission.
<span class="fc" id="L2331">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L2332">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Incite a settlement against an enemy.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is inciting.
	 * @param unit
	 *            The missionary &lt;code&gt;Unit&lt;/code&gt; inciting.
	 * @param settlement
	 *            The &lt;code&gt;IndianSettlement&lt;/code&gt; to incite.
	 * @param enemy
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to be incited against.
	 * @param gold
	 *            The amount of gold in the bribe.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element incite(ServerPlayer serverPlayer, Unit unit, IndianSettlement settlement, ServerPlayer enemy,
			int gold) {
<span class="nc" id="L2352">		ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L2354">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L2355">		csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="nc" id="L2356">		tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2357">		cs.add(See.only(serverPlayer), tile);</span>

		// How much gold will be needed?
<span class="nc" id="L2360">		ServerPlayer enemyPlayer = enemy;</span>
<span class="nc" id="L2361">		ServerPlayer nativePlayer = (ServerPlayer) settlement.getOwner();</span>
<span class="nc" id="L2362">		int payingValue = nativePlayer.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L2363">		int targetValue = nativePlayer.getTension(enemyPlayer).getValue();</span>
<span class="nc bnc" id="L2364" title="All 2 branches missed.">		int goldToPay = (payingValue &gt; targetValue) ? 10000 : 5000;</span>
<span class="nc" id="L2365">		goldToPay += 20 * (payingValue - targetValue);</span>
<span class="nc" id="L2366">		goldToPay = Math.max(goldToPay, 650);</span>

		// Try to incite?
<span class="nc bnc" id="L2369" title="All 2 branches missed.">		if (gold &lt; 0) { // Initial enquiry.</span>
<span class="nc" id="L2370">			cs.addAttribute(See.only(serverPlayer), &quot;gold&quot;, Integer.toString(goldToPay));</span>
<span class="nc bnc" id="L2371" title="All 4 branches missed.">		} else if (gold &lt; goldToPay || !serverPlayer.checkGold(gold)) {</span>
<span class="nc" id="L2372">			cs.addMessage(See.only(serverPlayer),</span>
					new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;indianSettlement.inciteGoldFail&quot;,
<span class="nc" id="L2374">							serverPlayer, settlement).addStringTemplate(&quot;%player%&quot;, enemyPlayer.getNationLabel())</span>
<span class="nc" id="L2375">									.addAmount(&quot;%amount%&quot;, goldToPay));</span>
<span class="nc" id="L2376">			cs.addAttribute(See.only(serverPlayer), &quot;gold&quot;, &quot;0&quot;);</span>
<span class="nc" id="L2377">			unit.setMovesLeft(0);</span>
<span class="nc" id="L2378">			cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
		} else {
			// Success. Raise the tension for the native player with respect
			// to the European player. Let resulting stance changes happen
			// naturally in the AI player turn/s.
<span class="nc" id="L2383">			nativePlayer.csModifyTension(enemyPlayer, Tension.WAR_MODIFIER, cs);// +til</span>
<span class="nc" id="L2384">			enemyPlayer.csModifyTension(serverPlayer, Tension.TENSION_ADD_WAR_INCITER, cs);// +til</span>
<span class="nc" id="L2385">			cs.addAttribute(See.only(serverPlayer), &quot;gold&quot;, Integer.toString(gold));</span>
<span class="nc" id="L2386">			serverPlayer.modifyGold(-gold);</span>
<span class="nc" id="L2387">			nativePlayer.modifyGold(gold);</span>
<span class="nc" id="L2388">			cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2389">			unit.setMovesLeft(0);</span>
<span class="nc" id="L2390">			cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
		}

		// Others might include enemy.
<span class="nc" id="L2394">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2395">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Set a unit destination.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to set the destination for.
	 * @param destination
	 *            The &lt;code&gt;Location&lt;/code&gt; to set as destination.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element setDestination(ServerPlayer serverPlayer, Unit unit, Location destination) {
<span class="nc bnc" id="L2410" title="All 2 branches missed.">		if (unit.getTradeRoute() != null) {</span>
			// Override destination to bring the unit to port.
<span class="nc bnc" id="L2412" title="All 4 branches missed.">			if (destination == null &amp;&amp; unit.isAtSea()) {</span>
<span class="nc" id="L2413">				destination = unit.getStop().getLocation();</span>
			}
<span class="nc" id="L2415">			unit.setTradeRoute(null);</span>
		}
<span class="nc" id="L2417">		unit.setDestination(destination);</span>

		// Others can not see a destination change.
<span class="nc" id="L2420">		return new ChangeSet().add(See.only(serverPlayer), unit).build(serverPlayer);</span>
	}

	/**
	 * Set a unit stop.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to set the destination for.
	 * @param index
	 *            the index
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element setCurrentStop(ServerPlayer serverPlayer, Unit unit, int index) {
<span class="nc" id="L2435">		TradeRoute tr = unit.getTradeRoute();</span>
<span class="nc bnc" id="L2436" title="All 2 branches missed.">		if (tr == null) {</span>
<span class="nc" id="L2437">			return DOMMessage.clientError(&quot;Unit has no trade route to set stop for.&quot;);</span>
<span class="nc bnc" id="L2438" title="All 4 branches missed.">		} else if (index &lt; 0 || index &gt;= tr.getStops().size()) {</span>
<span class="nc" id="L2439">			return DOMMessage.clientError(&quot;Stop index out of range [0..&quot; + tr.getStops().size() + &quot;]: &quot; + index);</span>
		}

<span class="nc" id="L2442">		unit.setCurrentStop(index);</span>

		// Others can not see a stop change.
<span class="nc" id="L2445">		return new ChangeSet().add(See.only(serverPlayer), unit).build(serverPlayer);</span>
	}

	/**
	 * Buy from a settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that will carry the goods.
	 * @param settlement
	 *            The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to buy from.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to buy.
	 * @param amount
	 *            How much gold to pay.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element buyFromSettlement(ServerPlayer serverPlayer, Unit unit, ServerIndianSettlement settlement,
			Goods goods, int amount) {
<span class="nc" id="L2465">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2466">		csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L2468">		TradeSession session = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L2469" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L2470">			return DOMMessage.clientError(&quot;Trying to buy without opening a transaction session&quot;);</span>
		}
<span class="nc bnc" id="L2472" title="All 2 branches missed.">		if (!session.getBuy()) {</span>
<span class="nc" id="L2473">			return DOMMessage.clientError(&quot;Trying to buy in a session where buying is not allowed.&quot;);</span>
		}
<span class="nc bnc" id="L2475" title="All 2 branches missed.">		if (!unit.hasSpaceLeft()) {</span>
<span class="nc" id="L2476">			return DOMMessage.clientError(&quot;Unit is full, unable to buy.&quot;);</span>
		}

		// Check that this is the agreement that was made
<span class="nc" id="L2480">		AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L2481">		int returnGold = ai.buyProposition(unit, settlement, goods, amount);</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">		if (returnGold != amount) {</span>
<span class="nc" id="L2483">			return DOMMessage.clientError(&quot;This was not the price we agreed upon! Cheater?&quot;);</span>
		}
<span class="nc bnc" id="L2485" title="All 2 branches missed.">		if (!serverPlayer.checkGold(amount)) { // Check this is funded.</span>
<span class="nc" id="L2486">			return DOMMessage.clientError(&quot;Insufficient gold to buy.&quot;);</span>
		}

		// Valid, make the trade.
<span class="nc" id="L2490">		moveGoods(settlement, goods.getType(), goods.getAmount(), unit);</span>
<span class="nc" id="L2491">		cs.add(See.perhaps(), unit);</span>

<span class="nc" id="L2493">		Player settlementPlayer = settlement.getOwner();</span>
<span class="nc" id="L2494">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L2495">		settlement.updateWantedGoods();</span>
<span class="nc" id="L2496">		settlementPlayer.modifyGold(amount);</span>
<span class="nc" id="L2497">		serverPlayer.modifyGold(-amount);</span>
<span class="nc" id="L2498">		settlement.csModifyAlarm(serverPlayer, -amount / 50, true, cs);</span>
<span class="nc" id="L2499">		tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2500">		cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2501">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2502">		session.setBuy();</span>
<span class="nc" id="L2503">		logger.finest(serverPlayer.getName() + &quot; &quot; + unit + &quot; buys &quot; + goods + &quot; at &quot; + settlement.getName() + &quot; for &quot;</span>
				+ amount);

		// Others can see the unit capacity.
<span class="nc" id="L2507">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2508">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Sell to a settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is selling.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
	 * @param settlement
	 *            The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to sell to.
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to sell.
	 * @param amount
	 *            How much gold to expect.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element sellToSettlement(ServerPlayer serverPlayer, Unit unit, ServerIndianSettlement settlement,
			Goods goods, int amount) {
<span class="nc" id="L2528">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2529">		csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L2531">		TradeSession session = TransactionSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L2533">			return DOMMessage.clientError(&quot;Trying to sell without opening a transaction session&quot;);</span>
		}
<span class="nc bnc" id="L2535" title="All 2 branches missed.">		if (!session.getSell()) {</span>
<span class="nc" id="L2536">			return DOMMessage.clientError(&quot;Trying to sell in a session where selling is not allowed.&quot;);</span>
		}

		// Check that the gold is the agreed amount
<span class="nc" id="L2540">		AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L2541">		int returnGold = ai.sellProposition(unit, settlement, goods, amount);</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">		if (returnGold != amount) {</span>
<span class="nc" id="L2543">			return DOMMessage.clientError(&quot;This was not the price we agreed upon! Cheater?&quot;);</span>
		}

		// Valid, make the trade.
<span class="nc" id="L2547">		moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L2548">		cs.add(See.perhaps(), unit);</span>

<span class="nc" id="L2550">		Player settlementPlayer = settlement.getOwner();</span>
<span class="nc" id="L2551">		settlementPlayer.modifyGold(-amount);</span>
<span class="nc" id="L2552">		serverPlayer.modifyGold(amount);</span>
<span class="nc" id="L2553">		settlement.csModifyAlarm(serverPlayer, -amount / 500, true, cs);</span>
<span class="nc" id="L2554">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L2555">		settlement.updateWantedGoods();</span>
<span class="nc" id="L2556">		tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2557">		cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2558">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2559">		session.setSell();</span>
<span class="nc" id="L2560">		cs.addSale(serverPlayer, settlement, goods.getType(), Math.round((float) amount / goods.getAmount()));</span>
<span class="nc" id="L2561">		logger.finest(serverPlayer.getName() + &quot; &quot; + unit + &quot; sells &quot; + goods + &quot; at &quot; + settlement.getName() + &quot; for &quot;</span>
				+ amount);

		// Others can see the unit capacity.
<span class="nc" id="L2565">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2566">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Deliver gift to settlement. Note that this includes both European and
	 * native gifts.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is delivering.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is delivering.
	 * @param settlement
	 *            the settlement
	 * @param goods
	 *            The &lt;code&gt;Goods&lt;/code&gt; to deliver.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element deliverGiftToSettlement(ServerPlayer serverPlayer, Unit unit, Settlement settlement, Goods goods) {
<span class="nc" id="L2584">		TradeSession session = TransactionSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L2585" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L2586">			return DOMMessage.clientError(&quot;Trying to deliver gift without opening a session&quot;);</span>
		}
<span class="nc bnc" id="L2588" title="All 2 branches missed.">		if (!session.getGift()) {</span>
<span class="nc" id="L2589">			return DOMMessage.clientError(&quot;Trying to deliver gift in a session where gift giving is not allowed: &quot;</span>
					+ unit + &quot; &quot; + settlement + &quot; &quot; + session);
		}

<span class="nc" id="L2593">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2594">		Tile tile = settlement.getTile();</span>
<span class="nc" id="L2595">		moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L2596">		cs.add(See.perhaps(), unit);</span>
<span class="nc bnc" id="L2597" title="All 2 branches missed.">		if (settlement instanceof ServerIndianSettlement) {</span>
<span class="nc" id="L2598">			ServerIndianSettlement sis = (ServerIndianSettlement) settlement;</span>
<span class="nc" id="L2599">			csVisit(serverPlayer, sis, 0, cs);</span>
<span class="nc" id="L2600">			sis.csModifyAlarm(serverPlayer, -sis.getPriceToBuy(goods) / 50, true, cs);</span>
<span class="nc" id="L2601">			sis.updateWantedGoods();</span>
<span class="nc" id="L2602">			tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2603">			cs.add(See.only(serverPlayer), tile);</span>
		}
<span class="nc" id="L2605">		session.setGift();</span>

		// Inform the receiver of the gift.
<span class="nc" id="L2608">		ModelMessage m = new ModelMessage(ModelMessage.MessageType.GIFT_GOODS, &quot;deliverGift.goods&quot;, settlement,</span>
<span class="nc" id="L2609">				goods.getType()).addStringTemplate(&quot;%player%&quot;, serverPlayer.getNationLabel()).addNamed(&quot;%type%&quot;, goods)</span>
<span class="nc" id="L2610">						.addAmount(&quot;%amount%&quot;, goods.getAmount()).addName(&quot;%settlement%&quot;, settlement.getName());</span>
<span class="nc" id="L2611">		cs.addMessage(See.only(serverPlayer), m);</span>
<span class="nc" id="L2612">		ServerPlayer receiver = (ServerPlayer) settlement.getOwner();</span>
<span class="nc bnc" id="L2613" title="All 4 branches missed.">		if (receiver.isConnected() &amp;&amp; settlement instanceof Colony) {</span>
<span class="nc" id="L2614">			cs.add(See.only(receiver), unit);</span>
<span class="nc" id="L2615">			cs.add(See.only(receiver), settlement);</span>
<span class="nc" id="L2616">			cs.addMessage(See.only(receiver), m);</span>
		}
<span class="nc" id="L2618">		logger.info(&quot;Gift delivered by unit: &quot; + unit.getId() + &quot; to settlement: &quot; + settlement.getName());</span>

		// Others can see unit capacity, receiver gets it own items.
<span class="nc" id="L2621">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2622">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Load goods.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is loading.
	 * @param loc
	 *            The &lt;code&gt;Location&lt;/code&gt; where the goods are.
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to load.
	 * @param amount
	 *            The amount of goods to load.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; to load.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element loadGoods(ServerPlayer serverPlayer, Location loc, GoodsType goodsType, int amount, Unit carrier) {
<span class="fc bfc" id="L2641" title="All 2 branches covered.">		if (loc instanceof Europe) {</span>
<span class="fc bfc" id="L2642" title="All 2 branches covered.">			if (carrier.isInEurope()) {</span>
<span class="fc" id="L2643">				return buyGoods(serverPlayer, goodsType, amount, carrier);</span>
			} else {
<span class="fc" id="L2645">				return DOMMessage.clientError(&quot;Carrier not in Europe: &quot; + loc);</span>
			}
		}
		// All loading locations other than Europe are GoodsLocations
<span class="pc bpc" id="L2649" title="1 of 2 branches missed.">		if (!(loc instanceof GoodsLocation)) {</span>
<span class="nc" id="L2650">			return DOMMessage.clientError(&quot;Not a goods location: &quot; + loc);</span>
		}
<span class="fc" id="L2652">		GoodsLocation gl = (GoodsLocation) loc;</span>
<span class="fc bfc" id="L2653" title="All 2 branches covered.">		if (!carrier.isAtLocation(loc)) {</span>
<span class="fc" id="L2654">			return DOMMessage.clientError(&quot;Carrier not at location: &quot; + loc);</span>
		}
<span class="fc bfc" id="L2656" title="All 2 branches covered.">		if (carrier.getLoadableAmount(goodsType) &lt; amount) {</span>
<span class="fc" id="L2657">			return DOMMessage.clientError(&quot;Too much goods&quot;);</span>
		}
<span class="pc bpc" id="L2659" title="1 of 2 branches missed.">		if (gl.getGoodsCount(goodsType) &lt; amount) {</span>
<span class="nc" id="L2660">			return DOMMessage.clientError(&quot;Not enough goods (&quot; + gl.getGoodsCount(goodsType) + &quot; &lt; &quot; + amount + &quot; &quot;</span>
<span class="nc" id="L2661">					+ goodsType.getSuffix() + &quot;) at &quot; + gl);</span>
		}

<span class="fc" id="L2664">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2665">		moveGoods(gl, goodsType, amount, carrier);</span>
<span class="fc" id="L2666">		logger.finest(Messages.message(loc.getLocationLabel()) + &quot; loaded &quot; + amount + &quot; &quot; + goodsType.getSuffix()</span>
				+ &quot; onto &quot; + carrier);
<span class="fc" id="L2668">		cs.add(See.only(serverPlayer), gl.getGoodsContainer());</span>
<span class="fc" id="L2669">		cs.add(See.only(serverPlayer), carrier.getGoodsContainer());</span>
<span class="pc bpc" id="L2670" title="1 of 2 branches missed.">		if (carrier.getInitialMovesLeft() != carrier.getMovesLeft()) {</span>
<span class="nc" id="L2671">			carrier.setMovesLeft(0);</span>
<span class="nc" id="L2672">			cs.addPartial(See.only(serverPlayer), carrier, &quot;movesLeft&quot;);</span>
		}

		// Invisible in settlement
<span class="fc" id="L2676">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Unload goods.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is unloading.
	 * @param goodsType
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to unload.
	 * @param amount
	 *            The amount of goods to unload.
	 * @param carrier
	 *            The &lt;code&gt;Unit&lt;/code&gt; to unload.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element unloadGoods(ServerPlayer serverPlayer, GoodsType goodsType, int amount, Unit carrier) {
<span class="fc bfc" id="L2693" title="All 2 branches covered.">		if (carrier.getGoodsCount(goodsType) &lt; amount) {</span>
<span class="fc" id="L2694">			return DOMMessage.clientError(&quot;Too few goods&quot;);</span>
		}
<span class="fc bfc" id="L2696" title="All 2 branches covered.">		if (carrier.isInEurope()) {</span>
<span class="fc" id="L2697">			return sellGoods(serverPlayer, goodsType, amount, carrier);</span>
		}

<span class="fc" id="L2700">		ChangeSet cs = new ChangeSet();</span>
<span class="fc bfc" id="L2701" title="All 2 branches covered.">		if (carrier.getSettlement() != null) {</span>
<span class="fc" id="L2702">			Settlement settlement = carrier.getSettlement();</span>
<span class="fc" id="L2703">			moveGoods(carrier, goodsType, amount, settlement);</span>
<span class="fc" id="L2704">			logger.finest(</span>
<span class="fc" id="L2705">					carrier + &quot; unloaded &quot; + amount + &quot; &quot; + goodsType.getSuffix() + &quot; to &quot; + settlement.getName());</span>
<span class="fc" id="L2706">			cs.add(See.only(serverPlayer), settlement.getGoodsContainer());</span>
<span class="fc" id="L2707">			cs.add(See.only(serverPlayer), carrier.getGoodsContainer());</span>
<span class="pc bpc" id="L2708" title="1 of 2 branches missed.">			if (carrier.getInitialMovesLeft() != carrier.getMovesLeft()) {</span>
<span class="nc" id="L2709">				carrier.setMovesLeft(0);</span>
<span class="nc" id="L2710">				cs.addPartial(See.only(serverPlayer), carrier, &quot;movesLeft&quot;);</span>
			}
<span class="fc" id="L2712">		} else { // Dump of goods onto a tile</span>
<span class="fc" id="L2713">			moveGoods(carrier, goodsType, amount, null);</span>
<span class="fc" id="L2714">			logger.finest(carrier + &quot; dumped &quot; + amount + &quot; &quot; + goodsType.getSuffix() + &quot; to &quot; + carrier.getLocation());</span>
<span class="fc" id="L2715">			cs.add(See.perhaps(), (FreeColGameObject) carrier.getLocation());</span>
			// Others might see a capacity change.
<span class="fc" id="L2717">			getGame().sendToOthers(serverPlayer, cs);</span>
		}
<span class="fc" id="L2719">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Clear the specialty of a unit.
	 *
	 * FIXME: why not clear speciality in the open? You can disband! If we
	 * implement this remember to fix the visibility.
	 *
	 * @param serverPlayer
	 *            The owner of the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to clear the speciality of.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element clearSpeciality(ServerPlayer serverPlayer, Unit unit) {
<span class="fc" id="L2735">		UnitType newType = unit.getTypeChange(ChangeType.CLEAR_SKILL, serverPlayer);</span>
<span class="pc bpc" id="L2736" title="1 of 2 branches missed.">		if (newType == null) {</span>
<span class="nc" id="L2737">			return DOMMessage.clientError(&quot;Can not clear unit speciality: &quot; + unit.getId());</span>
		}

		// There can be some restrictions that may prevent the
		// clearing of the speciality. AFAICT the only ATM is that a
		// teacher can not lose its speciality, but this will need to
		// be revisited if we invent a work location that requires a
		// particular unit type.
<span class="fc bfc" id="L2745" title="All 2 branches covered.">		if (unit.getStudent() != null) {</span>
<span class="fc" id="L2746">			return DOMMessage.clientError(&quot;Can not clear speciality of a teacher.&quot;);</span>
		}

		// Valid, change type.
<span class="fc" id="L2750">		unit.changeType(newType);// -vis: safe in colony</span>

		// Update just the unit, others can not see it as this only happens
		// in-colony.
<span class="fc" id="L2754">		return new ChangeSet().add(See.only(serverPlayer), unit).build(serverPlayer);</span>
	}

	/**
	 * Disband a unit.
	 *
	 * @param serverPlayer
	 *            The owner of the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to disband.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element disbandUnit(ServerPlayer serverPlayer, Unit unit) {
<span class="nc" id="L2767">		ChangeSet cs = new ChangeSet();</span>

		// Dispose of the unit.
<span class="nc" id="L2770">		cs.add(See.perhaps().always(serverPlayer), (FreeColGameObject) unit.getLocation());</span>
<span class="nc" id="L2771">		cs.addRemove(See.perhaps().always(serverPlayer), unit.getLocation(), unit);// -vis(serverPlayer)</span>
<span class="nc" id="L2772">		unit.dispose();</span>
<span class="nc" id="L2773">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>

		// Others can see the unit removal and the space it leaves.
<span class="nc" id="L2776">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2777">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Build a settlement.
	 *
	 * +til: Resolves many tile appearance changes.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is building.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is building.
	 * @param name
	 *            The new settlement name.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element buildSettlement(ServerPlayer serverPlayer, Unit unit, String name) {
<span class="nc" id="L2794">		final ServerGame game = getGame();</span>
<span class="nc" id="L2795">		final Specification spec = game.getSpecification();</span>
<span class="nc" id="L2796">		ChangeSet cs = new ChangeSet();</span>

		// Build settlement
<span class="nc" id="L2799">		Tile tile = unit.getTile();</span>
		Settlement settlement;
<span class="nc bnc" id="L2801" title="All 2 branches missed.">		if (Player.ASSIGN_SETTLEMENT_NAME.equals(name)) {</span>
<span class="nc" id="L2802">			name = serverPlayer.getSettlementName(random);</span>
		}
<span class="nc bnc" id="L2804" title="All 2 branches missed.">		if (serverPlayer.isEuropean()) {</span>
<span class="nc" id="L2805">			StringTemplate nation = serverPlayer.getNationLabel();</span>
<span class="nc" id="L2806">			settlement = new ServerColony(game, serverPlayer, name, tile);</span>
<span class="nc bnc" id="L2807" title="All 2 branches missed.">			for (Tile t : tile.getSurroundingTiles(settlement.getRadius())) {</span>
<span class="nc" id="L2808">				t.cacheUnseen();// +til</span>
<span class="nc" id="L2809">			}</span>
<span class="nc" id="L2810">			serverPlayer.addSettlement(settlement);</span>
<span class="nc" id="L2811">			settlement.placeSettlement(false);// -vis(serverPlayer,?),-til</span>
<span class="nc" id="L2812">			cs.add(See.only(serverPlayer), serverPlayer.exploreForSettlement(settlement));</span>

<span class="nc" id="L2814">			cs.addHistory(serverPlayer,</span>
<span class="nc" id="L2815">					new HistoryEvent(game.getTurn(), HistoryEvent.HistoryEventType.FOUND_COLONY, serverPlayer)</span>
<span class="nc" id="L2816">							.addName(&quot;%colony%&quot;, settlement.getName()));</span>

			// Remove equipment from founder in case role confuses
			// placement.
<span class="nc" id="L2820">			settlement.equipForRole(unit, spec.getDefaultRole(), 0);</span>

			// Coronado
<span class="nc bnc" id="L2823" title="All 2 branches missed.">			for (ServerPlayer sp : game.getConnectedPlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L2824" title="All 2 branches missed.">				if (!sp.hasAbility(Ability.SEE_ALL_COLONIES))</span>
<span class="nc" id="L2825">					continue;</span>
<span class="nc" id="L2826">				cs.add(See.only(sp), sp.exploreForSettlement(settlement));// -vis(sp)</span>
<span class="nc" id="L2827">				sp.invalidateCanSeeTiles();// +vis(sp)</span>
<span class="nc" id="L2828">				cs.addMessage(See.only(sp),</span>
						new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY, &quot;buildColony.others&quot;, settlement)
<span class="nc" id="L2830">								.addStringTemplate(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L2831">								.addStringTemplate(&quot;%colony%&quot;, settlement.getLocationLabelFor(sp))</span>
<span class="nc" id="L2832">								.addStringTemplate(&quot;%region%&quot;, tile.getRegion().getLabel()));</span>
<span class="nc" id="L2833">			}</span>
<span class="nc" id="L2834">		} else {</span>
<span class="nc" id="L2835">			IndianNationType nationType = (IndianNationType) serverPlayer.getNationType();</span>
<span class="nc" id="L2836">			UnitType skill = RandomChoice.getWeightedRandom(logger, &quot;Choose skill&quot;,</span>
<span class="nc" id="L2837">					nationType.generateSkillsForTile(tile), random);</span>
<span class="nc bnc" id="L2838" title="All 2 branches missed.">			if (skill == null) { // Seasoned Scout</span>
<span class="nc" id="L2839">				List&lt;UnitType&gt; scouts = spec.getUnitTypesWithAbility(Ability.EXPERT_SCOUT);</span>
<span class="nc" id="L2840">				skill = getRandomMember(logger, &quot;Choose scout&quot;, scouts, random);</span>
			}
<span class="nc" id="L2842">			settlement = new ServerIndianSettlement(game, serverPlayer, name, tile, false, skill, null);</span>
<span class="nc bnc" id="L2843" title="All 2 branches missed.">			for (Tile t : tile.getSurroundingTiles(settlement.getRadius())) {</span>
<span class="nc" id="L2844">				t.cacheUnseen();// +til</span>
<span class="nc" id="L2845">			}</span>
<span class="nc" id="L2846">			serverPlayer.addSettlement(settlement);</span>
<span class="nc" id="L2847">			settlement.placeSettlement(true);// -vis(serverPlayer),-til</span>
<span class="nc bnc" id="L2848" title="All 2 branches missed.">			for (Player p : getGame().getLivePlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L2849" title="All 2 branches missed.">				if (p == serverPlayer)</span>
<span class="nc" id="L2850">					continue;</span>
<span class="nc" id="L2851">				((IndianSettlement) settlement).setAlarm(p,</span>
<span class="nc bnc" id="L2852" title="All 2 branches missed.">						(p.isIndian()) ? new Tension(Tension.Level.CONTENT.getLimit()) : serverPlayer.getTension(p));// -til</span>
<span class="nc" id="L2853">			}</span>
		}

		// Join the settlement.
<span class="nc" id="L2857">		unit.setLocation(settlement);// -vis(serverPlayer),-til</span>
<span class="nc" id="L2858">		unit.setMovesLeft(0);</span>

		// Update with settlement tile, and newly owned tiles.
<span class="nc" id="L2861">		cs.add(See.perhaps(), settlement.getOwnedTiles());</span>
<span class="nc" id="L2862">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>

		// Others can see tile changes.
<span class="nc" id="L2865">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2866">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Join a colony.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is joining.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to join.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element joinColony(ServerPlayer serverPlayer, Unit unit, Colony colony) {
<span class="nc" id="L2881">		final Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L2882">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2883">		Set&lt;Tile&gt; ownedTiles = colony.getOwnedTiles();</span>
<span class="nc" id="L2884">		Tile tile = colony.getTile();</span>

		// Join.
<span class="nc" id="L2887">		tile.cacheUnseen();// +til</span>
<span class="nc" id="L2888">		unit.setLocation(colony);// -vis: safe/colony,-til</span>
<span class="nc" id="L2889">		unit.setMovesLeft(0);</span>
<span class="nc" id="L2890">		colony.equipForRole(unit, spec.getDefaultRole(), 0);</span>

		// Update with colony tile, and tiles now owned.
<span class="nc" id="L2893">		cs.add(See.only(serverPlayer), tile);</span>
<span class="nc bnc" id="L2894" title="All 2 branches missed.">		for (Tile t : tile.getSurroundingTiles(colony.getRadius())) {</span>
<span class="nc bnc" id="L2895" title="All 4 branches missed.">			if (t.getOwningSettlement() == colony &amp;&amp; !ownedTiles.contains(t)) {</span>
<span class="nc" id="L2896">				cs.add(See.perhaps(), t);</span>
			}
<span class="nc" id="L2898">		}</span>

		// Others might see a tile ownership change.
<span class="nc" id="L2901">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2902">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Abandon a settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is abandoning.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; to abandon.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element abandonSettlement(ServerPlayer serverPlayer, Settlement settlement) {
<span class="nc" id="L2915">		ChangeSet cs = new ChangeSet();</span>

		// Drop trade routes and create history event before disposing.
<span class="nc bnc" id="L2918" title="All 2 branches missed.">		if (settlement instanceof Colony) {</span>
<span class="nc" id="L2919">			serverPlayer.csLoseLocation(settlement, cs);</span>
<span class="nc" id="L2920">			cs.addHistory(serverPlayer,</span>
<span class="nc" id="L2921">					new HistoryEvent(getGame().getTurn(), HistoryEvent.HistoryEventType.ABANDON_COLONY, serverPlayer)</span>
<span class="nc" id="L2922">							.addName(&quot;%colony%&quot;, settlement.getName()));</span>
		}

		// Comprehensive dispose.
<span class="nc" id="L2926">		serverPlayer.csDisposeSettlement(settlement, cs);// +vis</span>

		// FIXME: Player.settlements is still being fixed on the client side.
<span class="nc" id="L2929">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2930">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Claim land.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; claiming.
	 * @param tile
	 *            The &lt;code&gt;Tile&lt;/code&gt; to claim.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; to claim for.
	 * @param price
	 *            The price to pay for the land, which must agree with the owner
	 *            valuation, unless negative which denotes stealing.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element claimLand(ServerPlayer serverPlayer, Tile tile, Settlement settlement, int price) {
<span class="fc" id="L2948">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2949">		serverPlayer.csClaimLand(tile, settlement, price, cs);</span>

<span class="pc bpc" id="L2951" title="3 of 4 branches missed.">		if (settlement != null &amp;&amp; serverPlayer.isEuropean()) {</span>
			// Define Coronado to make all colony-owned tiles visible
<span class="nc bnc" id="L2953" title="All 2 branches missed.">			for (ServerPlayer sp : getGame().getConnectedPlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L2954" title="All 4 branches missed.">				if (sp.isEuropean() &amp;&amp; sp.hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
<span class="nc" id="L2955">					sp.exploreTile(tile);</span>
<span class="nc" id="L2956">					cs.add(See.only(sp), tile);</span>
<span class="nc" id="L2957">					sp.invalidateCanSeeTiles();// +vis(sp)</span>
				}
<span class="nc" id="L2959">			}</span>
		}

		// Others can see the tile.
<span class="fc" id="L2963">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L2964">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Accept a diplomatic trade. Handles the transfers of TradeItems.
	 *
	 * Note that first contact contexts may not necessarily have a settlement,
	 * but this is ok because first contact trade can only include stance and
	 * gold trade items.
	 *
	 * @param agreement
	 *            The &lt;code&gt;DiplomacyTrade&lt;/code&gt; agreement.
	 * @param session
	 *            The &lt;code&gt;DiplomacySession&lt;/code&gt; in scope.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
	 * @return True if the trade was valid.
	 */
	private boolean csAcceptTrade(DiplomaticTrade agreement, DiplomacySession session, ChangeSet cs) {
<span class="nc" id="L2983">		final ServerPlayer srcPlayer = (ServerPlayer) agreement.getSender();</span>
<span class="nc" id="L2984">		final ServerPlayer dstPlayer = (ServerPlayer) agreement.getRecipient();</span>
<span class="nc" id="L2985">		final Unit unit = session.getUnit();</span>
<span class="nc" id="L2986">		final Settlement settlement = session.getSettlement();</span>
<span class="nc" id="L2987">		boolean visibilityChange = false;</span>

		// Check trade carefully before committing.
<span class="nc" id="L2990">		boolean fail = false;</span>
<span class="nc bnc" id="L2991" title="All 2 branches missed.">		for (TradeItem tradeItem : agreement.getTradeItems()) {</span>
<span class="nc" id="L2992">			final ServerPlayer source = (ServerPlayer) tradeItem.getSource();</span>
<span class="nc" id="L2993">			final ServerPlayer dest = (ServerPlayer) tradeItem.getDestination();</span>
<span class="nc bnc" id="L2994" title="All 2 branches missed.">			if (!tradeItem.isValid()) {</span>
<span class="nc" id="L2995">				logger.warning(&quot;Trade with invalid tradeItem: &quot; + tradeItem);</span>
<span class="nc" id="L2996">				fail = true;</span>
<span class="nc" id="L2997">				continue;</span>
			}
<span class="nc bnc" id="L2999" title="All 4 branches missed.">			if (source != srcPlayer &amp;&amp; source != dstPlayer) {</span>
<span class="nc bnc" id="L3000" title="All 2 branches missed.">				logger.warning(&quot;Trade with invalid source: &quot; + ((source == null) ? &quot;null&quot; : source.getId()));</span>
<span class="nc" id="L3001">				fail = true;</span>
<span class="nc" id="L3002">				continue;</span>
			}
<span class="nc bnc" id="L3004" title="All 4 branches missed.">			if (dest != srcPlayer &amp;&amp; dest != dstPlayer) {</span>
<span class="nc bnc" id="L3005" title="All 2 branches missed.">				logger.warning(&quot;Trade with invalid destination: &quot; + ((dest == null) ? &quot;null&quot; : dest.getId()));</span>
<span class="nc" id="L3006">				fail = true;</span>
<span class="nc" id="L3007">				continue;</span>
			}

<span class="nc" id="L3010">			Colony colony = tradeItem.getColony(getGame());</span>
<span class="nc bnc" id="L3011" title="All 4 branches missed.">			if (colony != null &amp;&amp; !source.owns(colony)) {</span>
<span class="nc" id="L3012">				logger.warning(&quot;Trade with invalid source owner: &quot; + colony);</span>
<span class="nc" id="L3013">				fail = true;</span>
<span class="nc" id="L3014">				continue;</span>
			}
<span class="nc" id="L3016">			int gold = tradeItem.getGold();</span>
<span class="nc bnc" id="L3017" title="All 4 branches missed.">			if (gold &gt; 0 &amp;&amp; !source.checkGold(gold)) {</span>
<span class="nc" id="L3018">				logger.warning(&quot;Trade with invalid gold: &quot; + gold);</span>
<span class="nc" id="L3019">				fail = true;</span>
<span class="nc" id="L3020">				continue;</span>
			}

<span class="nc" id="L3023">			Goods goods = tradeItem.getGoods();</span>
<span class="nc bnc" id="L3024" title="All 2 branches missed.">			if (goods != null) {</span>
<span class="nc" id="L3025">				Location loc = goods.getLocation();</span>
<span class="nc bnc" id="L3026" title="All 4 branches missed.">				if (loc instanceof Ownable &amp;&amp; !source.owns((Ownable) loc)) {</span>
<span class="nc" id="L3027">					logger.warning(&quot;Trade with invalid source owner: &quot; + loc);</span>
<span class="nc" id="L3028">					fail = true;</span>
<span class="nc bnc" id="L3029" title="All 4 branches missed.">				} else if (!(loc instanceof GoodsLocation &amp;&amp; loc.contains(goods))) {</span>
<span class="nc" id="L3030">					logger.warning(&quot;Trade of unavailable goods &quot; + goods + &quot; at &quot; + loc);</span>
<span class="nc" id="L3031">					fail = true;</span>
<span class="nc bnc" id="L3032" title="All 4 branches missed.">				} else if (dest.owns(unit) &amp;&amp; !unit.couldCarry(goods)) {</span>
<span class="nc" id="L3033">					logger.warning(&quot;Trade unit can not carry traded goods: &quot; + goods);</span>
<span class="nc" id="L3034">					fail = true;</span>
				}
			}

			// Stance trade fail is harmless
<span class="nc" id="L3039">			Unit u = tradeItem.getUnit();</span>
<span class="nc bnc" id="L3040" title="All 2 branches missed.">			if (u != null) {</span>
<span class="nc bnc" id="L3041" title="All 2 branches missed.">				if (!source.owns(u)) {</span>
<span class="nc" id="L3042">					logger.warning(&quot;Trade with invalid source owner: &quot; + u);</span>
<span class="nc" id="L3043">					fail = true;</span>
<span class="nc" id="L3044">					continue;</span>
<span class="nc bnc" id="L3045" title="All 4 branches missed.">				} else if (dest.owns(unit) &amp;&amp; !unit.couldCarry(u)) {</span>
<span class="nc" id="L3046">					logger.warning(&quot;Trade unit can not carry traded unit: &quot; + u);</span>
<span class="nc" id="L3047">					fail = true;</span>
				}
			}
<span class="nc" id="L3050">		}</span>
<span class="nc bnc" id="L3051" title="All 2 branches missed.">		if (fail)</span>
<span class="nc" id="L3052">			return false;</span>

<span class="nc bnc" id="L3054" title="All 2 branches missed.">		for (TradeItem tradeItem : agreement.getTradeItems()) {</span>
<span class="nc" id="L3055">			final ServerPlayer source = (ServerPlayer) tradeItem.getSource();</span>
<span class="nc" id="L3056">			final ServerPlayer dest = (ServerPlayer) tradeItem.getDestination();</span>
			// Collect changes for updating. Not very OO but
			// TradeItem should not know about server internals.
			// Take care to show items that change hands to the *old*
			// owner too.
<span class="nc" id="L3061">			Stance stance = tradeItem.getStance();</span>
<span class="nc bnc" id="L3062" title="All 4 branches missed.">			if (stance != null &amp;&amp; !source.csChangeStance(stance, dest, true, cs)) {</span>
<span class="nc" id="L3063">				logger.warning(&quot;Stance trade failure: &quot; + stance);</span>
			}
<span class="nc" id="L3065">			Colony colony = tradeItem.getColony(getGame());</span>
<span class="nc bnc" id="L3066" title="All 2 branches missed.">			if (colony != null) {</span>
<span class="nc" id="L3067">				ServerPlayer former = (ServerPlayer) colony.getOwner();</span>
<span class="nc bnc" id="L3068" title="All 2 branches missed.">				for (Tile t : colony.getOwnedTiles()) {</span>
<span class="nc" id="L3069">					t.cacheUnseen(dest);// +til</span>
<span class="nc" id="L3070">				}</span>
<span class="nc" id="L3071">				((ServerColony) colony).csChangeOwner(dest, cs);// -vis(both),-til</span>
<span class="nc" id="L3072">				cs.add(See.only(dest), dest.exploreForSettlement(colony));</span>
<span class="nc" id="L3073">				cs.add(See.perhaps().always(former), colony.getOwnedTiles());</span>
<span class="nc" id="L3074">				visibilityChange = true;</span>
			}
<span class="nc" id="L3076">			int gold = tradeItem.getGold();</span>
<span class="nc bnc" id="L3077" title="All 2 branches missed.">			if (gold &gt; 0) {</span>
<span class="nc" id="L3078">				source.modifyGold(-gold);</span>
<span class="nc" id="L3079">				dest.modifyGold(gold);</span>
<span class="nc" id="L3080">				cs.addPartial(See.only(source), source, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L3081">				cs.addPartial(See.only(dest), dest, &quot;gold&quot;, &quot;score&quot;);</span>
			}
<span class="nc" id="L3083">			Goods goods = tradeItem.getGoods();</span>
<span class="nc bnc" id="L3084" title="All 4 branches missed.">			if (goods != null &amp;&amp; settlement != null) {</span>
<span class="nc bnc" id="L3085" title="All 2 branches missed.">				if (dest.owns(settlement)) {</span>
<span class="nc" id="L3086">					goods.setLocation(unit);</span>
<span class="nc" id="L3087">					moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L3088">					cs.add(See.only(source), unit);</span>
<span class="nc" id="L3089">					cs.add(See.only(dest), settlement.getGoodsContainer());</span>
				} else {
<span class="nc" id="L3091">					goods.setLocation(settlement);</span>
<span class="nc" id="L3092">					moveGoods(settlement, goods.getType(), goods.getAmount(), unit);</span>
<span class="nc" id="L3093">					cs.add(See.only(dest), unit);</span>
<span class="nc" id="L3094">					cs.add(See.only(source), settlement.getGoodsContainer());</span>
				}
			}
<span class="nc" id="L3097">			ServerPlayer victim = (ServerPlayer) tradeItem.getVictim();</span>
<span class="nc bnc" id="L3098" title="All 2 branches missed.">			if (victim != null) {</span>
<span class="nc bnc" id="L3099" title="All 2 branches missed.">				if (source.csChangeStance(Stance.WAR, victim, true, cs)) {</span>
					// Have to add in an explicit stance change and
					// message because the player does not normally
					// have visibility of stance changes between other nations.
<span class="nc" id="L3103">					cs.addStance(See.only(dest), source, Stance.WAR, victim);</span>
<span class="nc" id="L3104">					cs.addMessage(See.only(dest),</span>
							new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="nc" id="L3106">									Stance.WAR.getOtherStanceChangeKey(), source)</span>
<span class="nc" id="L3107">											.addStringTemplate(&quot;%attacker%&quot;, source.getNationLabel())</span>
<span class="nc" id="L3108">											.addStringTemplate(&quot;%defender%&quot;, victim.getNationLabel()));</span>
				} else {
<span class="nc" id="L3110">					logger.warning(&quot;Incite trade failure: &quot; + victim);</span>
				}
			}
<span class="nc" id="L3113">			ServerUnit newUnit = (ServerUnit) tradeItem.getUnit();</span>
<span class="nc bnc" id="L3114" title="All 4 branches missed.">			if (newUnit != null &amp;&amp; settlement != null) {</span>
<span class="nc" id="L3115">				ServerPlayer former = (ServerPlayer) newUnit.getOwner();</span>
<span class="nc" id="L3116">				Tile oldTile = newUnit.getTile();</span>
				Location newLoc;
<span class="nc bnc" id="L3118" title="All 2 branches missed.">				if (unit.isOnCarrier()) {</span>
<span class="nc" id="L3119">					Unit carrier = unit.getCarrier();</span>
<span class="nc bnc" id="L3120" title="All 2 branches missed.">					if (!carrier.couldCarry(newUnit)) {</span>
<span class="nc" id="L3121">						logger.warning(&quot;Can not add &quot; + newUnit + &quot; to &quot; + carrier);</span>
<span class="nc" id="L3122">						continue;</span>
					}
<span class="nc" id="L3124">					newLoc = carrier;</span>
<span class="nc bnc" id="L3125" title="All 2 branches missed.">				} else if (dest == unit.getOwner()) {</span>
<span class="nc" id="L3126">					newLoc = unit.getTile();</span>
				} else {
<span class="nc" id="L3128">					newLoc = settlement.getTile();</span>
				}
<span class="nc bnc" id="L3130" title="All 2 branches missed.">				if (source.csChangeOwner(newUnit, dest, ChangeType.CAPTURE, newLoc, cs)) {// -vis(both)</span>
<span class="nc" id="L3131">					newUnit.setMovesLeft(0);</span>
<span class="nc" id="L3132">					cs.add(See.perhaps().always(former), oldTile);</span>
				}
<span class="nc" id="L3134">				visibilityChange = true;</span>
			}
<span class="nc" id="L3136">		}</span>
<span class="nc bnc" id="L3137" title="All 2 branches missed.">		if (visibilityChange) {</span>
<span class="nc" id="L3138">			srcPlayer.invalidateCanSeeTiles();// +vis(srcPlayer)</span>
<span class="nc" id="L3139">			dstPlayer.invalidateCanSeeTiles();// +vis(dstPlayer)</span>
		}
<span class="nc" id="L3141">		return true;</span>
	}

	/**
	 * Handle first contact between European and native player.
	 *
	 * Note that we check for a diplomacy session, but do only bother in the
	 * case of tile!=null as that is the only possibility for some benefit.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
	 * @param other
	 *            The native &lt;code&gt;ServerPlayer&lt;/code&gt; to contact.
	 * @param tile
	 *            A &lt;code&gt;Tile&lt;/code&gt; on offer at first landing.
	 * @param result
	 *            Whether the initial peace treaty was accepted.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element nativeFirstContact(ServerPlayer serverPlayer, ServerPlayer other, Tile tile, boolean result) {
<span class="fc" id="L3161">		ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L3162" title="1 of 2 branches missed.">		if (result) {</span>
<span class="pc bpc" id="L3163" title="1 of 2 branches missed.">			if (tile != null) {</span>
<span class="nc" id="L3164">				Unit u = tile.getFirstUnit();</span>
<span class="nc" id="L3165">				Settlement s = tile.getOwningSettlement();</span>
<span class="nc" id="L3166">				DiplomacySession session = TransactionSession.lookup(DiplomacySession.class, u, s);</span>
<span class="nc bnc" id="L3167" title="All 2 branches missed.">				if (session == null) {</span>
<span class="nc" id="L3168">					return DOMMessage.clientError(&quot;No diplomacy in effect for: &quot; + tile.getId());</span>
				}
<span class="nc" id="L3170">				tile.cacheUnseen();// +til</span>
<span class="nc" id="L3171">				tile.changeOwnership(serverPlayer, null);// -til</span>
<span class="nc" id="L3172">				cs.add(See.perhaps(), tile);</span>
<span class="nc" id="L3173">			}</span>
		} else {
			// Consider not accepting the treaty to be an insult and
			// ban missions.
<span class="nc" id="L3177">			other.csModifyTension(serverPlayer, Tension.TENSION_ADD_MAJOR, cs);// +til</span>
<span class="nc" id="L3178">			other.addMissionBan(serverPlayer);</span>
		}

<span class="fc" id="L3181">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L3182">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Process a European diplomacy session according to an agreement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; in the session.
	 * @param otherPlayer
	 *            The other &lt;code&gt;ServerPlayer&lt;/code&gt; in the session.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
	 * @param session
	 *            The &lt;code&gt;DiplomacySession&lt;/code&gt; underway.
	 * @param message
	 *            A &lt;code&gt;DiplomacyMessage&lt;/code&gt; to send.
	 * @param cs
	 *            A &lt;code&gt;ChangeSet&lt;/code&gt; to contain the trade changes if
	 *            accepted.
	 * @return True if a new DiplomacyMessage reply needs to be sent.
	 */
	private boolean csDiplomacySession(ServerPlayer serverPlayer, ServerPlayer otherPlayer, DiplomaticTrade agreement,
			DiplomacySession session, DiplomacyMessage message, ChangeSet cs) {
		// Consider the status, process acceptance and rejection,
		// which need no further action.
<span class="nc" id="L3207">		TradeStatus status = agreement.getStatus();</span>
<span class="pc bnc" id="L3208" title="All 3 branches missed.">		switch (status) {</span>
		case PROPOSE_TRADE:
<span class="nc" id="L3210">			session.setAgreement(agreement);</span>
<span class="nc" id="L3211">			break;</span>
		case ACCEPT_TRADE:
			// Process the agreement that was sent!
<span class="nc" id="L3214">			agreement = session.getAgreement();</span>
<span class="nc" id="L3215">			agreement.setStatus(TradeStatus.ACCEPT_TRADE);</span>
<span class="nc bnc" id="L3216" title="All 2 branches missed.">			if (csAcceptTrade(agreement, session, cs)) {</span>
<span class="nc" id="L3217">				session.complete(cs);</span>
<span class="nc" id="L3218">				getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3219">				return false;</span>
			}
			// Trade was invalid, fall through into rejection.
		case REJECT_TRADE:
		default:
<span class="nc" id="L3224">			agreement = session.getAgreement();</span>
<span class="nc" id="L3225">			agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
<span class="nc" id="L3226">			session.complete(cs);</span>
<span class="nc" id="L3227">			getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3228">			return false;</span>
		}

		// Ask the other player to consider the agreement.
		// Treat a missing reply as a rejection.
<span class="nc" id="L3233">		DOMMessage reply = askTimeout(otherPlayer, message);</span>
<span class="nc bnc" id="L3234" title="All 2 branches missed.">		if (reply instanceof DiplomacyMessage) {</span>
<span class="nc" id="L3235">			agreement = ((DiplomacyMessage) reply).getAgreement();</span>
<span class="nc" id="L3236">			status = agreement.getStatus();</span>
		} else {
<span class="nc" id="L3238">			status = TradeStatus.REJECT_TRADE;</span>
<span class="nc" id="L3239">			agreement.setStatus(status);</span>
		}
<span class="nc" id="L3241">		agreement.incrementVersion();</span>

		// Process the result. Always return true here as the serverPlayer
		// needs to be informed of the other player's response.
<span class="nc bnc" id="L3245" title="All 3 branches missed.">		switch (status) {</span>
		case PROPOSE_TRADE:
<span class="nc" id="L3247">			session.setAgreement(agreement);</span>
<span class="nc" id="L3248">			break;</span>
		case ACCEPT_TRADE:
<span class="nc" id="L3250">			agreement = session.getAgreement(); // Accept offered agreement</span>
<span class="nc" id="L3251">			agreement.setStatus(TradeStatus.ACCEPT_TRADE);</span>
<span class="nc bnc" id="L3252" title="All 2 branches missed.">			if (csAcceptTrade(agreement, session, cs)) {</span>
<span class="nc" id="L3253">				session.complete(cs);</span>
<span class="nc" id="L3254">				getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3255">				break;</span>
			}
			// Trade was invalid, fall through into rejection.
		case REJECT_TRADE:
		default:
<span class="nc" id="L3260">			agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
<span class="nc" id="L3261">			session.setAgreement(agreement);</span>
<span class="nc" id="L3262">			session.complete(cs);</span>
<span class="nc" id="L3263">			getGame().sendToOthers(serverPlayer, cs);</span>
			break;
		}
<span class="nc" id="L3266">		return true;</span>
	}

	/**
	 * Handle first contact between European players.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
	 * @param ourUnit
	 *            Our &lt;code&gt;Unit&lt;/code&gt;.
	 * @param otherUnit
	 *            The other &lt;code&gt;unit&lt;/code&gt;.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element europeanFirstContact(ServerPlayer serverPlayer, Unit ourUnit, Unit otherUnit,
			DiplomaticTrade agreement) {
<span class="nc" id="L3284">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3285">		DiplomacySession session = TransactionSession.lookup(DiplomacySession.class, ourUnit, otherUnit);</span>
<span class="nc bnc" id="L3286" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L3287">			session = TransactionSession.lookup(DiplomacySession.class, otherUnit, ourUnit);</span>
		}
<span class="nc bnc" id="L3289" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc bnc" id="L3290" title="All 2 branches missed.">			if (agreement.getStatus() != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L3291">				return DOMMessage.clientError(&quot;Missing uu1-diplomacy session for &quot; + ourUnit.getId() + &quot;,&quot;</span>
<span class="nc" id="L3292">						+ otherUnit.getId() + &quot; with &quot; + agreement);</span>
			}
<span class="nc" id="L3294">			session = new DiplomacySession(ourUnit, otherUnit);</span>
<span class="nc" id="L3295">			ourUnit.setMovesLeft(0);</span>
<span class="nc" id="L3296">			cs.addPartial(See.only(serverPlayer), ourUnit, &quot;movesLeft&quot;);</span>
		}
<span class="nc" id="L3298">		ServerPlayer otherPlayer = (ServerPlayer) otherUnit.getOwner();</span>
<span class="nc bnc" id="L3299" title="All 2 branches missed.">		if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
				new DiplomacyMessage(otherUnit, ourUnit, agreement), cs)) {
<span class="nc" id="L3301">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3302">					new DiplomacyMessage(ourUnit, otherUnit, session.getAgreement()));</span>
		}
<span class="nc" id="L3304">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Handle first contact between European players.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
	 * @param ourUnit
	 *            Our &lt;code&gt;Unit&lt;/code&gt;.
	 * @param otherColony
	 *            The other &lt;code&gt;Colony&lt;/code&gt;.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element europeanFirstContact(ServerPlayer serverPlayer, Unit ourUnit, Colony otherColony,
			DiplomaticTrade agreement) {
<span class="nc" id="L3322">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3323">		DiplomacySession session = TransactionSession.lookup(DiplomacySession.class, ourUnit, otherColony);</span>
<span class="nc bnc" id="L3324" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc bnc" id="L3325" title="All 2 branches missed.">			if (agreement.getStatus() != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L3326">				return DOMMessage.clientError(&quot;Missing uc1-diplomacy session for &quot; + ourUnit.getId() + &quot;,&quot;</span>
<span class="nc" id="L3327">						+ otherColony.getId() + &quot; with &quot; + agreement);</span>
			}
<span class="nc" id="L3329">			session = new DiplomacySession(ourUnit, otherColony);</span>
<span class="nc" id="L3330">			ourUnit.setMovesLeft(0);</span>
<span class="nc" id="L3331">			cs.addPartial(See.only(serverPlayer), ourUnit, &quot;movesLeft&quot;);</span>
		}
<span class="nc" id="L3333">		ServerPlayer otherPlayer = (ServerPlayer) otherColony.getOwner();</span>
<span class="nc bnc" id="L3334" title="All 2 branches missed.">		if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
				new DiplomacyMessage(otherColony, ourUnit, agreement), cs)) {
<span class="nc" id="L3336">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3337">					new DiplomacyMessage(ourUnit, otherColony, session.getAgreement()));</span>
		}
<span class="nc" id="L3339">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Handle first contact between European players.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
	 * @param ourColony
	 *            Our &lt;code&gt;Colony&lt;/code&gt;.
	 * @param otherUnit
	 *            The other &lt;code&gt;Unit&lt;/code&gt;.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element europeanFirstContact(ServerPlayer serverPlayer, Colony ourColony, Unit otherUnit,
			DiplomaticTrade agreement) {
<span class="nc" id="L3357">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3358">		DiplomacySession session = TransactionSession.lookup(DiplomacySession.class, otherUnit, ourColony);</span>
<span class="nc bnc" id="L3359" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L3360">			return DOMMessage.clientError(&quot;Missing cu1-diplomacy session for &quot; + ourColony.getId() + &quot;,&quot;</span>
<span class="nc" id="L3361">					+ otherUnit.getId() + &quot; with &quot; + agreement);</span>
		}
<span class="nc" id="L3363">		ServerPlayer otherPlayer = (ServerPlayer) otherUnit.getOwner();</span>
<span class="nc bnc" id="L3364" title="All 2 branches missed.">		if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
				new DiplomacyMessage(otherUnit, ourColony, agreement), cs)) {
<span class="nc" id="L3366">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3367">					new DiplomacyMessage(ourColony, otherUnit, session.getAgreement()));</span>
		}
<span class="nc" id="L3369">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Diplomacy.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
	 * @param ourUnit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param otherColony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to trade with.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element diplomacy(ServerPlayer serverPlayer, Unit ourUnit, Colony otherColony, DiplomaticTrade agreement) {
<span class="nc" id="L3386">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3387">		TradeStatus status = agreement.getStatus();</span>
<span class="nc" id="L3388">		DiplomacySession session = TransactionSession.lookup(DiplomacySession.class, ourUnit, otherColony);</span>
<span class="nc bnc" id="L3389" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc bnc" id="L3390" title="All 2 branches missed.">			if (status != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L3391">				return DOMMessage.clientError(&quot;Mission uc-diplomacy session for &quot; + ourUnit.getId() + &quot;/&quot;</span>
<span class="nc" id="L3392">						+ otherColony.getId() + &quot; with &quot; + agreement);</span>
			}
<span class="nc" id="L3394">			session = new DiplomacySession(ourUnit, otherColony);</span>
		}
<span class="nc" id="L3396">		ServerPlayer otherPlayer = (ServerPlayer) otherColony.getOwner();</span>
<span class="nc bnc" id="L3397" title="All 2 branches missed.">		if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
				new DiplomacyMessage(otherColony, ourUnit, agreement), cs)) {
<span class="nc" id="L3399">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3400">					new DiplomacyMessage(ourUnit, otherColony, session.getAgreement()));</span>
		}
<span class="nc" id="L3402">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Diplomacy.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
	 * @param ourColony
	 *            Our &lt;code&gt;Colony&lt;/code&gt;.
	 * @param otherUnit
	 *            The other &lt;code&gt;Unit&lt;/code&gt; that is trading.
	 * @param agreement
	 *            The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element diplomacy(ServerPlayer serverPlayer, Colony ourColony, Unit otherUnit, DiplomaticTrade agreement) {
<span class="nc" id="L3419">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3420">		DiplomacySession session = TransactionSession.lookup(DiplomacySession.class, otherUnit, ourColony);</span>
<span class="nc bnc" id="L3421" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L3422">			return DOMMessage.clientError(&quot;Mission cu-diplomacy session for &quot; + otherUnit.getId() + &quot;/&quot;</span>
<span class="nc" id="L3423">					+ ourColony.getId() + &quot; with &quot; + agreement);</span>
		}
<span class="nc" id="L3425">		ServerPlayer otherPlayer = (ServerPlayer) otherUnit.getOwner();</span>
<span class="nc bnc" id="L3426" title="All 2 branches missed.">		if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
				new DiplomacyMessage(otherUnit, ourColony, agreement), cs)) {
<span class="nc" id="L3428">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
<span class="nc" id="L3429">					new DiplomacyMessage(ourColony, otherUnit, session.getAgreement()));</span>
		}
<span class="nc" id="L3431">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Spy on a settlement.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is spying.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; that is spying.
	 * @param settlement
	 *            The &lt;code&gt;Settlement&lt;/code&gt; to spy on.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element spySettlement(ServerPlayer serverPlayer, Unit unit, Settlement settlement) {
<span class="nc" id="L3446">		ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L3448">		cs.addSpy(See.only(serverPlayer), settlement);</span>
<span class="nc" id="L3449">		unit.setMovesLeft(0);</span>
<span class="nc" id="L3450">		cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc" id="L3451">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Change work location.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to change the work location of.
	 * @param workLocation
	 *            The &lt;code&gt;WorkLocation&lt;/code&gt; to change to.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element work(ServerPlayer serverPlayer, Unit unit, WorkLocation workLocation) {
<span class="fc" id="L3466">		final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L3467">		final Colony colony = workLocation.getColony();</span>
<span class="fc" id="L3468">		colony.getGoodsContainer().saveState();</span>

<span class="fc" id="L3470">		ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L3471" title="1 of 2 branches missed.">		if (workLocation instanceof ColonyTile) {</span>
<span class="fc" id="L3472">			Tile tile = ((ColonyTile) workLocation).getWorkTile();</span>
<span class="pc bpc" id="L3473" title="1 of 2 branches missed.">			if (tile.getOwningSettlement() != colony) {</span>
				// Claim known free land (because canAdd() succeeded).
<span class="nc" id="L3475">				serverPlayer.csClaimLand(tile, colony, 0, cs);</span>
			}
		}

<span class="fc" id="L3479">		colony.equipForRole(unit, spec.getDefaultRole(), 0);</span>

		// Check for upgrade.
<span class="fc" id="L3482">		UnitType newType = unit.getTypeChange(ChangeType.ENTER_COLONY, unit.getOwner());</span>
<span class="pc bpc" id="L3483" title="1 of 2 branches missed.">		if (newType != null)</span>
<span class="fc" id="L3484">			unit.changeType(newType);// -vis: safe in colony</span>

		// Change the location.
		// We could avoid updating the whole tile if we knew that this
		// was definitely a move between locations and no student/teacher
		// interaction occurred.
<span class="pc bpc" id="L3490" title="1 of 2 branches missed.">		if (!unit.isInColony())</span>
<span class="fc" id="L3491">			unit.getColony().getTile().cacheUnseen();// +til</span>
<span class="fc" id="L3492">		unit.setLocation(workLocation);// -vis: safe/colony,-til if not in</span>
										// colony
<span class="fc" id="L3494">		cs.add(See.perhaps(), colony.getTile());</span>
		// Others can see colony change size
<span class="fc" id="L3496">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L3497">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Loot cargo.
	 *
	 * Note loser is passed by identifier, as by the time we get here the unit
	 * may have been sunk.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the winner.
	 * @param winner
	 *            The &lt;code&gt;Unit&lt;/code&gt; that looting.
	 * @param loserId
	 *            The object identifier of the &lt;code&gt;Unit&lt;/code&gt; that is looted.
	 * @param loot
	 *            The &lt;code&gt;Goods&lt;/code&gt; to loot.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element lootCargo(ServerPlayer serverPlayer, Unit winner, String loserId, List&lt;Goods&gt; loot) {
<span class="nc" id="L3517">		LootSession session = TransactionSession.lookup(LootSession.class, winner.getId(), loserId);</span>
<span class="nc bnc" id="L3518" title="All 2 branches missed.">		if (session == null) {</span>
<span class="nc" id="L3519">			return DOMMessage.clientError(&quot;Bogus looting!&quot;);</span>
		}
<span class="nc bnc" id="L3521" title="All 2 branches missed.">		if (!winner.hasSpaceLeft()) {</span>
<span class="nc" id="L3522">			return DOMMessage.clientError(&quot;No space to loot to: &quot; + winner.getId());</span>
		}

<span class="nc" id="L3525">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3526">		List&lt;Goods&gt; available = session.getCapture();</span>
<span class="nc bnc" id="L3527" title="All 2 branches missed.">		if (loot == null) { // Initial inquiry</span>
<span class="nc" id="L3528">			cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
					new LootCargoMessage(winner, loserId, available));
		} else {
<span class="nc bnc" id="L3531" title="All 2 branches missed.">			for (Goods g : loot) {</span>
<span class="nc bnc" id="L3532" title="All 2 branches missed.">				if (!available.contains(g)) {</span>
<span class="nc" id="L3533">					return DOMMessage.clientError(&quot;Invalid loot: &quot; + g);</span>
				}
<span class="nc" id="L3535">				available.remove(g);</span>
<span class="nc bnc" id="L3536" title="All 2 branches missed.">				if (!winner.canAdd(g)) {</span>
<span class="nc" id="L3537">					return DOMMessage.clientError(&quot;Loot failed: &quot; + g);</span>
				}
<span class="nc" id="L3539">				winner.add(g);</span>
<span class="nc" id="L3540">			}</span>

			// Others can see cargo capacity change.
<span class="nc" id="L3543">			session.complete(cs);</span>
<span class="nc" id="L3544">			cs.add(See.perhaps(), winner);</span>
<span class="nc" id="L3545">			getGame().sendToOthers(serverPlayer, cs);</span>
		}
<span class="nc" id="L3547">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Pay arrears.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; to pay the arrears for.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element payArrears(ServerPlayer serverPlayer, GoodsType type) {
<span class="nc" id="L3560">		int arrears = serverPlayer.getArrears(type);</span>
<span class="nc bnc" id="L3561" title="All 2 branches missed.">		if (arrears &lt;= 0) {</span>
<span class="nc" id="L3562">			return DOMMessage.clientError(&quot;No arrears for pay for: &quot; + type.getId());</span>
<span class="nc bnc" id="L3563" title="All 2 branches missed.">		} else if (!serverPlayer.checkGold(arrears)) {</span>
<span class="nc" id="L3564">			return DOMMessage.clientError(&quot;Not enough gold to pay arrears for: &quot; + type.getId());</span>
		}

<span class="nc" id="L3567">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3568">		Market market = serverPlayer.getMarket();</span>
<span class="nc" id="L3569">		serverPlayer.modifyGold(-arrears);</span>
<span class="nc" id="L3570">		market.setArrears(type, 0);</span>
<span class="nc" id="L3571">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3572">		cs.add(See.only(serverPlayer), market.getMarketData(type));</span>
		// Arrears payment is private.
<span class="nc" id="L3574">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Equip a unit for a specific role. Currently the unit is either in Europe
	 * or in a settlement. Might one day allow the unit to be on a tile
	 * co-located with an equipment-bearing wagon.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to equip.
	 * @param role
	 *            The &lt;code&gt;Role&lt;/code&gt; to equip for.
	 * @param roleCount
	 *            The role count.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element equipForRole(ServerPlayer serverPlayer, Unit unit, Role role, int roleCount) {
<span class="fc" id="L3593">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3594">		boolean ret = false;</span>
<span class="pc bpc" id="L3595" title="1 of 2 branches missed.">		if (unit.isInEurope()) {</span>
<span class="nc" id="L3596">			ServerEurope serverEurope = (ServerEurope) serverPlayer.getEurope();</span>
<span class="nc" id="L3597">			ret = serverEurope.csEquipForRole(unit, role, roleCount, random, cs);</span>
<span class="pc bpc" id="L3598" title="1 of 2 branches missed.">		} else if (unit.getColony() != null) {</span>
<span class="nc" id="L3599">			ServerColony serverColony = (ServerColony) unit.getColony();</span>
<span class="nc" id="L3600">			ret = serverColony.csEquipForRole(unit, role, roleCount, random, cs);</span>
<span class="pc bpc" id="L3601" title="1 of 2 branches missed.">		} else if (unit.getIndianSettlement() != null) {</span>
<span class="fc" id="L3602">			ServerIndianSettlement sis = (ServerIndianSettlement) unit.getIndianSettlement();</span>
<span class="fc" id="L3603">			ret = sis.csEquipForRole(unit, role, roleCount, random, cs);</span>
<span class="fc" id="L3604">		} else {</span>
<span class="nc" id="L3605">			return DOMMessage.clientError(&quot;Unsuitable equip location for: &quot; + unit.getId());</span>
		}
<span class="pc bpc" id="L3607" title="1 of 2 branches missed.">		if (!ret)</span>
<span class="nc" id="L3608">			return null;</span>

<span class="pc bpc" id="L3610" title="1 of 2 branches missed.">		if (unit.getInitialMovesLeft() != unit.getMovesLeft()) {</span>
<span class="fc" id="L3611">			unit.setMovesLeft(0);</span>
		}
<span class="fc" id="L3613">		Unit carrier = unit.getCarrier();</span>
<span class="pc bpc" id="L3614" title="5 of 6 branches missed.">		if (carrier != null &amp;&amp; carrier.getInitialMovesLeft() != carrier.getMovesLeft() &amp;&amp; carrier.getMovesLeft() != 0) {</span>
<span class="nc" id="L3615">			carrier.setMovesLeft(0);</span>
		}
<span class="fc" id="L3617">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Pay for a building.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the colony.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; that is building.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element payForBuilding(ServerPlayer serverPlayer, Colony colony) {
<span class="nc bnc" id="L3630" title="All 2 branches missed.">		if (!getGame().getSpecification().getBoolean(GameOptions.PAY_FOR_BUILDING)) {</span>
<span class="nc" id="L3631">			return DOMMessage.clientError(&quot;Pay for building is disabled&quot;);</span>
		}

<span class="nc" id="L3634">		BuildableType build = colony.getCurrentlyBuilding();</span>
<span class="nc bnc" id="L3635" title="All 2 branches missed.">		if (build == null) {</span>
<span class="nc" id="L3636">			return DOMMessage.clientError(&quot;Colony &quot; + colony.getId() + &quot; is not building anything!&quot;);</span>
		}
<span class="nc" id="L3638">		List&lt;AbstractGoods&gt; required = colony.getRequiredGoods(build);</span>
<span class="nc" id="L3639">		int price = colony.priceGoodsForBuilding(required);</span>
<span class="nc bnc" id="L3640" title="All 2 branches missed.">		if (!serverPlayer.checkGold(price)) {</span>
<span class="nc" id="L3641">			return DOMMessage.clientError(&quot;Insufficient funds to pay for build.&quot;);</span>
		}

		// Save the correct final gold for the player, as we are going to
		// use buy() below, but it deducts the normal uninflated price for
		// the goods being bought. We restore this correct amount later.
<span class="nc" id="L3647">		int savedGold = serverPlayer.modifyGold(-price);</span>
<span class="nc" id="L3648">		serverPlayer.modifyGold(price);</span>

<span class="nc" id="L3650">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3651">		GoodsContainer container = colony.getGoodsContainer();</span>
<span class="nc" id="L3652">		container.saveState();</span>
<span class="nc bnc" id="L3653" title="All 2 branches missed.">		for (AbstractGoods ag : required) {</span>
<span class="nc" id="L3654">			GoodsType type = ag.getType();</span>
<span class="nc" id="L3655">			int amount = ag.getAmount();</span>
<span class="nc bnc" id="L3656" title="All 2 branches missed.">			if (type.isStorable()) {</span>
				// FIXME: should also check canTrade(type, Access.?)
<span class="nc bnc" id="L3658" title="All 2 branches missed.">				if ((amount = serverPlayer.buy(container, type, amount)) &lt; 0) {</span>
<span class="nc" id="L3659">					return DOMMessage.clientError(&quot;Can not buy &quot; + amount + &quot; &quot; + type + &quot; for &quot; + build);</span>
				}
<span class="nc" id="L3661">				serverPlayer.propagateToEuropeanMarkets(type, -amount, random);</span>
<span class="nc" id="L3662">				serverPlayer.csFlushMarket(type, cs);</span>
			} else {
<span class="nc" id="L3664">				container.addGoods(type, amount);</span>
			}
<span class="nc" id="L3666">		}</span>
<span class="nc" id="L3667">		colony.invalidateCache();</span>

		// Nothing to see for others, colony internal.
<span class="nc" id="L3670">		serverPlayer.setGold(savedGold);</span>
<span class="nc" id="L3671">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3672">		cs.add(See.only(serverPlayer), container);</span>
<span class="nc" id="L3673">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Indians making demands of a colony.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is demanding.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; making the demands.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; that is demanded of.
	 * @param type
	 *            The &lt;code&gt;GoodsType&lt;/code&gt; being demanded, null implies gold.
	 * @param amount
	 *            The amount of goods/gold being demanded.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element indianDemand(final ServerPlayer serverPlayer, Unit unit, Colony colony, GoodsType type, int amount) {
<span class="nc" id="L3692">		final Game game = getGame();</span>
<span class="nc" id="L3693">		final Specification spec = game.getSpecification();</span>
<span class="nc" id="L3694">		ServerPlayer victim = (ServerPlayer) colony.getOwner();</span>
<span class="nc" id="L3695">		int difficulty = spec.getInteger(GameOptions.NATIVE_DEMANDS);</span>
<span class="nc" id="L3696">		ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L3698">		DOMMessage reply = askTimeout(victim, new IndianDemandMessage(unit, colony, type, amount));</span>
<span class="nc bnc" id="L3699" title="All 2 branches missed.">		boolean result = (reply instanceof IndianDemandMessage) ? ((IndianDemandMessage) reply).getResult() : false;</span>
<span class="nc bnc" id="L3700" title="All 2 branches missed.">		logger.info(serverPlayer.getName() + &quot; unit &quot; + unit + &quot; demands &quot; + amount + &quot; &quot;</span>
<span class="nc" id="L3701">				+ ((type == null) ? &quot;gold&quot; : type) + &quot; from &quot; + colony.getName() + &quot; accepted: &quot; + result);</span>

<span class="nc" id="L3703">		IndianDemandMessage message = new IndianDemandMessage(unit, colony, type, amount);</span>
<span class="nc" id="L3704">		message.setResult(result);</span>
<span class="nc" id="L3705">		cs.add(See.only(serverPlayer), ChangePriority.CHANGE_NORMAL, message);</span>
<span class="nc bnc" id="L3706" title="All 2 branches missed.">		if (result) {</span>
<span class="nc bnc" id="L3707" title="All 2 branches missed.">			if (type == null) {</span>
<span class="nc" id="L3708">				victim.modifyGold(-amount);</span>
<span class="nc" id="L3709">				serverPlayer.modifyGold(amount);</span>
<span class="nc" id="L3710">				cs.addPartial(See.only(victim), victim, &quot;gold&quot;);</span>
				// cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);
			} else {
<span class="nc" id="L3713">				GoodsContainer colonyContainer = colony.getGoodsContainer();</span>
<span class="nc" id="L3714">				colonyContainer.saveState();</span>
<span class="nc" id="L3715">				GoodsContainer unitContainer = unit.getGoodsContainer();</span>
<span class="nc" id="L3716">				unitContainer.saveState();</span>
<span class="nc" id="L3717">				moveGoods(colony, type, amount, unit);</span>
<span class="nc" id="L3718">				cs.add(See.only(victim), colonyContainer);</span>
				// cs.add(See.only(serverPlayer), unitContainer);
			}
<span class="nc" id="L3721">			int tension = -(5 - difficulty) * 50;</span>
<span class="nc" id="L3722">			ServerIndianSettlement is = (ServerIndianSettlement) unit.getHomeIndianSettlement();</span>
<span class="nc bnc" id="L3723" title="All 2 branches missed.">			if (is == null) {</span>
<span class="nc" id="L3724">				serverPlayer.csModifyTension(victim, tension, cs);</span>
			} else {
<span class="nc" id="L3726">				is.csModifyAlarm(victim, tension, true, cs);</span>
			}
		}

<span class="nc" id="L3730">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3731">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Train a unit in Europe.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is demanding.
	 * @param type
	 *            The &lt;code&gt;UnitType&lt;/code&gt; to train.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element trainUnitInEurope(ServerPlayer serverPlayer, UnitType type) {

<span class="nc" id="L3745">		Europe europe = serverPlayer.getEurope();</span>
<span class="nc bnc" id="L3746" title="All 2 branches missed.">		if (europe == null) {</span>
<span class="nc" id="L3747">			return DOMMessage.clientError(&quot;No Europe to train in.&quot;);</span>
		}
<span class="nc" id="L3749">		int price = europe.getUnitPrice(type);</span>
<span class="nc bnc" id="L3750" title="All 2 branches missed.">		if (price &lt;= 0) {</span>
<span class="nc" id="L3751">			return DOMMessage.clientError(&quot;Bogus price: &quot; + price);</span>
<span class="nc bnc" id="L3752" title="All 2 branches missed.">		} else if (!serverPlayer.checkGold(price)) {</span>
<span class="nc" id="L3753">			return DOMMessage</span>
<span class="nc" id="L3754">					.clientError(&quot;Not enough gold (&quot; + serverPlayer.getGold() + &quot; &lt; &quot; + price + &quot;) to train &quot; + type);</span>
		}

<span class="nc" id="L3757">		final Game game = getGame();</span>
<span class="nc" id="L3758">		final Specification spec = game.getSpecification();</span>
<span class="nc bnc" id="L3759" title="All 2 branches missed.">		Role role = (spec.getBoolean(GameOptions.EQUIP_EUROPEAN_RECRUITS)) ? type.getDefaultRole()</span>
<span class="nc" id="L3760">				: spec.getDefaultRole();</span>
<span class="nc" id="L3761">		Unit unit = new ServerUnit(game, europe, serverPlayer, type, role);// -vis:</span>
																			// safe,
																			// Europe
<span class="nc" id="L3764">		unit.setName(serverPlayer.getNameForUnit(type, random));</span>
<span class="nc" id="L3765">		serverPlayer.modifyGold(-price);</span>
<span class="nc" id="L3766">		((ServerEurope) europe).increasePrice(type, price);</span>

		// Only visible in Europe
<span class="nc" id="L3769">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3770">		cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3771">		cs.add(See.only(serverPlayer), europe);</span>
<span class="nc" id="L3772">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Set build queue.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the colony.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to set the queue of.
	 * @param queue
	 *            The new build queue.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element setBuildQueue(ServerPlayer serverPlayer, Colony colony, List&lt;BuildableType&gt; queue) {
<span class="fc" id="L3787">		BuildableType current = colony.getCurrentlyBuilding();</span>
<span class="fc" id="L3788">		colony.setBuildQueue(queue);</span>
<span class="pc bpc" id="L3789" title="1 of 2 branches missed.">		if (getGame().getSpecification().getBoolean(GameOptions.CLEAR_HAMMERS_ON_CONSTRUCTION_SWITCH)</span>
<span class="nc bnc" id="L3790" title="All 2 branches missed.">				&amp;&amp; current != colony.getCurrentlyBuilding()) {</span>
<span class="nc bnc" id="L3791" title="All 2 branches missed.">			for (AbstractGoods ag : current.getRequiredGoods()) {</span>
<span class="nc bnc" id="L3792" title="All 2 branches missed.">				if (!ag.getType().isStorable()) {</span>
<span class="nc" id="L3793">					colony.removeGoods(ag.getType());</span>
				}
<span class="nc" id="L3795">			}</span>
		}
<span class="fc" id="L3797">		colony.invalidateCache();</span>

		// Only visible to player.
<span class="fc" id="L3800">		ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3801">		cs.add(See.only(serverPlayer), colony);</span>
<span class="fc" id="L3802">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Set goods levels.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the colony.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to set the goods levels in.
	 * @param exportData
	 *            The new &lt;code&gt;ExportData&lt;/code&gt;.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element setGoodsLevels(ServerPlayer serverPlayer, Colony colony, ExportData exportData) {
<span class="nc" id="L3817">		colony.setExportData(exportData);</span>
<span class="nc" id="L3818">		return new ChangeSet().add(See.only(serverPlayer), colony).build(serverPlayer);</span>
	}

	/**
	 * Put outside colony.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to be put out.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element putOutsideColony(ServerPlayer serverPlayer, Unit unit) {
<span class="nc" id="L3831">		Tile tile = unit.getTile();</span>
<span class="nc" id="L3832">		Colony colony = unit.getColony();</span>
<span class="nc bnc" id="L3833" title="All 2 branches missed.">		if (unit.isInColony())</span>
<span class="nc" id="L3834">			tile.cacheUnseen();// +til</span>
<span class="nc" id="L3835">		unit.setLocation(tile);// -vis: safe/colony,-til if in colony</span>

		// Full tile update for the player, the rest get their limited
		// view of the colony so that population changes.
<span class="nc" id="L3839">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3840">		cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L3841">		cs.add(See.perhaps().except(serverPlayer), colony);</span>
<span class="nc" id="L3842">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Change work type.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to change the work type of.
	 * @param type
	 *            The new &lt;code&gt;GoodsType&lt;/code&gt; to produce.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element changeWorkType(ServerPlayer serverPlayer, Unit unit, GoodsType type) {
<span class="pc bpc" id="L3857" title="1 of 2 branches missed.">		if (unit.getWorkType() != type) {</span>
<span class="fc" id="L3858">			unit.setExperience(0);</span>
<span class="fc" id="L3859">			unit.changeWorkType(type);</span>
		}

		// Private update of the colony.
<span class="fc" id="L3863">		return new ChangeSet().add(See.only(serverPlayer), unit.getColony()).build(serverPlayer);</span>
	}

	/**
	 * Change improvement work type.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to change the work type of.
	 * @param type
	 *            The new &lt;code&gt;TileImprovementType&lt;/code&gt; to produce.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element changeWorkImprovementType(ServerPlayer serverPlayer, Unit unit, TileImprovementType type) {
<span class="fc" id="L3878">		Tile tile = unit.getTile();</span>
<span class="fc" id="L3879">		TileImprovement improvement = tile.getTileImprovement(type);</span>
<span class="fc bfc" id="L3880" title="All 2 branches covered.">		if (improvement == null) { // Create the new improvement.</span>
<span class="fc" id="L3881">			improvement = new TileImprovement(getGame(), tile, type);</span>
<span class="fc" id="L3882">			tile.add(improvement);</span>
		}

<span class="fc" id="L3885">		unit.setWorkImprovement(improvement);</span>
<span class="fc" id="L3886">		unit.setState(UnitState.IMPROVING);</span>

		// Private update of the tile.
<span class="fc" id="L3889">		return new ChangeSet().add(See.only(serverPlayer), tile).build(serverPlayer);</span>
	}

	/**
	 * Change a units state.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The &lt;code&gt;Unit&lt;/code&gt; to change the state of.
	 * @param state
	 *            The new &lt;code&gt;UnitState&lt;/code&gt;.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element changeState(ServerPlayer serverPlayer, Unit unit, UnitState state) {
<span class="nc" id="L3904">		ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L3906">		Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L3907" title="All 4 branches missed.">		boolean tileDirty = tile != null &amp;&amp; tile.getIndianSettlement() != null;</span>
<span class="nc bnc" id="L3908" title="All 4 branches missed.">		if (state == UnitState.FORTIFYING &amp;&amp; tile != null) {</span>
<span class="nc bnc" id="L3909" title="All 2 branches missed.">			ServerColony colony = (tile.getOwningSettlement() instanceof Colony)</span>
<span class="nc" id="L3910">					? (ServerColony) tile.getOwningSettlement() : null;</span>
<span class="nc bnc" id="L3911" title="All 2 branches missed.">			Player owner = (colony == null) ? null : colony.getOwner();</span>
<span class="nc bnc" id="L3912" title="All 6 branches missed.">			if (owner != null &amp;&amp; owner != unit.getOwner() &amp;&amp; serverPlayer.getStance(owner) != Stance.ALLIANCE</span>
<span class="nc bnc" id="L3913" title="All 2 branches missed.">					&amp;&amp; serverPlayer.getStance(owner) != Stance.PEACE) {</span>
<span class="nc bnc" id="L3914" title="All 2 branches missed.">				if (colony.isTileInUse(tile)) {</span>
<span class="nc" id="L3915">					colony.csEvictUsers(unit, cs);</span>
				}
<span class="nc bnc" id="L3917" title="All 2 branches missed.">				if (serverPlayer.getStance(owner) == Stance.WAR) {</span>
<span class="nc" id="L3918">					tile.changeOwnership(null, null); // Clear owner if at war</span>
<span class="nc" id="L3919">					tileDirty = true;</span>
				}
			}
		}

<span class="nc" id="L3924">		unit.setState(state);</span>
<span class="nc bnc" id="L3925" title="All 2 branches missed.">		if (tileDirty) {</span>
<span class="nc" id="L3926">			cs.add(See.perhaps(), tile);</span>
		} else {
<span class="nc" id="L3928">			cs.add(See.perhaps(), (FreeColGameObject) unit.getLocation());</span>
		}

		// Others might be able to see the unit.
<span class="nc" id="L3932">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3933">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Assign a student to a teacher.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param student
	 *            The student &lt;code&gt;Unit&lt;/code&gt;.
	 * @param teacher
	 *            The teacher &lt;code&gt;Unit&lt;/code&gt;.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element assignTeacher(ServerPlayer serverPlayer, Unit student, Unit teacher) {
<span class="nc" id="L3948">		Unit oldStudent = teacher.getStudent();</span>
<span class="nc" id="L3949">		Unit oldTeacher = student.getTeacher();</span>

		// Only update units that changed their teaching situation.
<span class="nc" id="L3952">		ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L3953" title="All 2 branches missed.">		if (oldTeacher != null) {</span>
<span class="nc" id="L3954">			oldTeacher.setStudent(null);</span>
<span class="nc" id="L3955">			cs.add(See.only(serverPlayer), oldTeacher);</span>
		}
<span class="nc bnc" id="L3957" title="All 2 branches missed.">		if (oldStudent != null) {</span>
<span class="nc" id="L3958">			oldStudent.setTeacher(null);</span>
<span class="nc" id="L3959">			cs.add(See.only(serverPlayer), oldStudent);</span>
		}
<span class="nc" id="L3961">		teacher.setStudent(student);</span>
<span class="nc" id="L3962">		teacher.changeWorkType(null);</span>
<span class="nc" id="L3963">		student.setTeacher(teacher);</span>
<span class="nc" id="L3964">		cs.add(See.only(serverPlayer), student, teacher);</span>
<span class="nc" id="L3965">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Assign a trade route to a unit.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
	 * @param unit
	 *            The unit &lt;code&gt;Unit&lt;/code&gt; to assign to.
	 * @param tradeRoute
	 *            The &lt;code&gt;TradeRoute&lt;/code&gt; to assign.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element assignTradeRoute(ServerPlayer serverPlayer, Unit unit, TradeRoute tradeRoute) {
		// If clearing a trade route and the unit is at sea, set
		// the destination to the next stop. Otherwise just clear
		// the destination.
		TradeRouteStop stop;
<span class="nc bnc" id="L3984" title="All 2 branches missed.">		unit.setDestination(</span>
<span class="nc bnc" id="L3985" title="All 4 branches missed.">				(tradeRoute == null &amp;&amp; unit.isAtSea() &amp;&amp; (stop = unit.getStop()) != null) ? stop.getLocation() : null);</span>
<span class="nc" id="L3986">		unit.setTradeRoute(tradeRoute);</span>
<span class="nc bnc" id="L3987" title="All 2 branches missed.">		if (tradeRoute != null) {</span>
<span class="nc" id="L3988">			List&lt;TradeRouteStop&gt; stops = tradeRoute.getStops();</span>
<span class="nc" id="L3989">			int found = -1;</span>
<span class="nc bnc" id="L3990" title="All 2 branches missed.">			for (int i = 0; i &lt; stops.size(); i++) {</span>
<span class="nc bnc" id="L3991" title="All 2 branches missed.">				if (Map.isSameLocation(unit.getLocation(), stops.get(i).getLocation())) {</span>
<span class="nc" id="L3992">					found = i;</span>
<span class="nc" id="L3993">					break;</span>
				}
			}
<span class="nc bnc" id="L3996" title="All 2 branches missed.">			if (found &lt; 0)</span>
<span class="nc" id="L3997">				found = 0;</span>
<span class="nc" id="L3998">			unit.setCurrentStop(found);</span>
		}

		// Only visible to the player
<span class="nc" id="L4002">		return new ChangeSet().add(See.only(serverPlayer), unit).build(serverPlayer);</span>
	}

	/**
	 * Set trade routes for a player.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to set trade routes for.
	 * @param routes
	 *            The new list of &lt;code&gt;TradeRoute&lt;/code&gt;s.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element setTradeRoutes(ServerPlayer serverPlayer, List&lt;TradeRoute&gt; routes) {
<span class="nc" id="L4015">		serverPlayer.setTradeRoutes(routes);</span>
		// Have to update the whole player alas.
<span class="nc" id="L4017">		return new ChangeSet().add(See.only(serverPlayer), serverPlayer).build(serverPlayer);</span>
	}

	/**
	 * Get a new trade route for a player.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to get a trade route for.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element getNewTradeRoute(ServerPlayer serverPlayer) {
<span class="nc" id="L4028">		List&lt;TradeRoute&gt; routes = serverPlayer.getTradeRoutes();</span>
<span class="nc" id="L4029">		TradeRoute route = new TradeRoute(getGame(), serverPlayer.getNameForTradeRoute(), serverPlayer);</span>
<span class="nc" id="L4030">		routes.add(route);</span>
<span class="nc" id="L4031">		return new ChangeSet().addTradeRoute(serverPlayer, route).build(serverPlayer);</span>
	}

	/**
	 * Get a list of abstract REF units for a player.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; to query the REF of.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element getREFUnits(ServerPlayer serverPlayer) {
<span class="nc" id="L4042">		final Game game = getGame();</span>
<span class="nc" id="L4043">		final Specification spec = game.getSpecification();</span>
<span class="nc" id="L4044">		List&lt;AbstractUnit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L4045">		final UnitType defaultType = spec.getDefaultUnitType(serverPlayer);</span>

<span class="nc bnc" id="L4047" title="All 2 branches missed.">		if (serverPlayer.getPlayerType() == PlayerType.COLONIAL) {</span>
<span class="nc" id="L4048">			units = serverPlayer.getMonarch().getExpeditionaryForce().getUnits();</span>
		} else {
<span class="nc" id="L4050">			ServerPlayer REFPlayer = (ServerPlayer) serverPlayer.getREFPlayer();</span>
<span class="nc" id="L4051">			java.util.Map&lt;UnitType, HashMap&lt;String, Integer&gt;&gt; unitHash = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L4052" title="All 2 branches missed.">			for (Unit unit : REFPlayer.getUnits()) {</span>
<span class="nc bnc" id="L4053" title="All 2 branches missed.">				if (unit.isOffensiveUnit()) {</span>
<span class="nc" id="L4054">					UnitType unitType = defaultType;</span>
<span class="nc bnc" id="L4055" title="All 4 branches missed.">					if (unit.getType().getOffence() &gt; 0 || unit.hasAbility(Ability.EXPERT_SOLDIER)) {</span>
<span class="nc" id="L4056">						unitType = unit.getType();</span>
					}
<span class="nc" id="L4058">					HashMap&lt;String, Integer&gt; roleMap = unitHash.get(unitType);</span>
<span class="nc bnc" id="L4059" title="All 2 branches missed.">					if (roleMap == null)</span>
<span class="nc" id="L4060">						roleMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4061">					String roleId = unit.getRole().getId();</span>
<span class="nc" id="L4062">					Integer count = roleMap.get(roleId);</span>
<span class="nc bnc" id="L4063" title="All 2 branches missed.">					roleMap.put(roleId, (count == null) ? 1 : count + 1);</span>
<span class="nc" id="L4064">					unitHash.put(unitType, roleMap);</span>
				}
<span class="nc" id="L4066">			}</span>
<span class="nc bnc" id="L4067" title="All 2 branches missed.">			for (java.util.Map.Entry&lt;UnitType, HashMap&lt;String, Integer&gt;&gt; typeEntry : unitHash.entrySet()) {</span>
<span class="nc bnc" id="L4068" title="All 2 branches missed.">				for (java.util.Map.Entry&lt;String, Integer&gt; roleEntry : typeEntry.getValue().entrySet()) {</span>
<span class="nc" id="L4069">					units.add(new AbstractUnit(typeEntry.getKey(), roleEntry.getKey(), roleEntry.getValue()));</span>
<span class="nc" id="L4070">				}</span>
<span class="nc" id="L4071">			}</span>
		}

<span class="nc" id="L4074">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4075">		cs.addTrivial(See.only(serverPlayer), &quot;getREFUnits&quot;, ChangePriority.CHANGE_NORMAL);</span>
<span class="nc" id="L4076">		Element reply = cs.build(serverPlayer);</span>
		// FIXME: eliminate explicit Element hackery
<span class="nc bnc" id="L4078" title="All 2 branches missed.">		for (AbstractUnit unit : units) {</span>
<span class="nc" id="L4079">			reply.appendChild(unit.toXMLElement(reply.getOwnerDocument()));</span>
<span class="nc" id="L4080">		}</span>
<span class="nc" id="L4081">		return reply;</span>
	}

	/**
	 * Gets the list of high scores.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is querying.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element getHighScores(ServerPlayer serverPlayer) {
<span class="nc" id="L4092">		List&lt;HighScore&gt; scores = HighScore.loadHighScores();</span>
<span class="nc" id="L4093">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4094">		cs.addTrivial(See.only(serverPlayer), &quot;getHighScores&quot;, ChangePriority.CHANGE_NORMAL);</span>
<span class="nc" id="L4095">		Element reply = cs.build(serverPlayer);</span>
<span class="nc bnc" id="L4096" title="All 2 branches missed.">		if (scores != null) {</span>
<span class="nc bnc" id="L4097" title="All 2 branches missed.">			for (HighScore score : scores) {</span>
<span class="nc" id="L4098">				reply.appendChild(score.toXMLElement(reply.getOwnerDocument()));</span>
<span class="nc" id="L4099">			}</span>
		}
<span class="nc" id="L4101">		return reply;</span>
	}

	/**
	 * Chat.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is chatting.
	 * @param message
	 *            The chat message.
	 * @param pri
	 *            A privacy setting, currently a noop.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element chat(ServerPlayer serverPlayer, String message, boolean pri) {
<span class="nc" id="L4116">		getGame().sendToOthers(serverPlayer, new ChangeSet().add(See.all().except(serverPlayer),</span>
				ChangeSet.ChangePriority.CHANGE_NORMAL, new ChatMessage(serverPlayer, message, false)));
<span class="nc" id="L4118">		return null;</span>
	}

	/**
	 * Get the current game statistics.
	 *
	 * @param serverPlayer
	 *            the server player
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element getStatistics(ServerPlayer serverPlayer) {
		// Convert statistics map to a list.
<span class="nc" id="L4130">		java.util.Map&lt;String, String&gt; stats = getGame().getStatistics();</span>

<span class="nc" id="L4132">		stats.putAll(getFreeColServer().getAIMain().getAIStatistics());</span>

<span class="nc" id="L4134">		List&lt;String&gt; all = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L4135" title="All 2 branches missed.">		for (Entry&lt;String, String&gt; e : mapEntriesByKey(stats)) {</span>
<span class="nc" id="L4136">			all.add(e.getKey());</span>
<span class="nc" id="L4137">			all.add(e.getValue());</span>
<span class="nc" id="L4138">		}</span>

		// Return as statistics element.
<span class="nc" id="L4141">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4142">		cs.addTrivial(See.only(serverPlayer), &quot;statistics&quot;, ChangePriority.CHANGE_NORMAL, all.toArray(new String[0]));</span>
<span class="nc" id="L4143">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Enters revenge mode against those evil AIs.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; entering revenge mode.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element enterRevengeMode(ServerPlayer serverPlayer) {
<span class="nc bnc" id="L4154" title="All 2 branches missed.">		if (!getFreeColServer().getSinglePlayer()) {</span>
<span class="nc" id="L4155">			return DOMMessage.clientError(&quot;Can not enter revenge mode,&quot; + &quot; as this is not a single player game.&quot;);</span>
		}
<span class="nc" id="L4157">		Game game = getGame();</span>
<span class="nc" id="L4158">		List&lt;UnitType&gt; undeads = game.getSpecification().getUnitTypesWithAbility(Ability.UNDEAD);</span>
<span class="nc" id="L4159">		List&lt;UnitType&gt; navalUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L4160">		List&lt;UnitType&gt; landUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L4161" title="All 2 branches missed.">		for (UnitType undead : undeads) {</span>
<span class="nc bnc" id="L4162" title="All 2 branches missed.">			if (undead.hasAbility(Ability.NAVAL_UNIT)) {</span>
<span class="nc" id="L4163">				navalUnits.add(undead);</span>
<span class="nc bnc" id="L4164" title="All 2 branches missed.">			} else if (undead.hasAbility(Ability.MULTIPLE_ATTACKS)) {</span>
<span class="nc" id="L4165">				landUnits.add(undead);</span>
			}
<span class="nc" id="L4167">		}</span>
<span class="nc bnc" id="L4168" title="All 4 branches missed.">		if (navalUnits.isEmpty() || landUnits.isEmpty()) {</span>
<span class="nc" id="L4169">			return DOMMessage.clientError(&quot;Can not enter revenge mode,&quot; + &quot; because we can not find the undead units.&quot;);</span>
		}

<span class="nc" id="L4172">		ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4173">		UnitType navalType = getRandomMember(logger, &quot;Choose undead navy&quot;, navalUnits, random);</span>
<span class="nc" id="L4174">		Tile start = ((Tile) serverPlayer.getEntryLocation()).getSafeTile(serverPlayer, random);</span>
<span class="nc" id="L4175">		Unit theFlyingDutchman = new ServerUnit(game, start, serverPlayer, navalType);// -vis(serverPlayer)</span>
<span class="nc" id="L4176">		UnitType landType = getRandomMember(logger, &quot;Choose undead army&quot;, landUnits, random);</span>
<span class="nc" id="L4177">		new ServerUnit(game, theFlyingDutchman, serverPlayer, landType);// -vis</span>
<span class="nc" id="L4178">		serverPlayer.setDead(false);</span>
<span class="nc" id="L4179">		serverPlayer.changePlayerType(PlayerType.UNDEAD);</span>
<span class="nc" id="L4180">		serverPlayer.invalidateCanSeeTiles();// +vis(serverPlayer)</span>

		// No one likes the undead.
<span class="nc bnc" id="L4183" title="All 2 branches missed.">		for (Player p : game.getLivePlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L4184" title="All 2 branches missed.">			if (serverPlayer.hasContacted(p)) {</span>
<span class="nc" id="L4185">				serverPlayer.csChangeStance(Stance.WAR, (ServerPlayer) p, true, cs);</span>
			}
<span class="nc" id="L4187">		}</span>

		// Revenge begins
<span class="nc" id="L4190">		game.setCurrentPlayer(serverPlayer);</span>
<span class="nc" id="L4191">		cs.addTrivial(See.all(), &quot;setCurrentPlayer&quot;, ChangePriority.CHANGE_LATE, &quot;player&quot;, serverPlayer.getId());</span>

		// Others can tell something has happened to the player,
		// and possibly see the units.
<span class="nc" id="L4195">		cs.add(See.all(), serverPlayer);</span>
<span class="nc" id="L4196">		cs.add(See.perhaps(), start);</span>
<span class="nc" id="L4197">		getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L4198">		return cs.build(serverPlayer);</span>
	}

	/**
	 * Rearrange a colony.
	 *
	 * @param serverPlayer
	 *            The &lt;code&gt;ServerPlayer&lt;/code&gt; that is querying.
	 * @param colony
	 *            The &lt;code&gt;Colony&lt;/code&gt; to rearrange.
	 * @param unitChanges
	 *            A list of &lt;code&gt;UnitChange&lt;/code&gt;s to apply.
	 * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
	 */
	public Element rearrangeColony(ServerPlayer serverPlayer, Colony colony, List&lt;UnitChange&gt; unitChanges) {
<span class="fc" id="L4213">		final Role defaultRole = getGame().getSpecification().getDefaultRole();</span>
<span class="fc" id="L4214">		Tile tile = colony.getTile();</span>
<span class="fc" id="L4215">		tile.cacheUnseen();// +til</span>

		// Move everyone out of the way and stockpile their equipment.
<span class="fc bfc" id="L4218" title="All 2 branches covered.">		for (UnitChange uc : unitChanges) {</span>
<span class="fc" id="L4219">			uc.unit.setLocation(tile);// -til</span>
<span class="pc bpc" id="L4220" title="1 of 2 branches missed.">			if (!uc.unit.hasDefaultRole()) {</span>
<span class="nc" id="L4221">				colony.equipForRole(uc.unit, defaultRole, 0);</span>
			}
<span class="fc" id="L4223">		}</span>

<span class="fc" id="L4225">		List&lt;UnitChange&gt; todo = new ArrayList&lt;&gt;(unitChanges);</span>
<span class="fc bfc" id="L4226" title="All 2 branches covered.">		while (!todo.isEmpty()) {</span>
<span class="fc" id="L4227">			UnitChange uc = todo.remove(0);</span>
<span class="pc bpc" id="L4228" title="1 of 2 branches missed.">			if (uc.loc == tile)</span>
<span class="nc" id="L4229">				continue;</span>
<span class="fc" id="L4230">			WorkLocation wl = (WorkLocation) uc.loc;</span>
			// Adding to wl can fail, and in the worst case there
			// might be a circular dependency. If the move can
			// succeed, do it, but if not, retry.
<span class="pc bpc" id="L4234" title="3 of 4 branches missed.">			switch (wl.getNoAddReason(uc.unit)) {</span>
			case NONE:
<span class="fc" id="L4236">				uc.unit.setLocation(wl);</span>
				// Fall through
			case ALREADY_PRESENT:
<span class="fc bfc" id="L4239" title="All 2 branches covered.">				if (uc.unit.getWorkType() != uc.work) {</span>
<span class="fc" id="L4240">					uc.unit.changeWorkType(uc.work);</span>
				}
				break;
			case CAPACITY_EXCEEDED:
<span class="nc" id="L4244">				todo.add(todo.size(), uc);</span>
<span class="nc" id="L4245">				break;</span>
			default:
<span class="nc" id="L4247">				logger.warning(&quot;Bad move for &quot; + uc.unit + &quot; to &quot; + wl);</span>
				break;
			}
<span class="fc" id="L4250">		}</span>

<span class="fc" id="L4252">		Iterator&lt;UnitChange&gt; uci = unitChanges.iterator();</span>
<span class="fc bfc" id="L4253" title="All 2 branches covered.">		while (uci.hasNext()) {</span>
<span class="fc" id="L4254">			UnitChange uc = uci.next();</span>
<span class="pc bpc" id="L4255" title="1 of 2 branches missed.">			if (uc.unit.getRole() == uc.role)</span>
<span class="fc" id="L4256">				uci.remove();</span>
<span class="fc" id="L4257">		}</span>
<span class="pc bpc" id="L4258" title="1 of 2 branches missed.">		if (!unitChanges.isEmpty()) {</span>
<span class="nc" id="L4259">			Collections.sort(unitChanges, RearrangeColonyMessage.roleComparator);</span>
<span class="nc" id="L4260">			Collections.reverse(unitChanges);</span>
<span class="nc bnc" id="L4261" title="All 2 branches missed.">			for (UnitChange uc : unitChanges) {</span>
<span class="nc bnc" id="L4262" title="All 2 branches missed.">				if (uc.role != defaultRole) {</span>
<span class="nc bnc" id="L4263" title="All 2 branches missed.">					if (!colony.equipForRole(uc.unit, uc.role, uc.roleCount)) {</span>
						// Should not happen if we equip simplest first
<span class="nc" id="L4265">						return DOMMessage.clientError(</span>
<span class="nc" id="L4266">								&quot;Failed to equip &quot; + uc.unit.getId() + &quot; for role &quot; + uc.role + &quot; at &quot; + colony);</span>
					}
				}
<span class="nc" id="L4269">			}</span>
		}

		// Just update the whole tile, including for other players
		// which might see colony population change.
<span class="fc" id="L4274">		return new ChangeSet().add(See.perhaps(), tile).build(serverPlayer);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>