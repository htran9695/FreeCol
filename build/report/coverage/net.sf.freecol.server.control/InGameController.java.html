<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InGameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacocoReport</a> &gt; <a href="index.source.html" class="el_package">net.sf.freecol.server.control</a> &gt; <span class="el_source">InGameController.java</span></div><h1>InGameController.java</h1><pre class="source lang-java linenums">/**
 *  Copyright (C) 2002-2015   The FreeCol Team
 *
 *  This file is part of FreeCol.
 *
 *  FreeCol is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  FreeCol is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with FreeCol.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */

package net.sf.freecol.server.control;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Map.Entry;
import java.util.Random;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;

import net.sf.freecol.FreeCol;
import net.sf.freecol.common.debug.FreeColDebugger;
import net.sf.freecol.common.i18n.Messages;
import net.sf.freecol.common.i18n.NameCache;
import net.sf.freecol.common.model.Ability;
import net.sf.freecol.common.model.AbstractGoods;
import net.sf.freecol.common.model.AbstractUnit;
import net.sf.freecol.common.model.BuildableType;
import net.sf.freecol.common.model.Colony;
import net.sf.freecol.common.model.ColonyTile;
import net.sf.freecol.common.model.CombatModel.CombatResult;
import net.sf.freecol.common.model.DiplomaticTrade;
import net.sf.freecol.common.model.DiplomaticTrade.TradeStatus;
import net.sf.freecol.common.model.Disaster;
import net.sf.freecol.common.model.Europe;
import net.sf.freecol.common.model.Europe.MigrationType;
import net.sf.freecol.common.model.ExportData;
import net.sf.freecol.common.model.FoundingFather;
import net.sf.freecol.common.model.FreeColGameObject;
import net.sf.freecol.common.model.Game;
import net.sf.freecol.common.model.GameOptions;
import net.sf.freecol.common.model.Goods;
import net.sf.freecol.common.model.GoodsContainer;
import net.sf.freecol.common.model.GoodsLocation;
import net.sf.freecol.common.model.GoodsType;
import net.sf.freecol.common.model.HighScore;
import net.sf.freecol.common.model.HighSeas;
import net.sf.freecol.common.model.HistoryEvent;
import net.sf.freecol.common.model.IndianNationType;
import net.sf.freecol.common.model.IndianSettlement;
import net.sf.freecol.common.model.Location;
import net.sf.freecol.common.model.Map;
import net.sf.freecol.common.model.Market;
import net.sf.freecol.common.model.Market.Access;
import net.sf.freecol.common.model.ModelMessage;
import net.sf.freecol.common.model.Monarch;
import net.sf.freecol.common.model.Monarch.MonarchAction;
import net.sf.freecol.common.model.Nameable;
import net.sf.freecol.common.model.Nation;
import net.sf.freecol.common.model.NationSummary;
import net.sf.freecol.common.model.Ownable;
import net.sf.freecol.common.model.Player;
import net.sf.freecol.common.model.Player.PlayerType;
import net.sf.freecol.common.model.Stance;
import net.sf.freecol.common.model.RandomRange;
import net.sf.freecol.common.model.Region;
import net.sf.freecol.common.model.Settlement;
import net.sf.freecol.common.model.Specification;
import net.sf.freecol.common.model.StringTemplate;
import net.sf.freecol.common.model.Tension;
import net.sf.freecol.common.model.Tile;
import net.sf.freecol.common.model.TileImprovement;
import net.sf.freecol.common.model.TileImprovementType;
import net.sf.freecol.common.model.TradeItem;
import net.sf.freecol.common.model.TradeRoute;
import net.sf.freecol.common.model.TradeRouteStop;
import net.sf.freecol.common.model.Turn;
import net.sf.freecol.common.model.Unit;
import net.sf.freecol.common.model.Role;
import net.sf.freecol.common.model.Unit.UnitState;
import net.sf.freecol.common.model.UnitLocation;
import net.sf.freecol.common.model.UnitType;
import net.sf.freecol.common.model.UnitTypeChange.ChangeType;
import net.sf.freecol.common.model.WorkLocation;
import net.sf.freecol.common.networking.ChatMessage;
import net.sf.freecol.common.networking.Connection;
import net.sf.freecol.common.networking.DOMMessage;
import net.sf.freecol.common.networking.DiplomacyMessage;
import net.sf.freecol.common.networking.GoodsForSaleMessage;
import net.sf.freecol.common.networking.IndianDemandMessage;
import net.sf.freecol.common.networking.LootCargoMessage;
import net.sf.freecol.common.networking.MonarchActionMessage;
import net.sf.freecol.common.networking.RearrangeColonyMessage;
import net.sf.freecol.common.networking.RearrangeColonyMessage.UnitChange;
import net.sf.freecol.common.util.LogBuilder;
import net.sf.freecol.common.util.RandomChoice;
import net.sf.freecol.common.util.Utils;

import static net.sf.freecol.common.util.CollectionUtils.*;
import static net.sf.freecol.common.util.RandomUtils.*;

import net.sf.freecol.server.FreeColServer;
import net.sf.freecol.server.ai.AIPlayer;
import net.sf.freecol.server.ai.REFAIPlayer;
import net.sf.freecol.server.control.ChangeSet.ChangePriority;
import net.sf.freecol.server.control.ChangeSet.See;
import net.sf.freecol.server.model.DiplomacySession;
import net.sf.freecol.server.model.LootSession;
import net.sf.freecol.server.model.MonarchSession;
import net.sf.freecol.server.model.ServerColony;
import net.sf.freecol.server.model.ServerEurope;
import net.sf.freecol.server.model.ServerGame;
import net.sf.freecol.server.model.ServerIndianSettlement;
import net.sf.freecol.server.model.ServerPlayer;
import net.sf.freecol.server.model.ServerRegion;
import net.sf.freecol.server.model.ServerUnit;
import net.sf.freecol.server.model.TradeSession;
import net.sf.freecol.server.model.TransactionSession;

import org.w3c.dom.Element;


/**
 * The main server controller.
 */
public final class InGameController extends Controller {

<span class="fc" id="L151">    private static final Logger logger = Logger.getLogger(InGameController.class.getName());</span>

    /** The server random number source. */
    private final Random random;

    /** Debug helpers, do not serialize. */
<span class="fc" id="L157">    private int debugOnlyAITurns = 0;</span>
<span class="fc" id="L158">    private MonarchAction debugMonarchAction = null;</span>
<span class="fc" id="L159">    private ServerPlayer debugMonarchPlayer = null;</span>


    /**
     * The constructor to use.
     *
     * @param freeColServer The main server object.
     * @param random The pseudo-random number source to use.
     */
    public InGameController(FreeColServer freeColServer, Random random) {
<span class="fc" id="L169">        super(freeColServer);</span>

<span class="fc" id="L171">        this.random = random;</span>
<span class="fc" id="L172">    }</span>

    /**
     * Gets the number of AI turns to skip through.
     *
     * @return The number of terms to skip.
     */
    public int getSkippedTurns() {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        return (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS))</span>
            ? debugOnlyAITurns : -1;
    }

    /**
     * Sets the number of AI turns to skip through as a debug helper.
     *
     * @param turns The number of turns to skip through.
     */
    public void setSkippedTurns(int turns) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">        if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L191">            debugOnlyAITurns = turns;</span>
        }
<span class="nc" id="L193">    }</span>

    /**
     * Sets a monarch action to debug/test.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose monarch
     *     should act.
     * @param action The &lt;code&gt;MonarchAction&lt;/code&gt; to be taken.
     */
    public void setMonarchAction(ServerPlayer serverPlayer,
                                 MonarchAction action) {
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (FreeColDebugger.isInDebugMode(FreeColDebugger.DebugMode.MENUS)) {</span>
<span class="nc" id="L205">            debugMonarchPlayer = serverPlayer;</span>
<span class="nc" id="L206">            debugMonarchAction = action;</span>
        }
<span class="nc" id="L208">    }</span>

    /**
     * Debug convenience to step the random number generator.
     *
     * @return The next random number in series, in the range 0-99.
     */
    public int stepRandom() {
<span class="nc" id="L216">        return randomInt(logger, &quot;step random&quot;, random, 100);</span>
    }

    /**
     * Public version of the yearly goods adjust (public so it can be
     * use in the Market test code).  Sends the market and change
     * messages to the player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose market
     *            is to be updated.
     */
    public void yearlyGoodsAdjust(ServerPlayer serverPlayer) {
<span class="fc" id="L228">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L229">        serverPlayer.csYearlyGoodsAdjust(random, cs);</span>
<span class="fc" id="L230">        serverPlayer.send(cs);</span>
<span class="fc" id="L231">    }</span>

    /**
     * Public version of csAddFoundingFather so it can be used in the
     * test code and DebugMenu.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; who gains a father.
     * @param father The &lt;code&gt;FoundingFather&lt;/code&gt; to add.
     */
    public void addFoundingFather(ServerPlayer serverPlayer,
                                  FoundingFather father) {
<span class="fc" id="L242">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L243">        serverPlayer.csAddFoundingFather(father, random, cs);</span>
<span class="fc" id="L244">        cs.addAttribute(See.only(serverPlayer), &quot;flush&quot;,</span>
<span class="fc" id="L245">                        Boolean.TRUE.toString());</span>
<span class="fc" id="L246">        serverPlayer.send(cs);</span>
<span class="fc" id="L247">    }</span>

    /**
     * Public change stance and inform all routine.  Mostly used in the
     * test suite, but the AIs also call it.
     *
     * @param serverPlayer The originating &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param stance The new &lt;code&gt;Stance&lt;/code&gt;.
     * @param other The &lt;code&gt;ServerPlayer&lt;/code&gt; wrt which the
     *     stance changes.
     * @param symmetric If true, change the otherPlayer stance as well.
     */
    public void changeStance(ServerPlayer serverPlayer, Stance stance,
                             ServerPlayer other, boolean symmetric) {
<span class="fc" id="L261">        ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">        if (serverPlayer.csChangeStance(stance, other, symmetric, cs)) {</span>
<span class="fc" id="L263">            getGame().sendToAll(cs);</span>
        }
<span class="fc" id="L265">    }</span>

    /**
     * Change colony owner.  Public for DebugUtils.
     *
     * @param colony The &lt;code&gt;ServerColony&lt;/code&gt; to change.
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to change to.
     */
    public void debugChangeOwner(ServerColony colony,
                                 ServerPlayer serverPlayer) {
<span class="fc" id="L275">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L276">        ServerPlayer owner = (ServerPlayer)colony.getOwner();</span>
<span class="fc" id="L277">        colony.csChangeOwner(serverPlayer, cs);//-vis(serverPlayer,owner)</span>
<span class="fc" id="L278">        cs.add(See.perhaps().always(owner), colony.getOwnedTiles());</span>
<span class="fc" id="L279">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="fc" id="L280">        owner.invalidateCanSeeTiles();//+vis(owner)</span>
<span class="fc" id="L281">        getGame().sendToAll(cs);</span>
<span class="fc" id="L282">    }</span>

    /**
     * Change unit owner.  Public for DebugUtils.
     *
     * @param unit The &lt;code&gt;ServerUnit&lt;/code&gt; to change.
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to change to.
     */
    public void debugChangeOwner(ServerUnit unit, ServerPlayer serverPlayer) {
<span class="nc" id="L291">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L292">        ServerPlayer owner = (ServerPlayer)unit.getOwner();</span>
<span class="nc" id="L293">        owner.csChangeOwner(unit, serverPlayer, null, null,</span>
                            cs);//-vis(serverPlayer,owner)
<span class="nc" id="L295">        cs.add(See.perhaps().always(owner), unit.getTile());</span>
<span class="nc" id="L296">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L297">        owner.invalidateCanSeeTiles();//+vis(owner)</span>
<span class="nc" id="L298">        getGame().sendToAll(cs);</span>
<span class="nc" id="L299">    }</span>

    /**
     * Apply a disaster to a colony.  Public for DebugUtils.
     *
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to apply the disaster to.
     * @param disaster The &lt;code&gt;Disaster&lt;/code&gt; to apply.
     * @return The number of messages generated.
     */
    public int debugApplyDisaster(ServerColony colony, Disaster disaster) {
<span class="nc" id="L309">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L310">        ServerPlayer owner = (ServerPlayer)colony.getOwner();</span>
<span class="nc" id="L311">        List&lt;ModelMessage&gt; messages</span>
<span class="nc" id="L312">            = owner.csApplyDisaster(random, colony, disaster, cs);</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">        if (!messages.isEmpty()) {</span>
<span class="nc" id="L314">            cs.addMessage(See.all(),</span>
                new ModelMessage(ModelMessage.MessageType.DEFAULT,
                    &quot;model.disaster.strikes&quot;, owner)
<span class="nc" id="L317">                .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L318">                .addName(&quot;%disaster%&quot;, disaster));</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            for (ModelMessage message : messages) {</span>
<span class="nc" id="L320">                cs.addMessage(See.all(), message);</span>
<span class="nc" id="L321">            }</span>
<span class="nc" id="L322">            getGame().sendToAll(cs);</span>
        }
<span class="nc" id="L324">        return messages.size();</span>
    }

    /**
     * Move goods from one location to another.
     *
     * @param src The source &lt;code&gt;GoodsLocation&lt;/code&gt;.
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to move.
     * @param amount The amount of goods to move.
     * @param dst The new &lt;code&gt;GoodsLocation&lt;/code&gt;.
     */
    private void moveGoods(GoodsLocation src, GoodsType goodsType, int amount,
                           GoodsLocation dst) {
<span class="fc" id="L337">        src.getGoodsContainer().saveState();</span>
<span class="fc" id="L338">        src.removeGoods(goodsType, amount);</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">        if (dst != null) {</span>
<span class="fc" id="L340">            dst.getGoodsContainer().saveState();</span>
<span class="fc" id="L341">            dst.addGoods(goodsType, amount);</span>
        }
<span class="fc" id="L343">    }</span>

    /**
     * Gets a nation summary.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is querying.
     * @param player The &lt;code&gt;Player&lt;/code&gt; to summarize.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public NationSummary getNationSummary(ServerPlayer serverPlayer,
                                          Player player) {
<span class="fc" id="L354">        return new NationSummary(player, serverPlayer);</span>
    }

    /**
     * Create the Royal Expeditionary Force player corresponding to
     * a given player that is about to rebel.
     *
     * Public for the test suite.
     *
     * FIXME: this should eventually generate changes for the REF player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; about to rebel.
     * @return The REF player.
     */
    public ServerPlayer createREFPlayer(ServerPlayer serverPlayer) {
<span class="fc" id="L369">        Nation refNation = serverPlayer.getNation().getREFNation();</span>
<span class="fc" id="L370">        Monarch monarch = serverPlayer.getMonarch();</span>
<span class="fc" id="L371">        ServerPlayer refPlayer = getFreeColServer().makeAIPlayer(refNation);</span>
<span class="fc" id="L372">        Europe europe = refPlayer.getEurope();</span>
        // Inherit rebel player knowledge of the seas, coasts, claimed
        // land but not full detailed scouting knowledge.
<span class="fc" id="L375">        Set&lt;Tile&gt; explore = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">        for (Tile t : getGame().getMap().getAllTiles()) {</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">            if (!t.isExploredBy(serverPlayer)) continue;</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">            if (!t.isLand()</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                || t.isCoastland()</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">                || t.getOwner() == serverPlayer) {</span>
<span class="nc" id="L381">                explore.add(t);</span>
            }
<span class="nc" id="L383">        }</span>
<span class="fc" id="L384">        refPlayer.exploreTiles(explore);</span>

        // Trigger initial placement routine
<span class="fc" id="L387">        refPlayer.setEntryLocation(null);</span>
        // Will change, setup only
<span class="fc" id="L389">        Player.makeContact(serverPlayer, refPlayer);</span>

        // Instantiate the REF in Europe
<span class="fc" id="L392">        Monarch.Force exf = monarch.getExpeditionaryForce();</span>
        // @compat 0.10.5
        // There was a bug that seriously under provisioned the navy back
        // around 0.10.5, the game in BR#2435 has it.  For now, just add
        // enough ships to carry all the units.
<span class="fc" id="L397">        UnitType ut = monarch.getNavalREFUnitType();</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">        while (exf.getSpaceRequired() &gt; exf.getCapacity()) {</span>
<span class="fc" id="L399">            AbstractUnit au</span>
                = new AbstractUnit(ut, Specification.DEFAULT_ROLE_ID, 1);
<span class="fc" id="L401">            exf.add(au);</span>
<span class="fc" id="L402">        }</span>
        // end @compat 0.10.5
<span class="fc" id="L404">        List&lt;Unit&gt; landUnits = refPlayer.createUnits(exf.getLandUnits(),</span>
                                                     europe);//-vis: safe!map
<span class="fc" id="L406">        List&lt;Unit&gt; navalUnits = refPlayer.createUnits(exf.getNavalUnits(),</span>
                                                      europe);//-vis: safe!map
<span class="fc" id="L408">        refPlayer.loadShips(landUnits, navalUnits, random);//-vis: safe!map</span>
<span class="fc" id="L409">        return refPlayer;</span>
    }


    // Client-server communication utilities

    // A handler interface to pass to askFuture().
    // This will change from DOMMessage to Message when DOM goes away.
    private interface DOMMessageHandler {
        public DOMMessage handle(DOMMessage message);
    };

    private static class DOMMessageCallable implements Callable&lt;DOMMessage&gt; {

        private final Connection connection;
        private final Game game;
        private final DOMMessage message;
        private final DOMMessageHandler handler;


        public DOMMessageCallable(Connection connection, Game game,
                                  DOMMessage message,
<span class="nc" id="L431">                                  DOMMessageHandler handler) {</span>
<span class="nc" id="L432">            this.connection = connection;</span>
<span class="nc" id="L433">            this.game = game;</span>
<span class="nc" id="L434">            this.message = message;</span>
<span class="nc" id="L435">            this.handler = handler;</span>
<span class="nc" id="L436">        }</span>

        @Override
        public DOMMessage call() {
            Element reply;
            try {
<span class="nc" id="L442">                reply = connection.ask(message.toXMLElement());</span>
<span class="nc" id="L443">            } catch (IOException e) {</span>
<span class="nc" id="L444">                return null;</span>
<span class="nc" id="L445">            }</span>
<span class="nc" id="L446">            DOMMessage replyMessage = DOMMessage.createMessage(game, reply);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">            return (replyMessage == null) ? null</span>
<span class="nc" id="L448">                : handler.handle(replyMessage);</span>
        }
    };

    // A service to run the futures.
<span class="fc" id="L453">    private final ExecutorService executor = Executors.newCachedThreadPool();</span>

    /**
     * Asks a question of a player in a Future.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to ask.
     * @param question The &lt;code&gt;DOMMessage&lt;/code&gt; question.
     * @param handler The &lt;code&gt;DOMMessageHandler&lt;/code&gt; handler to process
     *     the reply with.
     * @return A future encapsulating the result.
     */
    private Future&lt;DOMMessage&gt; askFuture(ServerPlayer serverPlayer,
                                         DOMMessage question,
                                         DOMMessageHandler handler) {
<span class="nc" id="L467">        Callable&lt;DOMMessage&gt; callable</span>
<span class="nc" id="L468">            = new DOMMessageCallable(serverPlayer.getConnection(), getGame(),</span>
                                     question, handler);
<span class="nc" id="L470">        return executor.submit(callable);</span>
    }

    /**
     * Asks a question of a player with a timeout.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to ask.
     * @param request The &lt;code&gt;DOMMessage&lt;/code&gt; question.
     * @return The response to the question, or null if none.
     */
    private DOMMessage askTimeout(ServerPlayer serverPlayer,
                                  DOMMessage request) {
<span class="nc" id="L482">        Future&lt;DOMMessage&gt; future = askFuture(serverPlayer, request,</span>
<span class="nc" id="L483">            new DOMMessageHandler() {</span>
                @Override
                public DOMMessage handle(DOMMessage message) {
<span class="nc" id="L486">                    return message;</span>
                }
            });
        DOMMessage reply;
        try {
<span class="nc" id="L491">            boolean single = getFreeColServer().getSinglePlayer();</span>
<span class="nc" id="L492">            reply = future.get(FreeCol.getTimeout(single), TimeUnit.SECONDS);</span>
<span class="nc" id="L493">        } catch (TimeoutException te) {</span>
<span class="nc" id="L494">            serverPlayer.send(new ChangeSet()</span>
<span class="nc" id="L495">                .addTrivial(See.only(serverPlayer), &quot;closeMenus&quot;,</span>
                            ChangePriority.CHANGE_NORMAL));
<span class="nc" id="L497">            reply = null;</span>
<span class="nc" id="L498">        } catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L499">            reply = null;</span>
<span class="nc" id="L500">            logger.log(Level.WARNING, &quot;Exception completing future&quot;, e);</span>
<span class="nc" id="L501">        }</span>
<span class="nc" id="L502">        return reply;</span>
    }

    /**
     * Visits a native settlement, possibly scouting it full if it is
     * as a result of a scout actually asking to speak to the chief,
     * or for other settlement-contacting events such as missionary
     * actions, demanding tribute, learning skills and trading if the
     * settlementActionsContactChief game option is enabled.  It is
     * still unclear what Col1 did here.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is contacting
     *     the settlement.
     * @param is The &lt;code&gt;IndianSettlement&lt;/code&gt; to contact.
     * @param scout Positive if this contact is due to a scout asking to
     *     speak to the chief, zero if it is another unit, negative if
     *     this is from the greeting dialog generation.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csVisit(ServerPlayer serverPlayer, IndianSettlement is,
                         int scout, ChangeSet cs) {
<span class="fc" id="L523">        final ServerPlayer owner = (ServerPlayer)is.getOwner();</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">        if (serverPlayer.csContact(owner, cs)) {</span>
<span class="fc" id="L525">            serverPlayer.csNativeFirstContact(owner, null, cs);</span>
        }
<span class="fc" id="L527">        is.setVisited(serverPlayer);</span>
<span class="pc bpc" id="L528" title="2 of 4 branches missed.">        if (scout &gt; 0 || (scout == 0 &amp;&amp; getGame().getSpecification()</span>
<span class="pc bpc" id="L529" title="1 of 2 branches missed.">                .getBoolean(GameOptions.SETTLEMENT_ACTIONS_CONTACT_CHIEF))) {</span>
<span class="nc" id="L530">            is.setScouted(serverPlayer);</span>
        }
<span class="fc" id="L532">    }</span>

    // Routines that follow implement the controller response to
    // messages.
    // The convention is to return an element to be passed back to the
    // client by the invoking message handler.

    /**
     * Ends the turn of the given player.
     *
     * Note: sends messages to other players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to end the turn of.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating the end of turn changes
     *     for the given player.
     */
    public Element endTurn(ServerPlayer serverPlayer) {
<span class="nc" id="L549">        final FreeColServer freeColServer = getFreeColServer();</span>
<span class="nc" id="L550">        final ServerGame game = getGame();</span>
<span class="nc" id="L551">        final ServerPlayer winner = (ServerPlayer)game.checkForWinner();</span>

<span class="nc" id="L553">        ServerPlayer player = (ServerPlayer)game.getCurrentPlayer();</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">        if (serverPlayer != player) {</span>
<span class="nc" id="L555">            throw new IllegalArgumentException(&quot;It is not &quot;</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">                + serverPlayer.getName() + &quot;'s turn, it is &quot;</span>
<span class="nc" id="L557">                + ((player == null) ? &quot;noone&quot; : player.getName()) + &quot;'s!&quot;);</span>
        }

        for (;;) {
<span class="nc" id="L561">            logger.finest(&quot;Ending turn for &quot; + player.getName());</span>
<span class="nc" id="L562">            player.clearModelMessages();</span>

            // Check for new turn
<span class="nc" id="L565">            ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">            if (game.isNextPlayerInNewTurn()) {</span>
<span class="nc" id="L567">                ChangeSet next = new ChangeSet();</span>
<span class="nc" id="L568">                game.csNextTurn(next);</span>
<span class="nc" id="L569">                game.sendToAll(next);</span>

<span class="nc" id="L571">                LogBuilder lb = new LogBuilder(512);</span>
<span class="nc" id="L572">                lb.add(&quot;New turn &quot;, game.getTurn(), &quot; for &quot;);</span>
<span class="nc" id="L573">                game.csNewTurn(random, lb, cs);</span>
<span class="nc" id="L574">                lb.shrink(&quot;, &quot;);</span>
<span class="nc" id="L575">                lb.log(logger, Level.FINEST);</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                if (debugOnlyAITurns &gt; 0) {</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">                    if (--debugOnlyAITurns &lt;= 0) {</span>
                        // If this was a debug run, complete it.  This will
                        // signal the client to save and quit at the next
                        // suitable opportunity.
<span class="nc" id="L581">                        FreeColDebugger.signalEndDebugRun();</span>
                    }
                }
            }

<span class="nc bnc" id="L586" title="All 2 branches missed.">            if ((player = (ServerPlayer)game.getNextPlayer()) == null) {</span>
                // &quot;can not happen&quot;
<span class="nc" id="L588">                return DOMMessage.clientError(&quot;Can not get next player&quot;);</span>
            }

            // Remove dead players and retry
<span class="nc bnc" id="L592" title="All 3 branches missed.">            switch (player.checkForDeath()) {</span>
            case ServerPlayer.IS_DEAD:
<span class="nc" id="L594">                player.csWithdraw(cs);</span>
<span class="nc" id="L595">                logger.info(&quot;For &quot; + serverPlayer.getSuffix()</span>
<span class="nc" id="L596">                    + &quot;, &quot; + player.getNation() + &quot; is dead.&quot;);</span>
<span class="nc" id="L597">                game.sendToAll(cs, player);</span>
<span class="nc" id="L598">                continue;</span>
            case ServerPlayer.IS_ALIVE:
<span class="nc bnc" id="L600" title="All 4 branches missed.">                if (player.isREF() &amp;&amp; player.checkForREFDefeat()) {</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">                    for (Player p : player.getRebels()) {</span>
<span class="nc" id="L602">                        csGiveIndependence(player, (ServerPlayer)p, cs);</span>
<span class="nc" id="L603">                    }</span>
<span class="nc" id="L604">                    player.csWithdraw(cs);</span>
<span class="nc" id="L605">                    logger.info(player.getNation() + &quot; is defeated.&quot;);</span>
<span class="nc" id="L606">                    game.sendToAll(cs, player);</span>
<span class="nc" id="L607">                    continue;</span>
                }
                break;
            default: // Need to autorecruit a unit to keep alive.
<span class="nc" id="L611">                player.csEmigrate(0, MigrationType.SURVIVAL, random, cs);</span>
                break;
            }
            // Are there humans left?
            // FIXME: see if this can be relaxed so we can run large
            // AI-only simulations.
<span class="nc" id="L617">            boolean onlyAI = all(game.getConnectedPlayers(), Player::isAI);</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">            if (onlyAI) {</span>
<span class="nc" id="L619">                logger.info(&quot;No human player left.&quot;);</span>
<span class="nc bnc" id="L620" title="All 2 branches missed.">                if (debugOnlyAITurns &gt; 0) { // Complete debug runs</span>
<span class="nc" id="L621">                    FreeColDebugger.signalEndDebugRun();</span>
                }
<span class="nc" id="L623">                game.setCurrentPlayer(null);</span>

<span class="nc" id="L625">                cs.addTrivial(See.all(), &quot;gameEnded&quot;,</span>
                              ChangePriority.CHANGE_NORMAL);
<span class="nc" id="L627">                game.sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L628">                return cs.build(serverPlayer);</span>
            }

            // Has the player won?
            // Do not end single player games where an AI has won,
            // that would stop revenge mode.
<span class="nc bnc" id="L634" title="All 2 branches missed.">            if (winner == player</span>
<span class="nc bnc" id="L635" title="All 4 branches missed.">                &amp;&amp; !(freeColServer.getSinglePlayer() &amp;&amp; winner.isAI())) {</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">                boolean highScore = !winner.isAI()</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">                    &amp;&amp; HighScore.newHighScore(winner);</span>
<span class="nc" id="L638">                cs.addTrivial(See.all(), &quot;gameEnded&quot;,</span>
                              ChangePriority.CHANGE_NORMAL,
<span class="nc" id="L640">                              &quot;highScore&quot;, String.valueOf(highScore),</span>
<span class="nc" id="L641">                              &quot;winner&quot;, winner.getId());</span>
            }

            // Do &quot;new turn&quot;-like actions that need to wait until right
            // before the player is about to move.
<span class="nc" id="L646">            game.setCurrentPlayer(player);</span>
<span class="nc bnc" id="L647" title="All 4 branches missed.">            if (player.isREF() &amp;&amp; player.getEntryLocation() == null) {</span>
                // Initialize this newly created REF
                // If the teleportREF option is enabled, teleport it in.
<span class="nc" id="L650">                REFAIPlayer refAIPlayer = (REFAIPlayer)freeColServer</span>
<span class="nc" id="L651">                    .getAIPlayer(player);</span>
<span class="nc" id="L652">                boolean teleport = game.getSpecification()</span>
<span class="nc" id="L653">                    .getBoolean(GameOptions.TELEPORT_REF);</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                if (refAIPlayer.initialize(teleport)) {</span>
<span class="nc" id="L655">                    csLaunchREF(player, teleport, cs);</span>
                } else {
<span class="nc" id="L657">                    logger.severe(&quot;REF failed to initialize.&quot;);</span>
                }
            }
<span class="nc" id="L660">            player.csStartTurn(random, cs);</span>

<span class="nc" id="L662">            cs.addTrivial(See.all(), &quot;setCurrentPlayer&quot;,</span>
                          ChangePriority.CHANGE_LATE,
<span class="nc" id="L664">                          &quot;player&quot;, player.getId());</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">            if (player.getPlayerType() == PlayerType.COLONIAL) {</span>
<span class="nc" id="L666">                Monarch monarch = player.getMonarch();</span>
<span class="nc" id="L667">                MonarchAction action = null;</span>
<span class="nc bnc" id="L668" title="All 4 branches missed.">                if (debugMonarchAction != null</span>
                    &amp;&amp; player == debugMonarchPlayer) {
<span class="nc" id="L670">                    action = debugMonarchAction;</span>
<span class="nc" id="L671">                    debugMonarchAction = null;</span>
<span class="nc" id="L672">                    debugMonarchPlayer = null;</span>
<span class="nc" id="L673">                    logger.finest(&quot;Debug monarch action: &quot; + action);</span>
                } else {
<span class="nc" id="L675">                    action = RandomChoice.getWeightedRandom(logger,</span>
                            &quot;Choose monarch action&quot;,
<span class="nc" id="L677">                        monarch.getActionChoices(), random);</span>
                }
<span class="nc bnc" id="L679" title="All 2 branches missed.">                if (action != null) {</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                    if (monarch.actionIsValid(action)) {</span>
<span class="nc" id="L681">                        logger.finest(&quot;Monarch action: &quot; + action);</span>
<span class="nc" id="L682">                        csMonarchAction(player, action, cs);</span>
                    } else {
<span class="nc" id="L684">                        logger.finest(&quot;Skipping invalid monarch action: &quot;</span>
                            + action);
                    }
                }
            }

            // Flush accumulated changes.  Send to all players, but
            // take care that the new player is last so that it does
            // not immediately start moving and cause further changes
            // which conflict with these updates.  Finally return to the
            // current player which requested the end-of-turn, unless
            // it is doing a debug run.
<span class="nc bnc" id="L696" title="All 2 branches missed.">            boolean debugSkip = !player.isAI()</span>
<span class="nc bnc" id="L697" title="All 4 branches missed.">                &amp;&amp; freeColServer.getSinglePlayer()</span>
                &amp;&amp; debugOnlyAITurns &gt; 0;
<span class="nc bnc" id="L699" title="All 2 branches missed.">            if (debugSkip) {</span>
<span class="nc" id="L700">                game.sendToOthers(player, cs);</span>
<span class="nc" id="L701">                player.send(cs);</span>
<span class="nc" id="L702">                continue;</span>
            }
<span class="nc" id="L704">            game.sendToList(game.getConnectedPlayers(player, serverPlayer),</span>
                            cs);
<span class="nc bnc" id="L706" title="All 2 branches missed.">            if (player != serverPlayer) player.send(cs);</span>
<span class="nc" id="L707">            return cs.build(serverPlayer);</span>
        }
    }

    /**
     * Launch the REF.
     *
     * @param serverPlayer The REF &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param teleport If true, teleport the REF in.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csLaunchREF(ServerPlayer serverPlayer, boolean teleport,
                             ChangeSet cs) {
        // Set the REF player entry location from the rebels.  Note
        // that the REF units will have their own unit-specific entry
        // locations set by their missions.  This just flags that the
        // REF is initialized.
<span class="nc bnc" id="L724" title="All 2 branches missed.">        for (Player p : serverPlayer.getRebels()) {</span>
<span class="nc" id="L725">            serverPlayer.setEntryLocation(p.getEntryLocation().getTile());</span>
<span class="nc" id="L726">            break;</span>
        }

<span class="nc bnc" id="L729" title="All 2 branches missed.">        if (teleport) { // Teleport in the units.</span>
<span class="nc" id="L730">            Set&lt;Tile&gt; seen = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L731" title="All 2 branches missed.">            for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L732" title="All 2 branches missed.">                if (!u.isNaval()) continue;</span>
<span class="nc" id="L733">                Tile entry = u.getEntryLocation().getTile();</span>
<span class="nc" id="L734">                u.setLocation(entry);//-vis(serverPlayer)</span>
<span class="nc" id="L735">                u.setWorkLeft(-1);</span>
<span class="nc" id="L736">                u.setState(Unit.UnitState.ACTIVE);</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">                if (!seen.contains(entry)) {</span>
<span class="nc" id="L738">                    seen.add(entry);</span>
<span class="nc" id="L739">                    cs.add(See.only(serverPlayer),</span>
<span class="nc" id="L740">                           serverPlayer.exploreForUnit(u));</span>
<span class="nc" id="L741">                    cs.add(See.perhaps().except(serverPlayer), entry);</span>
                }
<span class="nc" id="L743">            }</span>
<span class="nc" id="L744">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L745">        } else {</span>
            // Put navy on the high seas, with 1-turn sail time
<span class="nc bnc" id="L747" title="All 2 branches missed.">            for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">                if (!u.isNaval()) continue;</span>
<span class="nc" id="L749">                u.setWorkLeft(1);</span>
<span class="nc" id="L750">                u.setDestination(u.getEntryLocation());</span>
<span class="nc" id="L751">                u.setLocation(u.getOwner().getHighSeas());//-vis: safe!map</span>
<span class="nc" id="L752">            }</span>
        }
<span class="nc" id="L754">    }</span>

    /**
     * Give independence.  Note that the REF player is granting, but
     * most of the changes happen to the newly independent player.
     * hence the special handling.
     *
     * @param serverPlayer The REF &lt;code&gt;ServerPlayer&lt;/code&gt; that is granting.
     * @param independent The newly independent &lt;code&gt;ServerPlayer&lt;/code&gt;.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csGiveIndependence(ServerPlayer serverPlayer,
                                    ServerPlayer independent, ChangeSet cs) {
<span class="nc" id="L767">        serverPlayer.csChangeStance(Stance.PEACE, independent, true, cs);</span>
<span class="nc" id="L768">        independent.changePlayerType(PlayerType.INDEPENDENT);</span>
<span class="nc" id="L769">        Game game = getGame();</span>
<span class="nc" id="L770">        Turn turn = game.getTurn();</span>
<span class="nc" id="L771">        independent.setTax(0);</span>
<span class="nc" id="L772">        independent.reinitialiseMarket();</span>
<span class="nc" id="L773">        HistoryEvent h = new HistoryEvent(turn,</span>
            HistoryEvent.HistoryEventType.INDEPENDENCE, independent);

        // The score for actual independence is actually a percentage
        // bonus depending on how many other nations are independent.
        // If we ever go for a more complex scoring algorithm it might
        // be better to replace the score int with a Modifier, but for
        // now we just set the score value to the number of
        // independent players other than the one we are granting
        // here, and generate the bonus with a special case in
        // ServerPlayer.updateScore().
<span class="nc" id="L784">        int n = 0;</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">        for (Player p : game.getLiveEuropeanPlayers(independent)) {</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">            if (p.getPlayerType() == PlayerType.INDEPENDENT) n++;</span>
<span class="nc" id="L787">        }</span>
<span class="nc" id="L788">        h.setScore(n);</span>
<span class="nc" id="L789">        cs.addGlobalHistory(game, h);</span>
<span class="nc" id="L790">        cs.addMessage(See.only(independent),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                &quot;giveIndependence.announce&quot;, independent)
<span class="nc" id="L793">            .addStringTemplate(&quot;%ref%&quot;, serverPlayer.getNationLabel()));</span>

        // Who surrenders?
<span class="nc" id="L796">        List&lt;Unit&gt; surrenderUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">        for (Unit u : serverPlayer.getUnits()) {</span>
<span class="nc bnc" id="L798" title="All 6 branches missed.">            if (u.hasTile() &amp;&amp; !u.isNaval() &amp;&amp; !u.isOnCarrier()</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">                &amp;&amp; serverPlayer.csChangeOwner(u, independent,</span>
                    ChangeType.CAPTURE, null, cs)) {//-vis(both)
<span class="nc" id="L801">                u.setMovesLeft(0);</span>
<span class="nc" id="L802">                u.setState(Unit.UnitState.ACTIVE);</span>
<span class="nc" id="L803">                cs.add(See.perhaps().always(serverPlayer), u.getTile());</span>
<span class="nc" id="L804">                surrenderUnits.add(u);</span>
            }
<span class="nc" id="L806">        }</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">        if (!surrenderUnits.isEmpty()) {</span>
<span class="nc" id="L808">            cs.addMessage(See.only(independent),</span>
                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                    &quot;giveIndependence.unitsAcquired&quot;, independent)
<span class="nc" id="L811">                .addStringTemplate(&quot;%units%&quot;,</span>
<span class="nc" id="L812">                    unitTemplate(&quot;, &quot;, surrenderUnits)));</span>
<span class="nc" id="L813">            independent.invalidateCanSeeTiles();//+vis(independent)</span>
<span class="nc" id="L814">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
        }

        // Update player type.  Again, a pity to have to do a whole
        // player update, but a partial update works for other players.
<span class="nc" id="L819">        cs.addPartial(See.all().except(independent), independent, &quot;playerType&quot;);</span>
<span class="nc" id="L820">        cs.addMessage(See.all().except(independent),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                &quot;giveIndependence.otherAnnounce&quot;, independent)
<span class="nc" id="L823">                .addStringTemplate(&quot;%nation%&quot;, independent.getNationLabel())</span>
<span class="nc" id="L824">                .addStringTemplate(&quot;%ref%&quot;, serverPlayer.getNationLabel()));</span>
<span class="nc" id="L825">        cs.add(See.only(independent), independent);</span>

        // Reveal the map on independence.
<span class="nc" id="L828">        cs.add(See.only(independent), independent.exploreMap(true));</span>
<span class="nc" id="L829">    }</span>

    private StringTemplate unitTemplate(String base, List&lt;Unit&gt; units) {
<span class="nc" id="L832">        StringTemplate template = StringTemplate.label(base);</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">        for (Unit u : units) {</span>
<span class="nc" id="L834">            template.addStringTemplate(u.getLabel(Unit.UnitLabelType.PLAIN));</span>
<span class="nc" id="L835">        }</span>
<span class="nc" id="L836">        return template;</span>
    }

    /**
     * Resolves a tax raise.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose tax is rising.
     * @param taxRaise The amount of tax raise.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; for a goods party.
     * @param result Whether the tax was accepted or not.
     */
    private void raiseTax(ServerPlayer serverPlayer, int taxRaise, Goods goods,
                          boolean result) {
<span class="nc" id="L849">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L850">        serverPlayer.csRaiseTax(taxRaise, goods, result, cs);</span>
<span class="nc" id="L851">        serverPlayer.send(cs);</span>
<span class="nc" id="L852">    }</span>

    /**
     * Performs a monarch action.
     *
     * Note that CHANGE_LATE is used so that these actions follow
     * setting the current player, so that it is the players turn when
     * they respond to a monarch action.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; being acted upon.
     * @param action The monarch action.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     */
    private void csMonarchAction(final ServerPlayer serverPlayer,
                                 MonarchAction action, ChangeSet cs) {
<span class="nc" id="L867">        final Monarch monarch = serverPlayer.getMonarch();</span>
<span class="nc" id="L868">        final Game game = getGame();</span>
<span class="nc" id="L869">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L870">        boolean valid = monarch.actionIsValid(action);</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (!valid) return;</span>
<span class="nc" id="L872">        String messageId = action.getTextKey();</span>
        StringTemplate template;
        MonarchActionMessage message;
<span class="nc" id="L875">        String monarchKey = serverPlayer.getMonarchKey();</span>

<span class="pc bnc" id="L877" title="All 11 branches missed.">        switch (action) {</span>
        case NO_ACTION:
<span class="nc" id="L879">            break;</span>
        case RAISE_TAX_WAR: case RAISE_TAX_ACT:
<span class="nc" id="L881">            final int taxRaise = monarch.raiseTax(random);</span>
<span class="nc" id="L882">            final Goods goods = serverPlayer.getMostValuableGoods();</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">            if (goods == null) {</span>
<span class="nc" id="L884">                logger.finest(&quot;Ignoring tax raise, no goods to boycott.&quot;);</span>
<span class="nc" id="L885">                break;</span>
            }
<span class="nc" id="L887">            template = StringTemplate.template(messageId)</span>
<span class="nc" id="L888">                .addStringTemplate(&quot;%goods%&quot;, goods.getType().getLabel())</span>
<span class="nc" id="L889">                .addAmount(&quot;%amount%&quot;, taxRaise);</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">            if (action == MonarchAction.RAISE_TAX_WAR) {</span>
<span class="nc" id="L891">                template = template.add(&quot;%nation%&quot;,</span>
<span class="nc" id="L892">                    Nation.getRandomNonPlayerNationNameKey(game, random));</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">            } else if (action == MonarchAction.RAISE_TAX_ACT) {</span>
<span class="nc" id="L894">                template = template.addAmount(&quot;%number%&quot;,</span>
<span class="nc" id="L895">                    randomInt(logger, &quot;Tax act goods&quot;, random, 6))</span>
<span class="nc" id="L896">                    .addName(&quot;%newWorld%&quot;, serverPlayer.getNewLandName());</span>
            }
<span class="nc" id="L898">            message = new MonarchActionMessage(action, template, monarchKey)</span>
<span class="nc" id="L899">                .setTax(taxRaise);</span>
<span class="nc" id="L900">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY,</span>
                   message);
<span class="nc" id="L902">            new MonarchSession(serverPlayer, action, taxRaise, goods);</span>
<span class="nc" id="L903">            break;</span>
        case LOWER_TAX_WAR: case LOWER_TAX_OTHER:
<span class="nc" id="L905">            int oldTax = serverPlayer.getTax();</span>
<span class="nc" id="L906">            int taxLower = monarch.lowerTax(random);</span>
<span class="nc" id="L907">            serverPlayer.csSetTax(taxLower, cs);</span>
<span class="nc" id="L908">            template = StringTemplate.template(messageId)</span>
<span class="nc" id="L909">                .addAmount(&quot;%difference%&quot;, oldTax - taxLower)</span>
<span class="nc" id="L910">                .addAmount(&quot;%newTax%&quot;, taxLower);</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">            if (action == MonarchAction.LOWER_TAX_WAR) {</span>
<span class="nc" id="L912">                template = template.add(&quot;%nation%&quot;,</span>
<span class="nc" id="L913">                    Nation.getRandomNonPlayerNationNameKey(game, random));</span>
            } else {
<span class="nc" id="L915">                template = template.addAmount(&quot;%number%&quot;,</span>
<span class="nc" id="L916">                    randomInt(logger, &quot;Lower tax reason&quot;, random, 5));</span>
            }
<span class="nc" id="L918">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new MonarchActionMessage(action, template, monarchKey));
<span class="nc" id="L920">            break;</span>
        case WAIVE_TAX:
<span class="nc" id="L922">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_NORMAL,</span>
                new MonarchActionMessage(action,
<span class="nc" id="L924">                    StringTemplate.template(messageId), monarchKey));</span>
<span class="nc" id="L925">            break;</span>
        case ADD_TO_REF:
<span class="nc" id="L927">            AbstractUnit refAdditions = monarch.chooseForREF(random);</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">            if (refAdditions == null) break;</span>
<span class="nc" id="L929">            monarch.getExpeditionaryForce().add(refAdditions);</span>
<span class="nc" id="L930">            template = StringTemplate.template(messageId)</span>
<span class="nc" id="L931">                .addAmount(&quot;%number%&quot;, refAdditions.getNumber())</span>
<span class="nc" id="L932">                .addNamed(&quot;%unit%&quot;, refAdditions.getType(spec));</span>
<span class="nc" id="L933">            cs.add(See.only(serverPlayer), monarch);</span>
<span class="nc" id="L934">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new MonarchActionMessage(action, template, monarchKey));
<span class="nc" id="L936">            break;</span>
        case DECLARE_PEACE:
<span class="nc" id="L938">            List&lt;Player&gt; friends = monarch.collectPotentialFriends();</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">            if (friends.isEmpty()) break;</span>
<span class="nc" id="L940">            Player friend = getRandomMember(logger, &quot;Choose friend&quot;,</span>
                                            friends, random);
<span class="nc" id="L942">            serverPlayer.csChangeStance(Stance.PEACE, (ServerPlayer)friend,</span>
                                        true, cs);
<span class="nc" id="L944">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new MonarchActionMessage(action, StringTemplate
<span class="nc" id="L946">                    .template(messageId)</span>
<span class="nc" id="L947">                    .addStringTemplate(&quot;%nation%&quot;, friend.getNationLabel()),</span>
                    monarchKey));
<span class="nc" id="L949">            break;</span>
        case DECLARE_WAR:
<span class="nc" id="L951">            List&lt;Player&gt; enemies = monarch.collectPotentialEnemies();</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">            if (enemies.isEmpty()) break;</span>
<span class="nc" id="L953">            Player enemy = getRandomMember(logger, &quot;Choose enemy&quot;,</span>
                                           enemies, random);
<span class="nc" id="L955">            List&lt;AbstractUnit&gt; warSupport </span>
<span class="nc" id="L956">                = monarch.getWarSupport(enemy, random);</span>
<span class="nc" id="L957">            int warGold = 0;</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">            if (!warSupport.isEmpty()) {</span>
<span class="nc" id="L959">                serverPlayer.createUnits(warSupport,</span>
<span class="nc" id="L960">                    serverPlayer.getEurope());//-vis: safe, Europe</span>
<span class="nc" id="L961">                warGold = spec.getInteger(GameOptions.WAR_SUPPORT_GOLD);</span>
<span class="nc" id="L962">                warGold += (warGold/10) * (randomInt(logger, &quot;War support gold&quot;,</span>
                                                     random, 5) - 2);
<span class="nc" id="L964">                serverPlayer.modifyGold(warGold);</span>
<span class="nc" id="L965">                cs.addPartial(See.only(serverPlayer), serverPlayer,</span>
                              &quot;gold&quot;, &quot;score&quot;);
<span class="nc" id="L967">                logger.fine(&quot;War support v &quot; + enemy.getNation().getSuffix()</span>
<span class="nc" id="L968">                    + &quot; &quot; + warGold + &quot; gold + &quot; + Messages.message(AbstractUnit</span>
<span class="nc" id="L969">                        .getListLabel(&quot;, &quot;, warSupport)));</span>
            }
<span class="nc" id="L971">            serverPlayer.csChangeStance(Stance.WAR, (ServerPlayer)enemy,</span>
                                        true, cs);
<span class="nc" id="L973">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new MonarchActionMessage(action, StringTemplate
<span class="nc bnc" id="L975" title="All 2 branches missed.">                    .template((warSupport.isEmpty()) ? messageId</span>
                        : &quot;model.monarch.action.declareWarSupported.text&quot;)
<span class="nc" id="L977">                        .addStringTemplate(&quot;%nation%&quot;, enemy.getNationLabel())</span>
<span class="nc" id="L978">                        .addStringTemplate(&quot;%force%&quot;,</span>
<span class="nc" id="L979">                            AbstractUnit.getListLabel(&quot;, &quot;, warSupport))</span>
<span class="nc" id="L980">                        .addAmount(&quot;%gold%&quot;, warGold),</span>
                    monarchKey));
<span class="nc" id="L982">            break;</span>
        case SUPPORT_LAND: case SUPPORT_SEA:
<span class="nc bnc" id="L984" title="All 2 branches missed.">            boolean sea = action == MonarchAction.SUPPORT_SEA;</span>
<span class="nc" id="L985">            List&lt;AbstractUnit&gt; support = monarch.getSupport(random, sea);</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">            if (support.isEmpty()) break;</span>
<span class="nc" id="L987">            serverPlayer.createUnits(support,</span>
<span class="nc" id="L988">                serverPlayer.getEurope());//-vis: safe, Europe</span>
<span class="nc" id="L989">            cs.add(See.only(serverPlayer), serverPlayer.getEurope());</span>
<span class="nc" id="L990">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new MonarchActionMessage(action, StringTemplate
<span class="nc" id="L992">                    .template(messageId)</span>
<span class="nc" id="L993">                    .addStringTemplate(&quot;%addition%&quot;,</span>
<span class="nc" id="L994">                        AbstractUnit.getListLabel(&quot;, &quot;, support)),</span>
                    monarchKey));
<span class="nc" id="L996">            break;</span>
        case MONARCH_MERCENARIES:
<span class="nc" id="L998">            final List&lt;AbstractUnit&gt; mercenaries</span>
<span class="nc" id="L999">                = monarch.getMercenaries(random);</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            if (mercenaries.isEmpty()) break;</span>
<span class="nc" id="L1001">            final int mercPrice = serverPlayer.priceMercenaries(mercenaries);</span>
<span class="nc" id="L1002">            message = new MonarchActionMessage(action, StringTemplate</span>
<span class="nc" id="L1003">                .template(messageId)</span>
<span class="nc" id="L1004">                .addAmount(&quot;%gold%&quot;, mercPrice)</span>
<span class="nc" id="L1005">                .addStringTemplate(&quot;%mercenaries%&quot;,</span>
<span class="nc" id="L1006">                    AbstractUnit.getListLabel(&quot;, &quot;, mercenaries)),</span>
                monarchKey);
<span class="nc" id="L1008">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY,</span>
                   message);
<span class="nc" id="L1010">            new MonarchSession(serverPlayer, action, mercenaries, mercPrice);</span>
<span class="nc" id="L1011">            break;</span>
        case HESSIAN_MERCENARIES:
<span class="nc" id="L1013">            final List&lt;AbstractUnit&gt; hessians</span>
<span class="nc" id="L1014">                = monarch.getMercenaries(random);</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">            if (hessians.isEmpty()) break;</span>
<span class="nc" id="L1016">            int n = NameCache.getMercenaryLeaderIndex(random);</span>
<span class="nc" id="L1017">            final int hessPrice = serverPlayer.priceMercenaries(hessians);</span>
<span class="nc" id="L1018">            message = new MonarchActionMessage(action, StringTemplate</span>
<span class="nc" id="L1019">                .template(messageId)</span>
<span class="nc" id="L1020">                .addName(&quot;%leader%&quot;, NameCache.getMercenaryLeaderName(n))</span>
<span class="nc" id="L1021">                .addAmount(&quot;%gold%&quot;, hessPrice)</span>
<span class="nc" id="L1022">                .addStringTemplate(&quot;%mercenaries%&quot;,</span>
<span class="nc" id="L1023">                    AbstractUnit.getListLabel(&quot;, &quot;, hessians)),</span>
                &quot;image.flavor.model.mercenaries.&quot; + n);
<span class="nc" id="L1025">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_EARLY,</span>
                   message);
<span class="nc" id="L1027">            new MonarchSession(serverPlayer, action, hessians, hessPrice);</span>
<span class="nc" id="L1028">            break;</span>
        case DISPLEASURE: default:
<span class="nc" id="L1030">            logger.warning(&quot;Bogus action: &quot; + action);</span>
            break;
        }
<span class="nc" id="L1033">    }</span>

    public Element monarchAction(ServerPlayer serverPlayer,
                                 MonarchAction action, boolean result) {
<span class="nc" id="L1037">        MonarchSession session = TransactionSession.lookup(MonarchSession.class,</span>
<span class="nc" id="L1038">            serverPlayer.getId(), &quot;&quot;);</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1040">            return DOMMessage.clientError(&quot;Bogus monarch action: &quot; + action);</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">        } else if (action != session.getAction()) {</span>
<span class="nc" id="L1042">            return DOMMessage.clientError(&quot;Session action mismatch, &quot;</span>
<span class="nc" id="L1043">                + session.getAction() + &quot; expected: &quot; + action);</span>
        }

<span class="nc" id="L1046">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1047">        session.complete(result, cs);</span>
<span class="nc" id="L1048">        return cs.build(serverPlayer);</span>
    }

    /**
     * Handle a player retiring.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is retiring.
     * @return An element cleaning up the player.
     */
    public Element retire(ServerPlayer serverPlayer) {
<span class="nc" id="L1058">        boolean highScore = HighScore.newHighScore(serverPlayer);</span>
<span class="nc" id="L1059">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1060">        serverPlayer.csWithdraw(cs); // Clean up the player.</span>
<span class="nc" id="L1061">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1062">        cs.addAttribute(See.only(serverPlayer),</span>
<span class="nc" id="L1063">                        &quot;highScore&quot;, Boolean.toString(highScore));</span>
<span class="nc" id="L1064">        return cs.build(serverPlayer);</span>
    }

    /**
     * Continue playing after winning.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that plays on.
     * @return Null.
     */
    public Element continuePlaying(ServerPlayer serverPlayer) {
<span class="nc" id="L1074">        final ServerGame game = getGame();</span>
<span class="nc" id="L1075">        Element reply = null;</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">        if (!getFreeColServer().getSinglePlayer()) {</span>
<span class="nc" id="L1077">            logger.warning(&quot;Can not continue playing in multiplayer!&quot;);</span>
<span class="nc bnc" id="L1078" title="All 2 branches missed.">        } else if (serverPlayer != game.checkForWinner()) {</span>
<span class="nc" id="L1079">            logger.warning(&quot;Can not continue playing, as &quot;</span>
<span class="nc" id="L1080">                           + serverPlayer.getName()</span>
                           + &quot; has not won the game!&quot;);
        } else {
<span class="nc" id="L1083">            final Specification spec = game.getSpecification();</span>
<span class="nc" id="L1084">            spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_REF)</span>
<span class="nc" id="L1085">                .setValue(Boolean.FALSE);</span>
<span class="nc" id="L1086">            spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_EUROPEANS)</span>
<span class="nc" id="L1087">                .setValue(Boolean.FALSE);</span>
<span class="nc" id="L1088">            spec.getBooleanOption(GameOptions.VICTORY_DEFEAT_HUMANS)</span>
<span class="nc" id="L1089">                .setValue(Boolean.FALSE);</span>
<span class="nc" id="L1090">            logger.info(&quot;Disabled victory conditions, as &quot;</span>
<span class="nc" id="L1091">                        + serverPlayer.getName()</span>
                        + &quot; has won, but is continuing to play.&quot;);
        }
<span class="nc" id="L1094">        return null;</span>
    }

    /**
     * Cash in a treasure train.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is cashing in.
     * @param unit The treasure train &lt;code&gt;Unit&lt;/code&gt; to cash in.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element cashInTreasureTrain(ServerPlayer serverPlayer, Unit unit) {
<span class="fc" id="L1105">        ChangeSet cs = new ChangeSet();</span>

        // Work out the cash in amount and the message to send.
<span class="fc" id="L1108">        int fullAmount = unit.getTreasureAmount();</span>
        int cashInAmount;
        String messageId;
<span class="pc bpc" id="L1111" title="1 of 2 branches missed.">        if (serverPlayer.getPlayerType() == PlayerType.COLONIAL) {</span>
            // Charge transport fee and apply tax
<span class="fc" id="L1113">            cashInAmount = (fullAmount - unit.getTransportFee())</span>
<span class="fc" id="L1114">                * (100 - serverPlayer.getTax()) / 100;</span>
<span class="fc" id="L1115">            messageId = &quot;cashInTreasureTrain.colonial&quot;;</span>
        } else {
            // No fee possible, no tax applies.
<span class="nc" id="L1118">            cashInAmount = fullAmount;</span>
<span class="nc" id="L1119">            messageId = &quot;cashInTreasureTrain.independent&quot;;</span>
        }

<span class="fc" id="L1122">        serverPlayer.modifyGold(cashInAmount);</span>
<span class="fc" id="L1123">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="fc" id="L1124">        cs.addMessage(See.only(serverPlayer),</span>
            new ModelMessage(messageId, serverPlayer, unit)
<span class="fc" id="L1126">                .addAmount(&quot;%amount%&quot;, fullAmount)</span>
<span class="fc" id="L1127">                .addAmount(&quot;%cashInAmount%&quot;, cashInAmount));</span>
<span class="pc bpc" id="L1128" title="1 of 2 branches missed.">        messageId = (serverPlayer.isRebel()</span>
<span class="pc bpc" id="L1129" title="1 of 2 branches missed.">                     || serverPlayer.getPlayerType() == PlayerType.INDEPENDENT)</span>
            ? &quot;cashInTreasureTrain.otherIndependent&quot;
            : &quot;cashInTreasureTrain.otherColonial&quot;;
<span class="fc" id="L1132">        cs.addMessage(See.all().except(serverPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                             messageId, serverPlayer)
<span class="fc" id="L1135">                .addAmount(&quot;%amount%&quot;, fullAmount)</span>
<span class="fc" id="L1136">                .addStringTemplate(&quot;%nation%&quot;, serverPlayer.getNationLabel()));</span>

        // Dispose of the unit, only visible to the owner.
<span class="fc" id="L1139">        cs.add(See.only(serverPlayer), (FreeColGameObject)unit.getLocation());</span>
<span class="fc" id="L1140">        cs.addRemove(See.only(serverPlayer), null, unit);//-vis: safe in colony</span>
<span class="fc" id="L1141">        unit.dispose();</span>

        // Others can see the cash in message.
<span class="fc" id="L1144">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1145">        return cs.build(serverPlayer);</span>
    }


    /**
     * Declare independence.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is declaring.
     * @param nationName The new name for the independent nation.
     * @param countryName The new name for its residents.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element declareIndependence(final ServerPlayer serverPlayer,
                                       String nationName, String countryName) {
<span class="nc" id="L1159">        final Game game = getGame();</span>
<span class="nc" id="L1160">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L1161">        ChangeSet cs = new ChangeSet();</span>

        // Cross the Rubicon
<span class="nc" id="L1164">        StringTemplate oldNation = serverPlayer.getNationLabel();</span>
<span class="nc" id="L1165">        serverPlayer.setIndependentNationName(nationName);</span>
<span class="nc" id="L1166">        serverPlayer.setNewLandName(countryName);</span>
<span class="nc" id="L1167">        serverPlayer.changePlayerType(PlayerType.REBEL);</span>

        // Do not add history event to cs as we are going to update the
        // entire player.  Likewise clear model messages.
<span class="nc" id="L1171">        Turn turn = game.getTurn();</span>
<span class="nc" id="L1172">        HistoryEvent h = new HistoryEvent(turn,</span>
            HistoryEvent.HistoryEventType.DECLARE_INDEPENDENCE, serverPlayer);
<span class="nc" id="L1174">        final int independenceTurn = spec.getInteger(GameOptions.INDEPENDENCE_TURN);</span>
<span class="nc" id="L1175">        h.setScore(Math.max(0, independenceTurn - turn.getNumber()));</span>
<span class="nc" id="L1176">        cs.addGlobalHistory(game, h);</span>
<span class="nc" id="L1177">        serverPlayer.clearModelMessages();</span>
<span class="nc" id="L1178">        cs.addMessage(See.only(serverPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                &quot;declareIndependence.resolution&quot;, serverPlayer));

        // Dispose of units in or heading to Europe.
<span class="nc" id="L1183">        Europe europe = serverPlayer.getEurope();</span>
<span class="nc" id="L1184">        StringTemplate seized = StringTemplate.label(&quot;, &quot;);</span>
<span class="nc" id="L1185">        boolean lost = false;</span>
<span class="nc bnc" id="L1186" title="All 2 branches missed.">        for (Unit u : europe.getUnitList()) {</span>
<span class="nc" id="L1187">            seized.addStringTemplate(u.getLabel());</span>
<span class="nc" id="L1188">            cs.addRemoves(See.only(serverPlayer), null, u.getDisposeList());</span>
<span class="nc" id="L1189">            u.dispose();</span>
<span class="nc" id="L1190">            lost = true;</span>
<span class="nc" id="L1191">        }</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">        for (Unit u : serverPlayer.getHighSeas().getUnitList()) {</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">            if (u.getDestination() == europe) {</span>
<span class="nc" id="L1194">                seized.addStringTemplate(u.getLabel());</span>
<span class="nc" id="L1195">                cs.addRemoves(See.only(serverPlayer), null, u.getDisposeList());</span>
<span class="nc" id="L1196">                u.dispose();</span>
<span class="nc" id="L1197">                lost = true;</span>
            }
<span class="nc" id="L1199">        }</span>
<span class="nc bnc" id="L1200" title="All 2 branches missed.">        if (lost) {</span>
<span class="nc" id="L1201">            cs.addMessage(See.only(serverPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.UNIT_LOST,
                                 &quot;declareIndependence.unitsSeized&quot;,
                                 serverPlayer)
<span class="nc" id="L1205">                    .addStringTemplate(&quot;%units%&quot;, seized));</span>
        }
<span class="nc" id="L1207">        serverPlayer.csLoseLocation(europe, cs);</span>

        // Create the REF.
<span class="nc" id="L1210">        ServerPlayer refPlayer = createREFPlayer(serverPlayer);</span>
<span class="nc" id="L1211">        cs.addPlayer(refPlayer);</span>
        // Update the intervention force
<span class="nc" id="L1213">        serverPlayer.getMonarch().updateInterventionForce();</span>
<span class="nc" id="L1214">        String otherKey = Nation.getRandomNonPlayerNationNameKey(game, random);</span>
<span class="nc" id="L1215">        cs.addMessage(See.only(serverPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                             &quot;declareIndependence.interventionForce&quot;,
                             serverPlayer)
<span class="nc" id="L1219">                .add(&quot;%nation%&quot;, otherKey)</span>
<span class="nc" id="L1220">                .addAmount(&quot;%number%&quot;,</span>
<span class="nc" id="L1221">                    spec.getInteger(GameOptions.INTERVENTION_BELLS)));</span>
<span class="nc" id="L1222">        serverPlayer.csChangeStance(Stance.WAR, refPlayer, true, cs);</span>

        // Now the REF is ready, we can dispose of the European connection.
<span class="nc" id="L1225">        cs.addRemove(See.only(serverPlayer), null, europe);//-vis: not on map</span>
<span class="nc" id="L1226">        europe.dispose();</span>
        // Do not clean up the Monarch, it contains the intervention force

        // Generalized continental army muster.
        // Do not use UnitType.getTargetType.
<span class="nc" id="L1231">        java.util.Map&lt;UnitType, UnitType&gt; upgrades = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">        for (UnitType unitType : spec.getUnitTypeList()) {</span>
<span class="nc" id="L1233">            UnitType upgrade = unitType.getTargetType(ChangeType.INDEPENDENCE,</span>
                                                      serverPlayer);
<span class="nc bnc" id="L1235" title="All 2 branches missed.">            if (upgrade != null) upgrades.put(unitType, upgrade);</span>
<span class="nc" id="L1236">        }</span>
<span class="nc" id="L1237">        java.util.Map&lt;UnitType, List&lt;Unit&gt;&gt; unitMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">        for (Colony colony : serverPlayer.getColonies()) {</span>
<span class="nc" id="L1239">            List&lt;Unit&gt; allUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1240">            allUnits.addAll(colony.getTile().getUnitList());</span>
<span class="nc" id="L1241">            allUnits.addAll(colony.getUnitList());</span>
<span class="nc" id="L1242">            int limit = (allUnits.size() + 2) * (colony.getSoL() - 50) / 100;</span>
<span class="nc bnc" id="L1243" title="All 2 branches missed.">            if (limit &lt;= 0) continue;</span>

<span class="nc" id="L1245">            unitMap.clear();</span>
<span class="nc bnc" id="L1246" title="All 2 branches missed.">            for (Unit unit : allUnits) {</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">                if (upgrades.containsKey(unit.getType())) {</span>
<span class="nc" id="L1248">                    List&lt;Unit&gt; unitList = unitMap.get(unit.getType());</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">                    if (unitList == null) {</span>
<span class="nc" id="L1250">                        unitList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1251">                        unitMap.put(unit.getType(), unitList);</span>
                    }
<span class="nc" id="L1253">                    unitList.add(unit);</span>
                }
<span class="nc" id="L1255">            }</span>
<span class="nc bnc" id="L1256" title="All 2 branches missed.">            for (Entry&lt;UnitType, List&lt;Unit&gt;&gt; entry : unitMap.entrySet()) {</span>
<span class="nc" id="L1257">                int n = 0;</span>
<span class="nc" id="L1258">                UnitType type = entry.getKey();</span>
<span class="nc" id="L1259">                List&lt;Unit&gt; units = entry.getValue();</span>
<span class="nc bnc" id="L1260" title="All 4 branches missed.">                while (!units.isEmpty() &amp;&amp; n &lt; limit) {</span>
<span class="nc" id="L1261">                    Unit unit = units.remove(0);</span>
<span class="nc" id="L1262">                    unit.changeType(upgrades.get(type));//-vis</span>
<span class="nc" id="L1263">                    cs.add(See.only(serverPlayer), unit);</span>
<span class="nc" id="L1264">                    n++;</span>
<span class="nc" id="L1265">                }</span>
<span class="nc" id="L1266">                cs.addMessage(See.only(serverPlayer),</span>
                    new ModelMessage(ModelMessage.MessageType.UNIT_IMPROVED,
                        &quot;declareIndependence.continentalArmyMuster&quot;,
                        serverPlayer, colony)
<span class="nc" id="L1270">                    .addName(&quot;%colony%&quot;, colony.getName())</span>
<span class="nc" id="L1271">                    .addAmount(&quot;%number%&quot;, n)</span>
<span class="nc" id="L1272">                    .addNamed(&quot;%oldUnit%&quot;, type)</span>
<span class="nc" id="L1273">                    .addNamed(&quot;%unit%&quot;, upgrades.get(type)));</span>
<span class="nc" id="L1274">                limit -= n;</span>
<span class="nc" id="L1275">            }</span>
<span class="nc" id="L1276">        }</span>

        // Most hostile contacted non-warring natives declare war on
        // you and peace with the REF, least hostile contacted natives
        // declare peace on you and war on the REF.  If they are the
        // same nation, go to the next most hostile nation that may
        // already be at war.
<span class="nc" id="L1283">        List&lt;Player&gt; natives = game.getLiveNativePlayers(null).stream()</span>
<span class="nc" id="L1284">            .filter(p -&gt; p.hasContacted(serverPlayer))</span>
<span class="nc" id="L1285">            .sorted(new Comparator&lt;Player&gt;() {</span>
                    public int compare(Player p1, Player p2) {
<span class="nc" id="L1287">                        return p1.getTension(serverPlayer).getValue()</span>
<span class="nc" id="L1288">                            - p2.getTension(serverPlayer).getValue();</span>
                    }
                })
<span class="nc" id="L1291">            .collect(Collectors.toList());</span>
<span class="nc bnc" id="L1292" title="All 2 branches missed.">        if (!natives.isEmpty()) {</span>
<span class="nc" id="L1293">            ServerPlayer good = (ServerPlayer)natives.get(0);</span>
<span class="nc" id="L1294">            logger.info(&quot;Native ally following independence: &quot; + good);</span>
<span class="nc" id="L1295">            cs.addMessage(See.only(serverPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                                 &quot;declareIndependence.nativeSupport&quot;, good)
<span class="nc" id="L1298">                    .addStringTemplate(&quot;%nation%&quot;, good.getNationLabel())</span>
<span class="nc" id="L1299">                    .add(&quot;%ruler%&quot;, serverPlayer.getRulerNameKey())</span>
                          );
            int delta;
<span class="pc bnc" id="L1302" title="All 3 branches missed.">            switch (good.getStance(serverPlayer)) {</span>
            case ALLIANCE: case PEACE: default:
<span class="nc" id="L1304">                delta = 0;</span>
<span class="nc" id="L1305">                break;</span>
            case CEASE_FIRE:
<span class="nc" id="L1307">                delta = Tension.Level.HAPPY.getLimit()</span>
<span class="nc" id="L1308">                    - good.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L1309">                break;</span>
            case WAR:
<span class="nc" id="L1311">                delta = Tension.Level.CONTENT.getLimit()</span>
<span class="nc" id="L1312">                    - good.getTension(serverPlayer).getValue();</span>
                break;
            }
<span class="nc" id="L1315">            good.csModifyTension(serverPlayer, delta, cs);</span>
<span class="nc" id="L1316">            Player.makeContact(good, refPlayer);</span>
<span class="nc" id="L1317">            good.csModifyTension(refPlayer,</span>
<span class="nc" id="L1318">                Tension.Level.HATEFUL.getLimit(), cs);</span>

<span class="nc" id="L1320">            reverse(natives);</span>
<span class="nc" id="L1321">            ServerPlayer bad = null;</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">            for (Player p : natives) {</span>
<span class="nc bnc" id="L1323" title="All 2 branches missed.">                if (p == good</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">                    || p.getStance(serverPlayer) == Stance.ALLIANCE) break;</span>
<span class="nc" id="L1325">                bad = (ServerPlayer)p;</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">                if (!p.atWarWith(serverPlayer)) break;</span>
<span class="nc" id="L1327">            }</span>
<span class="nc" id="L1328">            logger.info(&quot;Native enemy following independence: &quot; + bad);</span>
<span class="nc bnc" id="L1329" title="All 2 branches missed.">            if (bad != null) {</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">                switch (bad.getStance(serverPlayer)) {</span>
                case PEACE: case CEASE_FIRE:
<span class="nc" id="L1332">                    delta = Tension.Level.HATEFUL.getLimit()</span>
<span class="nc" id="L1333">                        - bad.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L1334">                    break;</span>
                case WAR: default:
<span class="nc" id="L1336">                    delta = 0;</span>
                    break;
                }
<span class="nc" id="L1339">                cs.addMessage(See.only(serverPlayer),</span>
                    new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                                     &quot;declareIndependence.nativeHostile&quot;, bad)
<span class="nc" id="L1342">                        .addStringTemplate(&quot;%nation%&quot;, bad.getNationLabel()));</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">                if (delta != 0) bad.csModifyTension(serverPlayer, delta, cs);</span>
<span class="nc" id="L1344">                Player.makeContact(bad, refPlayer);</span>
<span class="nc" id="L1345">                bad.csModifyTension(refPlayer,</span>
<span class="nc" id="L1346">                    -bad.getTension(refPlayer).getValue(), cs);</span>
            }
        }

        //
        // Pity to have to update such a heavy object as the player,
        // but we do this, at most, once per player.  Other players
        // only need a partial player update and the stance change.
        // Put the stance change after the name change so that the
        // other players see the new nation name declaring war.  The
        // REF is hardwired to declare war on rebels so there is no
        // need to adjust its stance or tension.
<span class="nc" id="L1358">        cs.addPartial(See.all().except(serverPlayer), serverPlayer,</span>
                      &quot;playerType&quot;, &quot;independentNationName&quot;, &quot;newLandName&quot;);
<span class="nc" id="L1360">        cs.addMessage(See.all().except(serverPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                             &quot;declareIndependence.announce&quot;,
                             serverPlayer)
<span class="nc" id="L1364">                .addStringTemplate(&quot;%oldNation%&quot;, oldNation)</span>
<span class="nc" id="L1365">                .addStringTemplate(&quot;%newNation%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L1366">                .add(&quot;%ruler%&quot;, serverPlayer.getRulerNameKey()));</span>
<span class="nc" id="L1367">        cs.add(See.only(serverPlayer), serverPlayer);</span>
<span class="nc" id="L1368">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

<span class="nc" id="L1370">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1371">        return cs.build(serverPlayer);</span>
    }

    /**
     * Rename an object.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is naming.
     * @param object The &lt;code&gt;Nameable&lt;/code&gt; to rename.
     * @param newName The new name.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element renameObject(ServerPlayer serverPlayer, Nameable object,
                                String newName) {
<span class="nc" id="L1384">        ChangeSet cs = new ChangeSet();</span>

<span class="nc bnc" id="L1386" title="All 2 branches missed.">        if (object instanceof Settlement) {</span>
<span class="nc" id="L1387">            ((Settlement)object).getTile().cacheUnseen();//+til</span>
        }
<span class="nc" id="L1389">        object.setName(newName);//-til?</span>
<span class="nc" id="L1390">        FreeColGameObject fcgo = (FreeColGameObject)object;</span>
<span class="nc" id="L1391">        cs.addPartial(See.all(), fcgo, &quot;name&quot;);</span>

        // Others may be able to see the name change.
<span class="nc" id="L1394">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1395">        return cs.build(serverPlayer);</span>
    }


    /**
     * Gets a settlement transaction session, either existing or
     * newly opened.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element getTransaction(ServerPlayer serverPlayer, Unit unit,
                                  Settlement settlement) {
<span class="nc" id="L1410">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1411">        TradeSession session = TransactionSession.lookup(TradeSession.class,</span>
            unit, settlement);
<span class="nc bnc" id="L1413" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L1414" title="All 2 branches missed.">            if (unit.getMovesLeft() &lt;= 0) {</span>
<span class="nc" id="L1415">                return DOMMessage.clientError(&quot;Unit &quot; + unit.getId()</span>
                    + &quot; has no moves left.&quot;);
            }
<span class="nc" id="L1418">            session = new TradeSession(unit, settlement);</span>
            // Sets unit moves to zero to avoid cheating.  If no
            // action is taken, the moves will be restored when
            // closing the session
<span class="nc" id="L1422">            unit.setMovesLeft(0);</span>
<span class="nc" id="L1423">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
        }

        // Add just the attributes the client needs.
<span class="nc" id="L1427">        cs.addAttribute(See.only(serverPlayer), &quot;canBuy&quot;,</span>
<span class="nc" id="L1428">            Boolean.toString(session.getBuy()));</span>
<span class="nc" id="L1429">        cs.addAttribute(See.only(serverPlayer), &quot;canSell&quot;,</span>
<span class="nc" id="L1430">            Boolean.toString(session.getSell()));</span>
<span class="nc" id="L1431">        cs.addAttribute(See.only(serverPlayer), &quot;canGift&quot;,</span>
<span class="nc" id="L1432">            Boolean.toString(session.getGift()));</span>

        // Others can not see transactions.
<span class="nc" id="L1435">        return cs.build(serverPlayer);</span>
    }


    /**
     * Close a transaction.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element closeTransaction(ServerPlayer serverPlayer, Unit unit,
                                    Settlement settlement) {
<span class="nc" id="L1449">        TradeSession session</span>
<span class="nc" id="L1450">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1451" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1452">            return DOMMessage.clientError(&quot;No such transaction session.&quot;);</span>
        }

<span class="nc" id="L1455">        ChangeSet cs = new ChangeSet();</span>
        // Restore unit movement if no action taken.
<span class="nc bnc" id="L1457" title="All 2 branches missed.">        if (!session.getActionTaken()) {</span>
<span class="nc" id="L1458">            unit.setMovesLeft(session.getMovesLeft());</span>
<span class="nc" id="L1459">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
        }
<span class="nc" id="L1461">        session.complete(cs);</span>

        // Others can not see end of transaction.
<span class="nc" id="L1464">        return cs.build(serverPlayer);</span>
    }


    /**
     * Get the goods for sale in a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is enquiring.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element getGoodsForSale(ServerPlayer serverPlayer, Unit unit,
                                   Settlement settlement) {
<span class="nc" id="L1478">        List&lt;Goods&gt; sellGoods = null;</span>

<span class="nc bnc" id="L1480" title="All 2 branches missed.">        if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1481">            IndianSettlement indianSettlement = (IndianSettlement) settlement;</span>
<span class="nc" id="L1482">            AIPlayer aiPlayer = getFreeColServer()</span>
<span class="nc" id="L1483">                .getAIPlayer(indianSettlement.getOwner());</span>
<span class="nc" id="L1484">            sellGoods = indianSettlement.getSellGoods(3, unit);</span>
<span class="nc bnc" id="L1485" title="All 2 branches missed.">            for (Goods goods : sellGoods) {</span>
<span class="nc" id="L1486">                aiPlayer.registerSellGoods(goods);</span>
<span class="nc" id="L1487">            }</span>
<span class="nc" id="L1488">        } else { // Colony might be supported one day?</span>
<span class="nc" id="L1489">            return DOMMessage.clientError(&quot;Bogus settlement&quot;);</span>
        }
<span class="nc" id="L1491">        return new GoodsForSaleMessage(unit, settlement, sellGoods)</span>
<span class="nc" id="L1492">            .toXMLElement();</span>
    }


    /**
     * Price some goods for sale from a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to buy.
     * @param price The buyers proposed price for the goods.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element buyProposition(ServerPlayer serverPlayer,
                                  Unit unit, Settlement settlement,
                                  Goods goods, int price) {
<span class="nc" id="L1509">        TradeSession session</span>
<span class="nc" id="L1510">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1512">            return DOMMessage.clientError(&quot;Proposing to buy without opening a transaction session?!&quot;);</span>
        }
<span class="nc bnc" id="L1514" title="All 2 branches missed.">        if (!session.getBuy()) {</span>
<span class="nc" id="L1515">            return DOMMessage.clientError(&quot;Proposing to buy in a session where buying is not allowed.&quot;);</span>
        }
<span class="nc" id="L1517">        ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L1518" title="All 2 branches missed.">        if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1519">            csVisit(serverPlayer, (IndianSettlement)settlement, 0, cs);</span>
        }

        // AI considers the proposition, return with a gold value
<span class="nc" id="L1523">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L1524">        int gold = ai.buyProposition(unit, settlement, goods, price);</span>

        // Others can not see proposals.
<span class="nc" id="L1527">        cs.addAttribute(See.only(serverPlayer),</span>
<span class="nc" id="L1528">                        &quot;gold&quot;, Integer.toString(gold));</span>
<span class="nc" id="L1529">        return cs.build(serverPlayer);</span>
    }

    /**
     * Price some goods for sale to a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; that is trading.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to sell.
     * @param price The sellers proposed price for the goods.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element sellProposition(ServerPlayer serverPlayer,
                                   Unit unit, Settlement settlement,
                                   Goods goods, int price) {
<span class="nc" id="L1545">        TradeSession session</span>
<span class="nc" id="L1546">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L1548">            return DOMMessage.clientError(&quot;Proposing to sell without opening a transaction session&quot;);</span>
        }
<span class="nc bnc" id="L1550" title="All 2 branches missed.">        if (!session.getSell()) {</span>
<span class="nc" id="L1551">            return DOMMessage.clientError(&quot;Proposing to sell in a session where selling is not allowed.&quot;);</span>
        }
<span class="nc" id="L1553">        ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L1554" title="All 2 branches missed.">        if (settlement instanceof IndianSettlement) {</span>
<span class="nc" id="L1555">            csVisit(serverPlayer, (IndianSettlement)settlement, 0, cs);</span>
        }

        // AI considers the proposition, return with a gold value
<span class="nc" id="L1559">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L1560">        int gold = ai.sellProposition(unit, settlement, goods, price);</span>

        // Others can not see proposals.
<span class="nc" id="L1563">        cs.addAttribute(See.only(serverPlayer),</span>
<span class="nc" id="L1564">                        &quot;gold&quot;, Integer.toString(gold));</span>
<span class="nc" id="L1565">        return cs.build(serverPlayer);</span>
    }

    /**
     * Buy goods in Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to buy.
     * @param amount The amount of goods to buy.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to carry the goods.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element buyGoods(ServerPlayer serverPlayer, GoodsType type,
                            int amount, Unit carrier) {
<span class="fc bfc" id="L1579" title="All 2 branches covered.">        if (!serverPlayer.canTrade(type, Access.EUROPE)) {</span>
<span class="fc" id="L1580">            return DOMMessage.clientError(&quot;Can not trade boycotted goods&quot;);</span>
        }

<span class="fc" id="L1583">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1584">        GoodsContainer container = carrier.getGoodsContainer();</span>
<span class="fc" id="L1585">        container.saveState();</span>
<span class="fc" id="L1586">        int gold = serverPlayer.getGold();</span>
<span class="fc" id="L1587">        int buyAmount = serverPlayer.buy(container, type, amount);</span>
<span class="fc bfc" id="L1588" title="All 2 branches covered.">        if (buyAmount &lt; 0) {</span>
<span class="fc" id="L1589">            return DOMMessage.clientError(&quot;Player &quot; + serverPlayer.getName()</span>
<span class="fc" id="L1590">                + &quot; tried to buy &quot; + amount + &quot; &quot; + type.getSuffix());</span>
        }
<span class="fc" id="L1592">        serverPlayer.propagateToEuropeanMarkets(type, -buyAmount, random);</span>
<span class="fc" id="L1593">        serverPlayer.csFlushMarket(type, cs);</span>
<span class="fc" id="L1594">        carrier.setMovesLeft(0);</span>
<span class="fc" id="L1595">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L1596">        cs.add(See.only(serverPlayer), carrier);</span>
<span class="fc" id="L1597">        logger.finest(carrier + &quot; bought &quot; + amount + &quot;(&quot; + buyAmount + &quot;)&quot;</span>
<span class="fc" id="L1598">            + &quot; &quot; + type.getSuffix()</span>
<span class="fc" id="L1599">            + &quot; in Europe for &quot; + (serverPlayer.getGold() - gold));</span>
        // Action occurs in Europe, nothing is visible to other players.
<span class="fc" id="L1601">        return cs.build(serverPlayer);</span>
    }

    /**
     * Sell goods in Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is selling.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to sell.
     * @param amount The amount of goods to sell.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element sellGoods(ServerPlayer serverPlayer, GoodsType type,
                             int amount, Unit carrier) {

<span class="fc" id="L1616">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1617">        GoodsContainer container = carrier.getGoodsContainer();</span>
<span class="fc" id="L1618">        container.saveState();</span>
<span class="fc bfc" id="L1619" title="All 2 branches covered.">        if (serverPlayer.canTrade(type, Access.EUROPE)) {</span>
<span class="fc" id="L1620">            int gold = serverPlayer.getGold();</span>
<span class="fc" id="L1621">            int sellAmount = serverPlayer.sell(container, type, amount);</span>
<span class="pc bpc" id="L1622" title="1 of 2 branches missed.">            if (sellAmount &lt; 0) {</span>
<span class="nc" id="L1623">                return DOMMessage.clientError(&quot;Player &quot; + serverPlayer.getName()</span>
<span class="nc" id="L1624">                    + &quot; tried to sell &quot; + amount + &quot; &quot; + type.getSuffix());</span>
            }
<span class="fc" id="L1626">            serverPlayer.propagateToEuropeanMarkets(type, sellAmount, random);</span>
<span class="fc" id="L1627">            serverPlayer.csFlushMarket(type, cs);</span>
<span class="fc" id="L1628">            cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="fc" id="L1629">            logger.finest(carrier + &quot; sold &quot; + amount + &quot;(&quot; + sellAmount + &quot;)&quot;</span>
<span class="fc" id="L1630">                + &quot; &quot; + type.getSuffix()</span>
<span class="fc" id="L1631">                + &quot; in Europe for &quot; + (serverPlayer.getGold() - gold));</span>
<span class="fc" id="L1632">        } else {</span>
            // Dumping goods in Europe
<span class="fc" id="L1634">            moveGoods(carrier, type, amount, null);</span>
<span class="fc" id="L1635">            logger.finest(carrier + &quot; dumped &quot; + amount</span>
<span class="fc" id="L1636">                + &quot; &quot; + type.getSuffix() + &quot; in Europe&quot;);</span>
        }
<span class="fc" id="L1638">        carrier.setMovesLeft(0);</span>
<span class="fc" id="L1639">        cs.add(See.only(serverPlayer), carrier);</span>
        // Action occurs in Europe, nothing is visible to other players.
<span class="fc" id="L1641">        return cs.build(serverPlayer);</span>
    }


    /**
     * A unit migrates from Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose unit it will be.
     * @param slot The slot within &lt;code&gt;Europe&lt;/code&gt; to select the unit from.
     * @param type The type of migration occurring.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element emigrate(ServerPlayer serverPlayer, int slot,
                            MigrationType type) {
<span class="nc" id="L1655">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1656">        serverPlayer.csEmigrate(slot, type, random, cs);</span>

        // Do not update others, emigration is private.
<span class="nc" id="L1659">        return cs.build(serverPlayer);</span>
    }


    /**
     * Move a unit.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is moving.
     * @param unit The &lt;code&gt;ServerUnit&lt;/code&gt; to move.
     * @param newTile The &lt;code&gt;Tile&lt;/code&gt; to move to.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element move(ServerPlayer serverPlayer, ServerUnit unit,
                        Tile newTile) {
<span class="fc" id="L1673">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1674">        unit.csMove(newTile, random, cs);</span>
<span class="fc" id="L1675">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1676">        return cs.build(serverPlayer);</span>
    }

    /**
     * Decline to investigate strange mounds.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; where the mounds are.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element declineMounds(ServerPlayer serverPlayer, Tile tile) {
<span class="nc" id="L1687">        tile.cacheUnseen();//+til</span>
<span class="nc" id="L1688">        tile.removeLostCityRumour();//-til</span>

        // Others might see rumour disappear
<span class="nc" id="L1691">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1692">        cs.add(See.perhaps(), tile);</span>
<span class="nc" id="L1693">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1694">        return cs.build(serverPlayer);</span>
    }

    /**
     * Set land name.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; who landed.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that has come ashore.
     * @param name The new land name.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element setNewLandName(ServerPlayer serverPlayer, Unit unit,
                                  String name) {
<span class="nc" id="L1707">        ChangeSet cs = new ChangeSet();</span>

        // Special case of a welcome from an adjacent native unit,
        // offering the land the landing unit is on if a peace treaty
        // is accepted.
<span class="nc" id="L1712">        serverPlayer.setNewLandName(name);</span>

        // Update the name and note the history.
<span class="nc" id="L1715">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;newLandName&quot;);</span>
<span class="nc" id="L1716">        Turn turn = serverPlayer.getGame().getTurn();</span>
<span class="nc" id="L1717">        HistoryEvent h = new HistoryEvent(turn,</span>
            HistoryEvent.HistoryEventType.DISCOVER_NEW_WORLD, serverPlayer)
<span class="nc" id="L1719">                .addName(&quot;%name%&quot;, name);</span>
<span class="nc" id="L1720">        cs.addHistory(serverPlayer, h);</span>

<span class="nc" id="L1722">        return cs.build(serverPlayer);</span>
    }

    /**
     * Set region name.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; discovering.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is discovering.
     * @param region The &lt;code&gt;Region&lt;/code&gt; to discover.
     * @param name The new region name.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element setNewRegionName(ServerPlayer serverPlayer, Unit unit,
                                    Region region, String name) {
<span class="nc" id="L1736">        final Game game = getGame();</span>
<span class="nc" id="L1737">        ServerRegion serverRegion = (ServerRegion)region;</span>
        // Discoverer is set when unit moves in.
<span class="nc bnc" id="L1739" title="All 2 branches missed.">        if (!Utils.equals(region.getDiscoverer(), unit.getId())) {</span>
<span class="nc" id="L1740">            return DOMMessage.clientError(&quot;Discoverer mismatch, &quot;</span>
<span class="nc" id="L1741">                + region.getDiscoverer() + &quot; expected, &quot;</span>
<span class="nc" id="L1742">                + unit.getId() + &quot; provided.&quot;);</span>
        }
<span class="nc" id="L1744">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1745">        serverRegion.csDiscover(serverPlayer, game.getTurn(), name, cs);</span>

        // Others do find out about region name changes.
<span class="nc" id="L1748">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1749">        return cs.build(serverPlayer);</span>
    }

    /**
     * Move a unit across the high seas.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to move.
     * @param destination The &lt;code&gt;Location&lt;/code&gt; to move to.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element moveTo(ServerPlayer serverPlayer, Unit unit,
                          Location destination) {
<span class="fc" id="L1762">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1763">        HighSeas highSeas = serverPlayer.getHighSeas();</span>
<span class="fc" id="L1764">        Location current = unit.getDestination();</span>
<span class="fc" id="L1765">        boolean others = false; // Notify others?</span>
<span class="fc" id="L1766">        boolean invalid = false; // Not a highSeas move?</span>

<span class="pc bpc" id="L1768" title="1 of 2 branches missed.">        if (!unit.getType().canMoveToHighSeas()) {</span>
<span class="nc" id="L1769">            invalid = true;</span>
<span class="fc bfc" id="L1770" title="All 2 branches covered.">        } else if (destination instanceof Europe) {</span>
<span class="pc bpc" id="L1771" title="1 of 2 branches missed.">            if (!highSeas.getDestinations().contains(destination)) {</span>
<span class="nc" id="L1772">                return DOMMessage.clientError(&quot;HighSeas does not connect to: &quot;</span>
<span class="nc" id="L1773">                    + destination.getId());</span>
<span class="pc bpc" id="L1774" title="1 of 2 branches missed.">            } else if (unit.getLocation() == highSeas) {</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">                if (!(current instanceof Europe)) {</span>
                    // Changed direction
<span class="nc" id="L1777">                    unit.setWorkLeft(unit.getSailTurns()</span>
<span class="nc" id="L1778">                        - unit.getWorkLeft() + 1);</span>
                }
<span class="nc" id="L1780">                unit.setDestination(destination);</span>
<span class="nc" id="L1781">                cs.add(See.only(serverPlayer), unit, highSeas);</span>
<span class="pc bpc" id="L1782" title="1 of 2 branches missed.">            } else if (unit.hasTile()) {</span>
<span class="fc" id="L1783">                Tile tile = unit.getTile();</span>
<span class="fc" id="L1784">                unit.setEntryLocation(tile);</span>
<span class="fc" id="L1785">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="fc" id="L1786">                unit.setDestination(destination);</span>
<span class="fc" id="L1787">                unit.setMovesLeft(0);</span>
<span class="fc" id="L1788">                unit.setLocation(highSeas);//-vis(serverPlayer)</span>
<span class="fc" id="L1789">                serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="fc" id="L1790">                cs.addDisappear(serverPlayer, tile, unit);</span>
<span class="fc" id="L1791">                cs.add(See.only(serverPlayer), tile, highSeas);</span>
<span class="fc" id="L1792">                others = true;</span>
<span class="fc" id="L1793">            } else {</span>
<span class="nc" id="L1794">                invalid = true;</span>
            }
<span class="pc bpc" id="L1796" title="1 of 2 branches missed.">        } else if (destination instanceof Map) {</span>
<span class="pc bpc" id="L1797" title="1 of 2 branches missed.">            if (!highSeas.getDestinations().contains(destination)) {</span>
<span class="nc" id="L1798">                return DOMMessage.clientError(&quot;HighSeas does not connect to: &quot;</span>
<span class="nc" id="L1799">                    + destination.getId());</span>
<span class="pc bpc" id="L1800" title="1 of 2 branches missed.">            } else if (unit.getLocation() == highSeas) {</span>
<span class="nc bnc" id="L1801" title="All 4 branches missed.">                if (current != destination &amp;&amp; (current == null</span>
<span class="nc bnc" id="L1802" title="All 2 branches missed.">                        || current.getTile() == null</span>
<span class="nc bnc" id="L1803" title="All 2 branches missed.">                        || current.getTile().getMap() != destination)) {</span>
                    // Changed direction
<span class="nc" id="L1805">                    unit.setWorkLeft(unit.getSailTurns()</span>
<span class="nc" id="L1806">                        - unit.getWorkLeft() + 1);</span>
                }
<span class="nc" id="L1808">                unit.setDestination(destination);</span>
<span class="nc" id="L1809">                cs.add(See.only(serverPlayer), highSeas);</span>
<span class="pc bpc" id="L1810" title="1 of 2 branches missed.">            } else if (unit.getLocation() instanceof Europe) {</span>
<span class="fc" id="L1811">                Europe europe = (Europe) unit.getLocation();</span>
<span class="fc" id="L1812">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="fc" id="L1813">                unit.setDestination(destination);</span>
<span class="fc" id="L1814">                unit.setMovesLeft(0);</span>
<span class="fc" id="L1815">                unit.setLocation(highSeas);//-vis: safe!map</span>
<span class="fc" id="L1816">                cs.add(See.only(serverPlayer), europe, highSeas);</span>
<span class="fc" id="L1817">            } else {</span>
<span class="nc" id="L1818">                invalid = true;</span>
            }
<span class="nc bnc" id="L1820" title="All 2 branches missed.">        } else if (destination instanceof Settlement) {</span>
<span class="nc" id="L1821">            Tile tile = destination.getTile();</span>
<span class="nc bnc" id="L1822" title="All 2 branches missed.">            if (!highSeas.getDestinations().contains(tile.getMap())) {</span>
<span class="nc" id="L1823">                return DOMMessage.clientError(&quot;HighSeas does not connect to: &quot;</span>
<span class="nc" id="L1824">                    + destination.getId());</span>
<span class="nc bnc" id="L1825" title="All 2 branches missed.">            } else if (unit.getLocation() == highSeas) {</span>
                // Direction is somewhat moot, so just reset.
<span class="nc" id="L1827">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="nc" id="L1828">                unit.setDestination(destination);</span>
<span class="nc" id="L1829">                cs.add(See.only(serverPlayer), highSeas);</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">            } else if (unit.getLocation() instanceof Europe) {</span>
<span class="nc" id="L1831">                Europe europe = (Europe) unit.getLocation();</span>
<span class="nc" id="L1832">                unit.setWorkLeft(unit.getSailTurns());</span>
<span class="nc" id="L1833">                unit.setDestination(destination);</span>
<span class="nc" id="L1834">                unit.setMovesLeft(0);</span>
<span class="nc" id="L1835">                unit.setLocation(highSeas);//-vis: safe!map</span>
<span class="nc" id="L1836">                cs.add(See.only(serverPlayer), europe, highSeas);</span>
<span class="nc" id="L1837">            } else {</span>
<span class="nc" id="L1838">                invalid = true;</span>
            }
<span class="nc" id="L1840">        } else {</span>
<span class="nc" id="L1841">            return DOMMessage.clientError(&quot;Bogus moveTo destination: &quot;</span>
<span class="nc" id="L1842">                + destination.getId());</span>
        }
<span class="pc bpc" id="L1844" title="1 of 2 branches missed.">        if (invalid) {</span>
<span class="nc" id="L1845">            return DOMMessage.clientError(&quot;Invalid moveTo: unit=&quot; + unit.getId()</span>
<span class="nc" id="L1846">                + &quot; from=&quot; + unit.getLocation().getId()</span>
<span class="nc" id="L1847">                + &quot; to=&quot; + destination.getId());</span>
        }

<span class="fc bfc" id="L1850" title="All 2 branches covered.">        if (others) getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1851">        return cs.build(serverPlayer);</span>
    }

    /**
     * Embark a unit onto a carrier.
     * Checking that the locations are appropriate is not done here.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; embarking.
     * @param serverUnit The &lt;code&gt;ServerUnit&lt;/code&gt; that is embarking.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to embark onto.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element embarkUnit(ServerPlayer serverPlayer, ServerUnit serverUnit,
                              Unit carrier) {
<span class="fc bfc" id="L1865" title="All 2 branches covered.">        if (serverUnit.isNaval()) {</span>
<span class="fc" id="L1866">            return DOMMessage.clientError(&quot;Naval unit &quot; + serverUnit.getId()</span>
                + &quot; can not embark.&quot;);
        }
<span class="fc" id="L1869">        UnitLocation.NoAddReason reason = carrier.getNoAddReason(serverUnit);</span>
<span class="fc bfc" id="L1870" title="All 2 branches covered.">        if (reason != UnitLocation.NoAddReason.NONE) {</span>
<span class="fc" id="L1871">            return DOMMessage.clientError(&quot;Carrier: &quot; + carrier.getId()</span>
<span class="fc" id="L1872">                + &quot; can not carry &quot; + serverUnit.getId() + &quot;: &quot; + reason);</span>
        }

<span class="fc" id="L1875">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L1876">        serverUnit.csEmbark(carrier, cs);</span>

        // Others might see the unit disappear, or the carrier capacity.
<span class="fc" id="L1879">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L1880">        return cs.build(serverPlayer);</span>
    }

    /**
     * Disembark unit from a carrier.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; whose unit is
     *                     embarking.
     * @param serverUnit The &lt;code&gt;ServerUnit&lt;/code&gt; that is disembarking.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element disembarkUnit(ServerPlayer serverPlayer,
                                 ServerUnit serverUnit) {
<span class="nc bnc" id="L1893" title="All 2 branches missed.">        if (serverUnit.isNaval()) {</span>
<span class="nc" id="L1894">            return DOMMessage.clientError(&quot;Naval unit &quot; + serverUnit.getId()</span>
                + &quot; can not disembark.&quot;);
        }
<span class="nc" id="L1897">        Unit carrier = serverUnit.getCarrier();</span>
<span class="nc bnc" id="L1898" title="All 2 branches missed.">        if (carrier == null) {</span>
<span class="nc" id="L1899">            return DOMMessage.clientError(&quot;Unit &quot; + serverUnit.getId()</span>
                + &quot; is not embarked.&quot;);
        }

<span class="nc" id="L1903">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L1905">        Location newLocation = carrier.getLocation();</span>
<span class="nc bnc" id="L1906" title="All 2 branches missed.">        List&lt;Tile&gt; newTiles = (newLocation.getTile() == null) ? null</span>
<span class="nc" id="L1907">            : serverUnit.collectNewTiles(newLocation.getTile());</span>
<span class="nc" id="L1908">        serverUnit.setLocation(newLocation);//-vis(serverPlayer)</span>
<span class="nc" id="L1909">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L1910">        serverUnit.setMovesLeft(0); // In Col1 disembark consumes whole move.</span>
<span class="nc" id="L1911">        cs.add(See.perhaps(), (FreeColGameObject)newLocation);</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">        if (newTiles != null) {</span>
<span class="nc" id="L1913">            serverPlayer.csSeeNewTiles(newTiles, cs);</span>
        }

        // Others can (potentially) see the location.
<span class="nc" id="L1917">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L1918">        return cs.build(serverPlayer);</span>
    }


    /**
     * Combat.  Public for the test suite.
     *
     * @param attackerPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; who is attacking.
     * @param attacker The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is attacking.
     * @param defender The &lt;code&gt;FreeColGameObject&lt;/code&gt; that is defending.
     * @param crs A list of &lt;code&gt;CombatResult&lt;/code&gt;s defining the result.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element combat(ServerPlayer attackerPlayer,
                          FreeColGameObject attacker,
                          FreeColGameObject defender,
                          List&lt;CombatResult&gt; crs) {
<span class="fc" id="L1935">        ChangeSet cs = new ChangeSet();</span>
        try {
<span class="fc" id="L1937">            attackerPlayer.csCombat(attacker, defender, crs, random, cs);</span>
<span class="nc" id="L1938">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L1939">            logger.log(Level.WARNING, &quot;Combat FAIL&quot;, e);</span>
<span class="nc" id="L1940">            return DOMMessage.clientError(e.getMessage());</span>
<span class="fc" id="L1941">        }</span>
<span class="fc" id="L1942">        getGame().sendToOthers(attackerPlayer, cs);</span>
<span class="fc" id="L1943">        return cs.build(attackerPlayer);</span>
    }

    /**
     * Ask about learning a skill at an IndianSettlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is learning.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is learning.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to learn from.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element askLearnSkill(ServerPlayer serverPlayer, Unit unit,
                                 IndianSettlement settlement) {
<span class="nc" id="L1956">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L1958">        csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="nc" id="L1959">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L1960">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L1961">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L1962">        unit.setMovesLeft(0);</span>
<span class="nc" id="L1963">        cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>

        // Do not update others, nothing to see yet.
<span class="nc" id="L1966">        return cs.build(serverPlayer);</span>
    }

    /**
     * Learn a skill at an IndianSettlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is learning.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is learning.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to learn from.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element learnFromIndianSettlement(ServerPlayer serverPlayer,
                                             Unit unit,
                                             IndianSettlement settlement) {
        // Sanity checks.
<span class="nc" id="L1981">        UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc bnc" id="L1982" title="All 2 branches missed.">        if (skill == null) {</span>
<span class="nc" id="L1983">            return DOMMessage.clientError(&quot;No skill to learn at &quot;</span>
<span class="nc" id="L1984">                + settlement.getName());</span>
        }
<span class="nc bnc" id="L1986" title="All 2 branches missed.">        if (!unit.getType().canBeUpgraded(skill, ChangeType.NATIVES)) {</span>
<span class="nc" id="L1987">            return DOMMessage.clientError(&quot;Unit &quot; + unit</span>
                + &quot; can not learn skill &quot; + skill
<span class="nc" id="L1989">                + &quot; at &quot; + settlement.getName());</span>
        }

        // Try to learn
<span class="nc" id="L1993">        final Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L1994">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L1995">        unit.setMovesLeft(0);</span>
<span class="nc" id="L1996">        csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="pc bnc" id="L1997" title="All 3 branches missed.">        switch (settlement.getAlarm(serverPlayer).getLevel()) {</span>
        case HATEFUL: // Killed, might be visible to other players.
<span class="nc" id="L1999">            cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2000">                   (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L2001">            cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2002">                         unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L2003">            unit.dispose();</span>
<span class="nc" id="L2004">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L2005">            break;</span>
        case ANGRY: // Learn nothing, not even a pet update
<span class="nc" id="L2007">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc" id="L2008">            break;</span>
        default:
            // Teach the unit, and expend the skill if necessary.
            // Do a full information update as the unit is in the settlement.
<span class="nc" id="L2012">            unit.changeType(skill);//-vis(serverPlayer)</span>
<span class="nc" id="L2013">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L2014">            cs.add(See.perhaps(), unit);</span>
<span class="nc bnc" id="L2015" title="All 2 branches missed.">            if (!settlement.isCapital()</span>
<span class="nc bnc" id="L2016" title="All 2 branches missed.">                &amp;&amp; !(settlement.hasMissionary(serverPlayer)</span>
<span class="nc bnc" id="L2017" title="All 2 branches missed.">                    &amp;&amp; spec.getBoolean(GameOptions.ENHANCED_MISSIONARIES))) {</span>
<span class="nc" id="L2018">                settlement.setLearnableSkill(null);</span>
            }
            break;
        }
<span class="nc" id="L2022">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2023">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2024">        cs.add(See.only(serverPlayer), tile);</span>

        // Others always see the unit, it may have died or been taught.
<span class="nc" id="L2027">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2028">        return cs.build(serverPlayer);</span>
    }


    /**
     * Demand a tribute from a native settlement.
     *
     * FIXME: Move TURNS_PER_TRIBUTE magic number to the spec.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; demanding the tribute.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is demanding the tribute.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; demanded of.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element demandTribute(ServerPlayer serverPlayer, Unit unit,
                                 ServerIndianSettlement settlement) {
<span class="nc" id="L2044">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2045">        final int TURNS_PER_TRIBUTE = 5;</span>

<span class="nc" id="L2047">        csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L2049">        Player indianPlayer = settlement.getOwner();</span>
<span class="nc" id="L2050">        int gold = 0;</span>
<span class="nc" id="L2051">        int year = getGame().getTurn().getNumber();</span>
<span class="nc" id="L2052">        RandomRange gifts = settlement.getType().getGifts(unit);</span>
<span class="nc bnc" id="L2053" title="All 4 branches missed.">        if (settlement.getLastTribute() + TURNS_PER_TRIBUTE &lt; year</span>
            &amp;&amp; gifts != null) {
<span class="nc bnc" id="L2055" title="All 3 branches missed.">            switch (indianPlayer.getTension(serverPlayer).getLevel()) {</span>
            case HAPPY: case CONTENT:
<span class="nc" id="L2057">                gold = Math.min(gifts.getAmount(&quot;Tribute&quot;, random, true) / 10,</span>
                                100);
<span class="nc" id="L2059">                break;</span>
            case DISPLEASED:
<span class="nc" id="L2061">                gold = Math.min(gifts.getAmount(&quot;Tribute&quot;, random, true) / 20,</span>
                                100);
<span class="nc" id="L2063">                break;</span>
            case ANGRY: case HATEFUL:
            default:
<span class="nc" id="L2066">                gold = 0; // No tribute for you.</span>
                break;
            }
        }

        // Increase tension whether we paid or not.  Apply tension
        // directly to the settlement and let propagation work.
<span class="nc" id="L2073">        settlement.csModifyAlarm(serverPlayer, Tension.TENSION_ADD_NORMAL,</span>
                                 true, cs);
<span class="nc" id="L2075">        settlement.setLastTribute(year);</span>
        ModelMessage m;
<span class="nc bnc" id="L2077" title="All 2 branches missed.">        if (gold &gt; 0) {</span>
<span class="nc" id="L2078">            indianPlayer.modifyGold(-gold);</span>
<span class="nc" id="L2079">            serverPlayer.modifyGold(gold);</span>
<span class="nc" id="L2080">            cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L2081">            m = new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
                                 &quot;scoutSettlement.tributeAgree&quot;,
                                 unit, settlement)
<span class="nc" id="L2084">                .addAmount(&quot;%amount%&quot;, gold);</span>
        } else {
<span class="nc" id="L2086">            m = new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,</span>
                                 &quot;scoutSettlement.tributeDisagree&quot;,
                                 unit, settlement);
        }
<span class="nc" id="L2090">        cs.addMessage(See.only(serverPlayer), m);</span>
<span class="nc" id="L2091">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2092">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2093">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2094">        unit.setMovesLeft(0);</span>
<span class="nc" id="L2095">        cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>

        // Do not update others, this is all private.
<span class="nc" id="L2098">        return cs.build(serverPlayer);</span>
    }

    /**
     * Scout a native settlement, that is, the contacting action
     * that generates the greeting dialog.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is scouting.
     * @param unit The scout &lt;code&gt;Unit&lt;/code&gt;.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; to scout.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element scoutIndianSettlement(ServerPlayer serverPlayer,
                                         Unit unit,
                                         IndianSettlement settlement) {
<span class="nc" id="L2113">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2114">        Tile tile = settlement.getTile();</span>

<span class="nc" id="L2116">        csVisit(serverPlayer, settlement, -1, cs);</span>
<span class="nc" id="L2117">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2118">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2119">        cs.addAttribute(See.only(serverPlayer), &quot;settlements&quot;,</span>
<span class="nc" id="L2120">            Integer.toString(settlement.getOwner().getSettlements().size()));</span>

        // This is private.
<span class="nc" id="L2123">        return cs.build(serverPlayer);</span>
    }

    /**
     * Speak to the chief at a native settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is scouting.
     * @param unit The scout &lt;code&gt;Unit&lt;/code&gt;.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; to scout.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element scoutSpeakToChief(ServerPlayer serverPlayer,
                                     Unit unit, IndianSettlement settlement) {
<span class="nc" id="L2136">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2137">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2138">        boolean tileDirty = settlement.setVisited(serverPlayer);</span>
        String result;

        // Hateful natives kill the scout right away.
<span class="nc" id="L2142">        Tension tension = settlement.getAlarm(serverPlayer);</span>
<span class="nc bnc" id="L2143" title="All 2 branches missed.">        if (tension.getLevel() == Tension.Level.HATEFUL) {</span>
<span class="nc" id="L2144">            cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2145">                   (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L2146">            cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2147">                         unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L2148">            unit.dispose();</span>
<span class="nc" id="L2149">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L2150">            result = &quot;die&quot;;</span>
        } else {
            // Otherwise player gets to visit, and learn about the settlement.
<span class="nc" id="L2153">            List&lt;UnitType&gt; scoutTypes = getGame().getSpecification()</span>
<span class="nc" id="L2154">                .getUnitTypesWithAbility(Ability.EXPERT_SCOUT);</span>
<span class="nc bnc" id="L2155" title="All 2 branches missed.">            UnitType scoutSkill = (scoutTypes.isEmpty()) ? null</span>
<span class="nc" id="L2156">                : scoutTypes.get(0);</span>
<span class="nc" id="L2157">            int radius = unit.getLineOfSight();</span>
<span class="nc" id="L2158">            UnitType skill = settlement.getLearnableSkill();</span>
<span class="nc" id="L2159">            int rnd = randomInt(logger, &quot;scouting&quot;, random, 10);</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">            if (settlement.hasAnyScouted()) {</span>
                // Do nothing if already spoken to.
<span class="nc" id="L2162">                result = &quot;nothing&quot;;</span>
<span class="nc bnc" id="L2163" title="All 6 branches missed.">            } else if (scoutSkill != null &amp;&amp; unit.getType() != scoutSkill</span>
<span class="nc bnc" id="L2164" title="All 4 branches missed.">                &amp;&amp; ((skill != null &amp;&amp; skill.hasAbility(Ability.EXPERT_SCOUT))</span>
                    || rnd == 0)) {
                // If the scout can be taught to be an expert it will be.
<span class="nc" id="L2167">                unit.changeType(scoutSkill);//-vis(serverPlayer)</span>
<span class="nc" id="L2168">                serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="nc" id="L2169">                result = &quot;expert&quot;;</span>
            } else {
                // Choose tales 1/3 of the time, or if there are no beads.
<span class="nc" id="L2172">                RandomRange gifts = settlement.getType().getGifts(unit);</span>
<span class="nc bnc" id="L2173" title="All 2 branches missed.">                int gold = (gifts == null) ? 0</span>
<span class="nc" id="L2174">                    : gifts.getAmount(&quot;Base beads amount&quot;, random, true);</span>
<span class="nc bnc" id="L2175" title="All 4 branches missed.">                if (gold &lt;= 0 || rnd &lt;= 3) {</span>
<span class="nc" id="L2176">                    radius = Math.max(radius, IndianSettlement.TALES_RADIUS);</span>
<span class="nc" id="L2177">                    result = &quot;tales&quot;;</span>
                } else {
<span class="nc bnc" id="L2179" title="All 2 branches missed.">                    if (unit.hasAbility(Ability.EXPERT_SCOUT)) {</span>
<span class="nc" id="L2180">                        gold = (gold * 11) / 10; // FIXME: magic number</span>
                    }
<span class="nc" id="L2182">                    serverPlayer.modifyGold(gold);</span>
<span class="nc" id="L2183">                    settlement.getOwner().modifyGold(-gold);</span>
<span class="nc" id="L2184">                    result = &quot;beads&quot;;</span>
                }
            }

            // Have now spoken to the chief.
<span class="nc" id="L2189">            csVisit(serverPlayer, settlement, 1, cs);</span>
<span class="nc" id="L2190">            tileDirty = true;</span>

            // Update settlement tile with new information, and any
            // newly visible tiles, possibly with enhanced radius.
<span class="nc" id="L2194">            Set&lt;Tile&gt; tiles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2195" title="All 2 branches missed.">            for (Tile t : tile.getSurroundingTiles(1, radius)) {</span>
<span class="nc bnc" id="L2196" title="All 6 branches missed.">                if (!serverPlayer.canSee(t) &amp;&amp; (t.isLand() || t.isShore())) {</span>
<span class="nc" id="L2197">                    tiles.add(t);</span>
                }
<span class="nc" id="L2199">            }</span>
<span class="nc" id="L2200">            cs.add(See.only(serverPlayer), serverPlayer.exploreTiles(tiles));</span>

            // If the unit was promoted, update it completely, otherwise just
            // update moves and possibly gold+score.
<span class="nc" id="L2204">            unit.setMovesLeft(0);</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">            if (&quot;expert&quot;.equals(result)) {</span>
<span class="nc" id="L2206">                cs.add(See.perhaps(), unit);</span>
            } else {
<span class="nc" id="L2208">                cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc bnc" id="L2209" title="All 2 branches missed.">                if (&quot;beads&quot;.equals(result)) {</span>
<span class="nc" id="L2210">                    cs.addPartial(See.only(serverPlayer), serverPlayer,</span>
                                  &quot;gold&quot;, &quot;score&quot;);
                }
            }
        }
<span class="nc bnc" id="L2215" title="All 2 branches missed.">        if (tileDirty) {</span>
<span class="nc" id="L2216">            tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2217">            cs.add(See.only(serverPlayer), tile);</span>
        }

        // Always add result.
<span class="nc" id="L2221">        cs.addAttribute(See.only(serverPlayer), &quot;result&quot;, result);</span>

        // Other players may be able to see unit disappearing, or
        // learning.
<span class="nc" id="L2225">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2226">        return cs.build(serverPlayer);</span>
    }


    /**
     * Denounce an existing mission.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is denouncing.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; denouncing.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt;
     *     containing the mission to denounce.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element denounceMission(ServerPlayer serverPlayer, Unit unit,
                                   ServerIndianSettlement settlement) {
<span class="nc" id="L2241">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2242">        csVisit(serverPlayer, settlement, 0, cs);</span>

        // Determine result
<span class="nc" id="L2245">        Unit missionary = settlement.getMissionary();</span>
<span class="nc bnc" id="L2246" title="All 2 branches missed.">        if (missionary == null) {</span>
<span class="nc" id="L2247">            return DOMMessage.clientError(&quot;Denouncing null missionary&quot;);</span>
        }
<span class="nc" id="L2249">        ServerPlayer enemy = (ServerPlayer) missionary.getOwner();</span>
<span class="nc" id="L2250">        double denounce = randomDouble(logger, &quot;Denounce base&quot;, random)</span>
<span class="nc" id="L2251">            * enemy.getImmigration() / (serverPlayer.getImmigration() + 1);</span>
<span class="nc bnc" id="L2252" title="All 2 branches missed.">        if (missionary.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L2253">            denounce += 0.2;</span>
        }
<span class="nc bnc" id="L2255" title="All 2 branches missed.">        if (unit.hasAbility(Ability.EXPERT_MISSIONARY)) {</span>
<span class="nc" id="L2256">            denounce -= 0.2;</span>
        }

<span class="nc bnc" id="L2259" title="All 2 branches missed.">        if (denounce &lt; 0.5) { // Success, remove old mission and establish ours</span>
<span class="nc" id="L2260">            return establishMission(serverPlayer, unit, settlement);</span>
        }

        // Denounce failed
<span class="nc" id="L2264">        Player owner = settlement.getOwner();</span>
<span class="nc" id="L2265">        cs.add(See.only(serverPlayer), settlement);</span>
<span class="nc" id="L2266">        cs.addMessage(See.only(serverPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                             &quot;indianSettlement.mission.noDenounce&quot;,
                             serverPlayer, unit)
<span class="nc" id="L2270">                .addStringTemplate(&quot;%nation%&quot;, owner.getNationLabel()));</span>
<span class="nc" id="L2271">        cs.addMessage(See.only(enemy),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                             &quot;indianSettlement.mission.enemyDenounce&quot;,
                             enemy, settlement)
<span class="nc" id="L2275">                .addStringTemplate(&quot;%enemy%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L2276">                .addStringTemplate(&quot;%settlement%&quot;,</span>
<span class="nc" id="L2277">                    settlement.getLocationLabelFor(enemy))</span>
<span class="nc" id="L2278">                .addStringTemplate(&quot;%nation%&quot;, owner.getNationLabel()));</span>
<span class="nc" id="L2279">        cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2280">               (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L2281">        cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2282">                     unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L2283">        unit.dispose();</span>
<span class="nc" id="L2284">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // Others can see missionary disappear
<span class="nc" id="L2287">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2288">        return cs.build(serverPlayer);</span>
    }

    /**
     * Establish a new mission.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is establishing.
     * @param unit The missionary &lt;code&gt;Unit&lt;/code&gt;.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to
     *     establish at.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element establishMission(ServerPlayer serverPlayer, Unit unit,
                                    ServerIndianSettlement settlement) {
<span class="fc" id="L2302">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2303">        csVisit(serverPlayer, settlement, 0, cs);</span>

        // Result depends on tension wrt this settlement.
        // Establish if at least not angry.
<span class="fc" id="L2307">        final Tension tension = settlement.getAlarm(serverPlayer);</span>
<span class="pc bpc" id="L2308" title="1 of 3 branches missed.">        switch (tension.getLevel()) {</span>
        case HATEFUL: case ANGRY:
<span class="fc" id="L2310">            cs.add(See.perhaps().always(serverPlayer),</span>
<span class="fc" id="L2311">                   (FreeColGameObject)unit.getLocation());</span>
<span class="fc" id="L2312">            cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="fc" id="L2313">                         unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="fc" id="L2314">            unit.dispose();</span>
<span class="fc" id="L2315">            serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>
<span class="fc" id="L2316">            break;</span>

        case HAPPY: case CONTENT: case DISPLEASED:
<span class="pc bpc" id="L2319" title="1 of 2 branches missed.">            if (settlement.hasMissionary()) {</span>
<span class="nc" id="L2320">                settlement.csKillMissionary(false, cs);</span>
            }
            // Always show the tile the unit was on
<span class="fc" id="L2323">            cs.add(See.perhaps().always(serverPlayer), unit.getTile());</span>
            
<span class="fc" id="L2325">            settlement.csChangeMissionary(unit, cs);//+vis(serverPlayer)</span>
            break;
        }

        // Add the descriptive message.
<span class="fc" id="L2330">        final StringTemplate nation = settlement.getOwner().getNationLabel();</span>
<span class="fc" id="L2331">        cs.addMessage(See.only(serverPlayer),</span>
            new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="fc" id="L2333">                             &quot;indianSettlement.mission.&quot; + tension.getKey(),</span>
                             serverPlayer, unit)
<span class="fc" id="L2335">                .addStringTemplate(&quot;%nation%&quot;, nation));</span>

        // Others can see missionary disappear and settlement acquire
        // mission.
<span class="fc" id="L2339">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L2340">        return cs.build(serverPlayer);</span>
    }

    /**
     * Incite a settlement against an enemy.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is inciting.
     * @param unit The missionary &lt;code&gt;Unit&lt;/code&gt; inciting.
     * @param settlement The &lt;code&gt;IndianSettlement&lt;/code&gt; to incite.
     * @param enemy The &lt;code&gt;ServerPlayer&lt;/code&gt; to be incited against.
     * @param gold The amount of gold in the bribe.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element incite(ServerPlayer serverPlayer, Unit unit,
                          IndianSettlement settlement,
                          ServerPlayer enemy, int gold) {
<span class="nc" id="L2356">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L2358">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2359">        csVisit(serverPlayer, settlement, 0, cs);</span>
<span class="nc" id="L2360">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2361">        cs.add(See.only(serverPlayer), tile);</span>

        // How much gold will be needed?
<span class="nc" id="L2364">        ServerPlayer enemyPlayer = enemy;</span>
<span class="nc" id="L2365">        ServerPlayer nativePlayer = (ServerPlayer)settlement.getOwner();</span>
<span class="nc" id="L2366">        int payingValue = nativePlayer.getTension(serverPlayer).getValue();</span>
<span class="nc" id="L2367">        int targetValue = nativePlayer.getTension(enemyPlayer).getValue();</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">        int goldToPay = (payingValue &gt; targetValue) ? 10000 : 5000;</span>
<span class="nc" id="L2369">        goldToPay += 20 * (payingValue - targetValue);</span>
<span class="nc" id="L2370">        goldToPay = Math.max(goldToPay, 650);</span>

        // Try to incite?
<span class="nc bnc" id="L2373" title="All 2 branches missed.">        if (gold &lt; 0) { // Initial enquiry.</span>
<span class="nc" id="L2374">            cs.addAttribute(See.only(serverPlayer),</span>
<span class="nc" id="L2375">                            &quot;gold&quot;, Integer.toString(goldToPay));</span>
<span class="nc bnc" id="L2376" title="All 4 branches missed.">        } else if (gold &lt; goldToPay || !serverPlayer.checkGold(gold)) {</span>
<span class="nc" id="L2377">            cs.addMessage(See.only(serverPlayer),</span>
                new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                                 &quot;indianSettlement.inciteGoldFail&quot;,
                                 serverPlayer, settlement)
<span class="nc" id="L2381">                    .addStringTemplate(&quot;%player%&quot;, enemyPlayer.getNationLabel())</span>
<span class="nc" id="L2382">                    .addAmount(&quot;%amount%&quot;, goldToPay));</span>
<span class="nc" id="L2383">            cs.addAttribute(See.only(serverPlayer), &quot;gold&quot;, &quot;0&quot;);</span>
<span class="nc" id="L2384">            unit.setMovesLeft(0);</span>
<span class="nc" id="L2385">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
        } else {
            // Success.  Raise the tension for the native player with respect
            // to the European player.  Let resulting stance changes happen
            // naturally in the AI player turn/s.
<span class="nc" id="L2390">            nativePlayer.csModifyTension(enemyPlayer,</span>
                Tension.WAR_MODIFIER, cs);//+til
<span class="nc" id="L2392">            enemyPlayer.csModifyTension(serverPlayer,</span>
                Tension.TENSION_ADD_WAR_INCITER, cs);//+til
<span class="nc" id="L2394">            cs.addAttribute(See.only(serverPlayer),</span>
<span class="nc" id="L2395">                            &quot;gold&quot;, Integer.toString(gold));</span>
<span class="nc" id="L2396">            serverPlayer.modifyGold(-gold);</span>
<span class="nc" id="L2397">            nativePlayer.modifyGold(gold);</span>
<span class="nc" id="L2398">            cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2399">            unit.setMovesLeft(0);</span>
<span class="nc" id="L2400">            cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
        }

        // Others might include enemy.
<span class="nc" id="L2404">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2405">        return cs.build(serverPlayer);</span>
    }


    /**
     * Set a unit destination.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to set the destination for.
     * @param destination The &lt;code&gt;Location&lt;/code&gt; to set as destination.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element setDestination(ServerPlayer serverPlayer, Unit unit,
                                  Location destination) {
<span class="nc bnc" id="L2419" title="All 2 branches missed.">        if (unit.getTradeRoute() != null) {</span>
            // Override destination to bring the unit to port.
<span class="nc bnc" id="L2421" title="All 4 branches missed.">            if (destination == null &amp;&amp; unit.isAtSea()) {</span>
<span class="nc" id="L2422">                destination = unit.getStop().getLocation();</span>
            }
<span class="nc" id="L2424">            unit.setTradeRoute(null);</span>
        }
<span class="nc" id="L2426">        unit.setDestination(destination);</span>

        // Others can not see a destination change.
<span class="nc" id="L2429">        return new ChangeSet().add(See.only(serverPlayer), unit)</span>
<span class="nc" id="L2430">            .build(serverPlayer);</span>
    }


    /**
     * Set a unit stop.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to set the destination for.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element setCurrentStop(ServerPlayer serverPlayer, Unit unit,
                                  int index) {
<span class="nc" id="L2443">        TradeRoute tr = unit.getTradeRoute();</span>
<span class="nc bnc" id="L2444" title="All 2 branches missed.">        if (tr == null) {</span>
<span class="nc" id="L2445">            return DOMMessage.clientError(&quot;Unit has no trade route to set stop for.&quot;);</span>
<span class="nc bnc" id="L2446" title="All 4 branches missed.">        } else if (index &lt; 0 || index &gt;= tr.getStops().size()) {</span>
<span class="nc" id="L2447">            return DOMMessage.clientError(&quot;Stop index out of range [0..&quot;</span>
<span class="nc" id="L2448">                + tr.getStops().size() + &quot;]: &quot; + index);</span>
        }

<span class="nc" id="L2451">        unit.setCurrentStop(index);</span>

        // Others can not see a stop change.
<span class="nc" id="L2454">        return new ChangeSet().add(See.only(serverPlayer), unit)</span>
<span class="nc" id="L2455">            .build(serverPlayer);</span>
    }


    /**
     * Buy from a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is buying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that will carry the goods.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to buy from.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to buy.
     * @param amount How much gold to pay.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element buyFromSettlement(ServerPlayer serverPlayer, Unit unit,
                                     ServerIndianSettlement settlement,
                                     Goods goods, int amount) {
<span class="nc" id="L2472">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2473">        csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L2475">        TradeSession session</span>
<span class="nc" id="L2476">            = TradeSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L2477" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L2478">            return DOMMessage.clientError(&quot;Trying to buy without opening a transaction session&quot;);</span>
        }
<span class="nc bnc" id="L2480" title="All 2 branches missed.">        if (!session.getBuy()) {</span>
<span class="nc" id="L2481">            return DOMMessage.clientError(&quot;Trying to buy in a session where buying is not allowed.&quot;);</span>
        }
<span class="nc bnc" id="L2483" title="All 2 branches missed.">        if (!unit.hasSpaceLeft()) {</span>
<span class="nc" id="L2484">            return DOMMessage.clientError(&quot;Unit is full, unable to buy.&quot;);</span>
        }

        // Check that this is the agreement that was made
<span class="nc" id="L2488">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L2489">        int returnGold = ai.buyProposition(unit, settlement, goods, amount);</span>
<span class="nc bnc" id="L2490" title="All 2 branches missed.">        if (returnGold != amount) {</span>
<span class="nc" id="L2491">            return DOMMessage.clientError(&quot;This was not the price we agreed upon! Cheater?&quot;);</span>
        }
<span class="nc bnc" id="L2493" title="All 2 branches missed.">        if (!serverPlayer.checkGold(amount)) { // Check this is funded.</span>
<span class="nc" id="L2494">            return DOMMessage.clientError(&quot;Insufficient gold to buy.&quot;);</span>
        }

        // Valid, make the trade.
<span class="nc" id="L2498">        moveGoods(settlement, goods.getType(), goods.getAmount(), unit);</span>
<span class="nc" id="L2499">        cs.add(See.perhaps(), unit);</span>

<span class="nc" id="L2501">        Player settlementPlayer = settlement.getOwner();</span>
<span class="nc" id="L2502">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2503">        settlement.updateWantedGoods();</span>
<span class="nc" id="L2504">        settlementPlayer.modifyGold(amount);</span>
<span class="nc" id="L2505">        serverPlayer.modifyGold(-amount);</span>
<span class="nc" id="L2506">        settlement.csModifyAlarm(serverPlayer, -amount / 50, true, cs);</span>
<span class="nc" id="L2507">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2508">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2509">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2510">        session.setBuy();</span>
<span class="nc" id="L2511">        logger.finest(serverPlayer.getName() + &quot; &quot; + unit + &quot; buys &quot; + goods</span>
<span class="nc" id="L2512">                      + &quot; at &quot; + settlement.getName() + &quot; for &quot; + amount);</span>

        // Others can see the unit capacity.
<span class="nc" id="L2515">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2516">        return cs.build(serverPlayer);</span>
    }

    /**
     * Sell to a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is selling.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; carrying the goods.
     * @param settlement The &lt;code&gt;ServerIndianSettlement&lt;/code&gt; to sell to.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to sell.
     * @param amount How much gold to expect.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element sellToSettlement(ServerPlayer serverPlayer, Unit unit,
                                    ServerIndianSettlement settlement,
                                    Goods goods, int amount) {
<span class="nc" id="L2532">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2533">        csVisit(serverPlayer, settlement, 0, cs);</span>

<span class="nc" id="L2535">        TradeSession session</span>
<span class="nc" id="L2536">            = TransactionSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L2537" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L2538">            return DOMMessage.clientError(&quot;Trying to sell without opening a transaction session&quot;);</span>
        }
<span class="nc bnc" id="L2540" title="All 2 branches missed.">        if (!session.getSell()) {</span>
<span class="nc" id="L2541">            return DOMMessage.clientError(&quot;Trying to sell in a session where selling is not allowed.&quot;);</span>
        }

        // Check that the gold is the agreed amount
<span class="nc" id="L2545">        AIPlayer ai = getFreeColServer().getAIPlayer(settlement.getOwner());</span>
<span class="nc" id="L2546">        int returnGold = ai.sellProposition(unit, settlement, goods, amount);</span>
<span class="nc bnc" id="L2547" title="All 2 branches missed.">        if (returnGold != amount) {</span>
<span class="nc" id="L2548">            return DOMMessage.clientError(&quot;This was not the price we agreed upon! Cheater?&quot;);</span>
        }

        // Valid, make the trade.
<span class="nc" id="L2552">        moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L2553">        cs.add(See.perhaps(), unit);</span>

<span class="nc" id="L2555">        Player settlementPlayer = settlement.getOwner();</span>
<span class="nc" id="L2556">        settlementPlayer.modifyGold(-amount);</span>
<span class="nc" id="L2557">        serverPlayer.modifyGold(amount);</span>
<span class="nc" id="L2558">        settlement.csModifyAlarm(serverPlayer, -amount / 500, true, cs);</span>
<span class="nc" id="L2559">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2560">        settlement.updateWantedGoods();</span>
<span class="nc" id="L2561">        tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2562">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L2563">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L2564">        session.setSell();</span>
<span class="nc" id="L2565">        cs.addSale(serverPlayer, settlement, goods.getType(),</span>
<span class="nc" id="L2566">                Math.round((float) amount / goods.getAmount()));</span>
<span class="nc" id="L2567">        logger.finest(serverPlayer.getName() + &quot; &quot; + unit + &quot; sells &quot; + goods</span>
<span class="nc" id="L2568">                      + &quot; at &quot; + settlement.getName() + &quot; for &quot; + amount);</span>

        // Others can see the unit capacity.
<span class="nc" id="L2571">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2572">        return cs.build(serverPlayer);</span>
    }

    /**
     * Deliver gift to settlement.
     * Note that this includes both European and native gifts.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is delivering.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is delivering.
     * @param goods The &lt;code&gt;Goods&lt;/code&gt; to deliver.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element deliverGiftToSettlement(ServerPlayer serverPlayer,
                                           Unit unit, Settlement settlement,
                                           Goods goods) {
<span class="nc" id="L2587">        TradeSession session</span>
<span class="nc" id="L2588">            = TransactionSession.lookup(TradeSession.class, unit, settlement);</span>
<span class="nc bnc" id="L2589" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L2590">            return DOMMessage.clientError(&quot;Trying to deliver gift without opening a session&quot;);</span>
        }
<span class="nc bnc" id="L2592" title="All 2 branches missed.">        if (!session.getGift()) {</span>
<span class="nc" id="L2593">            return DOMMessage.clientError(&quot;Trying to deliver gift in a session where gift giving is not allowed: &quot; + unit + &quot; &quot; + settlement + &quot; &quot; + session);</span>
        }

<span class="nc" id="L2596">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2597">        Tile tile = settlement.getTile();</span>
<span class="nc" id="L2598">        moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L2599">        cs.add(See.perhaps(), unit);</span>
<span class="nc bnc" id="L2600" title="All 2 branches missed.">        if (settlement instanceof ServerIndianSettlement) {</span>
<span class="nc" id="L2601">            ServerIndianSettlement sis = (ServerIndianSettlement)settlement;</span>
<span class="nc" id="L2602">            csVisit(serverPlayer, sis, 0, cs);</span>
<span class="nc" id="L2603">            sis.csModifyAlarm(serverPlayer, -sis.getPriceToBuy(goods) / 50,</span>
                              true, cs);
<span class="nc" id="L2605">            sis.updateWantedGoods();</span>
<span class="nc" id="L2606">            tile.updateIndianSettlement(serverPlayer);</span>
<span class="nc" id="L2607">            cs.add(See.only(serverPlayer), tile);</span>
        }
<span class="nc" id="L2609">        session.setGift();</span>

        // Inform the receiver of the gift.
<span class="nc" id="L2612">        ModelMessage m = new ModelMessage(ModelMessage.MessageType.GIFT_GOODS,</span>
                                          &quot;deliverGift.goods&quot;,
<span class="nc" id="L2614">                                          settlement, goods.getType())</span>
<span class="nc" id="L2615">            .addStringTemplate(&quot;%player%&quot;, serverPlayer.getNationLabel())</span>
<span class="nc" id="L2616">            .addNamed(&quot;%type%&quot;, goods)</span>
<span class="nc" id="L2617">            .addAmount(&quot;%amount%&quot;, goods.getAmount())</span>
<span class="nc" id="L2618">            .addName(&quot;%settlement%&quot;, settlement.getName());</span>
<span class="nc" id="L2619">        cs.addMessage(See.only(serverPlayer), m);</span>
<span class="nc" id="L2620">        ServerPlayer receiver = (ServerPlayer) settlement.getOwner();</span>
<span class="nc bnc" id="L2621" title="All 4 branches missed.">        if (receiver.isConnected() &amp;&amp; settlement instanceof Colony) {</span>
<span class="nc" id="L2622">            cs.add(See.only(receiver), unit);</span>
<span class="nc" id="L2623">            cs.add(See.only(receiver), settlement);</span>
<span class="nc" id="L2624">            cs.addMessage(See.only(receiver), m);</span>
        }
<span class="nc" id="L2626">        logger.info(&quot;Gift delivered by unit: &quot; + unit.getId()</span>
<span class="nc" id="L2627">                    + &quot; to settlement: &quot; + settlement.getName());</span>

        // Others can see unit capacity, receiver gets it own items.
<span class="nc" id="L2630">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2631">        return cs.build(serverPlayer);</span>
    }


    /**
     * Load goods.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is loading.
     * @param loc The &lt;code&gt;Location&lt;/code&gt; where the goods are.
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to load.
     * @param amount The amount of goods to load.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to load.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element loadGoods(ServerPlayer serverPlayer, Location loc,
                             GoodsType goodsType, int amount, Unit carrier) {
<span class="fc bfc" id="L2647" title="All 2 branches covered.">        if (loc instanceof Europe) {</span>
<span class="fc bfc" id="L2648" title="All 2 branches covered.">            if (carrier.isInEurope()) {</span>
<span class="fc" id="L2649">                return buyGoods(serverPlayer, goodsType, amount, carrier);</span>
            } else {
<span class="fc" id="L2651">                return DOMMessage.clientError(&quot;Carrier not in Europe: &quot; + loc);</span>
            }
        }
        // All loading locations other than Europe are GoodsLocations
<span class="pc bpc" id="L2655" title="1 of 2 branches missed.">        if (!(loc instanceof GoodsLocation)) {</span>
<span class="nc" id="L2656">            return DOMMessage.clientError(&quot;Not a goods location: &quot; + loc);</span>
        }
<span class="fc" id="L2658">        GoodsLocation gl = (GoodsLocation)loc;</span>
<span class="fc bfc" id="L2659" title="All 2 branches covered.">        if (!carrier.isAtLocation(loc)) {</span>
<span class="fc" id="L2660">            return DOMMessage.clientError(&quot;Carrier not at location: &quot; + loc);</span>
        }
<span class="fc bfc" id="L2662" title="All 2 branches covered.">        if (carrier.getLoadableAmount(goodsType) &lt; amount) {</span>
<span class="fc" id="L2663">            return DOMMessage.clientError(&quot;Too much goods&quot;);</span>
        }
<span class="pc bpc" id="L2665" title="1 of 2 branches missed.">        if (gl.getGoodsCount(goodsType) &lt; amount) {</span>
<span class="nc" id="L2666">            return DOMMessage.clientError(&quot;Not enough goods (&quot;</span>
<span class="nc" id="L2667">                + gl.getGoodsCount(goodsType) + &quot; &lt; &quot; + amount</span>
<span class="nc" id="L2668">                + &quot; &quot; + goodsType.getSuffix() + &quot;) at &quot; + gl);</span>
        }

<span class="fc" id="L2671">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2672">        moveGoods(gl, goodsType, amount, carrier);</span>
<span class="fc" id="L2673">        logger.finest(Messages.message(loc.getLocationLabel())</span>
<span class="fc" id="L2674">            + &quot; loaded &quot; + amount + &quot; &quot; + goodsType.getSuffix()</span>
            + &quot; onto &quot; + carrier);
<span class="fc" id="L2676">        cs.add(See.only(serverPlayer), gl.getGoodsContainer());</span>
<span class="fc" id="L2677">        cs.add(See.only(serverPlayer), carrier.getGoodsContainer());</span>
<span class="pc bpc" id="L2678" title="1 of 2 branches missed.">        if (carrier.getInitialMovesLeft() != carrier.getMovesLeft()) {</span>
<span class="nc" id="L2679">            carrier.setMovesLeft(0);</span>
<span class="nc" id="L2680">            cs.addPartial(See.only(serverPlayer), carrier, &quot;movesLeft&quot;);</span>
        }

        // Invisible in settlement
<span class="fc" id="L2684">        return cs.build(serverPlayer);</span>
    }

    /**
     * Unload goods.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is unloading.
     * @param goodsType The &lt;code&gt;GoodsType&lt;/code&gt; to unload.
     * @param amount The amount of goods to unload.
     * @param carrier The &lt;code&gt;Unit&lt;/code&gt; to unload.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element unloadGoods(ServerPlayer serverPlayer, GoodsType goodsType,
                               int amount, Unit carrier) {
<span class="fc bfc" id="L2698" title="All 2 branches covered.">        if (carrier.getGoodsCount(goodsType) &lt; amount) {</span>
<span class="fc" id="L2699">            return DOMMessage.clientError(&quot;Too few goods&quot;);</span>
        }
<span class="fc bfc" id="L2701" title="All 2 branches covered.">        if (carrier.isInEurope()) {</span>
<span class="fc" id="L2702">            return sellGoods(serverPlayer, goodsType, amount, carrier);</span>
        }

<span class="fc" id="L2705">        ChangeSet cs = new ChangeSet();</span>
<span class="fc bfc" id="L2706" title="All 2 branches covered.">        if (carrier.getSettlement() != null) {</span>
<span class="fc" id="L2707">            Settlement settlement = carrier.getSettlement();</span>
<span class="fc" id="L2708">            moveGoods(carrier, goodsType, amount, settlement);</span>
<span class="fc" id="L2709">            logger.finest(carrier</span>
<span class="fc" id="L2710">                + &quot; unloaded &quot; + amount + &quot; &quot; + goodsType.getSuffix()</span>
<span class="fc" id="L2711">                + &quot; to &quot; + settlement.getName());</span>
<span class="fc" id="L2712">            cs.add(See.only(serverPlayer), settlement.getGoodsContainer());</span>
<span class="fc" id="L2713">            cs.add(See.only(serverPlayer), carrier.getGoodsContainer());</span>
<span class="pc bpc" id="L2714" title="1 of 2 branches missed.">            if (carrier.getInitialMovesLeft() != carrier.getMovesLeft()) {</span>
<span class="nc" id="L2715">                carrier.setMovesLeft(0);</span>
<span class="nc" id="L2716">                cs.addPartial(See.only(serverPlayer), carrier, &quot;movesLeft&quot;);</span>
            }
<span class="fc" id="L2718">        } else { // Dump of goods onto a tile</span>
<span class="fc" id="L2719">            moveGoods(carrier, goodsType, amount, null);</span>
<span class="fc" id="L2720">            logger.finest(carrier + &quot; dumped &quot; + amount</span>
<span class="fc" id="L2721">                + &quot; &quot; + goodsType.getSuffix() + &quot; to &quot; + carrier.getLocation());</span>
<span class="fc" id="L2722">            cs.add(See.perhaps(), (FreeColGameObject)carrier.getLocation());</span>
            // Others might see a capacity change.
<span class="fc" id="L2724">            getGame().sendToOthers(serverPlayer, cs);</span>
        }
<span class="fc" id="L2726">        return cs.build(serverPlayer);</span>
    }


    /**
     * Clear the specialty of a unit.
     *
     * FIXME: why not clear speciality in the open?  You can disband!
     * If we implement this remember to fix the visibility.
     *
     * @param serverPlayer The owner of the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to clear the speciality of.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element clearSpeciality(ServerPlayer serverPlayer, Unit unit) {
<span class="fc" id="L2741">        UnitType newType = unit.getTypeChange(ChangeType.CLEAR_SKILL,</span>
                                              serverPlayer);
<span class="pc bpc" id="L2743" title="1 of 2 branches missed.">        if (newType == null) {</span>
<span class="nc" id="L2744">            return DOMMessage.clientError(&quot;Can not clear unit speciality: &quot;</span>
<span class="nc" id="L2745">                + unit.getId());</span>
        }

        // There can be some restrictions that may prevent the
        // clearing of the speciality.  AFAICT the only ATM is that a
        // teacher can not lose its speciality, but this will need to
        // be revisited if we invent a work location that requires a
        // particular unit type.
<span class="fc bfc" id="L2753" title="All 2 branches covered.">        if (unit.getStudent() != null) {</span>
<span class="fc" id="L2754">            return DOMMessage.clientError(&quot;Can not clear speciality of a teacher.&quot;);</span>
        }

        // Valid, change type.
<span class="fc" id="L2758">        unit.changeType(newType);//-vis: safe in colony</span>

        // Update just the unit, others can not see it as this only happens
        // in-colony.
<span class="fc" id="L2762">        return new ChangeSet().add(See.only(serverPlayer), unit)</span>
<span class="fc" id="L2763">            .build(serverPlayer);</span>
    }


    /**
     * Disband a unit.
     *
     * @param serverPlayer The owner of the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to disband.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element disbandUnit(ServerPlayer serverPlayer, Unit unit) {
<span class="nc" id="L2775">        ChangeSet cs = new ChangeSet();</span>

        // Dispose of the unit.
<span class="nc" id="L2778">        cs.add(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2779">               (FreeColGameObject)unit.getLocation());</span>
<span class="nc" id="L2780">        cs.addRemove(See.perhaps().always(serverPlayer),</span>
<span class="nc" id="L2781">                     unit.getLocation(), unit);//-vis(serverPlayer)</span>
<span class="nc" id="L2782">        unit.dispose();</span>
<span class="nc" id="L2783">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // Others can see the unit removal and the space it leaves.
<span class="nc" id="L2786">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2787">        return cs.build(serverPlayer);</span>
    }


    /**
     * Build a settlement.
     *
     * +til: Resolves many tile appearance changes.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is building.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is building.
     * @param name The new settlement name.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element buildSettlement(ServerPlayer serverPlayer, Unit unit,
                                   String name) {
<span class="nc" id="L2803">        final ServerGame game = getGame();</span>
<span class="nc" id="L2804">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L2805">        ChangeSet cs = new ChangeSet();</span>

        // Build settlement
<span class="nc" id="L2808">        Tile tile = unit.getTile();</span>
        Settlement settlement;
<span class="nc bnc" id="L2810" title="All 2 branches missed.">        if (Player.ASSIGN_SETTLEMENT_NAME.equals(name)) {</span>
<span class="nc" id="L2811">            name = serverPlayer.getSettlementName(random);</span>
        }
<span class="nc bnc" id="L2813" title="All 2 branches missed.">        if (serverPlayer.isEuropean()) {</span>
<span class="nc" id="L2814">            StringTemplate nation = serverPlayer.getNationLabel();</span>
<span class="nc" id="L2815">            settlement = new ServerColony(game, serverPlayer, name, tile);</span>
<span class="nc bnc" id="L2816" title="All 2 branches missed.">            for (Tile t : tile.getSurroundingTiles(settlement.getRadius())) {</span>
<span class="nc" id="L2817">                t.cacheUnseen();//+til</span>
<span class="nc" id="L2818">            }</span>
<span class="nc" id="L2819">            serverPlayer.addSettlement(settlement);</span>
<span class="nc" id="L2820">            settlement.placeSettlement(false);//-vis(serverPlayer,?),-til</span>
<span class="nc" id="L2821">            cs.add(See.only(serverPlayer),</span>
<span class="nc" id="L2822">                   serverPlayer.exploreForSettlement(settlement));</span>

<span class="nc" id="L2824">            cs.addHistory(serverPlayer, new HistoryEvent(game.getTurn(),</span>
                    HistoryEvent.HistoryEventType.FOUND_COLONY, serverPlayer)
<span class="nc" id="L2826">                .addName(&quot;%colony%&quot;, settlement.getName()));</span>

            // Remove equipment from founder in case role confuses
            // placement.
<span class="nc" id="L2830">            settlement.equipForRole(unit, spec.getDefaultRole(), 0);</span>

            // Coronado
<span class="nc bnc" id="L2833" title="All 2 branches missed.">            for (ServerPlayer sp : game.getConnectedPlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L2834" title="All 2 branches missed.">                if (!sp.hasAbility(Ability.SEE_ALL_COLONIES)) continue;</span>
<span class="nc" id="L2835">                cs.add(See.only(sp), sp.exploreForSettlement(settlement));//-vis(sp)</span>
<span class="nc" id="L2836">                sp.invalidateCanSeeTiles();//+vis(sp)</span>
<span class="nc" id="L2837">                cs.addMessage(See.only(sp),</span>
                    new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
                                     &quot;buildColony.others&quot;, settlement)
<span class="nc" id="L2840">                        .addStringTemplate(&quot;%nation%&quot;, nation)</span>
<span class="nc" id="L2841">                        .addStringTemplate(&quot;%colony%&quot;,</span>
<span class="nc" id="L2842">                            settlement.getLocationLabelFor(sp))</span>
<span class="nc" id="L2843">                        .addStringTemplate(&quot;%region%&quot;,</span>
<span class="nc" id="L2844">                            tile.getRegion().getLabel()));</span>
<span class="nc" id="L2845">            }</span>
<span class="nc" id="L2846">        } else {</span>
<span class="nc" id="L2847">            IndianNationType nationType</span>
<span class="nc" id="L2848">                = (IndianNationType) serverPlayer.getNationType();</span>
<span class="nc" id="L2849">            UnitType skill = RandomChoice</span>
<span class="nc" id="L2850">                .getWeightedRandom(logger, &quot;Choose skill&quot;,</span>
<span class="nc" id="L2851">                                   nationType.generateSkillsForTile(tile),</span>
                                   random);
<span class="nc bnc" id="L2853" title="All 2 branches missed.">            if (skill == null) { // Seasoned Scout</span>
<span class="nc" id="L2854">                List&lt;UnitType&gt; scouts = spec</span>
<span class="nc" id="L2855">                    .getUnitTypesWithAbility(Ability.EXPERT_SCOUT);</span>
<span class="nc" id="L2856">                skill = getRandomMember(logger, &quot;Choose scout&quot;, scouts, random);</span>
            }
<span class="nc" id="L2858">            settlement = new ServerIndianSettlement(game, serverPlayer, name,</span>
                                                    tile, false, skill, null);
<span class="nc bnc" id="L2860" title="All 2 branches missed.">            for (Tile t : tile.getSurroundingTiles(settlement.getRadius())) {</span>
<span class="nc" id="L2861">                t.cacheUnseen();//+til</span>
<span class="nc" id="L2862">            }</span>
<span class="nc" id="L2863">            serverPlayer.addSettlement(settlement);</span>
<span class="nc" id="L2864">            settlement.placeSettlement(true);//-vis(serverPlayer),-til</span>
<span class="nc bnc" id="L2865" title="All 2 branches missed.">            for (Player p : getGame().getLivePlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L2866" title="All 2 branches missed.">                if (p == serverPlayer) continue;</span>
<span class="nc bnc" id="L2867" title="All 2 branches missed.">                ((IndianSettlement)settlement).setAlarm(p, (p.isIndian())</span>
<span class="nc" id="L2868">                    ? new Tension(Tension.Level.CONTENT.getLimit())</span>
<span class="nc" id="L2869">                    : serverPlayer.getTension(p));//-til</span>
<span class="nc" id="L2870">            }</span>
        }

        // Join the settlement.
<span class="nc" id="L2874">        unit.setLocation(settlement);//-vis(serverPlayer),-til</span>
<span class="nc" id="L2875">        unit.setMovesLeft(0);</span>

        // Update with settlement tile, and newly owned tiles.
<span class="nc" id="L2878">        cs.add(See.perhaps(), settlement.getOwnedTiles());</span>
<span class="nc" id="L2879">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // Others can see tile changes.
<span class="nc" id="L2882">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2883">        return cs.build(serverPlayer);</span>
    }

    /**
     * Join a colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is joining.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to join.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element joinColony(ServerPlayer serverPlayer, Unit unit,
                              Colony colony) {
<span class="nc" id="L2896">        final Specification spec = getGame().getSpecification();</span>
<span class="nc" id="L2897">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L2898">        Set&lt;Tile&gt; ownedTiles = colony.getOwnedTiles();</span>
<span class="nc" id="L2899">        Tile tile = colony.getTile();</span>

        // Join.
<span class="nc" id="L2902">        tile.cacheUnseen();//+til</span>
<span class="nc" id="L2903">        unit.setLocation(colony);//-vis: safe/colony,-til</span>
<span class="nc" id="L2904">        unit.setMovesLeft(0);</span>
<span class="nc" id="L2905">        colony.equipForRole(unit, spec.getDefaultRole(), 0);</span>

        // Update with colony tile, and tiles now owned.
<span class="nc" id="L2908">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc bnc" id="L2909" title="All 2 branches missed.">        for (Tile t : tile.getSurroundingTiles(colony.getRadius())) {</span>
<span class="nc bnc" id="L2910" title="All 4 branches missed.">            if (t.getOwningSettlement() == colony &amp;&amp; !ownedTiles.contains(t)) {</span>
<span class="nc" id="L2911">                cs.add(See.perhaps(), t);</span>
            }
<span class="nc" id="L2913">        }</span>

        // Others might see a tile ownership change.
<span class="nc" id="L2916">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2917">        return cs.build(serverPlayer);</span>
    }


    /**
     * Abandon a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is abandoning.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to abandon.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element abandonSettlement(ServerPlayer serverPlayer,
                                     Settlement settlement) {
<span class="nc" id="L2930">        ChangeSet cs = new ChangeSet();</span>

        // Drop trade routes and create history event before disposing.
<span class="nc bnc" id="L2933" title="All 2 branches missed.">        if (settlement instanceof Colony) {</span>
<span class="nc" id="L2934">            serverPlayer.csLoseLocation(settlement, cs);</span>
<span class="nc" id="L2935">            cs.addHistory(serverPlayer,</span>
<span class="nc" id="L2936">                new HistoryEvent(getGame().getTurn(),</span>
                    HistoryEvent.HistoryEventType.ABANDON_COLONY, serverPlayer)
<span class="nc" id="L2938">                    .addName(&quot;%colony%&quot;, settlement.getName()));</span>
        }

        // Comprehensive dispose.
<span class="nc" id="L2942">        serverPlayer.csDisposeSettlement(settlement, cs);//+vis</span>

        // FIXME: Player.settlements is still being fixed on the client side.
<span class="nc" id="L2945">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L2946">        return cs.build(serverPlayer);</span>
    }


    /**
     * Claim land.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; claiming.
     * @param tile The &lt;code&gt;Tile&lt;/code&gt; to claim.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to claim for.
     * @param price The price to pay for the land, which must agree
     *     with the owner valuation, unless negative which denotes stealing.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element claimLand(ServerPlayer serverPlayer, Tile tile,
                             Settlement settlement, int price) {
<span class="fc" id="L2962">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L2963">        serverPlayer.csClaimLand(tile, settlement, price, cs);</span>

<span class="pc bpc" id="L2965" title="3 of 4 branches missed.">        if (settlement != null &amp;&amp; serverPlayer.isEuropean()) {</span>
            // Define Coronado to make all colony-owned tiles visible
<span class="nc bnc" id="L2967" title="All 2 branches missed.">            for (ServerPlayer sp : getGame().getConnectedPlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L2968" title="All 2 branches missed.">                if (sp.isEuropean()</span>
<span class="nc bnc" id="L2969" title="All 2 branches missed.">                    &amp;&amp; sp.hasAbility(Ability.SEE_ALL_COLONIES)) {</span>
<span class="nc" id="L2970">                    sp.exploreTile(tile);</span>
<span class="nc" id="L2971">                    cs.add(See.only(sp), tile);</span>
<span class="nc" id="L2972">                    sp.invalidateCanSeeTiles();//+vis(sp)</span>
                }
<span class="nc" id="L2974">            }</span>
        }

        // Others can see the tile.
<span class="fc" id="L2978">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L2979">        return cs.build(serverPlayer);</span>
    }


    /**
     * Accept a diplomatic trade.  Handles the transfers of TradeItems.
     *
     * Note that first contact contexts may not necessarily have a settlement,
     * but this is ok because first contact trade can only include stance
     * and gold trade items.
     *
     * @param agreement The &lt;code&gt;DiplomacyTrade&lt;/code&gt; agreement.
     * @param session The &lt;code&gt;DiplomacySession&lt;/code&gt; in scope.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to update.
     * @return True if the trade was valid.
     */
    private boolean csAcceptTrade(DiplomaticTrade agreement,
                                  DiplomacySession session, ChangeSet cs) {
<span class="nc" id="L2997">        final ServerPlayer srcPlayer = (ServerPlayer)agreement.getSender();</span>
<span class="nc" id="L2998">        final ServerPlayer dstPlayer = (ServerPlayer)agreement.getRecipient();</span>
<span class="nc" id="L2999">        final Unit unit = session.getUnit();</span>
<span class="nc" id="L3000">        final Settlement settlement = session.getSettlement();</span>
<span class="nc" id="L3001">        boolean visibilityChange = false;</span>

        // Check trade carefully before committing.
<span class="nc" id="L3004">        boolean fail = false;</span>
<span class="nc bnc" id="L3005" title="All 2 branches missed.">        for (TradeItem tradeItem : agreement.getTradeItems()) {</span>
<span class="nc" id="L3006">            final ServerPlayer source = (ServerPlayer)tradeItem.getSource();</span>
<span class="nc" id="L3007">            final ServerPlayer dest = (ServerPlayer)tradeItem.getDestination();</span>
<span class="nc bnc" id="L3008" title="All 2 branches missed.">            if (!tradeItem.isValid()) {</span>
<span class="nc" id="L3009">                logger.warning(&quot;Trade with invalid tradeItem: &quot; + tradeItem);</span>
<span class="nc" id="L3010">                fail = true;</span>
<span class="nc" id="L3011">                continue;</span>
            }
<span class="nc bnc" id="L3013" title="All 4 branches missed.">            if (source != srcPlayer &amp;&amp; source != dstPlayer) {</span>
<span class="nc bnc" id="L3014" title="All 2 branches missed.">                logger.warning(&quot;Trade with invalid source: &quot;</span>
<span class="nc" id="L3015">                               + ((source == null) ? &quot;null&quot; : source.getId()));</span>
<span class="nc" id="L3016">                fail = true;</span>
<span class="nc" id="L3017">                continue;</span>
            }
<span class="nc bnc" id="L3019" title="All 4 branches missed.">            if (dest != srcPlayer &amp;&amp; dest != dstPlayer) {</span>
<span class="nc bnc" id="L3020" title="All 2 branches missed.">                logger.warning(&quot;Trade with invalid destination: &quot;</span>
<span class="nc" id="L3021">                               + ((dest == null) ? &quot;null&quot; : dest.getId()));</span>
<span class="nc" id="L3022">                fail = true;</span>
<span class="nc" id="L3023">                continue;</span>
            }

<span class="nc" id="L3026">            Colony colony = tradeItem.getColony(getGame());</span>
<span class="nc bnc" id="L3027" title="All 4 branches missed.">            if (colony != null &amp;&amp; !source.owns(colony)) {</span>
<span class="nc" id="L3028">                logger.warning(&quot;Trade with invalid source owner: &quot; + colony);</span>
<span class="nc" id="L3029">                fail = true;</span>
<span class="nc" id="L3030">                continue;</span>
            }
<span class="nc" id="L3032">            int gold = tradeItem.getGold();</span>
<span class="nc bnc" id="L3033" title="All 4 branches missed.">            if (gold &gt; 0 &amp;&amp; !source.checkGold(gold)) {</span>
<span class="nc" id="L3034">                logger.warning(&quot;Trade with invalid gold: &quot; + gold);</span>
<span class="nc" id="L3035">                fail = true;</span>
<span class="nc" id="L3036">                continue;</span>
            }

<span class="nc" id="L3039">            Goods goods = tradeItem.getGoods();</span>
<span class="nc bnc" id="L3040" title="All 2 branches missed.">            if (goods != null) {</span>
<span class="nc" id="L3041">                Location loc = goods.getLocation();</span>
<span class="nc bnc" id="L3042" title="All 2 branches missed.">                if (loc instanceof Ownable</span>
<span class="nc bnc" id="L3043" title="All 2 branches missed.">                    &amp;&amp; !source.owns((Ownable)loc)) {</span>
<span class="nc" id="L3044">                    logger.warning(&quot;Trade with invalid source owner: &quot; + loc);</span>
<span class="nc" id="L3045">                    fail = true;</span>
<span class="nc bnc" id="L3046" title="All 2 branches missed.">                } else if (!(loc instanceof GoodsLocation</span>
<span class="nc bnc" id="L3047" title="All 2 branches missed.">                        &amp;&amp; loc.contains(goods))) {</span>
<span class="nc" id="L3048">                    logger.warning(&quot;Trade of unavailable goods &quot; + goods</span>
                        + &quot; at &quot; + loc);
<span class="nc" id="L3050">                    fail = true;</span>
<span class="nc bnc" id="L3051" title="All 4 branches missed.">                } else if (dest.owns(unit) &amp;&amp; !unit.couldCarry(goods)) {</span>
<span class="nc" id="L3052">                    logger.warning(&quot;Trade unit can not carry traded goods: &quot;</span>
                        + goods);
<span class="nc" id="L3054">                    fail = true;</span>
                }
            }

            // Stance trade fail is harmless
<span class="nc" id="L3059">            Unit u = tradeItem.getUnit();</span>
<span class="nc bnc" id="L3060" title="All 2 branches missed.">            if (u != null) {</span>
<span class="nc bnc" id="L3061" title="All 2 branches missed.">                if (!source.owns(u)) {</span>
<span class="nc" id="L3062">                    logger.warning(&quot;Trade with invalid source owner: &quot; + u);</span>
<span class="nc" id="L3063">                    fail = true;</span>
<span class="nc" id="L3064">                    continue;</span>
<span class="nc bnc" id="L3065" title="All 4 branches missed.">                } else if (dest.owns(unit) &amp;&amp; !unit.couldCarry(u)) {</span>
<span class="nc" id="L3066">                    logger.warning(&quot;Trade unit can not carry traded unit: &quot;</span>
                        + u);
<span class="nc" id="L3068">                    fail = true;</span>
                }
            }
<span class="nc" id="L3071">        }</span>
<span class="nc bnc" id="L3072" title="All 2 branches missed.">        if (fail) return false;</span>

<span class="nc bnc" id="L3074" title="All 2 branches missed.">        for (TradeItem tradeItem : agreement.getTradeItems()) {</span>
<span class="nc" id="L3075">            final ServerPlayer source = (ServerPlayer)tradeItem.getSource();</span>
<span class="nc" id="L3076">            final ServerPlayer dest = (ServerPlayer)tradeItem.getDestination();</span>
            // Collect changes for updating.  Not very OO but
            // TradeItem should not know about server internals.
            // Take care to show items that change hands to the *old*
            // owner too.
<span class="nc" id="L3081">            Stance stance = tradeItem.getStance();</span>
<span class="nc bnc" id="L3082" title="All 2 branches missed.">            if (stance != null</span>
<span class="nc bnc" id="L3083" title="All 2 branches missed.">                &amp;&amp; !source.csChangeStance(stance, dest, true, cs)) {</span>
<span class="nc" id="L3084">                logger.warning(&quot;Stance trade failure: &quot; + stance);</span>
            }
<span class="nc" id="L3086">            Colony colony = tradeItem.getColony(getGame());</span>
<span class="nc bnc" id="L3087" title="All 2 branches missed.">            if (colony != null) {</span>
<span class="nc" id="L3088">                ServerPlayer former = (ServerPlayer) colony.getOwner();</span>
<span class="nc bnc" id="L3089" title="All 2 branches missed.">                for (Tile t : colony.getOwnedTiles()) {</span>
<span class="nc" id="L3090">                    t.cacheUnseen(dest);//+til</span>
<span class="nc" id="L3091">                }</span>
<span class="nc" id="L3092">                ((ServerColony)colony).csChangeOwner(dest, cs);//-vis(both),-til</span>
<span class="nc" id="L3093">                cs.add(See.only(dest), dest.exploreForSettlement(colony));</span>
<span class="nc" id="L3094">                cs.add(See.perhaps().always(former), colony.getOwnedTiles());</span>
<span class="nc" id="L3095">                visibilityChange = true;</span>
            }
<span class="nc" id="L3097">            int gold = tradeItem.getGold();</span>
<span class="nc bnc" id="L3098" title="All 2 branches missed.">            if (gold &gt; 0) {</span>
<span class="nc" id="L3099">                source.modifyGold(-gold);</span>
<span class="nc" id="L3100">                dest.modifyGold(gold);</span>
<span class="nc" id="L3101">                cs.addPartial(See.only(source), source, &quot;gold&quot;, &quot;score&quot;);</span>
<span class="nc" id="L3102">                cs.addPartial(See.only(dest), dest, &quot;gold&quot;, &quot;score&quot;);</span>
            }
<span class="nc" id="L3104">            Goods goods = tradeItem.getGoods();</span>
<span class="nc bnc" id="L3105" title="All 4 branches missed.">            if (goods != null &amp;&amp; settlement != null) {</span>
<span class="nc bnc" id="L3106" title="All 2 branches missed.">                if (dest.owns(settlement)) {</span>
<span class="nc" id="L3107">                    goods.setLocation(unit);</span>
<span class="nc" id="L3108">                    moveGoods(unit, goods.getType(), goods.getAmount(), settlement);</span>
<span class="nc" id="L3109">                    cs.add(See.only(source), unit);</span>
<span class="nc" id="L3110">                    cs.add(See.only(dest), settlement.getGoodsContainer());</span>
                } else {
<span class="nc" id="L3112">                    goods.setLocation(settlement);</span>
<span class="nc" id="L3113">                    moveGoods(settlement, goods.getType(), goods.getAmount(), unit);</span>
<span class="nc" id="L3114">                    cs.add(See.only(dest), unit);</span>
<span class="nc" id="L3115">                    cs.add(See.only(source), settlement.getGoodsContainer());</span>
                }
            }
<span class="nc" id="L3118">            ServerPlayer victim = (ServerPlayer)tradeItem.getVictim();</span>
<span class="nc bnc" id="L3119" title="All 2 branches missed.">            if (victim != null) {</span>
<span class="nc bnc" id="L3120" title="All 2 branches missed.">                if (source.csChangeStance(Stance.WAR, victim, true, cs)) {</span>
                    // Have to add in an explicit stance change and
                    // message because the player does not normally
                    // have visibility of stance changes between other nations.
<span class="nc" id="L3124">                    cs.addStance(See.only(dest), source, Stance.WAR, victim);</span>
<span class="nc" id="L3125">                    cs.addMessage(See.only(dest),</span>
                        new ModelMessage(ModelMessage.MessageType.FOREIGN_DIPLOMACY,
<span class="nc" id="L3127">                            Stance.WAR.getOtherStanceChangeKey(), source)</span>
<span class="nc" id="L3128">                            .addStringTemplate(&quot;%attacker%&quot;,</span>
<span class="nc" id="L3129">                                source.getNationLabel())</span>
<span class="nc" id="L3130">                            .addStringTemplate(&quot;%defender%&quot;,</span>
<span class="nc" id="L3131">                                victim.getNationLabel()));</span>
                } else {
<span class="nc" id="L3133">                    logger.warning(&quot;Incite trade failure: &quot; + victim);</span>
                }
            }                
<span class="nc" id="L3136">            ServerUnit newUnit = (ServerUnit)tradeItem.getUnit();</span>
<span class="nc bnc" id="L3137" title="All 4 branches missed.">            if (newUnit != null &amp;&amp; settlement != null) {</span>
<span class="nc" id="L3138">                ServerPlayer former = (ServerPlayer)newUnit.getOwner();</span>
<span class="nc" id="L3139">                Tile oldTile = newUnit.getTile();</span>
                Location newLoc;
<span class="nc bnc" id="L3141" title="All 2 branches missed.">                if (unit.isOnCarrier()) {</span>
<span class="nc" id="L3142">                    Unit carrier = unit.getCarrier();</span>
<span class="nc bnc" id="L3143" title="All 2 branches missed.">                    if (!carrier.couldCarry(newUnit)) {</span>
<span class="nc" id="L3144">                        logger.warning(&quot;Can not add &quot; + newUnit</span>
                            + &quot; to &quot; + carrier);
<span class="nc" id="L3146">                        continue;</span>
                    }
<span class="nc" id="L3148">                    newLoc = carrier;</span>
<span class="nc bnc" id="L3149" title="All 2 branches missed.">                } else if (dest == unit.getOwner()) {</span>
<span class="nc" id="L3150">                    newLoc = unit.getTile();</span>
                } else {
<span class="nc" id="L3152">                    newLoc = settlement.getTile();</span>
                }
<span class="nc bnc" id="L3154" title="All 2 branches missed.">                if (source.csChangeOwner(newUnit, dest, ChangeType.CAPTURE,</span>
                                         newLoc, cs)) {//-vis(both)
<span class="nc" id="L3156">                    newUnit.setMovesLeft(0);</span>
<span class="nc" id="L3157">                    cs.add(See.perhaps().always(former), oldTile);</span>
                }
<span class="nc" id="L3159">                visibilityChange = true;</span>
            }
<span class="nc" id="L3161">        }</span>
<span class="nc bnc" id="L3162" title="All 2 branches missed.">        if (visibilityChange) {</span>
<span class="nc" id="L3163">            srcPlayer.invalidateCanSeeTiles();//+vis(srcPlayer)</span>
<span class="nc" id="L3164">            dstPlayer.invalidateCanSeeTiles();//+vis(dstPlayer)</span>
        }
<span class="nc" id="L3166">        return true;</span>
    }

    /**
     * Handle first contact between European and native player.
     *
     * Note that we check for a diplomacy session, but do only bother
     * in the case of tile!=null as that is the only possibility for
     * some benefit.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param other The native &lt;code&gt;ServerPlayer&lt;/code&gt; to contact.
     * @param tile A &lt;code&gt;Tile&lt;/code&gt; on offer at first landing.
     * @param result Whether the initial peace treaty was accepted.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element nativeFirstContact(ServerPlayer serverPlayer,
                                      ServerPlayer other, Tile tile,
                                      boolean result) {
<span class="fc" id="L3185">        ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L3186" title="1 of 2 branches missed.">        if (result) {</span>
<span class="pc bpc" id="L3187" title="1 of 2 branches missed.">            if (tile != null) {</span>
<span class="nc" id="L3188">                Unit u = tile.getFirstUnit();</span>
<span class="nc" id="L3189">                Settlement s = tile.getOwningSettlement();</span>
<span class="nc" id="L3190">                DiplomacySession session</span>
<span class="nc" id="L3191">                    = TransactionSession.lookup(DiplomacySession.class, u, s);</span>
<span class="nc bnc" id="L3192" title="All 2 branches missed.">                if (session == null) {</span>
<span class="nc" id="L3193">                    return DOMMessage.clientError(&quot;No diplomacy in effect for: &quot;</span>
<span class="nc" id="L3194">                        + tile.getId());</span>
                }
<span class="nc" id="L3196">                tile.cacheUnseen();//+til</span>
<span class="nc" id="L3197">                tile.changeOwnership(serverPlayer, null);//-til</span>
<span class="nc" id="L3198">                cs.add(See.perhaps(), tile);</span>
<span class="nc" id="L3199">            }</span>
        } else {
            // Consider not accepting the treaty to be an insult and
            // ban missions.
<span class="nc" id="L3203">            other.csModifyTension(serverPlayer,</span>
                Tension.TENSION_ADD_MAJOR, cs);//+til
<span class="nc" id="L3205">            other.addMissionBan(serverPlayer);</span>
        }

<span class="fc" id="L3208">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L3209">        return cs.build(serverPlayer);</span>
    }


    /**
     * Process a European diplomacy session according to an agreement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; in the session.
     * @param otherPlayer The other &lt;code&gt;ServerPlayer&lt;/code&gt; in the session.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @param session The &lt;code&gt;DiplomacySession&lt;/code&gt; underway.
     * @param message A &lt;code&gt;DiplomacyMessage&lt;/code&gt; to send.
     * @param cs A &lt;code&gt;ChangeSet&lt;/code&gt; to contain the trade changes
     *     if accepted.
     * @return True if a new DiplomacyMessage reply needs to be sent.
     */
    private boolean csDiplomacySession(ServerPlayer serverPlayer,
                                       ServerPlayer otherPlayer,
                                       DiplomaticTrade agreement, 
                                       DiplomacySession session,
                                       DiplomacyMessage message,
                                       ChangeSet cs) {
        // Consider the status, process acceptance and rejection,
        // which need no further action.
<span class="nc" id="L3233">        TradeStatus status = agreement.getStatus();</span>
<span class="pc bnc" id="L3234" title="All 3 branches missed.">        switch (status) {</span>
        case PROPOSE_TRADE:
<span class="nc" id="L3236">            session.setAgreement(agreement);</span>
<span class="nc" id="L3237">            break;</span>
        case ACCEPT_TRADE:
            // Process the agreement that was sent!
<span class="nc" id="L3240">            agreement = session.getAgreement();</span>
<span class="nc" id="L3241">            agreement.setStatus(TradeStatus.ACCEPT_TRADE);</span>
<span class="nc bnc" id="L3242" title="All 2 branches missed.">            if (csAcceptTrade(agreement, session, cs)) {</span>
<span class="nc" id="L3243">                session.complete(cs);</span>
<span class="nc" id="L3244">                getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3245">                return false;</span>
            }
            // Trade was invalid, fall through into rejection.
        case REJECT_TRADE: default:
<span class="nc" id="L3249">            agreement = session.getAgreement();</span>
<span class="nc" id="L3250">            agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
<span class="nc" id="L3251">            session.complete(cs);</span>
<span class="nc" id="L3252">            getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3253">            return false;</span>
        }

        // Ask the other player to consider the agreement.
        // Treat a missing reply as a rejection.
<span class="nc" id="L3258">        DOMMessage reply = askTimeout(otherPlayer, message);</span>
<span class="nc bnc" id="L3259" title="All 2 branches missed.">        if (reply instanceof DiplomacyMessage) {</span>
<span class="nc" id="L3260">            agreement = ((DiplomacyMessage)reply).getAgreement();</span>
<span class="nc" id="L3261">            status = agreement.getStatus();</span>
        } else {
<span class="nc" id="L3263">            status = TradeStatus.REJECT_TRADE;</span>
<span class="nc" id="L3264">            agreement.setStatus(status);</span>
        }
<span class="nc" id="L3266">        agreement.incrementVersion();</span>

        // Process the result.  Always return true here as the serverPlayer
        // needs to be informed of the other player's response.
<span class="nc bnc" id="L3270" title="All 3 branches missed.">        switch (status) {</span>
        case PROPOSE_TRADE:
<span class="nc" id="L3272">            session.setAgreement(agreement);</span>
<span class="nc" id="L3273">            break;</span>
        case ACCEPT_TRADE:
<span class="nc" id="L3275">            agreement = session.getAgreement(); // Accept offered agreement</span>
<span class="nc" id="L3276">            agreement.setStatus(TradeStatus.ACCEPT_TRADE);</span>
<span class="nc bnc" id="L3277" title="All 2 branches missed.">            if (csAcceptTrade(agreement, session, cs)) {</span>
<span class="nc" id="L3278">                session.complete(cs);</span>
<span class="nc" id="L3279">                getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3280">                break;</span>
            }
            // Trade was invalid, fall through into rejection.
        case REJECT_TRADE: default:
<span class="nc" id="L3284">            agreement.setStatus(TradeStatus.REJECT_TRADE);</span>
<span class="nc" id="L3285">            session.setAgreement(agreement);</span>
<span class="nc" id="L3286">            session.complete(cs);</span>
<span class="nc" id="L3287">            getGame().sendToOthers(serverPlayer, cs);</span>
            break;
        }
<span class="nc" id="L3290">        return true;</span>
    }

    /**
     * Handle first contact between European players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param ourUnit Our &lt;code&gt;Unit&lt;/code&gt;.
     * @param otherUnit The other &lt;code&gt;unit&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element europeanFirstContact(ServerPlayer serverPlayer,
                                        Unit ourUnit, Unit otherUnit,
                                        DiplomaticTrade agreement) {
<span class="nc" id="L3305">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3306">        DiplomacySession session</span>
<span class="nc" id="L3307">            = TransactionSession.lookup(DiplomacySession.class, </span>
                                        ourUnit, otherUnit);
<span class="nc bnc" id="L3309" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3310">            session = TransactionSession.lookup(DiplomacySession.class,</span>
                                                otherUnit, ourUnit);
        }
<span class="nc bnc" id="L3313" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L3314" title="All 2 branches missed.">            if (agreement.getStatus() != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L3315">                return DOMMessage.clientError(&quot;Missing uu1-diplomacy session for &quot;</span>
<span class="nc" id="L3316">                    + ourUnit.getId() + &quot;,&quot; + otherUnit.getId()</span>
                    + &quot; with &quot; + agreement);
            }
<span class="nc" id="L3319">            session = new DiplomacySession(ourUnit, otherUnit);</span>
<span class="nc" id="L3320">            ourUnit.setMovesLeft(0);</span>
<span class="nc" id="L3321">            cs.addPartial(See.only(serverPlayer), ourUnit, &quot;movesLeft&quot;);</span>
        }
<span class="nc" id="L3323">        ServerPlayer otherPlayer = (ServerPlayer)otherUnit.getOwner();</span>
<span class="nc bnc" id="L3324" title="All 2 branches missed.">        if (csDiplomacySession(serverPlayer, otherPlayer,</span>
                agreement, session,
                new DiplomacyMessage(otherUnit, ourUnit, agreement), cs)) {
<span class="nc" id="L3327">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new DiplomacyMessage(ourUnit, otherUnit, 
<span class="nc" id="L3329">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L3331">        return cs.build(serverPlayer);</span>
    }

    /**
     * Handle first contact between European players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param ourUnit Our &lt;code&gt;Unit&lt;/code&gt;.
     * @param otherColony The other &lt;code&gt;Colony&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element europeanFirstContact(ServerPlayer serverPlayer,
                                        Unit ourUnit, Colony otherColony,
                                        DiplomaticTrade agreement) {
<span class="nc" id="L3346">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3347">        DiplomacySession session</span>
<span class="nc" id="L3348">            = TransactionSession.lookup(DiplomacySession.class,</span>
                                        ourUnit, otherColony);
<span class="nc bnc" id="L3350" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L3351" title="All 2 branches missed.">            if (agreement.getStatus() != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L3352">                return DOMMessage.clientError(&quot;Missing uc1-diplomacy session for &quot;</span>
<span class="nc" id="L3353">                    + ourUnit.getId() + &quot;,&quot; + otherColony.getId()</span>
                    + &quot; with &quot; + agreement);
            }
<span class="nc" id="L3356">            session = new DiplomacySession(ourUnit, otherColony);</span>
<span class="nc" id="L3357">            ourUnit.setMovesLeft(0);</span>
<span class="nc" id="L3358">            cs.addPartial(See.only(serverPlayer), ourUnit, &quot;movesLeft&quot;);</span>
        }
<span class="nc" id="L3360">        ServerPlayer otherPlayer = (ServerPlayer)otherColony.getOwner();</span>
<span class="nc bnc" id="L3361" title="All 2 branches missed.">        if (csDiplomacySession(serverPlayer, otherPlayer,</span>
                agreement, session,
                new DiplomacyMessage(otherColony, ourUnit, agreement), cs)) {
<span class="nc" id="L3364">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new DiplomacyMessage(ourUnit, otherColony, 
<span class="nc" id="L3366">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L3368">        return cs.build(serverPlayer);</span>
    }

    /**
     * Handle first contact between European players.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; making contact.
     * @param ourColony Our &lt;code&gt;Colony&lt;/code&gt;.
     * @param otherUnit The other &lt;code&gt;Unit&lt;/code&gt;.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element europeanFirstContact(ServerPlayer serverPlayer,
                                        Colony ourColony, Unit otherUnit,
                                        DiplomaticTrade agreement) {
<span class="nc" id="L3383">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3384">        DiplomacySession session</span>
<span class="nc" id="L3385">            = TransactionSession.lookup(DiplomacySession.class,</span>
                                        otherUnit, ourColony);
<span class="nc bnc" id="L3387" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3388">            return DOMMessage.clientError(&quot;Missing cu1-diplomacy session for &quot;</span>
<span class="nc" id="L3389">                + ourColony.getId() + &quot;,&quot; + otherUnit.getId()</span>
                + &quot; with &quot; + agreement);
        }
<span class="nc" id="L3392">        ServerPlayer otherPlayer = (ServerPlayer)otherUnit.getOwner();</span>
<span class="nc bnc" id="L3393" title="All 2 branches missed.">        if (csDiplomacySession(serverPlayer, otherPlayer,</span>
                agreement, session,
                new DiplomacyMessage(otherUnit, ourColony, agreement), cs)) {
<span class="nc" id="L3396">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new DiplomacyMessage(ourColony, otherUnit,
<span class="nc" id="L3398">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L3400">        return cs.build(serverPlayer);</span>
    }

    /**
     * Diplomacy.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param ourUnit The &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param otherColony The &lt;code&gt;Colony&lt;/code&gt; to trade with.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element diplomacy(ServerPlayer serverPlayer, Unit ourUnit,
                             Colony otherColony, DiplomaticTrade agreement) {
<span class="nc" id="L3414">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3415">        TradeStatus status = agreement.getStatus();</span>
<span class="nc" id="L3416">        DiplomacySession session</span>
<span class="nc" id="L3417">            = TransactionSession.lookup(DiplomacySession.class,</span>
                                        ourUnit, otherColony);
<span class="nc bnc" id="L3419" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc bnc" id="L3420" title="All 2 branches missed.">            if (status != TradeStatus.PROPOSE_TRADE) {</span>
<span class="nc" id="L3421">                return DOMMessage.clientError(&quot;Mission uc-diplomacy session for &quot;</span>
<span class="nc" id="L3422">                    + ourUnit.getId() + &quot;/&quot; + otherColony.getId()</span>
                    + &quot; with &quot; + agreement);
            }
<span class="nc" id="L3425">            session = new DiplomacySession(ourUnit, otherColony);</span>
        }
<span class="nc" id="L3427">        ServerPlayer otherPlayer = (ServerPlayer)otherColony.getOwner();</span>
<span class="nc bnc" id="L3428" title="All 2 branches missed.">        if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
                new DiplomacyMessage(otherColony, ourUnit, agreement), cs)) {
<span class="nc" id="L3430">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new DiplomacyMessage(ourUnit, otherColony, 
<span class="nc" id="L3432">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L3434">        return cs.build(serverPlayer);</span>
    }

    /**
     * Diplomacy.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is trading.
     * @param ourColony Our &lt;code&gt;Colony&lt;/code&gt;.
     * @param otherUnit The other &lt;code&gt;Unit&lt;/code&gt; that is trading.
     * @param agreement The &lt;code&gt;DiplomaticTrade&lt;/code&gt; to consider.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element diplomacy(ServerPlayer serverPlayer, Colony ourColony,
                             Unit otherUnit, DiplomaticTrade agreement) {
<span class="nc" id="L3448">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3449">        DiplomacySession session</span>
<span class="nc" id="L3450">            = TransactionSession.lookup(DiplomacySession.class,</span>
                                        otherUnit, ourColony);
<span class="nc bnc" id="L3452" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3453">            return DOMMessage.clientError(&quot;Mission cu-diplomacy session for &quot;</span>
<span class="nc" id="L3454">                + otherUnit.getId() + &quot;/&quot; + ourColony.getId()</span>
                + &quot; with &quot; + agreement);
        }
<span class="nc" id="L3457">        ServerPlayer otherPlayer = (ServerPlayer)otherUnit.getOwner();</span>
<span class="nc bnc" id="L3458" title="All 2 branches missed.">        if (csDiplomacySession(serverPlayer, otherPlayer, agreement, session,</span>
                new DiplomacyMessage(otherUnit, ourColony, agreement), cs)) {
<span class="nc" id="L3460">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                new DiplomacyMessage(ourColony, otherUnit,
<span class="nc" id="L3462">                                     session.getAgreement()));</span>
        }
<span class="nc" id="L3464">        return cs.build(serverPlayer);</span>
    }

    /**
     * Spy on a settlement.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is spying.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; that is spying.
     * @param settlement The &lt;code&gt;Settlement&lt;/code&gt; to spy on.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element spySettlement(ServerPlayer serverPlayer, Unit unit,
                                 Settlement settlement) {
<span class="nc" id="L3477">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L3479">        cs.addSpy(See.only(serverPlayer), settlement);</span>
<span class="nc" id="L3480">        unit.setMovesLeft(0);</span>
<span class="nc" id="L3481">        cs.addPartial(See.only(serverPlayer), unit, &quot;movesLeft&quot;);</span>
<span class="nc" id="L3482">        return cs.build(serverPlayer);</span>
    }


    /**
     * Change work location.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the work location of.
     * @param workLocation The &lt;code&gt;WorkLocation&lt;/code&gt; to change to.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element work(ServerPlayer serverPlayer, Unit unit,
                        WorkLocation workLocation) {
<span class="fc" id="L3496">        final Specification spec = getGame().getSpecification();</span>
<span class="fc" id="L3497">        final Colony colony = workLocation.getColony();</span>
<span class="fc" id="L3498">        colony.getGoodsContainer().saveState();</span>

<span class="fc" id="L3500">        ChangeSet cs = new ChangeSet();</span>
<span class="pc bpc" id="L3501" title="1 of 2 branches missed.">        if (workLocation instanceof ColonyTile) {</span>
<span class="fc" id="L3502">            Tile tile = ((ColonyTile) workLocation).getWorkTile();</span>
<span class="pc bpc" id="L3503" title="1 of 2 branches missed.">            if (tile.getOwningSettlement() != colony) {</span>
                // Claim known free land (because canAdd() succeeded).
<span class="nc" id="L3505">                serverPlayer.csClaimLand(tile, colony, 0, cs);</span>
            }
        }

<span class="fc" id="L3509">        colony.equipForRole(unit, spec.getDefaultRole(), 0);</span>

        // Check for upgrade.
<span class="fc" id="L3512">        UnitType newType = unit.getTypeChange(ChangeType.ENTER_COLONY,</span>
<span class="fc" id="L3513">                                              unit.getOwner());</span>
<span class="pc bpc" id="L3514" title="1 of 2 branches missed.">        if (newType != null) unit.changeType(newType);//-vis: safe in colony</span>

        // Change the location.
        // We could avoid updating the whole tile if we knew that this
        // was definitely a move between locations and no student/teacher
        // interaction occurred.
<span class="pc bpc" id="L3520" title="1 of 2 branches missed.">        if (!unit.isInColony()) unit.getColony().getTile().cacheUnseen();//+til</span>
<span class="fc" id="L3521">        unit.setLocation(workLocation);//-vis: safe/colony,-til if not in colony</span>
<span class="fc" id="L3522">        cs.add(See.perhaps(), colony.getTile());</span>
        // Others can see colony change size
<span class="fc" id="L3524">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="fc" id="L3525">        return cs.build(serverPlayer);</span>
    }


    /**
     * Loot cargo.
     *
     * Note loser is passed by identifier, as by the time we get here
     * the unit may have been sunk.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the winner.
     * @param winner The &lt;code&gt;Unit&lt;/code&gt; that looting.
     * @param loserId The object identifier of the &lt;code&gt;Unit&lt;/code&gt;
     *     that is looted.
     * @param loot The &lt;code&gt;Goods&lt;/code&gt; to loot.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element lootCargo(ServerPlayer serverPlayer, Unit winner,
                             String loserId, List&lt;Goods&gt; loot) {
<span class="nc" id="L3544">        LootSession session = TransactionSession.lookup(LootSession.class,</span>
<span class="nc" id="L3545">            winner.getId(), loserId);</span>
<span class="nc bnc" id="L3546" title="All 2 branches missed.">        if (session == null) {</span>
<span class="nc" id="L3547">            return DOMMessage.clientError(&quot;Bogus looting!&quot;);</span>
        }
<span class="nc bnc" id="L3549" title="All 2 branches missed.">        if (!winner.hasSpaceLeft()) {</span>
<span class="nc" id="L3550">            return DOMMessage.clientError(&quot;No space to loot to: &quot;</span>
<span class="nc" id="L3551">                + winner.getId());</span>
        }

<span class="nc" id="L3554">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3555">        List&lt;Goods&gt; available = session.getCapture();</span>
<span class="nc bnc" id="L3556" title="All 2 branches missed.">        if (loot == null) { // Initial inquiry</span>
<span class="nc" id="L3557">            cs.add(See.only(serverPlayer), ChangePriority.CHANGE_LATE,</span>
                   new LootCargoMessage(winner, loserId, available));
        } else {
<span class="nc bnc" id="L3560" title="All 2 branches missed.">            for (Goods g : loot) {</span>
<span class="nc bnc" id="L3561" title="All 2 branches missed.">                if (!available.contains(g)) {</span>
<span class="nc" id="L3562">                    return DOMMessage.clientError(&quot;Invalid loot: &quot; + g);</span>
                }
<span class="nc" id="L3564">                available.remove(g);</span>
<span class="nc bnc" id="L3565" title="All 2 branches missed.">                if (!winner.canAdd(g)) {</span>
<span class="nc" id="L3566">                    return DOMMessage.clientError(&quot;Loot failed: &quot; + g);</span>
                }
<span class="nc" id="L3568">                winner.add(g);</span>
<span class="nc" id="L3569">            }</span>

            // Others can see cargo capacity change.
<span class="nc" id="L3572">            session.complete(cs);</span>
<span class="nc" id="L3573">            cs.add(See.perhaps(), winner);</span>
<span class="nc" id="L3574">            getGame().sendToOthers(serverPlayer, cs);</span>
        }
<span class="nc" id="L3576">        return cs.build(serverPlayer);</span>
    }


    /**
     * Pay arrears.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; to pay the arrears for.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element payArrears(ServerPlayer serverPlayer, GoodsType type) {
<span class="nc" id="L3588">        int arrears = serverPlayer.getArrears(type);</span>
<span class="nc bnc" id="L3589" title="All 2 branches missed.">        if (arrears &lt;= 0) {</span>
<span class="nc" id="L3590">            return DOMMessage.clientError(&quot;No arrears for pay for: &quot;</span>
<span class="nc" id="L3591">                + type.getId());</span>
<span class="nc bnc" id="L3592" title="All 2 branches missed.">        } else if (!serverPlayer.checkGold(arrears)) {</span>
<span class="nc" id="L3593">            return DOMMessage.clientError(&quot;Not enough gold to pay arrears for: &quot;</span>
<span class="nc" id="L3594">                + type.getId());</span>
        }

<span class="nc" id="L3597">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3598">        Market market = serverPlayer.getMarket();</span>
<span class="nc" id="L3599">        serverPlayer.modifyGold(-arrears);</span>
<span class="nc" id="L3600">        market.setArrears(type, 0);</span>
<span class="nc" id="L3601">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3602">        cs.add(See.only(serverPlayer), market.getMarketData(type));</span>
        // Arrears payment is private.
<span class="nc" id="L3604">        return cs.build(serverPlayer);</span>
    }

    /**
     * Equip a unit for a specific role.
     * Currently the unit is either in Europe or in a settlement.
     * Might one day allow the unit to be on a tile co-located with
     * an equipment-bearing wagon.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to equip.
     * @param role The &lt;code&gt;Role&lt;/code&gt; to equip for.
     * @param roleCount The role count.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element equipForRole(ServerPlayer serverPlayer, Unit unit,
                                Role role, int roleCount) {
<span class="fc" id="L3621">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3622">        boolean ret = false;</span>
<span class="pc bpc" id="L3623" title="1 of 2 branches missed.">        if (unit.isInEurope()) {</span>
<span class="nc" id="L3624">            ServerEurope serverEurope = (ServerEurope)serverPlayer.getEurope();</span>
<span class="nc" id="L3625">            ret = serverEurope.csEquipForRole(unit, role, roleCount,</span>
                                              random, cs);
<span class="pc bpc" id="L3627" title="1 of 2 branches missed.">        } else if (unit.getColony() != null) {</span>
<span class="nc" id="L3628">            ServerColony serverColony = (ServerColony)unit.getColony();</span>
<span class="nc" id="L3629">            ret = serverColony.csEquipForRole(unit, role, roleCount,</span>
                                              random, cs);
<span class="pc bpc" id="L3631" title="1 of 2 branches missed.">        } else if (unit.getIndianSettlement() != null) {</span>
<span class="fc" id="L3632">            ServerIndianSettlement sis = (ServerIndianSettlement)unit.getIndianSettlement();</span>
<span class="fc" id="L3633">            ret = sis.csEquipForRole(unit, role, roleCount, random, cs);</span>
<span class="fc" id="L3634">        } else {</span>
<span class="nc" id="L3635">            return DOMMessage.clientError(&quot;Unsuitable equip location for: &quot;</span>
<span class="nc" id="L3636">                + unit.getId());</span>
        }
<span class="pc bpc" id="L3638" title="1 of 2 branches missed.">        if (!ret) return null;</span>

<span class="pc bpc" id="L3640" title="1 of 2 branches missed.">        if (unit.getInitialMovesLeft() != unit.getMovesLeft()) {</span>
<span class="fc" id="L3641">            unit.setMovesLeft(0);</span>
        }
<span class="fc" id="L3643">        Unit carrier = unit.getCarrier();</span>
<span class="pc bpc" id="L3644" title="1 of 2 branches missed.">        if (carrier != null</span>
<span class="nc bnc" id="L3645" title="All 2 branches missed.">            &amp;&amp; carrier.getInitialMovesLeft() != carrier.getMovesLeft()</span>
<span class="nc bnc" id="L3646" title="All 2 branches missed.">            &amp;&amp; carrier.getMovesLeft() != 0) {</span>
<span class="nc" id="L3647">            carrier.setMovesLeft(0);</span>
        }
<span class="fc" id="L3649">        return cs.build(serverPlayer);</span>
    }

    /**
     * Pay for a building.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the
     *     colony.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; that is building.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element payForBuilding(ServerPlayer serverPlayer, Colony colony) {
<span class="nc" id="L3661">        if (!getGame().getSpecification()</span>
<span class="nc bnc" id="L3662" title="All 2 branches missed.">            .getBoolean(GameOptions.PAY_FOR_BUILDING)) {</span>
<span class="nc" id="L3663">            return DOMMessage.clientError(&quot;Pay for building is disabled&quot;);</span>
        }

<span class="nc" id="L3666">        BuildableType build = colony.getCurrentlyBuilding();</span>
<span class="nc bnc" id="L3667" title="All 2 branches missed.">        if (build == null) {</span>
<span class="nc" id="L3668">            return DOMMessage.clientError(&quot;Colony &quot; + colony.getId()</span>
                + &quot; is not building anything!&quot;);
        }
<span class="nc" id="L3671">        List&lt;AbstractGoods&gt; required = colony.getRequiredGoods(build);</span>
<span class="nc" id="L3672">        int price = colony.priceGoodsForBuilding(required);</span>
<span class="nc bnc" id="L3673" title="All 2 branches missed.">        if (!serverPlayer.checkGold(price)) {</span>
<span class="nc" id="L3674">            return DOMMessage.clientError(&quot;Insufficient funds to pay for build.&quot;);</span>
        }

        // Save the correct final gold for the player, as we are going to
        // use buy() below, but it deducts the normal uninflated price for
        // the goods being bought.  We restore this correct amount later.
<span class="nc" id="L3680">        int savedGold = serverPlayer.modifyGold(-price);</span>
<span class="nc" id="L3681">        serverPlayer.modifyGold(price);</span>

<span class="nc" id="L3683">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3684">        GoodsContainer container = colony.getGoodsContainer();</span>
<span class="nc" id="L3685">        container.saveState();</span>
<span class="nc bnc" id="L3686" title="All 2 branches missed.">        for (AbstractGoods ag : required) {</span>
<span class="nc" id="L3687">            GoodsType type = ag.getType();</span>
<span class="nc" id="L3688">            int amount = ag.getAmount();</span>
<span class="nc bnc" id="L3689" title="All 2 branches missed.">            if (type.isStorable()) {</span>
                // FIXME: should also check canTrade(type, Access.?)
<span class="nc bnc" id="L3691" title="All 2 branches missed.">                if ((amount = serverPlayer.buy(container, type, amount)) &lt; 0) {</span>
<span class="nc" id="L3692">                    return DOMMessage.clientError(&quot;Can not buy &quot; + amount</span>
                        + &quot; &quot; + type + &quot; for &quot; + build);
                }
<span class="nc" id="L3695">                serverPlayer.propagateToEuropeanMarkets(type, -amount, random);</span>
<span class="nc" id="L3696">                serverPlayer.csFlushMarket(type, cs);</span>
            } else {
<span class="nc" id="L3698">                container.addGoods(type, amount);</span>
            }
<span class="nc" id="L3700">        }</span>
<span class="nc" id="L3701">        colony.invalidateCache();</span>

        // Nothing to see for others, colony internal.
<span class="nc" id="L3704">        serverPlayer.setGold(savedGold);</span>
<span class="nc" id="L3705">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3706">        cs.add(See.only(serverPlayer), container);</span>
<span class="nc" id="L3707">        return cs.build(serverPlayer);</span>
    }


    /**
     * Indians making demands of a colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is demanding.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; making the demands.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; that is demanded of.
     * @param type The &lt;code&gt;GoodsType&lt;/code&gt; being demanded, null
     *     implies gold.
     * @param amount The amount of goods/gold being demanded.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element indianDemand(final ServerPlayer serverPlayer, Unit unit,
                                Colony colony, GoodsType type, int amount) {
<span class="nc" id="L3724">        final Game game = getGame();</span>
<span class="nc" id="L3725">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L3726">        ServerPlayer victim = (ServerPlayer) colony.getOwner();</span>
<span class="nc" id="L3727">        int difficulty = spec.getInteger(GameOptions.NATIVE_DEMANDS);</span>
<span class="nc" id="L3728">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L3730">        DOMMessage reply = askTimeout(victim,</span>
            new IndianDemandMessage(unit, colony, type, amount));
<span class="nc bnc" id="L3732" title="All 2 branches missed.">        boolean result = (reply instanceof IndianDemandMessage)</span>
<span class="nc" id="L3733">            ? ((IndianDemandMessage)reply).getResult()</span>
            : false;
<span class="nc bnc" id="L3735" title="All 2 branches missed.">        logger.info(serverPlayer.getName() + &quot; unit &quot; + unit</span>
            + &quot; demands &quot; + amount + &quot; &quot; + ((type == null) ? &quot;gold&quot; : type)
<span class="nc" id="L3737">            + &quot; from &quot; + colony.getName() + &quot; accepted: &quot; + result);</span>

<span class="nc" id="L3739">        IndianDemandMessage message = new IndianDemandMessage(unit, colony,</span>
                                                              type, amount);
<span class="nc" id="L3741">        message.setResult(result);</span>
<span class="nc" id="L3742">        cs.add(See.only(serverPlayer), ChangePriority.CHANGE_NORMAL, message);</span>
<span class="nc bnc" id="L3743" title="All 2 branches missed.">        if (result) {</span>
<span class="nc bnc" id="L3744" title="All 2 branches missed.">            if (type == null) {</span>
<span class="nc" id="L3745">                victim.modifyGold(-amount);</span>
<span class="nc" id="L3746">                serverPlayer.modifyGold(amount);</span>
<span class="nc" id="L3747">                cs.addPartial(See.only(victim), victim, &quot;gold&quot;);</span>
                //cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);
            } else {
<span class="nc" id="L3750">                GoodsContainer colonyContainer = colony.getGoodsContainer();</span>
<span class="nc" id="L3751">                colonyContainer.saveState();</span>
<span class="nc" id="L3752">                GoodsContainer unitContainer = unit.getGoodsContainer();</span>
<span class="nc" id="L3753">                unitContainer.saveState();</span>
<span class="nc" id="L3754">                moveGoods(colony, type, amount, unit);</span>
<span class="nc" id="L3755">                cs.add(See.only(victim), colonyContainer);</span>
                //cs.add(See.only(serverPlayer), unitContainer);
            }
<span class="nc" id="L3758">            int tension = -(5 - difficulty) * 50;</span>
<span class="nc" id="L3759">            ServerIndianSettlement is = (ServerIndianSettlement)</span>
<span class="nc" id="L3760">                unit.getHomeIndianSettlement();</span>
<span class="nc bnc" id="L3761" title="All 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L3762">                serverPlayer.csModifyTension(victim, tension, cs);</span>
            } else {
<span class="nc" id="L3764">                is.csModifyAlarm(victim, tension, true, cs);</span>
            }
        }

<span class="nc" id="L3768">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3769">        return cs.build(serverPlayer);</span>
    }


    /**
     * Train a unit in Europe.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is demanding.
     * @param type The &lt;code&gt;UnitType&lt;/code&gt; to train.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element trainUnitInEurope(ServerPlayer serverPlayer, UnitType type) {

<span class="nc" id="L3782">        Europe europe = serverPlayer.getEurope();</span>
<span class="nc bnc" id="L3783" title="All 2 branches missed.">        if (europe == null) {</span>
<span class="nc" id="L3784">            return DOMMessage.clientError(&quot;No Europe to train in.&quot;);</span>
        }
<span class="nc" id="L3786">        int price = europe.getUnitPrice(type);</span>
<span class="nc bnc" id="L3787" title="All 2 branches missed.">        if (price &lt;= 0) {</span>
<span class="nc" id="L3788">            return DOMMessage.clientError(&quot;Bogus price: &quot; + price);</span>
<span class="nc bnc" id="L3789" title="All 2 branches missed.">        } else if (!serverPlayer.checkGold(price)) {</span>
<span class="nc" id="L3790">            return DOMMessage.clientError(&quot;Not enough gold (&quot;</span>
<span class="nc" id="L3791">                + serverPlayer.getGold() + &quot; &lt; &quot; + price</span>
                + &quot;) to train &quot; + type);
        }

<span class="nc" id="L3795">        final Game game = getGame();</span>
<span class="nc" id="L3796">        final Specification spec = game.getSpecification();</span>
<span class="nc bnc" id="L3797" title="All 2 branches missed.">        Role role = (spec.getBoolean(GameOptions.EQUIP_EUROPEAN_RECRUITS))</span>
<span class="nc" id="L3798">            ? type.getDefaultRole()</span>
<span class="nc" id="L3799">            : spec.getDefaultRole();</span>
<span class="nc" id="L3800">        Unit unit = new ServerUnit(game, europe, serverPlayer, type,</span>
                                   role);//-vis: safe, Europe
<span class="nc" id="L3802">        unit.setName(serverPlayer.getNameForUnit(type, random));</span>
<span class="nc" id="L3803">        serverPlayer.modifyGold(-price);</span>
<span class="nc" id="L3804">        ((ServerEurope)europe).increasePrice(type, price);</span>

        // Only visible in Europe
<span class="nc" id="L3807">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3808">        cs.addPartial(See.only(serverPlayer), serverPlayer, &quot;gold&quot;);</span>
<span class="nc" id="L3809">        cs.add(See.only(serverPlayer), europe);</span>
<span class="nc" id="L3810">        return cs.build(serverPlayer);</span>
    }


    /**
     * Set build queue.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the colony.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to set the queue of.
     * @param queue The new build queue.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element setBuildQueue(ServerPlayer serverPlayer, Colony colony,
                                 List&lt;BuildableType&gt; queue) {
<span class="fc" id="L3824">        BuildableType current = colony.getCurrentlyBuilding();</span>
<span class="fc" id="L3825">        colony.setBuildQueue(queue);</span>
<span class="fc" id="L3826">        if (getGame().getSpecification()</span>
<span class="pc bpc" id="L3827" title="1 of 2 branches missed.">            .getBoolean(GameOptions.CLEAR_HAMMERS_ON_CONSTRUCTION_SWITCH)</span>
<span class="nc bnc" id="L3828" title="All 2 branches missed.">            &amp;&amp; current != colony.getCurrentlyBuilding()) {</span>
<span class="nc bnc" id="L3829" title="All 2 branches missed.">            for (AbstractGoods ag : current.getRequiredGoods()) {</span>
<span class="nc bnc" id="L3830" title="All 2 branches missed.">                if (!ag.getType().isStorable()) {</span>
<span class="nc" id="L3831">                    colony.removeGoods(ag.getType());</span>
                }
<span class="nc" id="L3833">            }</span>
        }
<span class="fc" id="L3835">        colony.invalidateCache();</span>

        // Only visible to player.
<span class="fc" id="L3838">        ChangeSet cs = new ChangeSet();</span>
<span class="fc" id="L3839">        cs.add(See.only(serverPlayer), colony);</span>
<span class="fc" id="L3840">        return cs.build(serverPlayer);</span>
    }


    /**
     * Set goods levels.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the colony.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to set the goods levels in.
     * @param exportData The new &lt;code&gt;ExportData&lt;/code&gt;.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element setGoodsLevels(ServerPlayer serverPlayer, Colony colony,
                                  ExportData exportData) {
<span class="nc" id="L3854">        colony.setExportData(exportData);</span>
<span class="nc" id="L3855">        return new ChangeSet().add(See.only(serverPlayer), colony)</span>
<span class="nc" id="L3856">            .build(serverPlayer);</span>
    }


    /**
     * Put outside colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to be put out.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element putOutsideColony(ServerPlayer serverPlayer, Unit unit) {
<span class="nc" id="L3868">        Tile tile = unit.getTile();</span>
<span class="nc" id="L3869">        Colony colony = unit.getColony();</span>
<span class="nc bnc" id="L3870" title="All 2 branches missed.">        if (unit.isInColony()) tile.cacheUnseen();//+til</span>
<span class="nc" id="L3871">        unit.setLocation(tile);//-vis: safe/colony,-til if in colony</span>

        // Full tile update for the player, the rest get their limited
        // view of the colony so that population changes.
<span class="nc" id="L3875">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L3876">        cs.add(See.only(serverPlayer), tile);</span>
<span class="nc" id="L3877">        cs.add(See.perhaps().except(serverPlayer), colony);</span>
<span class="nc" id="L3878">        return cs.build(serverPlayer);</span>
    }


    /**
     * Change work type.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the work type of.
     * @param type The new &lt;code&gt;GoodsType&lt;/code&gt; to produce.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element changeWorkType(ServerPlayer serverPlayer, Unit unit,
                                  GoodsType type) {
<span class="pc bpc" id="L3892" title="1 of 2 branches missed.">        if (unit.getWorkType() != type) {</span>
<span class="fc" id="L3893">            unit.setExperience(0);</span>
<span class="fc" id="L3894">            unit.changeWorkType(type);</span>
        }

        // Private update of the colony.
<span class="fc" id="L3898">        return new ChangeSet().add(See.only(serverPlayer), unit.getColony())</span>
<span class="fc" id="L3899">            .build(serverPlayer);</span>
    }


    /**
     * Change improvement work type.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the work type of.
     * @param type The new &lt;code&gt;TileImprovementType&lt;/code&gt; to produce.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element changeWorkImprovementType(ServerPlayer serverPlayer,
                                             Unit unit,
                                             TileImprovementType type) {
<span class="fc" id="L3914">        Tile tile = unit.getTile();</span>
<span class="fc" id="L3915">        TileImprovement improvement = tile.getTileImprovement(type);</span>
<span class="fc bfc" id="L3916" title="All 2 branches covered.">        if (improvement == null) { // Create the new improvement.</span>
<span class="fc" id="L3917">            improvement = new TileImprovement(getGame(), tile, type);</span>
<span class="fc" id="L3918">            tile.add(improvement);</span>
        }

<span class="fc" id="L3921">        unit.setWorkImprovement(improvement);</span>
<span class="fc" id="L3922">        unit.setState(UnitState.IMPROVING);</span>

        // Private update of the tile.
<span class="fc" id="L3925">        return new ChangeSet().add(See.only(serverPlayer), tile)</span>
<span class="fc" id="L3926">            .build(serverPlayer);</span>
    }


    /**
     * Change a units state.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The &lt;code&gt;Unit&lt;/code&gt; to change the state of.
     * @param state The new &lt;code&gt;UnitState&lt;/code&gt;.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element changeState(ServerPlayer serverPlayer, Unit unit,
                               UnitState state) {
<span class="nc" id="L3940">        ChangeSet cs = new ChangeSet();</span>

<span class="nc" id="L3942">        Tile tile = unit.getTile();</span>
<span class="nc bnc" id="L3943" title="All 4 branches missed.">        boolean tileDirty = tile != null &amp;&amp; tile.getIndianSettlement() != null;</span>
<span class="nc bnc" id="L3944" title="All 4 branches missed.">        if (state == UnitState.FORTIFYING &amp;&amp; tile != null) {</span>
<span class="nc bnc" id="L3945" title="All 2 branches missed.">            ServerColony colony = (tile.getOwningSettlement() instanceof Colony)</span>
<span class="nc" id="L3946">                ? (ServerColony) tile.getOwningSettlement()</span>
                : null;
<span class="nc bnc" id="L3948" title="All 2 branches missed.">            Player owner = (colony == null) ? null : colony.getOwner();</span>
<span class="nc bnc" id="L3949" title="All 2 branches missed.">            if (owner != null</span>
<span class="nc bnc" id="L3950" title="All 2 branches missed.">                &amp;&amp; owner != unit.getOwner()</span>
<span class="nc bnc" id="L3951" title="All 2 branches missed.">                &amp;&amp; serverPlayer.getStance(owner) != Stance.ALLIANCE</span>
<span class="nc bnc" id="L3952" title="All 2 branches missed.">                &amp;&amp; serverPlayer.getStance(owner) != Stance.PEACE) {</span>
<span class="nc bnc" id="L3953" title="All 2 branches missed.">                if (colony.isTileInUse(tile)) {</span>
<span class="nc" id="L3954">                    colony.csEvictUsers(unit, cs);</span>
                }
<span class="nc bnc" id="L3956" title="All 2 branches missed.">                if (serverPlayer.getStance(owner) == Stance.WAR) {</span>
<span class="nc" id="L3957">                    tile.changeOwnership(null, null); // Clear owner if at war</span>
<span class="nc" id="L3958">                    tileDirty = true;</span>
                }
            }
        }

<span class="nc" id="L3963">        unit.setState(state);</span>
<span class="nc bnc" id="L3964" title="All 2 branches missed.">        if (tileDirty) {</span>
<span class="nc" id="L3965">            cs.add(See.perhaps(), tile);</span>
        } else {
<span class="nc" id="L3967">            cs.add(See.perhaps(), (FreeColGameObject)unit.getLocation());</span>
        }

        // Others might be able to see the unit.
<span class="nc" id="L3971">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L3972">        return cs.build(serverPlayer);</span>
    }


    /**
     * Assign a student to a teacher.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param student The student &lt;code&gt;Unit&lt;/code&gt;.
     * @param teacher The teacher &lt;code&gt;Unit&lt;/code&gt;.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element assignTeacher(ServerPlayer serverPlayer, Unit student,
                                 Unit teacher) {
<span class="nc" id="L3986">        Unit oldStudent = teacher.getStudent();</span>
<span class="nc" id="L3987">        Unit oldTeacher = student.getTeacher();</span>

        // Only update units that changed their teaching situation.
<span class="nc" id="L3990">        ChangeSet cs = new ChangeSet();</span>
<span class="nc bnc" id="L3991" title="All 2 branches missed.">        if (oldTeacher != null) {</span>
<span class="nc" id="L3992">            oldTeacher.setStudent(null);</span>
<span class="nc" id="L3993">            cs.add(See.only(serverPlayer), oldTeacher);</span>
        }
<span class="nc bnc" id="L3995" title="All 2 branches missed.">        if (oldStudent != null) {</span>
<span class="nc" id="L3996">            oldStudent.setTeacher(null);</span>
<span class="nc" id="L3997">            cs.add(See.only(serverPlayer), oldStudent);</span>
        }
<span class="nc" id="L3999">        teacher.setStudent(student);</span>
<span class="nc" id="L4000">        teacher.changeWorkType(null);</span>
<span class="nc" id="L4001">        student.setTeacher(teacher);</span>
<span class="nc" id="L4002">        cs.add(See.only(serverPlayer), student, teacher);</span>
<span class="nc" id="L4003">        return cs.build(serverPlayer);</span>
    }


    /**
     * Assign a trade route to a unit.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that owns the unit.
     * @param unit The unit &lt;code&gt;Unit&lt;/code&gt; to assign to.
     * @param tradeRoute The &lt;code&gt;TradeRoute&lt;/code&gt; to assign.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element assignTradeRoute(ServerPlayer serverPlayer, Unit unit,
                                    TradeRoute tradeRoute) {
        // If clearing a trade route and the unit is at sea, set
        // the destination to the next stop.  Otherwise just clear
        // the destination.
        TradeRouteStop stop;
<span class="nc bnc" id="L4021" title="All 4 branches missed.">        unit.setDestination((tradeRoute == null &amp;&amp; unit.isAtSea()</span>
<span class="nc bnc" id="L4022" title="All 2 branches missed.">                &amp;&amp; (stop = unit.getStop()) != null) ? stop.getLocation()</span>
            : null);
<span class="nc" id="L4024">        unit.setTradeRoute(tradeRoute);</span>
<span class="nc bnc" id="L4025" title="All 2 branches missed.">        if (tradeRoute != null) {</span>
<span class="nc" id="L4026">            List&lt;TradeRouteStop&gt; stops = tradeRoute.getStops();</span>
<span class="nc" id="L4027">            int found = -1;</span>
<span class="nc bnc" id="L4028" title="All 2 branches missed.">            for (int i = 0; i &lt; stops.size(); i++) {</span>
<span class="nc bnc" id="L4029" title="All 2 branches missed.">                if (Map.isSameLocation(unit.getLocation(),</span>
<span class="nc" id="L4030">                                       stops.get(i).getLocation())) {</span>
<span class="nc" id="L4031">                    found = i;</span>
<span class="nc" id="L4032">                    break;</span>
                }
            }
<span class="nc bnc" id="L4035" title="All 2 branches missed.">            if (found &lt; 0) found = 0;</span>
<span class="nc" id="L4036">            unit.setCurrentStop(found);</span>
        }

        // Only visible to the player
<span class="nc" id="L4040">        return new ChangeSet().add(See.only(serverPlayer), unit)</span>
<span class="nc" id="L4041">            .build(serverPlayer);</span>
    }

    /**
     * Set trade routes for a player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to set trade
     *    routes for.
     * @param routes The new list of &lt;code&gt;TradeRoute&lt;/code&gt;s.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element setTradeRoutes(ServerPlayer serverPlayer,
                                  List&lt;TradeRoute&gt; routes) {
<span class="nc" id="L4054">        serverPlayer.setTradeRoutes(routes);</span>
        // Have to update the whole player alas.
<span class="nc" id="L4056">        return new ChangeSet().add(See.only(serverPlayer), serverPlayer)</span>
<span class="nc" id="L4057">            .build(serverPlayer);</span>
    }

    /**
     * Get a new trade route for a player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to get a trade
     *    route for.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element getNewTradeRoute(ServerPlayer serverPlayer) {
<span class="nc" id="L4068">        List&lt;TradeRoute&gt; routes = serverPlayer.getTradeRoutes();</span>
<span class="nc" id="L4069">        TradeRoute route = new TradeRoute(getGame(), </span>
<span class="nc" id="L4070">            serverPlayer.getNameForTradeRoute(), serverPlayer);</span>
<span class="nc" id="L4071">        routes.add(route);</span>
<span class="nc" id="L4072">        return new ChangeSet().addTradeRoute(serverPlayer, route)</span>
<span class="nc" id="L4073">            .build(serverPlayer);</span>
    }


    /**
     * Get a list of abstract REF units for a player.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; to query the REF of.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element getREFUnits(ServerPlayer serverPlayer) {
<span class="nc" id="L4084">        final Game game = getGame();</span>
<span class="nc" id="L4085">        final Specification spec = game.getSpecification();</span>
<span class="nc" id="L4086">        List&lt;AbstractUnit&gt; units = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L4087">        final UnitType defaultType = spec.getDefaultUnitType(serverPlayer);</span>

<span class="nc bnc" id="L4089" title="All 2 branches missed.">        if (serverPlayer.getPlayerType() == PlayerType.COLONIAL) {</span>
<span class="nc" id="L4090">            units = serverPlayer.getMonarch().getExpeditionaryForce().getUnits();</span>
        } else {
<span class="nc" id="L4092">            ServerPlayer REFPlayer = (ServerPlayer) serverPlayer.getREFPlayer();</span>
<span class="nc" id="L4093">            java.util.Map&lt;UnitType, HashMap&lt;String, Integer&gt;&gt; unitHash</span>
                = new HashMap&lt;&gt;();
<span class="nc bnc" id="L4095" title="All 2 branches missed.">            for (Unit unit : REFPlayer.getUnits()) {</span>
<span class="nc bnc" id="L4096" title="All 2 branches missed.">                if (unit.isOffensiveUnit()) {</span>
<span class="nc" id="L4097">                    UnitType unitType = defaultType;</span>
<span class="nc bnc" id="L4098" title="All 2 branches missed.">                    if (unit.getType().getOffence() &gt; 0</span>
<span class="nc bnc" id="L4099" title="All 2 branches missed.">                        || unit.hasAbility(Ability.EXPERT_SOLDIER)) {</span>
<span class="nc" id="L4100">                        unitType = unit.getType();</span>
                    }
<span class="nc" id="L4102">                    HashMap&lt;String, Integer&gt; roleMap = unitHash.get(unitType);</span>
<span class="nc bnc" id="L4103" title="All 2 branches missed.">                    if (roleMap == null) roleMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4104">                    String roleId = unit.getRole().getId();</span>
<span class="nc" id="L4105">                    Integer count = roleMap.get(roleId);</span>
<span class="nc bnc" id="L4106" title="All 2 branches missed.">                    roleMap.put(roleId, (count == null) ? 1</span>
<span class="nc" id="L4107">                            : count + 1);</span>
<span class="nc" id="L4108">                    unitHash.put(unitType, roleMap);</span>
                }
<span class="nc" id="L4110">            }</span>
<span class="nc bnc" id="L4111" title="All 2 branches missed.">            for (java.util.Map.Entry&lt;UnitType, HashMap&lt;String, Integer&gt;&gt; typeEntry : unitHash.entrySet()) {</span>
<span class="nc bnc" id="L4112" title="All 2 branches missed.">                for (java.util.Map.Entry&lt;String, Integer&gt; roleEntry : typeEntry.getValue().entrySet()) {</span>
<span class="nc" id="L4113">                    units.add(new AbstractUnit(typeEntry.getKey(), roleEntry.getKey(), roleEntry.getValue()));</span>
<span class="nc" id="L4114">                }</span>
<span class="nc" id="L4115">            }</span>
        }

<span class="nc" id="L4118">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4119">        cs.addTrivial(See.only(serverPlayer), &quot;getREFUnits&quot;,</span>
                      ChangePriority.CHANGE_NORMAL);
<span class="nc" id="L4121">        Element reply = cs.build(serverPlayer);</span>
        // FIXME: eliminate explicit Element hackery
<span class="nc bnc" id="L4123" title="All 2 branches missed.">        for (AbstractUnit unit : units) {</span>
<span class="nc" id="L4124">            reply.appendChild(unit.toXMLElement(reply.getOwnerDocument()));</span>
<span class="nc" id="L4125">        }</span>
<span class="nc" id="L4126">        return reply;</span>
    }


    /**
     * Gets the list of high scores.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is querying.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element getHighScores(ServerPlayer serverPlayer) {
<span class="nc" id="L4137">        List&lt;HighScore&gt; scores = HighScore.loadHighScores();</span>
<span class="nc" id="L4138">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4139">        cs.addTrivial(See.only(serverPlayer), &quot;getHighScores&quot;,</span>
                      ChangePriority.CHANGE_NORMAL);
<span class="nc" id="L4141">        Element reply = cs.build(serverPlayer);</span>
<span class="nc bnc" id="L4142" title="All 2 branches missed.">        if (scores != null) {</span>
<span class="nc bnc" id="L4143" title="All 2 branches missed.">            for (HighScore score : scores) {</span>
<span class="nc" id="L4144">                reply.appendChild(score.toXMLElement(reply.getOwnerDocument()));</span>
<span class="nc" id="L4145">            }</span>
        }
<span class="nc" id="L4147">        return reply;</span>
    }


    /**
     * Chat.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is chatting.
     * @param message The chat message.
     * @param pri A privacy setting, currently a noop.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element chat(ServerPlayer serverPlayer, String message,
                        boolean pri) {
<span class="nc" id="L4161">        getGame().sendToOthers(serverPlayer, new ChangeSet()</span>
<span class="nc" id="L4162">            .add(See.all().except(serverPlayer),</span>
                 ChangeSet.ChangePriority.CHANGE_NORMAL,
                 new ChatMessage(serverPlayer, message, false)));
<span class="nc" id="L4165">        return null;</span>
    }

    /**
     * Get the current game statistics.
     *
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element getStatistics(ServerPlayer serverPlayer) {
        // Convert statistics map to a list.
<span class="nc" id="L4175">        java.util.Map&lt;String, String&gt; stats = getGame()</span>
<span class="nc" id="L4176">            .getStatistics();</span>

<span class="nc" id="L4178">        stats.putAll(getFreeColServer().getAIMain().getAIStatistics());</span>

<span class="nc" id="L4180">        List&lt;String&gt; all = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L4181" title="All 2 branches missed.">        for (Entry&lt;String, String&gt; e : mapEntriesByKey(stats)) {</span>
<span class="nc" id="L4182">            all.add(e.getKey());</span>
<span class="nc" id="L4183">            all.add(e.getValue());</span>
<span class="nc" id="L4184">        }</span>

        // Return as statistics element.
<span class="nc" id="L4187">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4188">        cs.addTrivial(See.only(serverPlayer), &quot;statistics&quot;,</span>
                      ChangePriority.CHANGE_NORMAL,
<span class="nc" id="L4190">                      all.toArray(new String[0]));</span>
<span class="nc" id="L4191">        return cs.build(serverPlayer);</span>
    }

    /**
     * Enters revenge mode against those evil AIs.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; entering revenge mode.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element enterRevengeMode(ServerPlayer serverPlayer) {
<span class="nc bnc" id="L4201" title="All 2 branches missed.">        if (!getFreeColServer().getSinglePlayer()) {</span>
<span class="nc" id="L4202">            return DOMMessage.clientError(&quot;Can not enter revenge mode,&quot;</span>
                + &quot; as this is not a single player game.&quot;);
        }
<span class="nc" id="L4205">        Game game = getGame();</span>
<span class="nc" id="L4206">        List&lt;UnitType&gt; undeads = game.getSpecification()</span>
<span class="nc" id="L4207">            .getUnitTypesWithAbility(Ability.UNDEAD);</span>
<span class="nc" id="L4208">        List&lt;UnitType&gt; navalUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L4209">        List&lt;UnitType&gt; landUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L4210" title="All 2 branches missed.">        for (UnitType undead : undeads) {</span>
<span class="nc bnc" id="L4211" title="All 2 branches missed.">            if (undead.hasAbility(Ability.NAVAL_UNIT)) {</span>
<span class="nc" id="L4212">                navalUnits.add(undead);</span>
<span class="nc bnc" id="L4213" title="All 2 branches missed.">            } else if (undead.hasAbility(Ability.MULTIPLE_ATTACKS)) {</span>
<span class="nc" id="L4214">                landUnits.add(undead);</span>
            }
<span class="nc" id="L4216">        }</span>
<span class="nc bnc" id="L4217" title="All 4 branches missed.">        if (navalUnits.isEmpty() || landUnits.isEmpty()) {</span>
<span class="nc" id="L4218">            return DOMMessage.clientError(&quot;Can not enter revenge mode,&quot;</span>
                + &quot; because we can not find the undead units.&quot;);
        }

<span class="nc" id="L4222">        ChangeSet cs = new ChangeSet();</span>
<span class="nc" id="L4223">        UnitType navalType = getRandomMember(logger, &quot;Choose undead navy&quot;,</span>
                                             navalUnits, random);
<span class="nc" id="L4225">        Tile start = ((Tile)serverPlayer.getEntryLocation())</span>
<span class="nc" id="L4226">            .getSafeTile(serverPlayer, random);</span>
<span class="nc" id="L4227">        Unit theFlyingDutchman</span>
            = new ServerUnit(game, start, serverPlayer,
                             navalType);//-vis(serverPlayer)
<span class="nc" id="L4230">        UnitType landType = getRandomMember(logger, &quot;Choose undead army&quot;,</span>
                                            landUnits, random);
<span class="nc" id="L4232">        new ServerUnit(game, theFlyingDutchman, serverPlayer, landType);//-vis</span>
<span class="nc" id="L4233">        serverPlayer.setDead(false);</span>
<span class="nc" id="L4234">        serverPlayer.changePlayerType(PlayerType.UNDEAD);</span>
<span class="nc" id="L4235">        serverPlayer.invalidateCanSeeTiles();//+vis(serverPlayer)</span>

        // No one likes the undead.
<span class="nc bnc" id="L4238" title="All 2 branches missed.">        for (Player p : game.getLivePlayers(serverPlayer)) {</span>
<span class="nc bnc" id="L4239" title="All 2 branches missed.">            if (serverPlayer.hasContacted(p)) {</span>
<span class="nc" id="L4240">                serverPlayer.csChangeStance(Stance.WAR, (ServerPlayer)p,</span>
                                            true, cs);
            }
<span class="nc" id="L4243">        }</span>

        // Revenge begins
<span class="nc" id="L4246">        game.setCurrentPlayer(serverPlayer);</span>
<span class="nc" id="L4247">        cs.addTrivial(See.all(), &quot;setCurrentPlayer&quot;,</span>
                      ChangePriority.CHANGE_LATE,
<span class="nc" id="L4249">                      &quot;player&quot;, serverPlayer.getId());</span>

        // Others can tell something has happened to the player,
        // and possibly see the units.
<span class="nc" id="L4253">        cs.add(See.all(), serverPlayer);</span>
<span class="nc" id="L4254">        cs.add(See.perhaps(), start);</span>
<span class="nc" id="L4255">        getGame().sendToOthers(serverPlayer, cs);</span>
<span class="nc" id="L4256">        return cs.build(serverPlayer);</span>
    }


    /**
     * Rearrange a colony.
     *
     * @param serverPlayer The &lt;code&gt;ServerPlayer&lt;/code&gt; that is querying.
     * @param colony The &lt;code&gt;Colony&lt;/code&gt; to rearrange.
     * @param unitChanges A list of &lt;code&gt;UnitChange&lt;/code&gt;s to apply.
     * @return An &lt;code&gt;Element&lt;/code&gt; encapsulating this action.
     */
    public Element rearrangeColony(ServerPlayer serverPlayer, Colony colony,
                                   List&lt;UnitChange&gt; unitChanges) {
<span class="fc" id="L4270">        final Role defaultRole = getGame().getSpecification().getDefaultRole();</span>
<span class="fc" id="L4271">        Tile tile = colony.getTile();</span>
<span class="fc" id="L4272">        tile.cacheUnseen();//+til</span>

        // Move everyone out of the way and stockpile their equipment.
<span class="fc bfc" id="L4275" title="All 2 branches covered.">        for (UnitChange uc : unitChanges) {</span>
<span class="fc" id="L4276">            uc.unit.setLocation(tile);//-til</span>
<span class="pc bpc" id="L4277" title="1 of 2 branches missed.">            if (!uc.unit.hasDefaultRole()) {</span>
<span class="nc" id="L4278">                colony.equipForRole(uc.unit, defaultRole, 0);</span>
            }
<span class="fc" id="L4280">        }</span>

<span class="fc" id="L4282">        List&lt;UnitChange&gt; todo = new ArrayList&lt;&gt;(unitChanges);</span>
<span class="fc bfc" id="L4283" title="All 2 branches covered.">        while (!todo.isEmpty()) {</span>
<span class="fc" id="L4284">            UnitChange uc = todo.remove(0);</span>
<span class="pc bpc" id="L4285" title="1 of 2 branches missed.">            if (uc.loc == tile) continue;</span>
<span class="fc" id="L4286">            WorkLocation wl = (WorkLocation)uc.loc;</span>
            // Adding to wl can fail, and in the worst case there
            // might be a circular dependency.  If the move can
            // succeed, do it, but if not, retry.
<span class="pc bpc" id="L4290" title="3 of 4 branches missed.">            switch (wl.getNoAddReason(uc.unit)) {</span>
            case NONE:
<span class="fc" id="L4292">                uc.unit.setLocation(wl);</span>
                // Fall through
            case ALREADY_PRESENT:
<span class="fc bfc" id="L4295" title="All 2 branches covered.">                if (uc.unit.getWorkType() != uc.work) {</span>
<span class="fc" id="L4296">                    uc.unit.changeWorkType(uc.work);</span>
                }
                break;
            case CAPACITY_EXCEEDED:
<span class="nc" id="L4300">                todo.add(todo.size(), uc);</span>
<span class="nc" id="L4301">                break;</span>
            default:
<span class="nc" id="L4303">                logger.warning(&quot;Bad move for &quot; + uc.unit + &quot; to &quot; + wl);</span>
                break;
            }
<span class="fc" id="L4306">        }</span>

<span class="fc" id="L4308">        Iterator&lt;UnitChange&gt; uci = unitChanges.iterator();</span>
<span class="fc bfc" id="L4309" title="All 2 branches covered.">        while (uci.hasNext()) {</span>
<span class="fc" id="L4310">            UnitChange uc = uci.next();</span>
<span class="pc bpc" id="L4311" title="1 of 2 branches missed.">            if (uc.unit.getRole() == uc.role) uci.remove();</span>
<span class="fc" id="L4312">        }</span>
<span class="pc bpc" id="L4313" title="1 of 2 branches missed.">        if (!unitChanges.isEmpty()) {</span>
<span class="nc" id="L4314">            Collections.sort(unitChanges,</span>
                             RearrangeColonyMessage.roleComparator);
<span class="nc" id="L4316">            Collections.reverse(unitChanges);</span>
<span class="nc bnc" id="L4317" title="All 2 branches missed.">            for (UnitChange uc : unitChanges) {</span>
<span class="nc bnc" id="L4318" title="All 2 branches missed.">                if (uc.role != defaultRole) {</span>
<span class="nc bnc" id="L4319" title="All 2 branches missed.">                    if (!colony.equipForRole(uc.unit, uc.role, uc.roleCount)) {</span>
                        // Should not happen if we equip simplest first
<span class="nc" id="L4321">                        return DOMMessage.clientError(&quot;Failed to equip &quot;</span>
<span class="nc" id="L4322">                            + uc.unit.getId() + &quot; for role &quot; + uc.role</span>
                            + &quot; at &quot; + colony);
                    }
                }
<span class="nc" id="L4326">            }</span>
        }
        
        // Just update the whole tile, including for other players
        // which might see colony population change.
<span class="fc" id="L4331">        return new ChangeSet().add(See.perhaps(), tile).build(serverPlayer);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>